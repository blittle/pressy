{"type":"file-history-snapshot","messageId":"dadb4ea5-c07a-4c84-8bd0-95386643597c","snapshot":{"messageId":"dadb4ea5-c07a-4c84-8bd0-95386643597c","trackedFileBackups":{},"timestamp":"2026-02-16T01:33:10.186Z"},"isSnapshotUpdate":false}
{"parentUuid":null,"isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","type":"progress","data":{"type":"hook_progress","hookEvent":"SessionStart","hookName":"SessionStart:clear","command":"entire hooks claude-code session-start"},"parentToolUseID":"32d2f5f4-674c-42d1-90f7-5175b64aeb84","toolUseID":"32d2f5f4-674c-42d1-90f7-5175b64aeb84","timestamp":"2026-02-16T01:33:09.902Z","uuid":"38ea1482-af99-4e88-bcd2-1cb251ebd091"}
{"parentUuid":"38ea1482-af99-4e88-bcd2-1cb251ebd091","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","type":"user","message":{"role":"user","content":"Implement the following plan:\n\n# Add PWA Install Button to Home Page\n\n## Context\n\nThe home page has a \"Start Reading\" / \"Continue Reading\" CTA button. The user wants an \"Install\" button next to it that triggers the browser's PWA install prompt, so visitors can install the book as an app directly from the landing page.\n\n## How `beforeinstallprompt` Works\n\nThe browser fires `beforeinstallprompt` when the site meets PWA installability criteria (manifest, service worker, HTTPS). We must:\n1. Capture the event and call `preventDefault()` to stop the browser's default mini-infobar\n2. Stash the event in a signal so the UI can show/hide an install button\n3. When the user clicks \"Install\", call `event.prompt()` to show the native install dialog\n4. After the user responds, clear the stashed event\n5. Listen for `appinstalled` to hide the button if installed via other means\n\n## Files to Modify\n\n| File | Changes |\n|------|---------|\n| `packages/pressy/src/runtime/offline.ts` | Add `installPrompt` signal + `setupInstallPrompt()` + `triggerInstall()` |\n| `packages/pressy/src/runtime/client.tsx` | Add `InstallButton` component, call `setupInstallPrompt()` in `hydrate()`, render button next to `StartReadingCTA` |\n\n## Implementation\n\n### 1. Add install prompt signal and helpers (`offline.ts`)\n\nAdd at the top alongside existing signals:\n\n```ts\nexport const installPrompt = signal<Event | null>(null)\n```\n\nAdd a setup function:\n\n```ts\nexport function setupInstallPrompt(): void {\n  window.addEventListener('beforeinstallprompt', (e) => {\n    e.preventDefault()\n    installPrompt.value = e\n  })\n  window.addEventListener('appinstalled', () => {\n    installPrompt.value = null\n  })\n}\n```\n\nAdd a trigger function:\n\n```ts\nexport async function triggerInstall(): Promise<boolean> {\n  const prompt = installPrompt.value as any\n  if (!prompt) return false\n  prompt.prompt()\n  const { outcome } = await prompt.userChoice\n  installPrompt.value = null\n  return outcome === 'accepted'\n}\n```\n\n### 2. Add `InstallButton` component and integrate (`client.tsx`)\n\nImport `installPrompt`, `setupInstallPrompt`, `triggerInstall` from offline.ts.\n\nCall `setupInstallPrompt()` in `hydrate()` alongside the existing `setupOfflineDetection()`.\n\nCreate a simple component:\n\n```tsx\nfunction InstallButton() {\n  // Reading .value auto-subscribes — button only shows when prompt is available\n  if (!installPrompt.value) return null\n\n  return (\n    <button\n      class=\"pressy-cta pressy-cta-secondary\"\n      onClick={() => triggerInstall()}\n    >\n      Install\n    </button>\n  )\n}\n```\n\nIn `renderBookPage()`, wrap both CTAs in a flex container:\n\n```tsx\n{chapterCount > 0 && (\n  <div class=\"pressy-cta-group\">\n    <StartReadingCTA book={book} />\n    <InstallButton />\n  </div>\n)}\n```\n\nAdd styles to `HOME_STYLES`:\n\n```css\n.pressy-cta-group {\n  display: flex;\n  flex-wrap: wrap;\n  gap: 0.75rem;\n  align-items: center;\n}\n.pressy-cta-secondary {\n  background: transparent;\n  color: var(--color-link, #2563eb);\n  border: 1.5px solid var(--color-link, #2563eb);\n  cursor: pointer;\n  font-family: inherit;\n}\n.pressy-cta-secondary:hover {\n  background: var(--color-link, #2563eb);\n  color: #fff;\n}\n```\n\nThe secondary/outline style differentiates it from the primary \"Start Reading\" button.\n\n## Verification\n\n1. `pnpm --filter pressy build` — no errors\n2. Home page in Chrome: \"Install\" button appears next to \"Start Reading\" (only when browser supports PWA install)\n3. Click \"Install\" — native browser install dialog appears\n4. After installing (or dismissing), the \"Install\" button disappears\n5. If already installed or browser doesn't support PWA, button is hidden\n6. Button styling: outline style, responsive wrapping on mobile\n\n\nIf you need specific details from before exiting plan mode (like exact code snippets, error messages, or content you generated), read the full transcript at: /Users/blittle/.REDACTED.jsonl"},"uuid":"dadb4ea5-c07a-4c84-8bd0-95386643597c","timestamp":"2026-02-16T01:33:09.659Z","planContent":"# Add PWA Install Button to Home Page\n\n## Context\n\nThe home page has a \"Start Reading\" / \"Continue Reading\" CTA button. The user wants an \"Install\" button next to it that triggers the browser's PWA install prompt, so visitors can install the book as an app directly from the landing page.\n\n## How `beforeinstallprompt` Works\n\nThe browser fires `beforeinstallprompt` when the site meets PWA installability criteria (manifest, service worker, HTTPS). We must:\n1. Capture the event and call `preventDefault()` to stop the browser's default mini-infobar\n2. Stash the event in a signal so the UI can show/hide an install button\n3. When the user clicks \"Install\", call `event.prompt()` to show the native install dialog\n4. After the user responds, clear the stashed event\n5. Listen for `appinstalled` to hide the button if installed via other means\n\n## Files to Modify\n\n| File | Changes |\n|------|---------|\n| `packages/pressy/src/runtime/offline.ts` | Add `installPrompt` signal + `setupInstallPrompt()` + `triggerInstall()` |\n| `packages/pressy/src/runtime/client.tsx` | Add `InstallButton` component, call `setupInstallPrompt()` in `hydrate()`, render button next to `StartReadingCTA` |\n\n## Implementation\n\n### 1. Add install prompt signal and helpers (`offline.ts`)\n\nAdd at the top alongside existing signals:\n\n```ts\nexport const installPrompt = signal<Event | null>(null)\n```\n\nAdd a setup function:\n\n```ts\nexport function setupInstallPrompt(): void {\n  window.addEventListener('beforeinstallprompt', (e) => {\n    e.preventDefault()\n    installPrompt.value = e\n  })\n  window.addEventListener('appinstalled', () => {\n    installPrompt.value = null\n  })\n}\n```\n\nAdd a trigger function:\n\n```ts\nexport async function triggerInstall(): Promise<boolean> {\n  const prompt = installPrompt.value as any\n  if (!prompt) return false\n  prompt.prompt()\n  const { outcome } = await prompt.userChoice\n  installPrompt.value = null\n  return outcome === 'accepted'\n}\n```\n\n### 2. Add `InstallButton` component and integrate (`client.tsx`)\n\nImport `installPrompt`, `setupInstallPrompt`, `triggerInstall` from offline.ts.\n\nCall `setupInstallPrompt()` in `hydrate()` alongside the existing `setupOfflineDetection()`.\n\nCreate a simple component:\n\n```tsx\nfunction InstallButton() {\n  // Reading .value auto-subscribes — button only shows when prompt is available\n  if (!installPrompt.value) return null\n\n  return (\n    <button\n      class=\"pressy-cta pressy-cta-secondary\"\n      onClick={() => triggerInstall()}\n    >\n      Install\n    </button>\n  )\n}\n```\n\nIn `renderBookPage()`, wrap both CTAs in a flex container:\n\n```tsx\n{chapterCount > 0 && (\n  <div class=\"pressy-cta-group\">\n    <StartReadingCTA book={book} />\n    <InstallButton />\n  </div>\n)}\n```\n\nAdd styles to `HOME_STYLES`:\n\n```css\n.pressy-cta-group {\n  display: flex;\n  flex-wrap: wrap;\n  gap: 0.75rem;\n  align-items: center;\n}\n.pressy-cta-secondary {\n  background: transparent;\n  color: var(--color-link, #2563eb);\n  border: 1.5px solid var(--color-link, #2563eb);\n  cursor: pointer;\n  font-family: inherit;\n}\n.pressy-cta-secondary:hover {\n  background: var(--color-link, #2563eb);\n  color: #fff;\n}\n```\n\nThe secondary/outline style differentiates it from the primary \"Start Reading\" button.\n\n## Verification\n\n1. `pnpm --filter pressy build` — no errors\n2. Home page in Chrome: \"Install\" button appears next to \"Start Reading\" (only when browser supports PWA install)\n3. Click \"Install\" — native browser install dialog appears\n4. After installing (or dismissing), the \"Install\" button disappears\n5. If already installed or browser doesn't support PWA, button is hidden\n6. Button styling: outline style, responsive wrapping on mobile\n"}
{"parentUuid":"dadb4ea5-c07a-4c84-8bd0-95386643597c","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","message":{"model":"claude-opus-4-6","id":"msg_01P9uCLUwvbd6BwtgpvUy4Pb","type":"message","role":"assistant","content":[{"type":"text","text":"\n\nI'll start by reading the two files that need to be modified."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":4998,"cache_read_input_tokens":15675,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":4998},"output_tokens":2,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CYAtNMr1e9hzN5eVtnAtM","type":"assistant","uuid":"ef7c6dc4-1fcc-4cf9-a56b-2cc3d34c9d13","timestamp":"2026-02-16T01:33:12.759Z"}
{"parentUuid":"ef7c6dc4-1fcc-4cf9-a56b-2cc3d34c9d13","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","message":{"model":"claude-opus-4-6","id":"msg_01P9uCLUwvbd6BwtgpvUy4Pb","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_011HKSh2fWX1a3sYE34AhuwE","name":"Read","input":{"file_path":"/Users/blittle/dev/pressy/packages/pressy/src/runtime/offline.ts"},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":4998,"cache_read_input_tokens":15675,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":4998},"output_tokens":2,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CYAtNMr1e9hzN5eVtnAtM","type":"assistant","uuid":"d00311ae-e75a-4707-87fe-8efdfddd3cf2","timestamp":"2026-02-16T01:33:13.226Z"}
{"parentUuid":"d00311ae-e75a-4707-87fe-8efdfddd3cf2","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","type":"progress","data":{"type":"hook_progress","hookEvent":"PostToolUse","hookName":"PostToolUse:Read","command":"callback"},"parentToolUseID":"toolu_011HKSh2fWX1a3sYE34AhuwE","toolUseID":"toolu_011HKSh2fWX1a3sYE34AhuwE","timestamp":"2026-02-16T01:33:13.250Z","uuid":"ebeafc41-cc2a-4fae-84c6-8902ccae2fb0"}
{"parentUuid":"d00311ae-e75a-4707-87fe-8efdfddd3cf2","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_011HKSh2fWX1a3sYE34AhuwE","type":"tool_result","content":"     1→import { signal } from '@preact/signals'\n     2→\n     3→const CACHED_BOOKS_KEY = 'pressy-cached-books'\n     4→\n     5→export const offlineStatus = signal<'online' | 'offline'>('online')\n     6→export const cacheProgress = signal<{ bookSlug: string; current: number; total: number } | null>(null)\n     7→export const swReady = signal<boolean>(false)\n     8→\n     9→// Restore cached books from localStorage synchronously on load\n    10→function loadCachedBooks(): Set<string> {\n    11→  if (typeof localStorage === 'undefined') return new Set()\n    12→  try {\n    13→    const stored = localStorage.getItem(CACHED_BOOKS_KEY)\n    14→    if (stored) return new Set(JSON.parse(stored))\n    15→  } catch {}\n    16→  return new Set()\n    17→}\n    18→\n    19→export const cachedBooks = signal<Set<string>>(loadCachedBooks())\n    20→\n    21→// Initialize offline detection\n    22→if (typeof window !== 'undefined') {\n    23→  offlineStatus.value = navigator.onLine ? 'online' : 'offline'\n    24→\n    25→  window.addEventListener('online', () => {\n    26→    offlineStatus.value = 'online'\n    27→  })\n    28→\n    29→  window.addEventListener('offline', () => {\n    30→    offlineStatus.value = 'offline'\n    31→  })\n    32→}\n    33→\n    34→// Service Worker registration\n    35→export async function registerServiceWorker(basePath = ''): Promise<ServiceWorkerRegistration | null> {\n    36→  if (!('serviceWorker' in navigator)) {\n    37→    console.warn('Service workers are not supported')\n    38→    return null\n    39→  }\n    40→\n    41→  const swUrl = basePath ? `${basePath}/sw.js` : '/sw.js'\n    42→  const scope = basePath ? `${basePath}/` : '/'\n    43→\n    44→  try {\n    45→    const registration = await navigator.serviceWorker.register(swUrl, {\n    46→      scope,\n    47→    })\n    48→\n    49→    // Listen for messages from service worker\n    50→    navigator.serviceWorker.addEventListener('message', handleSWMessage)\n    51→\n    52→    // Mark SW as ready when controller is available\n    53→    if (navigator.serviceWorker.controller) {\n    54→      swReady.value = true\n    55→    } else {\n    56→      navigator.serviceWorker.addEventListener('controllerchange', () => {\n    57→        swReady.value = true\n    58→      })\n    59→    }\n    60→\n    61→    // Handle updates\n    62→    registration.addEventListener('updatefound', () => {\n    63→      const newWorker = registration.installing\n    64→      if (!newWorker) return\n    65→\n    66→      newWorker.addEventListener('statechange', () => {\n    67→        if (newWorker.state === 'activated') {\n    68→          swReady.value = true\n    69→        }\n    70→      })\n    71→    })\n    72→\n    73→    return registration\n    74→  } catch (err) {\n    75→    console.error('Service worker registration failed:', err)\n    76→    return null\n    77→  }\n    78→}\n    79→\n    80→function persistCachedBooks() {\n    81→  try {\n    82→    localStorage.setItem(CACHED_BOOKS_KEY, JSON.stringify([...cachedBooks.value]))\n    83→  } catch {}\n    84→}\n    85→\n    86→function handleSWMessage(event: MessageEvent) {\n    87→  const { type } = event.data\n    88→\n    89→  if (type === 'CACHE_PROGRESS') {\n    90→    const { bookSlug, current, total } = event.data\n    91→    cacheProgress.value = { bookSlug, current, total }\n    92→  }\n    93→\n    94→  if (type === 'CACHE_COMPLETE') {\n    95→    const { bookSlug } = event.data\n    96→    cacheProgress.value = null\n    97→    const newCached = new Set(cachedBooks.value)\n    98→    newCached.add(bookSlug)\n    99→    cachedBooks.value = newCached\n   100→    persistCachedBooks()\n   101→  }\n   102→\n   103→  if (type === 'CACHE_STATUS') {\n   104→    const { cached } = event.data as { cached: string[] }\n   105→    const newCached = new Set<string>()\n   106→    for (const url of cached) {\n   107→      const match = url.match(/\\/books\\/([^/]+)/)\n   108→      if (match) {\n   109→        newCached.add(match[1])\n   110→      }\n   111→    }\n   112→    cachedBooks.value = newCached\n   113→    persistCachedBooks()\n   114→  }\n   115→\n   116→  if (type === 'CACHE_CLEARED') {\n   117→    const { bookSlug } = event.data\n   118→    const newCached = new Set(cachedBooks.value)\n   119→    newCached.delete(bookSlug)\n   120→    cachedBooks.value = newCached\n   121→    persistCachedBooks()\n   122→  }\n   123→}\n   124→\n   125→// Download a book for offline reading\n   126→export async function downloadBookForOffline(\n   127→  bookSlug: string,\n   128→  chapterUrls: string[]\n   129→): Promise<boolean> {\n   130→  if (!('serviceWorker' in navigator) || !navigator.serviceWorker.controller) {\n   131→    console.warn('Service worker not available')\n   132→    return false\n   133→  }\n   134→\n   135→  // Build full URLs\n   136→  const urls = chapterUrls.map((url) =>\n   137→    url.startsWith('http') ? url : `${window.location.origin}${url}`\n   138→  )\n   139→\n   140→  cacheProgress.value = { bookSlug, current: 0, total: urls.length }\n   141→\n   142→  // Optimistically persist to localStorage immediately so state survives refresh\n   143→  const newCached = new Set(cachedBooks.value)\n   144→  newCached.add(bookSlug)\n   145→  cachedBooks.value = newCached\n   146→  persistCachedBooks()\n   147→\n   148→  // Send message to service worker\n   149→  navigator.serviceWorker.controller.postMessage({\n   150→    type: 'CACHE_BOOK',\n   151→    bookSlug,\n   152→    urls,\n   153→  })\n   154→\n   155→  return true\n   156→}\n   157→\n   158→// Check if a book is available offline\n   159→export function isBookCached(bookSlug: string): boolean {\n   160→  return cachedBooks.value.has(bookSlug)\n   161→}\n   162→\n   163→// Get cache status for URLs\n   164→export async function checkCacheStatus(urls: string[]): Promise<void> {\n   165→  if (!('serviceWorker' in navigator) || !navigator.serviceWorker.controller) {\n   166→    return\n   167→  }\n   168→\n   169→  navigator.serviceWorker.controller.postMessage({\n   170→    type: 'GET_CACHE_STATUS',\n   171→    urls: urls.map((url) =>\n   172→      url.startsWith('http') ? url : `${window.location.origin}${url}`\n   173→    ),\n   174→  })\n   175→}\n   176→\n   177→// Clear cached book\n   178→export async function clearBookCache(bookSlug: string): Promise<boolean> {\n   179→  // Update state and persist immediately\n   180→  const newCached = new Set(cachedBooks.value)\n   181→  newCached.delete(bookSlug)\n   182→  cachedBooks.value = newCached\n   183→  persistCachedBooks()\n   184→\n   185→  if (!('serviceWorker' in navigator) || !navigator.serviceWorker.controller) {\n   186→    // Fallback to direct cache API\n   187→    try {\n   188→      const cache = await caches.open('pressy-offline-books')\n   189→      const keys = await cache.keys()\n   190→\n   191→      for (const request of keys) {\n   192→        if (request.url.includes(`/books/${bookSlug}`)) {\n   193→          await cache.delete(request)\n   194→        }\n   195→      }\n   196→\n   197→      return true\n   198→    } catch (err) {\n   199→      console.error('Failed to clear cache:', err)\n   200→      return false\n   201→    }\n   202→  }\n   203→\n   204→  // Prefer message-based approach so SW can coordinate\n   205→  navigator.serviceWorker.controller.postMessage({\n   206→    type: 'CLEAR_BOOK_CACHE',\n   207→    bookSlug,\n   208→  })\n   209→  return true\n   210→}\n   211→"}]},"uuid":"39efc362-bea0-4cb4-9964-345baa34fc99","timestamp":"2026-02-16T01:33:13.249Z","toolUseResult":{"type":"text","file":{"filePath":"/Users/blittle/dev/pressy/packages/pressy/src/runtime/offline.ts","content":"import { signal } from '@preact/signals'\n\nconst CACHED_BOOKS_KEY = 'pressy-cached-books'\n\nexport const offlineStatus = signal<'online' | 'offline'>('online')\nexport const cacheProgress = signal<{ bookSlug: string; current: number; total: number } | null>(null)\nexport const swReady = signal<boolean>(false)\n\n// Restore cached books from localStorage synchronously on load\nfunction loadCachedBooks(): Set<string> {\n  if (typeof localStorage === 'undefined') return new Set()\n  try {\n    const stored = localStorage.getItem(CACHED_BOOKS_KEY)\n    if (stored) return new Set(JSON.parse(stored))\n  } catch {}\n  return new Set()\n}\n\nexport const cachedBooks = signal<Set<string>>(loadCachedBooks())\n\n// Initialize offline detection\nif (typeof window !== 'undefined') {\n  offlineStatus.value = navigator.onLine ? 'online' : 'offline'\n\n  window.addEventListener('online', () => {\n    offlineStatus.value = 'online'\n  })\n\n  window.addEventListener('offline', () => {\n    offlineStatus.value = 'offline'\n  })\n}\n\n// Service Worker registration\nexport async function registerServiceWorker(basePath = ''): Promise<ServiceWorkerRegistration | null> {\n  if (!('serviceWorker' in navigator)) {\n    console.warn('Service workers are not supported')\n    return null\n  }\n\n  const swUrl = basePath ? `${basePath}/sw.js` : '/sw.js'\n  const scope = basePath ? `${basePath}/` : '/'\n\n  try {\n    const registration = await navigator.serviceWorker.register(swUrl, {\n      scope,\n    })\n\n    // Listen for messages from service worker\n    navigator.serviceWorker.addEventListener('message', handleSWMessage)\n\n    // Mark SW as ready when controller is available\n    if (navigator.serviceWorker.controller) {\n      swReady.value = true\n    } else {\n      navigator.serviceWorker.addEventListener('controllerchange', () => {\n        swReady.value = true\n      })\n    }\n\n    // Handle updates\n    registration.addEventListener('updatefound', () => {\n      const newWorker = registration.installing\n      if (!newWorker) return\n\n      newWorker.addEventListener('statechange', () => {\n        if (newWorker.state === 'activated') {\n          swReady.value = true\n        }\n      })\n    })\n\n    return registration\n  } catch (err) {\n    console.error('Service worker registration failed:', err)\n    return null\n  }\n}\n\nfunction persistCachedBooks() {\n  try {\n    localStorage.setItem(CACHED_BOOKS_KEY, JSON.stringify([...cachedBooks.value]))\n  } catch {}\n}\n\nfunction handleSWMessage(event: MessageEvent) {\n  const { type } = event.data\n\n  if (type === 'CACHE_PROGRESS') {\n    const { bookSlug, current, total } = event.data\n    cacheProgress.value = { bookSlug, current, total }\n  }\n\n  if (type === 'CACHE_COMPLETE') {\n    const { bookSlug } = event.data\n    cacheProgress.value = null\n    const newCached = new Set(cachedBooks.value)\n    newCached.add(bookSlug)\n    cachedBooks.value = newCached\n    persistCachedBooks()\n  }\n\n  if (type === 'CACHE_STATUS') {\n    const { cached } = event.data as { cached: string[] }\n    const newCached = new Set<string>()\n    for (const url of cached) {\n      const match = url.match(/\\/books\\/([^/]+)/)\n      if (match) {\n        newCached.add(match[1])\n      }\n    }\n    cachedBooks.value = newCached\n    persistCachedBooks()\n  }\n\n  if (type === 'CACHE_CLEARED') {\n    const { bookSlug } = event.data\n    const newCached = new Set(cachedBooks.value)\n    newCached.delete(bookSlug)\n    cachedBooks.value = newCached\n    persistCachedBooks()\n  }\n}\n\n// Download a book for offline reading\nexport async function downloadBookForOffline(\n  bookSlug: string,\n  chapterUrls: string[]\n): Promise<boolean> {\n  if (!('serviceWorker' in navigator) || !navigator.serviceWorker.controller) {\n    console.warn('Service worker not available')\n    return false\n  }\n\n  // Build full URLs\n  const urls = chapterUrls.map((url) =>\n    url.startsWith('http') ? url : `${window.location.origin}${url}`\n  )\n\n  cacheProgress.value = { bookSlug, current: 0, total: urls.length }\n\n  // Optimistically persist to localStorage immediately so state survives refresh\n  const newCached = new Set(cachedBooks.value)\n  newCached.add(bookSlug)\n  cachedBooks.value = newCached\n  persistCachedBooks()\n\n  // Send message to service worker\n  navigator.serviceWorker.controller.postMessage({\n    type: 'CACHE_BOOK',\n    bookSlug,\n    urls,\n  })\n\n  return true\n}\n\n// Check if a book is available offline\nexport function isBookCached(bookSlug: string): boolean {\n  return cachedBooks.value.has(bookSlug)\n}\n\n// Get cache status for URLs\nexport async function checkCacheStatus(urls: string[]): Promise<void> {\n  if (!('serviceWorker' in navigator) || !navigator.serviceWorker.controller) {\n    return\n  }\n\n  navigator.serviceWorker.controller.postMessage({\n    type: 'GET_CACHE_STATUS',\n    urls: urls.map((url) =>\n      url.startsWith('http') ? url : `${window.location.origin}${url}`\n    ),\n  })\n}\n\n// Clear cached book\nexport async function clearBookCache(bookSlug: string): Promise<boolean> {\n  // Update state and persist immediately\n  const newCached = new Set(cachedBooks.value)\n  newCached.delete(bookSlug)\n  cachedBooks.value = newCached\n  persistCachedBooks()\n\n  if (!('serviceWorker' in navigator) || !navigator.serviceWorker.controller) {\n    // Fallback to direct cache API\n    try {\n      const cache = await caches.open('pressy-offline-books')\n      const keys = await cache.keys()\n\n      for (const request of keys) {\n        if (request.url.includes(`/books/${bookSlug}`)) {\n          await cache.delete(request)\n        }\n      }\n\n      return true\n    } catch (err) {\n      console.error('Failed to clear cache:', err)\n      return false\n    }\n  }\n\n  // Prefer message-based approach so SW can coordinate\n  navigator.serviceWorker.controller.postMessage({\n    type: 'CLEAR_BOOK_CACHE',\n    bookSlug,\n  })\n  return true\n}\n","numLines":211,"startLine":1,"totalLines":211}},"sourceToolAssistantUUID":"d00311ae-e75a-4707-87fe-8efdfddd3cf2"}
{"parentUuid":"39efc362-bea0-4cb4-9964-345baa34fc99","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","message":{"model":"claude-opus-4-6","id":"msg_01P9uCLUwvbd6BwtgpvUy4Pb","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_018Wb8cxQJkTFjpG7m2pzzpd","name":"Read","input":{"file_path":"/Users/blittle/dev/pressy/packages/pressy/src/runtime/client.tsx"},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":4998,"cache_read_input_tokens":15675,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":4998},"output_tokens":2,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CYAtNMr1e9hzN5eVtnAtM","type":"assistant","uuid":"6964b310-6f67-42f7-ba72-1fd125ab1c5f","timestamp":"2026-02-16T01:33:13.628Z"}
{"parentUuid":"6964b310-6f67-42f7-ba72-1fd125ab1c5f","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","type":"progress","data":{"type":"hook_progress","hookEvent":"PostToolUse","hookName":"PostToolUse:Read","command":"callback"},"parentToolUseID":"toolu_018Wb8cxQJkTFjpG7m2pzzpd","toolUseID":"toolu_018Wb8cxQJkTFjpG7m2pzzpd","timestamp":"2026-02-16T01:33:13.653Z","uuid":"ccaa5802-29ab-4b36-a926-453e2d9b6181"}
{"parentUuid":"6964b310-6f67-42f7-ba72-1fd125ab1c5f","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_018Wb8cxQJkTFjpG7m2pzzpd","type":"tool_result","content":"     1→import { render, type ComponentType, type VNode } from 'preact'\n     2→import { useState, useEffect } from 'preact/hooks'\n     3→import { signal, effect } from '@preact/signals'\n     4→import { Reader } from '@pressy-pub/components'\n     5→import type { ProgressData } from '@pressy-pub/components'\n     6→import { useMDXComponents } from '@pressy-pub/components/content'\n     7→import {\n     8→  registerServiceWorker,\n     9→  downloadBookForOffline,\n    10→  clearBookCache,\n    11→  cachedBooks,\n    12→  cacheProgress,\n    13→} from './offline.js'\n    14→import type { ContentManifest, Route, Book, Chapter, Article, ReadingProgress, ChapterMapData } from '../types.js'\n    15→import type { PaginationConfig } from '../config.js'\n    16→\n    17→// State signals\n    18→export const currentRoute = signal<string>('/')\n    19→export const currentTheme = signal<'light' | 'dark' | 'sepia' | 'system'>('light')\n    20→export const isOffline = signal<boolean>(!navigator.onLine)\n    21→\n    22→// IndexedDB for reading progress\n    23→const DB_NAME = 'pressy'\n    24→const DB_VERSION = 1\n    25→const PROGRESS_STORE = 'reading-progress'\n    26→const UNLOCKS_STORE = 'unlocks'\n    27→\n    28→let db: IDBDatabase | null = null\n    29→\n    30→async function initDB(): Promise<IDBDatabase> {\n    31→  if (db) return db\n    32→\n    33→  return new Promise((resolve, reject) => {\n    34→    const request = indexedDB.open(DB_NAME, DB_VERSION)\n    35→\n    36→    request.onerror = () => reject(request.error)\n    37→    request.onsuccess = () => {\n    38→      db = request.result\n    39→      resolve(db)\n    40→    }\n    41→\n    42→    request.onupgradeneeded = (event) => {\n    43→      const database = (event.target as IDBOpenDBRequest).result\n    44→      if (!database.objectStoreNames.contains(PROGRESS_STORE)) {\n    45→        database.createObjectStore(PROGRESS_STORE, { keyPath: 'chapterSlug' })\n    46→      }\n    47→      if (!database.objectStoreNames.contains(UNLOCKS_STORE)) {\n    48→        database.createObjectStore(UNLOCKS_STORE, { keyPath: 'bookSlug' })\n    49→      }\n    50→    }\n    51→  })\n    52→}\n    53→\n    54→export async function saveReadingProgress(progress: ReadingProgress): Promise<void> {\n    55→  const database = await initDB()\n    56→  return new Promise((resolve, reject) => {\n    57→    const tx = database.transaction(PROGRESS_STORE, 'readwrite')\n    58→    const store = tx.objectStore(PROGRESS_STORE)\n    59→    const request = store.put(progress)\n    60→    request.onsuccess = () => resolve()\n    61→    request.onerror = () => reject(request.error)\n    62→  })\n    63→}\n    64→\n    65→export async function getReadingProgress(chapterSlug: string): Promise<ReadingProgress | null> {\n    66→  const database = await initDB()\n    67→  return new Promise((resolve, reject) => {\n    68→    const tx = database.transaction(PROGRESS_STORE, 'readonly')\n    69→    const store = tx.objectStore(PROGRESS_STORE)\n    70→    const request = store.get(chapterSlug)\n    71→    request.onsuccess = () => resolve(request.result || null)\n    72→    request.onerror = () => reject(request.error)\n    73→  })\n    74→}\n    75→\n    76→export async function getAllReadingProgress(): Promise<ReadingProgress[]> {\n    77→  const database = await initDB()\n    78→  return new Promise((resolve, reject) => {\n    79→    const tx = database.transaction(PROGRESS_STORE, 'readonly')\n    80→    const store = tx.objectStore(PROGRESS_STORE)\n    81→    const request = store.getAll()\n    82→    request.onsuccess = () => resolve(request.result || [])\n    83→    request.onerror = () => reject(request.error)\n    84→  })\n    85→}\n    86→\n    87→export async function isBookUnlocked(bookSlug: string): Promise<boolean> {\n    88→  const database = await initDB()\n    89→  return new Promise((resolve, reject) => {\n    90→    const tx = database.transaction(UNLOCKS_STORE, 'readonly')\n    91→    const store = tx.objectStore(UNLOCKS_STORE)\n    92→    const request = store.get(bookSlug)\n    93→    request.onsuccess = () => resolve(!!request.result)\n    94→    request.onerror = () => reject(request.error)\n    95→  })\n    96→}\n    97→\n    98→export async function unlockBook(bookSlug: string, orderId?: string): Promise<void> {\n    99→  const database = await initDB()\n   100→  return new Promise((resolve, reject) => {\n   101→    const tx = database.transaction(UNLOCKS_STORE, 'readwrite')\n   102→    const store = tx.objectStore(UNLOCKS_STORE)\n   103→    const request = store.put({ bookSlug, orderId, unlockedAt: Date.now() })\n   104→    request.onsuccess = () => resolve()\n   105→    request.onerror = () => reject(request.error)\n   106→  })\n   107→}\n   108→\n   109→// Client-side router\n   110→export function navigate(path: string, replace = false): void {\n   111→  if (replace) {\n   112→    history.replaceState(null, '', path)\n   113→  } else {\n   114→    history.pushState(null, '', path)\n   115→  }\n   116→  currentRoute.value = path\n   117→}\n   118→\n   119→// Theme management\n   120→function resolveSystemTheme(): 'light' | 'dark' {\n   121→  return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light'\n   122→}\n   123→\n   124→export function setTheme(theme: 'light' | 'dark' | 'sepia' | 'system'): void {\n   125→  currentTheme.value = theme\n   126→  localStorage.setItem('pressy-theme', theme)\n   127→  const resolved = theme === 'system' ? resolveSystemTheme() : theme\n   128→  document.documentElement.setAttribute('data-theme', resolved)\n   129→}\n   130→\n   131→function loadTheme(): void {\n   132→  const saved = localStorage.getItem('pressy-theme') as 'light' | 'dark' | 'sepia' | 'system' | null\n   133→  if (saved) {\n   134→    setTheme(saved)\n   135→  } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {\n   136→    setTheme('dark')\n   137→  }\n   138→\n   139→  // Listen for OS theme changes so \"system\" mode updates live\n   140→  window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', () => {\n   141→    if (currentTheme.value === 'system') {\n   142→      document.documentElement.setAttribute('data-theme', resolveSystemTheme())\n   143→    }\n   144→  })\n   145→}\n   146→\n   147→// Offline detection\n   148→function setupOfflineDetection(): void {\n   149→  window.addEventListener('online', () => {\n   150→    isOffline.value = false\n   151→  })\n   152→  window.addEventListener('offline', () => {\n   153→    isOffline.value = true\n   154→  })\n   155→}\n   156→\n   157→// ── Page renderers ──────────────────────────────────────────\n   158→\n   159→function StartReadingCTA({ book }: { book: Book }) {\n   160→  const [target, setTarget] = useState<{ label: string; href: string } | null>(null)\n   161→\n   162→  useEffect(() => {\n   163→    if (book.chapters.length === 0) return\n   164→    const firstHref = `${basePath}/books/${book.slug}/${book.chapters[0].slug}`\n   165→\n   166→    getAllReadingProgress().then((allProgress) => {\n   167→      const progressMap = new Map(allProgress.map((p) => [p.chapterSlug, p]))\n   168→\n   169→      // Walk chapters in order and find the furthest one that's in-progress (not completed)\n   170→      let furthestInProgress: Chapter | null = null\n   171→      for (const ch of book.chapters) {\n   172→        const p = progressMap.get(ch.slug)\n   173→        if (!p) continue\n   174→        const completed = p.totalPages > 0 && p.page >= p.totalPages - 1\n   175→        if (!completed && p.page > 0) {\n   176→          furthestInProgress = ch\n   177→        }\n   178→      }\n   179→\n   180→      if (furthestInProgress) {\n   181→        setTarget({\n   182→          label: 'Continue Reading',\n   183→          href: `${basePath}/books/${book.slug}/${furthestInProgress.slug}`,\n   184→        })\n   185→      } else {\n   186→        setTarget({ label: 'Start Reading', href: firstHref })\n   187→      }\n   188→    }).catch(() => {\n   189→      setTarget({ label: 'Start Reading', href: firstHref })\n   190→    })\n   191→  }, [book])\n   192→\n   193→  if (!target) return null\n   194→\n   195→  return (\n   196→    <a href={target.href} class=\"pressy-cta\">\n   197→      {target.label}\n   198→    </a>\n   199→  )\n   200→}\n   201→\n   202→function renderBookPage(book: Book, articles: Article[] = []) {\n   203→  // Stats calculations\n   204→  const totalWords = book.chapters.reduce((sum, ch) => sum + (ch.wordCount || 0), 0)\n   205→  const readingMinutes = Math.ceil(totalWords / 200)\n   206→  const chapterCount = book.chapters.length\n   207→  const publishYear = book.metadata.publishDate\n   208→    ? new Date(book.metadata.publishDate).getFullYear()\n   209→    : null\n   210→\n   211→  const formattedWords = totalWords.toLocaleString()\n   212→\n   213→  return (\n   214→    <div class=\"pressy-home\">\n   215→      <div class=\"pressy-hero\">\n   216→        {book.coverUrl && (\n   217→          <img\n   218→            src={basePath + book.coverUrl}\n   219→            alt={`${book.metadata.title} cover`}\n   220→            class=\"pressy-hero-cover\"\n   221→          />\n   222→        )}\n   223→        <div class=\"pressy-hero-text\">\n   224→          <header class=\"pressy-home-header\">\n   225→            <h1>{book.metadata.title}</h1>\n   226→            <p class=\"pressy-home-author\">by {book.metadata.author}</p>\n   227→            {book.metadata.description && (\n   228→              <p class=\"pressy-home-desc\">{book.metadata.description}</p>\n   229→            )}\n   230→          </header>\n   231→          {totalWords > 0 && (\n   232→            <div class=\"pressy-stats\">\n   233→              <span>{chapterCount} chapter{chapterCount !== 1 ? 's' : ''}</span>\n   234→              <span class=\"pressy-stats-sep\">&middot;</span>\n   235→              <span>{formattedWords} words</span>\n   236→              <span class=\"pressy-stats-sep\">&middot;</span>\n   237→              <span>~{readingMinutes} min</span>\n   238→              {publishYear && (\n   239→                <>\n   240→                  <span class=\"pressy-stats-sep\">&middot;</span>\n   241→                  <span>First published {publishYear}</span>\n   242→                </>\n   243→              )}\n   244→            </div>\n   245→          )}\n   246→          {chapterCount > 0 && <StartReadingCTA book={book} />}\n   247→        </div>\n   248→      </div>\n   249→      {articles.length > 0 && (\n   250→        <section class=\"pressy-home-section pressy-fade-sections\">\n   251→          <h2>Articles</h2>\n   252→          <nav class=\"pressy-chapter-list\">\n   253→            {articles.map((article: Article) => (\n   254→              <a\n   255→                href={`${basePath}/articles/${article.slug}`}\n   256→                class=\"pressy-chapter-link\"\n   257→              >\n   258→                {article.metadata.title}\n   259→              </a>\n   260→            ))}\n   261→          </nav>\n   262→        </section>\n   263→      )}\n   264→      <style>{HOME_STYLES}</style>\n   265→    </div>\n   266→  )\n   267→}\n   268→\n   269→function renderHomePage(manifest: ContentManifest) {\n   270→  // Single-book site: render as the book page\n   271→  if (manifest.books.length === 1) {\n   272→    return renderBookPage(manifest.books[0], manifest.articles)\n   273→  }\n   274→\n   275→  const siteTitle = manifest.books[0]?.metadata.title || 'Library'\n   276→\n   277→  return (\n   278→    <div class=\"pressy-home\">\n   279→      <header class=\"pressy-home-header\">\n   280→        <h1>{siteTitle}</h1>\n   281→        {manifest.books[0]?.metadata.description && (\n   282→          <p class=\"pressy-home-desc\">{manifest.books[0].metadata.description}</p>\n   283→        )}\n   284→      </header>\n   285→      {manifest.books.length > 0 && (\n   286→        <section class=\"pressy-home-section\">\n   287→          <h2>Books</h2>\n   288→          <nav class=\"pressy-chapter-list\">\n   289→            {manifest.books.map((book: Book) => (\n   290→              <a\n   291→                href={`${basePath}/books/${book.slug}`}\n   292→                class=\"pressy-chapter-link\"\n   293→              >\n   294→                {book.metadata.title}\n   295→              </a>\n   296→            ))}\n   297→          </nav>\n   298→        </section>\n   299→      )}\n   300→      {manifest.articles.length > 0 && (\n   301→        <section class=\"pressy-home-section\">\n   302→          <h2>Articles</h2>\n   303→          <nav class=\"pressy-chapter-list\">\n   304→            {manifest.articles.map((article: Article) => (\n   305→              <a\n   306→                href={`${basePath}/articles/${article.slug}`}\n   307→                class=\"pressy-chapter-link\"\n   308→              >\n   309→                {article.metadata.title}\n   310→              </a>\n   311→            ))}\n   312→          </nav>\n   313→        </section>\n   314→      )}\n   315→      <style>{HOME_STYLES}</style>\n   316→    </div>\n   317→  )\n   318→}\n   319→\n   320→// Calculates global book progress % from word counts + saved progress data\n   321→function calculateBookProgressPercent(\n   322→  book: Book,\n   323→  currentChapterSlug: string,\n   324→  currentPage: number,\n   325→  currentTotalPages: number,\n   326→  allProgress: ReadingProgress[],\n   327→): number {\n   328→  const totalWords = book.chapters.reduce((sum, ch) => sum + (ch.wordCount || 0), 0)\n   329→  if (totalWords === 0) return 0\n   330→\n   331→  const progressMap = new Map(allProgress.map((p) => [p.chapterSlug, p]))\n   332→  let wordsRead = 0\n   333→\n   334→  for (const ch of book.chapters) {\n   335→    const chapterWords = ch.wordCount || 0\n   336→    if (ch.slug === currentChapterSlug) {\n   337→      // Use live page position for current chapter\n   338→      if (currentTotalPages > 0) {\n   339→        wordsRead += (currentPage / Math.max(1, currentTotalPages - 1)) * chapterWords\n   340→      }\n   341→    } else {\n   342→      const progress = progressMap.get(ch.slug)\n   343→      if (!progress) continue\n   344→      if (progress.totalPages > 0 && progress.page >= progress.totalPages - 1) {\n   345→        wordsRead += chapterWords\n   346→      } else if (progress.page > 0 && progress.totalPages > 0) {\n   347→        wordsRead += (progress.page / progress.totalPages) * chapterWords\n   348→      }\n   349→    }\n   350→  }\n   351→\n   352→  return Math.min(100, (wordsRead / totalWords) * 100)\n   353→}\n   354→\n   355→// Wrapper component that provides progress callbacks and computes global progress\n   356→function ChapterReaderWithProgress({\n   357→  book,\n   358→  chapterSlug,\n   359→  chapter,\n   360→  prevChapter,\n   361→  nextChapter,\n   362→  paginationMode,\n   363→  Content,\n   364→  chapterMapData,\n   365→}: {\n   366→  book: Book\n   367→  chapterSlug: string\n   368→  chapter?: Chapter\n   369→  prevChapter?: { slug: string; title: string }\n   370→  nextChapter?: { slug: string; title: string }\n   371→  paginationMode?: 'scroll' | 'paginated'\n   372→  Content: ComponentType<{ components?: Record<string, unknown> }>\n   373→  chapterMapData?: ChapterMapData\n   374→}) {\n   375→  const [bookProgressPercent, setBookProgressPercent] = useState<number | undefined>(undefined)\n   376→\n   377→  // Load initial global book progress\n   378→  useEffect(() => {\n   379→    getAllReadingProgress().then((allProgress) => {\n   380→      const percent = calculateBookProgressPercent(book, chapterSlug, 0, 0, allProgress)\n   381→      setBookProgressPercent(percent)\n   382→    })\n   383→  }, [book, chapterSlug])\n   384→\n   385→  const handleSaveProgress = (data: ProgressData) => {\n   386→    saveReadingProgress({\n   387→      chapterSlug,\n   388→      page: data.page,\n   389→      totalPages: data.totalPages,\n   390→      scrollPosition: data.scrollPosition,\n   391→      timestamp: Date.now(),\n   392→    })\n   393→\n   394→    // Update global book progress with live page position\n   395→    if (data.totalPages > 0) {\n   396→      getAllReadingProgress().then((allProgress) => {\n   397→        const percent = calculateBookProgressPercent(\n   398→          book, chapterSlug, data.page, data.totalPages, allProgress,\n   399→        )\n   400→        setBookProgressPercent(percent)\n   401→      })\n   402→    }\n   403→  }\n   404→\n   405→  const handleRestoreProgress = async (): Promise<ProgressData | null> => {\n   406→    const progress = await getReadingProgress(chapterSlug)\n   407→    if (!progress) return null\n   408→    return {\n   409→      page: progress.page,\n   410→      totalPages: progress.totalPages,\n   411→      scrollPosition: progress.scrollPosition,\n   412→    }\n   413→  }\n   414→\n   415→  const handleChapterChange = (slug: string, page: number, chapterTotalPages: number) => {\n   416→    // Save progress for the chapter being left (mark as complete)\n   417→    saveReadingProgress({\n   418→      chapterSlug: slug,\n   419→      page,\n   420→      totalPages: chapterTotalPages,\n   421→      scrollPosition: 0,\n   422→      timestamp: Date.now(),\n   423→    })\n   424→\n   425→    // Update global book progress\n   426→    getAllReadingProgress().then((allProgress) => {\n   427→      const percent = calculateBookProgressPercent(book, slug, page, chapterTotalPages, allProgress)\n   428→      setBookProgressPercent(percent)\n   429→    })\n   430→  }\n   431→\n   432→  // Prefetch previous chapter HTML for fast backward navigation\n   433→  useEffect(() => {\n   434→    if (prevChapter) {\n   435→      const link = document.createElement('link')\n   436→      link.rel = 'prefetch'\n   437→      link.href = prevChapter.slug\n   438→      document.head.appendChild(link)\n   439→      return () => { document.head.removeChild(link) }\n   440→    }\n   441→  }, [prevChapter])\n   442→\n   443→  return (\n   444→    <Reader\n   445→      title={chapter?.title || chapterSlug}\n   446→      bookTitle={book.metadata.title}\n   447→      chapterSlug={chapterSlug}\n   448→      prevChapter={prevChapter}\n   449→      nextChapter={nextChapter}\n   450→      paginationMode={paginationMode}\n   451→      onSaveProgress={handleSaveProgress}\n   452→      onRestoreProgress={handleRestoreProgress}\n   453→      bookProgressPercent={bookProgressPercent}\n   454→      initialContent={Content}\n   455→      chapterMapData={chapterMapData}\n   456→      currentChapterSlug={chapterSlug}\n   457→      allChapters={book.chapters.map(ch => ({ slug: ch.slug, title: ch.title, wordCount: ch.wordCount }))}\n   458→      bookBasePath={`${basePath}/books/${book.slug}`}\n   459→      onChapterChange={handleChapterChange}\n   460→      mdxComponents={useMDXComponents()}\n   461→      offlineProps={{\n   462→        bookSlug: book.slug,\n   463→        chapterUrls: book.chapters.map(ch => `${basePath}/books/${book.slug}/${ch.slug}`),\n   464→        cachedBooks,\n   465→        cacheProgress,\n   466→        onDownload: downloadBookForOffline,\n   467→        onRemove: clearBookCache,\n   468→      }}\n   469→    >\n   470→      <Content components={useMDXComponents()} />\n   471→    </Reader>\n   472→  )\n   473→}\n   474→\n   475→function renderChapterPage(\n   476→  manifest: ContentManifest,\n   477→  route: string,\n   478→  Content: ComponentType,\n   479→  paginationMode?: 'scroll' | 'paginated',\n   480→  chapterMapData?: ChapterMapData,\n   481→) {\n   482→  const parts = route.split('/')\n   483→  const bookSlug = parts[2]\n   484→  const chapterSlug = parts[3]\n   485→  const book = manifest.books.find((b: Book) => b.slug === bookSlug)\n   486→  const chapterIdx = book ? book.chapters.findIndex((c: Chapter) => c.slug === chapterSlug) : -1\n   487→  const chapter = book?.chapters[chapterIdx]\n   488→  const chapterPath = (ch: Chapter) => `${basePath}/books/${bookSlug}/${ch.slug}`\n   489→  const prevChapter = book && chapterIdx > 0\n   490→    ? { slug: chapterPath(book.chapters[chapterIdx - 1]), title: book.chapters[chapterIdx - 1].title }\n   491→    : book\n   492→      ? { slug: `${basePath}/books/${bookSlug}`, title: book.metadata.title }\n   493→      : undefined\n   494→  const nextChapter = book && chapterIdx >= 0 && chapterIdx < book.chapters.length - 1\n   495→    ? { slug: chapterPath(book.chapters[chapterIdx + 1]), title: book.chapters[chapterIdx + 1].title }\n   496→    : book\n   497→      ? { slug: `${basePath}/books/${bookSlug}`, title: book.metadata.title }\n   498→      : undefined\n   499→\n   500→  const MDXContent = Content as ComponentType<{ components?: Record<string, unknown> }>\n   501→\n   502→  if (!book) {\n   503→    return (\n   504→      <Reader\n   505→        title={chapter?.title || chapterSlug}\n   506→        prevChapter={prevChapter}\n   507→        nextChapter={nextChapter}\n   508→        paginationMode={paginationMode}\n   509→      >\n   510→        <MDXContent components={useMDXComponents()} />\n   511→      </Reader>\n   512→    )\n   513→  }\n   514→\n   515→  return (\n   516→    <ChapterReaderWithProgress\n   517→      book={book}\n   518→      chapterSlug={chapterSlug}\n   519→      chapter={chapter}\n   520→      prevChapter={prevChapter}\n   521→      nextChapter={nextChapter}\n   522→      paginationMode={paginationMode}\n   523→      Content={MDXContent}\n   524→      chapterMapData={chapterMapData}\n   525→    />\n   526→  )\n   527→}\n   528→\n   529→function renderArticlePage(\n   530→  manifest: ContentManifest,\n   531→  route: string,\n   532→  Content: ComponentType,\n   533→) {\n   534→  const articleSlug = route.split('/')[2]\n   535→  const article = manifest.articles.find((a: Article) => a.slug === articleSlug)\n   536→\n   537→  const MDXContent = Content as ComponentType<{ components?: Record<string, unknown> }>\n   538→\n   539→  return (\n   540→    <Reader title={article?.metadata.title || articleSlug}>\n   541→      <MDXContent components={useMDXComponents()} />\n   542→    </Reader>\n   543→  )\n   544→}\n   545→\n   546→// ── Styles ──────────────────────────────────────────────────\n   547→\n   548→const HOME_STYLES = `\n   549→  @keyframes pressy-fade-in {\n   550→    from { opacity: 0; transform: translateY(20px); }\n   551→    to   { opacity: 1; transform: translateY(0); }\n   552→  }\n   553→  .pressy-home {\n   554→    max-width: 65ch;\n   555→    margin: 0 auto;\n   556→    padding: 2rem 1.5rem;\n   557→    font-family: var(--font-body, Georgia, 'Times New Roman', serif);\n   558→    color: var(--color-text, #1a1a1a);\n   559→  }\n   560→\n   561→  /* ── Hero layout ────────────────────────── */\n   562→  .pressy-hero {\n   563→    display: flex;\n   564→    align-items: flex-start;\n   565→    gap: 2.5rem;\n   566→    margin-bottom: 2.5rem;\n   567→  }\n   568→  .pressy-hero-cover {\n   569→    flex-shrink: 0;\n   570→    max-width: 280px;\n   571→    width: 100%;\n   572→    height: auto;\n   573→    border-radius: 4px;\n   574→    box-shadow: 0 4px 24px rgba(0,0,0,0.15);\n   575→    animation: pressy-fade-in 0.6s ease-out both;\n   576→  }\n   577→  .pressy-hero-text {\n   578→    flex: 1;\n   579→    animation: pressy-fade-in 0.6s ease-out 0.15s both;\n   580→  }\n   581→  @media (max-width: 700px) {\n   582→    .pressy-hero {\n   583→      flex-direction: column;\n   584→      align-items: center;\n   585→    }\n   586→    .pressy-hero-cover {\n   587→      max-width: 220px;\n   588→    }\n   589→    .pressy-hero-text {\n   590→      text-align: center;\n   591→    }\n   592→    .pressy-home-desc {\n   593→      margin-left: auto;\n   594→      margin-right: auto;\n   595→    }\n   596→    .pressy-stats {\n   597→      justify-content: center;\n   598→    }\n   599→  }\n   600→\n   601→  /* ── Header ─────────────────────────────── */\n   602→  .pressy-home-header {\n   603→    margin-bottom: 1rem;\n   604→  }\n   605→  .pressy-home-header h1 {\n   606→    font-size: 2rem;\n   607→    margin-bottom: 0.5rem;\n   608→  }\n   609→  .pressy-home-author {\n   610→    font-style: italic;\n   611→    color: var(--color-text-muted, #666);\n   612→  }\n   613→  .pressy-home-desc {\n   614→    color: var(--color-text-muted, #666);\n   615→    line-height: 1.6;\n   616→    max-width: 50ch;\n   617→    margin: 0.5rem 0 0;\n   618→  }\n   619→\n   620→  /* ── Stats row ──────────────────────────── */\n   621→  .pressy-stats {\n   622→    display: flex;\n   623→    flex-wrap: wrap;\n   624→    gap: 0.4em;\n   625→    font-size: 0.85rem;\n   626→    color: var(--color-text-muted, #666);\n   627→    margin-top: 1rem;\n   628→  }\n   629→  .pressy-stats-sep {\n   630→    opacity: 0.5;\n   631→  }\n   632→\n   633→  /* ── CTA button ─────────────────────────── */\n   634→  .pressy-cta {\n   635→    display: inline-block;\n   636→    margin-top: 1.25rem;\n   637→    padding: 0.75rem 1.75rem;\n   638→    background: var(--color-link, #2563eb);\n   639→    color: #fff;\n   640→    font-size: 1rem;\n   641→    font-weight: 600;\n   642→    text-decoration: none;\n   643→    border-radius: 0.5rem;\n   644→    transition: opacity 0.15s;\n   645→  }\n   646→  .pressy-cta:hover {\n   647→    opacity: 0.85;\n   648→  }\n   649→\n   650→  /* ── Sections below hero ────────────────── */\n   651→  .pressy-fade-sections {\n   652→    animation: pressy-fade-in 0.6s ease-out 0.3s both;\n   653→  }\n   654→  .pressy-home-section {\n   655→    margin-bottom: 2rem;\n   656→  }\n   657→  .pressy-home-section h2 {\n   658→    font-size: 1.25rem;\n   659→    margin-bottom: 1rem;\n   660→    border-bottom: 1px solid var(--color-border, #e5e5e5);\n   661→    padding-bottom: 0.5rem;\n   662→  }\n   663→  .pressy-chapter-list {\n   664→    display: flex;\n   665→    flex-direction: column;\n   666→    gap: 0.25rem;\n   667→  }\n   668→  .pressy-chapter-link {\n   669→    display: flex;\n   670→    gap: 0.75rem;\n   671→    padding: 0.75rem 1rem;\n   672→    text-decoration: none;\n   673→    color: var(--color-text, #1a1a1a);\n   674→    border-radius: 0.5rem;\n   675→    transition: background 0.15s;\n   676→  }\n   677→  .pressy-chapter-link:hover {\n   678→    background: var(--color-bg-subtle, #f5f5f5);\n   679→  }\n   680→  .pressy-chapter-order {\n   681→    color: var(--color-text-muted, #666);\n   682→    min-width: 2ch;\n   683→  }\n   684→\n   685→  /* ── Reduced motion ─────────────────────── */\n   686→  @media (prefers-reduced-motion: reduce) {\n   687→    .pressy-hero-cover,\n   688→    .pressy-hero-text,\n   689→    .pressy-fade-sections {\n   690→      animation: none;\n   691→    }\n   692→  }\n   693→`\n   694→\n   695→// ── Main hydration function ─────────────────────────────────\n   696→\n   697→interface HydrateData {\n   698→  route: string\n   699→  routeType: string\n   700→  manifest: ContentManifest\n   701→  pagination?: PaginationConfig\n   702→}\n   703→\n   704→// Compute the base path by comparing the known route to the actual URL\n   705→// e.g. URL=\"/pressy/pr-preview/pr-4/books/flatland\" with route=\"/books/flatland\"\n   706→// yields basePath=\"/pressy/pr-preview/pr-4\"\n   707→function getBasePath(route: string): string {\n   708→  const pathname = window.location.pathname\n   709→  // Remove trailing slash for comparison\n   710→  const cleanPath = pathname.endsWith('/') ? pathname.slice(0, -1) : pathname\n   711→  const cleanRoute = route.endsWith('/') ? route.slice(0, -1) : route\n   712→  if (cleanRoute === '' || cleanRoute === '/') {\n   713→    // Home page: strip /index.html or trailing slash\n   714→    return cleanPath.replace(/\\/index\\.html$/, '') || ''\n   715→  }\n   716→  const idx = cleanPath.indexOf(cleanRoute)\n   717→  if (idx > 0) {\n   718→    return cleanPath.slice(0, idx)\n   719→  }\n   720→  return ''\n   721→}\n   722→\n   723→let basePath = ''\n   724→\n   725→export function hydrate(data: HydrateData, Content?: ComponentType, chapterMapData?: ChapterMapData): void {\n   726→  basePath = getBasePath(data.route)\n   727→  currentRoute.value = data.route\n   728→\n   729→  // Initialize\n   730→  loadTheme()\n   731→  setupOfflineDetection()\n   732→  initDB()\n   733→\n   734→  // Register service worker for PWA offline support\n   735→  registerServiceWorker(basePath)\n   736→\n   737→  // Handle popstate for back/forward navigation\n   738→  window.addEventListener('popstate', () => {\n   739→    currentRoute.value = window.location.pathname\n   740→  })\n   741→\n   742→  // Handle client-side link clicks\n   743→  // For now, allow normal browser navigation for cross-page links\n   744→  // so each page loads its own HTML with the correct MDX content.\n   745→  // Only intercept hash links for in-page navigation.\n   746→  document.addEventListener('click', (e) => {\n   747→    const link = (e.target as HTMLElement).closest('a')\n   748→    if (!link) return\n   749→\n   750→    const href = link.getAttribute('href')\n   751→    if (!href) return\n   752→\n   753→    // Let external and full-page links navigate normally\n   754→    if (href.startsWith('http') || href.startsWith('#')) return\n   755→\n   756→    // Same-path hash links: handle client-side\n   757→    if (href.startsWith(data.route + '#')) {\n   758→      e.preventDefault()\n   759→      const hash = href.slice(href.indexOf('#'))\n   760→      const target = document.querySelector(hash)\n   761→      if (target) target.scrollIntoView({ behavior: 'smooth' })\n   762→      return\n   763→    }\n   764→\n   765→    // Cross-page links: let the browser navigate normally\n   766→    // (each page is a full server-rendered HTML document)\n   767→  })\n   768→\n   769→  // Render the app\n   770→  let page: VNode\n   771→  switch (data.routeType) {\n   772→    case 'home':\n   773→      page = renderHomePage(data.manifest)\n   774→      break\n   775→    case 'book': {\n   776→      const bookSlug = data.route.split('/')[2]\n   777→      const book = data.manifest.books.find((b: Book) => b.slug === bookSlug)\n   778→      page = book ? renderBookPage(book) : <div>Book not found</div>\n   779→      break\n   780→    }\n   781→    case 'chapter':\n   782→      page = Content\n   783→        ? renderChapterPage(data.manifest, data.route, Content, data.pagination?.defaultMode, chapterMapData)\n   784→        : <div>Loading...</div>\n   785→      break\n   786→    case 'article':\n   787→      page = Content\n   788→        ? renderArticlePage(data.manifest, data.route, Content)\n   789→        : <div>Loading...</div>\n   790→      break\n   791→    case 'books':\n   792→      page = renderHomePage(data.manifest)\n   793→      break\n   794→    case 'articles':\n   795→      page = renderHomePage(data.manifest)\n   796→      break\n   797→    default:\n   798→      page = <div>Page not found</div>\n   799→  }\n   800→\n   801→  render(page, document.getElementById('app')!)\n   802→}\n   803→\n   804→// Export for use in components\n   805→export { signal, effect }\n   806→"}]},"uuid":"d96deea9-decf-4e24-8444-c035238e56d4","timestamp":"2026-02-16T01:33:13.652Z","toolUseResult":{"type":"text","file":{"filePath":"/Users/blittle/dev/pressy/packages/pressy/src/runtime/client.tsx","content":"import { render, type ComponentType, type VNode } from 'preact'\nimport { useState, useEffect } from 'preact/hooks'\nimport { signal, effect } from '@preact/signals'\nimport { Reader } from '@pressy-pub/components'\nimport type { ProgressData } from '@pressy-pub/components'\nimport { useMDXComponents } from '@pressy-pub/components/content'\nimport {\n  registerServiceWorker,\n  downloadBookForOffline,\n  clearBookCache,\n  cachedBooks,\n  cacheProgress,\n} from './offline.js'\nimport type { ContentManifest, Route, Book, Chapter, Article, ReadingProgress, ChapterMapData } from '../types.js'\nimport type { PaginationConfig } from '../config.js'\n\n// State signals\nexport const currentRoute = signal<string>('/')\nexport const currentTheme = signal<'light' | 'dark' | 'sepia' | 'system'>('light')\nexport const isOffline = signal<boolean>(!navigator.onLine)\n\n// IndexedDB for reading progress\nconst DB_NAME = 'pressy'\nconst DB_VERSION = 1\nconst PROGRESS_STORE = 'reading-progress'\nconst UNLOCKS_STORE = 'unlocks'\n\nlet db: IDBDatabase | null = null\n\nasync function initDB(): Promise<IDBDatabase> {\n  if (db) return db\n\n  return new Promise((resolve, reject) => {\n    const request = indexedDB.open(DB_NAME, DB_VERSION)\n\n    request.onerror = () => reject(request.error)\n    request.onsuccess = () => {\n      db = request.result\n      resolve(db)\n    }\n\n    request.onupgradeneeded = (event) => {\n      const database = (event.target as IDBOpenDBRequest).result\n      if (!database.objectStoreNames.contains(PROGRESS_STORE)) {\n        database.createObjectStore(PROGRESS_STORE, { keyPath: 'chapterSlug' })\n      }\n      if (!database.objectStoreNames.contains(UNLOCKS_STORE)) {\n        database.createObjectStore(UNLOCKS_STORE, { keyPath: 'bookSlug' })\n      }\n    }\n  })\n}\n\nexport async function saveReadingProgress(progress: ReadingProgress): Promise<void> {\n  const database = await initDB()\n  return new Promise((resolve, reject) => {\n    const tx = database.transaction(PROGRESS_STORE, 'readwrite')\n    const store = tx.objectStore(PROGRESS_STORE)\n    const request = store.put(progress)\n    request.onsuccess = () => resolve()\n    request.onerror = () => reject(request.error)\n  })\n}\n\nexport async function getReadingProgress(chapterSlug: string): Promise<ReadingProgress | null> {\n  const database = await initDB()\n  return new Promise((resolve, reject) => {\n    const tx = database.transaction(PROGRESS_STORE, 'readonly')\n    const store = tx.objectStore(PROGRESS_STORE)\n    const request = store.get(chapterSlug)\n    request.onsuccess = () => resolve(request.result || null)\n    request.onerror = () => reject(request.error)\n  })\n}\n\nexport async function getAllReadingProgress(): Promise<ReadingProgress[]> {\n  const database = await initDB()\n  return new Promise((resolve, reject) => {\n    const tx = database.transaction(PROGRESS_STORE, 'readonly')\n    const store = tx.objectStore(PROGRESS_STORE)\n    const request = store.getAll()\n    request.onsuccess = () => resolve(request.result || [])\n    request.onerror = () => reject(request.error)\n  })\n}\n\nexport async function isBookUnlocked(bookSlug: string): Promise<boolean> {\n  const database = await initDB()\n  return new Promise((resolve, reject) => {\n    const tx = database.transaction(UNLOCKS_STORE, 'readonly')\n    const store = tx.objectStore(UNLOCKS_STORE)\n    const request = store.get(bookSlug)\n    request.onsuccess = () => resolve(!!request.result)\n    request.onerror = () => reject(request.error)\n  })\n}\n\nexport async function unlockBook(bookSlug: string, orderId?: string): Promise<void> {\n  const database = await initDB()\n  return new Promise((resolve, reject) => {\n    const tx = database.transaction(UNLOCKS_STORE, 'readwrite')\n    const store = tx.objectStore(UNLOCKS_STORE)\n    const request = store.put({ bookSlug, orderId, unlockedAt: Date.now() })\n    request.onsuccess = () => resolve()\n    request.onerror = () => reject(request.error)\n  })\n}\n\n// Client-side router\nexport function navigate(path: string, replace = false): void {\n  if (replace) {\n    history.replaceState(null, '', path)\n  } else {\n    history.pushState(null, '', path)\n  }\n  currentRoute.value = path\n}\n\n// Theme management\nfunction resolveSystemTheme(): 'light' | 'dark' {\n  return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light'\n}\n\nexport function setTheme(theme: 'light' | 'dark' | 'sepia' | 'system'): void {\n  currentTheme.value = theme\n  localStorage.setItem('pressy-theme', theme)\n  const resolved = theme === 'system' ? resolveSystemTheme() : theme\n  document.documentElement.setAttribute('data-theme', resolved)\n}\n\nfunction loadTheme(): void {\n  const saved = localStorage.getItem('pressy-theme') as 'light' | 'dark' | 'sepia' | 'system' | null\n  if (saved) {\n    setTheme(saved)\n  } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {\n    setTheme('dark')\n  }\n\n  // Listen for OS theme changes so \"system\" mode updates live\n  window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', () => {\n    if (currentTheme.value === 'system') {\n      document.documentElement.setAttribute('data-theme', resolveSystemTheme())\n    }\n  })\n}\n\n// Offline detection\nfunction setupOfflineDetection(): void {\n  window.addEventListener('online', () => {\n    isOffline.value = false\n  })\n  window.addEventListener('offline', () => {\n    isOffline.value = true\n  })\n}\n\n// ── Page renderers ──────────────────────────────────────────\n\nfunction StartReadingCTA({ book }: { book: Book }) {\n  const [target, setTarget] = useState<{ label: string; href: string } | null>(null)\n\n  useEffect(() => {\n    if (book.chapters.length === 0) return\n    const firstHref = `${basePath}/books/${book.slug}/${book.chapters[0].slug}`\n\n    getAllReadingProgress().then((allProgress) => {\n      const progressMap = new Map(allProgress.map((p) => [p.chapterSlug, p]))\n\n      // Walk chapters in order and find the furthest one that's in-progress (not completed)\n      let furthestInProgress: Chapter | null = null\n      for (const ch of book.chapters) {\n        const p = progressMap.get(ch.slug)\n        if (!p) continue\n        const completed = p.totalPages > 0 && p.page >= p.totalPages - 1\n        if (!completed && p.page > 0) {\n          furthestInProgress = ch\n        }\n      }\n\n      if (furthestInProgress) {\n        setTarget({\n          label: 'Continue Reading',\n          href: `${basePath}/books/${book.slug}/${furthestInProgress.slug}`,\n        })\n      } else {\n        setTarget({ label: 'Start Reading', href: firstHref })\n      }\n    }).catch(() => {\n      setTarget({ label: 'Start Reading', href: firstHref })\n    })\n  }, [book])\n\n  if (!target) return null\n\n  return (\n    <a href={target.href} class=\"pressy-cta\">\n      {target.label}\n    </a>\n  )\n}\n\nfunction renderBookPage(book: Book, articles: Article[] = []) {\n  // Stats calculations\n  const totalWords = book.chapters.reduce((sum, ch) => sum + (ch.wordCount || 0), 0)\n  const readingMinutes = Math.ceil(totalWords / 200)\n  const chapterCount = book.chapters.length\n  const publishYear = book.metadata.publishDate\n    ? new Date(book.metadata.publishDate).getFullYear()\n    : null\n\n  const formattedWords = totalWords.toLocaleString()\n\n  return (\n    <div class=\"pressy-home\">\n      <div class=\"pressy-hero\">\n        {book.coverUrl && (\n          <img\n            src={basePath + book.coverUrl}\n            alt={`${book.metadata.title} cover`}\n            class=\"pressy-hero-cover\"\n          />\n        )}\n        <div class=\"pressy-hero-text\">\n          <header class=\"pressy-home-header\">\n            <h1>{book.metadata.title}</h1>\n            <p class=\"pressy-home-author\">by {book.metadata.author}</p>\n            {book.metadata.description && (\n              <p class=\"pressy-home-desc\">{book.metadata.description}</p>\n            )}\n          </header>\n          {totalWords > 0 && (\n            <div class=\"pressy-stats\">\n              <span>{chapterCount} chapter{chapterCount !== 1 ? 's' : ''}</span>\n              <span class=\"pressy-stats-sep\">&middot;</span>\n              <span>{formattedWords} words</span>\n              <span class=\"pressy-stats-sep\">&middot;</span>\n              <span>~{readingMinutes} min</span>\n              {publishYear && (\n                <>\n                  <span class=\"pressy-stats-sep\">&middot;</span>\n                  <span>First published {publishYear}</span>\n                </>\n              )}\n            </div>\n          )}\n          {chapterCount > 0 && <StartReadingCTA book={book} />}\n        </div>\n      </div>\n      {articles.length > 0 && (\n        <section class=\"pressy-home-section pressy-fade-sections\">\n          <h2>Articles</h2>\n          <nav class=\"pressy-chapter-list\">\n            {articles.map((article: Article) => (\n              <a\n                href={`${basePath}/articles/${article.slug}`}\n                class=\"pressy-chapter-link\"\n              >\n                {article.metadata.title}\n              </a>\n            ))}\n          </nav>\n        </section>\n      )}\n      <style>{HOME_STYLES}</style>\n    </div>\n  )\n}\n\nfunction renderHomePage(manifest: ContentManifest) {\n  // Single-book site: render as the book page\n  if (manifest.books.length === 1) {\n    return renderBookPage(manifest.books[0], manifest.articles)\n  }\n\n  const siteTitle = manifest.books[0]?.metadata.title || 'Library'\n\n  return (\n    <div class=\"pressy-home\">\n      <header class=\"pressy-home-header\">\n        <h1>{siteTitle}</h1>\n        {manifest.books[0]?.metadata.description && (\n          <p class=\"pressy-home-desc\">{manifest.books[0].metadata.description}</p>\n        )}\n      </header>\n      {manifest.books.length > 0 && (\n        <section class=\"pressy-home-section\">\n          <h2>Books</h2>\n          <nav class=\"pressy-chapter-list\">\n            {manifest.books.map((book: Book) => (\n              <a\n                href={`${basePath}/books/${book.slug}`}\n                class=\"pressy-chapter-link\"\n              >\n                {book.metadata.title}\n              </a>\n            ))}\n          </nav>\n        </section>\n      )}\n      {manifest.articles.length > 0 && (\n        <section class=\"pressy-home-section\">\n          <h2>Articles</h2>\n          <nav class=\"pressy-chapter-list\">\n            {manifest.articles.map((article: Article) => (\n              <a\n                href={`${basePath}/articles/${article.slug}`}\n                class=\"pressy-chapter-link\"\n              >\n                {article.metadata.title}\n              </a>\n            ))}\n          </nav>\n        </section>\n      )}\n      <style>{HOME_STYLES}</style>\n    </div>\n  )\n}\n\n// Calculates global book progress % from word counts + saved progress data\nfunction calculateBookProgressPercent(\n  book: Book,\n  currentChapterSlug: string,\n  currentPage: number,\n  currentTotalPages: number,\n  allProgress: ReadingProgress[],\n): number {\n  const totalWords = book.chapters.reduce((sum, ch) => sum + (ch.wordCount || 0), 0)\n  if (totalWords === 0) return 0\n\n  const progressMap = new Map(allProgress.map((p) => [p.chapterSlug, p]))\n  let wordsRead = 0\n\n  for (const ch of book.chapters) {\n    const chapterWords = ch.wordCount || 0\n    if (ch.slug === currentChapterSlug) {\n      // Use live page position for current chapter\n      if (currentTotalPages > 0) {\n        wordsRead += (currentPage / Math.max(1, currentTotalPages - 1)) * chapterWords\n      }\n    } else {\n      const progress = progressMap.get(ch.slug)\n      if (!progress) continue\n      if (progress.totalPages > 0 && progress.page >= progress.totalPages - 1) {\n        wordsRead += chapterWords\n      } else if (progress.page > 0 && progress.totalPages > 0) {\n        wordsRead += (progress.page / progress.totalPages) * chapterWords\n      }\n    }\n  }\n\n  return Math.min(100, (wordsRead / totalWords) * 100)\n}\n\n// Wrapper component that provides progress callbacks and computes global progress\nfunction ChapterReaderWithProgress({\n  book,\n  chapterSlug,\n  chapter,\n  prevChapter,\n  nextChapter,\n  paginationMode,\n  Content,\n  chapterMapData,\n}: {\n  book: Book\n  chapterSlug: string\n  chapter?: Chapter\n  prevChapter?: { slug: string; title: string }\n  nextChapter?: { slug: string; title: string }\n  paginationMode?: 'scroll' | 'paginated'\n  Content: ComponentType<{ components?: Record<string, unknown> }>\n  chapterMapData?: ChapterMapData\n}) {\n  const [bookProgressPercent, setBookProgressPercent] = useState<number | undefined>(undefined)\n\n  // Load initial global book progress\n  useEffect(() => {\n    getAllReadingProgress().then((allProgress) => {\n      const percent = calculateBookProgressPercent(book, chapterSlug, 0, 0, allProgress)\n      setBookProgressPercent(percent)\n    })\n  }, [book, chapterSlug])\n\n  const handleSaveProgress = (data: ProgressData) => {\n    saveReadingProgress({\n      chapterSlug,\n      page: data.page,\n      totalPages: data.totalPages,\n      scrollPosition: data.scrollPosition,\n      timestamp: Date.now(),\n    })\n\n    // Update global book progress with live page position\n    if (data.totalPages > 0) {\n      getAllReadingProgress().then((allProgress) => {\n        const percent = calculateBookProgressPercent(\n          book, chapterSlug, data.page, data.totalPages, allProgress,\n        )\n        setBookProgressPercent(percent)\n      })\n    }\n  }\n\n  const handleRestoreProgress = async (): Promise<ProgressData | null> => {\n    const progress = await getReadingProgress(chapterSlug)\n    if (!progress) return null\n    return {\n      page: progress.page,\n      totalPages: progress.totalPages,\n      scrollPosition: progress.scrollPosition,\n    }\n  }\n\n  const handleChapterChange = (slug: string, page: number, chapterTotalPages: number) => {\n    // Save progress for the chapter being left (mark as complete)\n    saveReadingProgress({\n      chapterSlug: slug,\n      page,\n      totalPages: chapterTotalPages,\n      scrollPosition: 0,\n      timestamp: Date.now(),\n    })\n\n    // Update global book progress\n    getAllReadingProgress().then((allProgress) => {\n      const percent = calculateBookProgressPercent(book, slug, page, chapterTotalPages, allProgress)\n      setBookProgressPercent(percent)\n    })\n  }\n\n  // Prefetch previous chapter HTML for fast backward navigation\n  useEffect(() => {\n    if (prevChapter) {\n      const link = document.createElement('link')\n      link.rel = 'prefetch'\n      link.href = prevChapter.slug\n      document.head.appendChild(link)\n      return () => { document.head.removeChild(link) }\n    }\n  }, [prevChapter])\n\n  return (\n    <Reader\n      title={chapter?.title || chapterSlug}\n      bookTitle={book.metadata.title}\n      chapterSlug={chapterSlug}\n      prevChapter={prevChapter}\n      nextChapter={nextChapter}\n      paginationMode={paginationMode}\n      onSaveProgress={handleSaveProgress}\n      onRestoreProgress={handleRestoreProgress}\n      bookProgressPercent={bookProgressPercent}\n      initialContent={Content}\n      chapterMapData={chapterMapData}\n      currentChapterSlug={chapterSlug}\n      allChapters={book.chapters.map(ch => ({ slug: ch.slug, title: ch.title, wordCount: ch.wordCount }))}\n      bookBasePath={`${basePath}/books/${book.slug}`}\n      onChapterChange={handleChapterChange}\n      mdxComponents={useMDXComponents()}\n      offlineProps={{\n        bookSlug: book.slug,\n        chapterUrls: book.chapters.map(ch => `${basePath}/books/${book.slug}/${ch.slug}`),\n        cachedBooks,\n        cacheProgress,\n        onDownload: downloadBookForOffline,\n        onRemove: clearBookCache,\n      }}\n    >\n      <Content components={useMDXComponents()} />\n    </Reader>\n  )\n}\n\nfunction renderChapterPage(\n  manifest: ContentManifest,\n  route: string,\n  Content: ComponentType,\n  paginationMode?: 'scroll' | 'paginated',\n  chapterMapData?: ChapterMapData,\n) {\n  const parts = route.split('/')\n  const bookSlug = parts[2]\n  const chapterSlug = parts[3]\n  const book = manifest.books.find((b: Book) => b.slug === bookSlug)\n  const chapterIdx = book ? book.chapters.findIndex((c: Chapter) => c.slug === chapterSlug) : -1\n  const chapter = book?.chapters[chapterIdx]\n  const chapterPath = (ch: Chapter) => `${basePath}/books/${bookSlug}/${ch.slug}`\n  const prevChapter = book && chapterIdx > 0\n    ? { slug: chapterPath(book.chapters[chapterIdx - 1]), title: book.chapters[chapterIdx - 1].title }\n    : book\n      ? { slug: `${basePath}/books/${bookSlug}`, title: book.metadata.title }\n      : undefined\n  const nextChapter = book && chapterIdx >= 0 && chapterIdx < book.chapters.length - 1\n    ? { slug: chapterPath(book.chapters[chapterIdx + 1]), title: book.chapters[chapterIdx + 1].title }\n    : book\n      ? { slug: `${basePath}/books/${bookSlug}`, title: book.metadata.title }\n      : undefined\n\n  const MDXContent = Content as ComponentType<{ components?: Record<string, unknown> }>\n\n  if (!book) {\n    return (\n      <Reader\n        title={chapter?.title || chapterSlug}\n        prevChapter={prevChapter}\n        nextChapter={nextChapter}\n        paginationMode={paginationMode}\n      >\n        <MDXContent components={useMDXComponents()} />\n      </Reader>\n    )\n  }\n\n  return (\n    <ChapterReaderWithProgress\n      book={book}\n      chapterSlug={chapterSlug}\n      chapter={chapter}\n      prevChapter={prevChapter}\n      nextChapter={nextChapter}\n      paginationMode={paginationMode}\n      Content={MDXContent}\n      chapterMapData={chapterMapData}\n    />\n  )\n}\n\nfunction renderArticlePage(\n  manifest: ContentManifest,\n  route: string,\n  Content: ComponentType,\n) {\n  const articleSlug = route.split('/')[2]\n  const article = manifest.articles.find((a: Article) => a.slug === articleSlug)\n\n  const MDXContent = Content as ComponentType<{ components?: Record<string, unknown> }>\n\n  return (\n    <Reader title={article?.metadata.title || articleSlug}>\n      <MDXContent components={useMDXComponents()} />\n    </Reader>\n  )\n}\n\n// ── Styles ──────────────────────────────────────────────────\n\nconst HOME_STYLES = `\n  @keyframes pressy-fade-in {\n    from { opacity: 0; transform: translateY(20px); }\n    to   { opacity: 1; transform: translateY(0); }\n  }\n  .pressy-home {\n    max-width: 65ch;\n    margin: 0 auto;\n    padding: 2rem 1.5rem;\n    font-family: var(--font-body, Georgia, 'Times New Roman', serif);\n    color: var(--color-text, #1a1a1a);\n  }\n\n  /* ── Hero layout ────────────────────────── */\n  .pressy-hero {\n    display: flex;\n    align-items: flex-start;\n    gap: 2.5rem;\n    margin-bottom: 2.5rem;\n  }\n  .pressy-hero-cover {\n    flex-shrink: 0;\n    max-width: 280px;\n    width: 100%;\n    height: auto;\n    border-radius: 4px;\n    box-shadow: 0 4px 24px rgba(0,0,0,0.15);\n    animation: pressy-fade-in 0.6s ease-out both;\n  }\n  .pressy-hero-text {\n    flex: 1;\n    animation: pressy-fade-in 0.6s ease-out 0.15s both;\n  }\n  @media (max-width: 700px) {\n    .pressy-hero {\n      flex-direction: column;\n      align-items: center;\n    }\n    .pressy-hero-cover {\n      max-width: 220px;\n    }\n    .pressy-hero-text {\n      text-align: center;\n    }\n    .pressy-home-desc {\n      margin-left: auto;\n      margin-right: auto;\n    }\n    .pressy-stats {\n      justify-content: center;\n    }\n  }\n\n  /* ── Header ─────────────────────────────── */\n  .pressy-home-header {\n    margin-bottom: 1rem;\n  }\n  .pressy-home-header h1 {\n    font-size: 2rem;\n    margin-bottom: 0.5rem;\n  }\n  .pressy-home-author {\n    font-style: italic;\n    color: var(--color-text-muted, #666);\n  }\n  .pressy-home-desc {\n    color: var(--color-text-muted, #666);\n    line-height: 1.6;\n    max-width: 50ch;\n    margin: 0.5rem 0 0;\n  }\n\n  /* ── Stats row ──────────────────────────── */\n  .pressy-stats {\n    display: flex;\n    flex-wrap: wrap;\n    gap: 0.4em;\n    font-size: 0.85rem;\n    color: var(--color-text-muted, #666);\n    margin-top: 1rem;\n  }\n  .pressy-stats-sep {\n    opacity: 0.5;\n  }\n\n  /* ── CTA button ─────────────────────────── */\n  .pressy-cta {\n    display: inline-block;\n    margin-top: 1.25rem;\n    padding: 0.75rem 1.75rem;\n    background: var(--color-link, #2563eb);\n    color: #fff;\n    font-size: 1rem;\n    font-weight: 600;\n    text-decoration: none;\n    border-radius: 0.5rem;\n    transition: opacity 0.15s;\n  }\n  .pressy-cta:hover {\n    opacity: 0.85;\n  }\n\n  /* ── Sections below hero ────────────────── */\n  .pressy-fade-sections {\n    animation: pressy-fade-in 0.6s ease-out 0.3s both;\n  }\n  .pressy-home-section {\n    margin-bottom: 2rem;\n  }\n  .pressy-home-section h2 {\n    font-size: 1.25rem;\n    margin-bottom: 1rem;\n    border-bottom: 1px solid var(--color-border, #e5e5e5);\n    padding-bottom: 0.5rem;\n  }\n  .pressy-chapter-list {\n    display: flex;\n    flex-direction: column;\n    gap: 0.25rem;\n  }\n  .pressy-chapter-link {\n    display: flex;\n    gap: 0.75rem;\n    padding: 0.75rem 1rem;\n    text-decoration: none;\n    color: var(--color-text, #1a1a1a);\n    border-radius: 0.5rem;\n    transition: background 0.15s;\n  }\n  .pressy-chapter-link:hover {\n    background: var(--color-bg-subtle, #f5f5f5);\n  }\n  .pressy-chapter-order {\n    color: var(--color-text-muted, #666);\n    min-width: 2ch;\n  }\n\n  /* ── Reduced motion ─────────────────────── */\n  @media (prefers-reduced-motion: reduce) {\n    .pressy-hero-cover,\n    .pressy-hero-text,\n    .pressy-fade-sections {\n      animation: none;\n    }\n  }\n`\n\n// ── Main hydration function ─────────────────────────────────\n\ninterface HydrateData {\n  route: string\n  routeType: string\n  manifest: ContentManifest\n  pagination?: PaginationConfig\n}\n\n// Compute the base path by comparing the known route to the actual URL\n// e.g. URL=\"/pressy/pr-preview/pr-4/books/flatland\" with route=\"/books/flatland\"\n// yields basePath=\"/pressy/pr-preview/pr-4\"\nfunction getBasePath(route: string): string {\n  const pathname = window.location.pathname\n  // Remove trailing slash for comparison\n  const cleanPath = pathname.endsWith('/') ? pathname.slice(0, -1) : pathname\n  const cleanRoute = route.endsWith('/') ? route.slice(0, -1) : route\n  if (cleanRoute === '' || cleanRoute === '/') {\n    // Home page: strip /index.html or trailing slash\n    return cleanPath.replace(/\\/index\\.html$/, '') || ''\n  }\n  const idx = cleanPath.indexOf(cleanRoute)\n  if (idx > 0) {\n    return cleanPath.slice(0, idx)\n  }\n  return ''\n}\n\nlet basePath = ''\n\nexport function hydrate(data: HydrateData, Content?: ComponentType, chapterMapData?: ChapterMapData): void {\n  basePath = getBasePath(data.route)\n  currentRoute.value = data.route\n\n  // Initialize\n  loadTheme()\n  setupOfflineDetection()\n  initDB()\n\n  // Register service worker for PWA offline support\n  registerServiceWorker(basePath)\n\n  // Handle popstate for back/forward navigation\n  window.addEventListener('popstate', () => {\n    currentRoute.value = window.location.pathname\n  })\n\n  // Handle client-side link clicks\n  // For now, allow normal browser navigation for cross-page links\n  // so each page loads its own HTML with the correct MDX content.\n  // Only intercept hash links for in-page navigation.\n  document.addEventListener('click', (e) => {\n    const link = (e.target as HTMLElement).closest('a')\n    if (!link) return\n\n    const href = link.getAttribute('href')\n    if (!href) return\n\n    // Let external and full-page links navigate normally\n    if (href.startsWith('http') || href.startsWith('#')) return\n\n    // Same-path hash links: handle client-side\n    if (href.startsWith(data.route + '#')) {\n      e.preventDefault()\n      const hash = href.slice(href.indexOf('#'))\n      const target = document.querySelector(hash)\n      if (target) target.scrollIntoView({ behavior: 'smooth' })\n      return\n    }\n\n    // Cross-page links: let the browser navigate normally\n    // (each page is a full server-rendered HTML document)\n  })\n\n  // Render the app\n  let page: VNode\n  switch (data.routeType) {\n    case 'home':\n      page = renderHomePage(data.manifest)\n      break\n    case 'book': {\n      const bookSlug = data.route.split('/')[2]\n      const book = data.manifest.books.find((b: Book) => b.slug === bookSlug)\n      page = book ? renderBookPage(book) : <div>Book not found</div>\n      break\n    }\n    case 'chapter':\n      page = Content\n        ? renderChapterPage(data.manifest, data.route, Content, data.pagination?.defaultMode, chapterMapData)\n        : <div>Loading...</div>\n      break\n    case 'article':\n      page = Content\n        ? renderArticlePage(data.manifest, data.route, Content)\n        : <div>Loading...</div>\n      break\n    case 'books':\n      page = renderHomePage(data.manifest)\n      break\n    case 'articles':\n      page = renderHomePage(data.manifest)\n      break\n    default:\n      page = <div>Page not found</div>\n  }\n\n  render(page, document.getElementById('app')!)\n}\n\n// Export for use in components\nexport { signal, effect }\n","numLines":806,"startLine":1,"totalLines":806}},"sourceToolAssistantUUID":"6964b310-6f67-42f7-ba72-1fd125ab1c5f"}
{"parentUuid":"d96deea9-decf-4e24-8444-c035238e56d4","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","message":{"model":"claude-opus-4-6","id":"msg_01V7tpciJtMaEhhZCkucinjK","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"Now I have a clear picture of both files. Let me implement the changes as specified in the plan.\n\n1. First, add the install prompt signal and helpers to `offline.ts`\n2. Then, modify `client.tsx` to add the `InstallButton` component, call `setupInstallPrompt()`, and add styles\n\nLet me make all the edits.","signature":"EtUDCkYICxgCKkC97bmSKsiPV+5odr1VaBW+F+6EUwybUHqncj5Sc+Mqgin+/uSQE1+CtFBbnyeln80ex4gGzzRWJKAm7V7Z3N7vEgw40bA9ZcPTsF9UF7MaDGUd16a6kEPt44lSHiIwiMDACNpKMVUwrpEPwX2bmaNQkyFDMyRjlVJRwpzgptMRfBoc4TqMZnSqfs+y1OEYKrwCVClKFehI7gbul4g8SVKfszwgkWqoQCiB6wG9NDsOeIZkOPVInFRlrr4XbHOkHPLbYUBDATkYEp0WL/LcOSBH7N9tTJ9PK3ob/6B563cHaB9BwTFo1VLvrdQWJqoLW0BVr0lNz7Rd2uSZLWywjsJNZsG37bY7LxXz3RL8Q6KxHvq5FpPRW81aR1uTZ0auIExdt9bwjst5tKt+CZ5Evq+8/lO1BjS5a6xQf9dyGsV7R41bgA+357O73FrC7YXeeo0gzkZyyX9qCdRa2zsXj1deH/vShBJaBR+Hn0gHjF+ctMBwh5eqpByGnIwdMMEhuDoyIjyRG80gMQeT+FkMJcoljJOU/Spb7mnlGgldIS12+lyECrYXZO3sw3JwuV30+FS4hUqO4oU/3teh7zPnSOvnYdKdNvREMH1N2ocBaRgB"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":13089,"cache_read_input_tokens":20673,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":13089},"output_tokens":10,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CYAtNc6m6Rj5yXMDYXMhH","type":"assistant","uuid":"70825b2a-e198-445e-9b1f-32dc49cef557","timestamp":"2026-02-16T01:33:17.563Z"}
{"parentUuid":"70825b2a-e198-445e-9b1f-32dc49cef557","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","message":{"model":"claude-opus-4-6","id":"msg_01V7tpciJtMaEhhZCkucinjK","type":"message","role":"assistant","content":[{"type":"text","text":"Now I'll implement all the changes. Let me make the edits in parallel."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":13089,"cache_read_input_tokens":20673,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":13089},"output_tokens":10,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CYAtNc6m6Rj5yXMDYXMhH","type":"assistant","uuid":"fa30641c-c63d-416c-af8f-70f2f4d4a8b6","timestamp":"2026-02-16T01:33:18.238Z"}
{"parentUuid":"fa30641c-c63d-416c-af8f-70f2f4d4a8b6","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","message":{"model":"claude-opus-4-6","id":"msg_01V7tpciJtMaEhhZCkucinjK","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01Hg9ETevrwe9cxECR9HTxhp","name":"Edit","input":{"replace_all":false,"file_path":"/Users/blittle/dev/pressy/packages/pressy/src/runtime/offline.ts","old_string":"export const offlineStatus = signal<'online' | 'offline'>('online')\nexport const cacheProgress = signal<{ bookSlug: string; current: number; total: number } | null>(null)\nexport const swReady = signal<boolean>(false)","new_string":"export const offlineStatus = signal<'online' | 'offline'>('online')\nexport const cacheProgress = signal<{ bookSlug: string; current: number; total: number } | null>(null)\nexport const swReady = signal<boolean>(false)\nexport const installPrompt = signal<Event | null>(null)"},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":13089,"cache_read_input_tokens":20673,"output_tokens":361,"server_tool_use":{"web_search_requests":0,"web_fetch_requests":0},"service_tier":"standard","cache_creation":{"ephemeral_1h_input_tokens":13089,"ephemeral_5m_input_tokens":0},"inference_geo":"","iterations":[],"speed":"standard"}},"requestId":"req_011CYAtNc6m6Rj5yXMDYXMhH","type":"assistant","uuid":"22bf3d0a-6bc4-4577-b154-53bb695e0590","timestamp":"2026-02-16T01:33:21.359Z"}
{"type":"file-history-snapshot","messageId":"22bf3d0a-6bc4-4577-b154-53bb695e0590","snapshot":{"messageId":"dadb4ea5-c07a-4c84-8bd0-95386643597c","trackedFileBackups":{"packages/pressy/src/runtime/offline.ts":{"backupFileName":"259b478c67f372e9@v1","version":1,"backupTime":"2026-02-16T01:33:21.381Z"}},"timestamp":"2026-02-16T01:33:10.186Z"},"isSnapshotUpdate":true}
{"parentUuid":"22bf3d0a-6bc4-4577-b154-53bb695e0590","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","type":"progress","data":{"type":"hook_progress","hookEvent":"PostToolUse","hookName":"PostToolUse:Edit","command":"callback"},"parentToolUseID":"toolu_01Hg9ETevrwe9cxECR9HTxhp","toolUseID":"toolu_01Hg9ETevrwe9cxECR9HTxhp","timestamp":"2026-02-16T01:33:21.384Z","uuid":"83a658d8-fa6c-4f24-ba31-da9a9b19f730"}
{"parentUuid":"22bf3d0a-6bc4-4577-b154-53bb695e0590","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01Hg9ETevrwe9cxECR9HTxhp","type":"tool_result","content":"The file /Users/blittle/dev/pressy/packages/pressy/src/runtime/offline.ts has been updated successfully."}]},"uuid":"566bf33e-20ec-44c1-8e6f-ecc65d773947","timestamp":"2026-02-16T01:33:21.383Z","toolUseResult":{"filePath":"/Users/blittle/dev/pressy/packages/pressy/src/runtime/offline.ts","oldString":"export const offlineStatus = signal<'online' | 'offline'>('online')\nexport const cacheProgress = signal<{ bookSlug: string; current: number; total: number } | null>(null)\nexport const swReady = signal<boolean>(false)","newString":"export const offlineStatus = signal<'online' | 'offline'>('online')\nexport const cacheProgress = signal<{ bookSlug: string; current: number; total: number } | null>(null)\nexport const swReady = signal<boolean>(false)\nexport const installPrompt = signal<Event | null>(null)","originalFile":"import { signal } from '@preact/signals'\n\nconst CACHED_BOOKS_KEY = 'pressy-cached-books'\n\nexport const offlineStatus = signal<'online' | 'offline'>('online')\nexport const cacheProgress = signal<{ bookSlug: string; current: number; total: number } | null>(null)\nexport const swReady = signal<boolean>(false)\n\n// Restore cached books from localStorage synchronously on load\nfunction loadCachedBooks(): Set<string> {\n  if (typeof localStorage === 'undefined') return new Set()\n  try {\n    const stored = localStorage.getItem(CACHED_BOOKS_KEY)\n    if (stored) return new Set(JSON.parse(stored))\n  } catch {}\n  return new Set()\n}\n\nexport const cachedBooks = signal<Set<string>>(loadCachedBooks())\n\n// Initialize offline detection\nif (typeof window !== 'undefined') {\n  offlineStatus.value = navigator.onLine ? 'online' : 'offline'\n\n  window.addEventListener('online', () => {\n    offlineStatus.value = 'online'\n  })\n\n  window.addEventListener('offline', () => {\n    offlineStatus.value = 'offline'\n  })\n}\n\n// Service Worker registration\nexport async function registerServiceWorker(basePath = ''): Promise<ServiceWorkerRegistration | null> {\n  if (!('serviceWorker' in navigator)) {\n    console.warn('Service workers are not supported')\n    return null\n  }\n\n  const swUrl = basePath ? `${basePath}/sw.js` : '/sw.js'\n  const scope = basePath ? `${basePath}/` : '/'\n\n  try {\n    const registration = await navigator.serviceWorker.register(swUrl, {\n      scope,\n    })\n\n    // Listen for messages from service worker\n    navigator.serviceWorker.addEventListener('message', handleSWMessage)\n\n    // Mark SW as ready when controller is available\n    if (navigator.serviceWorker.controller) {\n      swReady.value = true\n    } else {\n      navigator.serviceWorker.addEventListener('controllerchange', () => {\n        swReady.value = true\n      })\n    }\n\n    // Handle updates\n    registration.addEventListener('updatefound', () => {\n      const newWorker = registration.installing\n      if (!newWorker) return\n\n      newWorker.addEventListener('statechange', () => {\n        if (newWorker.state === 'activated') {\n          swReady.value = true\n        }\n      })\n    })\n\n    return registration\n  } catch (err) {\n    console.error('Service worker registration failed:', err)\n    return null\n  }\n}\n\nfunction persistCachedBooks() {\n  try {\n    localStorage.setItem(CACHED_BOOKS_KEY, JSON.stringify([...cachedBooks.value]))\n  } catch {}\n}\n\nfunction handleSWMessage(event: MessageEvent) {\n  const { type } = event.data\n\n  if (type === 'CACHE_PROGRESS') {\n    const { bookSlug, current, total } = event.data\n    cacheProgress.value = { bookSlug, current, total }\n  }\n\n  if (type === 'CACHE_COMPLETE') {\n    const { bookSlug } = event.data\n    cacheProgress.value = null\n    const newCached = new Set(cachedBooks.value)\n    newCached.add(bookSlug)\n    cachedBooks.value = newCached\n    persistCachedBooks()\n  }\n\n  if (type === 'CACHE_STATUS') {\n    const { cached } = event.data as { cached: string[] }\n    const newCached = new Set<string>()\n    for (const url of cached) {\n      const match = url.match(/\\/books\\/([^/]+)/)\n      if (match) {\n        newCached.add(match[1])\n      }\n    }\n    cachedBooks.value = newCached\n    persistCachedBooks()\n  }\n\n  if (type === 'CACHE_CLEARED') {\n    const { bookSlug } = event.data\n    const newCached = new Set(cachedBooks.value)\n    newCached.delete(bookSlug)\n    cachedBooks.value = newCached\n    persistCachedBooks()\n  }\n}\n\n// Download a book for offline reading\nexport async function downloadBookForOffline(\n  bookSlug: string,\n  chapterUrls: string[]\n): Promise<boolean> {\n  if (!('serviceWorker' in navigator) || !navigator.serviceWorker.controller) {\n    console.warn('Service worker not available')\n    return false\n  }\n\n  // Build full URLs\n  const urls = chapterUrls.map((url) =>\n    url.startsWith('http') ? url : `${window.location.origin}${url}`\n  )\n\n  cacheProgress.value = { bookSlug, current: 0, total: urls.length }\n\n  // Optimistically persist to localStorage immediately so state survives refresh\n  const newCached = new Set(cachedBooks.value)\n  newCached.add(bookSlug)\n  cachedBooks.value = newCached\n  persistCachedBooks()\n\n  // Send message to service worker\n  navigator.serviceWorker.controller.postMessage({\n    type: 'CACHE_BOOK',\n    bookSlug,\n    urls,\n  })\n\n  return true\n}\n\n// Check if a book is available offline\nexport function isBookCached(bookSlug: string): boolean {\n  return cachedBooks.value.has(bookSlug)\n}\n\n// Get cache status for URLs\nexport async function checkCacheStatus(urls: string[]): Promise<void> {\n  if (!('serviceWorker' in navigator) || !navigator.serviceWorker.controller) {\n    return\n  }\n\n  navigator.serviceWorker.controller.postMessage({\n    type: 'GET_CACHE_STATUS',\n    urls: urls.map((url) =>\n      url.startsWith('http') ? url : `${window.location.origin}${url}`\n    ),\n  })\n}\n\n// Clear cached book\nexport async function clearBookCache(bookSlug: string): Promise<boolean> {\n  // Update state and persist immediately\n  const newCached = new Set(cachedBooks.value)\n  newCached.delete(bookSlug)\n  cachedBooks.value = newCached\n  persistCachedBooks()\n\n  if (!('serviceWorker' in navigator) || !navigator.serviceWorker.controller) {\n    // Fallback to direct cache API\n    try {\n      const cache = await caches.open('pressy-offline-books')\n      const keys = await cache.keys()\n\n      for (const request of keys) {\n        if (request.url.includes(`/books/${bookSlug}`)) {\n          await cache.delete(request)\n        }\n      }\n\n      return true\n    } catch (err) {\n      console.error('Failed to clear cache:', err)\n      return false\n    }\n  }\n\n  // Prefer message-based approach so SW can coordinate\n  navigator.serviceWorker.controller.postMessage({\n    type: 'CLEAR_BOOK_CACHE',\n    bookSlug,\n  })\n  return true\n}\n","structuredPatch":[{"oldStart":5,"oldLines":6,"newStart":5,"newLines":7,"lines":[" export const offlineStatus = signal<'online' | 'offline'>('online')"," export const cacheProgress = signal<{ bookSlug: string; current: number; total: number } | null>(null)"," export const swReady = signal<boolean>(false)","+export const installPrompt = signal<Event | null>(null)"," "," // Restore cached books from localStorage synchronously on load"," function loadCachedBooks(): Set<string> {"]}],"userModified":false,"replaceAll":false},"sourceToolAssistantUUID":"22bf3d0a-6bc4-4577-b154-53bb695e0590"}
{"parentUuid":"566bf33e-20ec-44c1-8e6f-ecc65d773947","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","message":{"model":"claude-opus-4-6","id":"msg_01E1u1gS5qbaq2D7ax9kiAH2","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01A1BqSSdhJVk6Hu6DLUHryi","name":"Edit","input":{"replace_all":false,"file_path":"/Users/blittle/dev/pressy/packages/pressy/src/runtime/offline.ts","old_string":"// Service Worker registration","new_string":"// PWA install prompt\nexport function setupInstallPrompt(): void {\n  window.addEventListener('beforeinstallprompt', (e) => {\n    e.preventDefault()\n    installPrompt.value = e\n  })\n  window.addEventListener('appinstalled', () => {\n    installPrompt.value = null\n  })\n}\n\nexport async function triggerInstall(): Promise<boolean> {\n  const prompt = installPrompt.value as any\n  if (!prompt) return false\n  prompt.prompt()\n  const { outcome } = await prompt.userChoice\n  installPrompt.value = null\n  return outcome === 'accepted'\n}\n\n// Service Worker registration"},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":422,"cache_read_input_tokens":33762,"output_tokens":272,"server_tool_use":{"web_search_requests":0,"web_fetch_requests":0},"service_tier":"standard","cache_creation":{"ephemeral_1h_input_tokens":422,"ephemeral_5m_input_tokens":0},"inference_geo":"","iterations":[],"speed":"standard"}},"requestId":"req_011CYAtPBDaTXSWPbDXaNHEv","type":"assistant","uuid":"381d1b18-1e33-4222-82ac-af6d6b18a93c","timestamp":"2026-02-16T01:33:26.121Z"}
{"parentUuid":"381d1b18-1e33-4222-82ac-af6d6b18a93c","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","type":"progress","data":{"type":"hook_progress","hookEvent":"PostToolUse","hookName":"PostToolUse:Edit","command":"callback"},"parentToolUseID":"toolu_01A1BqSSdhJVk6Hu6DLUHryi","toolUseID":"toolu_01A1BqSSdhJVk6Hu6DLUHryi","timestamp":"2026-02-16T01:33:26.142Z","uuid":"f789d9c8-f17d-4758-af79-1fd01624d4f0"}
{"parentUuid":"381d1b18-1e33-4222-82ac-af6d6b18a93c","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01A1BqSSdhJVk6Hu6DLUHryi","type":"tool_result","content":"The file /Users/blittle/dev/pressy/packages/pressy/src/runtime/offline.ts has been updated successfully."}]},"uuid":"8e2458a1-c218-44d2-b5a6-4d5d9963ee5f","timestamp":"2026-02-16T01:33:26.141Z","toolUseResult":{"filePath":"/Users/blittle/dev/pressy/packages/pressy/src/runtime/offline.ts","oldString":"// Service Worker registration","newString":"// PWA install prompt\nexport function setupInstallPrompt(): void {\n  window.addEventListener('beforeinstallprompt', (e) => {\n    e.preventDefault()\n    installPrompt.value = e\n  })\n  window.addEventListener('appinstalled', () => {\n    installPrompt.value = null\n  })\n}\n\nexport async function triggerInstall(): Promise<boolean> {\n  const prompt = installPrompt.value as any\n  if (!prompt) return false\n  prompt.prompt()\n  const { outcome } = await prompt.userChoice\n  installPrompt.value = null\n  return outcome === 'accepted'\n}\n\n// Service Worker registration","originalFile":"import { signal } from '@preact/signals'\n\nconst CACHED_BOOKS_KEY = 'pressy-cached-books'\n\nexport const offlineStatus = signal<'online' | 'offline'>('online')\nexport const cacheProgress = signal<{ bookSlug: string; current: number; total: number } | null>(null)\nexport const swReady = signal<boolean>(false)\nexport const installPrompt = signal<Event | null>(null)\n\n// Restore cached books from localStorage synchronously on load\nfunction loadCachedBooks(): Set<string> {\n  if (typeof localStorage === 'undefined') return new Set()\n  try {\n    const stored = localStorage.getItem(CACHED_BOOKS_KEY)\n    if (stored) return new Set(JSON.parse(stored))\n  } catch {}\n  return new Set()\n}\n\nexport const cachedBooks = signal<Set<string>>(loadCachedBooks())\n\n// Initialize offline detection\nif (typeof window !== 'undefined') {\n  offlineStatus.value = navigator.onLine ? 'online' : 'offline'\n\n  window.addEventListener('online', () => {\n    offlineStatus.value = 'online'\n  })\n\n  window.addEventListener('offline', () => {\n    offlineStatus.value = 'offline'\n  })\n}\n\n// Service Worker registration\nexport async function registerServiceWorker(basePath = ''): Promise<ServiceWorkerRegistration | null> {\n  if (!('serviceWorker' in navigator)) {\n    console.warn('Service workers are not supported')\n    return null\n  }\n\n  const swUrl = basePath ? `${basePath}/sw.js` : '/sw.js'\n  const scope = basePath ? `${basePath}/` : '/'\n\n  try {\n    const registration = await navigator.serviceWorker.register(swUrl, {\n      scope,\n    })\n\n    // Listen for messages from service worker\n    navigator.serviceWorker.addEventListener('message', handleSWMessage)\n\n    // Mark SW as ready when controller is available\n    if (navigator.serviceWorker.controller) {\n      swReady.value = true\n    } else {\n      navigator.serviceWorker.addEventListener('controllerchange', () => {\n        swReady.value = true\n      })\n    }\n\n    // Handle updates\n    registration.addEventListener('updatefound', () => {\n      const newWorker = registration.installing\n      if (!newWorker) return\n\n      newWorker.addEventListener('statechange', () => {\n        if (newWorker.state === 'activated') {\n          swReady.value = true\n        }\n      })\n    })\n\n    return registration\n  } catch (err) {\n    console.error('Service worker registration failed:', err)\n    return null\n  }\n}\n\nfunction persistCachedBooks() {\n  try {\n    localStorage.setItem(CACHED_BOOKS_KEY, JSON.stringify([...cachedBooks.value]))\n  } catch {}\n}\n\nfunction handleSWMessage(event: MessageEvent) {\n  const { type } = event.data\n\n  if (type === 'CACHE_PROGRESS') {\n    const { bookSlug, current, total } = event.data\n    cacheProgress.value = { bookSlug, current, total }\n  }\n\n  if (type === 'CACHE_COMPLETE') {\n    const { bookSlug } = event.data\n    cacheProgress.value = null\n    const newCached = new Set(cachedBooks.value)\n    newCached.add(bookSlug)\n    cachedBooks.value = newCached\n    persistCachedBooks()\n  }\n\n  if (type === 'CACHE_STATUS') {\n    const { cached } = event.data as { cached: string[] }\n    const newCached = new Set<string>()\n    for (const url of cached) {\n      const match = url.match(/\\/books\\/([^/]+)/)\n      if (match) {\n        newCached.add(match[1])\n      }\n    }\n    cachedBooks.value = newCached\n    persistCachedBooks()\n  }\n\n  if (type === 'CACHE_CLEARED') {\n    const { bookSlug } = event.data\n    const newCached = new Set(cachedBooks.value)\n    newCached.delete(bookSlug)\n    cachedBooks.value = newCached\n    persistCachedBooks()\n  }\n}\n\n// Download a book for offline reading\nexport async function downloadBookForOffline(\n  bookSlug: string,\n  chapterUrls: string[]\n): Promise<boolean> {\n  if (!('serviceWorker' in navigator) || !navigator.serviceWorker.controller) {\n    console.warn('Service worker not available')\n    return false\n  }\n\n  // Build full URLs\n  const urls = chapterUrls.map((url) =>\n    url.startsWith('http') ? url : `${window.location.origin}${url}`\n  )\n\n  cacheProgress.value = { bookSlug, current: 0, total: urls.length }\n\n  // Optimistically persist to localStorage immediately so state survives refresh\n  const newCached = new Set(cachedBooks.value)\n  newCached.add(bookSlug)\n  cachedBooks.value = newCached\n  persistCachedBooks()\n\n  // Send message to service worker\n  navigator.serviceWorker.controller.postMessage({\n    type: 'CACHE_BOOK',\n    bookSlug,\n    urls,\n  })\n\n  return true\n}\n\n// Check if a book is available offline\nexport function isBookCached(bookSlug: string): boolean {\n  return cachedBooks.value.has(bookSlug)\n}\n\n// Get cache status for URLs\nexport async function checkCacheStatus(urls: string[]): Promise<void> {\n  if (!('serviceWorker' in navigator) || !navigator.serviceWorker.controller) {\n    return\n  }\n\n  navigator.serviceWorker.controller.postMessage({\n    type: 'GET_CACHE_STATUS',\n    urls: urls.map((url) =>\n      url.startsWith('http') ? url : `${window.location.origin}${url}`\n    ),\n  })\n}\n\n// Clear cached book\nexport async function clearBookCache(bookSlug: string): Promise<boolean> {\n  // Update state and persist immediately\n  const newCached = new Set(cachedBooks.value)\n  newCached.delete(bookSlug)\n  cachedBooks.value = newCached\n  persistCachedBooks()\n\n  if (!('serviceWorker' in navigator) || !navigator.serviceWorker.controller) {\n    // Fallback to direct cache API\n    try {\n      const cache = await caches.open('pressy-offline-books')\n      const keys = await cache.keys()\n\n      for (const request of keys) {\n        if (request.url.includes(`/books/${bookSlug}`)) {\n          await cache.delete(request)\n        }\n      }\n\n      return true\n    } catch (err) {\n      console.error('Failed to clear cache:', err)\n      return false\n    }\n  }\n\n  // Prefer message-based approach so SW can coordinate\n  navigator.serviceWorker.controller.postMessage({\n    type: 'CLEAR_BOOK_CACHE',\n    bookSlug,\n  })\n  return true\n}\n","structuredPatch":[{"oldStart":32,"oldLines":6,"newStart":32,"newLines":26,"lines":["   })"," }"," ","+// PWA install prompt","+export function setupInstallPrompt(): void {","+  window.addEventListener('beforeinstallprompt', (e) => {","+    e.preventDefault()","+    installPrompt.value = e","+  })","+  window.addEventListener('appinstalled', () => {","+    installPrompt.value = null","+  })","+}","+","+export async function triggerInstall(): Promise<boolean> {","+  const prompt = installPrompt.value as any","+  if (!prompt) return false","+  prompt.prompt()","+  const { outcome } = await prompt.userChoice","+  installPrompt.value = null","+  return outcome === 'accepted'","+}","+"," // Service Worker registration"," export async function registerServiceWorker(basePath = ''): Promise<ServiceWorkerRegistration | null> {","   if (!('serviceWorker' in navigator)) {"]}],"userModified":false,"replaceAll":false},"sourceToolAssistantUUID":"381d1b18-1e33-4222-82ac-af6d6b18a93c"}
{"parentUuid":"8e2458a1-c218-44d2-b5a6-4d5d9963ee5f","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","message":{"model":"claude-opus-4-6","id":"msg_01RPGextQPYggn4AGZr8pZDf","type":"message","role":"assistant","content":[{"type":"text","text":"Now update `client.tsx` — add the imports, call `setupInstallPrompt()`, add the `InstallButton` component, wrap CTAs, and add styles."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":333,"cache_read_input_tokens":34184,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":333},"output_tokens":1,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CYAtPXavtFRJe5KNvzBYi","type":"assistant","uuid":"c2c4ceb7-b7cc-4c76-9cad-5ec1f3337161","timestamp":"2026-02-16T01:33:29.008Z"}
{"parentUuid":"c2c4ceb7-b7cc-4c76-9cad-5ec1f3337161","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","message":{"model":"claude-opus-4-6","id":"msg_01RPGextQPYggn4AGZr8pZDf","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01NmhNHjrsF4hYUNd8U5haNB","name":"Edit","input":{"replace_all":false,"file_path":"/Users/blittle/dev/pressy/packages/pressy/src/runtime/client.tsx","old_string":"import {\n  registerServiceWorker,\n  downloadBookForOffline,\n  clearBookCache,\n  cachedBooks,\n  cacheProgress,\n} from './offline.js'","new_string":"import {\n  registerServiceWorker,\n  downloadBookForOffline,\n  clearBookCache,\n  cachedBooks,\n  cacheProgress,\n  installPrompt,\n  setupInstallPrompt,\n  triggerInstall,\n} from './offline.js'"},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":333,"cache_read_input_tokens":34184,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":333},"output_tokens":1,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CYAtPXavtFRJe5KNvzBYi","type":"assistant","uuid":"68ffb6a6-5845-4204-9950-1dd4a6adff04","timestamp":"2026-02-16T01:33:31.170Z"}
{"type":"file-history-snapshot","messageId":"68ffb6a6-5845-4204-9950-1dd4a6adff04","snapshot":{"messageId":"dadb4ea5-c07a-4c84-8bd0-95386643597c","trackedFileBackups":{"packages/pressy/src/runtime/offline.ts":{"backupFileName":"259b478c67f372e9@v1","version":1,"backupTime":"2026-02-16T01:33:21.381Z"},"packages/pressy/src/runtime/client.tsx":{"backupFileName":"553e6fae6ff514b2@v1","version":1,"backupTime":"2026-02-16T01:33:31.186Z"}},"timestamp":"2026-02-16T01:33:10.186Z"},"isSnapshotUpdate":true}
{"parentUuid":"68ffb6a6-5845-4204-9950-1dd4a6adff04","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","type":"progress","data":{"type":"hook_progress","hookEvent":"PostToolUse","hookName":"PostToolUse:Edit","command":"callback"},"parentToolUseID":"toolu_01NmhNHjrsF4hYUNd8U5haNB","toolUseID":"toolu_01NmhNHjrsF4hYUNd8U5haNB","timestamp":"2026-02-16T01:33:31.188Z","uuid":"827273da-4b84-439e-a2b9-d8038c020a46"}
{"parentUuid":"68ffb6a6-5845-4204-9950-1dd4a6adff04","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01NmhNHjrsF4hYUNd8U5haNB","type":"tool_result","content":"The file /Users/blittle/dev/pressy/packages/pressy/src/runtime/client.tsx has been updated successfully."}]},"uuid":"192c07b6-1b5d-426c-ad76-e6ac91913086","timestamp":"2026-02-16T01:33:31.187Z","toolUseResult":{"filePath":"/Users/blittle/dev/pressy/packages/pressy/src/runtime/client.tsx","oldString":"import {\n  registerServiceWorker,\n  downloadBookForOffline,\n  clearBookCache,\n  cachedBooks,\n  cacheProgress,\n} from './offline.js'","newString":"import {\n  registerServiceWorker,\n  downloadBookForOffline,\n  clearBookCache,\n  cachedBooks,\n  cacheProgress,\n  installPrompt,\n  setupInstallPrompt,\n  triggerInstall,\n} from './offline.js'","originalFile":"import { render, type ComponentType, type VNode } from 'preact'\nimport { useState, useEffect } from 'preact/hooks'\nimport { signal, effect } from '@preact/signals'\nimport { Reader } from '@pressy-pub/components'\nimport type { ProgressData } from '@pressy-pub/components'\nimport { useMDXComponents } from '@pressy-pub/components/content'\nimport {\n  registerServiceWorker,\n  downloadBookForOffline,\n  clearBookCache,\n  cachedBooks,\n  cacheProgress,\n} from './offline.js'\nimport type { ContentManifest, Route, Book, Chapter, Article, ReadingProgress, ChapterMapData } from '../types.js'\nimport type { PaginationConfig } from '../config.js'\n\n// State signals\nexport const currentRoute = signal<string>('/')\nexport const currentTheme = signal<'light' | 'dark' | 'sepia' | 'system'>('light')\nexport const isOffline = signal<boolean>(!navigator.onLine)\n\n// IndexedDB for reading progress\nconst DB_NAME = 'pressy'\nconst DB_VERSION = 1\nconst PROGRESS_STORE = 'reading-progress'\nconst UNLOCKS_STORE = 'unlocks'\n\nlet db: IDBDatabase | null = null\n\nasync function initDB(): Promise<IDBDatabase> {\n  if (db) return db\n\n  return new Promise((resolve, reject) => {\n    const request = indexedDB.open(DB_NAME, DB_VERSION)\n\n    request.onerror = () => reject(request.error)\n    request.onsuccess = () => {\n      db = request.result\n      resolve(db)\n    }\n\n    request.onupgradeneeded = (event) => {\n      const database = (event.target as IDBOpenDBRequest).result\n      if (!database.objectStoreNames.contains(PROGRESS_STORE)) {\n        database.createObjectStore(PROGRESS_STORE, { keyPath: 'chapterSlug' })\n      }\n      if (!database.objectStoreNames.contains(UNLOCKS_STORE)) {\n        database.createObjectStore(UNLOCKS_STORE, { keyPath: 'bookSlug' })\n      }\n    }\n  })\n}\n\nexport async function saveReadingProgress(progress: ReadingProgress): Promise<void> {\n  const database = await initDB()\n  return new Promise((resolve, reject) => {\n    const tx = database.transaction(PROGRESS_STORE, 'readwrite')\n    const store = tx.objectStore(PROGRESS_STORE)\n    const request = store.put(progress)\n    request.onsuccess = () => resolve()\n    request.onerror = () => reject(request.error)\n  })\n}\n\nexport async function getReadingProgress(chapterSlug: string): Promise<ReadingProgress | null> {\n  const database = await initDB()\n  return new Promise((resolve, reject) => {\n    const tx = database.transaction(PROGRESS_STORE, 'readonly')\n    const store = tx.objectStore(PROGRESS_STORE)\n    const request = store.get(chapterSlug)\n    request.onsuccess = () => resolve(request.result || null)\n    request.onerror = () => reject(request.error)\n  })\n}\n\nexport async function getAllReadingProgress(): Promise<ReadingProgress[]> {\n  const database = await initDB()\n  return new Promise((resolve, reject) => {\n    const tx = database.transaction(PROGRESS_STORE, 'readonly')\n    const store = tx.objectStore(PROGRESS_STORE)\n    const request = store.getAll()\n    request.onsuccess = () => resolve(request.result || [])\n    request.onerror = () => reject(request.error)\n  })\n}\n\nexport async function isBookUnlocked(bookSlug: string): Promise<boolean> {\n  const database = await initDB()\n  return new Promise((resolve, reject) => {\n    const tx = database.transaction(UNLOCKS_STORE, 'readonly')\n    const store = tx.objectStore(UNLOCKS_STORE)\n    const request = store.get(bookSlug)\n    request.onsuccess = () => resolve(!!request.result)\n    request.onerror = () => reject(request.error)\n  })\n}\n\nexport async function unlockBook(bookSlug: string, orderId?: string): Promise<void> {\n  const database = await initDB()\n  return new Promise((resolve, reject) => {\n    const tx = database.transaction(UNLOCKS_STORE, 'readwrite')\n    const store = tx.objectStore(UNLOCKS_STORE)\n    const request = store.put({ bookSlug, orderId, unlockedAt: Date.now() })\n    request.onsuccess = () => resolve()\n    request.onerror = () => reject(request.error)\n  })\n}\n\n// Client-side router\nexport function navigate(path: string, replace = false): void {\n  if (replace) {\n    history.replaceState(null, '', path)\n  } else {\n    history.pushState(null, '', path)\n  }\n  currentRoute.value = path\n}\n\n// Theme management\nfunction resolveSystemTheme(): 'light' | 'dark' {\n  return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light'\n}\n\nexport function setTheme(theme: 'light' | 'dark' | 'sepia' | 'system'): void {\n  currentTheme.value = theme\n  localStorage.setItem('pressy-theme', theme)\n  const resolved = theme === 'system' ? resolveSystemTheme() : theme\n  document.documentElement.setAttribute('data-theme', resolved)\n}\n\nfunction loadTheme(): void {\n  const saved = localStorage.getItem('pressy-theme') as 'light' | 'dark' | 'sepia' | 'system' | null\n  if (saved) {\n    setTheme(saved)\n  } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {\n    setTheme('dark')\n  }\n\n  // Listen for OS theme changes so \"system\" mode updates live\n  window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', () => {\n    if (currentTheme.value === 'system') {\n      document.documentElement.setAttribute('data-theme', resolveSystemTheme())\n    }\n  })\n}\n\n// Offline detection\nfunction setupOfflineDetection(): void {\n  window.addEventListener('online', () => {\n    isOffline.value = false\n  })\n  window.addEventListener('offline', () => {\n    isOffline.value = true\n  })\n}\n\n// ── Page renderers ──────────────────────────────────────────\n\nfunction StartReadingCTA({ book }: { book: Book }) {\n  const [target, setTarget] = useState<{ label: string; href: string } | null>(null)\n\n  useEffect(() => {\n    if (book.chapters.length === 0) return\n    const firstHref = `${basePath}/books/${book.slug}/${book.chapters[0].slug}`\n\n    getAllReadingProgress().then((allProgress) => {\n      const progressMap = new Map(allProgress.map((p) => [p.chapterSlug, p]))\n\n      // Walk chapters in order and find the furthest one that's in-progress (not completed)\n      let furthestInProgress: Chapter | null = null\n      for (const ch of book.chapters) {\n        const p = progressMap.get(ch.slug)\n        if (!p) continue\n        const completed = p.totalPages > 0 && p.page >= p.totalPages - 1\n        if (!completed && p.page > 0) {\n          furthestInProgress = ch\n        }\n      }\n\n      if (furthestInProgress) {\n        setTarget({\n          label: 'Continue Reading',\n          href: `${basePath}/books/${book.slug}/${furthestInProgress.slug}`,\n        })\n      } else {\n        setTarget({ label: 'Start Reading', href: firstHref })\n      }\n    }).catch(() => {\n      setTarget({ label: 'Start Reading', href: firstHref })\n    })\n  }, [book])\n\n  if (!target) return null\n\n  return (\n    <a href={target.href} class=\"pressy-cta\">\n      {target.label}\n    </a>\n  )\n}\n\nfunction renderBookPage(book: Book, articles: Article[] = []) {\n  // Stats calculations\n  const totalWords = book.chapters.reduce((sum, ch) => sum + (ch.wordCount || 0), 0)\n  const readingMinutes = Math.ceil(totalWords / 200)\n  const chapterCount = book.chapters.length\n  const publishYear = book.metadata.publishDate\n    ? new Date(book.metadata.publishDate).getFullYear()\n    : null\n\n  const formattedWords = totalWords.toLocaleString()\n\n  return (\n    <div class=\"pressy-home\">\n      <div class=\"pressy-hero\">\n        {book.coverUrl && (\n          <img\n            src={basePath + book.coverUrl}\n            alt={`${book.metadata.title} cover`}\n            class=\"pressy-hero-cover\"\n          />\n        )}\n        <div class=\"pressy-hero-text\">\n          <header class=\"pressy-home-header\">\n            <h1>{book.metadata.title}</h1>\n            <p class=\"pressy-home-author\">by {book.metadata.author}</p>\n            {book.metadata.description && (\n              <p class=\"pressy-home-desc\">{book.metadata.description}</p>\n            )}\n          </header>\n          {totalWords > 0 && (\n            <div class=\"pressy-stats\">\n              <span>{chapterCount} chapter{chapterCount !== 1 ? 's' : ''}</span>\n              <span class=\"pressy-stats-sep\">&middot;</span>\n              <span>{formattedWords} words</span>\n              <span class=\"pressy-stats-sep\">&middot;</span>\n              <span>~{readingMinutes} min</span>\n              {publishYear && (\n                <>\n                  <span class=\"pressy-stats-sep\">&middot;</span>\n                  <span>First published {publishYear}</span>\n                </>\n              )}\n            </div>\n          )}\n          {chapterCount > 0 && <StartReadingCTA book={book} />}\n        </div>\n      </div>\n      {articles.length > 0 && (\n        <section class=\"pressy-home-section pressy-fade-sections\">\n          <h2>Articles</h2>\n          <nav class=\"pressy-chapter-list\">\n            {articles.map((article: Article) => (\n              <a\n                href={`${basePath}/articles/${article.slug}`}\n                class=\"pressy-chapter-link\"\n              >\n                {article.metadata.title}\n              </a>\n            ))}\n          </nav>\n        </section>\n      )}\n      <style>{HOME_STYLES}</style>\n    </div>\n  )\n}\n\nfunction renderHomePage(manifest: ContentManifest) {\n  // Single-book site: render as the book page\n  if (manifest.books.length === 1) {\n    return renderBookPage(manifest.books[0], manifest.articles)\n  }\n\n  const siteTitle = manifest.books[0]?.metadata.title || 'Library'\n\n  return (\n    <div class=\"pressy-home\">\n      <header class=\"pressy-home-header\">\n        <h1>{siteTitle}</h1>\n        {manifest.books[0]?.metadata.description && (\n          <p class=\"pressy-home-desc\">{manifest.books[0].metadata.description}</p>\n        )}\n      </header>\n      {manifest.books.length > 0 && (\n        <section class=\"pressy-home-section\">\n          <h2>Books</h2>\n          <nav class=\"pressy-chapter-list\">\n            {manifest.books.map((book: Book) => (\n              <a\n                href={`${basePath}/books/${book.slug}`}\n                class=\"pressy-chapter-link\"\n              >\n                {book.metadata.title}\n              </a>\n            ))}\n          </nav>\n        </section>\n      )}\n      {manifest.articles.length > 0 && (\n        <section class=\"pressy-home-section\">\n          <h2>Articles</h2>\n          <nav class=\"pressy-chapter-list\">\n            {manifest.articles.map((article: Article) => (\n              <a\n                href={`${basePath}/articles/${article.slug}`}\n                class=\"pressy-chapter-link\"\n              >\n                {article.metadata.title}\n              </a>\n            ))}\n          </nav>\n        </section>\n      )}\n      <style>{HOME_STYLES}</style>\n    </div>\n  )\n}\n\n// Calculates global book progress % from word counts + saved progress data\nfunction calculateBookProgressPercent(\n  book: Book,\n  currentChapterSlug: string,\n  currentPage: number,\n  currentTotalPages: number,\n  allProgress: ReadingProgress[],\n): number {\n  const totalWords = book.chapters.reduce((sum, ch) => sum + (ch.wordCount || 0), 0)\n  if (totalWords === 0) return 0\n\n  const progressMap = new Map(allProgress.map((p) => [p.chapterSlug, p]))\n  let wordsRead = 0\n\n  for (const ch of book.chapters) {\n    const chapterWords = ch.wordCount || 0\n    if (ch.slug === currentChapterSlug) {\n      // Use live page position for current chapter\n      if (currentTotalPages > 0) {\n        wordsRead += (currentPage / Math.max(1, currentTotalPages - 1)) * chapterWords\n      }\n    } else {\n      const progress = progressMap.get(ch.slug)\n      if (!progress) continue\n      if (progress.totalPages > 0 && progress.page >= progress.totalPages - 1) {\n        wordsRead += chapterWords\n      } else if (progress.page > 0 && progress.totalPages > 0) {\n        wordsRead += (progress.page / progress.totalPages) * chapterWords\n      }\n    }\n  }\n\n  return Math.min(100, (wordsRead / totalWords) * 100)\n}\n\n// Wrapper component that provides progress callbacks and computes global progress\nfunction ChapterReaderWithProgress({\n  book,\n  chapterSlug,\n  chapter,\n  prevChapter,\n  nextChapter,\n  paginationMode,\n  Content,\n  chapterMapData,\n}: {\n  book: Book\n  chapterSlug: string\n  chapter?: Chapter\n  prevChapter?: { slug: string; title: string }\n  nextChapter?: { slug: string; title: string }\n  paginationMode?: 'scroll' | 'paginated'\n  Content: ComponentType<{ components?: Record<string, unknown> }>\n  chapterMapData?: ChapterMapData\n}) {\n  const [bookProgressPercent, setBookProgressPercent] = useState<number | undefined>(undefined)\n\n  // Load initial global book progress\n  useEffect(() => {\n    getAllReadingProgress().then((allProgress) => {\n      const percent = calculateBookProgressPercent(book, chapterSlug, 0, 0, allProgress)\n      setBookProgressPercent(percent)\n    })\n  }, [book, chapterSlug])\n\n  const handleSaveProgress = (data: ProgressData) => {\n    saveReadingProgress({\n      chapterSlug,\n      page: data.page,\n      totalPages: data.totalPages,\n      scrollPosition: data.scrollPosition,\n      timestamp: Date.now(),\n    })\n\n    // Update global book progress with live page position\n    if (data.totalPages > 0) {\n      getAllReadingProgress().then((allProgress) => {\n        const percent = calculateBookProgressPercent(\n          book, chapterSlug, data.page, data.totalPages, allProgress,\n        )\n        setBookProgressPercent(percent)\n      })\n    }\n  }\n\n  const handleRestoreProgress = async (): Promise<ProgressData | null> => {\n    const progress = await getReadingProgress(chapterSlug)\n    if (!progress) return null\n    return {\n      page: progress.page,\n      totalPages: progress.totalPages,\n      scrollPosition: progress.scrollPosition,\n    }\n  }\n\n  const handleChapterChange = (slug: string, page: number, chapterTotalPages: number) => {\n    // Save progress for the chapter being left (mark as complete)\n    saveReadingProgress({\n      chapterSlug: slug,\n      page,\n      totalPages: chapterTotalPages,\n      scrollPosition: 0,\n      timestamp: Date.now(),\n    })\n\n    // Update global book progress\n    getAllReadingProgress().then((allProgress) => {\n      const percent = calculateBookProgressPercent(book, slug, page, chapterTotalPages, allProgress)\n      setBookProgressPercent(percent)\n    })\n  }\n\n  // Prefetch previous chapter HTML for fast backward navigation\n  useEffect(() => {\n    if (prevChapter) {\n      const link = document.createElement('link')\n      link.rel = 'prefetch'\n      link.href = prevChapter.slug\n      document.head.appendChild(link)\n      return () => { document.head.removeChild(link) }\n    }\n  }, [prevChapter])\n\n  return (\n    <Reader\n      title={chapter?.title || chapterSlug}\n      bookTitle={book.metadata.title}\n      chapterSlug={chapterSlug}\n      prevChapter={prevChapter}\n      nextChapter={nextChapter}\n      paginationMode={paginationMode}\n      onSaveProgress={handleSaveProgress}\n      onRestoreProgress={handleRestoreProgress}\n      bookProgressPercent={bookProgressPercent}\n      initialContent={Content}\n      chapterMapData={chapterMapData}\n      currentChapterSlug={chapterSlug}\n      allChapters={book.chapters.map(ch => ({ slug: ch.slug, title: ch.title, wordCount: ch.wordCount }))}\n      bookBasePath={`${basePath}/books/${book.slug}`}\n      onChapterChange={handleChapterChange}\n      mdxComponents={useMDXComponents()}\n      offlineProps={{\n        bookSlug: book.slug,\n        chapterUrls: book.chapters.map(ch => `${basePath}/books/${book.slug}/${ch.slug}`),\n        cachedBooks,\n        cacheProgress,\n        onDownload: downloadBookForOffline,\n        onRemove: clearBookCache,\n      }}\n    >\n      <Content components={useMDXComponents()} />\n    </Reader>\n  )\n}\n\nfunction renderChapterPage(\n  manifest: ContentManifest,\n  route: string,\n  Content: ComponentType,\n  paginationMode?: 'scroll' | 'paginated',\n  chapterMapData?: ChapterMapData,\n) {\n  const parts = route.split('/')\n  const bookSlug = parts[2]\n  const chapterSlug = parts[3]\n  const book = manifest.books.find((b: Book) => b.slug === bookSlug)\n  const chapterIdx = book ? book.chapters.findIndex((c: Chapter) => c.slug === chapterSlug) : -1\n  const chapter = book?.chapters[chapterIdx]\n  const chapterPath = (ch: Chapter) => `${basePath}/books/${bookSlug}/${ch.slug}`\n  const prevChapter = book && chapterIdx > 0\n    ? { slug: chapterPath(book.chapters[chapterIdx - 1]), title: book.chapters[chapterIdx - 1].title }\n    : book\n      ? { slug: `${basePath}/books/${bookSlug}`, title: book.metadata.title }\n      : undefined\n  const nextChapter = book && chapterIdx >= 0 && chapterIdx < book.chapters.length - 1\n    ? { slug: chapterPath(book.chapters[chapterIdx + 1]), title: book.chapters[chapterIdx + 1].title }\n    : book\n      ? { slug: `${basePath}/books/${bookSlug}`, title: book.metadata.title }\n      : undefined\n\n  const MDXContent = Content as ComponentType<{ components?: Record<string, unknown> }>\n\n  if (!book) {\n    return (\n      <Reader\n        title={chapter?.title || chapterSlug}\n        prevChapter={prevChapter}\n        nextChapter={nextChapter}\n        paginationMode={paginationMode}\n      >\n        <MDXContent components={useMDXComponents()} />\n      </Reader>\n    )\n  }\n\n  return (\n    <ChapterReaderWithProgress\n      book={book}\n      chapterSlug={chapterSlug}\n      chapter={chapter}\n      prevChapter={prevChapter}\n      nextChapter={nextChapter}\n      paginationMode={paginationMode}\n      Content={MDXContent}\n      chapterMapData={chapterMapData}\n    />\n  )\n}\n\nfunction renderArticlePage(\n  manifest: ContentManifest,\n  route: string,\n  Content: ComponentType,\n) {\n  const articleSlug = route.split('/')[2]\n  const article = manifest.articles.find((a: Article) => a.slug === articleSlug)\n\n  const MDXContent = Content as ComponentType<{ components?: Record<string, unknown> }>\n\n  return (\n    <Reader title={article?.metadata.title || articleSlug}>\n      <MDXContent components={useMDXComponents()} />\n    </Reader>\n  )\n}\n\n// ── Styles ──────────────────────────────────────────────────\n\nconst HOME_STYLES = `\n  @keyframes pressy-fade-in {\n    from { opacity: 0; transform: translateY(20px); }\n    to   { opacity: 1; transform: translateY(0); }\n  }\n  .pressy-home {\n    max-width: 65ch;\n    margin: 0 auto;\n    padding: 2rem 1.5rem;\n    font-family: var(--font-body, Georgia, 'Times New Roman', serif);\n    color: var(--color-text, #1a1a1a);\n  }\n\n  /* ── Hero layout ────────────────────────── */\n  .pressy-hero {\n    display: flex;\n    align-items: flex-start;\n    gap: 2.5rem;\n    margin-bottom: 2.5rem;\n  }\n  .pressy-hero-cover {\n    flex-shrink: 0;\n    max-width: 280px;\n    width: 100%;\n    height: auto;\n    border-radius: 4px;\n    box-shadow: 0 4px 24px rgba(0,0,0,0.15);\n    animation: pressy-fade-in 0.6s ease-out both;\n  }\n  .pressy-hero-text {\n    flex: 1;\n    animation: pressy-fade-in 0.6s ease-out 0.15s both;\n  }\n  @media (max-width: 700px) {\n    .pressy-hero {\n      flex-direction: column;\n      align-items: center;\n    }\n    .pressy-hero-cover {\n      max-width: 220px;\n    }\n    .pressy-hero-text {\n      text-align: center;\n    }\n    .pressy-home-desc {\n      margin-left: auto;\n      margin-right: auto;\n    }\n    .pressy-stats {\n      justify-content: center;\n    }\n  }\n\n  /* ── Header ─────────────────────────────── */\n  .pressy-home-header {\n    margin-bottom: 1rem;\n  }\n  .pressy-home-header h1 {\n    font-size: 2rem;\n    margin-bottom: 0.5rem;\n  }\n  .pressy-home-author {\n    font-style: italic;\n    color: var(--color-text-muted, #666);\n  }\n  .pressy-home-desc {\n    color: var(--color-text-muted, #666);\n    line-height: 1.6;\n    max-width: 50ch;\n    margin: 0.5rem 0 0;\n  }\n\n  /* ── Stats row ──────────────────────────── */\n  .pressy-stats {\n    display: flex;\n    flex-wrap: wrap;\n    gap: 0.4em;\n    font-size: 0.85rem;\n    color: var(--color-text-muted, #666);\n    margin-top: 1rem;\n  }\n  .pressy-stats-sep {\n    opacity: 0.5;\n  }\n\n  /* ── CTA button ─────────────────────────── */\n  .pressy-cta {\n    display: inline-block;\n    margin-top: 1.25rem;\n    padding: 0.75rem 1.75rem;\n    background: var(--color-link, #2563eb);\n    color: #fff;\n    font-size: 1rem;\n    font-weight: 600;\n    text-decoration: none;\n    border-radius: 0.5rem;\n    transition: opacity 0.15s;\n  }\n  .pressy-cta:hover {\n    opacity: 0.85;\n  }\n\n  /* ── Sections below hero ────────────────── */\n  .pressy-fade-sections {\n    animation: pressy-fade-in 0.6s ease-out 0.3s both;\n  }\n  .pressy-home-section {\n    margin-bottom: 2rem;\n  }\n  .pressy-home-section h2 {\n    font-size: 1.25rem;\n    margin-bottom: 1rem;\n    border-bottom: 1px solid var(--color-border, #e5e5e5);\n    padding-bottom: 0.5rem;\n  }\n  .pressy-chapter-list {\n    display: flex;\n    flex-direction: column;\n    gap: 0.25rem;\n  }\n  .pressy-chapter-link {\n    display: flex;\n    gap: 0.75rem;\n    padding: 0.75rem 1rem;\n    text-decoration: none;\n    color: var(--color-text, #1a1a1a);\n    border-radius: 0.5rem;\n    transition: background 0.15s;\n  }\n  .pressy-chapter-link:hover {\n    background: var(--color-bg-subtle, #f5f5f5);\n  }\n  .pressy-chapter-order {\n    color: var(--color-text-muted, #666);\n    min-width: 2ch;\n  }\n\n  /* ── Reduced motion ─────────────────────── */\n  @media (prefers-reduced-motion: reduce) {\n    .pressy-hero-cover,\n    .pressy-hero-text,\n    .pressy-fade-sections {\n      animation: none;\n    }\n  }\n`\n\n// ── Main hydration function ─────────────────────────────────\n\ninterface HydrateData {\n  route: string\n  routeType: string\n  manifest: ContentManifest\n  pagination?: PaginationConfig\n}\n\n// Compute the base path by comparing the known route to the actual URL\n// e.g. URL=\"/pressy/pr-preview/pr-4/books/flatland\" with route=\"/books/flatland\"\n// yields basePath=\"/pressy/pr-preview/pr-4\"\nfunction getBasePath(route: string): string {\n  const pathname = window.location.pathname\n  // Remove trailing slash for comparison\n  const cleanPath = pathname.endsWith('/') ? pathname.slice(0, -1) : pathname\n  const cleanRoute = route.endsWith('/') ? route.slice(0, -1) : route\n  if (cleanRoute === '' || cleanRoute === '/') {\n    // Home page: strip /index.html or trailing slash\n    return cleanPath.replace(/\\/index\\.html$/, '') || ''\n  }\n  const idx = cleanPath.indexOf(cleanRoute)\n  if (idx > 0) {\n    return cleanPath.slice(0, idx)\n  }\n  return ''\n}\n\nlet basePath = ''\n\nexport function hydrate(data: HydrateData, Content?: ComponentType, chapterMapData?: ChapterMapData): void {\n  basePath = getBasePath(data.route)\n  currentRoute.value = data.route\n\n  // Initialize\n  loadTheme()\n  setupOfflineDetection()\n  initDB()\n\n  // Register service worker for PWA offline support\n  registerServiceWorker(basePath)\n\n  // Handle popstate for back/forward navigation\n  window.addEventListener('popstate', () => {\n    currentRoute.value = window.location.pathname\n  })\n\n  // Handle client-side link clicks\n  // For now, allow normal browser navigation for cross-page links\n  // so each page loads its own HTML with the correct MDX content.\n  // Only intercept hash links for in-page navigation.\n  document.addEventListener('click', (e) => {\n    const link = (e.target as HTMLElement).closest('a')\n    if (!link) return\n\n    const href = link.getAttribute('href')\n    if (!href) return\n\n    // Let external and full-page links navigate normally\n    if (href.startsWith('http') || href.startsWith('#')) return\n\n    // Same-path hash links: handle client-side\n    if (href.startsWith(data.route + '#')) {\n      e.preventDefault()\n      const hash = href.slice(href.indexOf('#'))\n      const target = document.querySelector(hash)\n      if (target) target.scrollIntoView({ behavior: 'smooth' })\n      return\n    }\n\n    // Cross-page links: let the browser navigate normally\n    // (each page is a full server-rendered HTML document)\n  })\n\n  // Render the app\n  let page: VNode\n  switch (data.routeType) {\n    case 'home':\n      page = renderHomePage(data.manifest)\n      break\n    case 'book': {\n      const bookSlug = data.route.split('/')[2]\n      const book = data.manifest.books.find((b: Book) => b.slug === bookSlug)\n      page = book ? renderBookPage(book) : <div>Book not found</div>\n      break\n    }\n    case 'chapter':\n      page = Content\n        ? renderChapterPage(data.manifest, data.route, Content, data.pagination?.defaultMode, chapterMapData)\n        : <div>Loading...</div>\n      break\n    case 'article':\n      page = Content\n        ? renderArticlePage(data.manifest, data.route, Content)\n        : <div>Loading...</div>\n      break\n    case 'books':\n      page = renderHomePage(data.manifest)\n      break\n    case 'articles':\n      page = renderHomePage(data.manifest)\n      break\n    default:\n      page = <div>Page not found</div>\n  }\n\n  render(page, document.getElementById('app')!)\n}\n\n// Export for use in components\nexport { signal, effect }\n","structuredPatch":[{"oldStart":10,"oldLines":6,"newStart":10,"newLines":9,"lines":["   clearBookCache,","   cachedBooks,","   cacheProgress,","+  installPrompt,","+  setupInstallPrompt,","+  triggerInstall,"," } from './offline.js'"," import type { ContentManifest, Route, Book, Chapter, Article, ReadingProgress, ChapterMapData } from '../types.js'"," import type { PaginationConfig } from '../config.js'"]}],"userModified":false,"replaceAll":false},"sourceToolAssistantUUID":"68ffb6a6-5845-4204-9950-1dd4a6adff04"}
{"parentUuid":"192c07b6-1b5d-426c-ad76-e6ac91913086","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","message":{"model":"claude-opus-4-6","id":"msg_01EideJu3VKJzsXER1zBZm3p","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_013fgnsc4gZsW6ZQXLxKZnpG","name":"Edit","input":{"replace_all":false,"file_path":"/Users/blittle/dev/pressy/packages/pressy/src/runtime/client.tsx","old_string":"  // Initialize\n  loadTheme()\n  setupOfflineDetection()\n  initDB()","new_string":"  // Initialize\n  loadTheme()\n  setupOfflineDetection()\n  setupInstallPrompt()\n  initDB()"},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":319,"cache_read_input_tokens":34517,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":319},"output_tokens":24,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CYAtPubW6NSXUmzXnASwp","type":"assistant","uuid":"c677d3e5-ffeb-44aa-bbaa-c73a34484461","timestamp":"2026-02-16T01:33:34.786Z"}
{"parentUuid":"c677d3e5-ffeb-44aa-bbaa-c73a34484461","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","type":"progress","data":{"type":"hook_progress","hookEvent":"PostToolUse","hookName":"PostToolUse:Edit","command":"callback"},"parentToolUseID":"toolu_013fgnsc4gZsW6ZQXLxKZnpG","toolUseID":"toolu_013fgnsc4gZsW6ZQXLxKZnpG","timestamp":"2026-02-16T01:33:34.806Z","uuid":"d3864844-6914-4ce4-b159-8741f237917d"}
{"parentUuid":"c677d3e5-ffeb-44aa-bbaa-c73a34484461","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_013fgnsc4gZsW6ZQXLxKZnpG","type":"tool_result","content":"The file /Users/blittle/dev/pressy/packages/pressy/src/runtime/client.tsx has been updated successfully."}]},"uuid":"36030a1a-b636-4cbd-aa04-659fee6027e7","timestamp":"2026-02-16T01:33:34.806Z","toolUseResult":{"filePath":"/Users/blittle/dev/pressy/packages/pressy/src/runtime/client.tsx","oldString":"  // Initialize\n  loadTheme()\n  setupOfflineDetection()\n  initDB()","newString":"  // Initialize\n  loadTheme()\n  setupOfflineDetection()\n  setupInstallPrompt()\n  initDB()","originalFile":"import { render, type ComponentType, type VNode } from 'preact'\nimport { useState, useEffect } from 'preact/hooks'\nimport { signal, effect } from '@preact/signals'\nimport { Reader } from '@pressy-pub/components'\nimport type { ProgressData } from '@pressy-pub/components'\nimport { useMDXComponents } from '@pressy-pub/components/content'\nimport {\n  registerServiceWorker,\n  downloadBookForOffline,\n  clearBookCache,\n  cachedBooks,\n  cacheProgress,\n  installPrompt,\n  setupInstallPrompt,\n  triggerInstall,\n} from './offline.js'\nimport type { ContentManifest, Route, Book, Chapter, Article, ReadingProgress, ChapterMapData } from '../types.js'\nimport type { PaginationConfig } from '../config.js'\n\n// State signals\nexport const currentRoute = signal<string>('/')\nexport const currentTheme = signal<'light' | 'dark' | 'sepia' | 'system'>('light')\nexport const isOffline = signal<boolean>(!navigator.onLine)\n\n// IndexedDB for reading progress\nconst DB_NAME = 'pressy'\nconst DB_VERSION = 1\nconst PROGRESS_STORE = 'reading-progress'\nconst UNLOCKS_STORE = 'unlocks'\n\nlet db: IDBDatabase | null = null\n\nasync function initDB(): Promise<IDBDatabase> {\n  if (db) return db\n\n  return new Promise((resolve, reject) => {\n    const request = indexedDB.open(DB_NAME, DB_VERSION)\n\n    request.onerror = () => reject(request.error)\n    request.onsuccess = () => {\n      db = request.result\n      resolve(db)\n    }\n\n    request.onupgradeneeded = (event) => {\n      const database = (event.target as IDBOpenDBRequest).result\n      if (!database.objectStoreNames.contains(PROGRESS_STORE)) {\n        database.createObjectStore(PROGRESS_STORE, { keyPath: 'chapterSlug' })\n      }\n      if (!database.objectStoreNames.contains(UNLOCKS_STORE)) {\n        database.createObjectStore(UNLOCKS_STORE, { keyPath: 'bookSlug' })\n      }\n    }\n  })\n}\n\nexport async function saveReadingProgress(progress: ReadingProgress): Promise<void> {\n  const database = await initDB()\n  return new Promise((resolve, reject) => {\n    const tx = database.transaction(PROGRESS_STORE, 'readwrite')\n    const store = tx.objectStore(PROGRESS_STORE)\n    const request = store.put(progress)\n    request.onsuccess = () => resolve()\n    request.onerror = () => reject(request.error)\n  })\n}\n\nexport async function getReadingProgress(chapterSlug: string): Promise<ReadingProgress | null> {\n  const database = await initDB()\n  return new Promise((resolve, reject) => {\n    const tx = database.transaction(PROGRESS_STORE, 'readonly')\n    const store = tx.objectStore(PROGRESS_STORE)\n    const request = store.get(chapterSlug)\n    request.onsuccess = () => resolve(request.result || null)\n    request.onerror = () => reject(request.error)\n  })\n}\n\nexport async function getAllReadingProgress(): Promise<ReadingProgress[]> {\n  const database = await initDB()\n  return new Promise((resolve, reject) => {\n    const tx = database.transaction(PROGRESS_STORE, 'readonly')\n    const store = tx.objectStore(PROGRESS_STORE)\n    const request = store.getAll()\n    request.onsuccess = () => resolve(request.result || [])\n    request.onerror = () => reject(request.error)\n  })\n}\n\nexport async function isBookUnlocked(bookSlug: string): Promise<boolean> {\n  const database = await initDB()\n  return new Promise((resolve, reject) => {\n    const tx = database.transaction(UNLOCKS_STORE, 'readonly')\n    const store = tx.objectStore(UNLOCKS_STORE)\n    const request = store.get(bookSlug)\n    request.onsuccess = () => resolve(!!request.result)\n    request.onerror = () => reject(request.error)\n  })\n}\n\nexport async function unlockBook(bookSlug: string, orderId?: string): Promise<void> {\n  const database = await initDB()\n  return new Promise((resolve, reject) => {\n    const tx = database.transaction(UNLOCKS_STORE, 'readwrite')\n    const store = tx.objectStore(UNLOCKS_STORE)\n    const request = store.put({ bookSlug, orderId, unlockedAt: Date.now() })\n    request.onsuccess = () => resolve()\n    request.onerror = () => reject(request.error)\n  })\n}\n\n// Client-side router\nexport function navigate(path: string, replace = false): void {\n  if (replace) {\n    history.replaceState(null, '', path)\n  } else {\n    history.pushState(null, '', path)\n  }\n  currentRoute.value = path\n}\n\n// Theme management\nfunction resolveSystemTheme(): 'light' | 'dark' {\n  return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light'\n}\n\nexport function setTheme(theme: 'light' | 'dark' | 'sepia' | 'system'): void {\n  currentTheme.value = theme\n  localStorage.setItem('pressy-theme', theme)\n  const resolved = theme === 'system' ? resolveSystemTheme() : theme\n  document.documentElement.setAttribute('data-theme', resolved)\n}\n\nfunction loadTheme(): void {\n  const saved = localStorage.getItem('pressy-theme') as 'light' | 'dark' | 'sepia' | 'system' | null\n  if (saved) {\n    setTheme(saved)\n  } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {\n    setTheme('dark')\n  }\n\n  // Listen for OS theme changes so \"system\" mode updates live\n  window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', () => {\n    if (currentTheme.value === 'system') {\n      document.documentElement.setAttribute('data-theme', resolveSystemTheme())\n    }\n  })\n}\n\n// Offline detection\nfunction setupOfflineDetection(): void {\n  window.addEventListener('online', () => {\n    isOffline.value = false\n  })\n  window.addEventListener('offline', () => {\n    isOffline.value = true\n  })\n}\n\n// ── Page renderers ──────────────────────────────────────────\n\nfunction StartReadingCTA({ book }: { book: Book }) {\n  const [target, setTarget] = useState<{ label: string; href: string } | null>(null)\n\n  useEffect(() => {\n    if (book.chapters.length === 0) return\n    const firstHref = `${basePath}/books/${book.slug}/${book.chapters[0].slug}`\n\n    getAllReadingProgress().then((allProgress) => {\n      const progressMap = new Map(allProgress.map((p) => [p.chapterSlug, p]))\n\n      // Walk chapters in order and find the furthest one that's in-progress (not completed)\n      let furthestInProgress: Chapter | null = null\n      for (const ch of book.chapters) {\n        const p = progressMap.get(ch.slug)\n        if (!p) continue\n        const completed = p.totalPages > 0 && p.page >= p.totalPages - 1\n        if (!completed && p.page > 0) {\n          furthestInProgress = ch\n        }\n      }\n\n      if (furthestInProgress) {\n        setTarget({\n          label: 'Continue Reading',\n          href: `${basePath}/books/${book.slug}/${furthestInProgress.slug}`,\n        })\n      } else {\n        setTarget({ label: 'Start Reading', href: firstHref })\n      }\n    }).catch(() => {\n      setTarget({ label: 'Start Reading', href: firstHref })\n    })\n  }, [book])\n\n  if (!target) return null\n\n  return (\n    <a href={target.href} class=\"pressy-cta\">\n      {target.label}\n    </a>\n  )\n}\n\nfunction renderBookPage(book: Book, articles: Article[] = []) {\n  // Stats calculations\n  const totalWords = book.chapters.reduce((sum, ch) => sum + (ch.wordCount || 0), 0)\n  const readingMinutes = Math.ceil(totalWords / 200)\n  const chapterCount = book.chapters.length\n  const publishYear = book.metadata.publishDate\n    ? new Date(book.metadata.publishDate).getFullYear()\n    : null\n\n  const formattedWords = totalWords.toLocaleString()\n\n  return (\n    <div class=\"pressy-home\">\n      <div class=\"pressy-hero\">\n        {book.coverUrl && (\n          <img\n            src={basePath + book.coverUrl}\n            alt={`${book.metadata.title} cover`}\n            class=\"pressy-hero-cover\"\n          />\n        )}\n        <div class=\"pressy-hero-text\">\n          <header class=\"pressy-home-header\">\n            <h1>{book.metadata.title}</h1>\n            <p class=\"pressy-home-author\">by {book.metadata.author}</p>\n            {book.metadata.description && (\n              <p class=\"pressy-home-desc\">{book.metadata.description}</p>\n            )}\n          </header>\n          {totalWords > 0 && (\n            <div class=\"pressy-stats\">\n              <span>{chapterCount} chapter{chapterCount !== 1 ? 's' : ''}</span>\n              <span class=\"pressy-stats-sep\">&middot;</span>\n              <span>{formattedWords} words</span>\n              <span class=\"pressy-stats-sep\">&middot;</span>\n              <span>~{readingMinutes} min</span>\n              {publishYear && (\n                <>\n                  <span class=\"pressy-stats-sep\">&middot;</span>\n                  <span>First published {publishYear}</span>\n                </>\n              )}\n            </div>\n          )}\n          {chapterCount > 0 && <StartReadingCTA book={book} />}\n        </div>\n      </div>\n      {articles.length > 0 && (\n        <section class=\"pressy-home-section pressy-fade-sections\">\n          <h2>Articles</h2>\n          <nav class=\"pressy-chapter-list\">\n            {articles.map((article: Article) => (\n              <a\n                href={`${basePath}/articles/${article.slug}`}\n                class=\"pressy-chapter-link\"\n              >\n                {article.metadata.title}\n              </a>\n            ))}\n          </nav>\n        </section>\n      )}\n      <style>{HOME_STYLES}</style>\n    </div>\n  )\n}\n\nfunction renderHomePage(manifest: ContentManifest) {\n  // Single-book site: render as the book page\n  if (manifest.books.length === 1) {\n    return renderBookPage(manifest.books[0], manifest.articles)\n  }\n\n  const siteTitle = manifest.books[0]?.metadata.title || 'Library'\n\n  return (\n    <div class=\"pressy-home\">\n      <header class=\"pressy-home-header\">\n        <h1>{siteTitle}</h1>\n        {manifest.books[0]?.metadata.description && (\n          <p class=\"pressy-home-desc\">{manifest.books[0].metadata.description}</p>\n        )}\n      </header>\n      {manifest.books.length > 0 && (\n        <section class=\"pressy-home-section\">\n          <h2>Books</h2>\n          <nav class=\"pressy-chapter-list\">\n            {manifest.books.map((book: Book) => (\n              <a\n                href={`${basePath}/books/${book.slug}`}\n                class=\"pressy-chapter-link\"\n              >\n                {book.metadata.title}\n              </a>\n            ))}\n          </nav>\n        </section>\n      )}\n      {manifest.articles.length > 0 && (\n        <section class=\"pressy-home-section\">\n          <h2>Articles</h2>\n          <nav class=\"pressy-chapter-list\">\n            {manifest.articles.map((article: Article) => (\n              <a\n                href={`${basePath}/articles/${article.slug}`}\n                class=\"pressy-chapter-link\"\n              >\n                {article.metadata.title}\n              </a>\n            ))}\n          </nav>\n        </section>\n      )}\n      <style>{HOME_STYLES}</style>\n    </div>\n  )\n}\n\n// Calculates global book progress % from word counts + saved progress data\nfunction calculateBookProgressPercent(\n  book: Book,\n  currentChapterSlug: string,\n  currentPage: number,\n  currentTotalPages: number,\n  allProgress: ReadingProgress[],\n): number {\n  const totalWords = book.chapters.reduce((sum, ch) => sum + (ch.wordCount || 0), 0)\n  if (totalWords === 0) return 0\n\n  const progressMap = new Map(allProgress.map((p) => [p.chapterSlug, p]))\n  let wordsRead = 0\n\n  for (const ch of book.chapters) {\n    const chapterWords = ch.wordCount || 0\n    if (ch.slug === currentChapterSlug) {\n      // Use live page position for current chapter\n      if (currentTotalPages > 0) {\n        wordsRead += (currentPage / Math.max(1, currentTotalPages - 1)) * chapterWords\n      }\n    } else {\n      const progress = progressMap.get(ch.slug)\n      if (!progress) continue\n      if (progress.totalPages > 0 && progress.page >= progress.totalPages - 1) {\n        wordsRead += chapterWords\n      } else if (progress.page > 0 && progress.totalPages > 0) {\n        wordsRead += (progress.page / progress.totalPages) * chapterWords\n      }\n    }\n  }\n\n  return Math.min(100, (wordsRead / totalWords) * 100)\n}\n\n// Wrapper component that provides progress callbacks and computes global progress\nfunction ChapterReaderWithProgress({\n  book,\n  chapterSlug,\n  chapter,\n  prevChapter,\n  nextChapter,\n  paginationMode,\n  Content,\n  chapterMapData,\n}: {\n  book: Book\n  chapterSlug: string\n  chapter?: Chapter\n  prevChapter?: { slug: string; title: string }\n  nextChapter?: { slug: string; title: string }\n  paginationMode?: 'scroll' | 'paginated'\n  Content: ComponentType<{ components?: Record<string, unknown> }>\n  chapterMapData?: ChapterMapData\n}) {\n  const [bookProgressPercent, setBookProgressPercent] = useState<number | undefined>(undefined)\n\n  // Load initial global book progress\n  useEffect(() => {\n    getAllReadingProgress().then((allProgress) => {\n      const percent = calculateBookProgressPercent(book, chapterSlug, 0, 0, allProgress)\n      setBookProgressPercent(percent)\n    })\n  }, [book, chapterSlug])\n\n  const handleSaveProgress = (data: ProgressData) => {\n    saveReadingProgress({\n      chapterSlug,\n      page: data.page,\n      totalPages: data.totalPages,\n      scrollPosition: data.scrollPosition,\n      timestamp: Date.now(),\n    })\n\n    // Update global book progress with live page position\n    if (data.totalPages > 0) {\n      getAllReadingProgress().then((allProgress) => {\n        const percent = calculateBookProgressPercent(\n          book, chapterSlug, data.page, data.totalPages, allProgress,\n        )\n        setBookProgressPercent(percent)\n      })\n    }\n  }\n\n  const handleRestoreProgress = async (): Promise<ProgressData | null> => {\n    const progress = await getReadingProgress(chapterSlug)\n    if (!progress) return null\n    return {\n      page: progress.page,\n      totalPages: progress.totalPages,\n      scrollPosition: progress.scrollPosition,\n    }\n  }\n\n  const handleChapterChange = (slug: string, page: number, chapterTotalPages: number) => {\n    // Save progress for the chapter being left (mark as complete)\n    saveReadingProgress({\n      chapterSlug: slug,\n      page,\n      totalPages: chapterTotalPages,\n      scrollPosition: 0,\n      timestamp: Date.now(),\n    })\n\n    // Update global book progress\n    getAllReadingProgress().then((allProgress) => {\n      const percent = calculateBookProgressPercent(book, slug, page, chapterTotalPages, allProgress)\n      setBookProgressPercent(percent)\n    })\n  }\n\n  // Prefetch previous chapter HTML for fast backward navigation\n  useEffect(() => {\n    if (prevChapter) {\n      const link = document.createElement('link')\n      link.rel = 'prefetch'\n      link.href = prevChapter.slug\n      document.head.appendChild(link)\n      return () => { document.head.removeChild(link) }\n    }\n  }, [prevChapter])\n\n  return (\n    <Reader\n      title={chapter?.title || chapterSlug}\n      bookTitle={book.metadata.title}\n      chapterSlug={chapterSlug}\n      prevChapter={prevChapter}\n      nextChapter={nextChapter}\n      paginationMode={paginationMode}\n      onSaveProgress={handleSaveProgress}\n      onRestoreProgress={handleRestoreProgress}\n      bookProgressPercent={bookProgressPercent}\n      initialContent={Content}\n      chapterMapData={chapterMapData}\n      currentChapterSlug={chapterSlug}\n      allChapters={book.chapters.map(ch => ({ slug: ch.slug, title: ch.title, wordCount: ch.wordCount }))}\n      bookBasePath={`${basePath}/books/${book.slug}`}\n      onChapterChange={handleChapterChange}\n      mdxComponents={useMDXComponents()}\n      offlineProps={{\n        bookSlug: book.slug,\n        chapterUrls: book.chapters.map(ch => `${basePath}/books/${book.slug}/${ch.slug}`),\n        cachedBooks,\n        cacheProgress,\n        onDownload: downloadBookForOffline,\n        onRemove: clearBookCache,\n      }}\n    >\n      <Content components={useMDXComponents()} />\n    </Reader>\n  )\n}\n\nfunction renderChapterPage(\n  manifest: ContentManifest,\n  route: string,\n  Content: ComponentType,\n  paginationMode?: 'scroll' | 'paginated',\n  chapterMapData?: ChapterMapData,\n) {\n  const parts = route.split('/')\n  const bookSlug = parts[2]\n  const chapterSlug = parts[3]\n  const book = manifest.books.find((b: Book) => b.slug === bookSlug)\n  const chapterIdx = book ? book.chapters.findIndex((c: Chapter) => c.slug === chapterSlug) : -1\n  const chapter = book?.chapters[chapterIdx]\n  const chapterPath = (ch: Chapter) => `${basePath}/books/${bookSlug}/${ch.slug}`\n  const prevChapter = book && chapterIdx > 0\n    ? { slug: chapterPath(book.chapters[chapterIdx - 1]), title: book.chapters[chapterIdx - 1].title }\n    : book\n      ? { slug: `${basePath}/books/${bookSlug}`, title: book.metadata.title }\n      : undefined\n  const nextChapter = book && chapterIdx >= 0 && chapterIdx < book.chapters.length - 1\n    ? { slug: chapterPath(book.chapters[chapterIdx + 1]), title: book.chapters[chapterIdx + 1].title }\n    : book\n      ? { slug: `${basePath}/books/${bookSlug}`, title: book.metadata.title }\n      : undefined\n\n  const MDXContent = Content as ComponentType<{ components?: Record<string, unknown> }>\n\n  if (!book) {\n    return (\n      <Reader\n        title={chapter?.title || chapterSlug}\n        prevChapter={prevChapter}\n        nextChapter={nextChapter}\n        paginationMode={paginationMode}\n      >\n        <MDXContent components={useMDXComponents()} />\n      </Reader>\n    )\n  }\n\n  return (\n    <ChapterReaderWithProgress\n      book={book}\n      chapterSlug={chapterSlug}\n      chapter={chapter}\n      prevChapter={prevChapter}\n      nextChapter={nextChapter}\n      paginationMode={paginationMode}\n      Content={MDXContent}\n      chapterMapData={chapterMapData}\n    />\n  )\n}\n\nfunction renderArticlePage(\n  manifest: ContentManifest,\n  route: string,\n  Content: ComponentType,\n) {\n  const articleSlug = route.split('/')[2]\n  const article = manifest.articles.find((a: Article) => a.slug === articleSlug)\n\n  const MDXContent = Content as ComponentType<{ components?: Record<string, unknown> }>\n\n  return (\n    <Reader title={article?.metadata.title || articleSlug}>\n      <MDXContent components={useMDXComponents()} />\n    </Reader>\n  )\n}\n\n// ── Styles ──────────────────────────────────────────────────\n\nconst HOME_STYLES = `\n  @keyframes pressy-fade-in {\n    from { opacity: 0; transform: translateY(20px); }\n    to   { opacity: 1; transform: translateY(0); }\n  }\n  .pressy-home {\n    max-width: 65ch;\n    margin: 0 auto;\n    padding: 2rem 1.5rem;\n    font-family: var(--font-body, Georgia, 'Times New Roman', serif);\n    color: var(--color-text, #1a1a1a);\n  }\n\n  /* ── Hero layout ────────────────────────── */\n  .pressy-hero {\n    display: flex;\n    align-items: flex-start;\n    gap: 2.5rem;\n    margin-bottom: 2.5rem;\n  }\n  .pressy-hero-cover {\n    flex-shrink: 0;\n    max-width: 280px;\n    width: 100%;\n    height: auto;\n    border-radius: 4px;\n    box-shadow: 0 4px 24px rgba(0,0,0,0.15);\n    animation: pressy-fade-in 0.6s ease-out both;\n  }\n  .pressy-hero-text {\n    flex: 1;\n    animation: pressy-fade-in 0.6s ease-out 0.15s both;\n  }\n  @media (max-width: 700px) {\n    .pressy-hero {\n      flex-direction: column;\n      align-items: center;\n    }\n    .pressy-hero-cover {\n      max-width: 220px;\n    }\n    .pressy-hero-text {\n      text-align: center;\n    }\n    .pressy-home-desc {\n      margin-left: auto;\n      margin-right: auto;\n    }\n    .pressy-stats {\n      justify-content: center;\n    }\n  }\n\n  /* ── Header ─────────────────────────────── */\n  .pressy-home-header {\n    margin-bottom: 1rem;\n  }\n  .pressy-home-header h1 {\n    font-size: 2rem;\n    margin-bottom: 0.5rem;\n  }\n  .pressy-home-author {\n    font-style: italic;\n    color: var(--color-text-muted, #666);\n  }\n  .pressy-home-desc {\n    color: var(--color-text-muted, #666);\n    line-height: 1.6;\n    max-width: 50ch;\n    margin: 0.5rem 0 0;\n  }\n\n  /* ── Stats row ──────────────────────────── */\n  .pressy-stats {\n    display: flex;\n    flex-wrap: wrap;\n    gap: 0.4em;\n    font-size: 0.85rem;\n    color: var(--color-text-muted, #666);\n    margin-top: 1rem;\n  }\n  .pressy-stats-sep {\n    opacity: 0.5;\n  }\n\n  /* ── CTA button ─────────────────────────── */\n  .pressy-cta {\n    display: inline-block;\n    margin-top: 1.25rem;\n    padding: 0.75rem 1.75rem;\n    background: var(--color-link, #2563eb);\n    color: #fff;\n    font-size: 1rem;\n    font-weight: 600;\n    text-decoration: none;\n    border-radius: 0.5rem;\n    transition: opacity 0.15s;\n  }\n  .pressy-cta:hover {\n    opacity: 0.85;\n  }\n\n  /* ── Sections below hero ────────────────── */\n  .pressy-fade-sections {\n    animation: pressy-fade-in 0.6s ease-out 0.3s both;\n  }\n  .pressy-home-section {\n    margin-bottom: 2rem;\n  }\n  .pressy-home-section h2 {\n    font-size: 1.25rem;\n    margin-bottom: 1rem;\n    border-bottom: 1px solid var(--color-border, #e5e5e5);\n    padding-bottom: 0.5rem;\n  }\n  .pressy-chapter-list {\n    display: flex;\n    flex-direction: column;\n    gap: 0.25rem;\n  }\n  .pressy-chapter-link {\n    display: flex;\n    gap: 0.75rem;\n    padding: 0.75rem 1rem;\n    text-decoration: none;\n    color: var(--color-text, #1a1a1a);\n    border-radius: 0.5rem;\n    transition: background 0.15s;\n  }\n  .pressy-chapter-link:hover {\n    background: var(--color-bg-subtle, #f5f5f5);\n  }\n  .pressy-chapter-order {\n    color: var(--color-text-muted, #666);\n    min-width: 2ch;\n  }\n\n  /* ── Reduced motion ─────────────────────── */\n  @media (prefers-reduced-motion: reduce) {\n    .pressy-hero-cover,\n    .pressy-hero-text,\n    .pressy-fade-sections {\n      animation: none;\n    }\n  }\n`\n\n// ── Main hydration function ─────────────────────────────────\n\ninterface HydrateData {\n  route: string\n  routeType: string\n  manifest: ContentManifest\n  pagination?: PaginationConfig\n}\n\n// Compute the base path by comparing the known route to the actual URL\n// e.g. URL=\"/pressy/pr-preview/pr-4/books/flatland\" with route=\"/books/flatland\"\n// yields basePath=\"/pressy/pr-preview/pr-4\"\nfunction getBasePath(route: string): string {\n  const pathname = window.location.pathname\n  // Remove trailing slash for comparison\n  const cleanPath = pathname.endsWith('/') ? pathname.slice(0, -1) : pathname\n  const cleanRoute = route.endsWith('/') ? route.slice(0, -1) : route\n  if (cleanRoute === '' || cleanRoute === '/') {\n    // Home page: strip /index.html or trailing slash\n    return cleanPath.replace(/\\/index\\.html$/, '') || ''\n  }\n  const idx = cleanPath.indexOf(cleanRoute)\n  if (idx > 0) {\n    return cleanPath.slice(0, idx)\n  }\n  return ''\n}\n\nlet basePath = ''\n\nexport function hydrate(data: HydrateData, Content?: ComponentType, chapterMapData?: ChapterMapData): void {\n  basePath = getBasePath(data.route)\n  currentRoute.value = data.route\n\n  // Initialize\n  loadTheme()\n  setupOfflineDetection()\n  initDB()\n\n  // Register service worker for PWA offline support\n  registerServiceWorker(basePath)\n\n  // Handle popstate for back/forward navigation\n  window.addEventListener('popstate', () => {\n    currentRoute.value = window.location.pathname\n  })\n\n  // Handle client-side link clicks\n  // For now, allow normal browser navigation for cross-page links\n  // so each page loads its own HTML with the correct MDX content.\n  // Only intercept hash links for in-page navigation.\n  document.addEventListener('click', (e) => {\n    const link = (e.target as HTMLElement).closest('a')\n    if (!link) return\n\n    const href = link.getAttribute('href')\n    if (!href) return\n\n    // Let external and full-page links navigate normally\n    if (href.startsWith('http') || href.startsWith('#')) return\n\n    // Same-path hash links: handle client-side\n    if (href.startsWith(data.route + '#')) {\n      e.preventDefault()\n      const hash = href.slice(href.indexOf('#'))\n      const target = document.querySelector(hash)\n      if (target) target.scrollIntoView({ behavior: 'smooth' })\n      return\n    }\n\n    // Cross-page links: let the browser navigate normally\n    // (each page is a full server-rendered HTML document)\n  })\n\n  // Render the app\n  let page: VNode\n  switch (data.routeType) {\n    case 'home':\n      page = renderHomePage(data.manifest)\n      break\n    case 'book': {\n      const bookSlug = data.route.split('/')[2]\n      const book = data.manifest.books.find((b: Book) => b.slug === bookSlug)\n      page = book ? renderBookPage(book) : <div>Book not found</div>\n      break\n    }\n    case 'chapter':\n      page = Content\n        ? renderChapterPage(data.manifest, data.route, Content, data.pagination?.defaultMode, chapterMapData)\n        : <div>Loading...</div>\n      break\n    case 'article':\n      page = Content\n        ? renderArticlePage(data.manifest, data.route, Content)\n        : <div>Loading...</div>\n      break\n    case 'books':\n      page = renderHomePage(data.manifest)\n      break\n    case 'articles':\n      page = renderHomePage(data.manifest)\n      break\n    default:\n      page = <div>Page not found</div>\n  }\n\n  render(page, document.getElementById('app')!)\n}\n\n// Export for use in components\nexport { signal, effect }\n","structuredPatch":[{"oldStart":732,"oldLines":6,"newStart":732,"newLines":7,"lines":["   // Initialize","   loadTheme()","   setupOfflineDetection()","+  setupInstallPrompt()","   initDB()"," ","   // Register service worker for PWA offline support"]}],"userModified":false,"replaceAll":false},"sourceToolAssistantUUID":"c677d3e5-ffeb-44aa-bbaa-c73a34484461"}
{"parentUuid":"36030a1a-b636-4cbd-aa04-659fee6027e7","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","message":{"model":"claude-opus-4-6","id":"msg_01LzZFJDQibvXPfMGeXBi9bU","type":"message","role":"assistant","content":[{"type":"text","text":"Now add the `InstallButton` component right after `StartReadingCTA`:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":225,"cache_read_input_tokens":34836,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":225},"output_tokens":4,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CYAtQAhr3sUVFR5hCvnTF","type":"assistant","uuid":"0ee20cb4-8c91-4475-ab42-af2363f84189","timestamp":"2026-02-16T01:33:37.420Z"}
{"parentUuid":"0ee20cb4-8c91-4475-ab42-af2363f84189","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","message":{"model":"claude-opus-4-6","id":"msg_01LzZFJDQibvXPfMGeXBi9bU","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01Ceh14ETmztCZaCz6VhuPV6","name":"Edit","input":{"replace_all":false,"file_path":"/Users/blittle/dev/pressy/packages/pressy/src/runtime/client.tsx","old_string":"function renderBookPage(book: Book, articles: Article[] = []) {","new_string":"function InstallButton() {\n  if (!installPrompt.value) return null\n\n  return (\n    <button\n      class=\"pressy-cta pressy-cta-secondary\"\n      onClick={() => triggerInstall()}\n    >\n      Install\n    </button>\n  )\n}\n\nfunction renderBookPage(book: Book, articles: Article[] = []) {"},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":225,"cache_read_input_tokens":34836,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":225},"output_tokens":4,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CYAtQAhr3sUVFR5hCvnTF","type":"assistant","uuid":"37b12c7f-64c6-455b-a23d-c8f896ab0c59","timestamp":"2026-02-16T01:33:39.822Z"}
{"parentUuid":"37b12c7f-64c6-455b-a23d-c8f896ab0c59","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","type":"progress","data":{"type":"hook_progress","hookEvent":"PostToolUse","hookName":"PostToolUse:Edit","command":"callback"},"parentToolUseID":"toolu_01Ceh14ETmztCZaCz6VhuPV6","toolUseID":"toolu_01Ceh14ETmztCZaCz6VhuPV6","timestamp":"2026-02-16T01:33:39.857Z","uuid":"3ef7ec37-ed11-4cfa-bba4-6095737eca88"}
{"parentUuid":"37b12c7f-64c6-455b-a23d-c8f896ab0c59","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01Ceh14ETmztCZaCz6VhuPV6","type":"tool_result","content":"The file /Users/blittle/dev/pressy/packages/pressy/src/runtime/client.tsx has been updated successfully."}]},"uuid":"bed9a594-641e-4910-b278-0d2e45a9da7c","timestamp":"2026-02-16T01:33:39.856Z","toolUseResult":{"filePath":"/Users/blittle/dev/pressy/packages/pressy/src/runtime/client.tsx","oldString":"function renderBookPage(book: Book, articles: Article[] = []) {","newString":"function InstallButton() {\n  if (!installPrompt.value) return null\n\n  return (\n    <button\n      class=\"pressy-cta pressy-cta-secondary\"\n      onClick={() => triggerInstall()}\n    >\n      Install\n    </button>\n  )\n}\n\nfunction renderBookPage(book: Book, articles: Article[] = []) {","originalFile":"import { render, type ComponentType, type VNode } from 'preact'\nimport { useState, useEffect } from 'preact/hooks'\nimport { signal, effect } from '@preact/signals'\nimport { Reader } from '@pressy-pub/components'\nimport type { ProgressData } from '@pressy-pub/components'\nimport { useMDXComponents } from '@pressy-pub/components/content'\nimport {\n  registerServiceWorker,\n  downloadBookForOffline,\n  clearBookCache,\n  cachedBooks,\n  cacheProgress,\n  installPrompt,\n  setupInstallPrompt,\n  triggerInstall,\n} from './offline.js'\nimport type { ContentManifest, Route, Book, Chapter, Article, ReadingProgress, ChapterMapData } from '../types.js'\nimport type { PaginationConfig } from '../config.js'\n\n// State signals\nexport const currentRoute = signal<string>('/')\nexport const currentTheme = signal<'light' | 'dark' | 'sepia' | 'system'>('light')\nexport const isOffline = signal<boolean>(!navigator.onLine)\n\n// IndexedDB for reading progress\nconst DB_NAME = 'pressy'\nconst DB_VERSION = 1\nconst PROGRESS_STORE = 'reading-progress'\nconst UNLOCKS_STORE = 'unlocks'\n\nlet db: IDBDatabase | null = null\n\nasync function initDB(): Promise<IDBDatabase> {\n  if (db) return db\n\n  return new Promise((resolve, reject) => {\n    const request = indexedDB.open(DB_NAME, DB_VERSION)\n\n    request.onerror = () => reject(request.error)\n    request.onsuccess = () => {\n      db = request.result\n      resolve(db)\n    }\n\n    request.onupgradeneeded = (event) => {\n      const database = (event.target as IDBOpenDBRequest).result\n      if (!database.objectStoreNames.contains(PROGRESS_STORE)) {\n        database.createObjectStore(PROGRESS_STORE, { keyPath: 'chapterSlug' })\n      }\n      if (!database.objectStoreNames.contains(UNLOCKS_STORE)) {\n        database.createObjectStore(UNLOCKS_STORE, { keyPath: 'bookSlug' })\n      }\n    }\n  })\n}\n\nexport async function saveReadingProgress(progress: ReadingProgress): Promise<void> {\n  const database = await initDB()\n  return new Promise((resolve, reject) => {\n    const tx = database.transaction(PROGRESS_STORE, 'readwrite')\n    const store = tx.objectStore(PROGRESS_STORE)\n    const request = store.put(progress)\n    request.onsuccess = () => resolve()\n    request.onerror = () => reject(request.error)\n  })\n}\n\nexport async function getReadingProgress(chapterSlug: string): Promise<ReadingProgress | null> {\n  const database = await initDB()\n  return new Promise((resolve, reject) => {\n    const tx = database.transaction(PROGRESS_STORE, 'readonly')\n    const store = tx.objectStore(PROGRESS_STORE)\n    const request = store.get(chapterSlug)\n    request.onsuccess = () => resolve(request.result || null)\n    request.onerror = () => reject(request.error)\n  })\n}\n\nexport async function getAllReadingProgress(): Promise<ReadingProgress[]> {\n  const database = await initDB()\n  return new Promise((resolve, reject) => {\n    const tx = database.transaction(PROGRESS_STORE, 'readonly')\n    const store = tx.objectStore(PROGRESS_STORE)\n    const request = store.getAll()\n    request.onsuccess = () => resolve(request.result || [])\n    request.onerror = () => reject(request.error)\n  })\n}\n\nexport async function isBookUnlocked(bookSlug: string): Promise<boolean> {\n  const database = await initDB()\n  return new Promise((resolve, reject) => {\n    const tx = database.transaction(UNLOCKS_STORE, 'readonly')\n    const store = tx.objectStore(UNLOCKS_STORE)\n    const request = store.get(bookSlug)\n    request.onsuccess = () => resolve(!!request.result)\n    request.onerror = () => reject(request.error)\n  })\n}\n\nexport async function unlockBook(bookSlug: string, orderId?: string): Promise<void> {\n  const database = await initDB()\n  return new Promise((resolve, reject) => {\n    const tx = database.transaction(UNLOCKS_STORE, 'readwrite')\n    const store = tx.objectStore(UNLOCKS_STORE)\n    const request = store.put({ bookSlug, orderId, unlockedAt: Date.now() })\n    request.onsuccess = () => resolve()\n    request.onerror = () => reject(request.error)\n  })\n}\n\n// Client-side router\nexport function navigate(path: string, replace = false): void {\n  if (replace) {\n    history.replaceState(null, '', path)\n  } else {\n    history.pushState(null, '', path)\n  }\n  currentRoute.value = path\n}\n\n// Theme management\nfunction resolveSystemTheme(): 'light' | 'dark' {\n  return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light'\n}\n\nexport function setTheme(theme: 'light' | 'dark' | 'sepia' | 'system'): void {\n  currentTheme.value = theme\n  localStorage.setItem('pressy-theme', theme)\n  const resolved = theme === 'system' ? resolveSystemTheme() : theme\n  document.documentElement.setAttribute('data-theme', resolved)\n}\n\nfunction loadTheme(): void {\n  const saved = localStorage.getItem('pressy-theme') as 'light' | 'dark' | 'sepia' | 'system' | null\n  if (saved) {\n    setTheme(saved)\n  } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {\n    setTheme('dark')\n  }\n\n  // Listen for OS theme changes so \"system\" mode updates live\n  window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', () => {\n    if (currentTheme.value === 'system') {\n      document.documentElement.setAttribute('data-theme', resolveSystemTheme())\n    }\n  })\n}\n\n// Offline detection\nfunction setupOfflineDetection(): void {\n  window.addEventListener('online', () => {\n    isOffline.value = false\n  })\n  window.addEventListener('offline', () => {\n    isOffline.value = true\n  })\n}\n\n// ── Page renderers ──────────────────────────────────────────\n\nfunction StartReadingCTA({ book }: { book: Book }) {\n  const [target, setTarget] = useState<{ label: string; href: string } | null>(null)\n\n  useEffect(() => {\n    if (book.chapters.length === 0) return\n    const firstHref = `${basePath}/books/${book.slug}/${book.chapters[0].slug}`\n\n    getAllReadingProgress().then((allProgress) => {\n      const progressMap = new Map(allProgress.map((p) => [p.chapterSlug, p]))\n\n      // Walk chapters in order and find the furthest one that's in-progress (not completed)\n      let furthestInProgress: Chapter | null = null\n      for (const ch of book.chapters) {\n        const p = progressMap.get(ch.slug)\n        if (!p) continue\n        const completed = p.totalPages > 0 && p.page >= p.totalPages - 1\n        if (!completed && p.page > 0) {\n          furthestInProgress = ch\n        }\n      }\n\n      if (furthestInProgress) {\n        setTarget({\n          label: 'Continue Reading',\n          href: `${basePath}/books/${book.slug}/${furthestInProgress.slug}`,\n        })\n      } else {\n        setTarget({ label: 'Start Reading', href: firstHref })\n      }\n    }).catch(() => {\n      setTarget({ label: 'Start Reading', href: firstHref })\n    })\n  }, [book])\n\n  if (!target) return null\n\n  return (\n    <a href={target.href} class=\"pressy-cta\">\n      {target.label}\n    </a>\n  )\n}\n\nfunction renderBookPage(book: Book, articles: Article[] = []) {\n  // Stats calculations\n  const totalWords = book.chapters.reduce((sum, ch) => sum + (ch.wordCount || 0), 0)\n  const readingMinutes = Math.ceil(totalWords / 200)\n  const chapterCount = book.chapters.length\n  const publishYear = book.metadata.publishDate\n    ? new Date(book.metadata.publishDate).getFullYear()\n    : null\n\n  const formattedWords = totalWords.toLocaleString()\n\n  return (\n    <div class=\"pressy-home\">\n      <div class=\"pressy-hero\">\n        {book.coverUrl && (\n          <img\n            src={basePath + book.coverUrl}\n            alt={`${book.metadata.title} cover`}\n            class=\"pressy-hero-cover\"\n          />\n        )}\n        <div class=\"pressy-hero-text\">\n          <header class=\"pressy-home-header\">\n            <h1>{book.metadata.title}</h1>\n            <p class=\"pressy-home-author\">by {book.metadata.author}</p>\n            {book.metadata.description && (\n              <p class=\"pressy-home-desc\">{book.metadata.description}</p>\n            )}\n          </header>\n          {totalWords > 0 && (\n            <div class=\"pressy-stats\">\n              <span>{chapterCount} chapter{chapterCount !== 1 ? 's' : ''}</span>\n              <span class=\"pressy-stats-sep\">&middot;</span>\n              <span>{formattedWords} words</span>\n              <span class=\"pressy-stats-sep\">&middot;</span>\n              <span>~{readingMinutes} min</span>\n              {publishYear && (\n                <>\n                  <span class=\"pressy-stats-sep\">&middot;</span>\n                  <span>First published {publishYear}</span>\n                </>\n              )}\n            </div>\n          )}\n          {chapterCount > 0 && <StartReadingCTA book={book} />}\n        </div>\n      </div>\n      {articles.length > 0 && (\n        <section class=\"pressy-home-section pressy-fade-sections\">\n          <h2>Articles</h2>\n          <nav class=\"pressy-chapter-list\">\n            {articles.map((article: Article) => (\n              <a\n                href={`${basePath}/articles/${article.slug}`}\n                class=\"pressy-chapter-link\"\n              >\n                {article.metadata.title}\n              </a>\n            ))}\n          </nav>\n        </section>\n      )}\n      <style>{HOME_STYLES}</style>\n    </div>\n  )\n}\n\nfunction renderHomePage(manifest: ContentManifest) {\n  // Single-book site: render as the book page\n  if (manifest.books.length === 1) {\n    return renderBookPage(manifest.books[0], manifest.articles)\n  }\n\n  const siteTitle = manifest.books[0]?.metadata.title || 'Library'\n\n  return (\n    <div class=\"pressy-home\">\n      <header class=\"pressy-home-header\">\n        <h1>{siteTitle}</h1>\n        {manifest.books[0]?.metadata.description && (\n          <p class=\"pressy-home-desc\">{manifest.books[0].metadata.description}</p>\n        )}\n      </header>\n      {manifest.books.length > 0 && (\n        <section class=\"pressy-home-section\">\n          <h2>Books</h2>\n          <nav class=\"pressy-chapter-list\">\n            {manifest.books.map((book: Book) => (\n              <a\n                href={`${basePath}/books/${book.slug}`}\n                class=\"pressy-chapter-link\"\n              >\n                {book.metadata.title}\n              </a>\n            ))}\n          </nav>\n        </section>\n      )}\n      {manifest.articles.length > 0 && (\n        <section class=\"pressy-home-section\">\n          <h2>Articles</h2>\n          <nav class=\"pressy-chapter-list\">\n            {manifest.articles.map((article: Article) => (\n              <a\n                href={`${basePath}/articles/${article.slug}`}\n                class=\"pressy-chapter-link\"\n              >\n                {article.metadata.title}\n              </a>\n            ))}\n          </nav>\n        </section>\n      )}\n      <style>{HOME_STYLES}</style>\n    </div>\n  )\n}\n\n// Calculates global book progress % from word counts + saved progress data\nfunction calculateBookProgressPercent(\n  book: Book,\n  currentChapterSlug: string,\n  currentPage: number,\n  currentTotalPages: number,\n  allProgress: ReadingProgress[],\n): number {\n  const totalWords = book.chapters.reduce((sum, ch) => sum + (ch.wordCount || 0), 0)\n  if (totalWords === 0) return 0\n\n  const progressMap = new Map(allProgress.map((p) => [p.chapterSlug, p]))\n  let wordsRead = 0\n\n  for (const ch of book.chapters) {\n    const chapterWords = ch.wordCount || 0\n    if (ch.slug === currentChapterSlug) {\n      // Use live page position for current chapter\n      if (currentTotalPages > 0) {\n        wordsRead += (currentPage / Math.max(1, currentTotalPages - 1)) * chapterWords\n      }\n    } else {\n      const progress = progressMap.get(ch.slug)\n      if (!progress) continue\n      if (progress.totalPages > 0 && progress.page >= progress.totalPages - 1) {\n        wordsRead += chapterWords\n      } else if (progress.page > 0 && progress.totalPages > 0) {\n        wordsRead += (progress.page / progress.totalPages) * chapterWords\n      }\n    }\n  }\n\n  return Math.min(100, (wordsRead / totalWords) * 100)\n}\n\n// Wrapper component that provides progress callbacks and computes global progress\nfunction ChapterReaderWithProgress({\n  book,\n  chapterSlug,\n  chapter,\n  prevChapter,\n  nextChapter,\n  paginationMode,\n  Content,\n  chapterMapData,\n}: {\n  book: Book\n  chapterSlug: string\n  chapter?: Chapter\n  prevChapter?: { slug: string; title: string }\n  nextChapter?: { slug: string; title: string }\n  paginationMode?: 'scroll' | 'paginated'\n  Content: ComponentType<{ components?: Record<string, unknown> }>\n  chapterMapData?: ChapterMapData\n}) {\n  const [bookProgressPercent, setBookProgressPercent] = useState<number | undefined>(undefined)\n\n  // Load initial global book progress\n  useEffect(() => {\n    getAllReadingProgress().then((allProgress) => {\n      const percent = calculateBookProgressPercent(book, chapterSlug, 0, 0, allProgress)\n      setBookProgressPercent(percent)\n    })\n  }, [book, chapterSlug])\n\n  const handleSaveProgress = (data: ProgressData) => {\n    saveReadingProgress({\n      chapterSlug,\n      page: data.page,\n      totalPages: data.totalPages,\n      scrollPosition: data.scrollPosition,\n      timestamp: Date.now(),\n    })\n\n    // Update global book progress with live page position\n    if (data.totalPages > 0) {\n      getAllReadingProgress().then((allProgress) => {\n        const percent = calculateBookProgressPercent(\n          book, chapterSlug, data.page, data.totalPages, allProgress,\n        )\n        setBookProgressPercent(percent)\n      })\n    }\n  }\n\n  const handleRestoreProgress = async (): Promise<ProgressData | null> => {\n    const progress = await getReadingProgress(chapterSlug)\n    if (!progress) return null\n    return {\n      page: progress.page,\n      totalPages: progress.totalPages,\n      scrollPosition: progress.scrollPosition,\n    }\n  }\n\n  const handleChapterChange = (slug: string, page: number, chapterTotalPages: number) => {\n    // Save progress for the chapter being left (mark as complete)\n    saveReadingProgress({\n      chapterSlug: slug,\n      page,\n      totalPages: chapterTotalPages,\n      scrollPosition: 0,\n      timestamp: Date.now(),\n    })\n\n    // Update global book progress\n    getAllReadingProgress().then((allProgress) => {\n      const percent = calculateBookProgressPercent(book, slug, page, chapterTotalPages, allProgress)\n      setBookProgressPercent(percent)\n    })\n  }\n\n  // Prefetch previous chapter HTML for fast backward navigation\n  useEffect(() => {\n    if (prevChapter) {\n      const link = document.createElement('link')\n      link.rel = 'prefetch'\n      link.href = prevChapter.slug\n      document.head.appendChild(link)\n      return () => { document.head.removeChild(link) }\n    }\n  }, [prevChapter])\n\n  return (\n    <Reader\n      title={chapter?.title || chapterSlug}\n      bookTitle={book.metadata.title}\n      chapterSlug={chapterSlug}\n      prevChapter={prevChapter}\n      nextChapter={nextChapter}\n      paginationMode={paginationMode}\n      onSaveProgress={handleSaveProgress}\n      onRestoreProgress={handleRestoreProgress}\n      bookProgressPercent={bookProgressPercent}\n      initialContent={Content}\n      chapterMapData={chapterMapData}\n      currentChapterSlug={chapterSlug}\n      allChapters={book.chapters.map(ch => ({ slug: ch.slug, title: ch.title, wordCount: ch.wordCount }))}\n      bookBasePath={`${basePath}/books/${book.slug}`}\n      onChapterChange={handleChapterChange}\n      mdxComponents={useMDXComponents()}\n      offlineProps={{\n        bookSlug: book.slug,\n        chapterUrls: book.chapters.map(ch => `${basePath}/books/${book.slug}/${ch.slug}`),\n        cachedBooks,\n        cacheProgress,\n        onDownload: downloadBookForOffline,\n        onRemove: clearBookCache,\n      }}\n    >\n      <Content components={useMDXComponents()} />\n    </Reader>\n  )\n}\n\nfunction renderChapterPage(\n  manifest: ContentManifest,\n  route: string,\n  Content: ComponentType,\n  paginationMode?: 'scroll' | 'paginated',\n  chapterMapData?: ChapterMapData,\n) {\n  const parts = route.split('/')\n  const bookSlug = parts[2]\n  const chapterSlug = parts[3]\n  const book = manifest.books.find((b: Book) => b.slug === bookSlug)\n  const chapterIdx = book ? book.chapters.findIndex((c: Chapter) => c.slug === chapterSlug) : -1\n  const chapter = book?.chapters[chapterIdx]\n  const chapterPath = (ch: Chapter) => `${basePath}/books/${bookSlug}/${ch.slug}`\n  const prevChapter = book && chapterIdx > 0\n    ? { slug: chapterPath(book.chapters[chapterIdx - 1]), title: book.chapters[chapterIdx - 1].title }\n    : book\n      ? { slug: `${basePath}/books/${bookSlug}`, title: book.metadata.title }\n      : undefined\n  const nextChapter = book && chapterIdx >= 0 && chapterIdx < book.chapters.length - 1\n    ? { slug: chapterPath(book.chapters[chapterIdx + 1]), title: book.chapters[chapterIdx + 1].title }\n    : book\n      ? { slug: `${basePath}/books/${bookSlug}`, title: book.metadata.title }\n      : undefined\n\n  const MDXContent = Content as ComponentType<{ components?: Record<string, unknown> }>\n\n  if (!book) {\n    return (\n      <Reader\n        title={chapter?.title || chapterSlug}\n        prevChapter={prevChapter}\n        nextChapter={nextChapter}\n        paginationMode={paginationMode}\n      >\n        <MDXContent components={useMDXComponents()} />\n      </Reader>\n    )\n  }\n\n  return (\n    <ChapterReaderWithProgress\n      book={book}\n      chapterSlug={chapterSlug}\n      chapter={chapter}\n      prevChapter={prevChapter}\n      nextChapter={nextChapter}\n      paginationMode={paginationMode}\n      Content={MDXContent}\n      chapterMapData={chapterMapData}\n    />\n  )\n}\n\nfunction renderArticlePage(\n  manifest: ContentManifest,\n  route: string,\n  Content: ComponentType,\n) {\n  const articleSlug = route.split('/')[2]\n  const article = manifest.articles.find((a: Article) => a.slug === articleSlug)\n\n  const MDXContent = Content as ComponentType<{ components?: Record<string, unknown> }>\n\n  return (\n    <Reader title={article?.metadata.title || articleSlug}>\n      <MDXContent components={useMDXComponents()} />\n    </Reader>\n  )\n}\n\n// ── Styles ──────────────────────────────────────────────────\n\nconst HOME_STYLES = `\n  @keyframes pressy-fade-in {\n    from { opacity: 0; transform: translateY(20px); }\n    to   { opacity: 1; transform: translateY(0); }\n  }\n  .pressy-home {\n    max-width: 65ch;\n    margin: 0 auto;\n    padding: 2rem 1.5rem;\n    font-family: var(--font-body, Georgia, 'Times New Roman', serif);\n    color: var(--color-text, #1a1a1a);\n  }\n\n  /* ── Hero layout ────────────────────────── */\n  .pressy-hero {\n    display: flex;\n    align-items: flex-start;\n    gap: 2.5rem;\n    margin-bottom: 2.5rem;\n  }\n  .pressy-hero-cover {\n    flex-shrink: 0;\n    max-width: 280px;\n    width: 100%;\n    height: auto;\n    border-radius: 4px;\n    box-shadow: 0 4px 24px rgba(0,0,0,0.15);\n    animation: pressy-fade-in 0.6s ease-out both;\n  }\n  .pressy-hero-text {\n    flex: 1;\n    animation: pressy-fade-in 0.6s ease-out 0.15s both;\n  }\n  @media (max-width: 700px) {\n    .pressy-hero {\n      flex-direction: column;\n      align-items: center;\n    }\n    .pressy-hero-cover {\n      max-width: 220px;\n    }\n    .pressy-hero-text {\n      text-align: center;\n    }\n    .pressy-home-desc {\n      margin-left: auto;\n      margin-right: auto;\n    }\n    .pressy-stats {\n      justify-content: center;\n    }\n  }\n\n  /* ── Header ─────────────────────────────── */\n  .pressy-home-header {\n    margin-bottom: 1rem;\n  }\n  .pressy-home-header h1 {\n    font-size: 2rem;\n    margin-bottom: 0.5rem;\n  }\n  .pressy-home-author {\n    font-style: italic;\n    color: var(--color-text-muted, #666);\n  }\n  .pressy-home-desc {\n    color: var(--color-text-muted, #666);\n    line-height: 1.6;\n    max-width: 50ch;\n    margin: 0.5rem 0 0;\n  }\n\n  /* ── Stats row ──────────────────────────── */\n  .pressy-stats {\n    display: flex;\n    flex-wrap: wrap;\n    gap: 0.4em;\n    font-size: 0.85rem;\n    color: var(--color-text-muted, #666);\n    margin-top: 1rem;\n  }\n  .pressy-stats-sep {\n    opacity: 0.5;\n  }\n\n  /* ── CTA button ─────────────────────────── */\n  .pressy-cta {\n    display: inline-block;\n    margin-top: 1.25rem;\n    padding: 0.75rem 1.75rem;\n    background: var(--color-link, #2563eb);\n    color: #fff;\n    font-size: 1rem;\n    font-weight: 600;\n    text-decoration: none;\n    border-radius: 0.5rem;\n    transition: opacity 0.15s;\n  }\n  .pressy-cta:hover {\n    opacity: 0.85;\n  }\n\n  /* ── Sections below hero ────────────────── */\n  .pressy-fade-sections {\n    animation: pressy-fade-in 0.6s ease-out 0.3s both;\n  }\n  .pressy-home-section {\n    margin-bottom: 2rem;\n  }\n  .pressy-home-section h2 {\n    font-size: 1.25rem;\n    margin-bottom: 1rem;\n    border-bottom: 1px solid var(--color-border, #e5e5e5);\n    padding-bottom: 0.5rem;\n  }\n  .pressy-chapter-list {\n    display: flex;\n    flex-direction: column;\n    gap: 0.25rem;\n  }\n  .pressy-chapter-link {\n    display: flex;\n    gap: 0.75rem;\n    padding: 0.75rem 1rem;\n    text-decoration: none;\n    color: var(--color-text, #1a1a1a);\n    border-radius: 0.5rem;\n    transition: background 0.15s;\n  }\n  .pressy-chapter-link:hover {\n    background: var(--color-bg-subtle, #f5f5f5);\n  }\n  .pressy-chapter-order {\n    color: var(--color-text-muted, #666);\n    min-width: 2ch;\n  }\n\n  /* ── Reduced motion ─────────────────────── */\n  @media (prefers-reduced-motion: reduce) {\n    .pressy-hero-cover,\n    .pressy-hero-text,\n    .pressy-fade-sections {\n      animation: none;\n    }\n  }\n`\n\n// ── Main hydration function ─────────────────────────────────\n\ninterface HydrateData {\n  route: string\n  routeType: string\n  manifest: ContentManifest\n  pagination?: PaginationConfig\n}\n\n// Compute the base path by comparing the known route to the actual URL\n// e.g. URL=\"/pressy/pr-preview/pr-4/books/flatland\" with route=\"/books/flatland\"\n// yields basePath=\"/pressy/pr-preview/pr-4\"\nfunction getBasePath(route: string): string {\n  const pathname = window.location.pathname\n  // Remove trailing slash for comparison\n  const cleanPath = pathname.endsWith('/') ? pathname.slice(0, -1) : pathname\n  const cleanRoute = route.endsWith('/') ? route.slice(0, -1) : route\n  if (cleanRoute === '' || cleanRoute === '/') {\n    // Home page: strip /index.html or trailing slash\n    return cleanPath.replace(/\\/index\\.html$/, '') || ''\n  }\n  const idx = cleanPath.indexOf(cleanRoute)\n  if (idx > 0) {\n    return cleanPath.slice(0, idx)\n  }\n  return ''\n}\n\nlet basePath = ''\n\nexport function hydrate(data: HydrateData, Content?: ComponentType, chapterMapData?: ChapterMapData): void {\n  basePath = getBasePath(data.route)\n  currentRoute.value = data.route\n\n  // Initialize\n  loadTheme()\n  setupOfflineDetection()\n  setupInstallPrompt()\n  initDB()\n\n  // Register service worker for PWA offline support\n  registerServiceWorker(basePath)\n\n  // Handle popstate for back/forward navigation\n  window.addEventListener('popstate', () => {\n    currentRoute.value = window.location.pathname\n  })\n\n  // Handle client-side link clicks\n  // For now, allow normal browser navigation for cross-page links\n  // so each page loads its own HTML with the correct MDX content.\n  // Only intercept hash links for in-page navigation.\n  document.addEventListener('click', (e) => {\n    const link = (e.target as HTMLElement).closest('a')\n    if (!link) return\n\n    const href = link.getAttribute('href')\n    if (!href) return\n\n    // Let external and full-page links navigate normally\n    if (href.startsWith('http') || href.startsWith('#')) return\n\n    // Same-path hash links: handle client-side\n    if (href.startsWith(data.route + '#')) {\n      e.preventDefault()\n      const hash = href.slice(href.indexOf('#'))\n      const target = document.querySelector(hash)\n      if (target) target.scrollIntoView({ behavior: 'smooth' })\n      return\n    }\n\n    // Cross-page links: let the browser navigate normally\n    // (each page is a full server-rendered HTML document)\n  })\n\n  // Render the app\n  let page: VNode\n  switch (data.routeType) {\n    case 'home':\n      page = renderHomePage(data.manifest)\n      break\n    case 'book': {\n      const bookSlug = data.route.split('/')[2]\n      const book = data.manifest.books.find((b: Book) => b.slug === bookSlug)\n      page = book ? renderBookPage(book) : <div>Book not found</div>\n      break\n    }\n    case 'chapter':\n      page = Content\n        ? renderChapterPage(data.manifest, data.route, Content, data.pagination?.defaultMode, chapterMapData)\n        : <div>Loading...</div>\n      break\n    case 'article':\n      page = Content\n        ? renderArticlePage(data.manifest, data.route, Content)\n        : <div>Loading...</div>\n      break\n    case 'books':\n      page = renderHomePage(data.manifest)\n      break\n    case 'articles':\n      page = renderHomePage(data.manifest)\n      break\n    default:\n      page = <div>Page not found</div>\n  }\n\n  render(page, document.getElementById('app')!)\n}\n\n// Export for use in components\nexport { signal, effect }\n","structuredPatch":[{"oldStart":202,"oldLines":6,"newStart":202,"newLines":19,"lines":["   )"," }"," ","+function InstallButton() {","+  if (!installPrompt.value) return null","+","+  return (","+    <button","+      class=\"pressy-cta pressy-cta-secondary\"","+      onClick={() => triggerInstall()}","+    >","+      Install","+    </button>","+  )","+}","+"," function renderBookPage(book: Book, articles: Article[] = []) {","   // Stats calculations","   const totalWords = book.chapters.reduce((sum, ch) => sum + (ch.wordCount || 0), 0)"]}],"userModified":false,"replaceAll":false},"sourceToolAssistantUUID":"37b12c7f-64c6-455b-a23d-c8f896ab0c59"}
{"parentUuid":"bed9a594-641e-4910-b278-0d2e45a9da7c","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","message":{"model":"claude-opus-4-6","id":"msg_01UKFks3RVUNasS5sgWwgxuB","type":"message","role":"assistant","content":[{"type":"text","text":"Now wrap the CTA section with the flex container:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":407,"cache_read_input_tokens":35061,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":407},"output_tokens":1,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CYAtQYT3e7YHLrn8QwLPd","type":"assistant","uuid":"7f26e54b-531b-4b77-9ebe-cfcc6fbb243e","timestamp":"2026-02-16T01:33:41.801Z"}
{"parentUuid":"7f26e54b-531b-4b77-9ebe-cfcc6fbb243e","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","message":{"model":"claude-opus-4-6","id":"msg_01UKFks3RVUNasS5sgWwgxuB","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_018qy6j2WZCyzhU12knRTgi5","name":"Edit","input":{"replace_all":false,"file_path":"/Users/blittle/dev/pressy/packages/pressy/src/runtime/client.tsx","old_string":"          {chapterCount > 0 && <StartReadingCTA book={book} />}","new_string":"          {chapterCount > 0 && (\n            <div class=\"pressy-cta-group\">\n              <StartReadingCTA book={book} />\n              <InstallButton />\n            </div>\n          )}"},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":407,"cache_read_input_tokens":35061,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":407},"output_tokens":1,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CYAtQYT3e7YHLrn8QwLPd","type":"assistant","uuid":"357ae4a6-4340-40cc-a235-49d707a0a4c3","timestamp":"2026-02-16T01:33:44.047Z"}
{"parentUuid":"357ae4a6-4340-40cc-a235-49d707a0a4c3","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","type":"progress","data":{"type":"hook_progress","hookEvent":"PostToolUse","hookName":"PostToolUse:Edit","command":"callback"},"parentToolUseID":"toolu_018qy6j2WZCyzhU12knRTgi5","toolUseID":"toolu_018qy6j2WZCyzhU12knRTgi5","timestamp":"2026-02-16T01:33:44.057Z","uuid":"29e6990e-4776-4de8-9e62-6eec3ad9df55"}
{"parentUuid":"357ae4a6-4340-40cc-a235-49d707a0a4c3","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_018qy6j2WZCyzhU12knRTgi5","type":"tool_result","content":"The file /Users/blittle/dev/pressy/packages/pressy/src/runtime/client.tsx has been updated successfully."}]},"uuid":"a2d2e053-672c-48d1-93c1-9eb79952e863","timestamp":"2026-02-16T01:33:44.056Z","toolUseResult":{"filePath":"/Users/blittle/dev/pressy/packages/pressy/src/runtime/client.tsx","oldString":"          {chapterCount > 0 && <StartReadingCTA book={book} />}","newString":"          {chapterCount > 0 && (\n            <div class=\"pressy-cta-group\">\n              <StartReadingCTA book={book} />\n              <InstallButton />\n            </div>\n          )}","originalFile":"import { render, type ComponentType, type VNode } from 'preact'\nimport { useState, useEffect } from 'preact/hooks'\nimport { signal, effect } from '@preact/signals'\nimport { Reader } from '@pressy-pub/components'\nimport type { ProgressData } from '@pressy-pub/components'\nimport { useMDXComponents } from '@pressy-pub/components/content'\nimport {\n  registerServiceWorker,\n  downloadBookForOffline,\n  clearBookCache,\n  cachedBooks,\n  cacheProgress,\n  installPrompt,\n  setupInstallPrompt,\n  triggerInstall,\n} from './offline.js'\nimport type { ContentManifest, Route, Book, Chapter, Article, ReadingProgress, ChapterMapData } from '../types.js'\nimport type { PaginationConfig } from '../config.js'\n\n// State signals\nexport const currentRoute = signal<string>('/')\nexport const currentTheme = signal<'light' | 'dark' | 'sepia' | 'system'>('light')\nexport const isOffline = signal<boolean>(!navigator.onLine)\n\n// IndexedDB for reading progress\nconst DB_NAME = 'pressy'\nconst DB_VERSION = 1\nconst PROGRESS_STORE = 'reading-progress'\nconst UNLOCKS_STORE = 'unlocks'\n\nlet db: IDBDatabase | null = null\n\nasync function initDB(): Promise<IDBDatabase> {\n  if (db) return db\n\n  return new Promise((resolve, reject) => {\n    const request = indexedDB.open(DB_NAME, DB_VERSION)\n\n    request.onerror = () => reject(request.error)\n    request.onsuccess = () => {\n      db = request.result\n      resolve(db)\n    }\n\n    request.onupgradeneeded = (event) => {\n      const database = (event.target as IDBOpenDBRequest).result\n      if (!database.objectStoreNames.contains(PROGRESS_STORE)) {\n        database.createObjectStore(PROGRESS_STORE, { keyPath: 'chapterSlug' })\n      }\n      if (!database.objectStoreNames.contains(UNLOCKS_STORE)) {\n        database.createObjectStore(UNLOCKS_STORE, { keyPath: 'bookSlug' })\n      }\n    }\n  })\n}\n\nexport async function saveReadingProgress(progress: ReadingProgress): Promise<void> {\n  const database = await initDB()\n  return new Promise((resolve, reject) => {\n    const tx = database.transaction(PROGRESS_STORE, 'readwrite')\n    const store = tx.objectStore(PROGRESS_STORE)\n    const request = store.put(progress)\n    request.onsuccess = () => resolve()\n    request.onerror = () => reject(request.error)\n  })\n}\n\nexport async function getReadingProgress(chapterSlug: string): Promise<ReadingProgress | null> {\n  const database = await initDB()\n  return new Promise((resolve, reject) => {\n    const tx = database.transaction(PROGRESS_STORE, 'readonly')\n    const store = tx.objectStore(PROGRESS_STORE)\n    const request = store.get(chapterSlug)\n    request.onsuccess = () => resolve(request.result || null)\n    request.onerror = () => reject(request.error)\n  })\n}\n\nexport async function getAllReadingProgress(): Promise<ReadingProgress[]> {\n  const database = await initDB()\n  return new Promise((resolve, reject) => {\n    const tx = database.transaction(PROGRESS_STORE, 'readonly')\n    const store = tx.objectStore(PROGRESS_STORE)\n    const request = store.getAll()\n    request.onsuccess = () => resolve(request.result || [])\n    request.onerror = () => reject(request.error)\n  })\n}\n\nexport async function isBookUnlocked(bookSlug: string): Promise<boolean> {\n  const database = await initDB()\n  return new Promise((resolve, reject) => {\n    const tx = database.transaction(UNLOCKS_STORE, 'readonly')\n    const store = tx.objectStore(UNLOCKS_STORE)\n    const request = store.get(bookSlug)\n    request.onsuccess = () => resolve(!!request.result)\n    request.onerror = () => reject(request.error)\n  })\n}\n\nexport async function unlockBook(bookSlug: string, orderId?: string): Promise<void> {\n  const database = await initDB()\n  return new Promise((resolve, reject) => {\n    const tx = database.transaction(UNLOCKS_STORE, 'readwrite')\n    const store = tx.objectStore(UNLOCKS_STORE)\n    const request = store.put({ bookSlug, orderId, unlockedAt: Date.now() })\n    request.onsuccess = () => resolve()\n    request.onerror = () => reject(request.error)\n  })\n}\n\n// Client-side router\nexport function navigate(path: string, replace = false): void {\n  if (replace) {\n    history.replaceState(null, '', path)\n  } else {\n    history.pushState(null, '', path)\n  }\n  currentRoute.value = path\n}\n\n// Theme management\nfunction resolveSystemTheme(): 'light' | 'dark' {\n  return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light'\n}\n\nexport function setTheme(theme: 'light' | 'dark' | 'sepia' | 'system'): void {\n  currentTheme.value = theme\n  localStorage.setItem('pressy-theme', theme)\n  const resolved = theme === 'system' ? resolveSystemTheme() : theme\n  document.documentElement.setAttribute('data-theme', resolved)\n}\n\nfunction loadTheme(): void {\n  const saved = localStorage.getItem('pressy-theme') as 'light' | 'dark' | 'sepia' | 'system' | null\n  if (saved) {\n    setTheme(saved)\n  } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {\n    setTheme('dark')\n  }\n\n  // Listen for OS theme changes so \"system\" mode updates live\n  window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', () => {\n    if (currentTheme.value === 'system') {\n      document.documentElement.setAttribute('data-theme', resolveSystemTheme())\n    }\n  })\n}\n\n// Offline detection\nfunction setupOfflineDetection(): void {\n  window.addEventListener('online', () => {\n    isOffline.value = false\n  })\n  window.addEventListener('offline', () => {\n    isOffline.value = true\n  })\n}\n\n// ── Page renderers ──────────────────────────────────────────\n\nfunction StartReadingCTA({ book }: { book: Book }) {\n  const [target, setTarget] = useState<{ label: string; href: string } | null>(null)\n\n  useEffect(() => {\n    if (book.chapters.length === 0) return\n    const firstHref = `${basePath}/books/${book.slug}/${book.chapters[0].slug}`\n\n    getAllReadingProgress().then((allProgress) => {\n      const progressMap = new Map(allProgress.map((p) => [p.chapterSlug, p]))\n\n      // Walk chapters in order and find the furthest one that's in-progress (not completed)\n      let furthestInProgress: Chapter | null = null\n      for (const ch of book.chapters) {\n        const p = progressMap.get(ch.slug)\n        if (!p) continue\n        const completed = p.totalPages > 0 && p.page >= p.totalPages - 1\n        if (!completed && p.page > 0) {\n          furthestInProgress = ch\n        }\n      }\n\n      if (furthestInProgress) {\n        setTarget({\n          label: 'Continue Reading',\n          href: `${basePath}/books/${book.slug}/${furthestInProgress.slug}`,\n        })\n      } else {\n        setTarget({ label: 'Start Reading', href: firstHref })\n      }\n    }).catch(() => {\n      setTarget({ label: 'Start Reading', href: firstHref })\n    })\n  }, [book])\n\n  if (!target) return null\n\n  return (\n    <a href={target.href} class=\"pressy-cta\">\n      {target.label}\n    </a>\n  )\n}\n\nfunction InstallButton() {\n  if (!installPrompt.value) return null\n\n  return (\n    <button\n      class=\"pressy-cta pressy-cta-secondary\"\n      onClick={() => triggerInstall()}\n    >\n      Install\n    </button>\n  )\n}\n\nfunction renderBookPage(book: Book, articles: Article[] = []) {\n  // Stats calculations\n  const totalWords = book.chapters.reduce((sum, ch) => sum + (ch.wordCount || 0), 0)\n  const readingMinutes = Math.ceil(totalWords / 200)\n  const chapterCount = book.chapters.length\n  const publishYear = book.metadata.publishDate\n    ? new Date(book.metadata.publishDate).getFullYear()\n    : null\n\n  const formattedWords = totalWords.toLocaleString()\n\n  return (\n    <div class=\"pressy-home\">\n      <div class=\"pressy-hero\">\n        {book.coverUrl && (\n          <img\n            src={basePath + book.coverUrl}\n            alt={`${book.metadata.title} cover`}\n            class=\"pressy-hero-cover\"\n          />\n        )}\n        <div class=\"pressy-hero-text\">\n          <header class=\"pressy-home-header\">\n            <h1>{book.metadata.title}</h1>\n            <p class=\"pressy-home-author\">by {book.metadata.author}</p>\n            {book.metadata.description && (\n              <p class=\"pressy-home-desc\">{book.metadata.description}</p>\n            )}\n          </header>\n          {totalWords > 0 && (\n            <div class=\"pressy-stats\">\n              <span>{chapterCount} chapter{chapterCount !== 1 ? 's' : ''}</span>\n              <span class=\"pressy-stats-sep\">&middot;</span>\n              <span>{formattedWords} words</span>\n              <span class=\"pressy-stats-sep\">&middot;</span>\n              <span>~{readingMinutes} min</span>\n              {publishYear && (\n                <>\n                  <span class=\"pressy-stats-sep\">&middot;</span>\n                  <span>First published {publishYear}</span>\n                </>\n              )}\n            </div>\n          )}\n          {chapterCount > 0 && <StartReadingCTA book={book} />}\n        </div>\n      </div>\n      {articles.length > 0 && (\n        <section class=\"pressy-home-section pressy-fade-sections\">\n          <h2>Articles</h2>\n          <nav class=\"pressy-chapter-list\">\n            {articles.map((article: Article) => (\n              <a\n                href={`${basePath}/articles/${article.slug}`}\n                class=\"pressy-chapter-link\"\n              >\n                {article.metadata.title}\n              </a>\n            ))}\n          </nav>\n        </section>\n      )}\n      <style>{HOME_STYLES}</style>\n    </div>\n  )\n}\n\nfunction renderHomePage(manifest: ContentManifest) {\n  // Single-book site: render as the book page\n  if (manifest.books.length === 1) {\n    return renderBookPage(manifest.books[0], manifest.articles)\n  }\n\n  const siteTitle = manifest.books[0]?.metadata.title || 'Library'\n\n  return (\n    <div class=\"pressy-home\">\n      <header class=\"pressy-home-header\">\n        <h1>{siteTitle}</h1>\n        {manifest.books[0]?.metadata.description && (\n          <p class=\"pressy-home-desc\">{manifest.books[0].metadata.description}</p>\n        )}\n      </header>\n      {manifest.books.length > 0 && (\n        <section class=\"pressy-home-section\">\n          <h2>Books</h2>\n          <nav class=\"pressy-chapter-list\">\n            {manifest.books.map((book: Book) => (\n              <a\n                href={`${basePath}/books/${book.slug}`}\n                class=\"pressy-chapter-link\"\n              >\n                {book.metadata.title}\n              </a>\n            ))}\n          </nav>\n        </section>\n      )}\n      {manifest.articles.length > 0 && (\n        <section class=\"pressy-home-section\">\n          <h2>Articles</h2>\n          <nav class=\"pressy-chapter-list\">\n            {manifest.articles.map((article: Article) => (\n              <a\n                href={`${basePath}/articles/${article.slug}`}\n                class=\"pressy-chapter-link\"\n              >\n                {article.metadata.title}\n              </a>\n            ))}\n          </nav>\n        </section>\n      )}\n      <style>{HOME_STYLES}</style>\n    </div>\n  )\n}\n\n// Calculates global book progress % from word counts + saved progress data\nfunction calculateBookProgressPercent(\n  book: Book,\n  currentChapterSlug: string,\n  currentPage: number,\n  currentTotalPages: number,\n  allProgress: ReadingProgress[],\n): number {\n  const totalWords = book.chapters.reduce((sum, ch) => sum + (ch.wordCount || 0), 0)\n  if (totalWords === 0) return 0\n\n  const progressMap = new Map(allProgress.map((p) => [p.chapterSlug, p]))\n  let wordsRead = 0\n\n  for (const ch of book.chapters) {\n    const chapterWords = ch.wordCount || 0\n    if (ch.slug === currentChapterSlug) {\n      // Use live page position for current chapter\n      if (currentTotalPages > 0) {\n        wordsRead += (currentPage / Math.max(1, currentTotalPages - 1)) * chapterWords\n      }\n    } else {\n      const progress = progressMap.get(ch.slug)\n      if (!progress) continue\n      if (progress.totalPages > 0 && progress.page >= progress.totalPages - 1) {\n        wordsRead += chapterWords\n      } else if (progress.page > 0 && progress.totalPages > 0) {\n        wordsRead += (progress.page / progress.totalPages) * chapterWords\n      }\n    }\n  }\n\n  return Math.min(100, (wordsRead / totalWords) * 100)\n}\n\n// Wrapper component that provides progress callbacks and computes global progress\nfunction ChapterReaderWithProgress({\n  book,\n  chapterSlug,\n  chapter,\n  prevChapter,\n  nextChapter,\n  paginationMode,\n  Content,\n  chapterMapData,\n}: {\n  book: Book\n  chapterSlug: string\n  chapter?: Chapter\n  prevChapter?: { slug: string; title: string }\n  nextChapter?: { slug: string; title: string }\n  paginationMode?: 'scroll' | 'paginated'\n  Content: ComponentType<{ components?: Record<string, unknown> }>\n  chapterMapData?: ChapterMapData\n}) {\n  const [bookProgressPercent, setBookProgressPercent] = useState<number | undefined>(undefined)\n\n  // Load initial global book progress\n  useEffect(() => {\n    getAllReadingProgress().then((allProgress) => {\n      const percent = calculateBookProgressPercent(book, chapterSlug, 0, 0, allProgress)\n      setBookProgressPercent(percent)\n    })\n  }, [book, chapterSlug])\n\n  const handleSaveProgress = (data: ProgressData) => {\n    saveReadingProgress({\n      chapterSlug,\n      page: data.page,\n      totalPages: data.totalPages,\n      scrollPosition: data.scrollPosition,\n      timestamp: Date.now(),\n    })\n\n    // Update global book progress with live page position\n    if (data.totalPages > 0) {\n      getAllReadingProgress().then((allProgress) => {\n        const percent = calculateBookProgressPercent(\n          book, chapterSlug, data.page, data.totalPages, allProgress,\n        )\n        setBookProgressPercent(percent)\n      })\n    }\n  }\n\n  const handleRestoreProgress = async (): Promise<ProgressData | null> => {\n    const progress = await getReadingProgress(chapterSlug)\n    if (!progress) return null\n    return {\n      page: progress.page,\n      totalPages: progress.totalPages,\n      scrollPosition: progress.scrollPosition,\n    }\n  }\n\n  const handleChapterChange = (slug: string, page: number, chapterTotalPages: number) => {\n    // Save progress for the chapter being left (mark as complete)\n    saveReadingProgress({\n      chapterSlug: slug,\n      page,\n      totalPages: chapterTotalPages,\n      scrollPosition: 0,\n      timestamp: Date.now(),\n    })\n\n    // Update global book progress\n    getAllReadingProgress().then((allProgress) => {\n      const percent = calculateBookProgressPercent(book, slug, page, chapterTotalPages, allProgress)\n      setBookProgressPercent(percent)\n    })\n  }\n\n  // Prefetch previous chapter HTML for fast backward navigation\n  useEffect(() => {\n    if (prevChapter) {\n      const link = document.createElement('link')\n      link.rel = 'prefetch'\n      link.href = prevChapter.slug\n      document.head.appendChild(link)\n      return () => { document.head.removeChild(link) }\n    }\n  }, [prevChapter])\n\n  return (\n    <Reader\n      title={chapter?.title || chapterSlug}\n      bookTitle={book.metadata.title}\n      chapterSlug={chapterSlug}\n      prevChapter={prevChapter}\n      nextChapter={nextChapter}\n      paginationMode={paginationMode}\n      onSaveProgress={handleSaveProgress}\n      onRestoreProgress={handleRestoreProgress}\n      bookProgressPercent={bookProgressPercent}\n      initialContent={Content}\n      chapterMapData={chapterMapData}\n      currentChapterSlug={chapterSlug}\n      allChapters={book.chapters.map(ch => ({ slug: ch.slug, title: ch.title, wordCount: ch.wordCount }))}\n      bookBasePath={`${basePath}/books/${book.slug}`}\n      onChapterChange={handleChapterChange}\n      mdxComponents={useMDXComponents()}\n      offlineProps={{\n        bookSlug: book.slug,\n        chapterUrls: book.chapters.map(ch => `${basePath}/books/${book.slug}/${ch.slug}`),\n        cachedBooks,\n        cacheProgress,\n        onDownload: downloadBookForOffline,\n        onRemove: clearBookCache,\n      }}\n    >\n      <Content components={useMDXComponents()} />\n    </Reader>\n  )\n}\n\nfunction renderChapterPage(\n  manifest: ContentManifest,\n  route: string,\n  Content: ComponentType,\n  paginationMode?: 'scroll' | 'paginated',\n  chapterMapData?: ChapterMapData,\n) {\n  const parts = route.split('/')\n  const bookSlug = parts[2]\n  const chapterSlug = parts[3]\n  const book = manifest.books.find((b: Book) => b.slug === bookSlug)\n  const chapterIdx = book ? book.chapters.findIndex((c: Chapter) => c.slug === chapterSlug) : -1\n  const chapter = book?.chapters[chapterIdx]\n  const chapterPath = (ch: Chapter) => `${basePath}/books/${bookSlug}/${ch.slug}`\n  const prevChapter = book && chapterIdx > 0\n    ? { slug: chapterPath(book.chapters[chapterIdx - 1]), title: book.chapters[chapterIdx - 1].title }\n    : book\n      ? { slug: `${basePath}/books/${bookSlug}`, title: book.metadata.title }\n      : undefined\n  const nextChapter = book && chapterIdx >= 0 && chapterIdx < book.chapters.length - 1\n    ? { slug: chapterPath(book.chapters[chapterIdx + 1]), title: book.chapters[chapterIdx + 1].title }\n    : book\n      ? { slug: `${basePath}/books/${bookSlug}`, title: book.metadata.title }\n      : undefined\n\n  const MDXContent = Content as ComponentType<{ components?: Record<string, unknown> }>\n\n  if (!book) {\n    return (\n      <Reader\n        title={chapter?.title || chapterSlug}\n        prevChapter={prevChapter}\n        nextChapter={nextChapter}\n        paginationMode={paginationMode}\n      >\n        <MDXContent components={useMDXComponents()} />\n      </Reader>\n    )\n  }\n\n  return (\n    <ChapterReaderWithProgress\n      book={book}\n      chapterSlug={chapterSlug}\n      chapter={chapter}\n      prevChapter={prevChapter}\n      nextChapter={nextChapter}\n      paginationMode={paginationMode}\n      Content={MDXContent}\n      chapterMapData={chapterMapData}\n    />\n  )\n}\n\nfunction renderArticlePage(\n  manifest: ContentManifest,\n  route: string,\n  Content: ComponentType,\n) {\n  const articleSlug = route.split('/')[2]\n  const article = manifest.articles.find((a: Article) => a.slug === articleSlug)\n\n  const MDXContent = Content as ComponentType<{ components?: Record<string, unknown> }>\n\n  return (\n    <Reader title={article?.metadata.title || articleSlug}>\n      <MDXContent components={useMDXComponents()} />\n    </Reader>\n  )\n}\n\n// ── Styles ──────────────────────────────────────────────────\n\nconst HOME_STYLES = `\n  @keyframes pressy-fade-in {\n    from { opacity: 0; transform: translateY(20px); }\n    to   { opacity: 1; transform: translateY(0); }\n  }\n  .pressy-home {\n    max-width: 65ch;\n    margin: 0 auto;\n    padding: 2rem 1.5rem;\n    font-family: var(--font-body, Georgia, 'Times New Roman', serif);\n    color: var(--color-text, #1a1a1a);\n  }\n\n  /* ── Hero layout ────────────────────────── */\n  .pressy-hero {\n    display: flex;\n    align-items: flex-start;\n    gap: 2.5rem;\n    margin-bottom: 2.5rem;\n  }\n  .pressy-hero-cover {\n    flex-shrink: 0;\n    max-width: 280px;\n    width: 100%;\n    height: auto;\n    border-radius: 4px;\n    box-shadow: 0 4px 24px rgba(0,0,0,0.15);\n    animation: pressy-fade-in 0.6s ease-out both;\n  }\n  .pressy-hero-text {\n    flex: 1;\n    animation: pressy-fade-in 0.6s ease-out 0.15s both;\n  }\n  @media (max-width: 700px) {\n    .pressy-hero {\n      flex-direction: column;\n      align-items: center;\n    }\n    .pressy-hero-cover {\n      max-width: 220px;\n    }\n    .pressy-hero-text {\n      text-align: center;\n    }\n    .pressy-home-desc {\n      margin-left: auto;\n      margin-right: auto;\n    }\n    .pressy-stats {\n      justify-content: center;\n    }\n  }\n\n  /* ── Header ─────────────────────────────── */\n  .pressy-home-header {\n    margin-bottom: 1rem;\n  }\n  .pressy-home-header h1 {\n    font-size: 2rem;\n    margin-bottom: 0.5rem;\n  }\n  .pressy-home-author {\n    font-style: italic;\n    color: var(--color-text-muted, #666);\n  }\n  .pressy-home-desc {\n    color: var(--color-text-muted, #666);\n    line-height: 1.6;\n    max-width: 50ch;\n    margin: 0.5rem 0 0;\n  }\n\n  /* ── Stats row ──────────────────────────── */\n  .pressy-stats {\n    display: flex;\n    flex-wrap: wrap;\n    gap: 0.4em;\n    font-size: 0.85rem;\n    color: var(--color-text-muted, #666);\n    margin-top: 1rem;\n  }\n  .pressy-stats-sep {\n    opacity: 0.5;\n  }\n\n  /* ── CTA button ─────────────────────────── */\n  .pressy-cta {\n    display: inline-block;\n    margin-top: 1.25rem;\n    padding: 0.75rem 1.75rem;\n    background: var(--color-link, #2563eb);\n    color: #fff;\n    font-size: 1rem;\n    font-weight: 600;\n    text-decoration: none;\n    border-radius: 0.5rem;\n    transition: opacity 0.15s;\n  }\n  .pressy-cta:hover {\n    opacity: 0.85;\n  }\n\n  /* ── Sections below hero ────────────────── */\n  .pressy-fade-sections {\n    animation: pressy-fade-in 0.6s ease-out 0.3s both;\n  }\n  .pressy-home-section {\n    margin-bottom: 2rem;\n  }\n  .pressy-home-section h2 {\n    font-size: 1.25rem;\n    margin-bottom: 1rem;\n    border-bottom: 1px solid var(--color-border, #e5e5e5);\n    padding-bottom: 0.5rem;\n  }\n  .pressy-chapter-list {\n    display: flex;\n    flex-direction: column;\n    gap: 0.25rem;\n  }\n  .pressy-chapter-link {\n    display: flex;\n    gap: 0.75rem;\n    padding: 0.75rem 1rem;\n    text-decoration: none;\n    color: var(--color-text, #1a1a1a);\n    border-radius: 0.5rem;\n    transition: background 0.15s;\n  }\n  .pressy-chapter-link:hover {\n    background: var(--color-bg-subtle, #f5f5f5);\n  }\n  .pressy-chapter-order {\n    color: var(--color-text-muted, #666);\n    min-width: 2ch;\n  }\n\n  /* ── Reduced motion ─────────────────────── */\n  @media (prefers-reduced-motion: reduce) {\n    .pressy-hero-cover,\n    .pressy-hero-text,\n    .pressy-fade-sections {\n      animation: none;\n    }\n  }\n`\n\n// ── Main hydration function ─────────────────────────────────\n\ninterface HydrateData {\n  route: string\n  routeType: string\n  manifest: ContentManifest\n  pagination?: PaginationConfig\n}\n\n// Compute the base path by comparing the known route to the actual URL\n// e.g. URL=\"/pressy/pr-preview/pr-4/books/flatland\" with route=\"/books/flatland\"\n// yields basePath=\"/pressy/pr-preview/pr-4\"\nfunction getBasePath(route: string): string {\n  const pathname = window.location.pathname\n  // Remove trailing slash for comparison\n  const cleanPath = pathname.endsWith('/') ? pathname.slice(0, -1) : pathname\n  const cleanRoute = route.endsWith('/') ? route.slice(0, -1) : route\n  if (cleanRoute === '' || cleanRoute === '/') {\n    // Home page: strip /index.html or trailing slash\n    return cleanPath.replace(/\\/index\\.html$/, '') || ''\n  }\n  const idx = cleanPath.indexOf(cleanRoute)\n  if (idx > 0) {\n    return cleanPath.slice(0, idx)\n  }\n  return ''\n}\n\nlet basePath = ''\n\nexport function hydrate(data: HydrateData, Content?: ComponentType, chapterMapData?: ChapterMapData): void {\n  basePath = getBasePath(data.route)\n  currentRoute.value = data.route\n\n  // Initialize\n  loadTheme()\n  setupOfflineDetection()\n  setupInstallPrompt()\n  initDB()\n\n  // Register service worker for PWA offline support\n  registerServiceWorker(basePath)\n\n  // Handle popstate for back/forward navigation\n  window.addEventListener('popstate', () => {\n    currentRoute.value = window.location.pathname\n  })\n\n  // Handle client-side link clicks\n  // For now, allow normal browser navigation for cross-page links\n  // so each page loads its own HTML with the correct MDX content.\n  // Only intercept hash links for in-page navigation.\n  document.addEventListener('click', (e) => {\n    const link = (e.target as HTMLElement).closest('a')\n    if (!link) return\n\n    const href = link.getAttribute('href')\n    if (!href) return\n\n    // Let external and full-page links navigate normally\n    if (href.startsWith('http') || href.startsWith('#')) return\n\n    // Same-path hash links: handle client-side\n    if (href.startsWith(data.route + '#')) {\n      e.preventDefault()\n      const hash = href.slice(href.indexOf('#'))\n      const target = document.querySelector(hash)\n      if (target) target.scrollIntoView({ behavior: 'smooth' })\n      return\n    }\n\n    // Cross-page links: let the browser navigate normally\n    // (each page is a full server-rendered HTML document)\n  })\n\n  // Render the app\n  let page: VNode\n  switch (data.routeType) {\n    case 'home':\n      page = renderHomePage(data.manifest)\n      break\n    case 'book': {\n      const bookSlug = data.route.split('/')[2]\n      const book = data.manifest.books.find((b: Book) => b.slug === bookSlug)\n      page = book ? renderBookPage(book) : <div>Book not found</div>\n      break\n    }\n    case 'chapter':\n      page = Content\n        ? renderChapterPage(data.manifest, data.route, Content, data.pagination?.defaultMode, chapterMapData)\n        : <div>Loading...</div>\n      break\n    case 'article':\n      page = Content\n        ? renderArticlePage(data.manifest, data.route, Content)\n        : <div>Loading...</div>\n      break\n    case 'books':\n      page = renderHomePage(data.manifest)\n      break\n    case 'articles':\n      page = renderHomePage(data.manifest)\n      break\n    default:\n      page = <div>Page not found</div>\n  }\n\n  render(page, document.getElementById('app')!)\n}\n\n// Export for use in components\nexport { signal, effect }\n","structuredPatch":[{"oldStart":259,"oldLines":7,"newStart":259,"newLines":12,"lines":["               )}","             </div>","           )}","-          {chapterCount > 0 && <StartReadingCTA book={book} />}","+          {chapterCount > 0 && (","+            <div class=\"pressy-cta-group\">","+              <StartReadingCTA book={book} />","+              <InstallButton />","+            </div>","+          )}","         </div>","       </div>","       {articles.length > 0 && ("]}],"userModified":false,"replaceAll":false},"sourceToolAssistantUUID":"357ae4a6-4340-40cc-a235-49d707a0a4c3"}
{"parentUuid":"a2d2e053-672c-48d1-93c1-9eb79952e863","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","message":{"model":"claude-opus-4-6","id":"msg_018FcDZ6SWM9RVq2zwV5jdZY","type":"message","role":"assistant","content":[{"type":"text","text":"Finally, add the new styles to `HOME_STYLES`:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":259,"cache_read_input_tokens":35468,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":259},"output_tokens":1,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CYAtQrQnjmG3w87T7qHrb","type":"assistant","uuid":"899a57ea-a3ec-4e9d-a312-a164ff64a9a8","timestamp":"2026-02-16T01:33:46.660Z"}
{"parentUuid":"899a57ea-a3ec-4e9d-a312-a164ff64a9a8","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","message":{"model":"claude-opus-4-6","id":"msg_018FcDZ6SWM9RVq2zwV5jdZY","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01JPyRXpMT5TRntsF1crmirb","name":"Edit","input":{"replace_all":false,"file_path":"/Users/blittle/dev/pressy/packages/pressy/src/runtime/client.tsx","old_string":"  /* ── CTA button ─────────────────────────── */\n  .pressy-cta {\n    display: inline-block;\n    margin-top: 1.25rem;\n    padding: 0.75rem 1.75rem;\n    background: var(--color-link, #2563eb);\n    color: #fff;\n    font-size: 1rem;\n    font-weight: 600;\n    text-decoration: none;\n    border-radius: 0.5rem;\n    transition: opacity 0.15s;\n  }\n  .pressy-cta:hover {\n    opacity: 0.85;\n  }","new_string":"  /* ── CTA button ─────────────────────────── */\n  .pressy-cta-group {\n    display: flex;\n    flex-wrap: wrap;\n    gap: 0.75rem;\n    align-items: center;\n  }\n  .pressy-cta {\n    display: inline-block;\n    margin-top: 1.25rem;\n    padding: 0.75rem 1.75rem;\n    background: var(--color-link, #2563eb);\n    color: #fff;\n    font-size: 1rem;\n    font-weight: 600;\n    text-decoration: none;\n    border-radius: 0.5rem;\n    transition: opacity 0.15s;\n  }\n  .pressy-cta:hover {\n    opacity: 0.85;\n  }\n  .pressy-cta-secondary {\n    background: transparent;\n    color: var(--color-link, #2563eb);\n    border: 1.5px solid var(--color-link, #2563eb);\n    cursor: pointer;\n    font-family: inherit;\n  }\n  .pressy-cta-secondary:hover {\n    background: var(--color-link, #2563eb);\n    color: #fff;\n  }"},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":259,"cache_read_input_tokens":35468,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":259},"output_tokens":1,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CYAtQrQnjmG3w87T7qHrb","type":"assistant","uuid":"ae1b4b49-3485-4cd3-bb64-7708e7e365f3","timestamp":"2026-02-16T01:33:52.426Z"}
{"parentUuid":"ae1b4b49-3485-4cd3-bb64-7708e7e365f3","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","type":"progress","data":{"type":"hook_progress","hookEvent":"PostToolUse","hookName":"PostToolUse:Edit","command":"callback"},"parentToolUseID":"toolu_01JPyRXpMT5TRntsF1crmirb","toolUseID":"toolu_01JPyRXpMT5TRntsF1crmirb","timestamp":"2026-02-16T01:33:52.435Z","uuid":"cdeeebac-d4e9-4529-b119-557d86a245a3"}
{"parentUuid":"ae1b4b49-3485-4cd3-bb64-7708e7e365f3","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01JPyRXpMT5TRntsF1crmirb","type":"tool_result","content":"The file /Users/blittle/dev/pressy/packages/pressy/src/runtime/client.tsx has been updated successfully."}]},"uuid":"8f4e4387-a621-443e-976b-414763132ef7","timestamp":"2026-02-16T01:33:52.434Z","toolUseResult":{"filePath":"/Users/blittle/dev/pressy/packages/pressy/src/runtime/client.tsx","oldString":"  /* ── CTA button ─────────────────────────── */\n  .pressy-cta {\n    display: inline-block;\n    margin-top: 1.25rem;\n    padding: 0.75rem 1.75rem;\n    background: var(--color-link, #2563eb);\n    color: #fff;\n    font-size: 1rem;\n    font-weight: 600;\n    text-decoration: none;\n    border-radius: 0.5rem;\n    transition: opacity 0.15s;\n  }\n  .pressy-cta:hover {\n    opacity: 0.85;\n  }","newString":"  /* ── CTA button ─────────────────────────── */\n  .pressy-cta-group {\n    display: flex;\n    flex-wrap: wrap;\n    gap: 0.75rem;\n    align-items: center;\n  }\n  .pressy-cta {\n    display: inline-block;\n    margin-top: 1.25rem;\n    padding: 0.75rem 1.75rem;\n    background: var(--color-link, #2563eb);\n    color: #fff;\n    font-size: 1rem;\n    font-weight: 600;\n    text-decoration: none;\n    border-radius: 0.5rem;\n    transition: opacity 0.15s;\n  }\n  .pressy-cta:hover {\n    opacity: 0.85;\n  }\n  .pressy-cta-secondary {\n    background: transparent;\n    color: var(--color-link, #2563eb);\n    border: 1.5px solid var(--color-link, #2563eb);\n    cursor: pointer;\n    font-family: inherit;\n  }\n  .pressy-cta-secondary:hover {\n    background: var(--color-link, #2563eb);\n    color: #fff;\n  }","originalFile":"import { render, type ComponentType, type VNode } from 'preact'\nimport { useState, useEffect } from 'preact/hooks'\nimport { signal, effect } from '@preact/signals'\nimport { Reader } from '@pressy-pub/components'\nimport type { ProgressData } from '@pressy-pub/components'\nimport { useMDXComponents } from '@pressy-pub/components/content'\nimport {\n  registerServiceWorker,\n  downloadBookForOffline,\n  clearBookCache,\n  cachedBooks,\n  cacheProgress,\n  installPrompt,\n  setupInstallPrompt,\n  triggerInstall,\n} from './offline.js'\nimport type { ContentManifest, Route, Book, Chapter, Article, ReadingProgress, ChapterMapData } from '../types.js'\nimport type { PaginationConfig } from '../config.js'\n\n// State signals\nexport const currentRoute = signal<string>('/')\nexport const currentTheme = signal<'light' | 'dark' | 'sepia' | 'system'>('light')\nexport const isOffline = signal<boolean>(!navigator.onLine)\n\n// IndexedDB for reading progress\nconst DB_NAME = 'pressy'\nconst DB_VERSION = 1\nconst PROGRESS_STORE = 'reading-progress'\nconst UNLOCKS_STORE = 'unlocks'\n\nlet db: IDBDatabase | null = null\n\nasync function initDB(): Promise<IDBDatabase> {\n  if (db) return db\n\n  return new Promise((resolve, reject) => {\n    const request = indexedDB.open(DB_NAME, DB_VERSION)\n\n    request.onerror = () => reject(request.error)\n    request.onsuccess = () => {\n      db = request.result\n      resolve(db)\n    }\n\n    request.onupgradeneeded = (event) => {\n      const database = (event.target as IDBOpenDBRequest).result\n      if (!database.objectStoreNames.contains(PROGRESS_STORE)) {\n        database.createObjectStore(PROGRESS_STORE, { keyPath: 'chapterSlug' })\n      }\n      if (!database.objectStoreNames.contains(UNLOCKS_STORE)) {\n        database.createObjectStore(UNLOCKS_STORE, { keyPath: 'bookSlug' })\n      }\n    }\n  })\n}\n\nexport async function saveReadingProgress(progress: ReadingProgress): Promise<void> {\n  const database = await initDB()\n  return new Promise((resolve, reject) => {\n    const tx = database.transaction(PROGRESS_STORE, 'readwrite')\n    const store = tx.objectStore(PROGRESS_STORE)\n    const request = store.put(progress)\n    request.onsuccess = () => resolve()\n    request.onerror = () => reject(request.error)\n  })\n}\n\nexport async function getReadingProgress(chapterSlug: string): Promise<ReadingProgress | null> {\n  const database = await initDB()\n  return new Promise((resolve, reject) => {\n    const tx = database.transaction(PROGRESS_STORE, 'readonly')\n    const store = tx.objectStore(PROGRESS_STORE)\n    const request = store.get(chapterSlug)\n    request.onsuccess = () => resolve(request.result || null)\n    request.onerror = () => reject(request.error)\n  })\n}\n\nexport async function getAllReadingProgress(): Promise<ReadingProgress[]> {\n  const database = await initDB()\n  return new Promise((resolve, reject) => {\n    const tx = database.transaction(PROGRESS_STORE, 'readonly')\n    const store = tx.objectStore(PROGRESS_STORE)\n    const request = store.getAll()\n    request.onsuccess = () => resolve(request.result || [])\n    request.onerror = () => reject(request.error)\n  })\n}\n\nexport async function isBookUnlocked(bookSlug: string): Promise<boolean> {\n  const database = await initDB()\n  return new Promise((resolve, reject) => {\n    const tx = database.transaction(UNLOCKS_STORE, 'readonly')\n    const store = tx.objectStore(UNLOCKS_STORE)\n    const request = store.get(bookSlug)\n    request.onsuccess = () => resolve(!!request.result)\n    request.onerror = () => reject(request.error)\n  })\n}\n\nexport async function unlockBook(bookSlug: string, orderId?: string): Promise<void> {\n  const database = await initDB()\n  return new Promise((resolve, reject) => {\n    const tx = database.transaction(UNLOCKS_STORE, 'readwrite')\n    const store = tx.objectStore(UNLOCKS_STORE)\n    const request = store.put({ bookSlug, orderId, unlockedAt: Date.now() })\n    request.onsuccess = () => resolve()\n    request.onerror = () => reject(request.error)\n  })\n}\n\n// Client-side router\nexport function navigate(path: string, replace = false): void {\n  if (replace) {\n    history.replaceState(null, '', path)\n  } else {\n    history.pushState(null, '', path)\n  }\n  currentRoute.value = path\n}\n\n// Theme management\nfunction resolveSystemTheme(): 'light' | 'dark' {\n  return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light'\n}\n\nexport function setTheme(theme: 'light' | 'dark' | 'sepia' | 'system'): void {\n  currentTheme.value = theme\n  localStorage.setItem('pressy-theme', theme)\n  const resolved = theme === 'system' ? resolveSystemTheme() : theme\n  document.documentElement.setAttribute('data-theme', resolved)\n}\n\nfunction loadTheme(): void {\n  const saved = localStorage.getItem('pressy-theme') as 'light' | 'dark' | 'sepia' | 'system' | null\n  if (saved) {\n    setTheme(saved)\n  } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {\n    setTheme('dark')\n  }\n\n  // Listen for OS theme changes so \"system\" mode updates live\n  window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', () => {\n    if (currentTheme.value === 'system') {\n      document.documentElement.setAttribute('data-theme', resolveSystemTheme())\n    }\n  })\n}\n\n// Offline detection\nfunction setupOfflineDetection(): void {\n  window.addEventListener('online', () => {\n    isOffline.value = false\n  })\n  window.addEventListener('offline', () => {\n    isOffline.value = true\n  })\n}\n\n// ── Page renderers ──────────────────────────────────────────\n\nfunction StartReadingCTA({ book }: { book: Book }) {\n  const [target, setTarget] = useState<{ label: string; href: string } | null>(null)\n\n  useEffect(() => {\n    if (book.chapters.length === 0) return\n    const firstHref = `${basePath}/books/${book.slug}/${book.chapters[0].slug}`\n\n    getAllReadingProgress().then((allProgress) => {\n      const progressMap = new Map(allProgress.map((p) => [p.chapterSlug, p]))\n\n      // Walk chapters in order and find the furthest one that's in-progress (not completed)\n      let furthestInProgress: Chapter | null = null\n      for (const ch of book.chapters) {\n        const p = progressMap.get(ch.slug)\n        if (!p) continue\n        const completed = p.totalPages > 0 && p.page >= p.totalPages - 1\n        if (!completed && p.page > 0) {\n          furthestInProgress = ch\n        }\n      }\n\n      if (furthestInProgress) {\n        setTarget({\n          label: 'Continue Reading',\n          href: `${basePath}/books/${book.slug}/${furthestInProgress.slug}`,\n        })\n      } else {\n        setTarget({ label: 'Start Reading', href: firstHref })\n      }\n    }).catch(() => {\n      setTarget({ label: 'Start Reading', href: firstHref })\n    })\n  }, [book])\n\n  if (!target) return null\n\n  return (\n    <a href={target.href} class=\"pressy-cta\">\n      {target.label}\n    </a>\n  )\n}\n\nfunction InstallButton() {\n  if (!installPrompt.value) return null\n\n  return (\n    <button\n      class=\"pressy-cta pressy-cta-secondary\"\n      onClick={() => triggerInstall()}\n    >\n      Install\n    </button>\n  )\n}\n\nfunction renderBookPage(book: Book, articles: Article[] = []) {\n  // Stats calculations\n  const totalWords = book.chapters.reduce((sum, ch) => sum + (ch.wordCount || 0), 0)\n  const readingMinutes = Math.ceil(totalWords / 200)\n  const chapterCount = book.chapters.length\n  const publishYear = book.metadata.publishDate\n    ? new Date(book.metadata.publishDate).getFullYear()\n    : null\n\n  const formattedWords = totalWords.toLocaleString()\n\n  return (\n    <div class=\"pressy-home\">\n      <div class=\"pressy-hero\">\n        {book.coverUrl && (\n          <img\n            src={basePath + book.coverUrl}\n            alt={`${book.metadata.title} cover`}\n            class=\"pressy-hero-cover\"\n          />\n        )}\n        <div class=\"pressy-hero-text\">\n          <header class=\"pressy-home-header\">\n            <h1>{book.metadata.title}</h1>\n            <p class=\"pressy-home-author\">by {book.metadata.author}</p>\n            {book.metadata.description && (\n              <p class=\"pressy-home-desc\">{book.metadata.description}</p>\n            )}\n          </header>\n          {totalWords > 0 && (\n            <div class=\"pressy-stats\">\n              <span>{chapterCount} chapter{chapterCount !== 1 ? 's' : ''}</span>\n              <span class=\"pressy-stats-sep\">&middot;</span>\n              <span>{formattedWords} words</span>\n              <span class=\"pressy-stats-sep\">&middot;</span>\n              <span>~{readingMinutes} min</span>\n              {publishYear && (\n                <>\n                  <span class=\"pressy-stats-sep\">&middot;</span>\n                  <span>First published {publishYear}</span>\n                </>\n              )}\n            </div>\n          )}\n          {chapterCount > 0 && (\n            <div class=\"pressy-cta-group\">\n              <StartReadingCTA book={book} />\n              <InstallButton />\n            </div>\n          )}\n        </div>\n      </div>\n      {articles.length > 0 && (\n        <section class=\"pressy-home-section pressy-fade-sections\">\n          <h2>Articles</h2>\n          <nav class=\"pressy-chapter-list\">\n            {articles.map((article: Article) => (\n              <a\n                href={`${basePath}/articles/${article.slug}`}\n                class=\"pressy-chapter-link\"\n              >\n                {article.metadata.title}\n              </a>\n            ))}\n          </nav>\n        </section>\n      )}\n      <style>{HOME_STYLES}</style>\n    </div>\n  )\n}\n\nfunction renderHomePage(manifest: ContentManifest) {\n  // Single-book site: render as the book page\n  if (manifest.books.length === 1) {\n    return renderBookPage(manifest.books[0], manifest.articles)\n  }\n\n  const siteTitle = manifest.books[0]?.metadata.title || 'Library'\n\n  return (\n    <div class=\"pressy-home\">\n      <header class=\"pressy-home-header\">\n        <h1>{siteTitle}</h1>\n        {manifest.books[0]?.metadata.description && (\n          <p class=\"pressy-home-desc\">{manifest.books[0].metadata.description}</p>\n        )}\n      </header>\n      {manifest.books.length > 0 && (\n        <section class=\"pressy-home-section\">\n          <h2>Books</h2>\n          <nav class=\"pressy-chapter-list\">\n            {manifest.books.map((book: Book) => (\n              <a\n                href={`${basePath}/books/${book.slug}`}\n                class=\"pressy-chapter-link\"\n              >\n                {book.metadata.title}\n              </a>\n            ))}\n          </nav>\n        </section>\n      )}\n      {manifest.articles.length > 0 && (\n        <section class=\"pressy-home-section\">\n          <h2>Articles</h2>\n          <nav class=\"pressy-chapter-list\">\n            {manifest.articles.map((article: Article) => (\n              <a\n                href={`${basePath}/articles/${article.slug}`}\n                class=\"pressy-chapter-link\"\n              >\n                {article.metadata.title}\n              </a>\n            ))}\n          </nav>\n        </section>\n      )}\n      <style>{HOME_STYLES}</style>\n    </div>\n  )\n}\n\n// Calculates global book progress % from word counts + saved progress data\nfunction calculateBookProgressPercent(\n  book: Book,\n  currentChapterSlug: string,\n  currentPage: number,\n  currentTotalPages: number,\n  allProgress: ReadingProgress[],\n): number {\n  const totalWords = book.chapters.reduce((sum, ch) => sum + (ch.wordCount || 0), 0)\n  if (totalWords === 0) return 0\n\n  const progressMap = new Map(allProgress.map((p) => [p.chapterSlug, p]))\n  let wordsRead = 0\n\n  for (const ch of book.chapters) {\n    const chapterWords = ch.wordCount || 0\n    if (ch.slug === currentChapterSlug) {\n      // Use live page position for current chapter\n      if (currentTotalPages > 0) {\n        wordsRead += (currentPage / Math.max(1, currentTotalPages - 1)) * chapterWords\n      }\n    } else {\n      const progress = progressMap.get(ch.slug)\n      if (!progress) continue\n      if (progress.totalPages > 0 && progress.page >= progress.totalPages - 1) {\n        wordsRead += chapterWords\n      } else if (progress.page > 0 && progress.totalPages > 0) {\n        wordsRead += (progress.page / progress.totalPages) * chapterWords\n      }\n    }\n  }\n\n  return Math.min(100, (wordsRead / totalWords) * 100)\n}\n\n// Wrapper component that provides progress callbacks and computes global progress\nfunction ChapterReaderWithProgress({\n  book,\n  chapterSlug,\n  chapter,\n  prevChapter,\n  nextChapter,\n  paginationMode,\n  Content,\n  chapterMapData,\n}: {\n  book: Book\n  chapterSlug: string\n  chapter?: Chapter\n  prevChapter?: { slug: string; title: string }\n  nextChapter?: { slug: string; title: string }\n  paginationMode?: 'scroll' | 'paginated'\n  Content: ComponentType<{ components?: Record<string, unknown> }>\n  chapterMapData?: ChapterMapData\n}) {\n  const [bookProgressPercent, setBookProgressPercent] = useState<number | undefined>(undefined)\n\n  // Load initial global book progress\n  useEffect(() => {\n    getAllReadingProgress().then((allProgress) => {\n      const percent = calculateBookProgressPercent(book, chapterSlug, 0, 0, allProgress)\n      setBookProgressPercent(percent)\n    })\n  }, [book, chapterSlug])\n\n  const handleSaveProgress = (data: ProgressData) => {\n    saveReadingProgress({\n      chapterSlug,\n      page: data.page,\n      totalPages: data.totalPages,\n      scrollPosition: data.scrollPosition,\n      timestamp: Date.now(),\n    })\n\n    // Update global book progress with live page position\n    if (data.totalPages > 0) {\n      getAllReadingProgress().then((allProgress) => {\n        const percent = calculateBookProgressPercent(\n          book, chapterSlug, data.page, data.totalPages, allProgress,\n        )\n        setBookProgressPercent(percent)\n      })\n    }\n  }\n\n  const handleRestoreProgress = async (): Promise<ProgressData | null> => {\n    const progress = await getReadingProgress(chapterSlug)\n    if (!progress) return null\n    return {\n      page: progress.page,\n      totalPages: progress.totalPages,\n      scrollPosition: progress.scrollPosition,\n    }\n  }\n\n  const handleChapterChange = (slug: string, page: number, chapterTotalPages: number) => {\n    // Save progress for the chapter being left (mark as complete)\n    saveReadingProgress({\n      chapterSlug: slug,\n      page,\n      totalPages: chapterTotalPages,\n      scrollPosition: 0,\n      timestamp: Date.now(),\n    })\n\n    // Update global book progress\n    getAllReadingProgress().then((allProgress) => {\n      const percent = calculateBookProgressPercent(book, slug, page, chapterTotalPages, allProgress)\n      setBookProgressPercent(percent)\n    })\n  }\n\n  // Prefetch previous chapter HTML for fast backward navigation\n  useEffect(() => {\n    if (prevChapter) {\n      const link = document.createElement('link')\n      link.rel = 'prefetch'\n      link.href = prevChapter.slug\n      document.head.appendChild(link)\n      return () => { document.head.removeChild(link) }\n    }\n  }, [prevChapter])\n\n  return (\n    <Reader\n      title={chapter?.title || chapterSlug}\n      bookTitle={book.metadata.title}\n      chapterSlug={chapterSlug}\n      prevChapter={prevChapter}\n      nextChapter={nextChapter}\n      paginationMode={paginationMode}\n      onSaveProgress={handleSaveProgress}\n      onRestoreProgress={handleRestoreProgress}\n      bookProgressPercent={bookProgressPercent}\n      initialContent={Content}\n      chapterMapData={chapterMapData}\n      currentChapterSlug={chapterSlug}\n      allChapters={book.chapters.map(ch => ({ slug: ch.slug, title: ch.title, wordCount: ch.wordCount }))}\n      bookBasePath={`${basePath}/books/${book.slug}`}\n      onChapterChange={handleChapterChange}\n      mdxComponents={useMDXComponents()}\n      offlineProps={{\n        bookSlug: book.slug,\n        chapterUrls: book.chapters.map(ch => `${basePath}/books/${book.slug}/${ch.slug}`),\n        cachedBooks,\n        cacheProgress,\n        onDownload: downloadBookForOffline,\n        onRemove: clearBookCache,\n      }}\n    >\n      <Content components={useMDXComponents()} />\n    </Reader>\n  )\n}\n\nfunction renderChapterPage(\n  manifest: ContentManifest,\n  route: string,\n  Content: ComponentType,\n  paginationMode?: 'scroll' | 'paginated',\n  chapterMapData?: ChapterMapData,\n) {\n  const parts = route.split('/')\n  const bookSlug = parts[2]\n  const chapterSlug = parts[3]\n  const book = manifest.books.find((b: Book) => b.slug === bookSlug)\n  const chapterIdx = book ? book.chapters.findIndex((c: Chapter) => c.slug === chapterSlug) : -1\n  const chapter = book?.chapters[chapterIdx]\n  const chapterPath = (ch: Chapter) => `${basePath}/books/${bookSlug}/${ch.slug}`\n  const prevChapter = book && chapterIdx > 0\n    ? { slug: chapterPath(book.chapters[chapterIdx - 1]), title: book.chapters[chapterIdx - 1].title }\n    : book\n      ? { slug: `${basePath}/books/${bookSlug}`, title: book.metadata.title }\n      : undefined\n  const nextChapter = book && chapterIdx >= 0 && chapterIdx < book.chapters.length - 1\n    ? { slug: chapterPath(book.chapters[chapterIdx + 1]), title: book.chapters[chapterIdx + 1].title }\n    : book\n      ? { slug: `${basePath}/books/${bookSlug}`, title: book.metadata.title }\n      : undefined\n\n  const MDXContent = Content as ComponentType<{ components?: Record<string, unknown> }>\n\n  if (!book) {\n    return (\n      <Reader\n        title={chapter?.title || chapterSlug}\n        prevChapter={prevChapter}\n        nextChapter={nextChapter}\n        paginationMode={paginationMode}\n      >\n        <MDXContent components={useMDXComponents()} />\n      </Reader>\n    )\n  }\n\n  return (\n    <ChapterReaderWithProgress\n      book={book}\n      chapterSlug={chapterSlug}\n      chapter={chapter}\n      prevChapter={prevChapter}\n      nextChapter={nextChapter}\n      paginationMode={paginationMode}\n      Content={MDXContent}\n      chapterMapData={chapterMapData}\n    />\n  )\n}\n\nfunction renderArticlePage(\n  manifest: ContentManifest,\n  route: string,\n  Content: ComponentType,\n) {\n  const articleSlug = route.split('/')[2]\n  const article = manifest.articles.find((a: Article) => a.slug === articleSlug)\n\n  const MDXContent = Content as ComponentType<{ components?: Record<string, unknown> }>\n\n  return (\n    <Reader title={article?.metadata.title || articleSlug}>\n      <MDXContent components={useMDXComponents()} />\n    </Reader>\n  )\n}\n\n// ── Styles ──────────────────────────────────────────────────\n\nconst HOME_STYLES = `\n  @keyframes pressy-fade-in {\n    from { opacity: 0; transform: translateY(20px); }\n    to   { opacity: 1; transform: translateY(0); }\n  }\n  .pressy-home {\n    max-width: 65ch;\n    margin: 0 auto;\n    padding: 2rem 1.5rem;\n    font-family: var(--font-body, Georgia, 'Times New Roman', serif);\n    color: var(--color-text, #1a1a1a);\n  }\n\n  /* ── Hero layout ────────────────────────── */\n  .pressy-hero {\n    display: flex;\n    align-items: flex-start;\n    gap: 2.5rem;\n    margin-bottom: 2.5rem;\n  }\n  .pressy-hero-cover {\n    flex-shrink: 0;\n    max-width: 280px;\n    width: 100%;\n    height: auto;\n    border-radius: 4px;\n    box-shadow: 0 4px 24px rgba(0,0,0,0.15);\n    animation: pressy-fade-in 0.6s ease-out both;\n  }\n  .pressy-hero-text {\n    flex: 1;\n    animation: pressy-fade-in 0.6s ease-out 0.15s both;\n  }\n  @media (max-width: 700px) {\n    .pressy-hero {\n      flex-direction: column;\n      align-items: center;\n    }\n    .pressy-hero-cover {\n      max-width: 220px;\n    }\n    .pressy-hero-text {\n      text-align: center;\n    }\n    .pressy-home-desc {\n      margin-left: auto;\n      margin-right: auto;\n    }\n    .pressy-stats {\n      justify-content: center;\n    }\n  }\n\n  /* ── Header ─────────────────────────────── */\n  .pressy-home-header {\n    margin-bottom: 1rem;\n  }\n  .pressy-home-header h1 {\n    font-size: 2rem;\n    margin-bottom: 0.5rem;\n  }\n  .pressy-home-author {\n    font-style: italic;\n    color: var(--color-text-muted, #666);\n  }\n  .pressy-home-desc {\n    color: var(--color-text-muted, #666);\n    line-height: 1.6;\n    max-width: 50ch;\n    margin: 0.5rem 0 0;\n  }\n\n  /* ── Stats row ──────────────────────────── */\n  .pressy-stats {\n    display: flex;\n    flex-wrap: wrap;\n    gap: 0.4em;\n    font-size: 0.85rem;\n    color: var(--color-text-muted, #666);\n    margin-top: 1rem;\n  }\n  .pressy-stats-sep {\n    opacity: 0.5;\n  }\n\n  /* ── CTA button ─────────────────────────── */\n  .pressy-cta {\n    display: inline-block;\n    margin-top: 1.25rem;\n    padding: 0.75rem 1.75rem;\n    background: var(--color-link, #2563eb);\n    color: #fff;\n    font-size: 1rem;\n    font-weight: 600;\n    text-decoration: none;\n    border-radius: 0.5rem;\n    transition: opacity 0.15s;\n  }\n  .pressy-cta:hover {\n    opacity: 0.85;\n  }\n\n  /* ── Sections below hero ────────────────── */\n  .pressy-fade-sections {\n    animation: pressy-fade-in 0.6s ease-out 0.3s both;\n  }\n  .pressy-home-section {\n    margin-bottom: 2rem;\n  }\n  .pressy-home-section h2 {\n    font-size: 1.25rem;\n    margin-bottom: 1rem;\n    border-bottom: 1px solid var(--color-border, #e5e5e5);\n    padding-bottom: 0.5rem;\n  }\n  .pressy-chapter-list {\n    display: flex;\n    flex-direction: column;\n    gap: 0.25rem;\n  }\n  .pressy-chapter-link {\n    display: flex;\n    gap: 0.75rem;\n    padding: 0.75rem 1rem;\n    text-decoration: none;\n    color: var(--color-text, #1a1a1a);\n    border-radius: 0.5rem;\n    transition: background 0.15s;\n  }\n  .pressy-chapter-link:hover {\n    background: var(--color-bg-subtle, #f5f5f5);\n  }\n  .pressy-chapter-order {\n    color: var(--color-text-muted, #666);\n    min-width: 2ch;\n  }\n\n  /* ── Reduced motion ─────────────────────── */\n  @media (prefers-reduced-motion: reduce) {\n    .pressy-hero-cover,\n    .pressy-hero-text,\n    .pressy-fade-sections {\n      animation: none;\n    }\n  }\n`\n\n// ── Main hydration function ─────────────────────────────────\n\ninterface HydrateData {\n  route: string\n  routeType: string\n  manifest: ContentManifest\n  pagination?: PaginationConfig\n}\n\n// Compute the base path by comparing the known route to the actual URL\n// e.g. URL=\"/pressy/pr-preview/pr-4/books/flatland\" with route=\"/books/flatland\"\n// yields basePath=\"/pressy/pr-preview/pr-4\"\nfunction getBasePath(route: string): string {\n  const pathname = window.location.pathname\n  // Remove trailing slash for comparison\n  const cleanPath = pathname.endsWith('/') ? pathname.slice(0, -1) : pathname\n  const cleanRoute = route.endsWith('/') ? route.slice(0, -1) : route\n  if (cleanRoute === '' || cleanRoute === '/') {\n    // Home page: strip /index.html or trailing slash\n    return cleanPath.replace(/\\/index\\.html$/, '') || ''\n  }\n  const idx = cleanPath.indexOf(cleanRoute)\n  if (idx > 0) {\n    return cleanPath.slice(0, idx)\n  }\n  return ''\n}\n\nlet basePath = ''\n\nexport function hydrate(data: HydrateData, Content?: ComponentType, chapterMapData?: ChapterMapData): void {\n  basePath = getBasePath(data.route)\n  currentRoute.value = data.route\n\n  // Initialize\n  loadTheme()\n  setupOfflineDetection()\n  setupInstallPrompt()\n  initDB()\n\n  // Register service worker for PWA offline support\n  registerServiceWorker(basePath)\n\n  // Handle popstate for back/forward navigation\n  window.addEventListener('popstate', () => {\n    currentRoute.value = window.location.pathname\n  })\n\n  // Handle client-side link clicks\n  // For now, allow normal browser navigation for cross-page links\n  // so each page loads its own HTML with the correct MDX content.\n  // Only intercept hash links for in-page navigation.\n  document.addEventListener('click', (e) => {\n    const link = (e.target as HTMLElement).closest('a')\n    if (!link) return\n\n    const href = link.getAttribute('href')\n    if (!href) return\n\n    // Let external and full-page links navigate normally\n    if (href.startsWith('http') || href.startsWith('#')) return\n\n    // Same-path hash links: handle client-side\n    if (href.startsWith(data.route + '#')) {\n      e.preventDefault()\n      const hash = href.slice(href.indexOf('#'))\n      const target = document.querySelector(hash)\n      if (target) target.scrollIntoView({ behavior: 'smooth' })\n      return\n    }\n\n    // Cross-page links: let the browser navigate normally\n    // (each page is a full server-rendered HTML document)\n  })\n\n  // Render the app\n  let page: VNode\n  switch (data.routeType) {\n    case 'home':\n      page = renderHomePage(data.manifest)\n      break\n    case 'book': {\n      const bookSlug = data.route.split('/')[2]\n      const book = data.manifest.books.find((b: Book) => b.slug === bookSlug)\n      page = book ? renderBookPage(book) : <div>Book not found</div>\n      break\n    }\n    case 'chapter':\n      page = Content\n        ? renderChapterPage(data.manifest, data.route, Content, data.pagination?.defaultMode, chapterMapData)\n        : <div>Loading...</div>\n      break\n    case 'article':\n      page = Content\n        ? renderArticlePage(data.manifest, data.route, Content)\n        : <div>Loading...</div>\n      break\n    case 'books':\n      page = renderHomePage(data.manifest)\n      break\n    case 'articles':\n      page = renderHomePage(data.manifest)\n      break\n    default:\n      page = <div>Page not found</div>\n  }\n\n  render(page, document.getElementById('app')!)\n}\n\n// Export for use in components\nexport { signal, effect }\n","structuredPatch":[{"oldStart":652,"oldLines":6,"newStart":652,"newLines":12,"lines":["   }"," ","   /* ── CTA button ─────────────────────────── */","+  .pressy-cta-group {","+    display: flex;","+    flex-wrap: wrap;","+    gap: 0.75rem;","+    align-items: center;","+  }","   .pressy-cta {","     display: inline-block;","     margin-top: 1.25rem;"]},{"oldStart":667,"oldLines":6,"newStart":673,"newLines":17,"lines":["   .pressy-cta:hover {","     opacity: 0.85;","   }","+  .pressy-cta-secondary {","+    background: transparent;","+    color: var(--color-link, #2563eb);","+    border: 1.5px solid var(--color-link, #2563eb);","+    cursor: pointer;","+    font-family: inherit;","+  }","+  .pressy-cta-secondary:hover {","+    background: var(--color-link, #2563eb);","+    color: #fff;","+  }"," ","   /* ── Sections below hero ────────────────── */","   .pressy-fade-sections {"]}],"userModified":false,"replaceAll":false},"sourceToolAssistantUUID":"ae1b4b49-3485-4cd3-bb64-7708e7e365f3"}
{"parentUuid":"8f4e4387-a621-443e-976b-414763132ef7","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","message":{"model":"claude-opus-4-6","id":"msg_015bXy92XBxVTPGj9BQL1xpU","type":"message","role":"assistant","content":[{"type":"text","text":"Now let me verify the build passes."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":664,"cache_read_input_tokens":35727,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":664},"output_tokens":3,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CYAtRU1RwNEXAFHUEVb2B","type":"assistant","uuid":"1f3e4d2a-903b-4c6a-99dd-5f833345e167","timestamp":"2026-02-16T01:33:54.454Z"}
{"parentUuid":"1f3e4d2a-903b-4c6a-99dd-5f833345e167","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","message":{"model":"claude-opus-4-6","id":"msg_015bXy92XBxVTPGj9BQL1xpU","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01AEt7xUUUwkkdxMFsEgSLiW","name":"Bash","input":{"command":"pnpm --filter pressy build 2>&1","description":"Build pressy package to verify no errors","timeout":60000},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":664,"cache_read_input_tokens":35727,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":664},"output_tokens":3,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CYAtRU1RwNEXAFHUEVb2B","type":"assistant","uuid":"0ee350d5-6326-4cd5-82c4-b2e244318ffb","timestamp":"2026-02-16T01:33:55.706Z"}
{"parentUuid":"0ee350d5-6326-4cd5-82c4-b2e244318ffb","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","type":"progress","data":{"type":"bash_progress","output":"ESM dist/vite/plugin.js.map     52.96 KB\nESM dist/runtime/offline.js.map 10.20 KB\nESM dist/runtime/sw.js.map      8.29 KB\nESM ⚡️ Build success in 16ms\nDTS Build start","fullOutput":"> pressy@0.1.1 build /Users/blittle/dev/pressy/packages/pressy\n> tsup\nCLI Building entry: {\"index\":\"src/index.ts\",\"cli/index\":\"src/cli/index.ts\",\"vite/plugin\":\"src/vite/plugin.ts\",\"runtime/client\":\"src/runtime/client.tsx\",\"runtime/offline\":\"src/runtime/offline.ts\",\"runtime/sw\":\"src/runtime/sw.ts\"}\nCLI Using tsconfig: tsconfig.json\nCLI tsup v8.5.1\nCLI Using tsup config: /Users/blittle/dev/pressy/packages/pressy/tsup.config.ts\nCLI Target: node18\nCLI Cleaning output folder\nESM Build start\nESM dist/index.js               30.25 KB\nESM dist/runtime/client.js      28.01 KB\nESM dist/cli/index.js           32.92 KB\nESM dist/vite/plugin.js         29.94 KB\nESM dist/runtime/offline.js     5.52 KB\nESM dist/runtime/sw.js          4.09 KB\nESM dist/index.js.map           54.88 KB\nESM dist/runtime/client.js.map  48.30 KB\nESM dist/cli/index.js.map       58.66 KB\nESM dist/vite/plugin.js.map     52.96 KB\nESM dist/runtime/offline.js.map 10.20 KB\nESM dist/runtime/sw.js.map      8.29 KB\nESM ⚡️ Build success in 16ms\nDTS Build start","elapsedTimeSeconds":2,"totalLines":23,"timeoutMs":60000},"toolUseID":"bash-progress-0","parentToolUseID":"toolu_01AEt7xUUUwkkdxMFsEgSLiW","uuid":"f8e393bf-3aca-41c2-be9f-ae9180fa464c","timestamp":"2026-02-16T01:33:57.712Z"}
{"parentUuid":"f8e393bf-3aca-41c2-be9f-ae9180fa464c","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","type":"progress","data":{"type":"bash_progress","output":"ESM dist/vite/plugin.js.map     52.96 KB\nESM dist/runtime/offline.js.map 10.20 KB\nESM dist/runtime/sw.js.map      8.29 KB\nESM ⚡️ Build success in 16ms\nDTS Build start","fullOutput":"> pressy@0.1.1 build /Users/blittle/dev/pressy/packages/pressy\n> tsup\nCLI Building entry: {\"index\":\"src/index.ts\",\"cli/index\":\"src/cli/index.ts\",\"vite/plugin\":\"src/vite/plugin.ts\",\"runtime/client\":\"src/runtime/client.tsx\",\"runtime/offline\":\"src/runtime/offline.ts\",\"runtime/sw\":\"src/runtime/sw.ts\"}\nCLI Using tsconfig: tsconfig.json\nCLI tsup v8.5.1\nCLI Using tsup config: /Users/blittle/dev/pressy/packages/pressy/tsup.config.ts\nCLI Target: node18\nCLI Cleaning output folder\nESM Build start\nESM dist/index.js               30.25 KB\nESM dist/runtime/client.js      28.01 KB\nESM dist/cli/index.js           32.92 KB\nESM dist/vite/plugin.js         29.94 KB\nESM dist/runtime/offline.js     5.52 KB\nESM dist/runtime/sw.js          4.09 KB\nESM dist/index.js.map           54.88 KB\nESM dist/runtime/client.js.map  48.30 KB\nESM dist/cli/index.js.map       58.66 KB\nESM dist/vite/plugin.js.map     52.96 KB\nESM dist/runtime/offline.js.map 10.20 KB\nESM dist/runtime/sw.js.map      8.29 KB\nESM ⚡️ Build success in 16ms\nDTS Build start","elapsedTimeSeconds":3,"totalLines":23,"timeoutMs":60000},"toolUseID":"bash-progress-1","parentToolUseID":"toolu_01AEt7xUUUwkkdxMFsEgSLiW","uuid":"05367f4e-d873-4584-ade5-8f8eebcf1a29","timestamp":"2026-02-16T01:33:58.713Z"}
{"parentUuid":"05367f4e-d873-4584-ade5-8f8eebcf1a29","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","type":"progress","data":{"type":"bash_progress","output":"ESM dist/vite/plugin.js.map     52.96 KB\nESM dist/runtime/offline.js.map 10.20 KB\nESM dist/runtime/sw.js.map      8.29 KB\nESM ⚡️ Build success in 16ms\nDTS Build start","fullOutput":"> pressy@0.1.1 build /Users/blittle/dev/pressy/packages/pressy\n> tsup\nCLI Building entry: {\"index\":\"src/index.ts\",\"cli/index\":\"src/cli/index.ts\",\"vite/plugin\":\"src/vite/plugin.ts\",\"runtime/client\":\"src/runtime/client.tsx\",\"runtime/offline\":\"src/runtime/offline.ts\",\"runtime/sw\":\"src/runtime/sw.ts\"}\nCLI Using tsconfig: tsconfig.json\nCLI tsup v8.5.1\nCLI Using tsup config: /Users/blittle/dev/pressy/packages/pressy/tsup.config.ts\nCLI Target: node18\nCLI Cleaning output folder\nESM Build start\nESM dist/index.js               30.25 KB\nESM dist/runtime/client.js      28.01 KB\nESM dist/cli/index.js           32.92 KB\nESM dist/vite/plugin.js         29.94 KB\nESM dist/runtime/offline.js     5.52 KB\nESM dist/runtime/sw.js          4.09 KB\nESM dist/index.js.map           54.88 KB\nESM dist/runtime/client.js.map  48.30 KB\nESM dist/cli/index.js.map       58.66 KB\nESM dist/vite/plugin.js.map     52.96 KB\nESM dist/runtime/offline.js.map 10.20 KB\nESM dist/runtime/sw.js.map      8.29 KB\nESM ⚡️ Build success in 16ms\nDTS Build start","elapsedTimeSeconds":4,"totalLines":23,"timeoutMs":60000},"toolUseID":"bash-progress-2","parentToolUseID":"toolu_01AEt7xUUUwkkdxMFsEgSLiW","uuid":"05d63c36-f33a-4ba1-b13e-14106df3d1b9","timestamp":"2026-02-16T01:33:59.713Z"}
{"parentUuid":"0ee350d5-6326-4cd5-82c4-b2e244318ffb","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01AEt7xUUUwkkdxMFsEgSLiW","type":"tool_result","content":"> pressy@0.1.1 build /Users/blittle/dev/pressy/packages/pressy\n> tsup\n\nCLI Building entry: {\"index\":\"src/index.ts\",\"cli/index\":\"src/cli/index.ts\",\"vite/plugin\":\"src/vite/plugin.ts\",\"runtime/client\":\"src/runtime/client.tsx\",\"runtime/offline\":\"src/runtime/offline.ts\",\"runtime/sw\":\"src/runtime/sw.ts\"}\nCLI Using tsconfig: tsconfig.json\nCLI tsup v8.5.1\nCLI Using tsup config: /Users/blittle/dev/pressy/packages/pressy/tsup.config.ts\nCLI Target: node18\nCLI Cleaning output folder\nESM Build start\nESM dist/index.js               30.25 KB\nESM dist/runtime/client.js      28.01 KB\nESM dist/cli/index.js           32.92 KB\nESM dist/vite/plugin.js         29.94 KB\nESM dist/runtime/offline.js     5.52 KB\nESM dist/runtime/sw.js          4.09 KB\nESM dist/index.js.map           54.88 KB\nESM dist/runtime/client.js.map  48.30 KB\nESM dist/cli/index.js.map       58.66 KB\nESM dist/vite/plugin.js.map     52.96 KB\nESM dist/runtime/offline.js.map 10.20 KB\nESM dist/runtime/sw.js.map      8.29 KB\nESM ⚡️ Build success in 16ms\nDTS Build start\nDTS ⚡️ Build success in 2787ms\nDTS dist/index.d.ts           329.00 B\nDTS dist/cli/index.d.ts       20.00 B\nDTS dist/vite/plugin.d.ts     180.00 B\nDTS dist/runtime/client.d.ts  1.43 KB\nDTS dist/runtime/offline.d.ts 1.12 KB\nDTS dist/runtime/sw.d.ts      13.00 B\nDTS dist/types-DtFj4lcD.d.ts  1.62 KB\nDTS dist/config-M8fI46fg.d.ts 1.56 KB","is_error":false}]},"uuid":"93e1f7b9-9112-407f-8f77-09eb3c4f8189","timestamp":"2026-02-16T01:33:59.778Z","toolUseResult":{"stdout":"> pressy@0.1.1 build /Users/blittle/dev/pressy/packages/pressy\n> tsup\n\nCLI Building entry: {\"index\":\"src/index.ts\",\"cli/index\":\"src/cli/index.ts\",\"vite/plugin\":\"src/vite/plugin.ts\",\"runtime/client\":\"src/runtime/client.tsx\",\"runtime/offline\":\"src/runtime/offline.ts\",\"runtime/sw\":\"src/runtime/sw.ts\"}\nCLI Using tsconfig: tsconfig.json\nCLI tsup v8.5.1\nCLI Using tsup config: /Users/blittle/dev/pressy/packages/pressy/tsup.config.ts\nCLI Target: node18\nCLI Cleaning output folder\nESM Build start\nESM dist/index.js               30.25 KB\nESM dist/runtime/client.js      28.01 KB\nESM dist/cli/index.js           32.92 KB\nESM dist/vite/plugin.js         29.94 KB\nESM dist/runtime/offline.js     5.52 KB\nESM dist/runtime/sw.js          4.09 KB\nESM dist/index.js.map           54.88 KB\nESM dist/runtime/client.js.map  48.30 KB\nESM dist/cli/index.js.map       58.66 KB\nESM dist/vite/plugin.js.map     52.96 KB\nESM dist/runtime/offline.js.map 10.20 KB\nESM dist/runtime/sw.js.map      8.29 KB\nESM ⚡️ Build success in 16ms\nDTS Build start\nDTS ⚡️ Build success in 2787ms\nDTS dist/index.d.ts           329.00 B\nDTS dist/cli/index.d.ts       20.00 B\nDTS dist/vite/plugin.d.ts     180.00 B\nDTS dist/runtime/client.d.ts  1.43 KB\nDTS dist/runtime/offline.d.ts 1.12 KB\nDTS dist/runtime/sw.d.ts      13.00 B\nDTS dist/types-DtFj4lcD.d.ts  1.62 KB\nDTS dist/config-M8fI46fg.d.ts 1.56 KB","stderr":"","interrupted":false,"isImage":false,"noOutputExpected":false},"sourceToolAssistantUUID":"0ee350d5-6326-4cd5-82c4-b2e244318ffb"}
{"parentUuid":"93e1f7b9-9112-407f-8f77-09eb3c4f8189","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","message":{"model":"claude-opus-4-6","id":"msg_01X9V4K3XwjKq2Z9ZVHe8LWr","type":"message","role":"assistant","content":[{"type":"text","text":"Build succeeds with no errors. Here's a summary of what was implemented:\n\n**`offline.ts`** — Added:\n- `installPrompt` signal to hold the stashed `beforeinstallprompt` event\n- `setupInstallPrompt()` — listens for `beforeinstallprompt` (stashes event) and `appinstalled` (clears it)\n- `triggerInstall()` — calls `prompt()` on the stashed event and returns whether the user accepted\n\n**`client.tsx`** — Added:\n- Imported `installPrompt`, `setupInstallPrompt`, `triggerInstall` from offline\n- Called `setupInstallPrompt()` in `hydrate()` alongside existing setup calls\n- `InstallButton` component — renders only when `installPrompt.value` is set, calls `triggerInstall()` on click\n- Wrapped `StartReadingCTA` + `InstallButton` in a `<div class=\"pressy-cta-group\">` flex container\n- Added `.pressy-cta-group`, `.pressy-cta-secondary`, and hover styles to `HOME_STYLES`"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":691,"cache_read_input_tokens":36391,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":691},"output_tokens":1,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CYAtS1TnR2DRRMAiZpErz","type":"assistant","uuid":"3b8c37b9-7cc5-4082-82b4-4dd15787cfcb","timestamp":"2026-02-16T01:34:07.149Z"}
{"parentUuid":"3b8c37b9-7cc5-4082-82b4-4dd15787cfcb","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","type":"progress","data":{"type":"hook_progress","hookEvent":"Stop","hookName":"Stop","command":"entire hooks claude-code stop"},"parentToolUseID":"17590c09-7620-4ffd-9bf3-2cb48e69d09f","toolUseID":"17590c09-7620-4ffd-9bf3-2cb48e69d09f","timestamp":"2026-02-16T01:34:07.201Z","uuid":"999f3326-11c3-4825-84e3-da10c23aecd8"}
{"parentUuid":"999f3326-11c3-4825-84e3-da10c23aecd8","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","type":"system","subtype":"stop_hook_summary","hookCount":1,"hookInfos":[{"command":"entire hooks claude-code stop"}],"hookErrors":[],"preventedContinuation":false,"stopReason":"","hasOutput":true,"level":"suggestion","timestamp":"2026-02-16T01:34:07.985Z","uuid":"755aa9b4-e100-4a8f-8a00-96d303a248d7","toolUseID":"17590c09-7620-4ffd-9bf3-2cb48e69d09f"}
{"parentUuid":"755aa9b4-e100-4a8f-8a00-96d303a248d7","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","type":"system","subtype":"turn_duration","durationMs":57802,"timestamp":"2026-02-16T01:34:07.988Z","uuid":"27abeca2-a256-4780-82b8-737823275116","isMeta":false}
{"type":"file-history-snapshot","messageId":"e2fc2cc8-e4ba-4cb7-a8c1-914d80dbfdd2","snapshot":{"messageId":"e2fc2cc8-e4ba-4cb7-a8c1-914d80dbfdd2","trackedFileBackups":{"packages/pressy/src/runtime/offline.ts":{"backupFileName":"259b478c67f372e9@v2","version":2,"backupTime":"2026-02-16T01:34:16.305Z"},"packages/pressy/src/runtime/client.tsx":{"backupFileName":"553e6fae6ff514b2@v2","version":2,"backupTime":"2026-02-16T01:34:16.306Z"}},"timestamp":"2026-02-16T01:34:16.305Z"},"isSnapshotUpdate":false}
{"parentUuid":"27abeca2-a256-4780-82b8-737823275116","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","type":"user","message":{"role":"user","content":"Could we automatically download for offline usage if the user installs the app? So they don't have to click the icon in the footer?"},"uuid":"e2fc2cc8-e4ba-4cb7-a8c1-914d80dbfdd2","timestamp":"2026-02-16T01:34:15.695Z","thinkingMetadata":{"maxThinkingTokens":31999},"permissionMode":"acceptEdits"}
{"parentUuid":"e2fc2cc8-e4ba-4cb7-a8c1-914d80dbfdd2","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","message":{"model":"claude-opus-4-6","id":"msg_015ocSH7FHjExm2pMdJ5QB4o","type":"message","role":"assistant","content":[{"type":"text","text":"\n\n"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":31,"cache_read_input_tokens":37350,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":31},"output_tokens":11,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CYAtTE9JhgiAQX6UGtM5a","type":"assistant","uuid":"55f49a83-d9a9-4296-81f8-c849ef4959f9","timestamp":"2026-02-16T01:34:18.489Z"}
{"parentUuid":"55f49a83-d9a9-4296-81f8-c849ef4959f9","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","message":{"model":"claude-opus-4-6","id":"msg_015ocSH7FHjExm2pMdJ5QB4o","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"The user wants to automatically trigger the offline download when the user installs the PWA. Let me look at how the download flow works to understand what needs to happen.\n\nFrom `offline.ts`, `downloadBookForOffline(bookSlug, chapterUrls)` is the function that caches a book for offline reading. \n\nFrom `client.tsx`, in the `hydrate()` function we have access to `data.manifest` which contains the books and their chapters.\n\nThe `appinstalled` event fires when the user installs the PWA. We can hook into that to trigger the download.\n\nThe key question is: where to trigger this. The `setupInstallPrompt()` function in `offline.ts` already listens for `appinstalled`. But `offline.ts` doesn't have access to the book data/manifest. \n\n\nI think the cleanest approach is to add the `appinstalled` listener directly in `client.tsx`'s `hydrate()` function, where I have access to both the manifest and the download function. I'll add an `appinstalled` listener in `hydrate()` that iterates through the books and downloads them offline. I should also check if each book is already cached to skip redundant downloads.","signature":"EpgSCkYICxgCKkDJaxHmJZOTJLpxsP2kEUmpJsMoeRhI3BN07gBxfgoWHbcBFZq41lsJM8PDdAUM1x1Y3fZ61wXaKV/JUm8H4h1wEgxS1MSFyMSD3DxY7OcaDNkdxwH3m2DrNHuJKSIwMm2qRgYMM8ax6tF/8k1IeiSONTZJh63N96+ON3JeLCkinUlfDqRH7o8VhCMD08ImKv8Q8X2IBMt15jKj1fESQMzDo8utLbZaWmjcILKP+wU5z2X7Mp4ThKjToZbMnpdZ/n5B0tRyKQRguRoUfeAEVr65nm4cZLo8orpdeFon2U/tKuc2upziGSk9sNVkv2RFqeMJ2MrwOsJFJBku7JXP53xfkULn6lFYAMW7ugDZkmlpAIkgDzGmS5bRItz7Cnz49iFILOEKK7M1INCy+A2TGCcv2Het3KtyoQpGTBO8+lUzCvaHSf52NBI4pba31SntRnDFIc8dyPEDYcxaawVAvc3fPMZ5Qkv2FiTb60O6hTIRrRZrvrLv4oF7glrllkElQnra38FQ6wUuoYn2aa2onhTqKWQxofKGidmjbAO0LnFv2FJjTtgM+DIIwLiMNHOPdeYN0LkKIKGkB0358Cmu/XWnEDsY4QdH/L+EL7OzbZGVS0Ko5juvQY2E/UhKjWCk1eMaJa8CIc+z5pTfk6Zn/KzQ3UjdlM1TIVYs2CvwKKBwzc8seEfOAHifb5MujHTph9o4vv3LGo6gciXV0rRUbmX89/R+Kf36FYHP4b0TEA0l650MzP+8TejDMzfaYML9zSVBPMMf/6KoEW7rAbdeyJ4F8Bp6YnTn6uye/hEe2tKAAret1y+cLCcbAZboHwvaiEv6HP+DU756ieHmApWJJL5kL7NBwp6zKyadRjVUVqvabOLMW15p4UyPTYcl23PAWu3GeaskUOTNm0yOGFleMZtw/Zx/FcEi+pC+d07EdtQC59m9vHmmtq2Bxm7FiQD9IwmfJSXUTii56oYtA+al9W7KvMlYbbEhKlOhmslLPFb25Hf6ub8Ui2askj405oPC29PqUwb+BSgxTlHTouTe3QG5Du00y7J7jblO7EahnhnWQ7Ui7i8lsNR74kSouiNiojTbIIqQ4sliKLAiN6lkI6Xiw/PVDbjZuezTRlBWzjTQpULzzdQf6t4DTdCVw1NQF97XaEk2uBy5ZRxHQCuLmrXyscsCL+MoODWqClpaer+N7He4sgR51Yr0otsG6gJRKOh3+j5X6FygXLCNLe38CgoghW6Az4HKrgQHC3kzcnE1YDvsuqX9vx93LDC/d8+z8O6GdT+fLEIZy4Pb5mO60A7ZS3Z3BE786SykDXDECzJWQrZ8HbO94VuG50jQ8BFaoICTmaKSQDNht7c/uCrE5DWDwIIrQ6UWCncEY1XtLAlcmBMUBOuhQ0XkqwDzCT2eO5ksqfS7gF608/5UsGSuN7GY43yrjQMeeBJEz97Wig4bOx514v2a534gqNYhYqijXnEddIi4kPSrIw7Kf3EoLoTd9b2uHDbULGZc3Xot9qHA5ZxDMy2UBviglg8tTrSipF4HkK1zNjuSjuG84PyguPrq+NFNNutyhjSvvv5aVv40lzDHYyk6v8dHssY4nfi2kjips9tF5k7kPncOv6mpQHsI/qId+r/uHRw7EC03P5ylI2EgRigTtb539HZRf8Ozn2y9nH3vXp9Hp3500oNReFD5h2Ti9HbfA0bqmTQv7v28sCXt6PfLzwFm/HglRrUfd7Q/nOvvDCyZkvtUUXZS9bWxL5nO9S9h0VUPuaVjkcK8CtFtoR7KAj7nAqp9QZ4ewFsb0DY70J3WbazqV8RGiY7xKgvczZa3R5zqRKQ1yZk3waEq0CoSprUwNOulRdHNBBnhgDa3tawCNvZvCFj+qUwNmS63/Tl4ojWUoc9X5j2pATHgr63r4eF3OvKHxwIw7kFS0yyRu0E15udx5x2aZs9+pmzjtkOrhmVTzseDhcQlWoTRhfPTVOMrhIilPR7Q2YM7AwjIMGLgZFc42phGu/jE7I7dhcClsmXpYmoMcACLXv0DMBTKqmKqdnqlsPenyfWlTKOIsWTmBd8SxHTZZuA4doKGhsQ7asPVbw3CVfW/K8OGYqYQZtX5Bk9yXJSaDgtPTqoDLSkWgs43gJNW5rE+OTJHCYM5rH9Jbfi1c9YQqxzsNtO7tRUNSnmHrdXnmZgiVnzjrVj8Y4+m0hRYMBA+rftHedscMqUvFSMJGFbEwf9cWAUST92rFf+2xriIKUCoQLkiUo090Y/dbr5aFumU3fP9H2x4SS7KTnc0OjG7wvoS9a0nnsjLs/vD8IPN+96E4eYNWrRrdnpKHN9OK5aKjq0bAI2m5tfxz7UmA5hug3NIAtQXQ2u4qif6zfa0YvzE0rX+AFyXE8Zfu1p814HTL/b/7j/KHUGxykYplIN3/EST9xIK7MWswPmvk7TCpRSegzyo0STOBWBGQ15w3vrQiG1r45mxEnAP84JZHZT1a2+TbKBVXLV2p5rsqDWPykyOegAAVt32YZpHHvpNKjnIe2OYHQEfboqTXNEZkOYE/FFmk3nDJAvRZZrIK14cZtWUwEYDMYUQPp2DWnWuYYaKqUQWm10Tbc9N8oGGhyAtc7me+D6Ff4reR5QzFykttklvGe8ElnM/BYDRMDuBx67qdNskot9j4VkvKH2IMnyZ5CrhYM7N8mzSTsX6KMTxnjG3H58otdDVw4wzQa4S+Ya1CKlS6OFyKd3i1UZkyUG6gFDH7epGqmYdooHeV5IfV/F+NPGcLNhk5avt8QG6zyEzW/ogS6wqx8n0HXp6l+vqggqZU/9SRpJanojp5GvaTIQuo43kVuO5LuL1QSCx4xMXLWxZ0QsCM+B6ShMT1jfCO5CuCw2/1VNCM5SYcgLZHlPT9bhoaZ6RBhD5VOuXKQaZxPxpeoJnBLb98yuo+qj201JUCm+GKwOm7EJEMa7NxMyxaUciR2GaEATQSffi6paSABFo33YqYJCx0dSoKc5BJCQ4vK1thErF+5aUzDNzvy8UTQqoFLyZHEEIQUC2GZNrEcEdOQCwpR//fEM0GH7o9Bjuwg7+qlHIi36nXISCAvWjoVZ/gZYzygYwNB+tFRxrGAE="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":31,"cache_read_input_tokens":37350,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":31},"output_tokens":11,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CYAtTE9JhgiAQX6UGtM5a","type":"assistant","uuid":"a69d7140-f38f-479a-9bc2-0e0adcef3681","timestamp":"2026-02-16T01:34:31.938Z"}
{"parentUuid":"a69d7140-f38f-479a-9bc2-0e0adcef3681","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","message":{"model":"claude-opus-4-6","id":"msg_015ocSH7FHjExm2pMdJ5QB4o","type":"message","role":"assistant","content":[{"type":"text","text":"Simple and clean — I'll add an `appinstalled` listener in `hydrate()` that automatically downloads all books for offline reading when the user installs the PWA."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":31,"cache_read_input_tokens":37350,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":31},"output_tokens":11,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CYAtTE9JhgiAQX6UGtM5a","type":"assistant","uuid":"b9181ab1-1918-4e8c-a908-08d6bd3b5d86","timestamp":"2026-02-16T01:34:31.977Z"}
{"parentUuid":"b9181ab1-1918-4e8c-a908-08d6bd3b5d86","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","message":{"model":"claude-opus-4-6","id":"msg_015ocSH7FHjExm2pMdJ5QB4o","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01TFmUwcVhdeAsZinpC3x2ks","name":"Read","input":{"file_path":"/Users/blittle/dev/pressy/packages/pressy/src/runtime/client.tsx","offset":730,"limit":30},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":31,"cache_read_input_tokens":37350,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":31},"output_tokens":11,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CYAtTE9JhgiAQX6UGtM5a","type":"assistant","uuid":"55e3eb24-dc3f-4a7f-816a-3a64aa32213d","timestamp":"2026-02-16T01:34:32.819Z"}
{"parentUuid":"55e3eb24-dc3f-4a7f-816a-3a64aa32213d","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","type":"progress","data":{"type":"hook_progress","hookEvent":"PostToolUse","hookName":"PostToolUse:Read","command":"callback"},"parentToolUseID":"toolu_01TFmUwcVhdeAsZinpC3x2ks","toolUseID":"toolu_01TFmUwcVhdeAsZinpC3x2ks","timestamp":"2026-02-16T01:34:32.825Z","uuid":"4f94b442-eca1-4e3b-bfce-2d503c60539b"}
{"parentUuid":"55e3eb24-dc3f-4a7f-816a-3a64aa32213d","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01TFmUwcVhdeAsZinpC3x2ks","type":"tool_result","content":"   730→  }\n   731→`\n   732→\n   733→// ── Main hydration function ─────────────────────────────────\n   734→\n   735→interface HydrateData {\n   736→  route: string\n   737→  routeType: string\n   738→  manifest: ContentManifest\n   739→  pagination?: PaginationConfig\n   740→}\n   741→\n   742→// Compute the base path by comparing the known route to the actual URL\n   743→// e.g. URL=\"/pressy/pr-preview/pr-4/books/flatland\" with route=\"/books/flatland\"\n   744→// yields basePath=\"/pressy/pr-preview/pr-4\"\n   745→function getBasePath(route: string): string {\n   746→  const pathname = window.location.pathname\n   747→  // Remove trailing slash for comparison\n   748→  const cleanPath = pathname.endsWith('/') ? pathname.slice(0, -1) : pathname\n   749→  const cleanRoute = route.endsWith('/') ? route.slice(0, -1) : route\n   750→  if (cleanRoute === '' || cleanRoute === '/') {\n   751→    // Home page: strip /index.html or trailing slash\n   752→    return cleanPath.replace(/\\/index\\.html$/, '') || ''\n   753→  }\n   754→  const idx = cleanPath.indexOf(cleanRoute)\n   755→  if (idx > 0) {\n   756→    return cleanPath.slice(0, idx)\n   757→  }\n   758→  return ''\n   759→}"}]},"uuid":"d94f8b7e-06ec-47d6-afc2-8e1aa564cb58","timestamp":"2026-02-16T01:34:32.824Z","toolUseResult":{"type":"text","file":{"filePath":"/Users/blittle/dev/pressy/packages/pressy/src/runtime/client.tsx","content":"  }\n`\n\n// ── Main hydration function ─────────────────────────────────\n\ninterface HydrateData {\n  route: string\n  routeType: string\n  manifest: ContentManifest\n  pagination?: PaginationConfig\n}\n\n// Compute the base path by comparing the known route to the actual URL\n// e.g. URL=\"/pressy/pr-preview/pr-4/books/flatland\" with route=\"/books/flatland\"\n// yields basePath=\"/pressy/pr-preview/pr-4\"\nfunction getBasePath(route: string): string {\n  const pathname = window.location.pathname\n  // Remove trailing slash for comparison\n  const cleanPath = pathname.endsWith('/') ? pathname.slice(0, -1) : pathname\n  const cleanRoute = route.endsWith('/') ? route.slice(0, -1) : route\n  if (cleanRoute === '' || cleanRoute === '/') {\n    // Home page: strip /index.html or trailing slash\n    return cleanPath.replace(/\\/index\\.html$/, '') || ''\n  }\n  const idx = cleanPath.indexOf(cleanRoute)\n  if (idx > 0) {\n    return cleanPath.slice(0, idx)\n  }\n  return ''\n}","numLines":30,"startLine":730,"totalLines":845}},"sourceToolAssistantUUID":"55e3eb24-dc3f-4a7f-816a-3a64aa32213d"}
{"parentUuid":"d94f8b7e-06ec-47d6-afc2-8e1aa564cb58","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","message":{"model":"claude-opus-4-6","id":"msg_016LnH7c5UC4ga4c7iiCDyFH","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01Jh7Y5BV6gNSyz4afhi6jYu","name":"Read","input":{"file_path":"/Users/blittle/dev/pressy/packages/pressy/src/runtime/client.tsx","offset":760,"limit":30},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":1252,"cache_read_input_tokens":37381,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":1252},"output_tokens":24,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CYAtUSqpPwEfgf9cdnbXH","type":"assistant","uuid":"0882869e-cef6-45f0-a225-252f2990ee50","timestamp":"2026-02-16T01:34:35.478Z"}
{"parentUuid":"0882869e-cef6-45f0-a225-252f2990ee50","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","type":"progress","data":{"type":"hook_progress","hookEvent":"PostToolUse","hookName":"PostToolUse:Read","command":"callback"},"parentToolUseID":"toolu_01Jh7Y5BV6gNSyz4afhi6jYu","toolUseID":"toolu_01Jh7Y5BV6gNSyz4afhi6jYu","timestamp":"2026-02-16T01:34:35.506Z","uuid":"b7fc43db-2157-4176-a734-eab8b3498141"}
{"parentUuid":"0882869e-cef6-45f0-a225-252f2990ee50","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01Jh7Y5BV6gNSyz4afhi6jYu","type":"tool_result","content":"   760→\n   761→let basePath = ''\n   762→\n   763→export function hydrate(data: HydrateData, Content?: ComponentType, chapterMapData?: ChapterMapData): void {\n   764→  basePath = getBasePath(data.route)\n   765→  currentRoute.value = data.route\n   766→\n   767→  // Initialize\n   768→  loadTheme()\n   769→  setupOfflineDetection()\n   770→  setupInstallPrompt()\n   771→  initDB()\n   772→\n   773→  // Register service worker for PWA offline support\n   774→  registerServiceWorker(basePath)\n   775→\n   776→  // Handle popstate for back/forward navigation\n   777→  window.addEventListener('popstate', () => {\n   778→    currentRoute.value = window.location.pathname\n   779→  })\n   780→\n   781→  // Handle client-side link clicks\n   782→  // For now, allow normal browser navigation for cross-page links\n   783→  // so each page loads its own HTML with the correct MDX content.\n   784→  // Only intercept hash links for in-page navigation.\n   785→  document.addEventListener('click', (e) => {\n   786→    const link = (e.target as HTMLElement).closest('a')\n   787→    if (!link) return\n   788→\n   789→    const href = link.getAttribute('href')"}]},"uuid":"8fe4d725-26b9-4d42-92f6-e003cacd8dc8","timestamp":"2026-02-16T01:34:35.505Z","toolUseResult":{"type":"text","file":{"filePath":"/Users/blittle/dev/pressy/packages/pressy/src/runtime/client.tsx","content":"\nlet basePath = ''\n\nexport function hydrate(data: HydrateData, Content?: ComponentType, chapterMapData?: ChapterMapData): void {\n  basePath = getBasePath(data.route)\n  currentRoute.value = data.route\n\n  // Initialize\n  loadTheme()\n  setupOfflineDetection()\n  setupInstallPrompt()\n  initDB()\n\n  // Register service worker for PWA offline support\n  registerServiceWorker(basePath)\n\n  // Handle popstate for back/forward navigation\n  window.addEventListener('popstate', () => {\n    currentRoute.value = window.location.pathname\n  })\n\n  // Handle client-side link clicks\n  // For now, allow normal browser navigation for cross-page links\n  // so each page loads its own HTML with the correct MDX content.\n  // Only intercept hash links for in-page navigation.\n  document.addEventListener('click', (e) => {\n    const link = (e.target as HTMLElement).closest('a')\n    if (!link) return\n\n    const href = link.getAttribute('href')","numLines":30,"startLine":760,"totalLines":845}},"sourceToolAssistantUUID":"0882869e-cef6-45f0-a225-252f2990ee50"}
{"parentUuid":"8fe4d725-26b9-4d42-92f6-e003cacd8dc8","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","message":{"model":"claude-opus-4-6","id":"msg_01KoUMfmpsUbG8arkJQkHWd5","type":"message","role":"assistant","content":[{"type":"text","text":"Now I also need to import `isBookCached` to skip already-cached books."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":471,"cache_read_input_tokens":38633,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":471},"output_tokens":3,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CYAtUeo9sDxbDLWhKNS3R","type":"assistant","uuid":"85beb494-23be-452a-a579-3c2926dc9523","timestamp":"2026-02-16T01:34:38.661Z"}
{"parentUuid":"85beb494-23be-452a-a579-3c2926dc9523","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","message":{"model":"claude-opus-4-6","id":"msg_01KoUMfmpsUbG8arkJQkHWd5","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_013PugZzwYcUjKg6We3qnLpn","name":"Edit","input":{"replace_all":false,"file_path":"/Users/blittle/dev/pressy/packages/pressy/src/runtime/client.tsx","old_string":"import {\n  registerServiceWorker,\n  downloadBookForOffline,\n  clearBookCache,\n  cachedBooks,\n  cacheProgress,\n  installPrompt,\n  setupInstallPrompt,\n  triggerInstall,\n} from './offline.js'","new_string":"import {\n  registerServiceWorker,\n  downloadBookForOffline,\n  clearBookCache,\n  isBookCached,\n  cachedBooks,\n  cacheProgress,\n  installPrompt,\n  setupInstallPrompt,\n  triggerInstall,\n} from './offline.js'"},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":471,"cache_read_input_tokens":38633,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":471},"output_tokens":3,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CYAtUeo9sDxbDLWhKNS3R","type":"assistant","uuid":"03211ba2-e2ff-4755-904d-99bc5bb75a2e","timestamp":"2026-02-16T01:34:41.293Z"}
{"parentUuid":"03211ba2-e2ff-4755-904d-99bc5bb75a2e","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","type":"progress","data":{"type":"hook_progress","hookEvent":"PostToolUse","hookName":"PostToolUse:Edit","command":"callback"},"parentToolUseID":"toolu_013PugZzwYcUjKg6We3qnLpn","toolUseID":"toolu_013PugZzwYcUjKg6We3qnLpn","timestamp":"2026-02-16T01:34:41.306Z","uuid":"a3b575a6-4a9b-47fd-a6f4-9a4af6ba94cb"}
{"parentUuid":"03211ba2-e2ff-4755-904d-99bc5bb75a2e","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_013PugZzwYcUjKg6We3qnLpn","type":"tool_result","content":"The file /Users/blittle/dev/pressy/packages/pressy/src/runtime/client.tsx has been updated successfully."}]},"uuid":"3a0b794d-f422-46d5-bb9b-f2f437718831","timestamp":"2026-02-16T01:34:41.305Z","toolUseResult":{"filePath":"/Users/blittle/dev/pressy/packages/pressy/src/runtime/client.tsx","oldString":"import {\n  registerServiceWorker,\n  downloadBookForOffline,\n  clearBookCache,\n  cachedBooks,\n  cacheProgress,\n  installPrompt,\n  setupInstallPrompt,\n  triggerInstall,\n} from './offline.js'","newString":"import {\n  registerServiceWorker,\n  downloadBookForOffline,\n  clearBookCache,\n  isBookCached,\n  cachedBooks,\n  cacheProgress,\n  installPrompt,\n  setupInstallPrompt,\n  triggerInstall,\n} from './offline.js'","originalFile":"import { render, type ComponentType, type VNode } from 'preact'\nimport { useState, useEffect } from 'preact/hooks'\nimport { signal, effect } from '@preact/signals'\nimport { Reader } from '@pressy-pub/components'\nimport type { ProgressData } from '@pressy-pub/components'\nimport { useMDXComponents } from '@pressy-pub/components/content'\nimport {\n  registerServiceWorker,\n  downloadBookForOffline,\n  clearBookCache,\n  cachedBooks,\n  cacheProgress,\n  installPrompt,\n  setupInstallPrompt,\n  triggerInstall,\n} from './offline.js'\nimport type { ContentManifest, Route, Book, Chapter, Article, ReadingProgress, ChapterMapData } from '../types.js'\nimport type { PaginationConfig } from '../config.js'\n\n// State signals\nexport const currentRoute = signal<string>('/')\nexport const currentTheme = signal<'light' | 'dark' | 'sepia' | 'system'>('light')\nexport const isOffline = signal<boolean>(!navigator.onLine)\n\n// IndexedDB for reading progress\nconst DB_NAME = 'pressy'\nconst DB_VERSION = 1\nconst PROGRESS_STORE = 'reading-progress'\nconst UNLOCKS_STORE = 'unlocks'\n\nlet db: IDBDatabase | null = null\n\nasync function initDB(): Promise<IDBDatabase> {\n  if (db) return db\n\n  return new Promise((resolve, reject) => {\n    const request = indexedDB.open(DB_NAME, DB_VERSION)\n\n    request.onerror = () => reject(request.error)\n    request.onsuccess = () => {\n      db = request.result\n      resolve(db)\n    }\n\n    request.onupgradeneeded = (event) => {\n      const database = (event.target as IDBOpenDBRequest).result\n      if (!database.objectStoreNames.contains(PROGRESS_STORE)) {\n        database.createObjectStore(PROGRESS_STORE, { keyPath: 'chapterSlug' })\n      }\n      if (!database.objectStoreNames.contains(UNLOCKS_STORE)) {\n        database.createObjectStore(UNLOCKS_STORE, { keyPath: 'bookSlug' })\n      }\n    }\n  })\n}\n\nexport async function saveReadingProgress(progress: ReadingProgress): Promise<void> {\n  const database = await initDB()\n  return new Promise((resolve, reject) => {\n    const tx = database.transaction(PROGRESS_STORE, 'readwrite')\n    const store = tx.objectStore(PROGRESS_STORE)\n    const request = store.put(progress)\n    request.onsuccess = () => resolve()\n    request.onerror = () => reject(request.error)\n  })\n}\n\nexport async function getReadingProgress(chapterSlug: string): Promise<ReadingProgress | null> {\n  const database = await initDB()\n  return new Promise((resolve, reject) => {\n    const tx = database.transaction(PROGRESS_STORE, 'readonly')\n    const store = tx.objectStore(PROGRESS_STORE)\n    const request = store.get(chapterSlug)\n    request.onsuccess = () => resolve(request.result || null)\n    request.onerror = () => reject(request.error)\n  })\n}\n\nexport async function getAllReadingProgress(): Promise<ReadingProgress[]> {\n  const database = await initDB()\n  return new Promise((resolve, reject) => {\n    const tx = database.transaction(PROGRESS_STORE, 'readonly')\n    const store = tx.objectStore(PROGRESS_STORE)\n    const request = store.getAll()\n    request.onsuccess = () => resolve(request.result || [])\n    request.onerror = () => reject(request.error)\n  })\n}\n\nexport async function isBookUnlocked(bookSlug: string): Promise<boolean> {\n  const database = await initDB()\n  return new Promise((resolve, reject) => {\n    const tx = database.transaction(UNLOCKS_STORE, 'readonly')\n    const store = tx.objectStore(UNLOCKS_STORE)\n    const request = store.get(bookSlug)\n    request.onsuccess = () => resolve(!!request.result)\n    request.onerror = () => reject(request.error)\n  })\n}\n\nexport async function unlockBook(bookSlug: string, orderId?: string): Promise<void> {\n  const database = await initDB()\n  return new Promise((resolve, reject) => {\n    const tx = database.transaction(UNLOCKS_STORE, 'readwrite')\n    const store = tx.objectStore(UNLOCKS_STORE)\n    const request = store.put({ bookSlug, orderId, unlockedAt: Date.now() })\n    request.onsuccess = () => resolve()\n    request.onerror = () => reject(request.error)\n  })\n}\n\n// Client-side router\nexport function navigate(path: string, replace = false): void {\n  if (replace) {\n    history.replaceState(null, '', path)\n  } else {\n    history.pushState(null, '', path)\n  }\n  currentRoute.value = path\n}\n\n// Theme management\nfunction resolveSystemTheme(): 'light' | 'dark' {\n  return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light'\n}\n\nexport function setTheme(theme: 'light' | 'dark' | 'sepia' | 'system'): void {\n  currentTheme.value = theme\n  localStorage.setItem('pressy-theme', theme)\n  const resolved = theme === 'system' ? resolveSystemTheme() : theme\n  document.documentElement.setAttribute('data-theme', resolved)\n}\n\nfunction loadTheme(): void {\n  const saved = localStorage.getItem('pressy-theme') as 'light' | 'dark' | 'sepia' | 'system' | null\n  if (saved) {\n    setTheme(saved)\n  } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {\n    setTheme('dark')\n  }\n\n  // Listen for OS theme changes so \"system\" mode updates live\n  window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', () => {\n    if (currentTheme.value === 'system') {\n      document.documentElement.setAttribute('data-theme', resolveSystemTheme())\n    }\n  })\n}\n\n// Offline detection\nfunction setupOfflineDetection(): void {\n  window.addEventListener('online', () => {\n    isOffline.value = false\n  })\n  window.addEventListener('offline', () => {\n    isOffline.value = true\n  })\n}\n\n// ── Page renderers ──────────────────────────────────────────\n\nfunction StartReadingCTA({ book }: { book: Book }) {\n  const [target, setTarget] = useState<{ label: string; href: string } | null>(null)\n\n  useEffect(() => {\n    if (book.chapters.length === 0) return\n    const firstHref = `${basePath}/books/${book.slug}/${book.chapters[0].slug}`\n\n    getAllReadingProgress().then((allProgress) => {\n      const progressMap = new Map(allProgress.map((p) => [p.chapterSlug, p]))\n\n      // Walk chapters in order and find the furthest one that's in-progress (not completed)\n      let furthestInProgress: Chapter | null = null\n      for (const ch of book.chapters) {\n        const p = progressMap.get(ch.slug)\n        if (!p) continue\n        const completed = p.totalPages > 0 && p.page >= p.totalPages - 1\n        if (!completed && p.page > 0) {\n          furthestInProgress = ch\n        }\n      }\n\n      if (furthestInProgress) {\n        setTarget({\n          label: 'Continue Reading',\n          href: `${basePath}/books/${book.slug}/${furthestInProgress.slug}`,\n        })\n      } else {\n        setTarget({ label: 'Start Reading', href: firstHref })\n      }\n    }).catch(() => {\n      setTarget({ label: 'Start Reading', href: firstHref })\n    })\n  }, [book])\n\n  if (!target) return null\n\n  return (\n    <a href={target.href} class=\"pressy-cta\">\n      {target.label}\n    </a>\n  )\n}\n\nfunction InstallButton() {\n  if (!installPrompt.value) return null\n\n  return (\n    <button\n      class=\"pressy-cta pressy-cta-secondary\"\n      onClick={() => triggerInstall()}\n    >\n      Install\n    </button>\n  )\n}\n\nfunction renderBookPage(book: Book, articles: Article[] = []) {\n  // Stats calculations\n  const totalWords = book.chapters.reduce((sum, ch) => sum + (ch.wordCount || 0), 0)\n  const readingMinutes = Math.ceil(totalWords / 200)\n  const chapterCount = book.chapters.length\n  const publishYear = book.metadata.publishDate\n    ? new Date(book.metadata.publishDate).getFullYear()\n    : null\n\n  const formattedWords = totalWords.toLocaleString()\n\n  return (\n    <div class=\"pressy-home\">\n      <div class=\"pressy-hero\">\n        {book.coverUrl && (\n          <img\n            src={basePath + book.coverUrl}\n            alt={`${book.metadata.title} cover`}\n            class=\"pressy-hero-cover\"\n          />\n        )}\n        <div class=\"pressy-hero-text\">\n          <header class=\"pressy-home-header\">\n            <h1>{book.metadata.title}</h1>\n            <p class=\"pressy-home-author\">by {book.metadata.author}</p>\n            {book.metadata.description && (\n              <p class=\"pressy-home-desc\">{book.metadata.description}</p>\n            )}\n          </header>\n          {totalWords > 0 && (\n            <div class=\"pressy-stats\">\n              <span>{chapterCount} chapter{chapterCount !== 1 ? 's' : ''}</span>\n              <span class=\"pressy-stats-sep\">&middot;</span>\n              <span>{formattedWords} words</span>\n              <span class=\"pressy-stats-sep\">&middot;</span>\n              <span>~{readingMinutes} min</span>\n              {publishYear && (\n                <>\n                  <span class=\"pressy-stats-sep\">&middot;</span>\n                  <span>First published {publishYear}</span>\n                </>\n              )}\n            </div>\n          )}\n          {chapterCount > 0 && (\n            <div class=\"pressy-cta-group\">\n              <StartReadingCTA book={book} />\n              <InstallButton />\n            </div>\n          )}\n        </div>\n      </div>\n      {articles.length > 0 && (\n        <section class=\"pressy-home-section pressy-fade-sections\">\n          <h2>Articles</h2>\n          <nav class=\"pressy-chapter-list\">\n            {articles.map((article: Article) => (\n              <a\n                href={`${basePath}/articles/${article.slug}`}\n                class=\"pressy-chapter-link\"\n              >\n                {article.metadata.title}\n              </a>\n            ))}\n          </nav>\n        </section>\n      )}\n      <style>{HOME_STYLES}</style>\n    </div>\n  )\n}\n\nfunction renderHomePage(manifest: ContentManifest) {\n  // Single-book site: render as the book page\n  if (manifest.books.length === 1) {\n    return renderBookPage(manifest.books[0], manifest.articles)\n  }\n\n  const siteTitle = manifest.books[0]?.metadata.title || 'Library'\n\n  return (\n    <div class=\"pressy-home\">\n      <header class=\"pressy-home-header\">\n        <h1>{siteTitle}</h1>\n        {manifest.books[0]?.metadata.description && (\n          <p class=\"pressy-home-desc\">{manifest.books[0].metadata.description}</p>\n        )}\n      </header>\n      {manifest.books.length > 0 && (\n        <section class=\"pressy-home-section\">\n          <h2>Books</h2>\n          <nav class=\"pressy-chapter-list\">\n            {manifest.books.map((book: Book) => (\n              <a\n                href={`${basePath}/books/${book.slug}`}\n                class=\"pressy-chapter-link\"\n              >\n                {book.metadata.title}\n              </a>\n            ))}\n          </nav>\n        </section>\n      )}\n      {manifest.articles.length > 0 && (\n        <section class=\"pressy-home-section\">\n          <h2>Articles</h2>\n          <nav class=\"pressy-chapter-list\">\n            {manifest.articles.map((article: Article) => (\n              <a\n                href={`${basePath}/articles/${article.slug}`}\n                class=\"pressy-chapter-link\"\n              >\n                {article.metadata.title}\n              </a>\n            ))}\n          </nav>\n        </section>\n      )}\n      <style>{HOME_STYLES}</style>\n    </div>\n  )\n}\n\n// Calculates global book progress % from word counts + saved progress data\nfunction calculateBookProgressPercent(\n  book: Book,\n  currentChapterSlug: string,\n  currentPage: number,\n  currentTotalPages: number,\n  allProgress: ReadingProgress[],\n): number {\n  const totalWords = book.chapters.reduce((sum, ch) => sum + (ch.wordCount || 0), 0)\n  if (totalWords === 0) return 0\n\n  const progressMap = new Map(allProgress.map((p) => [p.chapterSlug, p]))\n  let wordsRead = 0\n\n  for (const ch of book.chapters) {\n    const chapterWords = ch.wordCount || 0\n    if (ch.slug === currentChapterSlug) {\n      // Use live page position for current chapter\n      if (currentTotalPages > 0) {\n        wordsRead += (currentPage / Math.max(1, currentTotalPages - 1)) * chapterWords\n      }\n    } else {\n      const progress = progressMap.get(ch.slug)\n      if (!progress) continue\n      if (progress.totalPages > 0 && progress.page >= progress.totalPages - 1) {\n        wordsRead += chapterWords\n      } else if (progress.page > 0 && progress.totalPages > 0) {\n        wordsRead += (progress.page / progress.totalPages) * chapterWords\n      }\n    }\n  }\n\n  return Math.min(100, (wordsRead / totalWords) * 100)\n}\n\n// Wrapper component that provides progress callbacks and computes global progress\nfunction ChapterReaderWithProgress({\n  book,\n  chapterSlug,\n  chapter,\n  prevChapter,\n  nextChapter,\n  paginationMode,\n  Content,\n  chapterMapData,\n}: {\n  book: Book\n  chapterSlug: string\n  chapter?: Chapter\n  prevChapter?: { slug: string; title: string }\n  nextChapter?: { slug: string; title: string }\n  paginationMode?: 'scroll' | 'paginated'\n  Content: ComponentType<{ components?: Record<string, unknown> }>\n  chapterMapData?: ChapterMapData\n}) {\n  const [bookProgressPercent, setBookProgressPercent] = useState<number | undefined>(undefined)\n\n  // Load initial global book progress\n  useEffect(() => {\n    getAllReadingProgress().then((allProgress) => {\n      const percent = calculateBookProgressPercent(book, chapterSlug, 0, 0, allProgress)\n      setBookProgressPercent(percent)\n    })\n  }, [book, chapterSlug])\n\n  const handleSaveProgress = (data: ProgressData) => {\n    saveReadingProgress({\n      chapterSlug,\n      page: data.page,\n      totalPages: data.totalPages,\n      scrollPosition: data.scrollPosition,\n      timestamp: Date.now(),\n    })\n\n    // Update global book progress with live page position\n    if (data.totalPages > 0) {\n      getAllReadingProgress().then((allProgress) => {\n        const percent = calculateBookProgressPercent(\n          book, chapterSlug, data.page, data.totalPages, allProgress,\n        )\n        setBookProgressPercent(percent)\n      })\n    }\n  }\n\n  const handleRestoreProgress = async (): Promise<ProgressData | null> => {\n    const progress = await getReadingProgress(chapterSlug)\n    if (!progress) return null\n    return {\n      page: progress.page,\n      totalPages: progress.totalPages,\n      scrollPosition: progress.scrollPosition,\n    }\n  }\n\n  const handleChapterChange = (slug: string, page: number, chapterTotalPages: number) => {\n    // Save progress for the chapter being left (mark as complete)\n    saveReadingProgress({\n      chapterSlug: slug,\n      page,\n      totalPages: chapterTotalPages,\n      scrollPosition: 0,\n      timestamp: Date.now(),\n    })\n\n    // Update global book progress\n    getAllReadingProgress().then((allProgress) => {\n      const percent = calculateBookProgressPercent(book, slug, page, chapterTotalPages, allProgress)\n      setBookProgressPercent(percent)\n    })\n  }\n\n  // Prefetch previous chapter HTML for fast backward navigation\n  useEffect(() => {\n    if (prevChapter) {\n      const link = document.createElement('link')\n      link.rel = 'prefetch'\n      link.href = prevChapter.slug\n      document.head.appendChild(link)\n      return () => { document.head.removeChild(link) }\n    }\n  }, [prevChapter])\n\n  return (\n    <Reader\n      title={chapter?.title || chapterSlug}\n      bookTitle={book.metadata.title}\n      chapterSlug={chapterSlug}\n      prevChapter={prevChapter}\n      nextChapter={nextChapter}\n      paginationMode={paginationMode}\n      onSaveProgress={handleSaveProgress}\n      onRestoreProgress={handleRestoreProgress}\n      bookProgressPercent={bookProgressPercent}\n      initialContent={Content}\n      chapterMapData={chapterMapData}\n      currentChapterSlug={chapterSlug}\n      allChapters={book.chapters.map(ch => ({ slug: ch.slug, title: ch.title, wordCount: ch.wordCount }))}\n      bookBasePath={`${basePath}/books/${book.slug}`}\n      onChapterChange={handleChapterChange}\n      mdxComponents={useMDXComponents()}\n      offlineProps={{\n        bookSlug: book.slug,\n        chapterUrls: book.chapters.map(ch => `${basePath}/books/${book.slug}/${ch.slug}`),\n        cachedBooks,\n        cacheProgress,\n        onDownload: downloadBookForOffline,\n        onRemove: clearBookCache,\n      }}\n    >\n      <Content components={useMDXComponents()} />\n    </Reader>\n  )\n}\n\nfunction renderChapterPage(\n  manifest: ContentManifest,\n  route: string,\n  Content: ComponentType,\n  paginationMode?: 'scroll' | 'paginated',\n  chapterMapData?: ChapterMapData,\n) {\n  const parts = route.split('/')\n  const bookSlug = parts[2]\n  const chapterSlug = parts[3]\n  const book = manifest.books.find((b: Book) => b.slug === bookSlug)\n  const chapterIdx = book ? book.chapters.findIndex((c: Chapter) => c.slug === chapterSlug) : -1\n  const chapter = book?.chapters[chapterIdx]\n  const chapterPath = (ch: Chapter) => `${basePath}/books/${bookSlug}/${ch.slug}`\n  const prevChapter = book && chapterIdx > 0\n    ? { slug: chapterPath(book.chapters[chapterIdx - 1]), title: book.chapters[chapterIdx - 1].title }\n    : book\n      ? { slug: `${basePath}/books/${bookSlug}`, title: book.metadata.title }\n      : undefined\n  const nextChapter = book && chapterIdx >= 0 && chapterIdx < book.chapters.length - 1\n    ? { slug: chapterPath(book.chapters[chapterIdx + 1]), title: book.chapters[chapterIdx + 1].title }\n    : book\n      ? { slug: `${basePath}/books/${bookSlug}`, title: book.metadata.title }\n      : undefined\n\n  const MDXContent = Content as ComponentType<{ components?: Record<string, unknown> }>\n\n  if (!book) {\n    return (\n      <Reader\n        title={chapter?.title || chapterSlug}\n        prevChapter={prevChapter}\n        nextChapter={nextChapter}\n        paginationMode={paginationMode}\n      >\n        <MDXContent components={useMDXComponents()} />\n      </Reader>\n    )\n  }\n\n  return (\n    <ChapterReaderWithProgress\n      book={book}\n      chapterSlug={chapterSlug}\n      chapter={chapter}\n      prevChapter={prevChapter}\n      nextChapter={nextChapter}\n      paginationMode={paginationMode}\n      Content={MDXContent}\n      chapterMapData={chapterMapData}\n    />\n  )\n}\n\nfunction renderArticlePage(\n  manifest: ContentManifest,\n  route: string,\n  Content: ComponentType,\n) {\n  const articleSlug = route.split('/')[2]\n  const article = manifest.articles.find((a: Article) => a.slug === articleSlug)\n\n  const MDXContent = Content as ComponentType<{ components?: Record<string, unknown> }>\n\n  return (\n    <Reader title={article?.metadata.title || articleSlug}>\n      <MDXContent components={useMDXComponents()} />\n    </Reader>\n  )\n}\n\n// ── Styles ──────────────────────────────────────────────────\n\nconst HOME_STYLES = `\n  @keyframes pressy-fade-in {\n    from { opacity: 0; transform: translateY(20px); }\n    to   { opacity: 1; transform: translateY(0); }\n  }\n  .pressy-home {\n    max-width: 65ch;\n    margin: 0 auto;\n    padding: 2rem 1.5rem;\n    font-family: var(--font-body, Georgia, 'Times New Roman', serif);\n    color: var(--color-text, #1a1a1a);\n  }\n\n  /* ── Hero layout ────────────────────────── */\n  .pressy-hero {\n    display: flex;\n    align-items: flex-start;\n    gap: 2.5rem;\n    margin-bottom: 2.5rem;\n  }\n  .pressy-hero-cover {\n    flex-shrink: 0;\n    max-width: 280px;\n    width: 100%;\n    height: auto;\n    border-radius: 4px;\n    box-shadow: 0 4px 24px rgba(0,0,0,0.15);\n    animation: pressy-fade-in 0.6s ease-out both;\n  }\n  .pressy-hero-text {\n    flex: 1;\n    animation: pressy-fade-in 0.6s ease-out 0.15s both;\n  }\n  @media (max-width: 700px) {\n    .pressy-hero {\n      flex-direction: column;\n      align-items: center;\n    }\n    .pressy-hero-cover {\n      max-width: 220px;\n    }\n    .pressy-hero-text {\n      text-align: center;\n    }\n    .pressy-home-desc {\n      margin-left: auto;\n      margin-right: auto;\n    }\n    .pressy-stats {\n      justify-content: center;\n    }\n  }\n\n  /* ── Header ─────────────────────────────── */\n  .pressy-home-header {\n    margin-bottom: 1rem;\n  }\n  .pressy-home-header h1 {\n    font-size: 2rem;\n    margin-bottom: 0.5rem;\n  }\n  .pressy-home-author {\n    font-style: italic;\n    color: var(--color-text-muted, #666);\n  }\n  .pressy-home-desc {\n    color: var(--color-text-muted, #666);\n    line-height: 1.6;\n    max-width: 50ch;\n    margin: 0.5rem 0 0;\n  }\n\n  /* ── Stats row ──────────────────────────── */\n  .pressy-stats {\n    display: flex;\n    flex-wrap: wrap;\n    gap: 0.4em;\n    font-size: 0.85rem;\n    color: var(--color-text-muted, #666);\n    margin-top: 1rem;\n  }\n  .pressy-stats-sep {\n    opacity: 0.5;\n  }\n\n  /* ── CTA button ─────────────────────────── */\n  .pressy-cta-group {\n    display: flex;\n    flex-wrap: wrap;\n    gap: 0.75rem;\n    align-items: center;\n  }\n  .pressy-cta {\n    display: inline-block;\n    margin-top: 1.25rem;\n    padding: 0.75rem 1.75rem;\n    background: var(--color-link, #2563eb);\n    color: #fff;\n    font-size: 1rem;\n    font-weight: 600;\n    text-decoration: none;\n    border-radius: 0.5rem;\n    transition: opacity 0.15s;\n  }\n  .pressy-cta:hover {\n    opacity: 0.85;\n  }\n  .pressy-cta-secondary {\n    background: transparent;\n    color: var(--color-link, #2563eb);\n    border: 1.5px solid var(--color-link, #2563eb);\n    cursor: pointer;\n    font-family: inherit;\n  }\n  .pressy-cta-secondary:hover {\n    background: var(--color-link, #2563eb);\n    color: #fff;\n  }\n\n  /* ── Sections below hero ────────────────── */\n  .pressy-fade-sections {\n    animation: pressy-fade-in 0.6s ease-out 0.3s both;\n  }\n  .pressy-home-section {\n    margin-bottom: 2rem;\n  }\n  .pressy-home-section h2 {\n    font-size: 1.25rem;\n    margin-bottom: 1rem;\n    border-bottom: 1px solid var(--color-border, #e5e5e5);\n    padding-bottom: 0.5rem;\n  }\n  .pressy-chapter-list {\n    display: flex;\n    flex-direction: column;\n    gap: 0.25rem;\n  }\n  .pressy-chapter-link {\n    display: flex;\n    gap: 0.75rem;\n    padding: 0.75rem 1rem;\n    text-decoration: none;\n    color: var(--color-text, #1a1a1a);\n    border-radius: 0.5rem;\n    transition: background 0.15s;\n  }\n  .pressy-chapter-link:hover {\n    background: var(--color-bg-subtle, #f5f5f5);\n  }\n  .pressy-chapter-order {\n    color: var(--color-text-muted, #666);\n    min-width: 2ch;\n  }\n\n  /* ── Reduced motion ─────────────────────── */\n  @media (prefers-reduced-motion: reduce) {\n    .pressy-hero-cover,\n    .pressy-hero-text,\n    .pressy-fade-sections {\n      animation: none;\n    }\n  }\n`\n\n// ── Main hydration function ─────────────────────────────────\n\ninterface HydrateData {\n  route: string\n  routeType: string\n  manifest: ContentManifest\n  pagination?: PaginationConfig\n}\n\n// Compute the base path by comparing the known route to the actual URL\n// e.g. URL=\"/pressy/pr-preview/pr-4/books/flatland\" with route=\"/books/flatland\"\n// yields basePath=\"/pressy/pr-preview/pr-4\"\nfunction getBasePath(route: string): string {\n  const pathname = window.location.pathname\n  // Remove trailing slash for comparison\n  const cleanPath = pathname.endsWith('/') ? pathname.slice(0, -1) : pathname\n  const cleanRoute = route.endsWith('/') ? route.slice(0, -1) : route\n  if (cleanRoute === '' || cleanRoute === '/') {\n    // Home page: strip /index.html or trailing slash\n    return cleanPath.replace(/\\/index\\.html$/, '') || ''\n  }\n  const idx = cleanPath.indexOf(cleanRoute)\n  if (idx > 0) {\n    return cleanPath.slice(0, idx)\n  }\n  return ''\n}\n\nlet basePath = ''\n\nexport function hydrate(data: HydrateData, Content?: ComponentType, chapterMapData?: ChapterMapData): void {\n  basePath = getBasePath(data.route)\n  currentRoute.value = data.route\n\n  // Initialize\n  loadTheme()\n  setupOfflineDetection()\n  setupInstallPrompt()\n  initDB()\n\n  // Register service worker for PWA offline support\n  registerServiceWorker(basePath)\n\n  // Handle popstate for back/forward navigation\n  window.addEventListener('popstate', () => {\n    currentRoute.value = window.location.pathname\n  })\n\n  // Handle client-side link clicks\n  // For now, allow normal browser navigation for cross-page links\n  // so each page loads its own HTML with the correct MDX content.\n  // Only intercept hash links for in-page navigation.\n  document.addEventListener('click', (e) => {\n    const link = (e.target as HTMLElement).closest('a')\n    if (!link) return\n\n    const href = link.getAttribute('href')\n    if (!href) return\n\n    // Let external and full-page links navigate normally\n    if (href.startsWith('http') || href.startsWith('#')) return\n\n    // Same-path hash links: handle client-side\n    if (href.startsWith(data.route + '#')) {\n      e.preventDefault()\n      const hash = href.slice(href.indexOf('#'))\n      const target = document.querySelector(hash)\n      if (target) target.scrollIntoView({ behavior: 'smooth' })\n      return\n    }\n\n    // Cross-page links: let the browser navigate normally\n    // (each page is a full server-rendered HTML document)\n  })\n\n  // Render the app\n  let page: VNode\n  switch (data.routeType) {\n    case 'home':\n      page = renderHomePage(data.manifest)\n      break\n    case 'book': {\n      const bookSlug = data.route.split('/')[2]\n      const book = data.manifest.books.find((b: Book) => b.slug === bookSlug)\n      page = book ? renderBookPage(book) : <div>Book not found</div>\n      break\n    }\n    case 'chapter':\n      page = Content\n        ? renderChapterPage(data.manifest, data.route, Content, data.pagination?.defaultMode, chapterMapData)\n        : <div>Loading...</div>\n      break\n    case 'article':\n      page = Content\n        ? renderArticlePage(data.manifest, data.route, Content)\n        : <div>Loading...</div>\n      break\n    case 'books':\n      page = renderHomePage(data.manifest)\n      break\n    case 'articles':\n      page = renderHomePage(data.manifest)\n      break\n    default:\n      page = <div>Page not found</div>\n  }\n\n  render(page, document.getElementById('app')!)\n}\n\n// Export for use in components\nexport { signal, effect }\n","structuredPatch":[{"oldStart":8,"oldLines":6,"newStart":8,"newLines":7,"lines":["   registerServiceWorker,","   downloadBookForOffline,","   clearBookCache,","+  isBookCached,","   cachedBooks,","   cacheProgress,","   installPrompt,"]}],"userModified":false,"replaceAll":false},"sourceToolAssistantUUID":"03211ba2-e2ff-4755-904d-99bc5bb75a2e"}
{"parentUuid":"3a0b794d-f422-46d5-bb9b-f2f437718831","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","message":{"model":"claude-opus-4-6","id":"msg_01SYQH7dFu6f6egzmjBjts8F","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01XSogbFRxDw9hp2aM46QXDy","name":"Edit","input":{"replace_all":false,"file_path":"/Users/blittle/dev/pressy/packages/pressy/src/runtime/client.tsx","old_string":"  // Register service worker for PWA offline support\n  registerServiceWorker(basePath)","new_string":"  // Register service worker for PWA offline support\n  registerServiceWorker(basePath)\n\n  // Auto-download books for offline when the user installs the PWA\n  window.addEventListener('appinstalled', () => {\n    for (const book of data.manifest.books) {\n      if (isBookCached(book.slug)) continue\n      const chapterUrls = book.chapters.map(ch => `${basePath}/books/${book.slug}/${ch.slug}`)\n      downloadBookForOffline(book.slug, chapterUrls)\n    }\n  })"},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":328,"cache_read_input_tokens":39104,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":328},"output_tokens":25,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CYAtV5B7FYSRGoaRGsPi3","type":"assistant","uuid":"d64257b8-62bf-450e-92ae-8a586a1b29e9","timestamp":"2026-02-16T01:34:45.875Z"}
{"parentUuid":"d64257b8-62bf-450e-92ae-8a586a1b29e9","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","type":"progress","data":{"type":"hook_progress","hookEvent":"PostToolUse","hookName":"PostToolUse:Edit","command":"callback"},"parentToolUseID":"toolu_01XSogbFRxDw9hp2aM46QXDy","toolUseID":"toolu_01XSogbFRxDw9hp2aM46QXDy","timestamp":"2026-02-16T01:34:45.884Z","uuid":"8c93eb2c-cb4c-454f-baee-b48c6dfc2e09"}
{"parentUuid":"d64257b8-62bf-450e-92ae-8a586a1b29e9","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01XSogbFRxDw9hp2aM46QXDy","type":"tool_result","content":"The file /Users/blittle/dev/pressy/packages/pressy/src/runtime/client.tsx has been updated successfully."}]},"uuid":"724b3948-43a2-4e32-b7a3-bbda40ccffba","timestamp":"2026-02-16T01:34:45.884Z","toolUseResult":{"filePath":"/Users/blittle/dev/pressy/packages/pressy/src/runtime/client.tsx","oldString":"  // Register service worker for PWA offline support\n  registerServiceWorker(basePath)","newString":"  // Register service worker for PWA offline support\n  registerServiceWorker(basePath)\n\n  // Auto-download books for offline when the user installs the PWA\n  window.addEventListener('appinstalled', () => {\n    for (const book of data.manifest.books) {\n      if (isBookCached(book.slug)) continue\n      const chapterUrls = book.chapters.map(ch => `${basePath}/books/${book.slug}/${ch.slug}`)\n      downloadBookForOffline(book.slug, chapterUrls)\n    }\n  })","originalFile":"import { render, type ComponentType, type VNode } from 'preact'\nimport { useState, useEffect } from 'preact/hooks'\nimport { signal, effect } from '@preact/signals'\nimport { Reader } from '@pressy-pub/components'\nimport type { ProgressData } from '@pressy-pub/components'\nimport { useMDXComponents } from '@pressy-pub/components/content'\nimport {\n  registerServiceWorker,\n  downloadBookForOffline,\n  clearBookCache,\n  isBookCached,\n  cachedBooks,\n  cacheProgress,\n  installPrompt,\n  setupInstallPrompt,\n  triggerInstall,\n} from './offline.js'\nimport type { ContentManifest, Route, Book, Chapter, Article, ReadingProgress, ChapterMapData } from '../types.js'\nimport type { PaginationConfig } from '../config.js'\n\n// State signals\nexport const currentRoute = signal<string>('/')\nexport const currentTheme = signal<'light' | 'dark' | 'sepia' | 'system'>('light')\nexport const isOffline = signal<boolean>(!navigator.onLine)\n\n// IndexedDB for reading progress\nconst DB_NAME = 'pressy'\nconst DB_VERSION = 1\nconst PROGRESS_STORE = 'reading-progress'\nconst UNLOCKS_STORE = 'unlocks'\n\nlet db: IDBDatabase | null = null\n\nasync function initDB(): Promise<IDBDatabase> {\n  if (db) return db\n\n  return new Promise((resolve, reject) => {\n    const request = indexedDB.open(DB_NAME, DB_VERSION)\n\n    request.onerror = () => reject(request.error)\n    request.onsuccess = () => {\n      db = request.result\n      resolve(db)\n    }\n\n    request.onupgradeneeded = (event) => {\n      const database = (event.target as IDBOpenDBRequest).result\n      if (!database.objectStoreNames.contains(PROGRESS_STORE)) {\n        database.createObjectStore(PROGRESS_STORE, { keyPath: 'chapterSlug' })\n      }\n      if (!database.objectStoreNames.contains(UNLOCKS_STORE)) {\n        database.createObjectStore(UNLOCKS_STORE, { keyPath: 'bookSlug' })\n      }\n    }\n  })\n}\n\nexport async function saveReadingProgress(progress: ReadingProgress): Promise<void> {\n  const database = await initDB()\n  return new Promise((resolve, reject) => {\n    const tx = database.transaction(PROGRESS_STORE, 'readwrite')\n    const store = tx.objectStore(PROGRESS_STORE)\n    const request = store.put(progress)\n    request.onsuccess = () => resolve()\n    request.onerror = () => reject(request.error)\n  })\n}\n\nexport async function getReadingProgress(chapterSlug: string): Promise<ReadingProgress | null> {\n  const database = await initDB()\n  return new Promise((resolve, reject) => {\n    const tx = database.transaction(PROGRESS_STORE, 'readonly')\n    const store = tx.objectStore(PROGRESS_STORE)\n    const request = store.get(chapterSlug)\n    request.onsuccess = () => resolve(request.result || null)\n    request.onerror = () => reject(request.error)\n  })\n}\n\nexport async function getAllReadingProgress(): Promise<ReadingProgress[]> {\n  const database = await initDB()\n  return new Promise((resolve, reject) => {\n    const tx = database.transaction(PROGRESS_STORE, 'readonly')\n    const store = tx.objectStore(PROGRESS_STORE)\n    const request = store.getAll()\n    request.onsuccess = () => resolve(request.result || [])\n    request.onerror = () => reject(request.error)\n  })\n}\n\nexport async function isBookUnlocked(bookSlug: string): Promise<boolean> {\n  const database = await initDB()\n  return new Promise((resolve, reject) => {\n    const tx = database.transaction(UNLOCKS_STORE, 'readonly')\n    const store = tx.objectStore(UNLOCKS_STORE)\n    const request = store.get(bookSlug)\n    request.onsuccess = () => resolve(!!request.result)\n    request.onerror = () => reject(request.error)\n  })\n}\n\nexport async function unlockBook(bookSlug: string, orderId?: string): Promise<void> {\n  const database = await initDB()\n  return new Promise((resolve, reject) => {\n    const tx = database.transaction(UNLOCKS_STORE, 'readwrite')\n    const store = tx.objectStore(UNLOCKS_STORE)\n    const request = store.put({ bookSlug, orderId, unlockedAt: Date.now() })\n    request.onsuccess = () => resolve()\n    request.onerror = () => reject(request.error)\n  })\n}\n\n// Client-side router\nexport function navigate(path: string, replace = false): void {\n  if (replace) {\n    history.replaceState(null, '', path)\n  } else {\n    history.pushState(null, '', path)\n  }\n  currentRoute.value = path\n}\n\n// Theme management\nfunction resolveSystemTheme(): 'light' | 'dark' {\n  return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light'\n}\n\nexport function setTheme(theme: 'light' | 'dark' | 'sepia' | 'system'): void {\n  currentTheme.value = theme\n  localStorage.setItem('pressy-theme', theme)\n  const resolved = theme === 'system' ? resolveSystemTheme() : theme\n  document.documentElement.setAttribute('data-theme', resolved)\n}\n\nfunction loadTheme(): void {\n  const saved = localStorage.getItem('pressy-theme') as 'light' | 'dark' | 'sepia' | 'system' | null\n  if (saved) {\n    setTheme(saved)\n  } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {\n    setTheme('dark')\n  }\n\n  // Listen for OS theme changes so \"system\" mode updates live\n  window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', () => {\n    if (currentTheme.value === 'system') {\n      document.documentElement.setAttribute('data-theme', resolveSystemTheme())\n    }\n  })\n}\n\n// Offline detection\nfunction setupOfflineDetection(): void {\n  window.addEventListener('online', () => {\n    isOffline.value = false\n  })\n  window.addEventListener('offline', () => {\n    isOffline.value = true\n  })\n}\n\n// ── Page renderers ──────────────────────────────────────────\n\nfunction StartReadingCTA({ book }: { book: Book }) {\n  const [target, setTarget] = useState<{ label: string; href: string } | null>(null)\n\n  useEffect(() => {\n    if (book.chapters.length === 0) return\n    const firstHref = `${basePath}/books/${book.slug}/${book.chapters[0].slug}`\n\n    getAllReadingProgress().then((allProgress) => {\n      const progressMap = new Map(allProgress.map((p) => [p.chapterSlug, p]))\n\n      // Walk chapters in order and find the furthest one that's in-progress (not completed)\n      let furthestInProgress: Chapter | null = null\n      for (const ch of book.chapters) {\n        const p = progressMap.get(ch.slug)\n        if (!p) continue\n        const completed = p.totalPages > 0 && p.page >= p.totalPages - 1\n        if (!completed && p.page > 0) {\n          furthestInProgress = ch\n        }\n      }\n\n      if (furthestInProgress) {\n        setTarget({\n          label: 'Continue Reading',\n          href: `${basePath}/books/${book.slug}/${furthestInProgress.slug}`,\n        })\n      } else {\n        setTarget({ label: 'Start Reading', href: firstHref })\n      }\n    }).catch(() => {\n      setTarget({ label: 'Start Reading', href: firstHref })\n    })\n  }, [book])\n\n  if (!target) return null\n\n  return (\n    <a href={target.href} class=\"pressy-cta\">\n      {target.label}\n    </a>\n  )\n}\n\nfunction InstallButton() {\n  if (!installPrompt.value) return null\n\n  return (\n    <button\n      class=\"pressy-cta pressy-cta-secondary\"\n      onClick={() => triggerInstall()}\n    >\n      Install\n    </button>\n  )\n}\n\nfunction renderBookPage(book: Book, articles: Article[] = []) {\n  // Stats calculations\n  const totalWords = book.chapters.reduce((sum, ch) => sum + (ch.wordCount || 0), 0)\n  const readingMinutes = Math.ceil(totalWords / 200)\n  const chapterCount = book.chapters.length\n  const publishYear = book.metadata.publishDate\n    ? new Date(book.metadata.publishDate).getFullYear()\n    : null\n\n  const formattedWords = totalWords.toLocaleString()\n\n  return (\n    <div class=\"pressy-home\">\n      <div class=\"pressy-hero\">\n        {book.coverUrl && (\n          <img\n            src={basePath + book.coverUrl}\n            alt={`${book.metadata.title} cover`}\n            class=\"pressy-hero-cover\"\n          />\n        )}\n        <div class=\"pressy-hero-text\">\n          <header class=\"pressy-home-header\">\n            <h1>{book.metadata.title}</h1>\n            <p class=\"pressy-home-author\">by {book.metadata.author}</p>\n            {book.metadata.description && (\n              <p class=\"pressy-home-desc\">{book.metadata.description}</p>\n            )}\n          </header>\n          {totalWords > 0 && (\n            <div class=\"pressy-stats\">\n              <span>{chapterCount} chapter{chapterCount !== 1 ? 's' : ''}</span>\n              <span class=\"pressy-stats-sep\">&middot;</span>\n              <span>{formattedWords} words</span>\n              <span class=\"pressy-stats-sep\">&middot;</span>\n              <span>~{readingMinutes} min</span>\n              {publishYear && (\n                <>\n                  <span class=\"pressy-stats-sep\">&middot;</span>\n                  <span>First published {publishYear}</span>\n                </>\n              )}\n            </div>\n          )}\n          {chapterCount > 0 && (\n            <div class=\"pressy-cta-group\">\n              <StartReadingCTA book={book} />\n              <InstallButton />\n            </div>\n          )}\n        </div>\n      </div>\n      {articles.length > 0 && (\n        <section class=\"pressy-home-section pressy-fade-sections\">\n          <h2>Articles</h2>\n          <nav class=\"pressy-chapter-list\">\n            {articles.map((article: Article) => (\n              <a\n                href={`${basePath}/articles/${article.slug}`}\n                class=\"pressy-chapter-link\"\n              >\n                {article.metadata.title}\n              </a>\n            ))}\n          </nav>\n        </section>\n      )}\n      <style>{HOME_STYLES}</style>\n    </div>\n  )\n}\n\nfunction renderHomePage(manifest: ContentManifest) {\n  // Single-book site: render as the book page\n  if (manifest.books.length === 1) {\n    return renderBookPage(manifest.books[0], manifest.articles)\n  }\n\n  const siteTitle = manifest.books[0]?.metadata.title || 'Library'\n\n  return (\n    <div class=\"pressy-home\">\n      <header class=\"pressy-home-header\">\n        <h1>{siteTitle}</h1>\n        {manifest.books[0]?.metadata.description && (\n          <p class=\"pressy-home-desc\">{manifest.books[0].metadata.description}</p>\n        )}\n      </header>\n      {manifest.books.length > 0 && (\n        <section class=\"pressy-home-section\">\n          <h2>Books</h2>\n          <nav class=\"pressy-chapter-list\">\n            {manifest.books.map((book: Book) => (\n              <a\n                href={`${basePath}/books/${book.slug}`}\n                class=\"pressy-chapter-link\"\n              >\n                {book.metadata.title}\n              </a>\n            ))}\n          </nav>\n        </section>\n      )}\n      {manifest.articles.length > 0 && (\n        <section class=\"pressy-home-section\">\n          <h2>Articles</h2>\n          <nav class=\"pressy-chapter-list\">\n            {manifest.articles.map((article: Article) => (\n              <a\n                href={`${basePath}/articles/${article.slug}`}\n                class=\"pressy-chapter-link\"\n              >\n                {article.metadata.title}\n              </a>\n            ))}\n          </nav>\n        </section>\n      )}\n      <style>{HOME_STYLES}</style>\n    </div>\n  )\n}\n\n// Calculates global book progress % from word counts + saved progress data\nfunction calculateBookProgressPercent(\n  book: Book,\n  currentChapterSlug: string,\n  currentPage: number,\n  currentTotalPages: number,\n  allProgress: ReadingProgress[],\n): number {\n  const totalWords = book.chapters.reduce((sum, ch) => sum + (ch.wordCount || 0), 0)\n  if (totalWords === 0) return 0\n\n  const progressMap = new Map(allProgress.map((p) => [p.chapterSlug, p]))\n  let wordsRead = 0\n\n  for (const ch of book.chapters) {\n    const chapterWords = ch.wordCount || 0\n    if (ch.slug === currentChapterSlug) {\n      // Use live page position for current chapter\n      if (currentTotalPages > 0) {\n        wordsRead += (currentPage / Math.max(1, currentTotalPages - 1)) * chapterWords\n      }\n    } else {\n      const progress = progressMap.get(ch.slug)\n      if (!progress) continue\n      if (progress.totalPages > 0 && progress.page >= progress.totalPages - 1) {\n        wordsRead += chapterWords\n      } else if (progress.page > 0 && progress.totalPages > 0) {\n        wordsRead += (progress.page / progress.totalPages) * chapterWords\n      }\n    }\n  }\n\n  return Math.min(100, (wordsRead / totalWords) * 100)\n}\n\n// Wrapper component that provides progress callbacks and computes global progress\nfunction ChapterReaderWithProgress({\n  book,\n  chapterSlug,\n  chapter,\n  prevChapter,\n  nextChapter,\n  paginationMode,\n  Content,\n  chapterMapData,\n}: {\n  book: Book\n  chapterSlug: string\n  chapter?: Chapter\n  prevChapter?: { slug: string; title: string }\n  nextChapter?: { slug: string; title: string }\n  paginationMode?: 'scroll' | 'paginated'\n  Content: ComponentType<{ components?: Record<string, unknown> }>\n  chapterMapData?: ChapterMapData\n}) {\n  const [bookProgressPercent, setBookProgressPercent] = useState<number | undefined>(undefined)\n\n  // Load initial global book progress\n  useEffect(() => {\n    getAllReadingProgress().then((allProgress) => {\n      const percent = calculateBookProgressPercent(book, chapterSlug, 0, 0, allProgress)\n      setBookProgressPercent(percent)\n    })\n  }, [book, chapterSlug])\n\n  const handleSaveProgress = (data: ProgressData) => {\n    saveReadingProgress({\n      chapterSlug,\n      page: data.page,\n      totalPages: data.totalPages,\n      scrollPosition: data.scrollPosition,\n      timestamp: Date.now(),\n    })\n\n    // Update global book progress with live page position\n    if (data.totalPages > 0) {\n      getAllReadingProgress().then((allProgress) => {\n        const percent = calculateBookProgressPercent(\n          book, chapterSlug, data.page, data.totalPages, allProgress,\n        )\n        setBookProgressPercent(percent)\n      })\n    }\n  }\n\n  const handleRestoreProgress = async (): Promise<ProgressData | null> => {\n    const progress = await getReadingProgress(chapterSlug)\n    if (!progress) return null\n    return {\n      page: progress.page,\n      totalPages: progress.totalPages,\n      scrollPosition: progress.scrollPosition,\n    }\n  }\n\n  const handleChapterChange = (slug: string, page: number, chapterTotalPages: number) => {\n    // Save progress for the chapter being left (mark as complete)\n    saveReadingProgress({\n      chapterSlug: slug,\n      page,\n      totalPages: chapterTotalPages,\n      scrollPosition: 0,\n      timestamp: Date.now(),\n    })\n\n    // Update global book progress\n    getAllReadingProgress().then((allProgress) => {\n      const percent = calculateBookProgressPercent(book, slug, page, chapterTotalPages, allProgress)\n      setBookProgressPercent(percent)\n    })\n  }\n\n  // Prefetch previous chapter HTML for fast backward navigation\n  useEffect(() => {\n    if (prevChapter) {\n      const link = document.createElement('link')\n      link.rel = 'prefetch'\n      link.href = prevChapter.slug\n      document.head.appendChild(link)\n      return () => { document.head.removeChild(link) }\n    }\n  }, [prevChapter])\n\n  return (\n    <Reader\n      title={chapter?.title || chapterSlug}\n      bookTitle={book.metadata.title}\n      chapterSlug={chapterSlug}\n      prevChapter={prevChapter}\n      nextChapter={nextChapter}\n      paginationMode={paginationMode}\n      onSaveProgress={handleSaveProgress}\n      onRestoreProgress={handleRestoreProgress}\n      bookProgressPercent={bookProgressPercent}\n      initialContent={Content}\n      chapterMapData={chapterMapData}\n      currentChapterSlug={chapterSlug}\n      allChapters={book.chapters.map(ch => ({ slug: ch.slug, title: ch.title, wordCount: ch.wordCount }))}\n      bookBasePath={`${basePath}/books/${book.slug}`}\n      onChapterChange={handleChapterChange}\n      mdxComponents={useMDXComponents()}\n      offlineProps={{\n        bookSlug: book.slug,\n        chapterUrls: book.chapters.map(ch => `${basePath}/books/${book.slug}/${ch.slug}`),\n        cachedBooks,\n        cacheProgress,\n        onDownload: downloadBookForOffline,\n        onRemove: clearBookCache,\n      }}\n    >\n      <Content components={useMDXComponents()} />\n    </Reader>\n  )\n}\n\nfunction renderChapterPage(\n  manifest: ContentManifest,\n  route: string,\n  Content: ComponentType,\n  paginationMode?: 'scroll' | 'paginated',\n  chapterMapData?: ChapterMapData,\n) {\n  const parts = route.split('/')\n  const bookSlug = parts[2]\n  const chapterSlug = parts[3]\n  const book = manifest.books.find((b: Book) => b.slug === bookSlug)\n  const chapterIdx = book ? book.chapters.findIndex((c: Chapter) => c.slug === chapterSlug) : -1\n  const chapter = book?.chapters[chapterIdx]\n  const chapterPath = (ch: Chapter) => `${basePath}/books/${bookSlug}/${ch.slug}`\n  const prevChapter = book && chapterIdx > 0\n    ? { slug: chapterPath(book.chapters[chapterIdx - 1]), title: book.chapters[chapterIdx - 1].title }\n    : book\n      ? { slug: `${basePath}/books/${bookSlug}`, title: book.metadata.title }\n      : undefined\n  const nextChapter = book && chapterIdx >= 0 && chapterIdx < book.chapters.length - 1\n    ? { slug: chapterPath(book.chapters[chapterIdx + 1]), title: book.chapters[chapterIdx + 1].title }\n    : book\n      ? { slug: `${basePath}/books/${bookSlug}`, title: book.metadata.title }\n      : undefined\n\n  const MDXContent = Content as ComponentType<{ components?: Record<string, unknown> }>\n\n  if (!book) {\n    return (\n      <Reader\n        title={chapter?.title || chapterSlug}\n        prevChapter={prevChapter}\n        nextChapter={nextChapter}\n        paginationMode={paginationMode}\n      >\n        <MDXContent components={useMDXComponents()} />\n      </Reader>\n    )\n  }\n\n  return (\n    <ChapterReaderWithProgress\n      book={book}\n      chapterSlug={chapterSlug}\n      chapter={chapter}\n      prevChapter={prevChapter}\n      nextChapter={nextChapter}\n      paginationMode={paginationMode}\n      Content={MDXContent}\n      chapterMapData={chapterMapData}\n    />\n  )\n}\n\nfunction renderArticlePage(\n  manifest: ContentManifest,\n  route: string,\n  Content: ComponentType,\n) {\n  const articleSlug = route.split('/')[2]\n  const article = manifest.articles.find((a: Article) => a.slug === articleSlug)\n\n  const MDXContent = Content as ComponentType<{ components?: Record<string, unknown> }>\n\n  return (\n    <Reader title={article?.metadata.title || articleSlug}>\n      <MDXContent components={useMDXComponents()} />\n    </Reader>\n  )\n}\n\n// ── Styles ──────────────────────────────────────────────────\n\nconst HOME_STYLES = `\n  @keyframes pressy-fade-in {\n    from { opacity: 0; transform: translateY(20px); }\n    to   { opacity: 1; transform: translateY(0); }\n  }\n  .pressy-home {\n    max-width: 65ch;\n    margin: 0 auto;\n    padding: 2rem 1.5rem;\n    font-family: var(--font-body, Georgia, 'Times New Roman', serif);\n    color: var(--color-text, #1a1a1a);\n  }\n\n  /* ── Hero layout ────────────────────────── */\n  .pressy-hero {\n    display: flex;\n    align-items: flex-start;\n    gap: 2.5rem;\n    margin-bottom: 2.5rem;\n  }\n  .pressy-hero-cover {\n    flex-shrink: 0;\n    max-width: 280px;\n    width: 100%;\n    height: auto;\n    border-radius: 4px;\n    box-shadow: 0 4px 24px rgba(0,0,0,0.15);\n    animation: pressy-fade-in 0.6s ease-out both;\n  }\n  .pressy-hero-text {\n    flex: 1;\n    animation: pressy-fade-in 0.6s ease-out 0.15s both;\n  }\n  @media (max-width: 700px) {\n    .pressy-hero {\n      flex-direction: column;\n      align-items: center;\n    }\n    .pressy-hero-cover {\n      max-width: 220px;\n    }\n    .pressy-hero-text {\n      text-align: center;\n    }\n    .pressy-home-desc {\n      margin-left: auto;\n      margin-right: auto;\n    }\n    .pressy-stats {\n      justify-content: center;\n    }\n  }\n\n  /* ── Header ─────────────────────────────── */\n  .pressy-home-header {\n    margin-bottom: 1rem;\n  }\n  .pressy-home-header h1 {\n    font-size: 2rem;\n    margin-bottom: 0.5rem;\n  }\n  .pressy-home-author {\n    font-style: italic;\n    color: var(--color-text-muted, #666);\n  }\n  .pressy-home-desc {\n    color: var(--color-text-muted, #666);\n    line-height: 1.6;\n    max-width: 50ch;\n    margin: 0.5rem 0 0;\n  }\n\n  /* ── Stats row ──────────────────────────── */\n  .pressy-stats {\n    display: flex;\n    flex-wrap: wrap;\n    gap: 0.4em;\n    font-size: 0.85rem;\n    color: var(--color-text-muted, #666);\n    margin-top: 1rem;\n  }\n  .pressy-stats-sep {\n    opacity: 0.5;\n  }\n\n  /* ── CTA button ─────────────────────────── */\n  .pressy-cta-group {\n    display: flex;\n    flex-wrap: wrap;\n    gap: 0.75rem;\n    align-items: center;\n  }\n  .pressy-cta {\n    display: inline-block;\n    margin-top: 1.25rem;\n    padding: 0.75rem 1.75rem;\n    background: var(--color-link, #2563eb);\n    color: #fff;\n    font-size: 1rem;\n    font-weight: 600;\n    text-decoration: none;\n    border-radius: 0.5rem;\n    transition: opacity 0.15s;\n  }\n  .pressy-cta:hover {\n    opacity: 0.85;\n  }\n  .pressy-cta-secondary {\n    background: transparent;\n    color: var(--color-link, #2563eb);\n    border: 1.5px solid var(--color-link, #2563eb);\n    cursor: pointer;\n    font-family: inherit;\n  }\n  .pressy-cta-secondary:hover {\n    background: var(--color-link, #2563eb);\n    color: #fff;\n  }\n\n  /* ── Sections below hero ────────────────── */\n  .pressy-fade-sections {\n    animation: pressy-fade-in 0.6s ease-out 0.3s both;\n  }\n  .pressy-home-section {\n    margin-bottom: 2rem;\n  }\n  .pressy-home-section h2 {\n    font-size: 1.25rem;\n    margin-bottom: 1rem;\n    border-bottom: 1px solid var(--color-border, #e5e5e5);\n    padding-bottom: 0.5rem;\n  }\n  .pressy-chapter-list {\n    display: flex;\n    flex-direction: column;\n    gap: 0.25rem;\n  }\n  .pressy-chapter-link {\n    display: flex;\n    gap: 0.75rem;\n    padding: 0.75rem 1rem;\n    text-decoration: none;\n    color: var(--color-text, #1a1a1a);\n    border-radius: 0.5rem;\n    transition: background 0.15s;\n  }\n  .pressy-chapter-link:hover {\n    background: var(--color-bg-subtle, #f5f5f5);\n  }\n  .pressy-chapter-order {\n    color: var(--color-text-muted, #666);\n    min-width: 2ch;\n  }\n\n  /* ── Reduced motion ─────────────────────── */\n  @media (prefers-reduced-motion: reduce) {\n    .pressy-hero-cover,\n    .pressy-hero-text,\n    .pressy-fade-sections {\n      animation: none;\n    }\n  }\n`\n\n// ── Main hydration function ─────────────────────────────────\n\ninterface HydrateData {\n  route: string\n  routeType: string\n  manifest: ContentManifest\n  pagination?: PaginationConfig\n}\n\n// Compute the base path by comparing the known route to the actual URL\n// e.g. URL=\"/pressy/pr-preview/pr-4/books/flatland\" with route=\"/books/flatland\"\n// yields basePath=\"/pressy/pr-preview/pr-4\"\nfunction getBasePath(route: string): string {\n  const pathname = window.location.pathname\n  // Remove trailing slash for comparison\n  const cleanPath = pathname.endsWith('/') ? pathname.slice(0, -1) : pathname\n  const cleanRoute = route.endsWith('/') ? route.slice(0, -1) : route\n  if (cleanRoute === '' || cleanRoute === '/') {\n    // Home page: strip /index.html or trailing slash\n    return cleanPath.replace(/\\/index\\.html$/, '') || ''\n  }\n  const idx = cleanPath.indexOf(cleanRoute)\n  if (idx > 0) {\n    return cleanPath.slice(0, idx)\n  }\n  return ''\n}\n\nlet basePath = ''\n\nexport function hydrate(data: HydrateData, Content?: ComponentType, chapterMapData?: ChapterMapData): void {\n  basePath = getBasePath(data.route)\n  currentRoute.value = data.route\n\n  // Initialize\n  loadTheme()\n  setupOfflineDetection()\n  setupInstallPrompt()\n  initDB()\n\n  // Register service worker for PWA offline support\n  registerServiceWorker(basePath)\n\n  // Handle popstate for back/forward navigation\n  window.addEventListener('popstate', () => {\n    currentRoute.value = window.location.pathname\n  })\n\n  // Handle client-side link clicks\n  // For now, allow normal browser navigation for cross-page links\n  // so each page loads its own HTML with the correct MDX content.\n  // Only intercept hash links for in-page navigation.\n  document.addEventListener('click', (e) => {\n    const link = (e.target as HTMLElement).closest('a')\n    if (!link) return\n\n    const href = link.getAttribute('href')\n    if (!href) return\n\n    // Let external and full-page links navigate normally\n    if (href.startsWith('http') || href.startsWith('#')) return\n\n    // Same-path hash links: handle client-side\n    if (href.startsWith(data.route + '#')) {\n      e.preventDefault()\n      const hash = href.slice(href.indexOf('#'))\n      const target = document.querySelector(hash)\n      if (target) target.scrollIntoView({ behavior: 'smooth' })\n      return\n    }\n\n    // Cross-page links: let the browser navigate normally\n    // (each page is a full server-rendered HTML document)\n  })\n\n  // Render the app\n  let page: VNode\n  switch (data.routeType) {\n    case 'home':\n      page = renderHomePage(data.manifest)\n      break\n    case 'book': {\n      const bookSlug = data.route.split('/')[2]\n      const book = data.manifest.books.find((b: Book) => b.slug === bookSlug)\n      page = book ? renderBookPage(book) : <div>Book not found</div>\n      break\n    }\n    case 'chapter':\n      page = Content\n        ? renderChapterPage(data.manifest, data.route, Content, data.pagination?.defaultMode, chapterMapData)\n        : <div>Loading...</div>\n      break\n    case 'article':\n      page = Content\n        ? renderArticlePage(data.manifest, data.route, Content)\n        : <div>Loading...</div>\n      break\n    case 'books':\n      page = renderHomePage(data.manifest)\n      break\n    case 'articles':\n      page = renderHomePage(data.manifest)\n      break\n    default:\n      page = <div>Page not found</div>\n  }\n\n  render(page, document.getElementById('app')!)\n}\n\n// Export for use in components\nexport { signal, effect }\n","structuredPatch":[{"oldStart":774,"oldLines":6,"newStart":774,"newLines":15,"lines":["   // Register service worker for PWA offline support","   registerServiceWorker(basePath)"," ","+  // Auto-download books for offline when the user installs the PWA","+  window.addEventListener('appinstalled', () => {","+    for (const book of data.manifest.books) {","+      if (isBookCached(book.slug)) continue","+      const chapterUrls = book.chapters.map(ch => `${basePath}/books/${book.slug}/${ch.slug}`)","+      downloadBookForOffline(book.slug, chapterUrls)","+    }","+  })","+","   // Handle popstate for back/forward navigation","   window.addEventListener('popstate', () => {","     currentRoute.value = window.location.pathname"]}],"userModified":false,"replaceAll":false},"sourceToolAssistantUUID":"d64257b8-62bf-450e-92ae-8a586a1b29e9"}
{"parentUuid":"724b3948-43a2-4e32-b7a3-bbda40ccffba","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","message":{"model":"claude-opus-4-6","id":"msg_01RzcMgJxKzQHpAcr1ivf68h","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01TTHz2ELCLLiHFovia6CsxD","name":"Bash","input":{"command":"pnpm --filter pressy build 2>&1","description":"Build pressy package to verify no errors","timeout":60000},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":326,"cache_read_input_tokens":39432,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":326},"output_tokens":26,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CYAtVQcQMxyVFPhrWRJjN","type":"assistant","uuid":"b1a5c0c1-584e-457f-bb56-769bd76af0d7","timestamp":"2026-02-16T01:34:49.411Z"}
{"parentUuid":"b1a5c0c1-584e-457f-bb56-769bd76af0d7","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","type":"progress","data":{"type":"bash_progress","output":"ESM dist/vite/plugin.js.map     52.96 KB\nESM dist/runtime/offline.js.map 10.20 KB\nESM dist/runtime/sw.js.map      8.29 KB\nESM ⚡️ Build success in 16ms\nDTS Build start","fullOutput":"> pressy@0.1.1 build /Users/blittle/dev/pressy/packages/pressy\n> tsup\nCLI Building entry: {\"index\":\"src/index.ts\",\"cli/index\":\"src/cli/index.ts\",\"vite/plugin\":\"src/vite/plugin.ts\",\"runtime/client\":\"src/runtime/client.tsx\",\"runtime/offline\":\"src/runtime/offline.ts\",\"runtime/sw\":\"src/runtime/sw.ts\"}\nCLI Using tsconfig: tsconfig.json\nCLI tsup v8.5.1\nCLI Using tsup config: /Users/blittle/dev/pressy/packages/pressy/tsup.config.ts\nCLI Target: node18\nCLI Cleaning output folder\nESM Build start\nESM dist/cli/index.js           32.92 KB\nESM dist/index.js               30.25 KB\nESM dist/runtime/client.js      28.38 KB\nESM dist/vite/plugin.js         29.94 KB\nESM dist/runtime/offline.js     5.52 KB\nESM dist/runtime/sw.js          4.09 KB\nESM dist/cli/index.js.map       58.66 KB\nESM dist/runtime/client.js.map  48.96 KB\nESM dist/index.js.map           54.88 KB\nESM dist/vite/plugin.js.map     52.96 KB\nESM dist/runtime/offline.js.map 10.20 KB\nESM dist/runtime/sw.js.map      8.29 KB\nESM ⚡️ Build success in 16ms\nDTS Build start","elapsedTimeSeconds":2,"totalLines":23,"timeoutMs":60000},"toolUseID":"bash-progress-0","parentToolUseID":"toolu_01TTHz2ELCLLiHFovia6CsxD","uuid":"4046ad9e-619d-4903-a6ff-9aca89434f37","timestamp":"2026-02-16T01:34:51.420Z"}
{"parentUuid":"4046ad9e-619d-4903-a6ff-9aca89434f37","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","type":"progress","data":{"type":"bash_progress","output":"ESM dist/vite/plugin.js.map     52.96 KB\nESM dist/runtime/offline.js.map 10.20 KB\nESM dist/runtime/sw.js.map      8.29 KB\nESM ⚡️ Build success in 16ms\nDTS Build start","fullOutput":"> pressy@0.1.1 build /Users/blittle/dev/pressy/packages/pressy\n> tsup\nCLI Building entry: {\"index\":\"src/index.ts\",\"cli/index\":\"src/cli/index.ts\",\"vite/plugin\":\"src/vite/plugin.ts\",\"runtime/client\":\"src/runtime/client.tsx\",\"runtime/offline\":\"src/runtime/offline.ts\",\"runtime/sw\":\"src/runtime/sw.ts\"}\nCLI Using tsconfig: tsconfig.json\nCLI tsup v8.5.1\nCLI Using tsup config: /Users/blittle/dev/pressy/packages/pressy/tsup.config.ts\nCLI Target: node18\nCLI Cleaning output folder\nESM Build start\nESM dist/cli/index.js           32.92 KB\nESM dist/index.js               30.25 KB\nESM dist/runtime/client.js      28.38 KB\nESM dist/vite/plugin.js         29.94 KB\nESM dist/runtime/offline.js     5.52 KB\nESM dist/runtime/sw.js          4.09 KB\nESM dist/cli/index.js.map       58.66 KB\nESM dist/runtime/client.js.map  48.96 KB\nESM dist/index.js.map           54.88 KB\nESM dist/vite/plugin.js.map     52.96 KB\nESM dist/runtime/offline.js.map 10.20 KB\nESM dist/runtime/sw.js.map      8.29 KB\nESM ⚡️ Build success in 16ms\nDTS Build start","elapsedTimeSeconds":3,"totalLines":23,"timeoutMs":60000},"toolUseID":"bash-progress-1","parentToolUseID":"toolu_01TTHz2ELCLLiHFovia6CsxD","uuid":"baba5d5a-ec10-46a8-9cb5-411f2fcba08b","timestamp":"2026-02-16T01:34:52.422Z"}
{"parentUuid":"b1a5c0c1-584e-457f-bb56-769bd76af0d7","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01TTHz2ELCLLiHFovia6CsxD","type":"tool_result","content":"> pressy@0.1.1 build /Users/blittle/dev/pressy/packages/pressy\n> tsup\n\nCLI Building entry: {\"index\":\"src/index.ts\",\"cli/index\":\"src/cli/index.ts\",\"vite/plugin\":\"src/vite/plugin.ts\",\"runtime/client\":\"src/runtime/client.tsx\",\"runtime/offline\":\"src/runtime/offline.ts\",\"runtime/sw\":\"src/runtime/sw.ts\"}\nCLI Using tsconfig: tsconfig.json\nCLI tsup v8.5.1\nCLI Using tsup config: /Users/blittle/dev/pressy/packages/pressy/tsup.config.ts\nCLI Target: node18\nCLI Cleaning output folder\nESM Build start\nESM dist/cli/index.js           32.92 KB\nESM dist/index.js               30.25 KB\nESM dist/runtime/client.js      28.38 KB\nESM dist/vite/plugin.js         29.94 KB\nESM dist/runtime/offline.js     5.52 KB\nESM dist/runtime/sw.js          4.09 KB\nESM dist/cli/index.js.map       58.66 KB\nESM dist/runtime/client.js.map  48.96 KB\nESM dist/index.js.map           54.88 KB\nESM dist/vite/plugin.js.map     52.96 KB\nESM dist/runtime/offline.js.map 10.20 KB\nESM dist/runtime/sw.js.map      8.29 KB\nESM ⚡️ Build success in 16ms\nDTS Build start\nDTS ⚡️ Build success in 2132ms\nDTS dist/index.d.ts           329.00 B\nDTS dist/cli/index.d.ts       20.00 B\nDTS dist/vite/plugin.d.ts     180.00 B\nDTS dist/runtime/client.d.ts  1.43 KB\nDTS dist/runtime/offline.d.ts 1.12 KB\nDTS dist/runtime/sw.d.ts      13.00 B\nDTS dist/types-DtFj4lcD.d.ts  1.62 KB\nDTS dist/config-M8fI46fg.d.ts 1.56 KB","is_error":false}]},"uuid":"bd439745-09df-4ca5-810c-f2d105b742a0","timestamp":"2026-02-16T01:34:52.773Z","toolUseResult":{"stdout":"> pressy@0.1.1 build /Users/blittle/dev/pressy/packages/pressy\n> tsup\n\nCLI Building entry: {\"index\":\"src/index.ts\",\"cli/index\":\"src/cli/index.ts\",\"vite/plugin\":\"src/vite/plugin.ts\",\"runtime/client\":\"src/runtime/client.tsx\",\"runtime/offline\":\"src/runtime/offline.ts\",\"runtime/sw\":\"src/runtime/sw.ts\"}\nCLI Using tsconfig: tsconfig.json\nCLI tsup v8.5.1\nCLI Using tsup config: /Users/blittle/dev/pressy/packages/pressy/tsup.config.ts\nCLI Target: node18\nCLI Cleaning output folder\nESM Build start\nESM dist/cli/index.js           32.92 KB\nESM dist/index.js               30.25 KB\nESM dist/runtime/client.js      28.38 KB\nESM dist/vite/plugin.js         29.94 KB\nESM dist/runtime/offline.js     5.52 KB\nESM dist/runtime/sw.js          4.09 KB\nESM dist/cli/index.js.map       58.66 KB\nESM dist/runtime/client.js.map  48.96 KB\nESM dist/index.js.map           54.88 KB\nESM dist/vite/plugin.js.map     52.96 KB\nESM dist/runtime/offline.js.map 10.20 KB\nESM dist/runtime/sw.js.map      8.29 KB\nESM ⚡️ Build success in 16ms\nDTS Build start\nDTS ⚡️ Build success in 2132ms\nDTS dist/index.d.ts           329.00 B\nDTS dist/cli/index.d.ts       20.00 B\nDTS dist/vite/plugin.d.ts     180.00 B\nDTS dist/runtime/client.d.ts  1.43 KB\nDTS dist/runtime/offline.d.ts 1.12 KB\nDTS dist/runtime/sw.d.ts      13.00 B\nDTS dist/types-DtFj4lcD.d.ts  1.62 KB\nDTS dist/config-M8fI46fg.d.ts 1.56 KB","stderr":"","interrupted":false,"isImage":false,"noOutputExpected":false},"sourceToolAssistantUUID":"b1a5c0c1-584e-457f-bb56-769bd76af0d7"}
{"parentUuid":"bd439745-09df-4ca5-810c-f2d105b742a0","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","message":{"model":"claude-opus-4-6","id":"msg_01X4JzugRNJ1LWYATU1cEPxt","type":"message","role":"assistant","content":[{"type":"text","text":"Build passes. I added an `appinstalled` event listener in `hydrate()` that loops over all books in the manifest and calls `downloadBookForOffline()` for any that aren't already cached. So when a user clicks \"Install\" and completes the PWA install, all book chapters get automatically cached for offline reading — no need to separately tap the download icon in the footer."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":682,"cache_read_input_tokens":39758,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":682},"output_tokens":1,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CYAtVv4wv9m4HjY4cd88a","type":"assistant","uuid":"f58bc2fd-8501-48ae-a521-12fa82c8d602","timestamp":"2026-02-16T01:34:57.176Z"}
{"parentUuid":"f58bc2fd-8501-48ae-a521-12fa82c8d602","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","type":"progress","data":{"type":"hook_progress","hookEvent":"Stop","hookName":"Stop","command":"entire hooks claude-code stop"},"parentToolUseID":"fe1fd188-28af-4b42-bd8f-9568587a4a1b","toolUseID":"fe1fd188-28af-4b42-bd8f-9568587a4a1b","timestamp":"2026-02-16T01:34:57.207Z","uuid":"657039bb-6cf1-4086-b617-3623c1005afb"}
{"parentUuid":"657039bb-6cf1-4086-b617-3623c1005afb","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","type":"system","subtype":"stop_hook_summary","hookCount":1,"hookInfos":[{"command":"entire hooks claude-code stop"}],"hookErrors":[],"preventedContinuation":false,"stopReason":"","hasOutput":true,"level":"suggestion","timestamp":"2026-02-16T01:34:57.817Z","uuid":"bbdad588-e20a-450b-8c1e-d6110d46d780","toolUseID":"fe1fd188-28af-4b42-bd8f-9568587a4a1b"}
{"parentUuid":"bbdad588-e20a-450b-8c1e-d6110d46d780","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","type":"system","subtype":"turn_duration","durationMs":41513,"timestamp":"2026-02-16T01:34:57.820Z","uuid":"2caf6770-98aa-4fd6-b055-7008746067c1","isMeta":false}
{"type":"file-history-snapshot","messageId":"347f8dcf-cf87-4e89-8aac-12672170d553","snapshot":{"messageId":"347f8dcf-cf87-4e89-8aac-12672170d553","trackedFileBackups":{"packages/pressy/src/runtime/offline.ts":{"backupFileName":"259b478c67f372e9@v2","version":2,"backupTime":"2026-02-16T01:34:16.305Z"},"packages/pressy/src/runtime/client.tsx":{"backupFileName":"553e6fae6ff514b2@v3","version":3,"backupTime":"2026-02-16T01:39:32.392Z"}},"timestamp":"2026-02-16T01:39:32.392Z"},"isSnapshotUpdate":false}
{"parentUuid":"2caf6770-98aa-4fd6-b055-7008746067c1","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","type":"user","message":{"role":"user","content":"Could we add to the top of the table of contents a link to the home page?"},"uuid":"347f8dcf-cf87-4e89-8aac-12672170d553","timestamp":"2026-02-16T01:39:31.775Z","thinkingMetadata":{"maxThinkingTokens":31999},"permissionMode":"acceptEdits"}
{"parentUuid":"347f8dcf-cf87-4e89-8aac-12672170d553","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","message":{"model":"claude-opus-4-6","id":"msg_018iocFo38YM2c5KMWjvzVkS","type":"message","role":"assistant","content":[{"type":"text","text":"\n\n"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":21,"cache_read_input_tokens":40524,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":21},"output_tokens":14,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CYAtrY3DXAFFxMcYo5Lwt","type":"assistant","uuid":"b2bb1454-41a5-4642-bcc7-4c8dd58995b9","timestamp":"2026-02-16T01:39:34.401Z"}
{"parentUuid":"b2bb1454-41a5-4642-bcc7-4c8dd58995b9","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","message":{"model":"claude-opus-4-6","id":"msg_018iocFo38YM2c5KMWjvzVkS","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"The user wants to add a link to the home page at the top of the table of contents. Let me find the table of contents component.","signature":"EqgCCkYICxgCKkAwvGGIguVKnBdlZSCrA3UiS25vHFUvSsdnFZH4s7pQpJjDvVDNb5ATMFNQiQins9eJFr/GTHIxDu35Ghd2bYcAEgzItIzjTXvcfWizRKUaDDUu3hGof+awAVrMOyIwIb0jwX5Kd5nsrR7p3m7EGnI/1csANU6ikkBgQHpEK2gKXFtmJ0xo00lfO9FZLy3OKo8BTJVyBalrTLgZaJbpSBQrek1N82V200urVW51s4F/gkYMU93y4jrvmFPvt+oPFjoeS3VIaRVptEIYeD48CDgKf4yib9/GRvQe8U8EF6sjrhqb85DVOTPJwmnxS1esxP9VNU0AKUOHq4B2L6qN4RpkSAHEuEkvt1acsWasbKM2nvft1HMC9yaZHE/M+Qehq9wYAQ=="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":21,"cache_read_input_tokens":40524,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":21},"output_tokens":14,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CYAtrY3DXAFFxMcYo5Lwt","type":"assistant","uuid":"afc2b9e6-c2ce-4035-a041-ee8c8b063471","timestamp":"2026-02-16T01:39:34.783Z"}
{"parentUuid":"afc2b9e6-c2ce-4035-a041-ee8c8b063471","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","message":{"model":"claude-opus-4-6","id":"msg_018iocFo38YM2c5KMWjvzVkS","type":"message","role":"assistant","content":[{"type":"text","text":"Let me find the table of contents component."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":21,"cache_read_input_tokens":40524,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":21},"output_tokens":14,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CYAtrY3DXAFFxMcYo5Lwt","type":"assistant","uuid":"4ae0c514-613a-43dc-bbb8-bb5f0ce3eb44","timestamp":"2026-02-16T01:39:35.276Z"}
{"parentUuid":"4ae0c514-613a-43dc-bbb8-bb5f0ce3eb44","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","message":{"model":"claude-opus-4-6","id":"msg_018iocFo38YM2c5KMWjvzVkS","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_0148Yq4mgK6PAXeLHpmymh7D","name":"Grep","input":{"pattern":"table.of.contents|TableOfContents|toc","glob":"**/*.{tsx,ts}","output_mode":"files_with_matches","-i":true},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":21,"cache_read_input_tokens":40524,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":21},"output_tokens":14,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CYAtrY3DXAFFxMcYo5Lwt","type":"assistant","uuid":"d2dd7843-67f6-495f-a003-868e26a1b50a","timestamp":"2026-02-16T01:39:36.724Z"}
{"parentUuid":"d2dd7843-67f6-495f-a003-868e26a1b50a","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","type":"progress","data":{"type":"hook_progress","hookEvent":"PostToolUse","hookName":"PostToolUse:Grep","command":"callback"},"parentToolUseID":"toolu_0148Yq4mgK6PAXeLHpmymh7D","toolUseID":"toolu_0148Yq4mgK6PAXeLHpmymh7D","timestamp":"2026-02-16T01:39:37.041Z","uuid":"86aecc73-7768-4a96-b362-fc6626ac7347"}
{"parentUuid":"d2dd7843-67f6-495f-a003-868e26a1b50a","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_0148Yq4mgK6PAXeLHpmymh7D","type":"tool_result","content":"Found 5 files\npackages/@pressy/components/dist/index.d.ts\npackages/@pressy/components/src/Reader.tsx\npackages/@pressy/components/src/index.ts\npackages/pressy/src/mdx/processor.ts\npackages/@pressy/components/src/TableOfContents.tsx"}]},"uuid":"366a972f-fffb-4427-8d5f-638114a9db5f","timestamp":"2026-02-16T01:39:37.040Z","toolUseResult":{"mode":"files_with_matches","filenames":["packages/@pressy/components/dist/index.d.ts","packages/@pressy/components/src/Reader.tsx","packages/@pressy/components/src/index.ts","packages/pressy/src/mdx/processor.ts","packages/@pressy/components/src/TableOfContents.tsx"],"numFiles":5},"sourceToolAssistantUUID":"d2dd7843-67f6-495f-a003-868e26a1b50a"}
{"parentUuid":"366a972f-fffb-4427-8d5f-638114a9db5f","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","message":{"model":"claude-opus-4-6","id":"msg_016eD5DayCBKVMEaZtEW3fPL","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01QArKmDpxLGMbtbfff8X2ee","name":"Read","input":{"file_path":"/Users/blittle/dev/pressy/packages/@pressy/components/src/TableOfContents.tsx"},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":273,"cache_read_input_tokens":40545,"output_tokens":79,"server_tool_use":{"web_search_requests":0,"web_fetch_requests":0},"service_tier":"standard","cache_creation":{"ephemeral_1h_input_tokens":273,"ephemeral_5m_input_tokens":0},"inference_geo":"","iterations":[],"speed":"standard"}},"requestId":"req_011CYAtrsmNhq4XzwdXSVZK7","type":"assistant","uuid":"0a0e799a-776f-43ee-aa11-c913740f091c","timestamp":"2026-02-16T01:39:39.168Z"}
{"parentUuid":"0a0e799a-776f-43ee-aa11-c913740f091c","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","type":"progress","data":{"type":"hook_progress","hookEvent":"PostToolUse","hookName":"PostToolUse:Read","command":"callback"},"parentToolUseID":"toolu_01QArKmDpxLGMbtbfff8X2ee","toolUseID":"toolu_01QArKmDpxLGMbtbfff8X2ee","timestamp":"2026-02-16T01:39:39.209Z","uuid":"371e63fb-03c3-4aa5-be39-ff4ad4304b76"}
{"parentUuid":"0a0e799a-776f-43ee-aa11-c913740f091c","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01QArKmDpxLGMbtbfff8X2ee","type":"tool_result","content":"     1→export interface TOCItem {\n     2→  level: number\n     3→  text: string\n     4→  slug: string\n     5→}\n     6→\n     7→export interface TableOfContentsProps {\n     8→  items: TOCItem[]\n     9→  onNavigate?: () => void\n    10→  activeSlug?: string\n    11→}\n    12→\n    13→export function TableOfContents({ items, onNavigate, activeSlug }: TableOfContentsProps) {\n    14→  const handleClick = (slug: string) => {\n    15→    // Scroll to heading\n    16→    const element = document.getElementById(slug)\n    17→    if (element) {\n    18→      element.scrollIntoView({ behavior: 'smooth' })\n    19→    }\n    20→    onNavigate?.()\n    21→  }\n    22→\n    23→  return (\n    24→    <nav class=\"pressy-toc\" aria-label=\"Table of contents\">\n    25→      <h2 class=\"pressy-toc-title\">Contents</h2>\n    26→      <ul class=\"pressy-toc-list\">\n    27→        {items.map((item) => (\n    28→          <li\n    29→            key={item.slug}\n    30→            class={`pressy-toc-item pressy-toc-level-${item.level}`}\n    31→            data-active={activeSlug === item.slug}\n    32→          >\n    33→            <a\n    34→              href={`#${item.slug}`}\n    35→              onClick={(e) => {\n    36→                e.preventDefault()\n    37→                handleClick(item.slug)\n    38→              }}\n    39→              class=\"pressy-toc-link\"\n    40→            >\n    41→              {item.text}\n    42→            </a>\n    43→          </li>\n    44→        ))}\n    45→      </ul>\n    46→\n    47→      <style>{`\n    48→        .pressy-toc {\n    49→          font-size: var(--font-size-sm);\n    50→        }\n    51→\n    52→        .pressy-toc-title {\n    53→          font-size: var(--font-size-base);\n    54→          font-weight: 600;\n    55→          margin-bottom: 1rem;\n    56→          color: var(--color-heading);\n    57→        }\n    58→\n    59→        .pressy-toc-list {\n    60→          list-style: none;\n    61→          padding: 0;\n    62→          margin: 0;\n    63→        }\n    64→\n    65→        .pressy-toc-item {\n    66→          margin-bottom: 0.5rem;\n    67→        }\n    68→\n    69→        .pressy-toc-level-1 {\n    70→          padding-left: 0;\n    71→        }\n    72→\n    73→        .pressy-toc-level-2 {\n    74→          padding-left: 1rem;\n    75→        }\n    76→\n    77→        .pressy-toc-level-3 {\n    78→          padding-left: 2rem;\n    79→        }\n    80→\n    81→        .pressy-toc-level-4 {\n    82→          padding-left: 3rem;\n    83→        }\n    84→\n    85→        .pressy-toc-link {\n    86→          color: var(--color-text-muted);\n    87→          text-decoration: none;\n    88→          transition: color 0.15s;\n    89→          display: block;\n    90→          padding: 0.25rem 0;\n    91→        }\n    92→\n    93→        .pressy-toc-link:hover {\n    94→          color: var(--color-text);\n    95→        }\n    96→\n    97→        .pressy-toc-item[data-active=\"true\"] .pressy-toc-link {\n    98→          color: var(--color-accent);\n    99→          font-weight: 500;\n   100→        }\n   101→      `}</style>\n   102→    </nav>\n   103→  )\n   104→}\n   105→"}]},"uuid":"9156234e-c1b5-4fdb-8e1e-5f5e502d959e","timestamp":"2026-02-16T01:39:39.208Z","toolUseResult":{"type":"text","file":{"filePath":"/Users/blittle/dev/pressy/packages/@pressy/components/src/TableOfContents.tsx","content":"export interface TOCItem {\n  level: number\n  text: string\n  slug: string\n}\n\nexport interface TableOfContentsProps {\n  items: TOCItem[]\n  onNavigate?: () => void\n  activeSlug?: string\n}\n\nexport function TableOfContents({ items, onNavigate, activeSlug }: TableOfContentsProps) {\n  const handleClick = (slug: string) => {\n    // Scroll to heading\n    const element = document.getElementById(slug)\n    if (element) {\n      element.scrollIntoView({ behavior: 'smooth' })\n    }\n    onNavigate?.()\n  }\n\n  return (\n    <nav class=\"pressy-toc\" aria-label=\"Table of contents\">\n      <h2 class=\"pressy-toc-title\">Contents</h2>\n      <ul class=\"pressy-toc-list\">\n        {items.map((item) => (\n          <li\n            key={item.slug}\n            class={`pressy-toc-item pressy-toc-level-${item.level}`}\n            data-active={activeSlug === item.slug}\n          >\n            <a\n              href={`#${item.slug}`}\n              onClick={(e) => {\n                e.preventDefault()\n                handleClick(item.slug)\n              }}\n              class=\"pressy-toc-link\"\n            >\n              {item.text}\n            </a>\n          </li>\n        ))}\n      </ul>\n\n      <style>{`\n        .pressy-toc {\n          font-size: var(--font-size-sm);\n        }\n\n        .pressy-toc-title {\n          font-size: var(--font-size-base);\n          font-weight: 600;\n          margin-bottom: 1rem;\n          color: var(--color-heading);\n        }\n\n        .pressy-toc-list {\n          list-style: none;\n          padding: 0;\n          margin: 0;\n        }\n\n        .pressy-toc-item {\n          margin-bottom: 0.5rem;\n        }\n\n        .pressy-toc-level-1 {\n          padding-left: 0;\n        }\n\n        .pressy-toc-level-2 {\n          padding-left: 1rem;\n        }\n\n        .pressy-toc-level-3 {\n          padding-left: 2rem;\n        }\n\n        .pressy-toc-level-4 {\n          padding-left: 3rem;\n        }\n\n        .pressy-toc-link {\n          color: var(--color-text-muted);\n          text-decoration: none;\n          transition: color 0.15s;\n          display: block;\n          padding: 0.25rem 0;\n        }\n\n        .pressy-toc-link:hover {\n          color: var(--color-text);\n        }\n\n        .pressy-toc-item[data-active=\"true\"] .pressy-toc-link {\n          color: var(--color-accent);\n          font-weight: 500;\n        }\n      `}</style>\n    </nav>\n  )\n}\n","numLines":105,"startLine":1,"totalLines":105}},"sourceToolAssistantUUID":"0a0e799a-776f-43ee-aa11-c913740f091c"}
{"parentUuid":"9156234e-c1b5-4fdb-8e1e-5f5e502d959e","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","message":{"model":"claude-opus-4-6","id":"msg_0186W6zT77LvXkRJDmUD3dCs","type":"message","role":"assistant","content":[{"type":"text","text":"Now let me check how this component is used in Reader to understand what props are available for constructing the home link."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":1307,"cache_read_input_tokens":40818,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":1307},"output_tokens":1,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CYAts2dfwEuh1xUformZp","type":"assistant","uuid":"e6412558-0f32-4e57-9b94-03ccce22b402","timestamp":"2026-02-16T01:39:42.741Z"}
{"parentUuid":"e6412558-0f32-4e57-9b94-03ccce22b402","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","message":{"model":"claude-opus-4-6","id":"msg_0186W6zT77LvXkRJDmUD3dCs","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01NAutFLCz1nJASYvRLYLC3a","name":"Grep","input":{"pattern":"TableOfContents","path":"/Users/blittle/dev/pressy/packages/@pressy/components/src/Reader.tsx","output_mode":"content","-C":5},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":1307,"cache_read_input_tokens":40818,"output_tokens":157,"server_tool_use":{"web_search_requests":0,"web_fetch_requests":0},"service_tier":"standard","cache_creation":{"ephemeral_1h_input_tokens":1307,"ephemeral_5m_input_tokens":0},"inference_geo":"","iterations":[],"speed":"standard"}},"requestId":"req_011CYAts2dfwEuh1xUformZp","type":"assistant","uuid":"67a2bac8-61aa-4f2d-aff3-30e8b62f7581","timestamp":"2026-02-16T01:39:44.524Z"}
{"parentUuid":"67a2bac8-61aa-4f2d-aff3-30e8b62f7581","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","type":"progress","data":{"type":"hook_progress","hookEvent":"PostToolUse","hookName":"PostToolUse:Grep","command":"callback"},"parentToolUseID":"toolu_01NAutFLCz1nJASYvRLYLC3a","toolUseID":"toolu_01NAutFLCz1nJASYvRLYLC3a","timestamp":"2026-02-16T01:39:44.900Z","uuid":"9605a6b3-3d8b-4a77-a414-0b2156773c04"}
{"parentUuid":"67a2bac8-61aa-4f2d-aff3-30e8b62f7581","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01NAutFLCz1nJASYvRLYLC3a","type":"tool_result","content":"No matches found"}]},"uuid":"fb7b77d2-7326-4bbd-ae0b-3412cb8d2635","timestamp":"2026-02-16T01:39:44.899Z","toolUseResult":{"mode":"content","numFiles":0,"filenames":[],"content":"","numLines":0},"sourceToolAssistantUUID":"67a2bac8-61aa-4f2d-aff3-30e8b62f7581"}
{"parentUuid":"fb7b77d2-7326-4bbd-ae0b-3412cb8d2635","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","message":{"model":"claude-opus-4-6","id":"msg_01XvH8NLAJqZ26YdCY8M5Kpd","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_014XPwyRY35iZgsixcLxLXMQ","name":"Grep","input":{"pattern":"TableOfContents|toc|TOC","path":"/Users/blittle/dev/pressy/packages/@pressy/components/src/Reader.tsx","output_mode":"content","-C":3},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":172,"cache_read_input_tokens":42125,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":172},"output_tokens":25,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CYAtsWDcLj8ZL7kjyxt2A","type":"assistant","uuid":"1b946fc0-d29a-4342-ae09-c051ca91bbaf","timestamp":"2026-02-16T01:39:49.009Z"}
{"parentUuid":"1b946fc0-d29a-4342-ae09-c051ca91bbaf","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","type":"progress","data":{"type":"hook_progress","hookEvent":"PostToolUse","hookName":"PostToolUse:Grep","command":"callback"},"parentToolUseID":"toolu_014XPwyRY35iZgsixcLxLXMQ","toolUseID":"toolu_014XPwyRY35iZgsixcLxLXMQ","timestamp":"2026-02-16T01:39:49.292Z","uuid":"7b36f1be-5694-4816-a3c9-78e5c5ed5511"}
{"parentUuid":"1b946fc0-d29a-4342-ae09-c051ca91bbaf","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_014XPwyRY35iZgsixcLxLXMQ","type":"tool_result","content":"237-  const [footerVisible, setFooterVisible] = useState(false);\n238-  const footerTimerRef = useRef<ReturnType<typeof setTimeout> | null>(null);\n239-  const [settingsOpen, setSettingsOpen] = useState(false);\n240:  const [tocOpen, setTocOpen] = useState(false);\n241-\n242-  const showFooterTemporarily = useCallback(() => {\n243-    setFooterVisible(true);\n--\n308-      const target = e.target as HTMLElement;\n309-      if (\n310-        target.closest(\n311:          \".pressy-page-footer, .pressy-toc-backdrop, .pressy-toc-toggle\"\n312-        )\n313-      )\n314-        return;\n315-      if (target.closest('a, button, input, select, textarea, [role=\"button\"]'))\n316-        return;\n317-\n318:      if (settingsOpen || tocOpen) {\n319-        setSettingsOpen(false);\n320-        setTocOpen(false);\n321-        return;\n--\n328-        showFooterTemporarily();\n329-      }\n330-    },\n331:    [footerVisible, settingsOpen, tocOpen, showFooterTemporarily]\n332-  );\n333-\n334-  // Restore scroll position on mount\n--\n394-      <Navigation prev={prevChapter} next={nextChapter} />\n395-      <OfflineIndicator />\n396-\n397:      {/* TOC drawer overlay */}\n398:      {tocOpen && allChapters && (\n399-        <div\n400:          class=\"pressy-toc-backdrop pressy-toc-backdrop--scroll\"\n401-          onClick={(e: MouseEvent) => {\n402-            e.stopPropagation();\n403-            setTocOpen(false);\n404-          }}\n405-        >\n406-          <div\n407:            class=\"pressy-toc-drawer\"\n408-            onClick={(e: MouseEvent) => e.stopPropagation()}\n409-          >\n410:            <div class=\"pressy-toc-header\">\n411:              <span class=\"pressy-toc-title\">Contents</span>\n412-              <button\n413:                class=\"pressy-toc-close\"\n414-                onClick={(e: MouseEvent) => {\n415-                  e.stopPropagation();\n416-                  setTocOpen(false);\n--\n430-                </svg>\n431-              </button>\n432-            </div>\n433:            <nav class=\"pressy-toc-list\">\n434-              {allChapters.map((ch, i) => (\n435-                <a\n436-                  key={ch.slug}\n437-                  href={`${bookBasePath || \"\"}/${ch.slug}`}\n438:                  class={`pressy-toc-item ${\n439-                    ch.slug === currentChapterSlug\n440:                      ? \"pressy-toc-item--active\"\n441-                      : \"\"\n442-                  }`}\n443-                  onClick={() => setTocOpen(false)}\n444-                >\n445:                  <span class=\"pressy-toc-item-num\">{i + 1}.</span>\n446:                  <span class=\"pressy-toc-item-title\">{ch.title}</span>\n447-                </a>\n448-              ))}\n449-            </nav>\n--\n454-      {/* Footer */}\n455-      <div\n456-        class={`pressy-page-footer pressy-page-footer--scroll ${\n457:          footerVisible || settingsOpen || tocOpen\n458-            ? \"pressy-page-footer--visible\"\n459-            : \"\"\n460-        }`}\n--\n462-        <div class=\"pressy-footer-row\">\n463-          {allChapters && allChapters.length > 0 && (\n464-            <button\n465:              class=\"pressy-toc-toggle\"\n466-              onClick={(e: MouseEvent) => {\n467-                e.stopPropagation();\n468-                setSettingsOpen(false);\n469:                setTocOpen(!tocOpen);\n470-              }}\n471-              aria-label=\"Table of contents\"\n472-            >\n--\n493-                e.stopPropagation();\n494-                if (allChapters && allChapters.length > 0) {\n495-                  setSettingsOpen(false);\n496:                  setTocOpen(!tocOpen);\n497-                }\n498-              }}\n499-            >\n--\n775-    }\n776-  }, []); // Only on mount\n777-\n778:  // Settings & TOC panel state\n779-  const [settingsOpen, setSettingsOpen] = useState(false);\n780:  const [tocOpen, setTocOpen] = useState(false);\n781-  const [activeTheme, setActiveTheme] = useState<string>(() => {\n782-    if (typeof localStorage !== \"undefined\") {\n783-      return localStorage.getItem(\"pressy-theme\") || \"light\";\n--\n1314-      // Clicks inside panels or on interactive elements — ignore\n1315-      if (\n1316-        target.closest(\n1317:          \".pressy-settings-panel, .pressy-settings-toggle, .pressy-toc-drawer, .pressy-toc-toggle\"\n1318-        )\n1319-      )\n1320-        return;\n1321-      if (target.closest('a, button, input, select, textarea, [role=\"button\"]'))\n1322-        return;\n1323-\n1324:      // If settings or TOC panel is open, close it on any outside click\n1325:      if (settingsOpen || tocOpen) {\n1326-        setSettingsOpen(false);\n1327-        setTocOpen(false);\n1328-        return;\n--\n1381-      footerVisible,\n1382-      isTouchDevice,\n1383-      settingsOpen,\n1384:      tocOpen,\n1385-      showFooterTemporarily,\n1386-      toggleFullscreen,\n1387-    ]\n--\n1412-      if (y > rect.height * 0.75) {\n1413-        setFooterVisible(true);\n1414-        if (footerTimerRef.current) clearTimeout(footerTimerRef.current);\n1415:      } else if (!settingsOpen && !tocOpen) {\n1416-        // Hide after a short delay when leaving the bottom area (not when panels are open)\n1417-        if (footerTimerRef.current) clearTimeout(footerTimerRef.current);\n1418-        footerTimerRef.current = setTimeout(() => setFooterVisible(false), 600);\n1419-      }\n1420-    },\n1421:    [settingsOpen, tocOpen]\n1422-  );\n1423-\n1424-  const handleMouseLeave = useCallback(() => {\n1425-    setHoverZone(null);\n1426:    if (!settingsOpen && !tocOpen) {\n1427-      if (footerTimerRef.current) clearTimeout(footerTimerRef.current);\n1428-      footerTimerRef.current = setTimeout(() => setFooterVisible(false), 600);\n1429-    }\n1430:  }, [settingsOpen, tocOpen]);\n1431-\n1432-  // Keyboard navigation\n1433-  useEffect(() => {\n--\n1755-        </div>\n1756-      )}\n1757-\n1758:      {/* TOC drawer overlay */}\n1759:      {tocOpen && allChapters && (\n1760-        <div\n1761:          class=\"pressy-toc-backdrop\"\n1762-          onClick={(e: MouseEvent) => {\n1763-            e.stopPropagation();\n1764-            setTocOpen(false);\n1765-          }}\n1766-        >\n1767-          <div\n1768:            class=\"pressy-toc-drawer\"\n1769-            onClick={(e: MouseEvent) => e.stopPropagation()}\n1770-          >\n1771:            <div class=\"pressy-toc-header\">\n1772:              <span class=\"pressy-toc-title\">Contents</span>\n1773-              <button\n1774:                class=\"pressy-toc-close\"\n1775-                onClick={(e: MouseEvent) => {\n1776-                  e.stopPropagation();\n1777-                  setTocOpen(false);\n--\n1791-                </svg>\n1792-              </button>\n1793-            </div>\n1794:            <nav class=\"pressy-toc-list\">\n1795-              {allChapters.map((ch, i) => (\n1796-                <a\n1797-                  key={ch.slug}\n1798-                  href={`${bookBasePath || \"\"}/${ch.slug}`}\n1799:                  class={`pressy-toc-item ${\n1800-                    ch.slug === (activeChapterSlug || currentChapterSlug)\n1801:                      ? \"pressy-toc-item--active\"\n1802-                      : \"\"\n1803-                  }`}\n1804-                  onClick={() => setTocOpen(false)}\n1805-                >\n1806:                  <span class=\"pressy-toc-item-num\">{i + 1}.</span>\n1807:                  <span class=\"pressy-toc-item-title\">{ch.title}</span>\n1808-                </a>\n1809-              ))}\n1810-            </nav>\n--\n1815-      {/* Page footer with progress — hidden by default */}\n1816-      <div\n1817-        class={`pressy-page-footer ${\n1818:          footerVisible || settingsOpen || tocOpen\n1819-            ? \"pressy-page-footer--visible\"\n1820-            : \"\"\n1821-        }`}\n--\n1829-        <div class=\"pressy-footer-row\">\n1830-          {allChapters && allChapters.length > 0 && (\n1831-            <button\n1832:              class=\"pressy-toc-toggle\"\n1833-              onClick={(e: MouseEvent) => {\n1834-                e.stopPropagation();\n1835-                setSettingsOpen(false);\n1836:                setTocOpen(!tocOpen);\n1837-              }}\n1838-              aria-label=\"Table of contents\"\n1839-            >\n--\n1860-                e.stopPropagation();\n1861-                if (allChapters && allChapters.length > 0) {\n1862-                  setSettingsOpen(false);\n1863:                  setTocOpen(!tocOpen);\n1864-                }\n1865-              }}\n1866-            >\n--\n2110-    color: var(--color-text, #212529);\n2111-  }\n2112-\n2113:  .pressy-page-footer--scroll .pressy-toc-toggle,\n2114-  .pressy-page-footer--scroll .pressy-settings-toggle {\n2115-    flex-shrink: 0;\n2116-    display: flex;\n--\n2127-    padding: 0;\n2128-  }\n2129-\n2130:  .pressy-page-footer--scroll .pressy-toc-toggle:hover,\n2131-  .pressy-page-footer--scroll .pressy-settings-toggle:hover {\n2132-    color: var(--color-text, #212529);\n2133-    background: var(--color-bg-subtle, #f8f9fa);\n--\n2243-    text-align: center;\n2244-  }\n2245-\n2246:  /* ── TOC drawer for scroll reader ───────────────────────── */\n2247:  .pressy-toc-backdrop--scroll {\n2248-    position: fixed;\n2249-    inset: 0;\n2250-    background: rgba(0, 0, 0, 0.3);\n2251-    z-index: 20;\n2252-    display: flex;\n2253-    align-items: flex-end;\n2254:    animation: pressy-scroll-toc-fade-in 0.2s ease-out;\n2255-  }\n2256-\n2257:  .pressy-toc-backdrop--scroll .pressy-toc-drawer {\n2258-    width: 100%;\n2259-    max-height: 70vh;\n2260-    background: var(--color-bg, #ffffff);\n2261-    border-radius: 1rem 1rem 0 0;\n2262-    display: flex;\n2263-    flex-direction: column;\n2264:    animation: pressy-scroll-toc-slide-up 0.25s ease-out;\n2265-    box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.1);\n2266-  }\n2267-\n2268:  .pressy-toc-backdrop--scroll .pressy-toc-header {\n2269-    display: flex;\n2270-    align-items: center;\n2271-    justify-content: space-between;\n--\n2274-    flex-shrink: 0;\n2275-  }\n2276-\n2277:  .pressy-toc-backdrop--scroll .pressy-toc-title {\n2278-    font-family: var(--font-heading, system-ui, -apple-system, sans-serif);\n2279-    font-size: 1rem;\n2280-    font-weight: 600;\n2281-    color: var(--color-text, #212529);\n2282-  }\n2283-\n2284:  .pressy-toc-backdrop--scroll .pressy-toc-close {\n2285-    display: flex;\n2286-    align-items: center;\n2287-    justify-content: center;\n--\n2295-    padding: 0;\n2296-  }\n2297-\n2298:  .pressy-toc-backdrop--scroll .pressy-toc-close:hover {\n2299-    color: var(--color-text, #212529);\n2300-    background: var(--color-bg-subtle, #f8f9fa);\n2301-  }\n2302-\n2303:  .pressy-toc-backdrop--scroll .pressy-toc-list {\n2304-    overflow-y: auto;\n2305-    padding: 0.5rem;\n2306-    display: flex;\n2307-    flex-direction: column;\n2308-  }\n2309-\n2310:  .pressy-toc-backdrop--scroll .pressy-toc-item {\n2311-    display: flex;\n2312-    gap: 0.75rem;\n2313-    padding: 0.625rem 1rem;\n--\n2319-    transition: background 0.15s;\n2320-  }\n2321-\n2322:  .pressy-toc-backdrop--scroll .pressy-toc-item:hover {\n2323-    background: var(--color-bg-subtle, #f5f5f5);\n2324-  }\n2325-\n2326:  .pressy-toc-backdrop--scroll .pressy-toc-item--active {\n2327-    background: var(--color-bg-subtle, #f5f5f5);\n2328-    font-weight: 600;\n2329-  }\n2330-\n2331:  .pressy-toc-backdrop--scroll .pressy-toc-item-num {\n2332-    color: var(--color-text-muted, #6c757d);\n2333-    min-width: 2ch;\n2334-    text-align: right;\n2335-  }\n2336-\n2337:  .pressy-toc-backdrop--scroll .pressy-toc-item-title {\n2338-    flex: 1;\n2339-    min-width: 0;\n2340-  }\n2341-\n2342:  @keyframes pressy-scroll-toc-fade-in {\n2343-    from { opacity: 0; }\n2344-    to { opacity: 1; }\n2345-  }\n2346-\n2347:  @keyframes pressy-scroll-toc-slide-up {\n2348-    from { transform: translateY(100%); }\n2349-    to { transform: translateY(0); }\n2350-  }\n--\n2394-    .pressy-page-footer--scroll {\n2395-      transition: none;\n2396-    }\n2397:    .pressy-toc-backdrop--scroll,\n2398:    .pressy-toc-backdrop--scroll .pressy-toc-drawer {\n2399-      animation: none;\n2400-    }\n2401-  }\n--\n2618-    color: var(--color-text, #212529);\n2619-  }\n2620-\n2621:  /* ── TOC toggle button ──────────────────────────────────── */\n2622:  .pressy-toc-toggle {\n2623-    flex-shrink: 0;\n2624-    display: flex;\n2625-    align-items: center;\n--\n2635-    padding: 0;\n2636-  }\n2637-\n2638:  .pressy-toc-toggle:hover {\n2639-    color: var(--color-text, #212529);\n2640-    background: var(--color-bg-subtle, #f8f9fa);\n2641-  }\n--\n2788-    margin: 0;\n2789-  }\n2790-\n2791:  /* ── TOC drawer ──────────────────────────────────────────── */\n2792:  .pressy-toc-backdrop {\n2793-    position: absolute;\n2794-    inset: 0;\n2795-    background: rgba(0, 0, 0, 0.3);\n2796-    z-index: 20;\n2797-    display: flex;\n2798-    align-items: flex-end;\n2799:    animation: pressy-toc-fade-in 0.2s ease-out;\n2800-  }\n2801-\n2802:  .pressy-toc-drawer {\n2803-    width: 100%;\n2804-    max-height: 70vh;\n2805-    background: var(--color-bg, #ffffff);\n2806-    border-radius: 1rem 1rem 0 0;\n2807-    display: flex;\n2808-    flex-direction: column;\n2809:    animation: pressy-toc-slide-up 0.25s ease-out;\n2810-    box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.1);\n2811-  }\n2812-\n2813:  .pressy-toc-header {\n2814-    display: flex;\n2815-    align-items: center;\n2816-    justify-content: space-between;\n--\n2819-    flex-shrink: 0;\n2820-  }\n2821-\n2822:  .pressy-toc-title {\n2823-    font-family: var(--font-heading, system-ui, -apple-system, sans-serif);\n2824-    font-size: 1rem;\n2825-    font-weight: 600;\n2826-    color: var(--color-text, #212529);\n2827-  }\n2828-\n2829:  .pressy-toc-close {\n2830-    display: flex;\n2831-    align-items: center;\n2832-    justify-content: center;\n--\n2840-    padding: 0;\n2841-  }\n2842-\n2843:  .pressy-toc-close:hover {\n2844-    color: var(--color-text, #212529);\n2845-    background: var(--color-bg-subtle, #f8f9fa);\n2846-  }\n2847-\n2848:  .pressy-toc-list {\n2849-    overflow-y: auto;\n2850-    padding: 0.5rem;\n2851-    display: flex;\n2852-    flex-direction: column;\n2853-  }\n2854-\n2855:  .pressy-toc-item {\n2856-    display: flex;\n2857-    gap: 0.75rem;\n2858-    padding: 0.625rem 1rem;\n--\n2864-    transition: background 0.15s;\n2865-  }\n2866-\n2867:  .pressy-toc-item:hover {\n2868-    background: var(--color-bg-subtle, #f5f5f5);\n2869-  }\n2870-\n2871:  .pressy-toc-item--active {\n2872-    background: var(--color-bg-subtle, #f5f5f5);\n2873-    font-weight: 600;\n2874-  }\n2875-\n2876:  .pressy-toc-item-num {\n2877-    color: var(--color-text-muted, #6c757d);\n2878-    min-width: 2ch;\n2879-    text-align: right;\n2880-  }\n2881-\n2882:  .pressy-toc-item-title {\n2883-    flex: 1;\n2884-    min-width: 0;\n2885-  }\n2886-\n2887:  @keyframes pressy-toc-fade-in {\n2888-    from { opacity: 0; }\n2889-    to { opacity: 1; }\n2890-  }\n2891-\n2892:  @keyframes pressy-toc-slide-up {\n2893-    from { transform: translateY(100%); }\n2894-    to { transform: translateY(0); }\n2895-  }\n--\n2954-    .pressy-progress-fill {\n2955-      transition: none !important;\n2956-    }\n2957:    .pressy-toc-backdrop,\n2958:    .pressy-toc-drawer {\n2959-      animation: none;\n2960-    }\n2961-    .pressy-offline-spinner {"}]},"uuid":"5eb4fd30-a987-483a-a029-2542e4e6a366","timestamp":"2026-02-16T01:39:49.291Z","toolUseResult":{"mode":"content","numFiles":0,"filenames":[],"content":"237-  const [footerVisible, setFooterVisible] = useState(false);\n238-  const footerTimerRef = useRef<ReturnType<typeof setTimeout> | null>(null);\n239-  const [settingsOpen, setSettingsOpen] = useState(false);\n240:  const [tocOpen, setTocOpen] = useState(false);\n241-\n242-  const showFooterTemporarily = useCallback(() => {\n243-    setFooterVisible(true);\n--\n308-      const target = e.target as HTMLElement;\n309-      if (\n310-        target.closest(\n311:          \".pressy-page-footer, .pressy-toc-backdrop, .pressy-toc-toggle\"\n312-        )\n313-      )\n314-        return;\n315-      if (target.closest('a, button, input, select, textarea, [role=\"button\"]'))\n316-        return;\n317-\n318:      if (settingsOpen || tocOpen) {\n319-        setSettingsOpen(false);\n320-        setTocOpen(false);\n321-        return;\n--\n328-        showFooterTemporarily();\n329-      }\n330-    },\n331:    [footerVisible, settingsOpen, tocOpen, showFooterTemporarily]\n332-  );\n333-\n334-  // Restore scroll position on mount\n--\n394-      <Navigation prev={prevChapter} next={nextChapter} />\n395-      <OfflineIndicator />\n396-\n397:      {/* TOC drawer overlay */}\n398:      {tocOpen && allChapters && (\n399-        <div\n400:          class=\"pressy-toc-backdrop pressy-toc-backdrop--scroll\"\n401-          onClick={(e: MouseEvent) => {\n402-            e.stopPropagation();\n403-            setTocOpen(false);\n404-          }}\n405-        >\n406-          <div\n407:            class=\"pressy-toc-drawer\"\n408-            onClick={(e: MouseEvent) => e.stopPropagation()}\n409-          >\n410:            <div class=\"pressy-toc-header\">\n411:              <span class=\"pressy-toc-title\">Contents</span>\n412-              <button\n413:                class=\"pressy-toc-close\"\n414-                onClick={(e: MouseEvent) => {\n415-                  e.stopPropagation();\n416-                  setTocOpen(false);\n--\n430-                </svg>\n431-              </button>\n432-            </div>\n433:            <nav class=\"pressy-toc-list\">\n434-              {allChapters.map((ch, i) => (\n435-                <a\n436-                  key={ch.slug}\n437-                  href={`${bookBasePath || \"\"}/${ch.slug}`}\n438:                  class={`pressy-toc-item ${\n439-                    ch.slug === currentChapterSlug\n440:                      ? \"pressy-toc-item--active\"\n441-                      : \"\"\n442-                  }`}\n443-                  onClick={() => setTocOpen(false)}\n444-                >\n445:                  <span class=\"pressy-toc-item-num\">{i + 1}.</span>\n446:                  <span class=\"pressy-toc-item-title\">{ch.title}</span>\n447-                </a>\n448-              ))}\n449-            </nav>\n--\n454-      {/* Footer */}\n455-      <div\n456-        class={`pressy-page-footer pressy-page-footer--scroll ${\n457:          footerVisible || settingsOpen || tocOpen\n458-            ? \"pressy-page-footer--visible\"\n459-            : \"\"\n460-        }`}\n--\n462-        <div class=\"pressy-footer-row\">\n463-          {allChapters && allChapters.length > 0 && (\n464-            <button\n465:              class=\"pressy-toc-toggle\"\n466-              onClick={(e: MouseEvent) => {\n467-                e.stopPropagation();\n468-                setSettingsOpen(false);\n469:                setTocOpen(!tocOpen);\n470-              }}\n471-              aria-label=\"Table of contents\"\n472-            >\n--\n493-                e.stopPropagation();\n494-                if (allChapters && allChapters.length > 0) {\n495-                  setSettingsOpen(false);\n496:                  setTocOpen(!tocOpen);\n497-                }\n498-              }}\n499-            >\n--\n775-    }\n776-  }, []); // Only on mount\n777-\n778:  // Settings & TOC panel state\n779-  const [settingsOpen, setSettingsOpen] = useState(false);\n780:  const [tocOpen, setTocOpen] = useState(false);\n781-  const [activeTheme, setActiveTheme] = useState<string>(() => {\n782-    if (typeof localStorage !== \"undefined\") {\n783-      return localStorage.getItem(\"pressy-theme\") || \"light\";\n--\n1314-      // Clicks inside panels or on interactive elements — ignore\n1315-      if (\n1316-        target.closest(\n1317:          \".pressy-settings-panel, .pressy-settings-toggle, .pressy-toc-drawer, .pressy-toc-toggle\"\n1318-        )\n1319-      )\n1320-        return;\n1321-      if (target.closest('a, button, input, select, textarea, [role=\"button\"]'))\n1322-        return;\n1323-\n1324:      // If settings or TOC panel is open, close it on any outside click\n1325:      if (settingsOpen || tocOpen) {\n1326-        setSettingsOpen(false);\n1327-        setTocOpen(false);\n1328-        return;\n--\n1381-      footerVisible,\n1382-      isTouchDevice,\n1383-      settingsOpen,\n1384:      tocOpen,\n1385-      showFooterTemporarily,\n1386-      toggleFullscreen,\n1387-    ]\n--\n1412-      if (y > rect.height * 0.75) {\n1413-        setFooterVisible(true);\n1414-        if (footerTimerRef.current) clearTimeout(footerTimerRef.current);\n1415:      } else if (!settingsOpen && !tocOpen) {\n1416-        // Hide after a short delay when leaving the bottom area (not when panels are open)\n1417-        if (footerTimerRef.current) clearTimeout(footerTimerRef.current);\n1418-        footerTimerRef.current = setTimeout(() => setFooterVisible(false), 600);\n1419-      }\n1420-    },\n1421:    [settingsOpen, tocOpen]\n1422-  );\n1423-\n1424-  const handleMouseLeave = useCallback(() => {\n1425-    setHoverZone(null);\n1426:    if (!settingsOpen && !tocOpen) {\n1427-      if (footerTimerRef.current) clearTimeout(footerTimerRef.current);\n1428-      footerTimerRef.current = setTimeout(() => setFooterVisible(false), 600);\n1429-    }\n1430:  }, [settingsOpen, tocOpen]);\n1431-\n1432-  // Keyboard navigation\n1433-  useEffect(() => {\n--\n1755-        </div>\n1756-      )}\n1757-\n1758:      {/* TOC drawer overlay */}\n1759:      {tocOpen && allChapters && (\n1760-        <div\n1761:          class=\"pressy-toc-backdrop\"\n1762-          onClick={(e: MouseEvent) => {\n1763-            e.stopPropagation();\n1764-            setTocOpen(false);\n1765-          }}\n1766-        >\n1767-          <div\n1768:            class=\"pressy-toc-drawer\"\n1769-            onClick={(e: MouseEvent) => e.stopPropagation()}\n1770-          >\n1771:            <div class=\"pressy-toc-header\">\n1772:              <span class=\"pressy-toc-title\">Contents</span>\n1773-              <button\n1774:                class=\"pressy-toc-close\"\n1775-                onClick={(e: MouseEvent) => {\n1776-                  e.stopPropagation();\n1777-                  setTocOpen(false);\n--\n1791-                </svg>\n1792-              </button>\n1793-            </div>\n1794:            <nav class=\"pressy-toc-list\">\n1795-              {allChapters.map((ch, i) => (\n1796-                <a\n1797-                  key={ch.slug}\n1798-                  href={`${bookBasePath || \"\"}/${ch.slug}`}\n1799:                  class={`pressy-toc-item ${\n1800-                    ch.slug === (activeChapterSlug || currentChapterSlug)\n1801:                      ? \"pressy-toc-item--active\"\n1802-                      : \"\"\n1803-                  }`}\n1804-                  onClick={() => setTocOpen(false)}\n1805-                >\n1806:                  <span class=\"pressy-toc-item-num\">{i + 1}.</span>\n1807:                  <span class=\"pressy-toc-item-title\">{ch.title}</span>\n1808-                </a>\n1809-              ))}\n1810-            </nav>\n--\n1815-      {/* Page footer with progress — hidden by default */}\n1816-      <div\n1817-        class={`pressy-page-footer ${\n1818:          footerVisible || settingsOpen || tocOpen\n1819-            ? \"pressy-page-footer--visible\"\n1820-            : \"\"\n1821-        }`}\n--\n1829-        <div class=\"pressy-footer-row\">\n1830-          {allChapters && allChapters.length > 0 && (\n1831-            <button\n1832:              class=\"pressy-toc-toggle\"\n1833-              onClick={(e: MouseEvent) => {\n1834-                e.stopPropagation();\n1835-                setSettingsOpen(false);\n1836:                setTocOpen(!tocOpen);\n1837-              }}\n1838-              aria-label=\"Table of contents\"\n1839-            >\n--\n1860-                e.stopPropagation();\n1861-                if (allChapters && allChapters.length > 0) {\n1862-                  setSettingsOpen(false);\n1863:                  setTocOpen(!tocOpen);\n1864-                }\n1865-              }}\n1866-            >\n--\n2110-    color: var(--color-text, #212529);\n2111-  }\n2112-\n2113:  .pressy-page-footer--scroll .pressy-toc-toggle,\n2114-  .pressy-page-footer--scroll .pressy-settings-toggle {\n2115-    flex-shrink: 0;\n2116-    display: flex;\n--\n2127-    padding: 0;\n2128-  }\n2129-\n2130:  .pressy-page-footer--scroll .pressy-toc-toggle:hover,\n2131-  .pressy-page-footer--scroll .pressy-settings-toggle:hover {\n2132-    color: var(--color-text, #212529);\n2133-    background: var(--color-bg-subtle, #f8f9fa);\n--\n2243-    text-align: center;\n2244-  }\n2245-\n2246:  /* ── TOC drawer for scroll reader ───────────────────────── */\n2247:  .pressy-toc-backdrop--scroll {\n2248-    position: fixed;\n2249-    inset: 0;\n2250-    background: rgba(0, 0, 0, 0.3);\n2251-    z-index: 20;\n2252-    display: flex;\n2253-    align-items: flex-end;\n2254:    animation: pressy-scroll-toc-fade-in 0.2s ease-out;\n2255-  }\n2256-\n2257:  .pressy-toc-backdrop--scroll .pressy-toc-drawer {\n2258-    width: 100%;\n2259-    max-height: 70vh;\n2260-    background: var(--color-bg, #ffffff);\n2261-    border-radius: 1rem 1rem 0 0;\n2262-    display: flex;\n2263-    flex-direction: column;\n2264:    animation: pressy-scroll-toc-slide-up 0.25s ease-out;\n2265-    box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.1);\n2266-  }\n2267-\n2268:  .pressy-toc-backdrop--scroll .pressy-toc-header {\n2269-    display: flex;\n2270-    align-items: center;\n2271-    justify-content: space-between;\n--\n2274-    flex-shrink: 0;\n2275-  }\n2276-\n2277:  .pressy-toc-backdrop--scroll .pressy-toc-title {\n2278-    font-family: var(--font-heading, system-ui, -apple-system, sans-serif);\n2279-    font-size: 1rem;\n2280-    font-weight: 600;\n2281-    color: var(--color-text, #212529);\n2282-  }\n2283-\n2284:  .pressy-toc-backdrop--scroll .pressy-toc-close {\n2285-    display: flex;\n2286-    align-items: center;\n2287-    justify-content: center;\n--\n2295-    padding: 0;\n2296-  }\n2297-\n2298:  .pressy-toc-backdrop--scroll .pressy-toc-close:hover {\n2299-    color: var(--color-text, #212529);\n2300-    background: var(--color-bg-subtle, #f8f9fa);\n2301-  }\n2302-\n2303:  .pressy-toc-backdrop--scroll .pressy-toc-list {\n2304-    overflow-y: auto;\n2305-    padding: 0.5rem;\n2306-    display: flex;\n2307-    flex-direction: column;\n2308-  }\n2309-\n2310:  .pressy-toc-backdrop--scroll .pressy-toc-item {\n2311-    display: flex;\n2312-    gap: 0.75rem;\n2313-    padding: 0.625rem 1rem;\n--\n2319-    transition: background 0.15s;\n2320-  }\n2321-\n2322:  .pressy-toc-backdrop--scroll .pressy-toc-item:hover {\n2323-    background: var(--color-bg-subtle, #f5f5f5);\n2324-  }\n2325-\n2326:  .pressy-toc-backdrop--scroll .pressy-toc-item--active {\n2327-    background: var(--color-bg-subtle, #f5f5f5);\n2328-    font-weight: 600;\n2329-  }\n2330-\n2331:  .pressy-toc-backdrop--scroll .pressy-toc-item-num {\n2332-    color: var(--color-text-muted, #6c757d);\n2333-    min-width: 2ch;\n2334-    text-align: right;\n2335-  }\n2336-\n2337:  .pressy-toc-backdrop--scroll .pressy-toc-item-title {\n2338-    flex: 1;\n2339-    min-width: 0;\n2340-  }\n2341-\n2342:  @keyframes pressy-scroll-toc-fade-in {\n2343-    from { opacity: 0; }\n2344-    to { opacity: 1; }\n2345-  }\n2346-\n2347:  @keyframes pressy-scroll-toc-slide-up {\n2348-    from { transform: translateY(100%); }\n2349-    to { transform: translateY(0); }\n2350-  }\n--\n2394-    .pressy-page-footer--scroll {\n2395-      transition: none;\n2396-    }\n2397:    .pressy-toc-backdrop--scroll,\n2398:    .pressy-toc-backdrop--scroll .pressy-toc-drawer {\n2399-      animation: none;\n2400-    }\n2401-  }\n--\n2618-    color: var(--color-text, #212529);\n2619-  }\n2620-\n2621:  /* ── TOC toggle button ──────────────────────────────────── */\n2622:  .pressy-toc-toggle {\n2623-    flex-shrink: 0;\n2624-    display: flex;\n2625-    align-items: center;\n--\n2635-    padding: 0;\n2636-  }\n2637-\n2638:  .pressy-toc-toggle:hover {\n2639-    color: var(--color-text, #212529);\n2640-    background: var(--color-bg-subtle, #f8f9fa);\n2641-  }\n--\n2788-    margin: 0;\n2789-  }\n2790-\n2791:  /* ── TOC drawer ──────────────────────────────────────────── */\n2792:  .pressy-toc-backdrop {\n2793-    position: absolute;\n2794-    inset: 0;\n2795-    background: rgba(0, 0, 0, 0.3);\n2796-    z-index: 20;\n2797-    display: flex;\n2798-    align-items: flex-end;\n2799:    animation: pressy-toc-fade-in 0.2s ease-out;\n2800-  }\n2801-\n2802:  .pressy-toc-drawer {\n2803-    width: 100%;\n2804-    max-height: 70vh;\n2805-    background: var(--color-bg, #ffffff);\n2806-    border-radius: 1rem 1rem 0 0;\n2807-    display: flex;\n2808-    flex-direction: column;\n2809:    animation: pressy-toc-slide-up 0.25s ease-out;\n2810-    box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.1);\n2811-  }\n2812-\n2813:  .pressy-toc-header {\n2814-    display: flex;\n2815-    align-items: center;\n2816-    justify-content: space-between;\n--\n2819-    flex-shrink: 0;\n2820-  }\n2821-\n2822:  .pressy-toc-title {\n2823-    font-family: var(--font-heading, system-ui, -apple-system, sans-serif);\n2824-    font-size: 1rem;\n2825-    font-weight: 600;\n2826-    color: var(--color-text, #212529);\n2827-  }\n2828-\n2829:  .pressy-toc-close {\n2830-    display: flex;\n2831-    align-items: center;\n2832-    justify-content: center;\n--\n2840-    padding: 0;\n2841-  }\n2842-\n2843:  .pressy-toc-close:hover {\n2844-    color: var(--color-text, #212529);\n2845-    background: var(--color-bg-subtle, #f8f9fa);\n2846-  }\n2847-\n2848:  .pressy-toc-list {\n2849-    overflow-y: auto;\n2850-    padding: 0.5rem;\n2851-    display: flex;\n2852-    flex-direction: column;\n2853-  }\n2854-\n2855:  .pressy-toc-item {\n2856-    display: flex;\n2857-    gap: 0.75rem;\n2858-    padding: 0.625rem 1rem;\n--\n2864-    transition: background 0.15s;\n2865-  }\n2866-\n2867:  .pressy-toc-item:hover {\n2868-    background: var(--color-bg-subtle, #f5f5f5);\n2869-  }\n2870-\n2871:  .pressy-toc-item--active {\n2872-    background: var(--color-bg-subtle, #f5f5f5);\n2873-    font-weight: 600;\n2874-  }\n2875-\n2876:  .pressy-toc-item-num {\n2877-    color: var(--color-text-muted, #6c757d);\n2878-    min-width: 2ch;\n2879-    text-align: right;\n2880-  }\n2881-\n2882:  .pressy-toc-item-title {\n2883-    flex: 1;\n2884-    min-width: 0;\n2885-  }\n2886-\n2887:  @keyframes pressy-toc-fade-in {\n2888-    from { opacity: 0; }\n2889-    to { opacity: 1; }\n2890-  }\n2891-\n2892:  @keyframes pressy-toc-slide-up {\n2893-    from { transform: translateY(100%); }\n2894-    to { transform: translateY(0); }\n2895-  }\n--\n2954-    .pressy-progress-fill {\n2955-      transition: none !important;\n2956-    }\n2957:    .pressy-toc-backdrop,\n2958:    .pressy-toc-drawer {\n2959-      animation: none;\n2960-    }\n2961-    .pressy-offline-spinner {","numLines":480},"sourceToolAssistantUUID":"1b946fc0-d29a-4342-ae09-c051ca91bbaf"}
{"parentUuid":"5eb4fd30-a987-483a-a029-2542e4e6a366","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","message":{"model":"claude-opus-4-6","id":"msg_01Xrq6YGP5D1vL4bQYrsnhkm","type":"message","role":"assistant","content":[{"type":"text","text":"There are two TOC drawers — one for scroll mode and one for paginated mode. Let me see the exact areas where chapters are rendered to understand how `bookBasePath` and `bookTitle` are available."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":5813,"cache_read_input_tokens":42297,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":5813},"output_tokens":1,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CYAtsmgHJH2ffBBDj3chF","type":"assistant","uuid":"0f5a11b2-552a-465f-a3e5-2da3aa07e311","timestamp":"2026-02-16T01:39:52.442Z"}
{"parentUuid":"0f5a11b2-552a-465f-a3e5-2da3aa07e311","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","message":{"model":"claude-opus-4-6","id":"msg_01Xrq6YGP5D1vL4bQYrsnhkm","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01M9fswntdhEZHY8GLLWd5bw","name":"Read","input":{"file_path":"/Users/blittle/dev/pressy/packages/@pressy/components/src/Reader.tsx","offset":390,"limit":75},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":5813,"cache_read_input_tokens":42297,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":5813},"output_tokens":1,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CYAtsmgHJH2ffBBDj3chF","type":"assistant","uuid":"8706eb5f-9bba-431f-933a-86aaf4946aa9","timestamp":"2026-02-16T01:39:53.601Z"}
{"parentUuid":"8706eb5f-9bba-431f-933a-86aaf4946aa9","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","type":"progress","data":{"type":"hook_progress","hookEvent":"PostToolUse","hookName":"PostToolUse:Read","command":"callback"},"parentToolUseID":"toolu_01M9fswntdhEZHY8GLLWd5bw","toolUseID":"toolu_01M9fswntdhEZHY8GLLWd5bw","timestamp":"2026-02-16T01:39:53.651Z","uuid":"da58981f-df31-4258-9081-69a256ce0f0b"}
{"parentUuid":"8706eb5f-9bba-431f-933a-86aaf4946aa9","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01M9fswntdhEZHY8GLLWd5bw","type":"tool_result","content":"   390→        </article>\n   391→      </main>\n   392→\n   393→      <TextShare />\n   394→      <Navigation prev={prevChapter} next={nextChapter} />\n   395→      <OfflineIndicator />\n   396→\n   397→      {/* TOC drawer overlay */}\n   398→      {tocOpen && allChapters && (\n   399→        <div\n   400→          class=\"pressy-toc-backdrop pressy-toc-backdrop--scroll\"\n   401→          onClick={(e: MouseEvent) => {\n   402→            e.stopPropagation();\n   403→            setTocOpen(false);\n   404→          }}\n   405→        >\n   406→          <div\n   407→            class=\"pressy-toc-drawer\"\n   408→            onClick={(e: MouseEvent) => e.stopPropagation()}\n   409→          >\n   410→            <div class=\"pressy-toc-header\">\n   411→              <span class=\"pressy-toc-title\">Contents</span>\n   412→              <button\n   413→                class=\"pressy-toc-close\"\n   414→                onClick={(e: MouseEvent) => {\n   415→                  e.stopPropagation();\n   416→                  setTocOpen(false);\n   417→                }}\n   418→                aria-label=\"Close table of contents\"\n   419→              >\n   420→                <svg\n   421→                  viewBox=\"0 0 24 24\"\n   422→                  fill=\"none\"\n   423→                  stroke=\"currentColor\"\n   424→                  stroke-width=\"2\"\n   425→                  width=\"18\"\n   426→                  height=\"18\"\n   427→                >\n   428→                  <line x1=\"18\" y1=\"6\" x2=\"6\" y2=\"18\" />\n   429→                  <line x1=\"6\" y1=\"6\" x2=\"18\" y2=\"18\" />\n   430→                </svg>\n   431→              </button>\n   432→            </div>\n   433→            <nav class=\"pressy-toc-list\">\n   434→              {allChapters.map((ch, i) => (\n   435→                <a\n   436→                  key={ch.slug}\n   437→                  href={`${bookBasePath || \"\"}/${ch.slug}`}\n   438→                  class={`pressy-toc-item ${\n   439→                    ch.slug === currentChapterSlug\n   440→                      ? \"pressy-toc-item--active\"\n   441→                      : \"\"\n   442→                  }`}\n   443→                  onClick={() => setTocOpen(false)}\n   444→                >\n   445→                  <span class=\"pressy-toc-item-num\">{i + 1}.</span>\n   446→                  <span class=\"pressy-toc-item-title\">{ch.title}</span>\n   447→                </a>\n   448→              ))}\n   449→            </nav>\n   450→          </div>\n   451→        </div>\n   452→      )}\n   453→\n   454→      {/* Footer */}\n   455→      <div\n   456→        class={`pressy-page-footer pressy-page-footer--scroll ${\n   457→          footerVisible || settingsOpen || tocOpen\n   458→            ? \"pressy-page-footer--visible\"\n   459→            : \"\"\n   460→        }`}\n   461→      >\n   462→        <div class=\"pressy-footer-row\">\n   463→          {allChapters && allChapters.length > 0 && (\n   464→            <button"}]},"uuid":"eb49b1a7-ff88-4eca-a064-2b376c7b57fe","timestamp":"2026-02-16T01:39:53.651Z","toolUseResult":{"type":"text","file":{"filePath":"/Users/blittle/dev/pressy/packages/@pressy/components/src/Reader.tsx","content":"        </article>\n      </main>\n\n      <TextShare />\n      <Navigation prev={prevChapter} next={nextChapter} />\n      <OfflineIndicator />\n\n      {/* TOC drawer overlay */}\n      {tocOpen && allChapters && (\n        <div\n          class=\"pressy-toc-backdrop pressy-toc-backdrop--scroll\"\n          onClick={(e: MouseEvent) => {\n            e.stopPropagation();\n            setTocOpen(false);\n          }}\n        >\n          <div\n            class=\"pressy-toc-drawer\"\n            onClick={(e: MouseEvent) => e.stopPropagation()}\n          >\n            <div class=\"pressy-toc-header\">\n              <span class=\"pressy-toc-title\">Contents</span>\n              <button\n                class=\"pressy-toc-close\"\n                onClick={(e: MouseEvent) => {\n                  e.stopPropagation();\n                  setTocOpen(false);\n                }}\n                aria-label=\"Close table of contents\"\n              >\n                <svg\n                  viewBox=\"0 0 24 24\"\n                  fill=\"none\"\n                  stroke=\"currentColor\"\n                  stroke-width=\"2\"\n                  width=\"18\"\n                  height=\"18\"\n                >\n                  <line x1=\"18\" y1=\"6\" x2=\"6\" y2=\"18\" />\n                  <line x1=\"6\" y1=\"6\" x2=\"18\" y2=\"18\" />\n                </svg>\n              </button>\n            </div>\n            <nav class=\"pressy-toc-list\">\n              {allChapters.map((ch, i) => (\n                <a\n                  key={ch.slug}\n                  href={`${bookBasePath || \"\"}/${ch.slug}`}\n                  class={`pressy-toc-item ${\n                    ch.slug === currentChapterSlug\n                      ? \"pressy-toc-item--active\"\n                      : \"\"\n                  }`}\n                  onClick={() => setTocOpen(false)}\n                >\n                  <span class=\"pressy-toc-item-num\">{i + 1}.</span>\n                  <span class=\"pressy-toc-item-title\">{ch.title}</span>\n                </a>\n              ))}\n            </nav>\n          </div>\n        </div>\n      )}\n\n      {/* Footer */}\n      <div\n        class={`pressy-page-footer pressy-page-footer--scroll ${\n          footerVisible || settingsOpen || tocOpen\n            ? \"pressy-page-footer--visible\"\n            : \"\"\n        }`}\n      >\n        <div class=\"pressy-footer-row\">\n          {allChapters && allChapters.length > 0 && (\n            <button","numLines":75,"startLine":390,"totalLines":2966}},"sourceToolAssistantUUID":"8706eb5f-9bba-431f-933a-86aaf4946aa9"}
{"parentUuid":"eb49b1a7-ff88-4eca-a064-2b376c7b57fe","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","message":{"model":"claude-opus-4-6","id":"msg_015jZKPQV1xaH5ZdJZCK3h1L","type":"message","role":"assistant","content":[{"type":"text","text":"Now let me see the paginated mode TOC drawer:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":1092,"cache_read_input_tokens":48110,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":1092},"output_tokens":1,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CYAtt6T93KfDe2kF7asa1","type":"assistant","uuid":"126a850d-f287-4195-938b-d27c643a6850","timestamp":"2026-02-16T01:39:57.740Z"}
{"parentUuid":"126a850d-f287-4195-938b-d27c643a6850","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","message":{"model":"claude-opus-4-6","id":"msg_015jZKPQV1xaH5ZdJZCK3h1L","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01CK9NdbJtKH1mK2ebervpbF","name":"Read","input":{"file_path":"/Users/blittle/dev/pressy/packages/@pressy/components/src/Reader.tsx","offset":1755,"limit":65},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":1092,"cache_read_input_tokens":48110,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":1092},"output_tokens":1,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CYAtt6T93KfDe2kF7asa1","type":"assistant","uuid":"5f14f570-1356-48cd-950b-d2aab47282a7","timestamp":"2026-02-16T01:39:58.504Z"}
{"parentUuid":"5f14f570-1356-48cd-950b-d2aab47282a7","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","type":"progress","data":{"type":"hook_progress","hookEvent":"PostToolUse","hookName":"PostToolUse:Read","command":"callback"},"parentToolUseID":"toolu_01CK9NdbJtKH1mK2ebervpbF","toolUseID":"toolu_01CK9NdbJtKH1mK2ebervpbF","timestamp":"2026-02-16T01:39:58.523Z","uuid":"978f33be-b4df-4197-bb41-ee49c909fdab"}
{"parentUuid":"5f14f570-1356-48cd-950b-d2aab47282a7","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01CK9NdbJtKH1mK2ebervpbF","type":"tool_result","content":"  1755→        </div>\n  1756→      )}\n  1757→\n  1758→      {/* TOC drawer overlay */}\n  1759→      {tocOpen && allChapters && (\n  1760→        <div\n  1761→          class=\"pressy-toc-backdrop\"\n  1762→          onClick={(e: MouseEvent) => {\n  1763→            e.stopPropagation();\n  1764→            setTocOpen(false);\n  1765→          }}\n  1766→        >\n  1767→          <div\n  1768→            class=\"pressy-toc-drawer\"\n  1769→            onClick={(e: MouseEvent) => e.stopPropagation()}\n  1770→          >\n  1771→            <div class=\"pressy-toc-header\">\n  1772→              <span class=\"pressy-toc-title\">Contents</span>\n  1773→              <button\n  1774→                class=\"pressy-toc-close\"\n  1775→                onClick={(e: MouseEvent) => {\n  1776→                  e.stopPropagation();\n  1777→                  setTocOpen(false);\n  1778→                }}\n  1779→                aria-label=\"Close table of contents\"\n  1780→              >\n  1781→                <svg\n  1782→                  viewBox=\"0 0 24 24\"\n  1783→                  fill=\"none\"\n  1784→                  stroke=\"currentColor\"\n  1785→                  stroke-width=\"2\"\n  1786→                  width=\"18\"\n  1787→                  height=\"18\"\n  1788→                >\n  1789→                  <line x1=\"18\" y1=\"6\" x2=\"6\" y2=\"18\" />\n  1790→                  <line x1=\"6\" y1=\"6\" x2=\"18\" y2=\"18\" />\n  1791→                </svg>\n  1792→              </button>\n  1793→            </div>\n  1794→            <nav class=\"pressy-toc-list\">\n  1795→              {allChapters.map((ch, i) => (\n  1796→                <a\n  1797→                  key={ch.slug}\n  1798→                  href={`${bookBasePath || \"\"}/${ch.slug}`}\n  1799→                  class={`pressy-toc-item ${\n  1800→                    ch.slug === (activeChapterSlug || currentChapterSlug)\n  1801→                      ? \"pressy-toc-item--active\"\n  1802→                      : \"\"\n  1803→                  }`}\n  1804→                  onClick={() => setTocOpen(false)}\n  1805→                >\n  1806→                  <span class=\"pressy-toc-item-num\">{i + 1}.</span>\n  1807→                  <span class=\"pressy-toc-item-title\">{ch.title}</span>\n  1808→                </a>\n  1809→              ))}\n  1810→            </nav>\n  1811→          </div>\n  1812→        </div>\n  1813→      )}\n  1814→\n  1815→      {/* Page footer with progress — hidden by default */}\n  1816→      <div\n  1817→        class={`pressy-page-footer ${\n  1818→          footerVisible || settingsOpen || tocOpen\n  1819→            ? \"pressy-page-footer--visible\""}]},"uuid":"a33fae94-4043-47e7-9ecb-178e2421ad55","timestamp":"2026-02-16T01:39:58.522Z","toolUseResult":{"type":"text","file":{"filePath":"/Users/blittle/dev/pressy/packages/@pressy/components/src/Reader.tsx","content":"        </div>\n      )}\n\n      {/* TOC drawer overlay */}\n      {tocOpen && allChapters && (\n        <div\n          class=\"pressy-toc-backdrop\"\n          onClick={(e: MouseEvent) => {\n            e.stopPropagation();\n            setTocOpen(false);\n          }}\n        >\n          <div\n            class=\"pressy-toc-drawer\"\n            onClick={(e: MouseEvent) => e.stopPropagation()}\n          >\n            <div class=\"pressy-toc-header\">\n              <span class=\"pressy-toc-title\">Contents</span>\n              <button\n                class=\"pressy-toc-close\"\n                onClick={(e: MouseEvent) => {\n                  e.stopPropagation();\n                  setTocOpen(false);\n                }}\n                aria-label=\"Close table of contents\"\n              >\n                <svg\n                  viewBox=\"0 0 24 24\"\n                  fill=\"none\"\n                  stroke=\"currentColor\"\n                  stroke-width=\"2\"\n                  width=\"18\"\n                  height=\"18\"\n                >\n                  <line x1=\"18\" y1=\"6\" x2=\"6\" y2=\"18\" />\n                  <line x1=\"6\" y1=\"6\" x2=\"18\" y2=\"18\" />\n                </svg>\n              </button>\n            </div>\n            <nav class=\"pressy-toc-list\">\n              {allChapters.map((ch, i) => (\n                <a\n                  key={ch.slug}\n                  href={`${bookBasePath || \"\"}/${ch.slug}`}\n                  class={`pressy-toc-item ${\n                    ch.slug === (activeChapterSlug || currentChapterSlug)\n                      ? \"pressy-toc-item--active\"\n                      : \"\"\n                  }`}\n                  onClick={() => setTocOpen(false)}\n                >\n                  <span class=\"pressy-toc-item-num\">{i + 1}.</span>\n                  <span class=\"pressy-toc-item-title\">{ch.title}</span>\n                </a>\n              ))}\n            </nav>\n          </div>\n        </div>\n      )}\n\n      {/* Page footer with progress — hidden by default */}\n      <div\n        class={`pressy-page-footer ${\n          footerVisible || settingsOpen || tocOpen\n            ? \"pressy-page-footer--visible\"","numLines":65,"startLine":1755,"totalLines":2966}},"sourceToolAssistantUUID":"5f14f570-1356-48cd-950b-d2aab47282a7"}
{"parentUuid":"a33fae94-4043-47e7-9ecb-178e2421ad55","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","message":{"model":"claude-opus-4-6","id":"msg_012d5bLqYRGEJABirZ6W7DAm","type":"message","role":"assistant","content":[{"type":"text","text":"Now let me check what `bookTitle` prop is available. Let me look at the Reader props."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":1009,"cache_read_input_tokens":49202,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":1009},"output_tokens":4,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CYAttTSCrxVme4xxsUtE8","type":"assistant","uuid":"85571aa1-5616-469a-a676-54d283268ae5","timestamp":"2026-02-16T01:40:00.793Z"}
{"parentUuid":"85571aa1-5616-469a-a676-54d283268ae5","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","message":{"model":"claude-opus-4-6","id":"msg_012d5bLqYRGEJABirZ6W7DAm","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_013SxzaMdCmgtpTTspJc4Zcm","name":"Grep","input":{"pattern":"bookTitle|bookBasePath","path":"/Users/blittle/dev/pressy/packages/@pressy/components/src/Reader.tsx","output_mode":"content","-n":true,"head_limit":20},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":1009,"cache_read_input_tokens":49202,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":1009},"output_tokens":4,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CYAttTSCrxVme4xxsUtE8","type":"assistant","uuid":"708b4daa-77db-4a65-a802-5986642713fc","timestamp":"2026-02-16T01:40:02.145Z"}
{"parentUuid":"708b4daa-77db-4a65-a802-5986642713fc","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","type":"progress","data":{"type":"hook_progress","hookEvent":"PostToolUse","hookName":"PostToolUse:Grep","command":"callback"},"parentToolUseID":"toolu_013SxzaMdCmgtpTTspJc4Zcm","toolUseID":"toolu_013SxzaMdCmgtpTTspJc4Zcm","timestamp":"2026-02-16T01:40:02.437Z","uuid":"4e661793-15b8-4679-a822-d13c1003ccb0"}
{"parentUuid":"708b4daa-77db-4a65-a802-5986642713fc","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_013SxzaMdCmgtpTTspJc4Zcm","type":"tool_result","content":"38:  bookTitle?: string;\n51:  bookBasePath?: string;\n59:  bookTitle,\n71:  bookBasePath,\n79:        bookTitle={bookTitle}\n90:        bookBasePath={bookBasePath}\n102:      bookTitle={bookTitle}\n109:      bookBasePath={bookBasePath}\n209:  bookTitle?: string;\n216:  bookBasePath?: string;\n223:  bookTitle,\n230:  bookBasePath,\n437:                  href={`${bookBasePath || \"\"}/${ch.slug}`}\n489:          {bookTitle && (\n500:              {bookTitle}\n694:  bookTitle?: string;\n705:  bookBasePath?: string;\n721:  bookTitle,\n732:  bookBasePath,\n1094:    if (!isMultiChapter || chapterRanges.length === 0 || !bookBasePath) return;\n\n[Showing results with pagination = limit: 20, offset: 0]"}]},"uuid":"13fbdc00-4deb-47eb-b343-3c1341b0d61c","timestamp":"2026-02-16T01:40:02.436Z","toolUseResult":{"mode":"content","numFiles":0,"filenames":[],"content":"38:  bookTitle?: string;\n51:  bookBasePath?: string;\n59:  bookTitle,\n71:  bookBasePath,\n79:        bookTitle={bookTitle}\n90:        bookBasePath={bookBasePath}\n102:      bookTitle={bookTitle}\n109:      bookBasePath={bookBasePath}\n209:  bookTitle?: string;\n216:  bookBasePath?: string;\n223:  bookTitle,\n230:  bookBasePath,\n437:                  href={`${bookBasePath || \"\"}/${ch.slug}`}\n489:          {bookTitle && (\n500:              {bookTitle}\n694:  bookTitle?: string;\n705:  bookBasePath?: string;\n721:  bookTitle,\n732:  bookBasePath,\n1094:    if (!isMultiChapter || chapterRanges.length === 0 || !bookBasePath) return;","numLines":20,"appliedLimit":20},"sourceToolAssistantUUID":"708b4daa-77db-4a65-a802-5986642713fc"}
{"parentUuid":"13fbdc00-4deb-47eb-b343-3c1341b0d61c","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","message":{"model":"claude-opus-4-6","id":"msg_01Q2vkMq69WeehrdbCptebme","type":"message","role":"assistant","content":[{"type":"text","text":"Good — `bookTitle` and `bookBasePath` are both available. The home page is one level up from `bookBasePath` (e.g. `bookBasePath` = `/books/flatland`, home = `/`). Let me check how `bookBasePath` is constructed to understand the home link."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":420,"cache_read_input_tokens":50211,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":420},"output_tokens":1,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CYAttkgHg2NVAKNLeyjTg","type":"assistant","uuid":"636eed96-fcdb-4a59-8e65-6bda37538443","timestamp":"2026-02-16T01:40:06.544Z"}
{"parentUuid":"636eed96-fcdb-4a59-8e65-6bda37538443","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","message":{"model":"claude-opus-4-6","id":"msg_01Q2vkMq69WeehrdbCptebme","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_011LS9NfwsDA7JALRQctszrK","name":"Read","input":{"file_path":"/Users/blittle/dev/pressy/packages/@pressy/components/src/Reader.tsx","offset":485,"limit":25},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":420,"cache_read_input_tokens":50211,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":420},"output_tokens":1,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CYAttkgHg2NVAKNLeyjTg","type":"assistant","uuid":"c0d2c42e-faab-4722-b8cd-e66e2571683b","timestamp":"2026-02-16T01:40:07.351Z"}
{"parentUuid":"c0d2c42e-faab-4722-b8cd-e66e2571683b","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","type":"progress","data":{"type":"hook_progress","hookEvent":"PostToolUse","hookName":"PostToolUse:Read","command":"callback"},"parentToolUseID":"toolu_011LS9NfwsDA7JALRQctszrK","toolUseID":"toolu_011LS9NfwsDA7JALRQctszrK","timestamp":"2026-02-16T01:40:07.386Z","uuid":"211acc8f-1763-4c8a-8cdb-6010a08729bf"}
{"parentUuid":"c0d2c42e-faab-4722-b8cd-e66e2571683b","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_011LS9NfwsDA7JALRQctszrK","type":"tool_result","content":"   485→                <line x1=\"3\" y1=\"18\" x2=\"21\" y2=\"18\" />\n   486→              </svg>\n   487→            </button>\n   488→          )}\n   489→          {bookTitle && (\n   490→            <button\n   491→              class=\"pressy-footer-title\"\n   492→              onClick={(e: MouseEvent) => {\n   493→                e.stopPropagation();\n   494→                if (allChapters && allChapters.length > 0) {\n   495→                  setSettingsOpen(false);\n   496→                  setTocOpen(!tocOpen);\n   497→                }\n   498→              }}\n   499→            >\n   500→              {bookTitle}\n   501→            </button>\n   502→          )}\n   503→          <OfflineFooterIcon offlineProps={offlineProps} />\n   504→          <button\n   505→            class=\"pressy-settings-toggle\"\n   506→            onClick={(e: MouseEvent) => {\n   507→              e.stopPropagation();\n   508→              setTocOpen(false);\n   509→              setSettingsOpen(!settingsOpen);"}]},"uuid":"6b43e1e3-b8cf-40b9-ae7a-99d89eb29fc0","timestamp":"2026-02-16T01:40:07.385Z","toolUseResult":{"type":"text","file":{"filePath":"/Users/blittle/dev/pressy/packages/@pressy/components/src/Reader.tsx","content":"                <line x1=\"3\" y1=\"18\" x2=\"21\" y2=\"18\" />\n              </svg>\n            </button>\n          )}\n          {bookTitle && (\n            <button\n              class=\"pressy-footer-title\"\n              onClick={(e: MouseEvent) => {\n                e.stopPropagation();\n                if (allChapters && allChapters.length > 0) {\n                  setSettingsOpen(false);\n                  setTocOpen(!tocOpen);\n                }\n              }}\n            >\n              {bookTitle}\n            </button>\n          )}\n          <OfflineFooterIcon offlineProps={offlineProps} />\n          <button\n            class=\"pressy-settings-toggle\"\n            onClick={(e: MouseEvent) => {\n              e.stopPropagation();\n              setTocOpen(false);\n              setSettingsOpen(!settingsOpen);","numLines":25,"startLine":485,"totalLines":2966}},"sourceToolAssistantUUID":"c0d2c42e-faab-4722-b8cd-e66e2571683b"}
{"parentUuid":"6b43e1e3-b8cf-40b9-ae7a-99d89eb29fc0","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","message":{"model":"claude-opus-4-6","id":"msg_01AJ7GJ9sqjH8XL7pgU9RSqb","type":"message","role":"assistant","content":[{"type":"text","text":"Now I understand the structure. Both TOC drawers have the same pattern — a `<nav class=\"pressy-toc-list\">` with chapter links. I need to add a home link at the top of each. The home path can be derived from `bookBasePath` by going up one level (removing `/books/slug`), or more simply, `bookBasePath` already ends at `/books/<slug>` so going up two segments gives the base. Let me check exactly."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":593,"cache_read_input_tokens":50631,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":593},"output_tokens":4,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CYAtu8NmBKKk7Qf7Bz5Tq","type":"assistant","uuid":"3bea2fc7-fedd-4e12-acad-d55238a9481a","timestamp":"2026-02-16T01:40:12.677Z"}
{"parentUuid":"3bea2fc7-fedd-4e12-acad-d55238a9481a","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","message":{"model":"claude-opus-4-6","id":"msg_01AJ7GJ9sqjH8XL7pgU9RSqb","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01YMBFriLjWrrdbminytqHvp","name":"Grep","input":{"pattern":"bookBasePath.*=","path":"/Users/blittle/dev/pressy/packages/pressy/src/runtime/client.tsx","output_mode":"content","-n":true},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":593,"cache_read_input_tokens":50631,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":593},"output_tokens":4,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CYAtu8NmBKKk7Qf7Bz5Tq","type":"assistant","uuid":"cfa93e35-6e4f-41cf-8845-e959dd7973f7","timestamp":"2026-02-16T01:40:13.631Z"}
{"parentUuid":"cfa93e35-6e4f-41cf-8845-e959dd7973f7","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","type":"progress","data":{"type":"hook_progress","hookEvent":"PostToolUse","hookName":"PostToolUse:Grep","command":"callback"},"parentToolUseID":"toolu_01YMBFriLjWrrdbminytqHvp","toolUseID":"toolu_01YMBFriLjWrrdbminytqHvp","timestamp":"2026-02-16T01:40:13.896Z","uuid":"db8895f0-45bd-4bbe-87dd-80491158cd68"}
{"parentUuid":"cfa93e35-6e4f-41cf-8845-e959dd7973f7","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01YMBFriLjWrrdbminytqHvp","type":"tool_result","content":"480:      bookBasePath={`${basePath}/books/${book.slug}`}"}]},"uuid":"c4babb33-e840-40df-a089-939747c14259","timestamp":"2026-02-16T01:40:13.895Z","toolUseResult":{"mode":"content","numFiles":0,"filenames":[],"content":"480:      bookBasePath={`${basePath}/books/${book.slug}`}","numLines":1},"sourceToolAssistantUUID":"cfa93e35-6e4f-41cf-8845-e959dd7973f7"}
{"parentUuid":"c4babb33-e840-40df-a089-939747c14259","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","message":{"model":"claude-opus-4-6","id":"msg_01XvsUwjshoQWUC8XkPXMsjy","type":"message","role":"assistant","content":[{"type":"text","text":"So `bookBasePath` is like `/books/flatland` or `/prefix/books/flatland`. The home page is `basePath`, which would be everything before `/books/slug`. I can derive it: `bookBasePath.replace(/\\/books\\/[^/]+$/, '') || '/'`.\n\nNow I'll add the home link to both TOC drawers. I'll add it as the first item in the `<nav>` list, styled distinctly."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":269,"cache_read_input_tokens":51224,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":269},"output_tokens":1,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CYAtubZdgjYg7wyDNDQc2","type":"assistant","uuid":"c546d514-b1dc-4f00-ba3f-10bb347562e0","timestamp":"2026-02-16T01:40:18.726Z"}
{"parentUuid":"c546d514-b1dc-4f00-ba3f-10bb347562e0","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","message":{"model":"claude-opus-4-6","id":"msg_01XvsUwjshoQWUC8XkPXMsjy","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01Rpnx4p4eWmYsyjcpVWnged","name":"Edit","input":{"replace_all":false,"file_path":"/Users/blittle/dev/pressy/packages/@pressy/components/src/Reader.tsx","old_string":"            <nav class=\"pressy-toc-list\">\n              {allChapters.map((ch, i) => (\n                <a\n                  key={ch.slug}\n                  href={`${bookBasePath || \"\"}/${ch.slug}`}\n                  class={`pressy-toc-item ${\n                    ch.slug === currentChapterSlug\n                      ? \"pressy-toc-item--active\"\n                      : \"\"\n                  }`}\n                  onClick={() => setTocOpen(false)}\n                >\n                  <span class=\"pressy-toc-item-num\">{i + 1}.</span>\n                  <span class=\"pressy-toc-item-title\">{ch.title}</span>\n                </a>\n              ))}\n            </nav>","new_string":"            <nav class=\"pressy-toc-list\">\n              <a\n                href={bookBasePath ? bookBasePath.replace(/\\/books\\/[^/]+$/, '') || '/' : '/'}\n                class=\"pressy-toc-item pressy-toc-item--home\"\n                onClick={() => setTocOpen(false)}\n              >\n                <span class=\"pressy-toc-item-num\">\n                  <svg viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" width=\"14\" height=\"14\">\n                    <path d=\"M3 9.5L12 3l9 6.5V20a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V9.5z\" />\n                  </svg>\n                </span>\n                <span class=\"pressy-toc-item-title\">{bookTitle || 'Home'}</span>\n              </a>\n              {allChapters.map((ch, i) => (\n                <a\n                  key={ch.slug}\n                  href={`${bookBasePath || \"\"}/${ch.slug}`}\n                  class={`pressy-toc-item ${\n                    ch.slug === currentChapterSlug\n                      ? \"pressy-toc-item--active\"\n                      : \"\"\n                  }`}\n                  onClick={() => setTocOpen(false)}\n                >\n                  <span class=\"pressy-toc-item-num\">{i + 1}.</span>\n                  <span class=\"pressy-toc-item-title\">{ch.title}</span>\n                </a>\n              ))}\n            </nav>"},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":269,"cache_read_input_tokens":51224,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":269},"output_tokens":1,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CYAtubZdgjYg7wyDNDQc2","type":"assistant","uuid":"9aa7c10c-c197-4aeb-bdea-9f8ae4f4663b","timestamp":"2026-02-16T01:40:25.293Z"}
{"type":"file-history-snapshot","messageId":"9aa7c10c-c197-4aeb-bdea-9f8ae4f4663b","snapshot":{"messageId":"347f8dcf-cf87-4e89-8aac-12672170d553","trackedFileBackups":{"packages/pressy/src/runtime/offline.ts":{"backupFileName":"259b478c67f372e9@v2","version":2,"backupTime":"2026-02-16T01:34:16.305Z"},"packages/pressy/src/runtime/client.tsx":{"backupFileName":"553e6fae6ff514b2@v3","version":3,"backupTime":"2026-02-16T01:39:32.392Z"},"packages/@pressy/components/src/Reader.tsx":{"backupFileName":"04a3a173c9615dd4@v1","version":1,"backupTime":"2026-02-16T01:40:25.329Z"}},"timestamp":"2026-02-16T01:39:32.392Z"},"isSnapshotUpdate":true}
{"parentUuid":"9aa7c10c-c197-4aeb-bdea-9f8ae4f4663b","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","type":"progress","data":{"type":"hook_progress","hookEvent":"PostToolUse","hookName":"PostToolUse:Edit","command":"callback"},"parentToolUseID":"toolu_01Rpnx4p4eWmYsyjcpVWnged","toolUseID":"toolu_01Rpnx4p4eWmYsyjcpVWnged","timestamp":"2026-02-16T01:40:25.333Z","uuid":"9b33d60d-86be-4b4b-b50f-d7010b99b65b"}
{"parentUuid":"9aa7c10c-c197-4aeb-bdea-9f8ae4f4663b","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01Rpnx4p4eWmYsyjcpVWnged","type":"tool_result","content":"The file /Users/blittle/dev/pressy/packages/@pressy/components/src/Reader.tsx has been updated successfully."}]},"uuid":"68cd488d-84d5-4e6d-a01f-eae52f1862d0","timestamp":"2026-02-16T01:40:25.332Z","toolUseResult":{"filePath":"/Users/blittle/dev/pressy/packages/@pressy/components/src/Reader.tsx","oldString":"            <nav class=\"pressy-toc-list\">\n              {allChapters.map((ch, i) => (\n                <a\n                  key={ch.slug}\n                  href={`${bookBasePath || \"\"}/${ch.slug}`}\n                  class={`pressy-toc-item ${\n                    ch.slug === currentChapterSlug\n                      ? \"pressy-toc-item--active\"\n                      : \"\"\n                  }`}\n                  onClick={() => setTocOpen(false)}\n                >\n                  <span class=\"pressy-toc-item-num\">{i + 1}.</span>\n                  <span class=\"pressy-toc-item-title\">{ch.title}</span>\n                </a>\n              ))}\n            </nav>","newString":"            <nav class=\"pressy-toc-list\">\n              <a\n                href={bookBasePath ? bookBasePath.replace(/\\/books\\/[^/]+$/, '') || '/' : '/'}\n                class=\"pressy-toc-item pressy-toc-item--home\"\n                onClick={() => setTocOpen(false)}\n              >\n                <span class=\"pressy-toc-item-num\">\n                  <svg viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" width=\"14\" height=\"14\">\n                    <path d=\"M3 9.5L12 3l9 6.5V20a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V9.5z\" />\n                  </svg>\n                </span>\n                <span class=\"pressy-toc-item-title\">{bookTitle || 'Home'}</span>\n              </a>\n              {allChapters.map((ch, i) => (\n                <a\n                  key={ch.slug}\n                  href={`${bookBasePath || \"\"}/${ch.slug}`}\n                  class={`pressy-toc-item ${\n                    ch.slug === currentChapterSlug\n                      ? \"pressy-toc-item--active\"\n                      : \"\"\n                  }`}\n                  onClick={() => setTocOpen(false)}\n                >\n                  <span class=\"pressy-toc-item-num\">{i + 1}.</span>\n                  <span class=\"pressy-toc-item-title\">{ch.title}</span>\n                </a>\n              ))}\n            </nav>","originalFile":"import { ComponentChildren, ComponentType } from \"preact\";\nimport { useState, useEffect, useRef, useCallback } from \"preact/hooks\";\n\nimport { Navigation } from \"./Navigation.js\";\nimport { TextShare } from \"./TextShare.js\";\nimport { OfflineIndicator } from \"./OfflineIndicator.js\";\n\nexport interface ProgressData {\n  page: number;\n  totalPages: number;\n  scrollPosition: number;\n}\n\nexport interface ChapterMapData {\n  chapterMap: Record<\n    string,\n    () => Promise<{\n      default: ComponentType<{ components?: Record<string, unknown> }>;\n    }>\n  >;\n  chapterOrder: string[];\n}\n\nexport interface OfflineProps {\n  bookSlug: string;\n  chapterUrls: string[];\n  cachedBooks: { value: Set<string> };\n  cacheProgress: {\n    value: { bookSlug: string; current: number; total: number } | null;\n  };\n  onDownload: (bookSlug: string, chapterUrls: string[]) => void;\n  onRemove: (bookSlug: string) => void;\n}\n\nexport interface ReaderProps {\n  children: ComponentChildren;\n  title: string;\n  bookTitle?: string;\n  chapterSlug?: string;\n  prevChapter?: { slug: string; title: string };\n  nextChapter?: { slug: string; title: string };\n  showDropCap?: boolean;\n  paginationMode?: \"scroll\" | \"paginated\";\n  onSaveProgress?: (data: ProgressData) => void;\n  onRestoreProgress?: () => Promise<ProgressData | null>;\n  bookProgressPercent?: number;\n  initialContent?: ComponentType<{ components?: Record<string, unknown> }>;\n  chapterMapData?: ChapterMapData;\n  currentChapterSlug?: string;\n  allChapters?: Array<{ slug: string; title: string; wordCount?: number }>;\n  bookBasePath?: string;\n  onChapterChange?: (slug: string, page: number, totalPages: number) => void;\n  mdxComponents?: Record<string, unknown>;\n  offlineProps?: OfflineProps;\n}\n\nexport function Reader({\n  children,\n  bookTitle,\n  prevChapter,\n  nextChapter,\n  showDropCap = true,\n  paginationMode = \"scroll\",\n  onSaveProgress,\n  onRestoreProgress,\n  bookProgressPercent,\n  initialContent,\n  chapterMapData,\n  currentChapterSlug,\n  allChapters,\n  bookBasePath,\n  onChapterChange,\n  mdxComponents,\n  offlineProps,\n}: ReaderProps) {\n  if (paginationMode === \"paginated\") {\n    return (\n      <PaginatedReader\n        bookTitle={bookTitle}\n        prevChapter={prevChapter}\n        nextChapter={nextChapter}\n        showDropCap={showDropCap}\n        onSaveProgress={onSaveProgress}\n        onRestoreProgress={onRestoreProgress}\n        bookProgressPercent={bookProgressPercent}\n        initialContent={initialContent}\n        chapterMapData={chapterMapData}\n        currentChapterSlug={currentChapterSlug}\n        allChapters={allChapters}\n        bookBasePath={bookBasePath}\n        onChapterChange={onChapterChange}\n        mdxComponents={mdxComponents}\n        offlineProps={offlineProps}\n      >\n        {children}\n      </PaginatedReader>\n    );\n  }\n\n  return (\n    <ScrollReader\n      bookTitle={bookTitle}\n      prevChapter={prevChapter}\n      nextChapter={nextChapter}\n      showDropCap={showDropCap}\n      onSaveProgress={onSaveProgress}\n      onRestoreProgress={onRestoreProgress}\n      allChapters={allChapters}\n      bookBasePath={bookBasePath}\n      currentChapterSlug={currentChapterSlug}\n      offlineProps={offlineProps}\n    >\n      {children}\n    </ScrollReader>\n  );\n}\n\n// ── Offline Footer Icon ───────────────────────────────────────\n\nfunction OfflineFooterIcon({ offlineProps }: { offlineProps?: OfflineProps }) {\n  if (!offlineProps) return null;\n\n  const {\n    bookSlug,\n    chapterUrls,\n    cachedBooks,\n    onDownload,\n    onRemove,\n  } = offlineProps;\n\n  // Read signal .value directly in render — @preact/signals auto-subscribes\n  // and re-renders this component when the underlying signal changes.\n  const isCached = cachedBooks.value.has(bookSlug);\n\n  // Check isCached FIRST (matching DownloadBook's order). The download function\n  // optimistically marks the book as cached immediately, so isCached becomes true\n  // at the same time as isDownloading. Checking isCached first means we show the\n  // cached icon right away while the SW downloads in the background.\n  if (isCached) {\n    return (\n      <button\n        class=\"pressy-offline-icon pressy-offline-icon--cached\"\n        onClick={(e: MouseEvent) => {\n          e.stopPropagation();\n          onRemove(bookSlug);\n        }}\n        aria-label=\"Available offline. Click to remove.\"\n        title=\"Available offline. Click to remove.\"\n      >\n        <svg\n          viewBox=\"0 0 24 24\"\n          fill=\"none\"\n          stroke=\"currentColor\"\n          stroke-width=\"1.5\"\n          stroke-linecap=\"round\"\n          stroke-linejoin=\"round\"\n          width=\"18\"\n          height=\"18\"\n        >\n          <path d=\"M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z\" />\n          <polyline points=\"9 15 12 18 15 15\" />\n          <line x1=\"12\" y1=\"12\" x2=\"12\" y2=\"18\" />\n        </svg>\n        <svg\n          class=\"pressy-offline-check\"\n          viewBox=\"0 0 24 24\"\n          fill=\"currentColor\"\n          width=\"10\"\n          height=\"10\"\n        >\n          <path d=\"M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z\" />\n        </svg>\n      </button>\n    );\n  }\n\n  return (\n    <button\n      class=\"pressy-offline-icon\"\n      onClick={(e: MouseEvent) => {\n        e.stopPropagation();\n        onDownload(bookSlug, chapterUrls);\n      }}\n      aria-label=\"Download for offline reading\"\n      title=\"Download for offline reading\"\n    >\n      <svg\n        viewBox=\"0 0 24 24\"\n        fill=\"none\"\n        stroke=\"currentColor\"\n        stroke-width=\"1.5\"\n        stroke-linecap=\"round\"\n        stroke-linejoin=\"round\"\n        width=\"18\"\n        height=\"18\"\n      >\n        <path d=\"M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z\" />\n        <polyline points=\"9 15 12 18 15 15\" />\n        <line x1=\"12\" y1=\"12\" x2=\"12\" y2=\"18\" />\n      </svg>\n    </button>\n  );\n}\n\n// ── Scroll Reader ────────────────────────────────────────────\n\ninterface ScrollReaderProps {\n  children: ComponentChildren;\n  bookTitle?: string;\n  prevChapter?: { slug: string; title: string };\n  nextChapter?: { slug: string; title: string };\n  showDropCap: boolean;\n  onSaveProgress?: (data: ProgressData) => void;\n  onRestoreProgress?: () => Promise<ProgressData | null>;\n  allChapters?: Array<{ slug: string; title: string; wordCount?: number }>;\n  bookBasePath?: string;\n  currentChapterSlug?: string;\n  offlineProps?: OfflineProps;\n}\n\nfunction ScrollReader({\n  children,\n  bookTitle,\n  prevChapter,\n  nextChapter,\n  showDropCap,\n  onSaveProgress,\n  onRestoreProgress,\n  allChapters,\n  bookBasePath,\n  currentChapterSlug,\n  offlineProps,\n}: ScrollReaderProps) {\n  const saveTimerRef = useRef<ReturnType<typeof setTimeout> | null>(null);\n\n  // Footer visibility\n  const [footerVisible, setFooterVisible] = useState(false);\n  const footerTimerRef = useRef<ReturnType<typeof setTimeout> | null>(null);\n  const [settingsOpen, setSettingsOpen] = useState(false);\n  const [tocOpen, setTocOpen] = useState(false);\n\n  const showFooterTemporarily = useCallback(() => {\n    setFooterVisible(true);\n    if (footerTimerRef.current) clearTimeout(footerTimerRef.current);\n    footerTimerRef.current = setTimeout(() => setFooterVisible(false), 3000);\n  }, []);\n\n  // Settings state\n  const [activeTheme, setActiveTheme] = useState<string>(() => {\n    if (typeof localStorage !== \"undefined\") {\n      return localStorage.getItem(\"pressy-theme\") || \"light\";\n    }\n    return \"light\";\n  });\n  const [fontScale, setFontScale] = useState<number>(() => {\n    if (typeof localStorage !== \"undefined\") {\n      const saved = localStorage.getItem(\"pressy-font-size\");\n      return saved ? parseFloat(saved) : 1.0;\n    }\n    return 1.0;\n  });\n\n  const applyFontScale = useCallback((scale: number) => {\n    if (scale === 1.0) {\n      document.documentElement.style.removeProperty(\"--font-size-base\");\n    } else {\n      document.documentElement.style.setProperty(\n        \"--font-size-base\",\n        `calc(clamp(1rem, 0.875rem + 0.5vw, 1.25rem) * ${scale})`\n      );\n    }\n  }, []);\n\n  useEffect(() => {\n    if (fontScale !== 1.0) {\n      applyFontScale(fontScale);\n    }\n  }, []);\n\n  const handleThemeChange = useCallback((theme: string) => {\n    setActiveTheme(theme);\n    localStorage.setItem(\"pressy-theme\", theme);\n    const resolved =\n      theme === \"system\"\n        ? window.matchMedia(\"(prefers-color-scheme: dark)\").matches\n          ? \"dark\"\n          : \"light\"\n        : theme;\n    document.documentElement.setAttribute(\"data-theme\", resolved);\n  }, []);\n\n  const handleFontSizeChange = useCallback(\n    (delta: number) => {\n      setFontScale((prev) => {\n        const next =\n          Math.round(Math.max(0.8, Math.min(1.5, prev + delta)) * 10) / 10;\n        localStorage.setItem(\"pressy-font-size\", String(next));\n        applyFontScale(next);\n        return next;\n      });\n    },\n    [applyFontScale]\n  );\n\n  // Toggle footer on tap\n  const handleReaderClick = useCallback(\n    (e: MouseEvent) => {\n      const target = e.target as HTMLElement;\n      if (\n        target.closest(\n          \".pressy-page-footer, .pressy-toc-backdrop, .pressy-toc-toggle\"\n        )\n      )\n        return;\n      if (target.closest('a, button, input, select, textarea, [role=\"button\"]'))\n        return;\n\n      if (settingsOpen || tocOpen) {\n        setSettingsOpen(false);\n        setTocOpen(false);\n        return;\n      }\n\n      if (footerVisible) {\n        setFooterVisible(false);\n        if (footerTimerRef.current) clearTimeout(footerTimerRef.current);\n      } else {\n        showFooterTemporarily();\n      }\n    },\n    [footerVisible, settingsOpen, tocOpen, showFooterTemporarily]\n  );\n\n  // Restore scroll position on mount\n  useEffect(() => {\n    if (!onRestoreProgress) return;\n    onRestoreProgress().then((data) => {\n      if (data && data.scrollPosition > 0) {\n        window.scrollTo(0, data.scrollPosition);\n      }\n    });\n  }, []);\n\n  // Save scroll position (debounced)\n  useEffect(() => {\n    if (!onSaveProgress) return;\n\n    const handleScroll = () => {\n      if (saveTimerRef.current) clearTimeout(saveTimerRef.current);\n      saveTimerRef.current = setTimeout(() => {\n        onSaveProgress({\n          page: 0,\n          totalPages: 0,\n          scrollPosition: window.scrollY,\n        });\n      }, 500);\n    };\n\n    window.addEventListener(\"scroll\", handleScroll, { passive: true });\n    return () => {\n      window.removeEventListener(\"scroll\", handleScroll);\n      if (saveTimerRef.current) clearTimeout(saveTimerRef.current);\n    };\n  }, [onSaveProgress]);\n\n  // Save on page unload\n  useEffect(() => {\n    if (!onSaveProgress) return;\n\n    const handleUnload = () => {\n      onSaveProgress({\n        page: 0,\n        totalPages: 0,\n        scrollPosition: window.scrollY,\n      });\n    };\n\n    window.addEventListener(\"beforeunload\", handleUnload);\n    return () => window.removeEventListener(\"beforeunload\", handleUnload);\n  }, [onSaveProgress]);\n\n  return (\n    <div class=\"pressy-reader\" onClick={handleReaderClick}>\n      <main class=\"pressy-reader-main\">\n        <article\n          class={`pressy-prose ${showDropCap ? \"\" : \"no-drop-cap\"}`}\n          data-drop-cap={showDropCap}\n        >\n          {children}\n        </article>\n      </main>\n\n      <TextShare />\n      <Navigation prev={prevChapter} next={nextChapter} />\n      <OfflineIndicator />\n\n      {/* TOC drawer overlay */}\n      {tocOpen && allChapters && (\n        <div\n          class=\"pressy-toc-backdrop pressy-toc-backdrop--scroll\"\n          onClick={(e: MouseEvent) => {\n            e.stopPropagation();\n            setTocOpen(false);\n          }}\n        >\n          <div\n            class=\"pressy-toc-drawer\"\n            onClick={(e: MouseEvent) => e.stopPropagation()}\n          >\n            <div class=\"pressy-toc-header\">\n              <span class=\"pressy-toc-title\">Contents</span>\n              <button\n                class=\"pressy-toc-close\"\n                onClick={(e: MouseEvent) => {\n                  e.stopPropagation();\n                  setTocOpen(false);\n                }}\n                aria-label=\"Close table of contents\"\n              >\n                <svg\n                  viewBox=\"0 0 24 24\"\n                  fill=\"none\"\n                  stroke=\"currentColor\"\n                  stroke-width=\"2\"\n                  width=\"18\"\n                  height=\"18\"\n                >\n                  <line x1=\"18\" y1=\"6\" x2=\"6\" y2=\"18\" />\n                  <line x1=\"6\" y1=\"6\" x2=\"18\" y2=\"18\" />\n                </svg>\n              </button>\n            </div>\n            <nav class=\"pressy-toc-list\">\n              {allChapters.map((ch, i) => (\n                <a\n                  key={ch.slug}\n                  href={`${bookBasePath || \"\"}/${ch.slug}`}\n                  class={`pressy-toc-item ${\n                    ch.slug === currentChapterSlug\n                      ? \"pressy-toc-item--active\"\n                      : \"\"\n                  }`}\n                  onClick={() => setTocOpen(false)}\n                >\n                  <span class=\"pressy-toc-item-num\">{i + 1}.</span>\n                  <span class=\"pressy-toc-item-title\">{ch.title}</span>\n                </a>\n              ))}\n            </nav>\n          </div>\n        </div>\n      )}\n\n      {/* Footer */}\n      <div\n        class={`pressy-page-footer pressy-page-footer--scroll ${\n          footerVisible || settingsOpen || tocOpen\n            ? \"pressy-page-footer--visible\"\n            : \"\"\n        }`}\n      >\n        <div class=\"pressy-footer-row\">\n          {allChapters && allChapters.length > 0 && (\n            <button\n              class=\"pressy-toc-toggle\"\n              onClick={(e: MouseEvent) => {\n                e.stopPropagation();\n                setSettingsOpen(false);\n                setTocOpen(!tocOpen);\n              }}\n              aria-label=\"Table of contents\"\n            >\n              <svg\n                viewBox=\"0 0 24 24\"\n                fill=\"none\"\n                stroke=\"currentColor\"\n                stroke-width=\"1.5\"\n                stroke-linecap=\"round\"\n                stroke-linejoin=\"round\"\n                width=\"18\"\n                height=\"18\"\n              >\n                <line x1=\"3\" y1=\"6\" x2=\"21\" y2=\"6\" />\n                <line x1=\"3\" y1=\"12\" x2=\"21\" y2=\"12\" />\n                <line x1=\"3\" y1=\"18\" x2=\"21\" y2=\"18\" />\n              </svg>\n            </button>\n          )}\n          {bookTitle && (\n            <button\n              class=\"pressy-footer-title\"\n              onClick={(e: MouseEvent) => {\n                e.stopPropagation();\n                if (allChapters && allChapters.length > 0) {\n                  setSettingsOpen(false);\n                  setTocOpen(!tocOpen);\n                }\n              }}\n            >\n              {bookTitle}\n            </button>\n          )}\n          <OfflineFooterIcon offlineProps={offlineProps} />\n          <button\n            class=\"pressy-settings-toggle\"\n            onClick={(e: MouseEvent) => {\n              e.stopPropagation();\n              setTocOpen(false);\n              setSettingsOpen(!settingsOpen);\n            }}\n            aria-label=\"Settings\"\n          >\n            <svg\n              viewBox=\"0 0 24 24\"\n              fill=\"none\"\n              stroke=\"currentColor\"\n              stroke-width=\"1.5\"\n              stroke-linecap=\"round\"\n              stroke-linejoin=\"round\"\n              width=\"18\"\n              height=\"18\"\n            >\n              <circle cx=\"12\" cy=\"12\" r=\"3\" />\n              <path d=\"M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z\" />\n            </svg>\n          </button>\n        </div>\n\n        {/* Settings panel */}\n        <div\n          class={`pressy-settings-panel ${\n            settingsOpen ? \"pressy-settings-panel--open\" : \"\"\n          }`}\n        >\n          <div class=\"pressy-settings-section\">\n            <div class=\"pressy-settings-label\">Theme</div>\n            <div class=\"pressy-theme-options\">\n              {(\n                [\n                  {\n                    id: \"light\",\n                    label: \"Light\",\n                    icon: (\n                      <svg\n                        viewBox=\"0 0 24 24\"\n                        fill=\"none\"\n                        stroke=\"currentColor\"\n                        stroke-width=\"1.5\"\n                        width=\"16\"\n                        height=\"16\"\n                      >\n                        <circle cx=\"12\" cy=\"12\" r=\"5\" />\n                        <line x1=\"12\" y1=\"1\" x2=\"12\" y2=\"3\" />\n                        <line x1=\"12\" y1=\"21\" x2=\"12\" y2=\"23\" />\n                        <line x1=\"4.22\" y1=\"4.22\" x2=\"5.64\" y2=\"5.64\" />\n                        <line x1=\"18.36\" y1=\"18.36\" x2=\"19.78\" y2=\"19.78\" />\n                        <line x1=\"1\" y1=\"12\" x2=\"3\" y2=\"12\" />\n                        <line x1=\"21\" y1=\"12\" x2=\"23\" y2=\"12\" />\n                        <line x1=\"4.22\" y1=\"19.78\" x2=\"5.64\" y2=\"18.36\" />\n                        <line x1=\"18.36\" y1=\"5.64\" x2=\"19.78\" y2=\"4.22\" />\n                      </svg>\n                    ),\n                  },\n                  {\n                    id: \"dark\",\n                    label: \"Dark\",\n                    icon: (\n                      <svg\n                        viewBox=\"0 0 24 24\"\n                        fill=\"none\"\n                        stroke=\"currentColor\"\n                        stroke-width=\"1.5\"\n                        width=\"16\"\n                        height=\"16\"\n                      >\n                        <path d=\"M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z\" />\n                      </svg>\n                    ),\n                  },\n                  {\n                    id: \"system\",\n                    label: \"System\",\n                    icon: (\n                      <svg\n                        viewBox=\"0 0 24 24\"\n                        fill=\"none\"\n                        stroke=\"currentColor\"\n                        stroke-width=\"1.5\"\n                        width=\"16\"\n                        height=\"16\"\n                      >\n                        <rect\n                          x=\"2\"\n                          y=\"3\"\n                          width=\"20\"\n                          height=\"14\"\n                          rx=\"2\"\n                          ry=\"2\"\n                        />\n                        <line x1=\"8\" y1=\"21\" x2=\"16\" y2=\"21\" />\n                        <line x1=\"12\" y1=\"17\" x2=\"12\" y2=\"21\" />\n                      </svg>\n                    ),\n                  },\n                  {\n                    id: \"sepia\",\n                    label: \"Sepia\",\n                    icon: (\n                      <svg\n                        viewBox=\"0 0 24 24\"\n                        fill=\"none\"\n                        stroke=\"currentColor\"\n                        stroke-width=\"1.5\"\n                        width=\"16\"\n                        height=\"16\"\n                      >\n                        <path d=\"M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z\" />\n                        <path d=\"M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z\" />\n                      </svg>\n                    ),\n                  },\n                ] as const\n              ).map((t) => (\n                <button\n                  key={t.id}\n                  class={`pressy-theme-btn ${\n                    activeTheme === t.id ? \"pressy-theme-btn--active\" : \"\"\n                  }`}\n                  onClick={(e: MouseEvent) => {\n                    e.stopPropagation();\n                    handleThemeChange(t.id);\n                  }}\n                >\n                  {t.icon}\n                  <span>{t.label}</span>\n                </button>\n              ))}\n            </div>\n          </div>\n          <div class=\"pressy-settings-section\">\n            <div class=\"pressy-settings-label\">Font Size</div>\n            <div class=\"pressy-font-size-controls\">\n              <button\n                class=\"pressy-font-size-btn\"\n                onClick={(e: MouseEvent) => {\n                  e.stopPropagation();\n                  handleFontSizeChange(-0.1);\n                }}\n                disabled={fontScale <= 0.8}\n                aria-label=\"Decrease font size\"\n              >\n                A-\n              </button>\n              <span class=\"pressy-font-size-value\">\n                {Math.round(fontScale * 100)}%\n              </span>\n              <button\n                class=\"pressy-font-size-btn\"\n                onClick={(e: MouseEvent) => {\n                  e.stopPropagation();\n                  handleFontSizeChange(0.1);\n                }}\n                disabled={fontScale >= 1.5}\n                aria-label=\"Increase font size\"\n              >\n                A+\n              </button>\n            </div>\n          </div>\n        </div>\n      </div>\n\n      <style>{SCROLL_STYLES}</style>\n    </div>\n  );\n}\n\n// ── Paginated Reader ──────────────────────────────────────────\n\ninterface LoadedChapter {\n  slug: string;\n  title: string;\n  Content: ComponentType<{ components?: Record<string, unknown> }>;\n}\n\ninterface ChapterPageRange {\n  slug: string;\n  startPage: number;\n  endPage: number;\n}\n\ninterface PaginatedReaderProps {\n  children: ComponentChildren;\n  bookTitle?: string;\n  prevChapter?: { slug: string; title: string };\n  nextChapter?: { slug: string; title: string };\n  showDropCap: boolean;\n  onSaveProgress?: (data: ProgressData) => void;\n  onRestoreProgress?: () => Promise<ProgressData | null>;\n  bookProgressPercent?: number;\n  initialContent?: ComponentType<{ components?: Record<string, unknown> }>;\n  chapterMapData?: ChapterMapData;\n  currentChapterSlug?: string;\n  allChapters?: Array<{ slug: string; title: string; wordCount?: number }>;\n  bookBasePath?: string;\n  onChapterChange?: (slug: string, page: number, totalPages: number) => void;\n  mdxComponents?: Record<string, unknown>;\n  offlineProps?: OfflineProps;\n}\n\nfunction ChapterDivider({ title }: { title: string }) {\n  return (\n    <div class=\"pressy-chapter-divider\">\n      <h2 class=\"pressy-chapter-divider-title\">{title}</h2>\n    </div>\n  );\n}\n\nfunction PaginatedReader({\n  children,\n  bookTitle,\n  prevChapter,\n  nextChapter,\n  showDropCap,\n  onSaveProgress,\n  onRestoreProgress,\n  bookProgressPercent,\n  initialContent,\n  chapterMapData,\n  currentChapterSlug,\n  allChapters,\n  bookBasePath,\n  onChapterChange,\n  mdxComponents,\n  offlineProps,\n}: PaginatedReaderProps) {\n  const containerRef = useRef<HTMLDivElement>(null);\n  const viewportRef = useRef<HTMLDivElement>(null);\n  const articleRef = useRef<HTMLElement>(null);\n  const [currentPage, setCurrentPage] = useState(0);\n  const [totalPages, setTotalPages] = useState(1);\n  const hasRestoredRef = useRef(false);\n  const saveTimerRef = useRef<ReturnType<typeof setTimeout> | null>(null);\n\n  // Multi-chapter state\n  const [loadedChapters, setLoadedChapters] = useState<LoadedChapter[]>([]);\n  const [chapterRanges, setChapterRanges] = useState<ChapterPageRange[]>([]);\n  const [activeChapterSlug, setActiveChapterSlug] = useState(\n    currentChapterSlug || \"\"\n  );\n  const preloadingRef = useRef<Set<string>>(new Set());\n\n  // Whether we're in multi-chapter mode\n  const isMultiChapter = !!(\n    chapterMapData &&\n    initialContent &&\n    currentChapterSlug &&\n    allChapters\n  );\n\n  // Initialize loaded chapters\n  useEffect(() => {\n    if (isMultiChapter && initialContent && currentChapterSlug) {\n      const chapterInfo = allChapters!.find(\n        (ch) => ch.slug === currentChapterSlug\n      );\n      setLoadedChapters([\n        {\n          slug: currentChapterSlug,\n          title: chapterInfo?.title || currentChapterSlug,\n          Content: initialContent,\n        },\n      ]);\n      setActiveChapterSlug(currentChapterSlug);\n    }\n  }, []); // Only on mount\n\n  // Settings & TOC panel state\n  const [settingsOpen, setSettingsOpen] = useState(false);\n  const [tocOpen, setTocOpen] = useState(false);\n  const [activeTheme, setActiveTheme] = useState<string>(() => {\n    if (typeof localStorage !== \"undefined\") {\n      return localStorage.getItem(\"pressy-theme\") || \"light\";\n    }\n    return \"light\";\n  });\n  const [fontScale, setFontScale] = useState<number>(() => {\n    if (typeof localStorage !== \"undefined\") {\n      const saved = localStorage.getItem(\"pressy-font-size\");\n      return saved ? parseFloat(saved) : 1.0;\n    }\n    return 1.0;\n  });\n\n  const applyFontScale = useCallback((scale: number) => {\n    if (scale === 1.0) {\n      document.documentElement.style.removeProperty(\"--font-size-base\");\n    } else {\n      document.documentElement.style.setProperty(\n        \"--font-size-base\",\n        `calc(clamp(1rem, 0.875rem + 0.5vw, 1.25rem) * ${scale})`\n      );\n    }\n  }, []);\n\n  // Apply saved font scale on mount\n  useEffect(() => {\n    if (fontScale !== 1.0) {\n      applyFontScale(fontScale);\n    }\n  }, []);\n\n  const handleThemeChange = useCallback((theme: string) => {\n    setActiveTheme(theme);\n    localStorage.setItem(\"pressy-theme\", theme);\n    const resolved =\n      theme === \"system\"\n        ? window.matchMedia(\"(prefers-color-scheme: dark)\").matches\n          ? \"dark\"\n          : \"light\"\n        : theme;\n    document.documentElement.setAttribute(\"data-theme\", resolved);\n  }, []);\n\n  // Drag/swipe state\n  const [isDragging, setIsDragging] = useState(false);\n  const [dragOffset, setDragOffset] = useState(0);\n  const [chapterHint, setChapterHint] = useState<\"next\" | \"prev\" | null>(null);\n\n  // Touch tracking refs (avoid re-renders during drag)\n  const touchStartXRef = useRef(0);\n  const touchStartYRef = useRef(0);\n  const lastTouchXRef = useRef(0);\n  const lastTouchTimeRef = useRef(0);\n  const velocityRef = useRef(0);\n  const isSwipingRef = useRef(false);\n  const isDraggingRef = useRef(false);\n\n  // Build page-to-chapter map after recalculating pages\n  const updateChapterRanges = useCallback(() => {\n    if (!isMultiChapter) return;\n    const article = articleRef.current;\n    const viewport = viewportRef.current;\n    if (!article || !viewport) return;\n\n    const viewportWidth = viewport.clientWidth;\n    if (viewportWidth === 0) return;\n\n    const sections = article.querySelectorAll(\".pressy-chapter-section\");\n    const ranges: ChapterPageRange[] = [];\n\n    sections.forEach((section) => {\n      const slug = section.getAttribute(\"data-chapter-slug\") || \"\";\n      const sectionLeft = (section as HTMLElement).offsetLeft;\n      const sectionWidth = (section as HTMLElement).scrollWidth;\n      const startPage = Math.floor(sectionLeft / viewportWidth);\n      const endPage = Math.max(\n        startPage,\n        Math.ceil((sectionLeft + sectionWidth) / viewportWidth) - 1\n      );\n      ranges.push({ slug, startPage, endPage });\n    });\n\n    setChapterRanges(ranges);\n  }, [isMultiChapter]);\n\n  // Calculate page count and set column-width to match viewport\n  const recalculatePages = useCallback(() => {\n    const article = articleRef.current;\n    const viewport = viewportRef.current;\n    if (!article || !viewport) return;\n\n    const viewportWidth = viewport.clientWidth;\n    if (viewportWidth === 0) return;\n\n    // Set column-width to viewport width so each column = one page\n    article.style.columnWidth = `${viewportWidth}px`;\n\n    // Force synchronous layout recalculation\n    void article.scrollWidth;\n\n    const total = Math.max(1, Math.round(article.scrollWidth / viewportWidth));\n    setTotalPages(total);\n\n    // Clamp current page if now out of bounds (e.g. after resize)\n    setCurrentPage((prev) => Math.min(prev, total - 1));\n\n    // Update chapter ranges for multi-chapter mode\n    updateChapterRanges();\n  }, [updateChapterRanges]);\n\n  // Font size change handler (defined after recalculatePages)\n  const handleFontSizeChange = useCallback(\n    (delta: number) => {\n      setFontScale((prev) => {\n        const next =\n          Math.round(Math.max(0.8, Math.min(1.5, prev + delta)) * 10) / 10;\n        localStorage.setItem(\"pressy-font-size\", String(next));\n        applyFontScale(next);\n        setTimeout(() => recalculatePages(), 100);\n        return next;\n      });\n    },\n    [applyFontScale, recalculatePages]\n  );\n\n  // Recalculate on mount and on resize via ResizeObserver\n  useEffect(() => {\n    const viewport = viewportRef.current;\n    if (!viewport) return;\n\n    // Delay initial calculation to let fonts and content render\n    const initialTimer = setTimeout(recalculatePages, 50);\n\n    const observer = new ResizeObserver(() => {\n      recalculatePages();\n    });\n    observer.observe(viewport);\n\n    return () => {\n      clearTimeout(initialTimer);\n      observer.disconnect();\n    };\n  }, [recalculatePages]);\n\n  // Recalculate when loaded chapters change\n  useEffect(() => {\n    if (loadedChapters.length > 0) {\n      // Delay to let new content render\n      const timer = setTimeout(recalculatePages, 50);\n      return () => clearTimeout(timer);\n    }\n  }, [loadedChapters.length, recalculatePages]);\n\n  // Recalculate when images finish loading\n  useEffect(() => {\n    const article = articleRef.current;\n    if (!article) return;\n\n    const images = article.querySelectorAll(\"img\");\n    if (images.length === 0) return;\n\n    const onLoad = () => recalculatePages();\n    images.forEach((img) => {\n      if (!img.complete) {\n        img.addEventListener(\"load\", onLoad);\n        img.addEventListener(\"error\", onLoad);\n      }\n    });\n\n    return () => {\n      images.forEach((img) => {\n        img.removeEventListener(\"load\", onLoad);\n        img.removeEventListener(\"error\", onLoad);\n      });\n    };\n  }, [recalculatePages, loadedChapters.length]);\n\n  // Check ?page=last query param for backward navigation\n  useEffect(() => {\n    const params = new URLSearchParams(window.location.search);\n    if (params.get(\"page\") === \"last\" && totalPages > 1) {\n      setCurrentPage(totalPages - 1);\n      hasRestoredRef.current = true;\n      // Clean up the URL\n      const url = new URL(window.location.href);\n      url.searchParams.delete(\"page\");\n      history.replaceState(null, \"\", url.pathname);\n    }\n  }, [totalPages]);\n\n  // Apply translateX — combines page position + drag offset\n  useEffect(() => {\n    const article = articleRef.current;\n    const viewport = viewportRef.current;\n    if (!article || !viewport) return;\n\n    const baseOffset = currentPage * viewport.clientWidth;\n    const totalOffset = baseOffset - dragOffset;\n\n    if (isDragging) {\n      // During drag: no transition, immediate response\n      article.style.transition = \"none\";\n    } else {\n      // Snap animation: smooth ease-out\n      article.style.transition =\n        \"transform 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94)\";\n    }\n\n    article.style.transform = `translateX(-${totalOffset}px)`;\n  }, [currentPage, dragOffset, isDragging]);\n\n  // Manage focusability: elements on off-screen pages get tabindex=\"-1\"\n  // so tab navigation can't reach them and cause layout shifts.\n  // Uses getBoundingClientRect which accounts for the CSS transform.\n  useEffect(() => {\n    const article = articleRef.current;\n    const viewport = viewportRef.current;\n    if (!article || !viewport) return;\n\n    const viewportRect = viewport.getBoundingClientRect();\n\n    const focusable = article.querySelectorAll<HTMLElement>(\n      \"a[href], button, input, select, textarea, [tabindex]\"\n    );\n\n    focusable.forEach((el) => {\n      const elRect = el.getBoundingClientRect();\n      const onCurrentPage =\n        elRect.left >= viewportRect.left - 1 &&\n        elRect.right <= viewportRect.right + 1;\n\n      if (onCurrentPage) {\n        const original = el.getAttribute(\"data-original-tabindex\");\n        if (original !== null) {\n          if (original === \"\") {\n            el.removeAttribute(\"tabindex\");\n          } else {\n            el.setAttribute(\"tabindex\", original);\n          }\n          el.removeAttribute(\"data-original-tabindex\");\n        }\n      } else {\n        if (!el.hasAttribute(\"data-original-tabindex\")) {\n          el.setAttribute(\n            \"data-original-tabindex\",\n            el.getAttribute(\"tabindex\") || \"\"\n          );\n        }\n        el.setAttribute(\"tabindex\", \"-1\");\n      }\n    });\n  }, [currentPage, totalPages]);\n\n  // Preload next chapter when within 2 pages of chapter end\n  useEffect(() => {\n    if (!isMultiChapter || !chapterMapData || chapterRanges.length === 0)\n      return;\n\n    const activeRange = chapterRanges.find((r) => r.slug === activeChapterSlug);\n    if (!activeRange) return;\n\n    const pagesFromEnd = activeRange.endPage - currentPage;\n    if (pagesFromEnd > 2) return;\n\n    // Find the next chapter to preload\n    const { chapterOrder, chapterMap } = chapterMapData;\n    const lastLoadedSlug = loadedChapters[loadedChapters.length - 1]?.slug;\n    const lastLoadedIdx = chapterOrder.indexOf(lastLoadedSlug);\n    if (lastLoadedIdx === -1 || lastLoadedIdx >= chapterOrder.length - 1)\n      return;\n\n    const nextSlug = chapterOrder[lastLoadedIdx + 1];\n    if (preloadingRef.current.has(nextSlug)) return;\n    if (loadedChapters.some((ch) => ch.slug === nextSlug)) return;\n\n    preloadingRef.current.add(nextSlug);\n\n    const loader = chapterMap[nextSlug];\n    if (!loader) return;\n\n    loader()\n      .then((mod) => {\n        const Content = mod.default;\n        const chapterInfo = allChapters!.find((ch) => ch.slug === nextSlug);\n        setLoadedChapters((prev) => {\n          if (prev.some((ch) => ch.slug === nextSlug)) return prev;\n          return [\n            ...prev,\n            {\n              slug: nextSlug,\n              title: chapterInfo?.title || nextSlug,\n              Content,\n            },\n          ];\n        });\n      })\n      .catch(() => {\n        // Dynamic import failed — will fall back to full-page navigation\n        preloadingRef.current.delete(nextSlug);\n      });\n  }, [\n    currentPage,\n    activeChapterSlug,\n    chapterRanges,\n    isMultiChapter,\n    chapterMapData,\n    loadedChapters,\n    allChapters,\n  ]);\n\n  // Detect chapter boundary crossings and update URL / active chapter\n  useEffect(() => {\n    if (!isMultiChapter || chapterRanges.length === 0 || !bookBasePath) return;\n\n    const currentRange = chapterRanges.find(\n      (r) => currentPage >= r.startPage && currentPage <= r.endPage\n    );\n    if (!currentRange || currentRange.slug === activeChapterSlug) return;\n\n    const prevSlug = activeChapterSlug;\n    setActiveChapterSlug(currentRange.slug);\n\n    // Update URL\n    const newPath = `${bookBasePath}/${currentRange.slug}`;\n    history.replaceState(null, \"\", newPath);\n\n    // Update document title\n    const chapterInfo = allChapters?.find(\n      (ch) => ch.slug === currentRange.slug\n    );\n    if (chapterInfo) {\n      document.title = document.title.replace(\n        /^[^|]+/,\n        chapterInfo.title + \" \"\n      );\n    }\n\n    // Notify parent about chapter change (saves progress for the chapter being left)\n    if (onChapterChange && prevSlug) {\n      const prevRange = chapterRanges.find((r) => r.slug === prevSlug);\n      if (prevRange) {\n        const prevTotalPages = prevRange.endPage - prevRange.startPage + 1;\n        onChapterChange(prevSlug, prevTotalPages - 1, prevTotalPages);\n      }\n    }\n  }, [\n    currentPage,\n    chapterRanges,\n    activeChapterSlug,\n    isMultiChapter,\n    bookBasePath,\n    allChapters,\n    onChapterChange,\n  ]);\n\n  // Save progress when page changes (debounced) — save relative to active chapter\n  useEffect(() => {\n    if (!onSaveProgress || !hasRestoredRef.current) return;\n\n    if (saveTimerRef.current) clearTimeout(saveTimerRef.current);\n    saveTimerRef.current = setTimeout(() => {\n      if (isMultiChapter && chapterRanges.length > 0) {\n        const activeRange = chapterRanges.find(\n          (r) => r.slug === activeChapterSlug\n        );\n        if (activeRange) {\n          const chapterPage = currentPage - activeRange.startPage;\n          const chapterTotalPages =\n            activeRange.endPage - activeRange.startPage + 1;\n          onSaveProgress({\n            page: chapterPage,\n            totalPages: chapterTotalPages,\n            scrollPosition: 0,\n          });\n        }\n      } else {\n        onSaveProgress({\n          page: currentPage,\n          totalPages,\n          scrollPosition: 0,\n        });\n      }\n    }, 300);\n\n    return () => {\n      if (saveTimerRef.current) clearTimeout(saveTimerRef.current);\n    };\n  }, [\n    currentPage,\n    totalPages,\n    onSaveProgress,\n    isMultiChapter,\n    chapterRanges,\n    activeChapterSlug,\n  ]);\n\n  // Save progress on page unload\n  useEffect(() => {\n    if (!onSaveProgress) return;\n\n    const handleUnload = () => {\n      if (isMultiChapter && chapterRanges.length > 0) {\n        const activeRange = chapterRanges.find(\n          (r) => r.slug === activeChapterSlug\n        );\n        if (activeRange) {\n          const chapterPage = currentPage - activeRange.startPage;\n          const chapterTotalPages =\n            activeRange.endPage - activeRange.startPage + 1;\n          onSaveProgress({\n            page: chapterPage,\n            totalPages: chapterTotalPages,\n            scrollPosition: 0,\n          });\n        }\n      } else {\n        onSaveProgress({\n          page: currentPage,\n          totalPages,\n          scrollPosition: 0,\n        });\n      }\n    };\n\n    window.addEventListener(\"beforeunload\", handleUnload);\n    return () => window.removeEventListener(\"beforeunload\", handleUnload);\n  }, [\n    currentPage,\n    totalPages,\n    onSaveProgress,\n    isMultiChapter,\n    chapterRanges,\n    activeChapterSlug,\n  ]);\n\n  // Determine the effective last chapter slug for rubber-band / next chapter hint\n  const effectiveNextChapter = (() => {\n    if (!isMultiChapter || !chapterMapData) return nextChapter;\n    const { chapterOrder } = chapterMapData;\n    const lastLoadedSlug = loadedChapters[loadedChapters.length - 1]?.slug;\n    const lastLoadedIdx = chapterOrder.indexOf(lastLoadedSlug);\n    // If we haven't loaded the last chapter in the book yet, no next chapter hint needed\n    // (preloading will seamlessly add the next chapter)\n    if (lastLoadedIdx < chapterOrder.length - 1) return undefined;\n    // All chapters loaded — navigate to book table of contents\n    if (bookBasePath) return { slug: bookBasePath, title: \"Table of Contents\" };\n    return nextChapter;\n  })();\n\n  // Determine the effective prev chapter for backward navigation\n  const effectivePrevChapter = (() => {\n    if (!isMultiChapter || !chapterMapData) return prevChapter;\n    const { chapterOrder } = chapterMapData;\n    const firstLoadedSlug = loadedChapters[0]?.slug;\n    const firstLoadedIdx = chapterOrder.indexOf(firstLoadedSlug);\n    // If the first loaded chapter is the first chapter of the book\n    if (firstLoadedIdx <= 0) return prevChapter;\n    // There's a previous chapter in the book — navigate to it via page load\n    const prevSlug = chapterOrder[firstLoadedIdx - 1];\n    const prevInfo = allChapters?.find((ch) => ch.slug === prevSlug);\n    return {\n      slug: `${bookBasePath}/${prevSlug}?page=last`,\n      title: prevInfo?.title || prevSlug,\n    };\n  })();\n\n  const goToPage = useCallback(\n    (page: number) => {\n      const clamped = Math.max(0, Math.min(page, totalPages - 1));\n      setCurrentPage(clamped);\n    },\n    [totalPages]\n  );\n\n  const goNext = useCallback(() => {\n    if (currentPage >= totalPages - 1) {\n      // At the last page — navigate to next chapter if available\n      if (effectiveNextChapter) {\n        window.location.href = effectiveNextChapter.slug;\n      }\n      return;\n    }\n    goToPage(currentPage + 1);\n  }, [currentPage, totalPages, effectiveNextChapter, goToPage]);\n\n  const goPrev = useCallback(() => {\n    if (currentPage <= 0) {\n      // At the first page — navigate to prev chapter if available\n      if (effectivePrevChapter) {\n        window.location.href = effectivePrevChapter.slug;\n      }\n      return;\n    }\n    goToPage(currentPage - 1);\n  }, [currentPage, effectivePrevChapter, goToPage]);\n\n  // Footer visibility — hidden by default, shown on interaction\n  const [footerVisible, setFooterVisible] = useState(false);\n  const footerTimerRef = useRef<ReturnType<typeof setTimeout> | null>(null);\n\n  const showFooterTemporarily = useCallback(() => {\n    setFooterVisible(true);\n    if (footerTimerRef.current) clearTimeout(footerTimerRef.current);\n    footerTimerRef.current = setTimeout(() => setFooterVisible(false), 3000);\n  }, []);\n\n  // Double-tap fullscreen (mobile middle-third)\n  const lastMiddleTapRef = useRef(0);\n  const middleTapTimerRef = useRef<ReturnType<typeof setTimeout> | null>(null);\n\n  const toggleFullscreen = useCallback(() => {\n    if (document.fullscreenElement) {\n      document.exitFullscreen();\n    } else {\n      document.documentElement.requestFullscreen().catch(() => {\n        // Fullscreen not supported or denied\n      });\n    }\n  }, []);\n\n  // Whether the device supports hover (i.e. desktop with a mouse).\n  // Touch-only devices use swipe for page turns; tapping just toggles the footer.\n  const isTouchDevice =\n    typeof window !== \"undefined\" && window.matchMedia(\"(hover: none)\").matches;\n\n  // Click handler: on desktop, edge clicks turn pages and middle clicks\n  // toggle footer / double-click fullscreen. On touch devices, any tap\n  // simply toggles the footer — swiping handles all page navigation.\n  const handleContainerClick = useCallback(\n    (e: MouseEvent) => {\n      const target = e.target as HTMLElement;\n\n      // Clicks inside panels or on interactive elements — ignore\n      if (\n        target.closest(\n          \".pressy-settings-panel, .pressy-settings-toggle, .pressy-toc-drawer, .pressy-toc-toggle\"\n        )\n      )\n        return;\n      if (target.closest('a, button, input, select, textarea, [role=\"button\"]'))\n        return;\n\n      // If settings or TOC panel is open, close it on any outside click\n      if (settingsOpen || tocOpen) {\n        setSettingsOpen(false);\n        setTocOpen(false);\n        return;\n      }\n\n      // Touch devices: tap anywhere toggles the footer, nothing else\n      if (isTouchDevice) {\n        if (footerVisible) {\n          setFooterVisible(false);\n          if (footerTimerRef.current) clearTimeout(footerTimerRef.current);\n        } else {\n          showFooterTemporarily();\n        }\n        return;\n      }\n\n      // Desktop: edge clicks turn pages, middle clicks toggle footer / fullscreen\n      const container = containerRef.current;\n      if (!container) return;\n\n      const rect = container.getBoundingClientRect();\n      const x = e.clientX - rect.left;\n      const edgeZone = rect.width * 0.15;\n\n      if (x < edgeZone) {\n        goPrev();\n      } else if (x > rect.width - edgeZone) {\n        goNext();\n      } else {\n        // Middle third — single click toggles footer, double click toggles fullscreen\n        const now = Date.now();\n        const timeSinceLastTap = now - lastMiddleTapRef.current;\n        lastMiddleTapRef.current = now;\n\n        if (timeSinceLastTap < 300) {\n          if (middleTapTimerRef.current)\n            clearTimeout(middleTapTimerRef.current);\n          toggleFullscreen();\n        } else {\n          if (middleTapTimerRef.current)\n            clearTimeout(middleTapTimerRef.current);\n          middleTapTimerRef.current = setTimeout(() => {\n            if (footerVisible) {\n              setFooterVisible(false);\n              if (footerTimerRef.current) clearTimeout(footerTimerRef.current);\n            } else {\n              showFooterTemporarily();\n            }\n          }, 300);\n        }\n      }\n    },\n    [\n      goNext,\n      goPrev,\n      footerVisible,\n      isTouchDevice,\n      settingsOpen,\n      tocOpen,\n      showFooterTemporarily,\n      toggleFullscreen,\n    ]\n  );\n\n  // Hover zone tracking for desktop navigation hints\n  const [hoverZone, setHoverZone] = useState<\"left\" | \"right\" | null>(null);\n\n  const handleMouseMove = useCallback(\n    (e: MouseEvent) => {\n      const container = containerRef.current;\n      if (!container) return;\n\n      const rect = container.getBoundingClientRect();\n      const x = e.clientX - rect.left;\n      const y = e.clientY - rect.top;\n      const third = rect.width / 3;\n\n      if (x < third) {\n        setHoverZone(\"left\");\n      } else if (x > third * 2) {\n        setHoverZone(\"right\");\n      } else {\n        setHoverZone(null);\n      }\n\n      // Show footer when mouse is in the bottom quarter\n      if (y > rect.height * 0.75) {\n        setFooterVisible(true);\n        if (footerTimerRef.current) clearTimeout(footerTimerRef.current);\n      } else if (!settingsOpen && !tocOpen) {\n        // Hide after a short delay when leaving the bottom area (not when panels are open)\n        if (footerTimerRef.current) clearTimeout(footerTimerRef.current);\n        footerTimerRef.current = setTimeout(() => setFooterVisible(false), 600);\n      }\n    },\n    [settingsOpen, tocOpen]\n  );\n\n  const handleMouseLeave = useCallback(() => {\n    setHoverZone(null);\n    if (!settingsOpen && !tocOpen) {\n      if (footerTimerRef.current) clearTimeout(footerTimerRef.current);\n      footerTimerRef.current = setTimeout(() => setFooterVisible(false), 600);\n    }\n  }, [settingsOpen, tocOpen]);\n\n  // Keyboard navigation\n  useEffect(() => {\n    const handleKeyDown = (e: KeyboardEvent) => {\n      // Don't intercept if user is in an input/textarea\n      const tag = (e.target as HTMLElement).tagName;\n      if (tag === \"INPUT\" || tag === \"TEXTAREA\" || tag === \"SELECT\") return;\n\n      if (e.key === \"ArrowRight\" || e.key === \" \") {\n        e.preventDefault();\n        goNext();\n      } else if (e.key === \"ArrowLeft\") {\n        e.preventDefault();\n        goPrev();\n      } else if (e.key === \"Home\") {\n        e.preventDefault();\n        goToPage(0);\n      } else if (e.key === \"End\") {\n        e.preventDefault();\n        goToPage(totalPages - 1);\n      }\n    };\n\n    window.addEventListener(\"keydown\", handleKeyDown);\n    return () => window.removeEventListener(\"keydown\", handleKeyDown);\n  }, [goNext, goPrev, goToPage, totalPages]);\n\n  // Touch swipe navigation with drag tracking, velocity detection, and rubber-band.\n  // Listeners attach to the outer container (not the viewport) so they capture\n  // touches that land on sibling elements like the tap-zone overlays.\n  useEffect(() => {\n    const container = containerRef.current;\n    if (!container) return;\n\n    const onTouchStart = (e: TouchEvent) => {\n      const touch = e.touches[0];\n      touchStartXRef.current = touch.clientX;\n      touchStartYRef.current = touch.clientY;\n      lastTouchXRef.current = touch.clientX;\n      lastTouchTimeRef.current = performance.now();\n      velocityRef.current = 0;\n      isSwipingRef.current = false;\n      isDraggingRef.current = false;\n    };\n\n    const onTouchMove = (e: TouchEvent) => {\n      const touch = e.touches[0];\n      const dx = touch.clientX - touchStartXRef.current;\n      const dy = touch.clientY - touchStartYRef.current;\n\n      // Lock direction after initial movement\n      if (!isSwipingRef.current) {\n        if (Math.abs(dx) > Math.abs(dy) && Math.abs(dx) > 10) {\n          isSwipingRef.current = true;\n        } else if (Math.abs(dy) > Math.abs(dx) && Math.abs(dy) > 10) {\n          // Vertical scroll — not our concern\n          return;\n        } else {\n          return; // Not enough movement yet\n        }\n      }\n\n      e.preventDefault();\n\n      // Track velocity (px per ms) using last touch position\n      const now = performance.now();\n      const timeDelta = now - lastTouchTimeRef.current;\n      if (timeDelta > 0) {\n        const instantVelocity =\n          (touch.clientX - lastTouchXRef.current) / timeDelta;\n        // Smooth velocity with exponential moving average\n        velocityRef.current = 0.6 * instantVelocity + 0.4 * velocityRef.current;\n      }\n      lastTouchXRef.current = touch.clientX;\n      lastTouchTimeRef.current = now;\n\n      // Determine drag offset with rubber-band resistance at boundaries\n      let offset = dx;\n      const atStart = currentPage === 0;\n      const atEnd = currentPage >= totalPages - 1;\n\n      if ((atStart && dx > 0) || (atEnd && dx < 0)) {\n        // Rubber-band: diminishing resistance using square root curve\n        // This gives a natural iOS-like rubber-band feel\n        const sign = dx > 0 ? 1 : -1;\n        const absDx = Math.abs(dx);\n        offset = sign * Math.sqrt(absDx) * 5;\n\n        // Show chapter hint when overscrolling past boundary\n        if (dx > 40 && atStart && effectivePrevChapter) {\n          setChapterHint(\"prev\");\n        } else if (dx < -40 && atEnd && effectiveNextChapter) {\n          setChapterHint(\"next\");\n        } else {\n          setChapterHint(null);\n        }\n      } else {\n        setChapterHint(null);\n      }\n\n      isDraggingRef.current = true;\n      setIsDragging(true);\n      setDragOffset(offset);\n    };\n\n    const onTouchEnd = (e: TouchEvent) => {\n      if (!isSwipingRef.current || !isDraggingRef.current) {\n        setIsDragging(false);\n        setDragOffset(0);\n        setChapterHint(null);\n        return;\n      }\n\n      const dx = e.changedTouches[0].clientX - touchStartXRef.current;\n      const velocity = velocityRef.current; // px/ms\n      const distanceThreshold = 50;\n      const velocityThreshold = 0.3; // px/ms — a fast flick\n      const chapterThreshold = 80;\n\n      const atStart = currentPage === 0;\n      const atEnd = currentPage >= totalPages - 1;\n\n      // Chapter navigation on overscroll\n      if (atEnd && dx < -chapterThreshold && effectiveNextChapter) {\n        setIsDragging(false);\n        setDragOffset(0);\n        setChapterHint(null);\n        window.location.href = effectiveNextChapter.slug;\n        return;\n      }\n      if (atStart && dx > chapterThreshold && effectivePrevChapter) {\n        setIsDragging(false);\n        setDragOffset(0);\n        setChapterHint(null);\n        window.location.href = effectivePrevChapter.slug;\n        return;\n      }\n\n      // Determine page change: distance OR velocity triggers a turn\n      if (dx < -distanceThreshold || velocity < -velocityThreshold) {\n        goNext();\n      } else if (dx > distanceThreshold || velocity > velocityThreshold) {\n        goPrev();\n      }\n\n      // Reset drag state — the CSS transition handles the snap animation\n      isDraggingRef.current = false;\n      setIsDragging(false);\n      setDragOffset(0);\n      setChapterHint(null);\n    };\n\n    // Cancel drag if touch is interrupted\n    const onTouchCancel = () => {\n      isDraggingRef.current = false;\n      setIsDragging(false);\n      setDragOffset(0);\n      setChapterHint(null);\n    };\n\n    container.addEventListener(\"touchstart\", onTouchStart, { passive: true });\n    container.addEventListener(\"touchmove\", onTouchMove, { passive: false });\n    container.addEventListener(\"touchend\", onTouchEnd, { passive: true });\n    container.addEventListener(\"touchcancel\", onTouchCancel, { passive: true });\n\n    return () => {\n      container.removeEventListener(\"touchstart\", onTouchStart);\n      container.removeEventListener(\"touchmove\", onTouchMove);\n      container.removeEventListener(\"touchend\", onTouchEnd);\n      container.removeEventListener(\"touchcancel\", onTouchCancel);\n    };\n  }, [\n    currentPage,\n    totalPages,\n    goNext,\n    goPrev,\n    effectiveNextChapter,\n    effectivePrevChapter,\n  ]);\n\n  // Compute per-chapter page indicator values\n  const chapterPageInfo = (() => {\n    if (!isMultiChapter || chapterRanges.length === 0) {\n      return { chapterPage: currentPage, chapterTotalPages: totalPages };\n    }\n    const activeRange = chapterRanges.find((r) => r.slug === activeChapterSlug);\n    if (!activeRange) {\n      return { chapterPage: currentPage, chapterTotalPages: totalPages };\n    }\n    return {\n      chapterPage: currentPage - activeRange.startPage,\n      chapterTotalPages: activeRange.endPage - activeRange.startPage + 1,\n    };\n  })();\n\n  // Book progress: position in the entire book based on word counts.\n  // Maps currentPage/totalPages (across all loaded content) through\n  // word counts to estimate absolute position in the full book.\n  const progressPercent = (() => {\n    if (!allChapters || allChapters.length === 0) {\n      return totalPages > 1 ? (currentPage / (totalPages - 1)) * 100 : 100;\n    }\n\n    const totalWords = allChapters.reduce(\n      (sum, ch) => sum + (ch.wordCount || 0),\n      0\n    );\n    if (totalWords === 0) return 0;\n\n    const firstLoadedSlug = loadedChapters[0]?.slug || activeChapterSlug;\n    let wordsBeforeLoaded = 0;\n    let loadedWords = 0;\n    let foundFirst = false;\n\n    for (const ch of allChapters) {\n      if (ch.slug === firstLoadedSlug) foundFirst = true;\n      if (!foundFirst) {\n        wordsBeforeLoaded += ch.wordCount || 0;\n      } else if (loadedChapters.some((lc) => lc.slug === ch.slug)) {\n        loadedWords += ch.wordCount || 0;\n      } else {\n        break;\n      }\n    }\n\n    const pageFraction = totalPages > 1 ? currentPage / (totalPages - 1) : 0;\n    const wordsInto = wordsBeforeLoaded + pageFraction * loadedWords;\n\n    return Math.min(100, (wordsInto / totalWords) * 100);\n  })();\n\n  // Render content — either multi-chapter sections or single-chapter children\n  const renderContent = () => {\n    if (isMultiChapter && loadedChapters.length > 0) {\n      return loadedChapters.map((ch) => (\n        <section\n          key={ch.slug}\n          class=\"pressy-chapter-section\"\n          data-chapter-slug={ch.slug}\n        >\n          <ChapterDivider title={ch.title} />\n          <ch.Content components={mdxComponents || {}} />\n        </section>\n      ));\n    }\n    return children;\n  };\n\n  return (\n    <div\n      class=\"pressy-reader pressy-reader--paginated\"\n      ref={containerRef}\n      onClick={handleContainerClick}\n      onMouseMove={handleMouseMove}\n      onMouseLeave={handleMouseLeave}\n    >\n      {/* Paginated content viewport */}\n      <div class=\"pressy-paginated-viewport\" ref={viewportRef}>\n        <article\n          ref={articleRef}\n          class={`pressy-prose pressy-prose--paginated ${\n            showDropCap ? \"\" : \"no-drop-cap\"\n          }`}\n          data-drop-cap={showDropCap}\n        >\n          {renderContent()}\n        </article>\n      </div>\n\n      {/* Navigation arrows — appear on hover in left/right thirds */}\n      <div\n        class={`pressy-nav-arrow pressy-nav-arrow--prev ${\n          hoverZone === \"left\" ? \"pressy-nav-arrow--visible\" : \"\"\n        }`}\n      >\n        <svg\n          viewBox=\"0 0 24 24\"\n          fill=\"none\"\n          stroke=\"currentColor\"\n          stroke-width=\"2\"\n          stroke-linecap=\"round\"\n          stroke-linejoin=\"round\"\n        >\n          <polyline points=\"15 18 9 12 15 6\" />\n        </svg>\n      </div>\n      <div\n        class={`pressy-nav-arrow pressy-nav-arrow--next ${\n          hoverZone === \"right\" ? \"pressy-nav-arrow--visible\" : \"\"\n        }`}\n      >\n        <svg\n          viewBox=\"0 0 24 24\"\n          fill=\"none\"\n          stroke=\"currentColor\"\n          stroke-width=\"2\"\n          stroke-linecap=\"round\"\n          stroke-linejoin=\"round\"\n        >\n          <polyline points=\"9 6 15 12 9 18\" />\n        </svg>\n      </div>\n\n      {/* Chapter boundary hints */}\n      {chapterHint === \"prev\" && effectivePrevChapter && (\n        <div\n          class=\"pressy-chapter-hint pressy-chapter-hint--prev\"\n          aria-live=\"polite\"\n        >\n          <span class=\"pressy-chapter-hint-arrow\">{\"\\u2190\"}</span>\n          <span class=\"pressy-chapter-hint-text\">\n            {effectivePrevChapter.title}\n          </span>\n        </div>\n      )}\n      {chapterHint === \"next\" && effectiveNextChapter && (\n        <div\n          class=\"pressy-chapter-hint pressy-chapter-hint--next\"\n          aria-live=\"polite\"\n        >\n          <span class=\"pressy-chapter-hint-text\">\n            {effectiveNextChapter.title}\n          </span>\n          <span class=\"pressy-chapter-hint-arrow\">{\"\\u2192\"}</span>\n        </div>\n      )}\n\n      {/* TOC drawer overlay */}\n      {tocOpen && allChapters && (\n        <div\n          class=\"pressy-toc-backdrop\"\n          onClick={(e: MouseEvent) => {\n            e.stopPropagation();\n            setTocOpen(false);\n          }}\n        >\n          <div\n            class=\"pressy-toc-drawer\"\n            onClick={(e: MouseEvent) => e.stopPropagation()}\n          >\n            <div class=\"pressy-toc-header\">\n              <span class=\"pressy-toc-title\">Contents</span>\n              <button\n                class=\"pressy-toc-close\"\n                onClick={(e: MouseEvent) => {\n                  e.stopPropagation();\n                  setTocOpen(false);\n                }}\n                aria-label=\"Close table of contents\"\n              >\n                <svg\n                  viewBox=\"0 0 24 24\"\n                  fill=\"none\"\n                  stroke=\"currentColor\"\n                  stroke-width=\"2\"\n                  width=\"18\"\n                  height=\"18\"\n                >\n                  <line x1=\"18\" y1=\"6\" x2=\"6\" y2=\"18\" />\n                  <line x1=\"6\" y1=\"6\" x2=\"18\" y2=\"18\" />\n                </svg>\n              </button>\n            </div>\n            <nav class=\"pressy-toc-list\">\n              {allChapters.map((ch, i) => (\n                <a\n                  key={ch.slug}\n                  href={`${bookBasePath || \"\"}/${ch.slug}`}\n                  class={`pressy-toc-item ${\n                    ch.slug === (activeChapterSlug || currentChapterSlug)\n                      ? \"pressy-toc-item--active\"\n                      : \"\"\n                  }`}\n                  onClick={() => setTocOpen(false)}\n                >\n                  <span class=\"pressy-toc-item-num\">{i + 1}.</span>\n                  <span class=\"pressy-toc-item-title\">{ch.title}</span>\n                </a>\n              ))}\n            </nav>\n          </div>\n        </div>\n      )}\n\n      {/* Page footer with progress — hidden by default */}\n      <div\n        class={`pressy-page-footer ${\n          footerVisible || settingsOpen || tocOpen\n            ? \"pressy-page-footer--visible\"\n            : \"\"\n        }`}\n      >\n        <div class=\"pressy-progress-bar\">\n          <div\n            class=\"pressy-progress-fill\"\n            style={{ width: `${progressPercent}%` }}\n          />\n        </div>\n        <div class=\"pressy-footer-row\">\n          {allChapters && allChapters.length > 0 && (\n            <button\n              class=\"pressy-toc-toggle\"\n              onClick={(e: MouseEvent) => {\n                e.stopPropagation();\n                setSettingsOpen(false);\n                setTocOpen(!tocOpen);\n              }}\n              aria-label=\"Table of contents\"\n            >\n              <svg\n                viewBox=\"0 0 24 24\"\n                fill=\"none\"\n                stroke=\"currentColor\"\n                stroke-width=\"1.5\"\n                stroke-linecap=\"round\"\n                stroke-linejoin=\"round\"\n                width=\"18\"\n                height=\"18\"\n              >\n                <line x1=\"3\" y1=\"6\" x2=\"21\" y2=\"6\" />\n                <line x1=\"3\" y1=\"12\" x2=\"21\" y2=\"12\" />\n                <line x1=\"3\" y1=\"18\" x2=\"21\" y2=\"18\" />\n              </svg>\n            </button>\n          )}\n          {bookTitle && (\n            <button\n              class=\"pressy-footer-title\"\n              onClick={(e: MouseEvent) => {\n                e.stopPropagation();\n                if (allChapters && allChapters.length > 0) {\n                  setSettingsOpen(false);\n                  setTocOpen(!tocOpen);\n                }\n              }}\n            >\n              {bookTitle}\n            </button>\n          )}\n          <OfflineFooterIcon offlineProps={offlineProps} />\n          <button\n            class=\"pressy-settings-toggle\"\n            onClick={(e: MouseEvent) => {\n              e.stopPropagation();\n              setTocOpen(false);\n              setSettingsOpen(!settingsOpen);\n            }}\n            aria-label=\"Settings\"\n          >\n            <svg\n              viewBox=\"0 0 24 24\"\n              fill=\"none\"\n              stroke=\"currentColor\"\n              stroke-width=\"1.5\"\n              stroke-linecap=\"round\"\n              stroke-linejoin=\"round\"\n              width=\"18\"\n              height=\"18\"\n            >\n              <circle cx=\"12\" cy=\"12\" r=\"3\" />\n              <path d=\"M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z\" />\n            </svg>\n          </button>\n        </div>\n\n        {/* Settings panel */}\n        <div\n          class={`pressy-settings-panel ${\n            settingsOpen ? \"pressy-settings-panel--open\" : \"\"\n          }`}\n        >\n          <div class=\"pressy-settings-section\">\n            <div class=\"pressy-settings-label\">Theme</div>\n            <div class=\"pressy-theme-options\">\n              {(\n                [\n                  {\n                    id: \"light\",\n                    label: \"Light\",\n                    icon: (\n                      <svg\n                        viewBox=\"0 0 24 24\"\n                        fill=\"none\"\n                        stroke=\"currentColor\"\n                        stroke-width=\"1.5\"\n                        width=\"16\"\n                        height=\"16\"\n                      >\n                        <circle cx=\"12\" cy=\"12\" r=\"5\" />\n                        <line x1=\"12\" y1=\"1\" x2=\"12\" y2=\"3\" />\n                        <line x1=\"12\" y1=\"21\" x2=\"12\" y2=\"23\" />\n                        <line x1=\"4.22\" y1=\"4.22\" x2=\"5.64\" y2=\"5.64\" />\n                        <line x1=\"18.36\" y1=\"18.36\" x2=\"19.78\" y2=\"19.78\" />\n                        <line x1=\"1\" y1=\"12\" x2=\"3\" y2=\"12\" />\n                        <line x1=\"21\" y1=\"12\" x2=\"23\" y2=\"12\" />\n                        <line x1=\"4.22\" y1=\"19.78\" x2=\"5.64\" y2=\"18.36\" />\n                        <line x1=\"18.36\" y1=\"5.64\" x2=\"19.78\" y2=\"4.22\" />\n                      </svg>\n                    ),\n                  },\n                  {\n                    id: \"dark\",\n                    label: \"Dark\",\n                    icon: (\n                      <svg\n                        viewBox=\"0 0 24 24\"\n                        fill=\"none\"\n                        stroke=\"currentColor\"\n                        stroke-width=\"1.5\"\n                        width=\"16\"\n                        height=\"16\"\n                      >\n                        <path d=\"M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z\" />\n                      </svg>\n                    ),\n                  },\n                  {\n                    id: \"system\",\n                    label: \"System\",\n                    icon: (\n                      <svg\n                        viewBox=\"0 0 24 24\"\n                        fill=\"none\"\n                        stroke=\"currentColor\"\n                        stroke-width=\"1.5\"\n                        width=\"16\"\n                        height=\"16\"\n                      >\n                        <rect\n                          x=\"2\"\n                          y=\"3\"\n                          width=\"20\"\n                          height=\"14\"\n                          rx=\"2\"\n                          ry=\"2\"\n                        />\n                        <line x1=\"8\" y1=\"21\" x2=\"16\" y2=\"21\" />\n                        <line x1=\"12\" y1=\"17\" x2=\"12\" y2=\"21\" />\n                      </svg>\n                    ),\n                  },\n                  {\n                    id: \"sepia\",\n                    label: \"Sepia\",\n                    icon: (\n                      <svg\n                        viewBox=\"0 0 24 24\"\n                        fill=\"none\"\n                        stroke=\"currentColor\"\n                        stroke-width=\"1.5\"\n                        width=\"16\"\n                        height=\"16\"\n                      >\n                        <path d=\"M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z\" />\n                        <path d=\"M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z\" />\n                      </svg>\n                    ),\n                  },\n                ] as const\n              ).map((t) => (\n                <button\n                  key={t.id}\n                  class={`pressy-theme-btn ${\n                    activeTheme === t.id ? \"pressy-theme-btn--active\" : \"\"\n                  }`}\n                  onClick={(e: MouseEvent) => {\n                    e.stopPropagation();\n                    handleThemeChange(t.id);\n                  }}\n                >\n                  {t.icon}\n                  <span>{t.label}</span>\n                </button>\n              ))}\n            </div>\n          </div>\n          <div class=\"pressy-settings-section\">\n            <div class=\"pressy-settings-label\">Font Size</div>\n            <div class=\"pressy-font-size-controls\">\n              <button\n                class=\"pressy-font-size-btn\"\n                onClick={(e: MouseEvent) => {\n                  e.stopPropagation();\n                  handleFontSizeChange(-0.1);\n                }}\n                disabled={fontScale <= 0.8}\n                aria-label=\"Decrease font size\"\n              >\n                A-\n              </button>\n              <span class=\"pressy-font-size-value\">\n                {Math.round(fontScale * 100)}%\n              </span>\n              <button\n                class=\"pressy-font-size-btn\"\n                onClick={(e: MouseEvent) => {\n                  e.stopPropagation();\n                  handleFontSizeChange(0.1);\n                }}\n                disabled={fontScale >= 1.5}\n                aria-label=\"Increase font size\"\n              >\n                A+\n              </button>\n            </div>\n          </div>\n        </div>\n      </div>\n\n      <TextShare />\n      <OfflineIndicator />\n\n      <style>{PAGINATED_STYLES}</style>\n    </div>\n  );\n}\n\n// ── Styles ────────────────────────────────────────────────────\n\nconst SCROLL_STYLES = `\n  .pressy-reader {\n    min-height: 100vh;\n    display: flex;\n    flex-direction: column;\n  }\n\n  .pressy-reader-main {\n    flex: 1;\n    padding: 2rem 0;\n  }\n\n  /* ── Scroll reader footer ──────────────────────────────── */\n  .pressy-page-footer--scroll {\n    position: fixed;\n    bottom: 0;\n    left: 0;\n    right: 0;\n    padding: 0.5rem 1.5rem 1rem;\n    text-align: center;\n    user-select: none;\n    transform: translateY(100%);\n    opacity: 0;\n    transition: transform 0.25s ease, opacity 0.25s ease;\n    z-index: 15;\n    background: var(--color-bg, #ffffff);\n    box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.05);\n  }\n\n  .pressy-page-footer--scroll.pressy-page-footer--visible {\n    transform: translateY(0);\n    opacity: 1;\n  }\n\n  /* Shared footer styles for scroll reader */\n  .pressy-page-footer--scroll .pressy-footer-row {\n    display: flex;\n    align-items: center;\n    justify-content: space-between;\n    gap: 0.5rem;\n  }\n\n  .pressy-page-footer--scroll .pressy-footer-title {\n    font-family: var(--font-heading, system-ui, -apple-system, sans-serif);\n    font-size: 0.75rem;\n    color: var(--color-text-muted, #6c757d);\n    text-decoration: none;\n    overflow: hidden;\n    text-overflow: ellipsis;\n    white-space: nowrap;\n    min-width: 0;\n    flex: 1;\n    text-align: left;\n    border: none;\n    background: none;\n    cursor: pointer;\n    padding: 0;\n  }\n\n  .pressy-page-footer--scroll .pressy-footer-title:hover {\n    color: var(--color-text, #212529);\n  }\n\n  .pressy-page-footer--scroll .pressy-toc-toggle,\n  .pressy-page-footer--scroll .pressy-settings-toggle {\n    flex-shrink: 0;\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    width: 2rem;\n    height: 2rem;\n    border: none;\n    background: transparent;\n    color: var(--color-text-muted, #6c757d);\n    cursor: pointer;\n    border-radius: 0.375rem;\n    transition: color 0.15s, background 0.15s;\n    padding: 0;\n  }\n\n  .pressy-page-footer--scroll .pressy-toc-toggle:hover,\n  .pressy-page-footer--scroll .pressy-settings-toggle:hover {\n    color: var(--color-text, #212529);\n    background: var(--color-bg-subtle, #f8f9fa);\n  }\n\n  .pressy-page-footer--scroll .pressy-settings-panel {\n    overflow: hidden;\n    max-height: 0;\n    opacity: 0;\n    transition: max-height 0.25s ease, opacity 0.2s ease;\n    border-top: 0 solid var(--color-border, #dee2e6);\n  }\n\n  .pressy-page-footer--scroll .pressy-settings-panel--open {\n    max-height: 300px;\n    opacity: 1;\n    border-top-width: 1px;\n    margin-top: 0.5rem;\n    padding-top: 0.75rem;\n  }\n\n  .pressy-page-footer--scroll .pressy-settings-section {\n    margin-bottom: 0.75rem;\n  }\n\n  .pressy-page-footer--scroll .pressy-settings-section:last-child {\n    margin-bottom: 0;\n  }\n\n  .pressy-page-footer--scroll .pressy-settings-label {\n    font-family: var(--font-heading, system-ui, -apple-system, sans-serif);\n    font-size: 0.6875rem;\n    font-weight: 600;\n    text-transform: uppercase;\n    letter-spacing: 0.05em;\n    color: var(--color-text-muted, #6c757d);\n    margin-bottom: 0.5rem;\n    text-align: left;\n  }\n\n  .pressy-page-footer--scroll .pressy-theme-options {\n    display: flex;\n    gap: 0.375rem;\n  }\n\n  .pressy-page-footer--scroll .pressy-theme-btn {\n    flex: 1;\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    gap: 0.25rem;\n    padding: 0.375rem 0.5rem;\n    border: 1.5px solid var(--color-border, #dee2e6);\n    border-radius: 0.5rem;\n    background: transparent;\n    color: var(--color-text, #212529);\n    font-family: var(--font-heading, system-ui, -apple-system, sans-serif);\n    font-size: 0.6875rem;\n    cursor: pointer;\n    transition: border-color 0.15s, background 0.15s;\n  }\n\n  .pressy-page-footer--scroll .pressy-theme-btn:hover {\n    background: var(--color-bg-subtle, #f8f9fa);\n  }\n\n  .pressy-page-footer--scroll .pressy-theme-btn--active {\n    border-color: var(--color-accent, #212529);\n    background: var(--color-bg-subtle, #f8f9fa);\n    font-weight: 600;\n  }\n\n  .pressy-page-footer--scroll .pressy-font-size-controls {\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    gap: 1rem;\n  }\n\n  .pressy-page-footer--scroll .pressy-font-size-btn {\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    width: 2rem;\n    height: 2rem;\n    border: 1.5px solid var(--color-border, #dee2e6);\n    border-radius: 50%;\n    background: transparent;\n    color: var(--color-text, #212529);\n    font-family: var(--font-heading, system-ui, -apple-system, sans-serif);\n    font-size: 0.75rem;\n    font-weight: 600;\n    cursor: pointer;\n    transition: border-color 0.15s, background 0.15s;\n  }\n\n  .pressy-page-footer--scroll .pressy-font-size-btn:hover:not(:disabled) {\n    background: var(--color-bg-subtle, #f8f9fa);\n    border-color: var(--color-accent, #212529);\n  }\n\n  .pressy-page-footer--scroll .pressy-font-size-btn:disabled {\n    opacity: 0.3;\n    cursor: default;\n  }\n\n  .pressy-page-footer--scroll .pressy-font-size-value {\n    font-family: var(--font-heading, system-ui, -apple-system, sans-serif);\n    font-size: 0.8125rem;\n    font-weight: 500;\n    color: var(--color-text, #212529);\n    min-width: 3ch;\n    text-align: center;\n  }\n\n  /* ── TOC drawer for scroll reader ───────────────────────── */\n  .pressy-toc-backdrop--scroll {\n    position: fixed;\n    inset: 0;\n    background: rgba(0, 0, 0, 0.3);\n    z-index: 20;\n    display: flex;\n    align-items: flex-end;\n    animation: pressy-scroll-toc-fade-in 0.2s ease-out;\n  }\n\n  .pressy-toc-backdrop--scroll .pressy-toc-drawer {\n    width: 100%;\n    max-height: 70vh;\n    background: var(--color-bg, #ffffff);\n    border-radius: 1rem 1rem 0 0;\n    display: flex;\n    flex-direction: column;\n    animation: pressy-scroll-toc-slide-up 0.25s ease-out;\n    box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.1);\n  }\n\n  .pressy-toc-backdrop--scroll .pressy-toc-header {\n    display: flex;\n    align-items: center;\n    justify-content: space-between;\n    padding: 1rem 1.5rem 0.75rem;\n    border-bottom: 1px solid var(--color-border, #dee2e6);\n    flex-shrink: 0;\n  }\n\n  .pressy-toc-backdrop--scroll .pressy-toc-title {\n    font-family: var(--font-heading, system-ui, -apple-system, sans-serif);\n    font-size: 1rem;\n    font-weight: 600;\n    color: var(--color-text, #212529);\n  }\n\n  .pressy-toc-backdrop--scroll .pressy-toc-close {\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    width: 2rem;\n    height: 2rem;\n    border: none;\n    background: transparent;\n    color: var(--color-text-muted, #6c757d);\n    cursor: pointer;\n    border-radius: 0.375rem;\n    padding: 0;\n  }\n\n  .pressy-toc-backdrop--scroll .pressy-toc-close:hover {\n    color: var(--color-text, #212529);\n    background: var(--color-bg-subtle, #f8f9fa);\n  }\n\n  .pressy-toc-backdrop--scroll .pressy-toc-list {\n    overflow-y: auto;\n    padding: 0.5rem;\n    display: flex;\n    flex-direction: column;\n  }\n\n  .pressy-toc-backdrop--scroll .pressy-toc-item {\n    display: flex;\n    gap: 0.75rem;\n    padding: 0.625rem 1rem;\n    text-decoration: none;\n    color: var(--color-text, #212529);\n    border-radius: 0.5rem;\n    font-family: var(--font-heading, system-ui, -apple-system, sans-serif);\n    font-size: 0.875rem;\n    transition: background 0.15s;\n  }\n\n  .pressy-toc-backdrop--scroll .pressy-toc-item:hover {\n    background: var(--color-bg-subtle, #f5f5f5);\n  }\n\n  .pressy-toc-backdrop--scroll .pressy-toc-item--active {\n    background: var(--color-bg-subtle, #f5f5f5);\n    font-weight: 600;\n  }\n\n  .pressy-toc-backdrop--scroll .pressy-toc-item-num {\n    color: var(--color-text-muted, #6c757d);\n    min-width: 2ch;\n    text-align: right;\n  }\n\n  .pressy-toc-backdrop--scroll .pressy-toc-item-title {\n    flex: 1;\n    min-width: 0;\n  }\n\n  @keyframes pressy-scroll-toc-fade-in {\n    from { opacity: 0; }\n    to { opacity: 1; }\n  }\n\n  @keyframes pressy-scroll-toc-slide-up {\n    from { transform: translateY(100%); }\n    to { transform: translateY(0); }\n  }\n\n  /* ── Offline icon for scroll reader ─────────────────────── */\n  .pressy-page-footer--scroll .pressy-offline-icon {\n    flex-shrink: 0;\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    position: relative;\n    width: 2rem;\n    height: 2rem;\n    border: none;\n    background: transparent;\n    color: var(--color-text-muted, #6c757d);\n    cursor: pointer;\n    border-radius: 0.375rem;\n    transition: color 0.15s, background 0.15s;\n    padding: 0;\n  }\n\n  .pressy-page-footer--scroll .pressy-offline-icon:hover {\n    color: var(--color-text, #212529);\n    background: var(--color-bg-subtle, #f8f9fa);\n  }\n\n  .pressy-page-footer--scroll .pressy-offline-icon--cached {\n    color: #16a34a;\n  }\n\n  .pressy-page-footer--scroll .pressy-offline-icon--cached:hover {\n    color: #dc2626;\n  }\n\n  .pressy-page-footer--scroll .pressy-offline-check {\n    position: absolute;\n    bottom: 2px;\n    right: 2px;\n  }\n\n  .pressy-page-footer--scroll .pressy-offline-icon--downloading {\n    cursor: default;\n  }\n\n  @media (prefers-reduced-motion: reduce) {\n    .pressy-page-footer--scroll {\n      transition: none;\n    }\n    .pressy-toc-backdrop--scroll,\n    .pressy-toc-backdrop--scroll .pressy-toc-drawer {\n      animation: none;\n    }\n  }\n`;\n\nconst PAGINATED_STYLES = `\n  html:has(.pressy-reader--paginated) body {\n    margin: 0;\n  }\n\n  .pressy-reader--paginated {\n    height: 100vh;\n    height: 100dvh;\n    display: flex;\n    flex-direction: column;\n    overflow: hidden;\n    position: relative;\n  }\n\n  /* Viewport clips overflow and shows one page at a time.\n     Vertical padding gives consistent top/bottom margins on every page. */\n  .pressy-paginated-viewport {\n    flex: 1;\n    overflow: hidden;\n    position: relative;\n    min-height: 0;\n    padding-block: 2rem;\n    box-sizing: border-box;\n    text-wrap: pretty;\n  }\n\n  /* Article uses CSS multi-column layout for pagination.\n     column-width is set dynamically via JS to match viewport width.\n     Each column = one \"page\". Content overflows horizontally into new columns.\n     translateX controlled by JS — transitions set dynamically during drag vs snap. */\n  .pressy-prose--paginated {\n    max-width: none;\n    height: 100%;\n    column-fill: auto;\n    column-gap: 0;\n    overflow: visible;\n    box-sizing: border-box;\n    padding: 0;\n    will-change: transform;\n    /* Transition is set dynamically: none during drag, ease-out on snap */\n  }\n\n  /* Center content elements within each column/page at a readable width */\n  .pressy-prose--paginated > * {\n    max-width: min(65ch, calc(100% - 3rem));\n    margin-left: auto;\n    margin-right: auto;\n  }\n\n  /* Preserve vertical margins from prose styles */\n  .pressy-prose--paginated > h1,\n  .pressy-prose--paginated > h2,\n  .pressy-prose--paginated > h3,\n  .pressy-prose--paginated > h4 {\n    max-width: min(65ch, calc(100% - 3rem));\n    margin-left: auto;\n    margin-right: auto;\n  }\n\n  /* ── Navigation arrows ────────────────────────────────────── */\n  /* Hover-triggered arrows on left/right edges for desktop navigation */\n  .pressy-nav-arrow {\n    position: absolute;\n    top: 50%;\n    transform: translateY(-50%);\n    width: 2.5rem;\n    height: 2.5rem;\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    color: var(--color-text-muted, #6c757d);\n    opacity: 0;\n    transition: opacity 0.2s ease;\n    pointer-events: none;\n    z-index: 5;\n  }\n\n  .pressy-nav-arrow svg {\n    width: 1.5rem;\n    height: 1.5rem;\n  }\n\n  .pressy-nav-arrow--prev {\n    left: 0.75rem;\n  }\n\n  .pressy-nav-arrow--next {\n    right: 0.75rem;\n  }\n\n  .pressy-nav-arrow--visible {\n    opacity: 0.4;\n  }\n\n  /* Hide on touch devices — swipe handles navigation there */\n  @media (hover: none) {\n    .pressy-nav-arrow {\n      display: none;\n    }\n  }\n\n  /* ── Chapter boundary hints ─────────────────────────────── */\n  /* Shown when overscrolling past first/last page of a chapter */\n  .pressy-chapter-hint {\n    position: absolute;\n    top: 50%;\n    transform: translateY(-50%);\n    display: flex;\n    align-items: center;\n    gap: 0.5rem;\n    padding: 0.75rem 1.25rem;\n    background: var(--color-bg-subtle, #f5f5f5);\n    border: 1px solid var(--color-border, #dee2e6);\n    border-radius: 0.75rem;\n    font-family: var(--font-heading, system-ui, -apple-system, sans-serif);\n    font-size: var(--font-size-sm, 0.875rem);\n    color: var(--color-text-muted, #6c757d);\n    z-index: 20;\n    pointer-events: none;\n    animation: pressy-hint-fade-in 0.15s ease-out;\n    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);\n    max-width: 60%;\n    white-space: nowrap;\n    overflow: hidden;\n    text-overflow: ellipsis;\n  }\n\n  .pressy-chapter-hint--prev {\n    left: 1rem;\n  }\n\n  .pressy-chapter-hint--next {\n    right: 1rem;\n  }\n\n  .pressy-chapter-hint-arrow {\n    flex-shrink: 0;\n    font-size: 1rem;\n    opacity: 0.6;\n  }\n\n  .pressy-chapter-hint-text {\n    overflow: hidden;\n    text-overflow: ellipsis;\n  }\n\n  @keyframes pressy-hint-fade-in {\n    from { opacity: 0; transform: translateY(-50%) scale(0.95); }\n    to { opacity: 1; transform: translateY(-50%) scale(1); }\n  }\n\n  /* ── Page footer ───────────────────────────────────────────── */\n  .pressy-page-footer {\n    position: absolute;\n    bottom: 0;\n    left: 0;\n    right: 0;\n    padding: 0.5rem 1.5rem 1rem;\n    text-align: center;\n    user-select: none;\n    transform: translateY(100%);\n    opacity: 0;\n    transition: transform 0.25s ease, opacity 0.25s ease;\n    z-index: 15;\n    background: var(--color-bg, #ffffff);\n  }\n\n  .pressy-page-footer--visible {\n    transform: translateY(0);\n    opacity: 1;\n  }\n\n  /* Progress bar */\n  .pressy-progress-bar {\n    height: 3px;\n    background: var(--color-border, #dee2e6);\n    border-radius: 1.5px;\n    overflow: hidden;\n  }\n\n  .pressy-progress-fill {\n    height: 100%;\n    background: var(--color-accent, #212529);\n    border-radius: 1.5px;\n    transition: width 0.3s ease;\n  }\n\n  /* ── Footer row (title + gear) ──────────────────────────── */\n  .pressy-footer-row {\n    display: flex;\n    align-items: center;\n    justify-content: space-between;\n    margin-top: 0.5rem;\n    gap: 0.5rem;\n  }\n\n  .pressy-footer-title {\n    font-family: var(--font-heading, system-ui, -apple-system, sans-serif);\n    font-size: 0.75rem;\n    color: var(--color-text-muted, #6c757d);\n    text-decoration: none;\n    overflow: hidden;\n    text-overflow: ellipsis;\n    white-space: nowrap;\n    min-width: 0;\n    flex: 1;\n    text-align: left;\n    border: none;\n    background: none;\n    cursor: pointer;\n    padding: 0;\n  }\n\n  .pressy-footer-title:hover {\n    color: var(--color-text, #212529);\n  }\n\n  /* ── TOC toggle button ──────────────────────────────────── */\n  .pressy-toc-toggle {\n    flex-shrink: 0;\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    width: 2rem;\n    height: 2rem;\n    border: none;\n    background: transparent;\n    color: var(--color-text-muted, #6c757d);\n    cursor: pointer;\n    border-radius: 0.375rem;\n    transition: color 0.15s, background 0.15s;\n    padding: 0;\n  }\n\n  .pressy-toc-toggle:hover {\n    color: var(--color-text, #212529);\n    background: var(--color-bg-subtle, #f8f9fa);\n  }\n\n  .pressy-settings-toggle {\n    flex-shrink: 0;\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    width: 2rem;\n    height: 2rem;\n    border: none;\n    background: transparent;\n    color: var(--color-text-muted, #6c757d);\n    cursor: pointer;\n    border-radius: 0.375rem;\n    transition: color 0.15s, background 0.15s;\n    padding: 0;\n  }\n\n  .pressy-settings-toggle:hover {\n    color: var(--color-text, #212529);\n    background: var(--color-bg-subtle, #f8f9fa);\n  }\n\n  /* ── Settings panel ────────────────────────────────────── */\n  .pressy-settings-panel {\n    overflow: hidden;\n    max-height: 0;\n    opacity: 0;\n    transition: max-height 0.25s ease, opacity 0.2s ease;\n    border-top: 0 solid var(--color-border, #dee2e6);\n  }\n\n  .pressy-settings-panel--open {\n    max-height: 300px;\n    opacity: 1;\n    border-top-width: 1px;\n    margin-top: 0.5rem;\n    padding-top: 0.75rem;\n  }\n\n  .pressy-settings-section {\n    margin-bottom: 0.75rem;\n  }\n\n  .pressy-settings-section:last-child {\n    margin-bottom: 0;\n  }\n\n  .pressy-settings-label {\n    font-family: var(--font-heading, system-ui, -apple-system, sans-serif);\n    font-size: 0.6875rem;\n    font-weight: 600;\n    text-transform: uppercase;\n    letter-spacing: 0.05em;\n    color: var(--color-text-muted, #6c757d);\n    margin-bottom: 0.5rem;\n    text-align: left;\n  }\n\n  .pressy-theme-options {\n    display: flex;\n    gap: 0.375rem;\n  }\n\n  .pressy-theme-btn {\n    flex: 1;\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    gap: 0.25rem;\n    padding: 0.375rem 0.5rem;\n    border: 1.5px solid var(--color-border, #dee2e6);\n    border-radius: 0.5rem;\n    background: transparent;\n    color: var(--color-text, #212529);\n    font-family: var(--font-heading, system-ui, -apple-system, sans-serif);\n    font-size: 0.6875rem;\n    cursor: pointer;\n    transition: border-color 0.15s, background 0.15s;\n  }\n\n  .pressy-theme-btn:hover {\n    background: var(--color-bg-subtle, #f8f9fa);\n  }\n\n  .pressy-theme-btn--active {\n    border-color: var(--color-accent, #212529);\n    background: var(--color-bg-subtle, #f8f9fa);\n    font-weight: 600;\n  }\n\n  .pressy-font-size-controls {\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    gap: 1rem;\n  }\n\n  .pressy-font-size-btn {\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    width: 2rem;\n    height: 2rem;\n    border: 1.5px solid var(--color-border, #dee2e6);\n    border-radius: 50%;\n    background: transparent;\n    color: var(--color-text, #212529);\n    font-family: var(--font-heading, system-ui, -apple-system, sans-serif);\n    font-size: 0.75rem;\n    font-weight: 600;\n    cursor: pointer;\n    transition: border-color 0.15s, background 0.15s;\n  }\n\n  .pressy-font-size-btn:hover:not(:disabled) {\n    background: var(--color-bg-subtle, #f8f9fa);\n    border-color: var(--color-accent, #212529);\n  }\n\n  .pressy-font-size-btn:disabled {\n    opacity: 0.3;\n    cursor: default;\n  }\n\n  .pressy-font-size-value {\n    font-family: var(--font-heading, system-ui, -apple-system, sans-serif);\n    font-size: 0.8125rem;\n    font-weight: 500;\n    color: var(--color-text, #212529);\n    min-width: 3ch;\n    text-align: center;\n  }\n\n  /* ── Chapter sections ─────────────────────────────────── */\n  .pressy-chapter-section + .pressy-chapter-section {\n    break-before: column;\n  }\n\n  .pressy-chapter-divider {\n    padding: 0;\n    margin: 0;\n  }\n\n  .pressy-chapter-divider-title {\n    font-size: 1.5rem;\n    font-family: var(--font-heading, system-ui, -apple-system, sans-serif);\n    margin: 0;\n  }\n\n  /* ── TOC drawer ──────────────────────────────────────────── */\n  .pressy-toc-backdrop {\n    position: absolute;\n    inset: 0;\n    background: rgba(0, 0, 0, 0.3);\n    z-index: 20;\n    display: flex;\n    align-items: flex-end;\n    animation: pressy-toc-fade-in 0.2s ease-out;\n  }\n\n  .pressy-toc-drawer {\n    width: 100%;\n    max-height: 70vh;\n    background: var(--color-bg, #ffffff);\n    border-radius: 1rem 1rem 0 0;\n    display: flex;\n    flex-direction: column;\n    animation: pressy-toc-slide-up 0.25s ease-out;\n    box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.1);\n  }\n\n  .pressy-toc-header {\n    display: flex;\n    align-items: center;\n    justify-content: space-between;\n    padding: 1rem 1.5rem 0.75rem;\n    border-bottom: 1px solid var(--color-border, #dee2e6);\n    flex-shrink: 0;\n  }\n\n  .pressy-toc-title {\n    font-family: var(--font-heading, system-ui, -apple-system, sans-serif);\n    font-size: 1rem;\n    font-weight: 600;\n    color: var(--color-text, #212529);\n  }\n\n  .pressy-toc-close {\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    width: 2rem;\n    height: 2rem;\n    border: none;\n    background: transparent;\n    color: var(--color-text-muted, #6c757d);\n    cursor: pointer;\n    border-radius: 0.375rem;\n    padding: 0;\n  }\n\n  .pressy-toc-close:hover {\n    color: var(--color-text, #212529);\n    background: var(--color-bg-subtle, #f8f9fa);\n  }\n\n  .pressy-toc-list {\n    overflow-y: auto;\n    padding: 0.5rem;\n    display: flex;\n    flex-direction: column;\n  }\n\n  .pressy-toc-item {\n    display: flex;\n    gap: 0.75rem;\n    padding: 0.625rem 1rem;\n    text-decoration: none;\n    color: var(--color-text, #212529);\n    border-radius: 0.5rem;\n    font-family: var(--font-heading, system-ui, -apple-system, sans-serif);\n    font-size: 0.875rem;\n    transition: background 0.15s;\n  }\n\n  .pressy-toc-item:hover {\n    background: var(--color-bg-subtle, #f5f5f5);\n  }\n\n  .pressy-toc-item--active {\n    background: var(--color-bg-subtle, #f5f5f5);\n    font-weight: 600;\n  }\n\n  .pressy-toc-item-num {\n    color: var(--color-text-muted, #6c757d);\n    min-width: 2ch;\n    text-align: right;\n  }\n\n  .pressy-toc-item-title {\n    flex: 1;\n    min-width: 0;\n  }\n\n  @keyframes pressy-toc-fade-in {\n    from { opacity: 0; }\n    to { opacity: 1; }\n  }\n\n  @keyframes pressy-toc-slide-up {\n    from { transform: translateY(100%); }\n    to { transform: translateY(0); }\n  }\n\n  /* ── Offline footer icon ────────────────────────────────── */\n  .pressy-offline-icon {\n    flex-shrink: 0;\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    position: relative;\n    width: 2rem;\n    height: 2rem;\n    border: none;\n    background: transparent;\n    color: var(--color-text-muted, #6c757d);\n    cursor: pointer;\n    border-radius: 0.375rem;\n    transition: color 0.15s, background 0.15s;\n    padding: 0;\n  }\n\n  .pressy-offline-icon:hover {\n    color: var(--color-text, #212529);\n    background: var(--color-bg-subtle, #f8f9fa);\n  }\n\n  .pressy-offline-icon--cached {\n    color: #16a34a;\n  }\n\n  .pressy-offline-icon--cached:hover {\n    color: #dc2626;\n  }\n\n  .pressy-offline-check {\n    position: absolute;\n    bottom: 2px;\n    right: 2px;\n  }\n\n  .pressy-offline-icon--downloading {\n    cursor: default;\n  }\n\n  @keyframes pressy-offline-spin {\n    from { transform: rotate(0deg); }\n    to { transform: rotate(360deg); }\n  }\n\n  .pressy-offline-spinner {\n    animation: pressy-offline-spin 1s linear infinite;\n    transform-origin: 12px 12px;\n  }\n\n  /* ── Reduced motion preference ────────────────────────────\n     Disable page turn animations for users who prefer reduced motion. */\n  @media (prefers-reduced-motion: reduce) {\n    .pressy-prose--paginated {\n      transition: none !important;\n    }\n    .pressy-progress-fill {\n      transition: none !important;\n    }\n    .pressy-toc-backdrop,\n    .pressy-toc-drawer {\n      animation: none;\n    }\n    .pressy-offline-spinner {\n      animation: none;\n    }\n  }\n`;\n","structuredPatch":[{"oldStart":431,"oldLines":6,"newStart":431,"newLines":18,"lines":["               </button>","             </div>","             <nav class=\"pressy-toc-list\">","+              <a","+                href={bookBasePath ? bookBasePath.replace(/\\/books\\/[^/]+$/, '') || '/' : '/'}","+                class=\"pressy-toc-item pressy-toc-item--home\"","+                onClick={() => setTocOpen(false)}","+              >","+                <span class=\"pressy-toc-item-num\">","+                  <svg viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" width=\"14\" height=\"14\">","+                    <path d=\"M3 9.5L12 3l9 6.5V20a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V9.5z\" />","+                  </svg>","+                </span>","+                <span class=\"pressy-toc-item-title\">{bookTitle || 'Home'}</span>","+              </a>","               {allChapters.map((ch, i) => (","                 <a","                   key={ch.slug}"]}],"userModified":false,"replaceAll":false},"sourceToolAssistantUUID":"9aa7c10c-c197-4aeb-bdea-9f8ae4f4663b"}
{"parentUuid":"68cd488d-84d5-4e6d-a01f-eae52f1862d0","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","message":{"model":"claude-opus-4-6","id":"msg_01TWCuLAWA7UZPrcFFsE6RY9","type":"message","role":"assistant","content":[{"type":"text","text":"Now do the same for the paginated mode TOC drawer:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":891,"cache_read_input_tokens":51493,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":891},"output_tokens":2,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CYAtvSLHQB7gSFkbExbf4","type":"assistant","uuid":"b92e8630-2705-4bd8-a86c-6ecb98b91099","timestamp":"2026-02-16T01:40:27.793Z"}
{"parentUuid":"b92e8630-2705-4bd8-a86c-6ecb98b91099","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","message":{"model":"claude-opus-4-6","id":"msg_01TWCuLAWA7UZPrcFFsE6RY9","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01BAMgn3HGnZdBLf3J1CqEeV","name":"Edit","input":{"replace_all":false,"file_path":"/Users/blittle/dev/pressy/packages/@pressy/components/src/Reader.tsx","old_string":"            <nav class=\"pressy-toc-list\">\n              {allChapters.map((ch, i) => (\n                <a\n                  key={ch.slug}\n                  href={`${bookBasePath || \"\"}/${ch.slug}`}\n                  class={`pressy-toc-item ${\n                    ch.slug === (activeChapterSlug || currentChapterSlug)\n                      ? \"pressy-toc-item--active\"\n                      : \"\"\n                  }`}\n                  onClick={() => setTocOpen(false)}\n                >\n                  <span class=\"pressy-toc-item-num\">{i + 1}.</span>\n                  <span class=\"pressy-toc-item-title\">{ch.title}</span>\n                </a>\n              ))}\n            </nav>","new_string":"            <nav class=\"pressy-toc-list\">\n              <a\n                href={bookBasePath ? bookBasePath.replace(/\\/books\\/[^/]+$/, '') || '/' : '/'}\n                class=\"pressy-toc-item pressy-toc-item--home\"\n                onClick={() => setTocOpen(false)}\n              >\n                <span class=\"pressy-toc-item-num\">\n                  <svg viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" width=\"14\" height=\"14\">\n                    <path d=\"M3 9.5L12 3l9 6.5V20a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V9.5z\" />\n                  </svg>\n                </span>\n                <span class=\"pressy-toc-item-title\">{bookTitle || 'Home'}</span>\n              </a>\n              {allChapters.map((ch, i) => (\n                <a\n                  key={ch.slug}\n                  href={`${bookBasePath || \"\"}/${ch.slug}`}\n                  class={`pressy-toc-item ${\n                    ch.slug === (activeChapterSlug || currentChapterSlug)\n                      ? \"pressy-toc-item--active\"\n                      : \"\"\n                  }`}\n                  onClick={() => setTocOpen(false)}\n                >\n                  <span class=\"pressy-toc-item-num\">{i + 1}.</span>\n                  <span class=\"pressy-toc-item-title\">{ch.title}</span>\n                </a>\n              ))}\n            </nav>"},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":891,"cache_read_input_tokens":51493,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":891},"output_tokens":2,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CYAtvSLHQB7gSFkbExbf4","type":"assistant","uuid":"798ef559-bd9b-49bd-8cdb-75fa2e70d744","timestamp":"2026-02-16T01:40:33.328Z"}
{"parentUuid":"798ef559-bd9b-49bd-8cdb-75fa2e70d744","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","type":"progress","data":{"type":"hook_progress","hookEvent":"PostToolUse","hookName":"PostToolUse:Edit","command":"callback"},"parentToolUseID":"toolu_01BAMgn3HGnZdBLf3J1CqEeV","toolUseID":"toolu_01BAMgn3HGnZdBLf3J1CqEeV","timestamp":"2026-02-16T01:40:33.360Z","uuid":"9d8186fe-74ea-4062-aa4f-435ed4efc509"}
{"parentUuid":"798ef559-bd9b-49bd-8cdb-75fa2e70d744","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01BAMgn3HGnZdBLf3J1CqEeV","type":"tool_result","content":"The file /Users/blittle/dev/pressy/packages/@pressy/components/src/Reader.tsx has been updated successfully."}]},"uuid":"ec19e1d8-f6e1-4534-8ed0-3ec2d27a89bf","timestamp":"2026-02-16T01:40:33.360Z","toolUseResult":{"filePath":"/Users/blittle/dev/pressy/packages/@pressy/components/src/Reader.tsx","oldString":"            <nav class=\"pressy-toc-list\">\n              {allChapters.map((ch, i) => (\n                <a\n                  key={ch.slug}\n                  href={`${bookBasePath || \"\"}/${ch.slug}`}\n                  class={`pressy-toc-item ${\n                    ch.slug === (activeChapterSlug || currentChapterSlug)\n                      ? \"pressy-toc-item--active\"\n                      : \"\"\n                  }`}\n                  onClick={() => setTocOpen(false)}\n                >\n                  <span class=\"pressy-toc-item-num\">{i + 1}.</span>\n                  <span class=\"pressy-toc-item-title\">{ch.title}</span>\n                </a>\n              ))}\n            </nav>","newString":"            <nav class=\"pressy-toc-list\">\n              <a\n                href={bookBasePath ? bookBasePath.replace(/\\/books\\/[^/]+$/, '') || '/' : '/'}\n                class=\"pressy-toc-item pressy-toc-item--home\"\n                onClick={() => setTocOpen(false)}\n              >\n                <span class=\"pressy-toc-item-num\">\n                  <svg viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" width=\"14\" height=\"14\">\n                    <path d=\"M3 9.5L12 3l9 6.5V20a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V9.5z\" />\n                  </svg>\n                </span>\n                <span class=\"pressy-toc-item-title\">{bookTitle || 'Home'}</span>\n              </a>\n              {allChapters.map((ch, i) => (\n                <a\n                  key={ch.slug}\n                  href={`${bookBasePath || \"\"}/${ch.slug}`}\n                  class={`pressy-toc-item ${\n                    ch.slug === (activeChapterSlug || currentChapterSlug)\n                      ? \"pressy-toc-item--active\"\n                      : \"\"\n                  }`}\n                  onClick={() => setTocOpen(false)}\n                >\n                  <span class=\"pressy-toc-item-num\">{i + 1}.</span>\n                  <span class=\"pressy-toc-item-title\">{ch.title}</span>\n                </a>\n              ))}\n            </nav>","originalFile":"import { ComponentChildren, ComponentType } from \"preact\";\nimport { useState, useEffect, useRef, useCallback } from \"preact/hooks\";\n\nimport { Navigation } from \"./Navigation.js\";\nimport { TextShare } from \"./TextShare.js\";\nimport { OfflineIndicator } from \"./OfflineIndicator.js\";\n\nexport interface ProgressData {\n  page: number;\n  totalPages: number;\n  scrollPosition: number;\n}\n\nexport interface ChapterMapData {\n  chapterMap: Record<\n    string,\n    () => Promise<{\n      default: ComponentType<{ components?: Record<string, unknown> }>;\n    }>\n  >;\n  chapterOrder: string[];\n}\n\nexport interface OfflineProps {\n  bookSlug: string;\n  chapterUrls: string[];\n  cachedBooks: { value: Set<string> };\n  cacheProgress: {\n    value: { bookSlug: string; current: number; total: number } | null;\n  };\n  onDownload: (bookSlug: string, chapterUrls: string[]) => void;\n  onRemove: (bookSlug: string) => void;\n}\n\nexport interface ReaderProps {\n  children: ComponentChildren;\n  title: string;\n  bookTitle?: string;\n  chapterSlug?: string;\n  prevChapter?: { slug: string; title: string };\n  nextChapter?: { slug: string; title: string };\n  showDropCap?: boolean;\n  paginationMode?: \"scroll\" | \"paginated\";\n  onSaveProgress?: (data: ProgressData) => void;\n  onRestoreProgress?: () => Promise<ProgressData | null>;\n  bookProgressPercent?: number;\n  initialContent?: ComponentType<{ components?: Record<string, unknown> }>;\n  chapterMapData?: ChapterMapData;\n  currentChapterSlug?: string;\n  allChapters?: Array<{ slug: string; title: string; wordCount?: number }>;\n  bookBasePath?: string;\n  onChapterChange?: (slug: string, page: number, totalPages: number) => void;\n  mdxComponents?: Record<string, unknown>;\n  offlineProps?: OfflineProps;\n}\n\nexport function Reader({\n  children,\n  bookTitle,\n  prevChapter,\n  nextChapter,\n  showDropCap = true,\n  paginationMode = \"scroll\",\n  onSaveProgress,\n  onRestoreProgress,\n  bookProgressPercent,\n  initialContent,\n  chapterMapData,\n  currentChapterSlug,\n  allChapters,\n  bookBasePath,\n  onChapterChange,\n  mdxComponents,\n  offlineProps,\n}: ReaderProps) {\n  if (paginationMode === \"paginated\") {\n    return (\n      <PaginatedReader\n        bookTitle={bookTitle}\n        prevChapter={prevChapter}\n        nextChapter={nextChapter}\n        showDropCap={showDropCap}\n        onSaveProgress={onSaveProgress}\n        onRestoreProgress={onRestoreProgress}\n        bookProgressPercent={bookProgressPercent}\n        initialContent={initialContent}\n        chapterMapData={chapterMapData}\n        currentChapterSlug={currentChapterSlug}\n        allChapters={allChapters}\n        bookBasePath={bookBasePath}\n        onChapterChange={onChapterChange}\n        mdxComponents={mdxComponents}\n        offlineProps={offlineProps}\n      >\n        {children}\n      </PaginatedReader>\n    );\n  }\n\n  return (\n    <ScrollReader\n      bookTitle={bookTitle}\n      prevChapter={prevChapter}\n      nextChapter={nextChapter}\n      showDropCap={showDropCap}\n      onSaveProgress={onSaveProgress}\n      onRestoreProgress={onRestoreProgress}\n      allChapters={allChapters}\n      bookBasePath={bookBasePath}\n      currentChapterSlug={currentChapterSlug}\n      offlineProps={offlineProps}\n    >\n      {children}\n    </ScrollReader>\n  );\n}\n\n// ── Offline Footer Icon ───────────────────────────────────────\n\nfunction OfflineFooterIcon({ offlineProps }: { offlineProps?: OfflineProps }) {\n  if (!offlineProps) return null;\n\n  const {\n    bookSlug,\n    chapterUrls,\n    cachedBooks,\n    onDownload,\n    onRemove,\n  } = offlineProps;\n\n  // Read signal .value directly in render — @preact/signals auto-subscribes\n  // and re-renders this component when the underlying signal changes.\n  const isCached = cachedBooks.value.has(bookSlug);\n\n  // Check isCached FIRST (matching DownloadBook's order). The download function\n  // optimistically marks the book as cached immediately, so isCached becomes true\n  // at the same time as isDownloading. Checking isCached first means we show the\n  // cached icon right away while the SW downloads in the background.\n  if (isCached) {\n    return (\n      <button\n        class=\"pressy-offline-icon pressy-offline-icon--cached\"\n        onClick={(e: MouseEvent) => {\n          e.stopPropagation();\n          onRemove(bookSlug);\n        }}\n        aria-label=\"Available offline. Click to remove.\"\n        title=\"Available offline. Click to remove.\"\n      >\n        <svg\n          viewBox=\"0 0 24 24\"\n          fill=\"none\"\n          stroke=\"currentColor\"\n          stroke-width=\"1.5\"\n          stroke-linecap=\"round\"\n          stroke-linejoin=\"round\"\n          width=\"18\"\n          height=\"18\"\n        >\n          <path d=\"M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z\" />\n          <polyline points=\"9 15 12 18 15 15\" />\n          <line x1=\"12\" y1=\"12\" x2=\"12\" y2=\"18\" />\n        </svg>\n        <svg\n          class=\"pressy-offline-check\"\n          viewBox=\"0 0 24 24\"\n          fill=\"currentColor\"\n          width=\"10\"\n          height=\"10\"\n        >\n          <path d=\"M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z\" />\n        </svg>\n      </button>\n    );\n  }\n\n  return (\n    <button\n      class=\"pressy-offline-icon\"\n      onClick={(e: MouseEvent) => {\n        e.stopPropagation();\n        onDownload(bookSlug, chapterUrls);\n      }}\n      aria-label=\"Download for offline reading\"\n      title=\"Download for offline reading\"\n    >\n      <svg\n        viewBox=\"0 0 24 24\"\n        fill=\"none\"\n        stroke=\"currentColor\"\n        stroke-width=\"1.5\"\n        stroke-linecap=\"round\"\n        stroke-linejoin=\"round\"\n        width=\"18\"\n        height=\"18\"\n      >\n        <path d=\"M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z\" />\n        <polyline points=\"9 15 12 18 15 15\" />\n        <line x1=\"12\" y1=\"12\" x2=\"12\" y2=\"18\" />\n      </svg>\n    </button>\n  );\n}\n\n// ── Scroll Reader ────────────────────────────────────────────\n\ninterface ScrollReaderProps {\n  children: ComponentChildren;\n  bookTitle?: string;\n  prevChapter?: { slug: string; title: string };\n  nextChapter?: { slug: string; title: string };\n  showDropCap: boolean;\n  onSaveProgress?: (data: ProgressData) => void;\n  onRestoreProgress?: () => Promise<ProgressData | null>;\n  allChapters?: Array<{ slug: string; title: string; wordCount?: number }>;\n  bookBasePath?: string;\n  currentChapterSlug?: string;\n  offlineProps?: OfflineProps;\n}\n\nfunction ScrollReader({\n  children,\n  bookTitle,\n  prevChapter,\n  nextChapter,\n  showDropCap,\n  onSaveProgress,\n  onRestoreProgress,\n  allChapters,\n  bookBasePath,\n  currentChapterSlug,\n  offlineProps,\n}: ScrollReaderProps) {\n  const saveTimerRef = useRef<ReturnType<typeof setTimeout> | null>(null);\n\n  // Footer visibility\n  const [footerVisible, setFooterVisible] = useState(false);\n  const footerTimerRef = useRef<ReturnType<typeof setTimeout> | null>(null);\n  const [settingsOpen, setSettingsOpen] = useState(false);\n  const [tocOpen, setTocOpen] = useState(false);\n\n  const showFooterTemporarily = useCallback(() => {\n    setFooterVisible(true);\n    if (footerTimerRef.current) clearTimeout(footerTimerRef.current);\n    footerTimerRef.current = setTimeout(() => setFooterVisible(false), 3000);\n  }, []);\n\n  // Settings state\n  const [activeTheme, setActiveTheme] = useState<string>(() => {\n    if (typeof localStorage !== \"undefined\") {\n      return localStorage.getItem(\"pressy-theme\") || \"light\";\n    }\n    return \"light\";\n  });\n  const [fontScale, setFontScale] = useState<number>(() => {\n    if (typeof localStorage !== \"undefined\") {\n      const saved = localStorage.getItem(\"pressy-font-size\");\n      return saved ? parseFloat(saved) : 1.0;\n    }\n    return 1.0;\n  });\n\n  const applyFontScale = useCallback((scale: number) => {\n    if (scale === 1.0) {\n      document.documentElement.style.removeProperty(\"--font-size-base\");\n    } else {\n      document.documentElement.style.setProperty(\n        \"--font-size-base\",\n        `calc(clamp(1rem, 0.875rem + 0.5vw, 1.25rem) * ${scale})`\n      );\n    }\n  }, []);\n\n  useEffect(() => {\n    if (fontScale !== 1.0) {\n      applyFontScale(fontScale);\n    }\n  }, []);\n\n  const handleThemeChange = useCallback((theme: string) => {\n    setActiveTheme(theme);\n    localStorage.setItem(\"pressy-theme\", theme);\n    const resolved =\n      theme === \"system\"\n        ? window.matchMedia(\"(prefers-color-scheme: dark)\").matches\n          ? \"dark\"\n          : \"light\"\n        : theme;\n    document.documentElement.setAttribute(\"data-theme\", resolved);\n  }, []);\n\n  const handleFontSizeChange = useCallback(\n    (delta: number) => {\n      setFontScale((prev) => {\n        const next =\n          Math.round(Math.max(0.8, Math.min(1.5, prev + delta)) * 10) / 10;\n        localStorage.setItem(\"pressy-font-size\", String(next));\n        applyFontScale(next);\n        return next;\n      });\n    },\n    [applyFontScale]\n  );\n\n  // Toggle footer on tap\n  const handleReaderClick = useCallback(\n    (e: MouseEvent) => {\n      const target = e.target as HTMLElement;\n      if (\n        target.closest(\n          \".pressy-page-footer, .pressy-toc-backdrop, .pressy-toc-toggle\"\n        )\n      )\n        return;\n      if (target.closest('a, button, input, select, textarea, [role=\"button\"]'))\n        return;\n\n      if (settingsOpen || tocOpen) {\n        setSettingsOpen(false);\n        setTocOpen(false);\n        return;\n      }\n\n      if (footerVisible) {\n        setFooterVisible(false);\n        if (footerTimerRef.current) clearTimeout(footerTimerRef.current);\n      } else {\n        showFooterTemporarily();\n      }\n    },\n    [footerVisible, settingsOpen, tocOpen, showFooterTemporarily]\n  );\n\n  // Restore scroll position on mount\n  useEffect(() => {\n    if (!onRestoreProgress) return;\n    onRestoreProgress().then((data) => {\n      if (data && data.scrollPosition > 0) {\n        window.scrollTo(0, data.scrollPosition);\n      }\n    });\n  }, []);\n\n  // Save scroll position (debounced)\n  useEffect(() => {\n    if (!onSaveProgress) return;\n\n    const handleScroll = () => {\n      if (saveTimerRef.current) clearTimeout(saveTimerRef.current);\n      saveTimerRef.current = setTimeout(() => {\n        onSaveProgress({\n          page: 0,\n          totalPages: 0,\n          scrollPosition: window.scrollY,\n        });\n      }, 500);\n    };\n\n    window.addEventListener(\"scroll\", handleScroll, { passive: true });\n    return () => {\n      window.removeEventListener(\"scroll\", handleScroll);\n      if (saveTimerRef.current) clearTimeout(saveTimerRef.current);\n    };\n  }, [onSaveProgress]);\n\n  // Save on page unload\n  useEffect(() => {\n    if (!onSaveProgress) return;\n\n    const handleUnload = () => {\n      onSaveProgress({\n        page: 0,\n        totalPages: 0,\n        scrollPosition: window.scrollY,\n      });\n    };\n\n    window.addEventListener(\"beforeunload\", handleUnload);\n    return () => window.removeEventListener(\"beforeunload\", handleUnload);\n  }, [onSaveProgress]);\n\n  return (\n    <div class=\"pressy-reader\" onClick={handleReaderClick}>\n      <main class=\"pressy-reader-main\">\n        <article\n          class={`pressy-prose ${showDropCap ? \"\" : \"no-drop-cap\"}`}\n          data-drop-cap={showDropCap}\n        >\n          {children}\n        </article>\n      </main>\n\n      <TextShare />\n      <Navigation prev={prevChapter} next={nextChapter} />\n      <OfflineIndicator />\n\n      {/* TOC drawer overlay */}\n      {tocOpen && allChapters && (\n        <div\n          class=\"pressy-toc-backdrop pressy-toc-backdrop--scroll\"\n          onClick={(e: MouseEvent) => {\n            e.stopPropagation();\n            setTocOpen(false);\n          }}\n        >\n          <div\n            class=\"pressy-toc-drawer\"\n            onClick={(e: MouseEvent) => e.stopPropagation()}\n          >\n            <div class=\"pressy-toc-header\">\n              <span class=\"pressy-toc-title\">Contents</span>\n              <button\n                class=\"pressy-toc-close\"\n                onClick={(e: MouseEvent) => {\n                  e.stopPropagation();\n                  setTocOpen(false);\n                }}\n                aria-label=\"Close table of contents\"\n              >\n                <svg\n                  viewBox=\"0 0 24 24\"\n                  fill=\"none\"\n                  stroke=\"currentColor\"\n                  stroke-width=\"2\"\n                  width=\"18\"\n                  height=\"18\"\n                >\n                  <line x1=\"18\" y1=\"6\" x2=\"6\" y2=\"18\" />\n                  <line x1=\"6\" y1=\"6\" x2=\"18\" y2=\"18\" />\n                </svg>\n              </button>\n            </div>\n            <nav class=\"pressy-toc-list\">\n              <a\n                href={bookBasePath ? bookBasePath.replace(/\\/books\\/[^/]+$/, '') || '/' : '/'}\n                class=\"pressy-toc-item pressy-toc-item--home\"\n                onClick={() => setTocOpen(false)}\n              >\n                <span class=\"pressy-toc-item-num\">\n                  <svg viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" width=\"14\" height=\"14\">\n                    <path d=\"M3 9.5L12 3l9 6.5V20a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V9.5z\" />\n                  </svg>\n                </span>\n                <span class=\"pressy-toc-item-title\">{bookTitle || 'Home'}</span>\n              </a>\n              {allChapters.map((ch, i) => (\n                <a\n                  key={ch.slug}\n                  href={`${bookBasePath || \"\"}/${ch.slug}`}\n                  class={`pressy-toc-item ${\n                    ch.slug === currentChapterSlug\n                      ? \"pressy-toc-item--active\"\n                      : \"\"\n                  }`}\n                  onClick={() => setTocOpen(false)}\n                >\n                  <span class=\"pressy-toc-item-num\">{i + 1}.</span>\n                  <span class=\"pressy-toc-item-title\">{ch.title}</span>\n                </a>\n              ))}\n            </nav>\n          </div>\n        </div>\n      )}\n\n      {/* Footer */}\n      <div\n        class={`pressy-page-footer pressy-page-footer--scroll ${\n          footerVisible || settingsOpen || tocOpen\n            ? \"pressy-page-footer--visible\"\n            : \"\"\n        }`}\n      >\n        <div class=\"pressy-footer-row\">\n          {allChapters && allChapters.length > 0 && (\n            <button\n              class=\"pressy-toc-toggle\"\n              onClick={(e: MouseEvent) => {\n                e.stopPropagation();\n                setSettingsOpen(false);\n                setTocOpen(!tocOpen);\n              }}\n              aria-label=\"Table of contents\"\n            >\n              <svg\n                viewBox=\"0 0 24 24\"\n                fill=\"none\"\n                stroke=\"currentColor\"\n                stroke-width=\"1.5\"\n                stroke-linecap=\"round\"\n                stroke-linejoin=\"round\"\n                width=\"18\"\n                height=\"18\"\n              >\n                <line x1=\"3\" y1=\"6\" x2=\"21\" y2=\"6\" />\n                <line x1=\"3\" y1=\"12\" x2=\"21\" y2=\"12\" />\n                <line x1=\"3\" y1=\"18\" x2=\"21\" y2=\"18\" />\n              </svg>\n            </button>\n          )}\n          {bookTitle && (\n            <button\n              class=\"pressy-footer-title\"\n              onClick={(e: MouseEvent) => {\n                e.stopPropagation();\n                if (allChapters && allChapters.length > 0) {\n                  setSettingsOpen(false);\n                  setTocOpen(!tocOpen);\n                }\n              }}\n            >\n              {bookTitle}\n            </button>\n          )}\n          <OfflineFooterIcon offlineProps={offlineProps} />\n          <button\n            class=\"pressy-settings-toggle\"\n            onClick={(e: MouseEvent) => {\n              e.stopPropagation();\n              setTocOpen(false);\n              setSettingsOpen(!settingsOpen);\n            }}\n            aria-label=\"Settings\"\n          >\n            <svg\n              viewBox=\"0 0 24 24\"\n              fill=\"none\"\n              stroke=\"currentColor\"\n              stroke-width=\"1.5\"\n              stroke-linecap=\"round\"\n              stroke-linejoin=\"round\"\n              width=\"18\"\n              height=\"18\"\n            >\n              <circle cx=\"12\" cy=\"12\" r=\"3\" />\n              <path d=\"M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z\" />\n            </svg>\n          </button>\n        </div>\n\n        {/* Settings panel */}\n        <div\n          class={`pressy-settings-panel ${\n            settingsOpen ? \"pressy-settings-panel--open\" : \"\"\n          }`}\n        >\n          <div class=\"pressy-settings-section\">\n            <div class=\"pressy-settings-label\">Theme</div>\n            <div class=\"pressy-theme-options\">\n              {(\n                [\n                  {\n                    id: \"light\",\n                    label: \"Light\",\n                    icon: (\n                      <svg\n                        viewBox=\"0 0 24 24\"\n                        fill=\"none\"\n                        stroke=\"currentColor\"\n                        stroke-width=\"1.5\"\n                        width=\"16\"\n                        height=\"16\"\n                      >\n                        <circle cx=\"12\" cy=\"12\" r=\"5\" />\n                        <line x1=\"12\" y1=\"1\" x2=\"12\" y2=\"3\" />\n                        <line x1=\"12\" y1=\"21\" x2=\"12\" y2=\"23\" />\n                        <line x1=\"4.22\" y1=\"4.22\" x2=\"5.64\" y2=\"5.64\" />\n                        <line x1=\"18.36\" y1=\"18.36\" x2=\"19.78\" y2=\"19.78\" />\n                        <line x1=\"1\" y1=\"12\" x2=\"3\" y2=\"12\" />\n                        <line x1=\"21\" y1=\"12\" x2=\"23\" y2=\"12\" />\n                        <line x1=\"4.22\" y1=\"19.78\" x2=\"5.64\" y2=\"18.36\" />\n                        <line x1=\"18.36\" y1=\"5.64\" x2=\"19.78\" y2=\"4.22\" />\n                      </svg>\n                    ),\n                  },\n                  {\n                    id: \"dark\",\n                    label: \"Dark\",\n                    icon: (\n                      <svg\n                        viewBox=\"0 0 24 24\"\n                        fill=\"none\"\n                        stroke=\"currentColor\"\n                        stroke-width=\"1.5\"\n                        width=\"16\"\n                        height=\"16\"\n                      >\n                        <path d=\"M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z\" />\n                      </svg>\n                    ),\n                  },\n                  {\n                    id: \"system\",\n                    label: \"System\",\n                    icon: (\n                      <svg\n                        viewBox=\"0 0 24 24\"\n                        fill=\"none\"\n                        stroke=\"currentColor\"\n                        stroke-width=\"1.5\"\n                        width=\"16\"\n                        height=\"16\"\n                      >\n                        <rect\n                          x=\"2\"\n                          y=\"3\"\n                          width=\"20\"\n                          height=\"14\"\n                          rx=\"2\"\n                          ry=\"2\"\n                        />\n                        <line x1=\"8\" y1=\"21\" x2=\"16\" y2=\"21\" />\n                        <line x1=\"12\" y1=\"17\" x2=\"12\" y2=\"21\" />\n                      </svg>\n                    ),\n                  },\n                  {\n                    id: \"sepia\",\n                    label: \"Sepia\",\n                    icon: (\n                      <svg\n                        viewBox=\"0 0 24 24\"\n                        fill=\"none\"\n                        stroke=\"currentColor\"\n                        stroke-width=\"1.5\"\n                        width=\"16\"\n                        height=\"16\"\n                      >\n                        <path d=\"M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z\" />\n                        <path d=\"M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z\" />\n                      </svg>\n                    ),\n                  },\n                ] as const\n              ).map((t) => (\n                <button\n                  key={t.id}\n                  class={`pressy-theme-btn ${\n                    activeTheme === t.id ? \"pressy-theme-btn--active\" : \"\"\n                  }`}\n                  onClick={(e: MouseEvent) => {\n                    e.stopPropagation();\n                    handleThemeChange(t.id);\n                  }}\n                >\n                  {t.icon}\n                  <span>{t.label}</span>\n                </button>\n              ))}\n            </div>\n          </div>\n          <div class=\"pressy-settings-section\">\n            <div class=\"pressy-settings-label\">Font Size</div>\n            <div class=\"pressy-font-size-controls\">\n              <button\n                class=\"pressy-font-size-btn\"\n                onClick={(e: MouseEvent) => {\n                  e.stopPropagation();\n                  handleFontSizeChange(-0.1);\n                }}\n                disabled={fontScale <= 0.8}\n                aria-label=\"Decrease font size\"\n              >\n                A-\n              </button>\n              <span class=\"pressy-font-size-value\">\n                {Math.round(fontScale * 100)}%\n              </span>\n              <button\n                class=\"pressy-font-size-btn\"\n                onClick={(e: MouseEvent) => {\n                  e.stopPropagation();\n                  handleFontSizeChange(0.1);\n                }}\n                disabled={fontScale >= 1.5}\n                aria-label=\"Increase font size\"\n              >\n                A+\n              </button>\n            </div>\n          </div>\n        </div>\n      </div>\n\n      <style>{SCROLL_STYLES}</style>\n    </div>\n  );\n}\n\n// ── Paginated Reader ──────────────────────────────────────────\n\ninterface LoadedChapter {\n  slug: string;\n  title: string;\n  Content: ComponentType<{ components?: Record<string, unknown> }>;\n}\n\ninterface ChapterPageRange {\n  slug: string;\n  startPage: number;\n  endPage: number;\n}\n\ninterface PaginatedReaderProps {\n  children: ComponentChildren;\n  bookTitle?: string;\n  prevChapter?: { slug: string; title: string };\n  nextChapter?: { slug: string; title: string };\n  showDropCap: boolean;\n  onSaveProgress?: (data: ProgressData) => void;\n  onRestoreProgress?: () => Promise<ProgressData | null>;\n  bookProgressPercent?: number;\n  initialContent?: ComponentType<{ components?: Record<string, unknown> }>;\n  chapterMapData?: ChapterMapData;\n  currentChapterSlug?: string;\n  allChapters?: Array<{ slug: string; title: string; wordCount?: number }>;\n  bookBasePath?: string;\n  onChapterChange?: (slug: string, page: number, totalPages: number) => void;\n  mdxComponents?: Record<string, unknown>;\n  offlineProps?: OfflineProps;\n}\n\nfunction ChapterDivider({ title }: { title: string }) {\n  return (\n    <div class=\"pressy-chapter-divider\">\n      <h2 class=\"pressy-chapter-divider-title\">{title}</h2>\n    </div>\n  );\n}\n\nfunction PaginatedReader({\n  children,\n  bookTitle,\n  prevChapter,\n  nextChapter,\n  showDropCap,\n  onSaveProgress,\n  onRestoreProgress,\n  bookProgressPercent,\n  initialContent,\n  chapterMapData,\n  currentChapterSlug,\n  allChapters,\n  bookBasePath,\n  onChapterChange,\n  mdxComponents,\n  offlineProps,\n}: PaginatedReaderProps) {\n  const containerRef = useRef<HTMLDivElement>(null);\n  const viewportRef = useRef<HTMLDivElement>(null);\n  const articleRef = useRef<HTMLElement>(null);\n  const [currentPage, setCurrentPage] = useState(0);\n  const [totalPages, setTotalPages] = useState(1);\n  const hasRestoredRef = useRef(false);\n  const saveTimerRef = useRef<ReturnType<typeof setTimeout> | null>(null);\n\n  // Multi-chapter state\n  const [loadedChapters, setLoadedChapters] = useState<LoadedChapter[]>([]);\n  const [chapterRanges, setChapterRanges] = useState<ChapterPageRange[]>([]);\n  const [activeChapterSlug, setActiveChapterSlug] = useState(\n    currentChapterSlug || \"\"\n  );\n  const preloadingRef = useRef<Set<string>>(new Set());\n\n  // Whether we're in multi-chapter mode\n  const isMultiChapter = !!(\n    chapterMapData &&\n    initialContent &&\n    currentChapterSlug &&\n    allChapters\n  );\n\n  // Initialize loaded chapters\n  useEffect(() => {\n    if (isMultiChapter && initialContent && currentChapterSlug) {\n      const chapterInfo = allChapters!.find(\n        (ch) => ch.slug === currentChapterSlug\n      );\n      setLoadedChapters([\n        {\n          slug: currentChapterSlug,\n          title: chapterInfo?.title || currentChapterSlug,\n          Content: initialContent,\n        },\n      ]);\n      setActiveChapterSlug(currentChapterSlug);\n    }\n  }, []); // Only on mount\n\n  // Settings & TOC panel state\n  const [settingsOpen, setSettingsOpen] = useState(false);\n  const [tocOpen, setTocOpen] = useState(false);\n  const [activeTheme, setActiveTheme] = useState<string>(() => {\n    if (typeof localStorage !== \"undefined\") {\n      return localStorage.getItem(\"pressy-theme\") || \"light\";\n    }\n    return \"light\";\n  });\n  const [fontScale, setFontScale] = useState<number>(() => {\n    if (typeof localStorage !== \"undefined\") {\n      const saved = localStorage.getItem(\"pressy-font-size\");\n      return saved ? parseFloat(saved) : 1.0;\n    }\n    return 1.0;\n  });\n\n  const applyFontScale = useCallback((scale: number) => {\n    if (scale === 1.0) {\n      document.documentElement.style.removeProperty(\"--font-size-base\");\n    } else {\n      document.documentElement.style.setProperty(\n        \"--font-size-base\",\n        `calc(clamp(1rem, 0.875rem + 0.5vw, 1.25rem) * ${scale})`\n      );\n    }\n  }, []);\n\n  // Apply saved font scale on mount\n  useEffect(() => {\n    if (fontScale !== 1.0) {\n      applyFontScale(fontScale);\n    }\n  }, []);\n\n  const handleThemeChange = useCallback((theme: string) => {\n    setActiveTheme(theme);\n    localStorage.setItem(\"pressy-theme\", theme);\n    const resolved =\n      theme === \"system\"\n        ? window.matchMedia(\"(prefers-color-scheme: dark)\").matches\n          ? \"dark\"\n          : \"light\"\n        : theme;\n    document.documentElement.setAttribute(\"data-theme\", resolved);\n  }, []);\n\n  // Drag/swipe state\n  const [isDragging, setIsDragging] = useState(false);\n  const [dragOffset, setDragOffset] = useState(0);\n  const [chapterHint, setChapterHint] = useState<\"next\" | \"prev\" | null>(null);\n\n  // Touch tracking refs (avoid re-renders during drag)\n  const touchStartXRef = useRef(0);\n  const touchStartYRef = useRef(0);\n  const lastTouchXRef = useRef(0);\n  const lastTouchTimeRef = useRef(0);\n  const velocityRef = useRef(0);\n  const isSwipingRef = useRef(false);\n  const isDraggingRef = useRef(false);\n\n  // Build page-to-chapter map after recalculating pages\n  const updateChapterRanges = useCallback(() => {\n    if (!isMultiChapter) return;\n    const article = articleRef.current;\n    const viewport = viewportRef.current;\n    if (!article || !viewport) return;\n\n    const viewportWidth = viewport.clientWidth;\n    if (viewportWidth === 0) return;\n\n    const sections = article.querySelectorAll(\".pressy-chapter-section\");\n    const ranges: ChapterPageRange[] = [];\n\n    sections.forEach((section) => {\n      const slug = section.getAttribute(\"data-chapter-slug\") || \"\";\n      const sectionLeft = (section as HTMLElement).offsetLeft;\n      const sectionWidth = (section as HTMLElement).scrollWidth;\n      const startPage = Math.floor(sectionLeft / viewportWidth);\n      const endPage = Math.max(\n        startPage,\n        Math.ceil((sectionLeft + sectionWidth) / viewportWidth) - 1\n      );\n      ranges.push({ slug, startPage, endPage });\n    });\n\n    setChapterRanges(ranges);\n  }, [isMultiChapter]);\n\n  // Calculate page count and set column-width to match viewport\n  const recalculatePages = useCallback(() => {\n    const article = articleRef.current;\n    const viewport = viewportRef.current;\n    if (!article || !viewport) return;\n\n    const viewportWidth = viewport.clientWidth;\n    if (viewportWidth === 0) return;\n\n    // Set column-width to viewport width so each column = one page\n    article.style.columnWidth = `${viewportWidth}px`;\n\n    // Force synchronous layout recalculation\n    void article.scrollWidth;\n\n    const total = Math.max(1, Math.round(article.scrollWidth / viewportWidth));\n    setTotalPages(total);\n\n    // Clamp current page if now out of bounds (e.g. after resize)\n    setCurrentPage((prev) => Math.min(prev, total - 1));\n\n    // Update chapter ranges for multi-chapter mode\n    updateChapterRanges();\n  }, [updateChapterRanges]);\n\n  // Font size change handler (defined after recalculatePages)\n  const handleFontSizeChange = useCallback(\n    (delta: number) => {\n      setFontScale((prev) => {\n        const next =\n          Math.round(Math.max(0.8, Math.min(1.5, prev + delta)) * 10) / 10;\n        localStorage.setItem(\"pressy-font-size\", String(next));\n        applyFontScale(next);\n        setTimeout(() => recalculatePages(), 100);\n        return next;\n      });\n    },\n    [applyFontScale, recalculatePages]\n  );\n\n  // Recalculate on mount and on resize via ResizeObserver\n  useEffect(() => {\n    const viewport = viewportRef.current;\n    if (!viewport) return;\n\n    // Delay initial calculation to let fonts and content render\n    const initialTimer = setTimeout(recalculatePages, 50);\n\n    const observer = new ResizeObserver(() => {\n      recalculatePages();\n    });\n    observer.observe(viewport);\n\n    return () => {\n      clearTimeout(initialTimer);\n      observer.disconnect();\n    };\n  }, [recalculatePages]);\n\n  // Recalculate when loaded chapters change\n  useEffect(() => {\n    if (loadedChapters.length > 0) {\n      // Delay to let new content render\n      const timer = setTimeout(recalculatePages, 50);\n      return () => clearTimeout(timer);\n    }\n  }, [loadedChapters.length, recalculatePages]);\n\n  // Recalculate when images finish loading\n  useEffect(() => {\n    const article = articleRef.current;\n    if (!article) return;\n\n    const images = article.querySelectorAll(\"img\");\n    if (images.length === 0) return;\n\n    const onLoad = () => recalculatePages();\n    images.forEach((img) => {\n      if (!img.complete) {\n        img.addEventListener(\"load\", onLoad);\n        img.addEventListener(\"error\", onLoad);\n      }\n    });\n\n    return () => {\n      images.forEach((img) => {\n        img.removeEventListener(\"load\", onLoad);\n        img.removeEventListener(\"error\", onLoad);\n      });\n    };\n  }, [recalculatePages, loadedChapters.length]);\n\n  // Check ?page=last query param for backward navigation\n  useEffect(() => {\n    const params = new URLSearchParams(window.location.search);\n    if (params.get(\"page\") === \"last\" && totalPages > 1) {\n      setCurrentPage(totalPages - 1);\n      hasRestoredRef.current = true;\n      // Clean up the URL\n      const url = new URL(window.location.href);\n      url.searchParams.delete(\"page\");\n      history.replaceState(null, \"\", url.pathname);\n    }\n  }, [totalPages]);\n\n  // Apply translateX — combines page position + drag offset\n  useEffect(() => {\n    const article = articleRef.current;\n    const viewport = viewportRef.current;\n    if (!article || !viewport) return;\n\n    const baseOffset = currentPage * viewport.clientWidth;\n    const totalOffset = baseOffset - dragOffset;\n\n    if (isDragging) {\n      // During drag: no transition, immediate response\n      article.style.transition = \"none\";\n    } else {\n      // Snap animation: smooth ease-out\n      article.style.transition =\n        \"transform 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94)\";\n    }\n\n    article.style.transform = `translateX(-${totalOffset}px)`;\n  }, [currentPage, dragOffset, isDragging]);\n\n  // Manage focusability: elements on off-screen pages get tabindex=\"-1\"\n  // so tab navigation can't reach them and cause layout shifts.\n  // Uses getBoundingClientRect which accounts for the CSS transform.\n  useEffect(() => {\n    const article = articleRef.current;\n    const viewport = viewportRef.current;\n    if (!article || !viewport) return;\n\n    const viewportRect = viewport.getBoundingClientRect();\n\n    const focusable = article.querySelectorAll<HTMLElement>(\n      \"a[href], button, input, select, textarea, [tabindex]\"\n    );\n\n    focusable.forEach((el) => {\n      const elRect = el.getBoundingClientRect();\n      const onCurrentPage =\n        elRect.left >= viewportRect.left - 1 &&\n        elRect.right <= viewportRect.right + 1;\n\n      if (onCurrentPage) {\n        const original = el.getAttribute(\"data-original-tabindex\");\n        if (original !== null) {\n          if (original === \"\") {\n            el.removeAttribute(\"tabindex\");\n          } else {\n            el.setAttribute(\"tabindex\", original);\n          }\n          el.removeAttribute(\"data-original-tabindex\");\n        }\n      } else {\n        if (!el.hasAttribute(\"data-original-tabindex\")) {\n          el.setAttribute(\n            \"data-original-tabindex\",\n            el.getAttribute(\"tabindex\") || \"\"\n          );\n        }\n        el.setAttribute(\"tabindex\", \"-1\");\n      }\n    });\n  }, [currentPage, totalPages]);\n\n  // Preload next chapter when within 2 pages of chapter end\n  useEffect(() => {\n    if (!isMultiChapter || !chapterMapData || chapterRanges.length === 0)\n      return;\n\n    const activeRange = chapterRanges.find((r) => r.slug === activeChapterSlug);\n    if (!activeRange) return;\n\n    const pagesFromEnd = activeRange.endPage - currentPage;\n    if (pagesFromEnd > 2) return;\n\n    // Find the next chapter to preload\n    const { chapterOrder, chapterMap } = chapterMapData;\n    const lastLoadedSlug = loadedChapters[loadedChapters.length - 1]?.slug;\n    const lastLoadedIdx = chapterOrder.indexOf(lastLoadedSlug);\n    if (lastLoadedIdx === -1 || lastLoadedIdx >= chapterOrder.length - 1)\n      return;\n\n    const nextSlug = chapterOrder[lastLoadedIdx + 1];\n    if (preloadingRef.current.has(nextSlug)) return;\n    if (loadedChapters.some((ch) => ch.slug === nextSlug)) return;\n\n    preloadingRef.current.add(nextSlug);\n\n    const loader = chapterMap[nextSlug];\n    if (!loader) return;\n\n    loader()\n      .then((mod) => {\n        const Content = mod.default;\n        const chapterInfo = allChapters!.find((ch) => ch.slug === nextSlug);\n        setLoadedChapters((prev) => {\n          if (prev.some((ch) => ch.slug === nextSlug)) return prev;\n          return [\n            ...prev,\n            {\n              slug: nextSlug,\n              title: chapterInfo?.title || nextSlug,\n              Content,\n            },\n          ];\n        });\n      })\n      .catch(() => {\n        // Dynamic import failed — will fall back to full-page navigation\n        preloadingRef.current.delete(nextSlug);\n      });\n  }, [\n    currentPage,\n    activeChapterSlug,\n    chapterRanges,\n    isMultiChapter,\n    chapterMapData,\n    loadedChapters,\n    allChapters,\n  ]);\n\n  // Detect chapter boundary crossings and update URL / active chapter\n  useEffect(() => {\n    if (!isMultiChapter || chapterRanges.length === 0 || !bookBasePath) return;\n\n    const currentRange = chapterRanges.find(\n      (r) => currentPage >= r.startPage && currentPage <= r.endPage\n    );\n    if (!currentRange || currentRange.slug === activeChapterSlug) return;\n\n    const prevSlug = activeChapterSlug;\n    setActiveChapterSlug(currentRange.slug);\n\n    // Update URL\n    const newPath = `${bookBasePath}/${currentRange.slug}`;\n    history.replaceState(null, \"\", newPath);\n\n    // Update document title\n    const chapterInfo = allChapters?.find(\n      (ch) => ch.slug === currentRange.slug\n    );\n    if (chapterInfo) {\n      document.title = document.title.replace(\n        /^[^|]+/,\n        chapterInfo.title + \" \"\n      );\n    }\n\n    // Notify parent about chapter change (saves progress for the chapter being left)\n    if (onChapterChange && prevSlug) {\n      const prevRange = chapterRanges.find((r) => r.slug === prevSlug);\n      if (prevRange) {\n        const prevTotalPages = prevRange.endPage - prevRange.startPage + 1;\n        onChapterChange(prevSlug, prevTotalPages - 1, prevTotalPages);\n      }\n    }\n  }, [\n    currentPage,\n    chapterRanges,\n    activeChapterSlug,\n    isMultiChapter,\n    bookBasePath,\n    allChapters,\n    onChapterChange,\n  ]);\n\n  // Save progress when page changes (debounced) — save relative to active chapter\n  useEffect(() => {\n    if (!onSaveProgress || !hasRestoredRef.current) return;\n\n    if (saveTimerRef.current) clearTimeout(saveTimerRef.current);\n    saveTimerRef.current = setTimeout(() => {\n      if (isMultiChapter && chapterRanges.length > 0) {\n        const activeRange = chapterRanges.find(\n          (r) => r.slug === activeChapterSlug\n        );\n        if (activeRange) {\n          const chapterPage = currentPage - activeRange.startPage;\n          const chapterTotalPages =\n            activeRange.endPage - activeRange.startPage + 1;\n          onSaveProgress({\n            page: chapterPage,\n            totalPages: chapterTotalPages,\n            scrollPosition: 0,\n          });\n        }\n      } else {\n        onSaveProgress({\n          page: currentPage,\n          totalPages,\n          scrollPosition: 0,\n        });\n      }\n    }, 300);\n\n    return () => {\n      if (saveTimerRef.current) clearTimeout(saveTimerRef.current);\n    };\n  }, [\n    currentPage,\n    totalPages,\n    onSaveProgress,\n    isMultiChapter,\n    chapterRanges,\n    activeChapterSlug,\n  ]);\n\n  // Save progress on page unload\n  useEffect(() => {\n    if (!onSaveProgress) return;\n\n    const handleUnload = () => {\n      if (isMultiChapter && chapterRanges.length > 0) {\n        const activeRange = chapterRanges.find(\n          (r) => r.slug === activeChapterSlug\n        );\n        if (activeRange) {\n          const chapterPage = currentPage - activeRange.startPage;\n          const chapterTotalPages =\n            activeRange.endPage - activeRange.startPage + 1;\n          onSaveProgress({\n            page: chapterPage,\n            totalPages: chapterTotalPages,\n            scrollPosition: 0,\n          });\n        }\n      } else {\n        onSaveProgress({\n          page: currentPage,\n          totalPages,\n          scrollPosition: 0,\n        });\n      }\n    };\n\n    window.addEventListener(\"beforeunload\", handleUnload);\n    return () => window.removeEventListener(\"beforeunload\", handleUnload);\n  }, [\n    currentPage,\n    totalPages,\n    onSaveProgress,\n    isMultiChapter,\n    chapterRanges,\n    activeChapterSlug,\n  ]);\n\n  // Determine the effective last chapter slug for rubber-band / next chapter hint\n  const effectiveNextChapter = (() => {\n    if (!isMultiChapter || !chapterMapData) return nextChapter;\n    const { chapterOrder } = chapterMapData;\n    const lastLoadedSlug = loadedChapters[loadedChapters.length - 1]?.slug;\n    const lastLoadedIdx = chapterOrder.indexOf(lastLoadedSlug);\n    // If we haven't loaded the last chapter in the book yet, no next chapter hint needed\n    // (preloading will seamlessly add the next chapter)\n    if (lastLoadedIdx < chapterOrder.length - 1) return undefined;\n    // All chapters loaded — navigate to book table of contents\n    if (bookBasePath) return { slug: bookBasePath, title: \"Table of Contents\" };\n    return nextChapter;\n  })();\n\n  // Determine the effective prev chapter for backward navigation\n  const effectivePrevChapter = (() => {\n    if (!isMultiChapter || !chapterMapData) return prevChapter;\n    const { chapterOrder } = chapterMapData;\n    const firstLoadedSlug = loadedChapters[0]?.slug;\n    const firstLoadedIdx = chapterOrder.indexOf(firstLoadedSlug);\n    // If the first loaded chapter is the first chapter of the book\n    if (firstLoadedIdx <= 0) return prevChapter;\n    // There's a previous chapter in the book — navigate to it via page load\n    const prevSlug = chapterOrder[firstLoadedIdx - 1];\n    const prevInfo = allChapters?.find((ch) => ch.slug === prevSlug);\n    return {\n      slug: `${bookBasePath}/${prevSlug}?page=last`,\n      title: prevInfo?.title || prevSlug,\n    };\n  })();\n\n  const goToPage = useCallback(\n    (page: number) => {\n      const clamped = Math.max(0, Math.min(page, totalPages - 1));\n      setCurrentPage(clamped);\n    },\n    [totalPages]\n  );\n\n  const goNext = useCallback(() => {\n    if (currentPage >= totalPages - 1) {\n      // At the last page — navigate to next chapter if available\n      if (effectiveNextChapter) {\n        window.location.href = effectiveNextChapter.slug;\n      }\n      return;\n    }\n    goToPage(currentPage + 1);\n  }, [currentPage, totalPages, effectiveNextChapter, goToPage]);\n\n  const goPrev = useCallback(() => {\n    if (currentPage <= 0) {\n      // At the first page — navigate to prev chapter if available\n      if (effectivePrevChapter) {\n        window.location.href = effectivePrevChapter.slug;\n      }\n      return;\n    }\n    goToPage(currentPage - 1);\n  }, [currentPage, effectivePrevChapter, goToPage]);\n\n  // Footer visibility — hidden by default, shown on interaction\n  const [footerVisible, setFooterVisible] = useState(false);\n  const footerTimerRef = useRef<ReturnType<typeof setTimeout> | null>(null);\n\n  const showFooterTemporarily = useCallback(() => {\n    setFooterVisible(true);\n    if (footerTimerRef.current) clearTimeout(footerTimerRef.current);\n    footerTimerRef.current = setTimeout(() => setFooterVisible(false), 3000);\n  }, []);\n\n  // Double-tap fullscreen (mobile middle-third)\n  const lastMiddleTapRef = useRef(0);\n  const middleTapTimerRef = useRef<ReturnType<typeof setTimeout> | null>(null);\n\n  const toggleFullscreen = useCallback(() => {\n    if (document.fullscreenElement) {\n      document.exitFullscreen();\n    } else {\n      document.documentElement.requestFullscreen().catch(() => {\n        // Fullscreen not supported or denied\n      });\n    }\n  }, []);\n\n  // Whether the device supports hover (i.e. desktop with a mouse).\n  // Touch-only devices use swipe for page turns; tapping just toggles the footer.\n  const isTouchDevice =\n    typeof window !== \"undefined\" && window.matchMedia(\"(hover: none)\").matches;\n\n  // Click handler: on desktop, edge clicks turn pages and middle clicks\n  // toggle footer / double-click fullscreen. On touch devices, any tap\n  // simply toggles the footer — swiping handles all page navigation.\n  const handleContainerClick = useCallback(\n    (e: MouseEvent) => {\n      const target = e.target as HTMLElement;\n\n      // Clicks inside panels or on interactive elements — ignore\n      if (\n        target.closest(\n          \".pressy-settings-panel, .pressy-settings-toggle, .pressy-toc-drawer, .pressy-toc-toggle\"\n        )\n      )\n        return;\n      if (target.closest('a, button, input, select, textarea, [role=\"button\"]'))\n        return;\n\n      // If settings or TOC panel is open, close it on any outside click\n      if (settingsOpen || tocOpen) {\n        setSettingsOpen(false);\n        setTocOpen(false);\n        return;\n      }\n\n      // Touch devices: tap anywhere toggles the footer, nothing else\n      if (isTouchDevice) {\n        if (footerVisible) {\n          setFooterVisible(false);\n          if (footerTimerRef.current) clearTimeout(footerTimerRef.current);\n        } else {\n          showFooterTemporarily();\n        }\n        return;\n      }\n\n      // Desktop: edge clicks turn pages, middle clicks toggle footer / fullscreen\n      const container = containerRef.current;\n      if (!container) return;\n\n      const rect = container.getBoundingClientRect();\n      const x = e.clientX - rect.left;\n      const edgeZone = rect.width * 0.15;\n\n      if (x < edgeZone) {\n        goPrev();\n      } else if (x > rect.width - edgeZone) {\n        goNext();\n      } else {\n        // Middle third — single click toggles footer, double click toggles fullscreen\n        const now = Date.now();\n        const timeSinceLastTap = now - lastMiddleTapRef.current;\n        lastMiddleTapRef.current = now;\n\n        if (timeSinceLastTap < 300) {\n          if (middleTapTimerRef.current)\n            clearTimeout(middleTapTimerRef.current);\n          toggleFullscreen();\n        } else {\n          if (middleTapTimerRef.current)\n            clearTimeout(middleTapTimerRef.current);\n          middleTapTimerRef.current = setTimeout(() => {\n            if (footerVisible) {\n              setFooterVisible(false);\n              if (footerTimerRef.current) clearTimeout(footerTimerRef.current);\n            } else {\n              showFooterTemporarily();\n            }\n          }, 300);\n        }\n      }\n    },\n    [\n      goNext,\n      goPrev,\n      footerVisible,\n      isTouchDevice,\n      settingsOpen,\n      tocOpen,\n      showFooterTemporarily,\n      toggleFullscreen,\n    ]\n  );\n\n  // Hover zone tracking for desktop navigation hints\n  const [hoverZone, setHoverZone] = useState<\"left\" | \"right\" | null>(null);\n\n  const handleMouseMove = useCallback(\n    (e: MouseEvent) => {\n      const container = containerRef.current;\n      if (!container) return;\n\n      const rect = container.getBoundingClientRect();\n      const x = e.clientX - rect.left;\n      const y = e.clientY - rect.top;\n      const third = rect.width / 3;\n\n      if (x < third) {\n        setHoverZone(\"left\");\n      } else if (x > third * 2) {\n        setHoverZone(\"right\");\n      } else {\n        setHoverZone(null);\n      }\n\n      // Show footer when mouse is in the bottom quarter\n      if (y > rect.height * 0.75) {\n        setFooterVisible(true);\n        if (footerTimerRef.current) clearTimeout(footerTimerRef.current);\n      } else if (!settingsOpen && !tocOpen) {\n        // Hide after a short delay when leaving the bottom area (not when panels are open)\n        if (footerTimerRef.current) clearTimeout(footerTimerRef.current);\n        footerTimerRef.current = setTimeout(() => setFooterVisible(false), 600);\n      }\n    },\n    [settingsOpen, tocOpen]\n  );\n\n  const handleMouseLeave = useCallback(() => {\n    setHoverZone(null);\n    if (!settingsOpen && !tocOpen) {\n      if (footerTimerRef.current) clearTimeout(footerTimerRef.current);\n      footerTimerRef.current = setTimeout(() => setFooterVisible(false), 600);\n    }\n  }, [settingsOpen, tocOpen]);\n\n  // Keyboard navigation\n  useEffect(() => {\n    const handleKeyDown = (e: KeyboardEvent) => {\n      // Don't intercept if user is in an input/textarea\n      const tag = (e.target as HTMLElement).tagName;\n      if (tag === \"INPUT\" || tag === \"TEXTAREA\" || tag === \"SELECT\") return;\n\n      if (e.key === \"ArrowRight\" || e.key === \" \") {\n        e.preventDefault();\n        goNext();\n      } else if (e.key === \"ArrowLeft\") {\n        e.preventDefault();\n        goPrev();\n      } else if (e.key === \"Home\") {\n        e.preventDefault();\n        goToPage(0);\n      } else if (e.key === \"End\") {\n        e.preventDefault();\n        goToPage(totalPages - 1);\n      }\n    };\n\n    window.addEventListener(\"keydown\", handleKeyDown);\n    return () => window.removeEventListener(\"keydown\", handleKeyDown);\n  }, [goNext, goPrev, goToPage, totalPages]);\n\n  // Touch swipe navigation with drag tracking, velocity detection, and rubber-band.\n  // Listeners attach to the outer container (not the viewport) so they capture\n  // touches that land on sibling elements like the tap-zone overlays.\n  useEffect(() => {\n    const container = containerRef.current;\n    if (!container) return;\n\n    const onTouchStart = (e: TouchEvent) => {\n      const touch = e.touches[0];\n      touchStartXRef.current = touch.clientX;\n      touchStartYRef.current = touch.clientY;\n      lastTouchXRef.current = touch.clientX;\n      lastTouchTimeRef.current = performance.now();\n      velocityRef.current = 0;\n      isSwipingRef.current = false;\n      isDraggingRef.current = false;\n    };\n\n    const onTouchMove = (e: TouchEvent) => {\n      const touch = e.touches[0];\n      const dx = touch.clientX - touchStartXRef.current;\n      const dy = touch.clientY - touchStartYRef.current;\n\n      // Lock direction after initial movement\n      if (!isSwipingRef.current) {\n        if (Math.abs(dx) > Math.abs(dy) && Math.abs(dx) > 10) {\n          isSwipingRef.current = true;\n        } else if (Math.abs(dy) > Math.abs(dx) && Math.abs(dy) > 10) {\n          // Vertical scroll — not our concern\n          return;\n        } else {\n          return; // Not enough movement yet\n        }\n      }\n\n      e.preventDefault();\n\n      // Track velocity (px per ms) using last touch position\n      const now = performance.now();\n      const timeDelta = now - lastTouchTimeRef.current;\n      if (timeDelta > 0) {\n        const instantVelocity =\n          (touch.clientX - lastTouchXRef.current) / timeDelta;\n        // Smooth velocity with exponential moving average\n        velocityRef.current = 0.6 * instantVelocity + 0.4 * velocityRef.current;\n      }\n      lastTouchXRef.current = touch.clientX;\n      lastTouchTimeRef.current = now;\n\n      // Determine drag offset with rubber-band resistance at boundaries\n      let offset = dx;\n      const atStart = currentPage === 0;\n      const atEnd = currentPage >= totalPages - 1;\n\n      if ((atStart && dx > 0) || (atEnd && dx < 0)) {\n        // Rubber-band: diminishing resistance using square root curve\n        // This gives a natural iOS-like rubber-band feel\n        const sign = dx > 0 ? 1 : -1;\n        const absDx = Math.abs(dx);\n        offset = sign * Math.sqrt(absDx) * 5;\n\n        // Show chapter hint when overscrolling past boundary\n        if (dx > 40 && atStart && effectivePrevChapter) {\n          setChapterHint(\"prev\");\n        } else if (dx < -40 && atEnd && effectiveNextChapter) {\n          setChapterHint(\"next\");\n        } else {\n          setChapterHint(null);\n        }\n      } else {\n        setChapterHint(null);\n      }\n\n      isDraggingRef.current = true;\n      setIsDragging(true);\n      setDragOffset(offset);\n    };\n\n    const onTouchEnd = (e: TouchEvent) => {\n      if (!isSwipingRef.current || !isDraggingRef.current) {\n        setIsDragging(false);\n        setDragOffset(0);\n        setChapterHint(null);\n        return;\n      }\n\n      const dx = e.changedTouches[0].clientX - touchStartXRef.current;\n      const velocity = velocityRef.current; // px/ms\n      const distanceThreshold = 50;\n      const velocityThreshold = 0.3; // px/ms — a fast flick\n      const chapterThreshold = 80;\n\n      const atStart = currentPage === 0;\n      const atEnd = currentPage >= totalPages - 1;\n\n      // Chapter navigation on overscroll\n      if (atEnd && dx < -chapterThreshold && effectiveNextChapter) {\n        setIsDragging(false);\n        setDragOffset(0);\n        setChapterHint(null);\n        window.location.href = effectiveNextChapter.slug;\n        return;\n      }\n      if (atStart && dx > chapterThreshold && effectivePrevChapter) {\n        setIsDragging(false);\n        setDragOffset(0);\n        setChapterHint(null);\n        window.location.href = effectivePrevChapter.slug;\n        return;\n      }\n\n      // Determine page change: distance OR velocity triggers a turn\n      if (dx < -distanceThreshold || velocity < -velocityThreshold) {\n        goNext();\n      } else if (dx > distanceThreshold || velocity > velocityThreshold) {\n        goPrev();\n      }\n\n      // Reset drag state — the CSS transition handles the snap animation\n      isDraggingRef.current = false;\n      setIsDragging(false);\n      setDragOffset(0);\n      setChapterHint(null);\n    };\n\n    // Cancel drag if touch is interrupted\n    const onTouchCancel = () => {\n      isDraggingRef.current = false;\n      setIsDragging(false);\n      setDragOffset(0);\n      setChapterHint(null);\n    };\n\n    container.addEventListener(\"touchstart\", onTouchStart, { passive: true });\n    container.addEventListener(\"touchmove\", onTouchMove, { passive: false });\n    container.addEventListener(\"touchend\", onTouchEnd, { passive: true });\n    container.addEventListener(\"touchcancel\", onTouchCancel, { passive: true });\n\n    return () => {\n      container.removeEventListener(\"touchstart\", onTouchStart);\n      container.removeEventListener(\"touchmove\", onTouchMove);\n      container.removeEventListener(\"touchend\", onTouchEnd);\n      container.removeEventListener(\"touchcancel\", onTouchCancel);\n    };\n  }, [\n    currentPage,\n    totalPages,\n    goNext,\n    goPrev,\n    effectiveNextChapter,\n    effectivePrevChapter,\n  ]);\n\n  // Compute per-chapter page indicator values\n  const chapterPageInfo = (() => {\n    if (!isMultiChapter || chapterRanges.length === 0) {\n      return { chapterPage: currentPage, chapterTotalPages: totalPages };\n    }\n    const activeRange = chapterRanges.find((r) => r.slug === activeChapterSlug);\n    if (!activeRange) {\n      return { chapterPage: currentPage, chapterTotalPages: totalPages };\n    }\n    return {\n      chapterPage: currentPage - activeRange.startPage,\n      chapterTotalPages: activeRange.endPage - activeRange.startPage + 1,\n    };\n  })();\n\n  // Book progress: position in the entire book based on word counts.\n  // Maps currentPage/totalPages (across all loaded content) through\n  // word counts to estimate absolute position in the full book.\n  const progressPercent = (() => {\n    if (!allChapters || allChapters.length === 0) {\n      return totalPages > 1 ? (currentPage / (totalPages - 1)) * 100 : 100;\n    }\n\n    const totalWords = allChapters.reduce(\n      (sum, ch) => sum + (ch.wordCount || 0),\n      0\n    );\n    if (totalWords === 0) return 0;\n\n    const firstLoadedSlug = loadedChapters[0]?.slug || activeChapterSlug;\n    let wordsBeforeLoaded = 0;\n    let loadedWords = 0;\n    let foundFirst = false;\n\n    for (const ch of allChapters) {\n      if (ch.slug === firstLoadedSlug) foundFirst = true;\n      if (!foundFirst) {\n        wordsBeforeLoaded += ch.wordCount || 0;\n      } else if (loadedChapters.some((lc) => lc.slug === ch.slug)) {\n        loadedWords += ch.wordCount || 0;\n      } else {\n        break;\n      }\n    }\n\n    const pageFraction = totalPages > 1 ? currentPage / (totalPages - 1) : 0;\n    const wordsInto = wordsBeforeLoaded + pageFraction * loadedWords;\n\n    return Math.min(100, (wordsInto / totalWords) * 100);\n  })();\n\n  // Render content — either multi-chapter sections or single-chapter children\n  const renderContent = () => {\n    if (isMultiChapter && loadedChapters.length > 0) {\n      return loadedChapters.map((ch) => (\n        <section\n          key={ch.slug}\n          class=\"pressy-chapter-section\"\n          data-chapter-slug={ch.slug}\n        >\n          <ChapterDivider title={ch.title} />\n          <ch.Content components={mdxComponents || {}} />\n        </section>\n      ));\n    }\n    return children;\n  };\n\n  return (\n    <div\n      class=\"pressy-reader pressy-reader--paginated\"\n      ref={containerRef}\n      onClick={handleContainerClick}\n      onMouseMove={handleMouseMove}\n      onMouseLeave={handleMouseLeave}\n    >\n      {/* Paginated content viewport */}\n      <div class=\"pressy-paginated-viewport\" ref={viewportRef}>\n        <article\n          ref={articleRef}\n          class={`pressy-prose pressy-prose--paginated ${\n            showDropCap ? \"\" : \"no-drop-cap\"\n          }`}\n          data-drop-cap={showDropCap}\n        >\n          {renderContent()}\n        </article>\n      </div>\n\n      {/* Navigation arrows — appear on hover in left/right thirds */}\n      <div\n        class={`pressy-nav-arrow pressy-nav-arrow--prev ${\n          hoverZone === \"left\" ? \"pressy-nav-arrow--visible\" : \"\"\n        }`}\n      >\n        <svg\n          viewBox=\"0 0 24 24\"\n          fill=\"none\"\n          stroke=\"currentColor\"\n          stroke-width=\"2\"\n          stroke-linecap=\"round\"\n          stroke-linejoin=\"round\"\n        >\n          <polyline points=\"15 18 9 12 15 6\" />\n        </svg>\n      </div>\n      <div\n        class={`pressy-nav-arrow pressy-nav-arrow--next ${\n          hoverZone === \"right\" ? \"pressy-nav-arrow--visible\" : \"\"\n        }`}\n      >\n        <svg\n          viewBox=\"0 0 24 24\"\n          fill=\"none\"\n          stroke=\"currentColor\"\n          stroke-width=\"2\"\n          stroke-linecap=\"round\"\n          stroke-linejoin=\"round\"\n        >\n          <polyline points=\"9 6 15 12 9 18\" />\n        </svg>\n      </div>\n\n      {/* Chapter boundary hints */}\n      {chapterHint === \"prev\" && effectivePrevChapter && (\n        <div\n          class=\"pressy-chapter-hint pressy-chapter-hint--prev\"\n          aria-live=\"polite\"\n        >\n          <span class=\"pressy-chapter-hint-arrow\">{\"\\u2190\"}</span>\n          <span class=\"pressy-chapter-hint-text\">\n            {effectivePrevChapter.title}\n          </span>\n        </div>\n      )}\n      {chapterHint === \"next\" && effectiveNextChapter && (\n        <div\n          class=\"pressy-chapter-hint pressy-chapter-hint--next\"\n          aria-live=\"polite\"\n        >\n          <span class=\"pressy-chapter-hint-text\">\n            {effectiveNextChapter.title}\n          </span>\n          <span class=\"pressy-chapter-hint-arrow\">{\"\\u2192\"}</span>\n        </div>\n      )}\n\n      {/* TOC drawer overlay */}\n      {tocOpen && allChapters && (\n        <div\n          class=\"pressy-toc-backdrop\"\n          onClick={(e: MouseEvent) => {\n            e.stopPropagation();\n            setTocOpen(false);\n          }}\n        >\n          <div\n            class=\"pressy-toc-drawer\"\n            onClick={(e: MouseEvent) => e.stopPropagation()}\n          >\n            <div class=\"pressy-toc-header\">\n              <span class=\"pressy-toc-title\">Contents</span>\n              <button\n                class=\"pressy-toc-close\"\n                onClick={(e: MouseEvent) => {\n                  e.stopPropagation();\n                  setTocOpen(false);\n                }}\n                aria-label=\"Close table of contents\"\n              >\n                <svg\n                  viewBox=\"0 0 24 24\"\n                  fill=\"none\"\n                  stroke=\"currentColor\"\n                  stroke-width=\"2\"\n                  width=\"18\"\n                  height=\"18\"\n                >\n                  <line x1=\"18\" y1=\"6\" x2=\"6\" y2=\"18\" />\n                  <line x1=\"6\" y1=\"6\" x2=\"18\" y2=\"18\" />\n                </svg>\n              </button>\n            </div>\n            <nav class=\"pressy-toc-list\">\n              {allChapters.map((ch, i) => (\n                <a\n                  key={ch.slug}\n                  href={`${bookBasePath || \"\"}/${ch.slug}`}\n                  class={`pressy-toc-item ${\n                    ch.slug === (activeChapterSlug || currentChapterSlug)\n                      ? \"pressy-toc-item--active\"\n                      : \"\"\n                  }`}\n                  onClick={() => setTocOpen(false)}\n                >\n                  <span class=\"pressy-toc-item-num\">{i + 1}.</span>\n                  <span class=\"pressy-toc-item-title\">{ch.title}</span>\n                </a>\n              ))}\n            </nav>\n          </div>\n        </div>\n      )}\n\n      {/* Page footer with progress — hidden by default */}\n      <div\n        class={`pressy-page-footer ${\n          footerVisible || settingsOpen || tocOpen\n            ? \"pressy-page-footer--visible\"\n            : \"\"\n        }`}\n      >\n        <div class=\"pressy-progress-bar\">\n          <div\n            class=\"pressy-progress-fill\"\n            style={{ width: `${progressPercent}%` }}\n          />\n        </div>\n        <div class=\"pressy-footer-row\">\n          {allChapters && allChapters.length > 0 && (\n            <button\n              class=\"pressy-toc-toggle\"\n              onClick={(e: MouseEvent) => {\n                e.stopPropagation();\n                setSettingsOpen(false);\n                setTocOpen(!tocOpen);\n              }}\n              aria-label=\"Table of contents\"\n            >\n              <svg\n                viewBox=\"0 0 24 24\"\n                fill=\"none\"\n                stroke=\"currentColor\"\n                stroke-width=\"1.5\"\n                stroke-linecap=\"round\"\n                stroke-linejoin=\"round\"\n                width=\"18\"\n                height=\"18\"\n              >\n                <line x1=\"3\" y1=\"6\" x2=\"21\" y2=\"6\" />\n                <line x1=\"3\" y1=\"12\" x2=\"21\" y2=\"12\" />\n                <line x1=\"3\" y1=\"18\" x2=\"21\" y2=\"18\" />\n              </svg>\n            </button>\n          )}\n          {bookTitle && (\n            <button\n              class=\"pressy-footer-title\"\n              onClick={(e: MouseEvent) => {\n                e.stopPropagation();\n                if (allChapters && allChapters.length > 0) {\n                  setSettingsOpen(false);\n                  setTocOpen(!tocOpen);\n                }\n              }}\n            >\n              {bookTitle}\n            </button>\n          )}\n          <OfflineFooterIcon offlineProps={offlineProps} />\n          <button\n            class=\"pressy-settings-toggle\"\n            onClick={(e: MouseEvent) => {\n              e.stopPropagation();\n              setTocOpen(false);\n              setSettingsOpen(!settingsOpen);\n            }}\n            aria-label=\"Settings\"\n          >\n            <svg\n              viewBox=\"0 0 24 24\"\n              fill=\"none\"\n              stroke=\"currentColor\"\n              stroke-width=\"1.5\"\n              stroke-linecap=\"round\"\n              stroke-linejoin=\"round\"\n              width=\"18\"\n              height=\"18\"\n            >\n              <circle cx=\"12\" cy=\"12\" r=\"3\" />\n              <path d=\"M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z\" />\n            </svg>\n          </button>\n        </div>\n\n        {/* Settings panel */}\n        <div\n          class={`pressy-settings-panel ${\n            settingsOpen ? \"pressy-settings-panel--open\" : \"\"\n          }`}\n        >\n          <div class=\"pressy-settings-section\">\n            <div class=\"pressy-settings-label\">Theme</div>\n            <div class=\"pressy-theme-options\">\n              {(\n                [\n                  {\n                    id: \"light\",\n                    label: \"Light\",\n                    icon: (\n                      <svg\n                        viewBox=\"0 0 24 24\"\n                        fill=\"none\"\n                        stroke=\"currentColor\"\n                        stroke-width=\"1.5\"\n                        width=\"16\"\n                        height=\"16\"\n                      >\n                        <circle cx=\"12\" cy=\"12\" r=\"5\" />\n                        <line x1=\"12\" y1=\"1\" x2=\"12\" y2=\"3\" />\n                        <line x1=\"12\" y1=\"21\" x2=\"12\" y2=\"23\" />\n                        <line x1=\"4.22\" y1=\"4.22\" x2=\"5.64\" y2=\"5.64\" />\n                        <line x1=\"18.36\" y1=\"18.36\" x2=\"19.78\" y2=\"19.78\" />\n                        <line x1=\"1\" y1=\"12\" x2=\"3\" y2=\"12\" />\n                        <line x1=\"21\" y1=\"12\" x2=\"23\" y2=\"12\" />\n                        <line x1=\"4.22\" y1=\"19.78\" x2=\"5.64\" y2=\"18.36\" />\n                        <line x1=\"18.36\" y1=\"5.64\" x2=\"19.78\" y2=\"4.22\" />\n                      </svg>\n                    ),\n                  },\n                  {\n                    id: \"dark\",\n                    label: \"Dark\",\n                    icon: (\n                      <svg\n                        viewBox=\"0 0 24 24\"\n                        fill=\"none\"\n                        stroke=\"currentColor\"\n                        stroke-width=\"1.5\"\n                        width=\"16\"\n                        height=\"16\"\n                      >\n                        <path d=\"M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z\" />\n                      </svg>\n                    ),\n                  },\n                  {\n                    id: \"system\",\n                    label: \"System\",\n                    icon: (\n                      <svg\n                        viewBox=\"0 0 24 24\"\n                        fill=\"none\"\n                        stroke=\"currentColor\"\n                        stroke-width=\"1.5\"\n                        width=\"16\"\n                        height=\"16\"\n                      >\n                        <rect\n                          x=\"2\"\n                          y=\"3\"\n                          width=\"20\"\n                          height=\"14\"\n                          rx=\"2\"\n                          ry=\"2\"\n                        />\n                        <line x1=\"8\" y1=\"21\" x2=\"16\" y2=\"21\" />\n                        <line x1=\"12\" y1=\"17\" x2=\"12\" y2=\"21\" />\n                      </svg>\n                    ),\n                  },\n                  {\n                    id: \"sepia\",\n                    label: \"Sepia\",\n                    icon: (\n                      <svg\n                        viewBox=\"0 0 24 24\"\n                        fill=\"none\"\n                        stroke=\"currentColor\"\n                        stroke-width=\"1.5\"\n                        width=\"16\"\n                        height=\"16\"\n                      >\n                        <path d=\"M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z\" />\n                        <path d=\"M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z\" />\n                      </svg>\n                    ),\n                  },\n                ] as const\n              ).map((t) => (\n                <button\n                  key={t.id}\n                  class={`pressy-theme-btn ${\n                    activeTheme === t.id ? \"pressy-theme-btn--active\" : \"\"\n                  }`}\n                  onClick={(e: MouseEvent) => {\n                    e.stopPropagation();\n                    handleThemeChange(t.id);\n                  }}\n                >\n                  {t.icon}\n                  <span>{t.label}</span>\n                </button>\n              ))}\n            </div>\n          </div>\n          <div class=\"pressy-settings-section\">\n            <div class=\"pressy-settings-label\">Font Size</div>\n            <div class=\"pressy-font-size-controls\">\n              <button\n                class=\"pressy-font-size-btn\"\n                onClick={(e: MouseEvent) => {\n                  e.stopPropagation();\n                  handleFontSizeChange(-0.1);\n                }}\n                disabled={fontScale <= 0.8}\n                aria-label=\"Decrease font size\"\n              >\n                A-\n              </button>\n              <span class=\"pressy-font-size-value\">\n                {Math.round(fontScale * 100)}%\n              </span>\n              <button\n                class=\"pressy-font-size-btn\"\n                onClick={(e: MouseEvent) => {\n                  e.stopPropagation();\n                  handleFontSizeChange(0.1);\n                }}\n                disabled={fontScale >= 1.5}\n                aria-label=\"Increase font size\"\n              >\n                A+\n              </button>\n            </div>\n          </div>\n        </div>\n      </div>\n\n      <TextShare />\n      <OfflineIndicator />\n\n      <style>{PAGINATED_STYLES}</style>\n    </div>\n  );\n}\n\n// ── Styles ────────────────────────────────────────────────────\n\nconst SCROLL_STYLES = `\n  .pressy-reader {\n    min-height: 100vh;\n    display: flex;\n    flex-direction: column;\n  }\n\n  .pressy-reader-main {\n    flex: 1;\n    padding: 2rem 0;\n  }\n\n  /* ── Scroll reader footer ──────────────────────────────── */\n  .pressy-page-footer--scroll {\n    position: fixed;\n    bottom: 0;\n    left: 0;\n    right: 0;\n    padding: 0.5rem 1.5rem 1rem;\n    text-align: center;\n    user-select: none;\n    transform: translateY(100%);\n    opacity: 0;\n    transition: transform 0.25s ease, opacity 0.25s ease;\n    z-index: 15;\n    background: var(--color-bg, #ffffff);\n    box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.05);\n  }\n\n  .pressy-page-footer--scroll.pressy-page-footer--visible {\n    transform: translateY(0);\n    opacity: 1;\n  }\n\n  /* Shared footer styles for scroll reader */\n  .pressy-page-footer--scroll .pressy-footer-row {\n    display: flex;\n    align-items: center;\n    justify-content: space-between;\n    gap: 0.5rem;\n  }\n\n  .pressy-page-footer--scroll .pressy-footer-title {\n    font-family: var(--font-heading, system-ui, -apple-system, sans-serif);\n    font-size: 0.75rem;\n    color: var(--color-text-muted, #6c757d);\n    text-decoration: none;\n    overflow: hidden;\n    text-overflow: ellipsis;\n    white-space: nowrap;\n    min-width: 0;\n    flex: 1;\n    text-align: left;\n    border: none;\n    background: none;\n    cursor: pointer;\n    padding: 0;\n  }\n\n  .pressy-page-footer--scroll .pressy-footer-title:hover {\n    color: var(--color-text, #212529);\n  }\n\n  .pressy-page-footer--scroll .pressy-toc-toggle,\n  .pressy-page-footer--scroll .pressy-settings-toggle {\n    flex-shrink: 0;\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    width: 2rem;\n    height: 2rem;\n    border: none;\n    background: transparent;\n    color: var(--color-text-muted, #6c757d);\n    cursor: pointer;\n    border-radius: 0.375rem;\n    transition: color 0.15s, background 0.15s;\n    padding: 0;\n  }\n\n  .pressy-page-footer--scroll .pressy-toc-toggle:hover,\n  .pressy-page-footer--scroll .pressy-settings-toggle:hover {\n    color: var(--color-text, #212529);\n    background: var(--color-bg-subtle, #f8f9fa);\n  }\n\n  .pressy-page-footer--scroll .pressy-settings-panel {\n    overflow: hidden;\n    max-height: 0;\n    opacity: 0;\n    transition: max-height 0.25s ease, opacity 0.2s ease;\n    border-top: 0 solid var(--color-border, #dee2e6);\n  }\n\n  .pressy-page-footer--scroll .pressy-settings-panel--open {\n    max-height: 300px;\n    opacity: 1;\n    border-top-width: 1px;\n    margin-top: 0.5rem;\n    padding-top: 0.75rem;\n  }\n\n  .pressy-page-footer--scroll .pressy-settings-section {\n    margin-bottom: 0.75rem;\n  }\n\n  .pressy-page-footer--scroll .pressy-settings-section:last-child {\n    margin-bottom: 0;\n  }\n\n  .pressy-page-footer--scroll .pressy-settings-label {\n    font-family: var(--font-heading, system-ui, -apple-system, sans-serif);\n    font-size: 0.6875rem;\n    font-weight: 600;\n    text-transform: uppercase;\n    letter-spacing: 0.05em;\n    color: var(--color-text-muted, #6c757d);\n    margin-bottom: 0.5rem;\n    text-align: left;\n  }\n\n  .pressy-page-footer--scroll .pressy-theme-options {\n    display: flex;\n    gap: 0.375rem;\n  }\n\n  .pressy-page-footer--scroll .pressy-theme-btn {\n    flex: 1;\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    gap: 0.25rem;\n    padding: 0.375rem 0.5rem;\n    border: 1.5px solid var(--color-border, #dee2e6);\n    border-radius: 0.5rem;\n    background: transparent;\n    color: var(--color-text, #212529);\n    font-family: var(--font-heading, system-ui, -apple-system, sans-serif);\n    font-size: 0.6875rem;\n    cursor: pointer;\n    transition: border-color 0.15s, background 0.15s;\n  }\n\n  .pressy-page-footer--scroll .pressy-theme-btn:hover {\n    background: var(--color-bg-subtle, #f8f9fa);\n  }\n\n  .pressy-page-footer--scroll .pressy-theme-btn--active {\n    border-color: var(--color-accent, #212529);\n    background: var(--color-bg-subtle, #f8f9fa);\n    font-weight: 600;\n  }\n\n  .pressy-page-footer--scroll .pressy-font-size-controls {\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    gap: 1rem;\n  }\n\n  .pressy-page-footer--scroll .pressy-font-size-btn {\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    width: 2rem;\n    height: 2rem;\n    border: 1.5px solid var(--color-border, #dee2e6);\n    border-radius: 50%;\n    background: transparent;\n    color: var(--color-text, #212529);\n    font-family: var(--font-heading, system-ui, -apple-system, sans-serif);\n    font-size: 0.75rem;\n    font-weight: 600;\n    cursor: pointer;\n    transition: border-color 0.15s, background 0.15s;\n  }\n\n  .pressy-page-footer--scroll .pressy-font-size-btn:hover:not(:disabled) {\n    background: var(--color-bg-subtle, #f8f9fa);\n    border-color: var(--color-accent, #212529);\n  }\n\n  .pressy-page-footer--scroll .pressy-font-size-btn:disabled {\n    opacity: 0.3;\n    cursor: default;\n  }\n\n  .pressy-page-footer--scroll .pressy-font-size-value {\n    font-family: var(--font-heading, system-ui, -apple-system, sans-serif);\n    font-size: 0.8125rem;\n    font-weight: 500;\n    color: var(--color-text, #212529);\n    min-width: 3ch;\n    text-align: center;\n  }\n\n  /* ── TOC drawer for scroll reader ───────────────────────── */\n  .pressy-toc-backdrop--scroll {\n    position: fixed;\n    inset: 0;\n    background: rgba(0, 0, 0, 0.3);\n    z-index: 20;\n    display: flex;\n    align-items: flex-end;\n    animation: pressy-scroll-toc-fade-in 0.2s ease-out;\n  }\n\n  .pressy-toc-backdrop--scroll .pressy-toc-drawer {\n    width: 100%;\n    max-height: 70vh;\n    background: var(--color-bg, #ffffff);\n    border-radius: 1rem 1rem 0 0;\n    display: flex;\n    flex-direction: column;\n    animation: pressy-scroll-toc-slide-up 0.25s ease-out;\n    box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.1);\n  }\n\n  .pressy-toc-backdrop--scroll .pressy-toc-header {\n    display: flex;\n    align-items: center;\n    justify-content: space-between;\n    padding: 1rem 1.5rem 0.75rem;\n    border-bottom: 1px solid var(--color-border, #dee2e6);\n    flex-shrink: 0;\n  }\n\n  .pressy-toc-backdrop--scroll .pressy-toc-title {\n    font-family: var(--font-heading, system-ui, -apple-system, sans-serif);\n    font-size: 1rem;\n    font-weight: 600;\n    color: var(--color-text, #212529);\n  }\n\n  .pressy-toc-backdrop--scroll .pressy-toc-close {\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    width: 2rem;\n    height: 2rem;\n    border: none;\n    background: transparent;\n    color: var(--color-text-muted, #6c757d);\n    cursor: pointer;\n    border-radius: 0.375rem;\n    padding: 0;\n  }\n\n  .pressy-toc-backdrop--scroll .pressy-toc-close:hover {\n    color: var(--color-text, #212529);\n    background: var(--color-bg-subtle, #f8f9fa);\n  }\n\n  .pressy-toc-backdrop--scroll .pressy-toc-list {\n    overflow-y: auto;\n    padding: 0.5rem;\n    display: flex;\n    flex-direction: column;\n  }\n\n  .pressy-toc-backdrop--scroll .pressy-toc-item {\n    display: flex;\n    gap: 0.75rem;\n    padding: 0.625rem 1rem;\n    text-decoration: none;\n    color: var(--color-text, #212529);\n    border-radius: 0.5rem;\n    font-family: var(--font-heading, system-ui, -apple-system, sans-serif);\n    font-size: 0.875rem;\n    transition: background 0.15s;\n  }\n\n  .pressy-toc-backdrop--scroll .pressy-toc-item:hover {\n    background: var(--color-bg-subtle, #f5f5f5);\n  }\n\n  .pressy-toc-backdrop--scroll .pressy-toc-item--active {\n    background: var(--color-bg-subtle, #f5f5f5);\n    font-weight: 600;\n  }\n\n  .pressy-toc-backdrop--scroll .pressy-toc-item-num {\n    color: var(--color-text-muted, #6c757d);\n    min-width: 2ch;\n    text-align: right;\n  }\n\n  .pressy-toc-backdrop--scroll .pressy-toc-item-title {\n    flex: 1;\n    min-width: 0;\n  }\n\n  @keyframes pressy-scroll-toc-fade-in {\n    from { opacity: 0; }\n    to { opacity: 1; }\n  }\n\n  @keyframes pressy-scroll-toc-slide-up {\n    from { transform: translateY(100%); }\n    to { transform: translateY(0); }\n  }\n\n  /* ── Offline icon for scroll reader ─────────────────────── */\n  .pressy-page-footer--scroll .pressy-offline-icon {\n    flex-shrink: 0;\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    position: relative;\n    width: 2rem;\n    height: 2rem;\n    border: none;\n    background: transparent;\n    color: var(--color-text-muted, #6c757d);\n    cursor: pointer;\n    border-radius: 0.375rem;\n    transition: color 0.15s, background 0.15s;\n    padding: 0;\n  }\n\n  .pressy-page-footer--scroll .pressy-offline-icon:hover {\n    color: var(--color-text, #212529);\n    background: var(--color-bg-subtle, #f8f9fa);\n  }\n\n  .pressy-page-footer--scroll .pressy-offline-icon--cached {\n    color: #16a34a;\n  }\n\n  .pressy-page-footer--scroll .pressy-offline-icon--cached:hover {\n    color: #dc2626;\n  }\n\n  .pressy-page-footer--scroll .pressy-offline-check {\n    position: absolute;\n    bottom: 2px;\n    right: 2px;\n  }\n\n  .pressy-page-footer--scroll .pressy-offline-icon--downloading {\n    cursor: default;\n  }\n\n  @media (prefers-reduced-motion: reduce) {\n    .pressy-page-footer--scroll {\n      transition: none;\n    }\n    .pressy-toc-backdrop--scroll,\n    .pressy-toc-backdrop--scroll .pressy-toc-drawer {\n      animation: none;\n    }\n  }\n`;\n\nconst PAGINATED_STYLES = `\n  html:has(.pressy-reader--paginated) body {\n    margin: 0;\n  }\n\n  .pressy-reader--paginated {\n    height: 100vh;\n    height: 100dvh;\n    display: flex;\n    flex-direction: column;\n    overflow: hidden;\n    position: relative;\n  }\n\n  /* Viewport clips overflow and shows one page at a time.\n     Vertical padding gives consistent top/bottom margins on every page. */\n  .pressy-paginated-viewport {\n    flex: 1;\n    overflow: hidden;\n    position: relative;\n    min-height: 0;\n    padding-block: 2rem;\n    box-sizing: border-box;\n    text-wrap: pretty;\n  }\n\n  /* Article uses CSS multi-column layout for pagination.\n     column-width is set dynamically via JS to match viewport width.\n     Each column = one \"page\". Content overflows horizontally into new columns.\n     translateX controlled by JS — transitions set dynamically during drag vs snap. */\n  .pressy-prose--paginated {\n    max-width: none;\n    height: 100%;\n    column-fill: auto;\n    column-gap: 0;\n    overflow: visible;\n    box-sizing: border-box;\n    padding: 0;\n    will-change: transform;\n    /* Transition is set dynamically: none during drag, ease-out on snap */\n  }\n\n  /* Center content elements within each column/page at a readable width */\n  .pressy-prose--paginated > * {\n    max-width: min(65ch, calc(100% - 3rem));\n    margin-left: auto;\n    margin-right: auto;\n  }\n\n  /* Preserve vertical margins from prose styles */\n  .pressy-prose--paginated > h1,\n  .pressy-prose--paginated > h2,\n  .pressy-prose--paginated > h3,\n  .pressy-prose--paginated > h4 {\n    max-width: min(65ch, calc(100% - 3rem));\n    margin-left: auto;\n    margin-right: auto;\n  }\n\n  /* ── Navigation arrows ────────────────────────────────────── */\n  /* Hover-triggered arrows on left/right edges for desktop navigation */\n  .pressy-nav-arrow {\n    position: absolute;\n    top: 50%;\n    transform: translateY(-50%);\n    width: 2.5rem;\n    height: 2.5rem;\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    color: var(--color-text-muted, #6c757d);\n    opacity: 0;\n    transition: opacity 0.2s ease;\n    pointer-events: none;\n    z-index: 5;\n  }\n\n  .pressy-nav-arrow svg {\n    width: 1.5rem;\n    height: 1.5rem;\n  }\n\n  .pressy-nav-arrow--prev {\n    left: 0.75rem;\n  }\n\n  .pressy-nav-arrow--next {\n    right: 0.75rem;\n  }\n\n  .pressy-nav-arrow--visible {\n    opacity: 0.4;\n  }\n\n  /* Hide on touch devices — swipe handles navigation there */\n  @media (hover: none) {\n    .pressy-nav-arrow {\n      display: none;\n    }\n  }\n\n  /* ── Chapter boundary hints ─────────────────────────────── */\n  /* Shown when overscrolling past first/last page of a chapter */\n  .pressy-chapter-hint {\n    position: absolute;\n    top: 50%;\n    transform: translateY(-50%);\n    display: flex;\n    align-items: center;\n    gap: 0.5rem;\n    padding: 0.75rem 1.25rem;\n    background: var(--color-bg-subtle, #f5f5f5);\n    border: 1px solid var(--color-border, #dee2e6);\n    border-radius: 0.75rem;\n    font-family: var(--font-heading, system-ui, -apple-system, sans-serif);\n    font-size: var(--font-size-sm, 0.875rem);\n    color: var(--color-text-muted, #6c757d);\n    z-index: 20;\n    pointer-events: none;\n    animation: pressy-hint-fade-in 0.15s ease-out;\n    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);\n    max-width: 60%;\n    white-space: nowrap;\n    overflow: hidden;\n    text-overflow: ellipsis;\n  }\n\n  .pressy-chapter-hint--prev {\n    left: 1rem;\n  }\n\n  .pressy-chapter-hint--next {\n    right: 1rem;\n  }\n\n  .pressy-chapter-hint-arrow {\n    flex-shrink: 0;\n    font-size: 1rem;\n    opacity: 0.6;\n  }\n\n  .pressy-chapter-hint-text {\n    overflow: hidden;\n    text-overflow: ellipsis;\n  }\n\n  @keyframes pressy-hint-fade-in {\n    from { opacity: 0; transform: translateY(-50%) scale(0.95); }\n    to { opacity: 1; transform: translateY(-50%) scale(1); }\n  }\n\n  /* ── Page footer ───────────────────────────────────────────── */\n  .pressy-page-footer {\n    position: absolute;\n    bottom: 0;\n    left: 0;\n    right: 0;\n    padding: 0.5rem 1.5rem 1rem;\n    text-align: center;\n    user-select: none;\n    transform: translateY(100%);\n    opacity: 0;\n    transition: transform 0.25s ease, opacity 0.25s ease;\n    z-index: 15;\n    background: var(--color-bg, #ffffff);\n  }\n\n  .pressy-page-footer--visible {\n    transform: translateY(0);\n    opacity: 1;\n  }\n\n  /* Progress bar */\n  .pressy-progress-bar {\n    height: 3px;\n    background: var(--color-border, #dee2e6);\n    border-radius: 1.5px;\n    overflow: hidden;\n  }\n\n  .pressy-progress-fill {\n    height: 100%;\n    background: var(--color-accent, #212529);\n    border-radius: 1.5px;\n    transition: width 0.3s ease;\n  }\n\n  /* ── Footer row (title + gear) ──────────────────────────── */\n  .pressy-footer-row {\n    display: flex;\n    align-items: center;\n    justify-content: space-between;\n    margin-top: 0.5rem;\n    gap: 0.5rem;\n  }\n\n  .pressy-footer-title {\n    font-family: var(--font-heading, system-ui, -apple-system, sans-serif);\n    font-size: 0.75rem;\n    color: var(--color-text-muted, #6c757d);\n    text-decoration: none;\n    overflow: hidden;\n    text-overflow: ellipsis;\n    white-space: nowrap;\n    min-width: 0;\n    flex: 1;\n    text-align: left;\n    border: none;\n    background: none;\n    cursor: pointer;\n    padding: 0;\n  }\n\n  .pressy-footer-title:hover {\n    color: var(--color-text, #212529);\n  }\n\n  /* ── TOC toggle button ──────────────────────────────────── */\n  .pressy-toc-toggle {\n    flex-shrink: 0;\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    width: 2rem;\n    height: 2rem;\n    border: none;\n    background: transparent;\n    color: var(--color-text-muted, #6c757d);\n    cursor: pointer;\n    border-radius: 0.375rem;\n    transition: color 0.15s, background 0.15s;\n    padding: 0;\n  }\n\n  .pressy-toc-toggle:hover {\n    color: var(--color-text, #212529);\n    background: var(--color-bg-subtle, #f8f9fa);\n  }\n\n  .pressy-settings-toggle {\n    flex-shrink: 0;\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    width: 2rem;\n    height: 2rem;\n    border: none;\n    background: transparent;\n    color: var(--color-text-muted, #6c757d);\n    cursor: pointer;\n    border-radius: 0.375rem;\n    transition: color 0.15s, background 0.15s;\n    padding: 0;\n  }\n\n  .pressy-settings-toggle:hover {\n    color: var(--color-text, #212529);\n    background: var(--color-bg-subtle, #f8f9fa);\n  }\n\n  /* ── Settings panel ────────────────────────────────────── */\n  .pressy-settings-panel {\n    overflow: hidden;\n    max-height: 0;\n    opacity: 0;\n    transition: max-height 0.25s ease, opacity 0.2s ease;\n    border-top: 0 solid var(--color-border, #dee2e6);\n  }\n\n  .pressy-settings-panel--open {\n    max-height: 300px;\n    opacity: 1;\n    border-top-width: 1px;\n    margin-top: 0.5rem;\n    padding-top: 0.75rem;\n  }\n\n  .pressy-settings-section {\n    margin-bottom: 0.75rem;\n  }\n\n  .pressy-settings-section:last-child {\n    margin-bottom: 0;\n  }\n\n  .pressy-settings-label {\n    font-family: var(--font-heading, system-ui, -apple-system, sans-serif);\n    font-size: 0.6875rem;\n    font-weight: 600;\n    text-transform: uppercase;\n    letter-spacing: 0.05em;\n    color: var(--color-text-muted, #6c757d);\n    margin-bottom: 0.5rem;\n    text-align: left;\n  }\n\n  .pressy-theme-options {\n    display: flex;\n    gap: 0.375rem;\n  }\n\n  .pressy-theme-btn {\n    flex: 1;\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    gap: 0.25rem;\n    padding: 0.375rem 0.5rem;\n    border: 1.5px solid var(--color-border, #dee2e6);\n    border-radius: 0.5rem;\n    background: transparent;\n    color: var(--color-text, #212529);\n    font-family: var(--font-heading, system-ui, -apple-system, sans-serif);\n    font-size: 0.6875rem;\n    cursor: pointer;\n    transition: border-color 0.15s, background 0.15s;\n  }\n\n  .pressy-theme-btn:hover {\n    background: var(--color-bg-subtle, #f8f9fa);\n  }\n\n  .pressy-theme-btn--active {\n    border-color: var(--color-accent, #212529);\n    background: var(--color-bg-subtle, #f8f9fa);\n    font-weight: 600;\n  }\n\n  .pressy-font-size-controls {\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    gap: 1rem;\n  }\n\n  .pressy-font-size-btn {\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    width: 2rem;\n    height: 2rem;\n    border: 1.5px solid var(--color-border, #dee2e6);\n    border-radius: 50%;\n    background: transparent;\n    color: var(--color-text, #212529);\n    font-family: var(--font-heading, system-ui, -apple-system, sans-serif);\n    font-size: 0.75rem;\n    font-weight: 600;\n    cursor: pointer;\n    transition: border-color 0.15s, background 0.15s;\n  }\n\n  .pressy-font-size-btn:hover:not(:disabled) {\n    background: var(--color-bg-subtle, #f8f9fa);\n    border-color: var(--color-accent, #212529);\n  }\n\n  .pressy-font-size-btn:disabled {\n    opacity: 0.3;\n    cursor: default;\n  }\n\n  .pressy-font-size-value {\n    font-family: var(--font-heading, system-ui, -apple-system, sans-serif);\n    font-size: 0.8125rem;\n    font-weight: 500;\n    color: var(--color-text, #212529);\n    min-width: 3ch;\n    text-align: center;\n  }\n\n  /* ── Chapter sections ─────────────────────────────────── */\n  .pressy-chapter-section + .pressy-chapter-section {\n    break-before: column;\n  }\n\n  .pressy-chapter-divider {\n    padding: 0;\n    margin: 0;\n  }\n\n  .pressy-chapter-divider-title {\n    font-size: 1.5rem;\n    font-family: var(--font-heading, system-ui, -apple-system, sans-serif);\n    margin: 0;\n  }\n\n  /* ── TOC drawer ──────────────────────────────────────────── */\n  .pressy-toc-backdrop {\n    position: absolute;\n    inset: 0;\n    background: rgba(0, 0, 0, 0.3);\n    z-index: 20;\n    display: flex;\n    align-items: flex-end;\n    animation: pressy-toc-fade-in 0.2s ease-out;\n  }\n\n  .pressy-toc-drawer {\n    width: 100%;\n    max-height: 70vh;\n    background: var(--color-bg, #ffffff);\n    border-radius: 1rem 1rem 0 0;\n    display: flex;\n    flex-direction: column;\n    animation: pressy-toc-slide-up 0.25s ease-out;\n    box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.1);\n  }\n\n  .pressy-toc-header {\n    display: flex;\n    align-items: center;\n    justify-content: space-between;\n    padding: 1rem 1.5rem 0.75rem;\n    border-bottom: 1px solid var(--color-border, #dee2e6);\n    flex-shrink: 0;\n  }\n\n  .pressy-toc-title {\n    font-family: var(--font-heading, system-ui, -apple-system, sans-serif);\n    font-size: 1rem;\n    font-weight: 600;\n    color: var(--color-text, #212529);\n  }\n\n  .pressy-toc-close {\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    width: 2rem;\n    height: 2rem;\n    border: none;\n    background: transparent;\n    color: var(--color-text-muted, #6c757d);\n    cursor: pointer;\n    border-radius: 0.375rem;\n    padding: 0;\n  }\n\n  .pressy-toc-close:hover {\n    color: var(--color-text, #212529);\n    background: var(--color-bg-subtle, #f8f9fa);\n  }\n\n  .pressy-toc-list {\n    overflow-y: auto;\n    padding: 0.5rem;\n    display: flex;\n    flex-direction: column;\n  }\n\n  .pressy-toc-item {\n    display: flex;\n    gap: 0.75rem;\n    padding: 0.625rem 1rem;\n    text-decoration: none;\n    color: var(--color-text, #212529);\n    border-radius: 0.5rem;\n    font-family: var(--font-heading, system-ui, -apple-system, sans-serif);\n    font-size: 0.875rem;\n    transition: background 0.15s;\n  }\n\n  .pressy-toc-item:hover {\n    background: var(--color-bg-subtle, #f5f5f5);\n  }\n\n  .pressy-toc-item--active {\n    background: var(--color-bg-subtle, #f5f5f5);\n    font-weight: 600;\n  }\n\n  .pressy-toc-item-num {\n    color: var(--color-text-muted, #6c757d);\n    min-width: 2ch;\n    text-align: right;\n  }\n\n  .pressy-toc-item-title {\n    flex: 1;\n    min-width: 0;\n  }\n\n  @keyframes pressy-toc-fade-in {\n    from { opacity: 0; }\n    to { opacity: 1; }\n  }\n\n  @keyframes pressy-toc-slide-up {\n    from { transform: translateY(100%); }\n    to { transform: translateY(0); }\n  }\n\n  /* ── Offline footer icon ────────────────────────────────── */\n  .pressy-offline-icon {\n    flex-shrink: 0;\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    position: relative;\n    width: 2rem;\n    height: 2rem;\n    border: none;\n    background: transparent;\n    color: var(--color-text-muted, #6c757d);\n    cursor: pointer;\n    border-radius: 0.375rem;\n    transition: color 0.15s, background 0.15s;\n    padding: 0;\n  }\n\n  .pressy-offline-icon:hover {\n    color: var(--color-text, #212529);\n    background: var(--color-bg-subtle, #f8f9fa);\n  }\n\n  .pressy-offline-icon--cached {\n    color: #16a34a;\n  }\n\n  .pressy-offline-icon--cached:hover {\n    color: #dc2626;\n  }\n\n  .pressy-offline-check {\n    position: absolute;\n    bottom: 2px;\n    right: 2px;\n  }\n\n  .pressy-offline-icon--downloading {\n    cursor: default;\n  }\n\n  @keyframes pressy-offline-spin {\n    from { transform: rotate(0deg); }\n    to { transform: rotate(360deg); }\n  }\n\n  .pressy-offline-spinner {\n    animation: pressy-offline-spin 1s linear infinite;\n    transform-origin: 12px 12px;\n  }\n\n  /* ── Reduced motion preference ────────────────────────────\n     Disable page turn animations for users who prefer reduced motion. */\n  @media (prefers-reduced-motion: reduce) {\n    .pressy-prose--paginated {\n      transition: none !important;\n    }\n    .pressy-progress-fill {\n      transition: none !important;\n    }\n    .pressy-toc-backdrop,\n    .pressy-toc-drawer {\n      animation: none;\n    }\n    .pressy-offline-spinner {\n      animation: none;\n    }\n  }\n`;\n","structuredPatch":[{"oldStart":1804,"oldLines":6,"newStart":1804,"newLines":18,"lines":["               </button>","             </div>","             <nav class=\"pressy-toc-list\">","+              <a","+                href={bookBasePath ? bookBasePath.replace(/\\/books\\/[^/]+$/, '') || '/' : '/'}","+                class=\"pressy-toc-item pressy-toc-item--home\"","+                onClick={() => setTocOpen(false)}","+              >","+                <span class=\"pressy-toc-item-num\">","+                  <svg viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" width=\"14\" height=\"14\">","+                    <path d=\"M3 9.5L12 3l9 6.5V20a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V9.5z\" />","+                  </svg>","+                </span>","+                <span class=\"pressy-toc-item-title\">{bookTitle || 'Home'}</span>","+              </a>","               {allChapters.map((ch, i) => (","                 <a","                   key={ch.slug}"]}],"userModified":false,"replaceAll":false},"sourceToolAssistantUUID":"798ef559-bd9b-49bd-8cdb-75fa2e70d744"}
{"parentUuid":"ec19e1d8-f6e1-4534-8ed0-3ec2d27a89bf","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","message":{"model":"claude-opus-4-6","id":"msg_015PVTUkbzWDnrvnm9t1CRuq","type":"message","role":"assistant","content":[{"type":"text","text":"Now add a style for the home item so the icon aligns nicely with the chapter numbers:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":817,"cache_read_input_tokens":52384,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":817},"output_tokens":2,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CYAtw2JSaQPQCZor2bLjo","type":"assistant","uuid":"540a187e-45c4-4a03-b2c9-ef9b11e98126","timestamp":"2026-02-16T01:40:35.971Z"}
{"parentUuid":"540a187e-45c4-4a03-b2c9-ef9b11e98126","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","message":{"model":"claude-opus-4-6","id":"msg_015PVTUkbzWDnrvnm9t1CRuq","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01BHZ82omdD4SZYq2Ki7B9Mo","name":"Grep","input":{"pattern":"pressy-toc-item-num \\{","path":"/Users/blittle/dev/pressy/packages/@pressy/components/src/Reader.tsx","output_mode":"content","-A":5,"-n":true},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":817,"cache_read_input_tokens":52384,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":817},"output_tokens":2,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CYAtw2JSaQPQCZor2bLjo","type":"assistant","uuid":"f8057c63-c567-44ed-b491-5c421733c2dd","timestamp":"2026-02-16T01:40:37.634Z"}
{"parentUuid":"f8057c63-c567-44ed-b491-5c421733c2dd","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","type":"progress","data":{"type":"hook_progress","hookEvent":"PostToolUse","hookName":"PostToolUse:Grep","command":"callback"},"parentToolUseID":"toolu_01BHZ82omdD4SZYq2Ki7B9Mo","toolUseID":"toolu_01BHZ82omdD4SZYq2Ki7B9Mo","timestamp":"2026-02-16T01:40:37.901Z","uuid":"acf41c35-9daf-4fb4-a206-7316da94d7a0"}
{"parentUuid":"f8057c63-c567-44ed-b491-5c421733c2dd","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01BHZ82omdD4SZYq2Ki7B9Mo","type":"tool_result","content":"2355:  .pressy-toc-backdrop--scroll .pressy-toc-item-num {\n2356-    color: var(--color-text-muted, #6c757d);\n2357-    min-width: 2ch;\n2358-    text-align: right;\n2359-  }\n2360-\n--\n2900:  .pressy-toc-item-num {\n2901-    color: var(--color-text-muted, #6c757d);\n2902-    min-width: 2ch;\n2903-    text-align: right;\n2904-  }\n2905-"}]},"uuid":"68eb2eb5-3bbe-46ef-ac84-3df296e35769","timestamp":"2026-02-16T01:40:37.900Z","toolUseResult":{"mode":"content","numFiles":0,"filenames":[],"content":"2355:  .pressy-toc-backdrop--scroll .pressy-toc-item-num {\n2356-    color: var(--color-text-muted, #6c757d);\n2357-    min-width: 2ch;\n2358-    text-align: right;\n2359-  }\n2360-\n--\n2900:  .pressy-toc-item-num {\n2901-    color: var(--color-text-muted, #6c757d);\n2902-    min-width: 2ch;\n2903-    text-align: right;\n2904-  }\n2905-","numLines":13},"sourceToolAssistantUUID":"f8057c63-c567-44ed-b491-5c421733c2dd"}
{"parentUuid":"68eb2eb5-3bbe-46ef-ac84-3df296e35769","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","message":{"model":"claude-opus-4-6","id":"msg_01AarsoMFZ1KScTryw7P1FoZ","type":"message","role":"assistant","content":[{"type":"text","text":"I need to add a style for `.pressy-toc-item--home` in both the scroll and paginated sections. Let me add it after each `pressy-toc-item-num` block."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":347,"cache_read_input_tokens":53201,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":347},"output_tokens":1,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CYAtwMboTb67rsnKutpXT","type":"assistant","uuid":"90ade3c1-def1-427a-8369-f2abad513f61","timestamp":"2026-02-16T01:40:40.803Z"}
{"parentUuid":"90ade3c1-def1-427a-8369-f2abad513f61","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","message":{"model":"claude-opus-4-6","id":"msg_01AarsoMFZ1KScTryw7P1FoZ","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01U5hJQeBZFGtTBsjhxubKdi","name":"Edit","input":{"replace_all":false,"file_path":"/Users/blittle/dev/pressy/packages/@pressy/components/src/Reader.tsx","old_string":"  .pressy-toc-backdrop--scroll .pressy-toc-item-num {\n    color: var(--color-text-muted, #6c757d);\n    min-width: 2ch;\n    text-align: right;\n  }\n\n  .pressy-toc-backdrop--scroll .pressy-toc-item-title {","new_string":"  .pressy-toc-backdrop--scroll .pressy-toc-item-num {\n    color: var(--color-text-muted, #6c757d);\n    min-width: 2ch;\n    text-align: right;\n  }\n\n  .pressy-toc-backdrop--scroll .pressy-toc-item--home {\n    border-bottom: 1px solid var(--color-border, #e5e5e5);\n    margin-bottom: 0.25rem;\n    padding-bottom: 0.75rem;\n  }\n\n  .pressy-toc-backdrop--scroll .pressy-toc-item--home .pressy-toc-item-num {\n    display: flex;\n    align-items: center;\n    justify-content: center;\n  }\n\n  .pressy-toc-backdrop--scroll .pressy-toc-item-title {"},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":347,"cache_read_input_tokens":53201,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":347},"output_tokens":1,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CYAtwMboTb67rsnKutpXT","type":"assistant","uuid":"12f5f948-3df6-4630-8fe0-e9e353ff33da","timestamp":"2026-02-16T01:40:44.611Z"}
{"parentUuid":"12f5f948-3df6-4630-8fe0-e9e353ff33da","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","type":"progress","data":{"type":"hook_progress","hookEvent":"PostToolUse","hookName":"PostToolUse:Edit","command":"callback"},"parentToolUseID":"toolu_01U5hJQeBZFGtTBsjhxubKdi","toolUseID":"toolu_01U5hJQeBZFGtTBsjhxubKdi","timestamp":"2026-02-16T01:40:44.630Z","uuid":"2b1ec4b1-9fd9-4cf6-bd90-b39963026389"}
{"parentUuid":"12f5f948-3df6-4630-8fe0-e9e353ff33da","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01U5hJQeBZFGtTBsjhxubKdi","type":"tool_result","content":"The file /Users/blittle/dev/pressy/packages/@pressy/components/src/Reader.tsx has been updated successfully."}]},"uuid":"1c3ca5ad-7443-416a-8136-45159be16bc6","timestamp":"2026-02-16T01:40:44.629Z","toolUseResult":{"filePath":"/Users/blittle/dev/pressy/packages/@pressy/components/src/Reader.tsx","oldString":"  .pressy-toc-backdrop--scroll .pressy-toc-item-num {\n    color: var(--color-text-muted, #6c757d);\n    min-width: 2ch;\n    text-align: right;\n  }\n\n  .pressy-toc-backdrop--scroll .pressy-toc-item-title {","newString":"  .pressy-toc-backdrop--scroll .pressy-toc-item-num {\n    color: var(--color-text-muted, #6c757d);\n    min-width: 2ch;\n    text-align: right;\n  }\n\n  .pressy-toc-backdrop--scroll .pressy-toc-item--home {\n    border-bottom: 1px solid var(--color-border, #e5e5e5);\n    margin-bottom: 0.25rem;\n    padding-bottom: 0.75rem;\n  }\n\n  .pressy-toc-backdrop--scroll .pressy-toc-item--home .pressy-toc-item-num {\n    display: flex;\n    align-items: center;\n    justify-content: center;\n  }\n\n  .pressy-toc-backdrop--scroll .pressy-toc-item-title {","originalFile":"import { ComponentChildren, ComponentType } from \"preact\";\nimport { useState, useEffect, useRef, useCallback } from \"preact/hooks\";\n\nimport { Navigation } from \"./Navigation.js\";\nimport { TextShare } from \"./TextShare.js\";\nimport { OfflineIndicator } from \"./OfflineIndicator.js\";\n\nexport interface ProgressData {\n  page: number;\n  totalPages: number;\n  scrollPosition: number;\n}\n\nexport interface ChapterMapData {\n  chapterMap: Record<\n    string,\n    () => Promise<{\n      default: ComponentType<{ components?: Record<string, unknown> }>;\n    }>\n  >;\n  chapterOrder: string[];\n}\n\nexport interface OfflineProps {\n  bookSlug: string;\n  chapterUrls: string[];\n  cachedBooks: { value: Set<string> };\n  cacheProgress: {\n    value: { bookSlug: string; current: number; total: number } | null;\n  };\n  onDownload: (bookSlug: string, chapterUrls: string[]) => void;\n  onRemove: (bookSlug: string) => void;\n}\n\nexport interface ReaderProps {\n  children: ComponentChildren;\n  title: string;\n  bookTitle?: string;\n  chapterSlug?: string;\n  prevChapter?: { slug: string; title: string };\n  nextChapter?: { slug: string; title: string };\n  showDropCap?: boolean;\n  paginationMode?: \"scroll\" | \"paginated\";\n  onSaveProgress?: (data: ProgressData) => void;\n  onRestoreProgress?: () => Promise<ProgressData | null>;\n  bookProgressPercent?: number;\n  initialContent?: ComponentType<{ components?: Record<string, unknown> }>;\n  chapterMapData?: ChapterMapData;\n  currentChapterSlug?: string;\n  allChapters?: Array<{ slug: string; title: string; wordCount?: number }>;\n  bookBasePath?: string;\n  onChapterChange?: (slug: string, page: number, totalPages: number) => void;\n  mdxComponents?: Record<string, unknown>;\n  offlineProps?: OfflineProps;\n}\n\nexport function Reader({\n  children,\n  bookTitle,\n  prevChapter,\n  nextChapter,\n  showDropCap = true,\n  paginationMode = \"scroll\",\n  onSaveProgress,\n  onRestoreProgress,\n  bookProgressPercent,\n  initialContent,\n  chapterMapData,\n  currentChapterSlug,\n  allChapters,\n  bookBasePath,\n  onChapterChange,\n  mdxComponents,\n  offlineProps,\n}: ReaderProps) {\n  if (paginationMode === \"paginated\") {\n    return (\n      <PaginatedReader\n        bookTitle={bookTitle}\n        prevChapter={prevChapter}\n        nextChapter={nextChapter}\n        showDropCap={showDropCap}\n        onSaveProgress={onSaveProgress}\n        onRestoreProgress={onRestoreProgress}\n        bookProgressPercent={bookProgressPercent}\n        initialContent={initialContent}\n        chapterMapData={chapterMapData}\n        currentChapterSlug={currentChapterSlug}\n        allChapters={allChapters}\n        bookBasePath={bookBasePath}\n        onChapterChange={onChapterChange}\n        mdxComponents={mdxComponents}\n        offlineProps={offlineProps}\n      >\n        {children}\n      </PaginatedReader>\n    );\n  }\n\n  return (\n    <ScrollReader\n      bookTitle={bookTitle}\n      prevChapter={prevChapter}\n      nextChapter={nextChapter}\n      showDropCap={showDropCap}\n      onSaveProgress={onSaveProgress}\n      onRestoreProgress={onRestoreProgress}\n      allChapters={allChapters}\n      bookBasePath={bookBasePath}\n      currentChapterSlug={currentChapterSlug}\n      offlineProps={offlineProps}\n    >\n      {children}\n    </ScrollReader>\n  );\n}\n\n// ── Offline Footer Icon ───────────────────────────────────────\n\nfunction OfflineFooterIcon({ offlineProps }: { offlineProps?: OfflineProps }) {\n  if (!offlineProps) return null;\n\n  const {\n    bookSlug,\n    chapterUrls,\n    cachedBooks,\n    onDownload,\n    onRemove,\n  } = offlineProps;\n\n  // Read signal .value directly in render — @preact/signals auto-subscribes\n  // and re-renders this component when the underlying signal changes.\n  const isCached = cachedBooks.value.has(bookSlug);\n\n  // Check isCached FIRST (matching DownloadBook's order). The download function\n  // optimistically marks the book as cached immediately, so isCached becomes true\n  // at the same time as isDownloading. Checking isCached first means we show the\n  // cached icon right away while the SW downloads in the background.\n  if (isCached) {\n    return (\n      <button\n        class=\"pressy-offline-icon pressy-offline-icon--cached\"\n        onClick={(e: MouseEvent) => {\n          e.stopPropagation();\n          onRemove(bookSlug);\n        }}\n        aria-label=\"Available offline. Click to remove.\"\n        title=\"Available offline. Click to remove.\"\n      >\n        <svg\n          viewBox=\"0 0 24 24\"\n          fill=\"none\"\n          stroke=\"currentColor\"\n          stroke-width=\"1.5\"\n          stroke-linecap=\"round\"\n          stroke-linejoin=\"round\"\n          width=\"18\"\n          height=\"18\"\n        >\n          <path d=\"M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z\" />\n          <polyline points=\"9 15 12 18 15 15\" />\n          <line x1=\"12\" y1=\"12\" x2=\"12\" y2=\"18\" />\n        </svg>\n        <svg\n          class=\"pressy-offline-check\"\n          viewBox=\"0 0 24 24\"\n          fill=\"currentColor\"\n          width=\"10\"\n          height=\"10\"\n        >\n          <path d=\"M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z\" />\n        </svg>\n      </button>\n    );\n  }\n\n  return (\n    <button\n      class=\"pressy-offline-icon\"\n      onClick={(e: MouseEvent) => {\n        e.stopPropagation();\n        onDownload(bookSlug, chapterUrls);\n      }}\n      aria-label=\"Download for offline reading\"\n      title=\"Download for offline reading\"\n    >\n      <svg\n        viewBox=\"0 0 24 24\"\n        fill=\"none\"\n        stroke=\"currentColor\"\n        stroke-width=\"1.5\"\n        stroke-linecap=\"round\"\n        stroke-linejoin=\"round\"\n        width=\"18\"\n        height=\"18\"\n      >\n        <path d=\"M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z\" />\n        <polyline points=\"9 15 12 18 15 15\" />\n        <line x1=\"12\" y1=\"12\" x2=\"12\" y2=\"18\" />\n      </svg>\n    </button>\n  );\n}\n\n// ── Scroll Reader ────────────────────────────────────────────\n\ninterface ScrollReaderProps {\n  children: ComponentChildren;\n  bookTitle?: string;\n  prevChapter?: { slug: string; title: string };\n  nextChapter?: { slug: string; title: string };\n  showDropCap: boolean;\n  onSaveProgress?: (data: ProgressData) => void;\n  onRestoreProgress?: () => Promise<ProgressData | null>;\n  allChapters?: Array<{ slug: string; title: string; wordCount?: number }>;\n  bookBasePath?: string;\n  currentChapterSlug?: string;\n  offlineProps?: OfflineProps;\n}\n\nfunction ScrollReader({\n  children,\n  bookTitle,\n  prevChapter,\n  nextChapter,\n  showDropCap,\n  onSaveProgress,\n  onRestoreProgress,\n  allChapters,\n  bookBasePath,\n  currentChapterSlug,\n  offlineProps,\n}: ScrollReaderProps) {\n  const saveTimerRef = useRef<ReturnType<typeof setTimeout> | null>(null);\n\n  // Footer visibility\n  const [footerVisible, setFooterVisible] = useState(false);\n  const footerTimerRef = useRef<ReturnType<typeof setTimeout> | null>(null);\n  const [settingsOpen, setSettingsOpen] = useState(false);\n  const [tocOpen, setTocOpen] = useState(false);\n\n  const showFooterTemporarily = useCallback(() => {\n    setFooterVisible(true);\n    if (footerTimerRef.current) clearTimeout(footerTimerRef.current);\n    footerTimerRef.current = setTimeout(() => setFooterVisible(false), 3000);\n  }, []);\n\n  // Settings state\n  const [activeTheme, setActiveTheme] = useState<string>(() => {\n    if (typeof localStorage !== \"undefined\") {\n      return localStorage.getItem(\"pressy-theme\") || \"light\";\n    }\n    return \"light\";\n  });\n  const [fontScale, setFontScale] = useState<number>(() => {\n    if (typeof localStorage !== \"undefined\") {\n      const saved = localStorage.getItem(\"pressy-font-size\");\n      return saved ? parseFloat(saved) : 1.0;\n    }\n    return 1.0;\n  });\n\n  const applyFontScale = useCallback((scale: number) => {\n    if (scale === 1.0) {\n      document.documentElement.style.removeProperty(\"--font-size-base\");\n    } else {\n      document.documentElement.style.setProperty(\n        \"--font-size-base\",\n        `calc(clamp(1rem, 0.875rem + 0.5vw, 1.25rem) * ${scale})`\n      );\n    }\n  }, []);\n\n  useEffect(() => {\n    if (fontScale !== 1.0) {\n      applyFontScale(fontScale);\n    }\n  }, []);\n\n  const handleThemeChange = useCallback((theme: string) => {\n    setActiveTheme(theme);\n    localStorage.setItem(\"pressy-theme\", theme);\n    const resolved =\n      theme === \"system\"\n        ? window.matchMedia(\"(prefers-color-scheme: dark)\").matches\n          ? \"dark\"\n          : \"light\"\n        : theme;\n    document.documentElement.setAttribute(\"data-theme\", resolved);\n  }, []);\n\n  const handleFontSizeChange = useCallback(\n    (delta: number) => {\n      setFontScale((prev) => {\n        const next =\n          Math.round(Math.max(0.8, Math.min(1.5, prev + delta)) * 10) / 10;\n        localStorage.setItem(\"pressy-font-size\", String(next));\n        applyFontScale(next);\n        return next;\n      });\n    },\n    [applyFontScale]\n  );\n\n  // Toggle footer on tap\n  const handleReaderClick = useCallback(\n    (e: MouseEvent) => {\n      const target = e.target as HTMLElement;\n      if (\n        target.closest(\n          \".pressy-page-footer, .pressy-toc-backdrop, .pressy-toc-toggle\"\n        )\n      )\n        return;\n      if (target.closest('a, button, input, select, textarea, [role=\"button\"]'))\n        return;\n\n      if (settingsOpen || tocOpen) {\n        setSettingsOpen(false);\n        setTocOpen(false);\n        return;\n      }\n\n      if (footerVisible) {\n        setFooterVisible(false);\n        if (footerTimerRef.current) clearTimeout(footerTimerRef.current);\n      } else {\n        showFooterTemporarily();\n      }\n    },\n    [footerVisible, settingsOpen, tocOpen, showFooterTemporarily]\n  );\n\n  // Restore scroll position on mount\n  useEffect(() => {\n    if (!onRestoreProgress) return;\n    onRestoreProgress().then((data) => {\n      if (data && data.scrollPosition > 0) {\n        window.scrollTo(0, data.scrollPosition);\n      }\n    });\n  }, []);\n\n  // Save scroll position (debounced)\n  useEffect(() => {\n    if (!onSaveProgress) return;\n\n    const handleScroll = () => {\n      if (saveTimerRef.current) clearTimeout(saveTimerRef.current);\n      saveTimerRef.current = setTimeout(() => {\n        onSaveProgress({\n          page: 0,\n          totalPages: 0,\n          scrollPosition: window.scrollY,\n        });\n      }, 500);\n    };\n\n    window.addEventListener(\"scroll\", handleScroll, { passive: true });\n    return () => {\n      window.removeEventListener(\"scroll\", handleScroll);\n      if (saveTimerRef.current) clearTimeout(saveTimerRef.current);\n    };\n  }, [onSaveProgress]);\n\n  // Save on page unload\n  useEffect(() => {\n    if (!onSaveProgress) return;\n\n    const handleUnload = () => {\n      onSaveProgress({\n        page: 0,\n        totalPages: 0,\n        scrollPosition: window.scrollY,\n      });\n    };\n\n    window.addEventListener(\"beforeunload\", handleUnload);\n    return () => window.removeEventListener(\"beforeunload\", handleUnload);\n  }, [onSaveProgress]);\n\n  return (\n    <div class=\"pressy-reader\" onClick={handleReaderClick}>\n      <main class=\"pressy-reader-main\">\n        <article\n          class={`pressy-prose ${showDropCap ? \"\" : \"no-drop-cap\"}`}\n          data-drop-cap={showDropCap}\n        >\n          {children}\n        </article>\n      </main>\n\n      <TextShare />\n      <Navigation prev={prevChapter} next={nextChapter} />\n      <OfflineIndicator />\n\n      {/* TOC drawer overlay */}\n      {tocOpen && allChapters && (\n        <div\n          class=\"pressy-toc-backdrop pressy-toc-backdrop--scroll\"\n          onClick={(e: MouseEvent) => {\n            e.stopPropagation();\n            setTocOpen(false);\n          }}\n        >\n          <div\n            class=\"pressy-toc-drawer\"\n            onClick={(e: MouseEvent) => e.stopPropagation()}\n          >\n            <div class=\"pressy-toc-header\">\n              <span class=\"pressy-toc-title\">Contents</span>\n              <button\n                class=\"pressy-toc-close\"\n                onClick={(e: MouseEvent) => {\n                  e.stopPropagation();\n                  setTocOpen(false);\n                }}\n                aria-label=\"Close table of contents\"\n              >\n                <svg\n                  viewBox=\"0 0 24 24\"\n                  fill=\"none\"\n                  stroke=\"currentColor\"\n                  stroke-width=\"2\"\n                  width=\"18\"\n                  height=\"18\"\n                >\n                  <line x1=\"18\" y1=\"6\" x2=\"6\" y2=\"18\" />\n                  <line x1=\"6\" y1=\"6\" x2=\"18\" y2=\"18\" />\n                </svg>\n              </button>\n            </div>\n            <nav class=\"pressy-toc-list\">\n              <a\n                href={bookBasePath ? bookBasePath.replace(/\\/books\\/[^/]+$/, '') || '/' : '/'}\n                class=\"pressy-toc-item pressy-toc-item--home\"\n                onClick={() => setTocOpen(false)}\n              >\n                <span class=\"pressy-toc-item-num\">\n                  <svg viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" width=\"14\" height=\"14\">\n                    <path d=\"M3 9.5L12 3l9 6.5V20a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V9.5z\" />\n                  </svg>\n                </span>\n                <span class=\"pressy-toc-item-title\">{bookTitle || 'Home'}</span>\n              </a>\n              {allChapters.map((ch, i) => (\n                <a\n                  key={ch.slug}\n                  href={`${bookBasePath || \"\"}/${ch.slug}`}\n                  class={`pressy-toc-item ${\n                    ch.slug === currentChapterSlug\n                      ? \"pressy-toc-item--active\"\n                      : \"\"\n                  }`}\n                  onClick={() => setTocOpen(false)}\n                >\n                  <span class=\"pressy-toc-item-num\">{i + 1}.</span>\n                  <span class=\"pressy-toc-item-title\">{ch.title}</span>\n                </a>\n              ))}\n            </nav>\n          </div>\n        </div>\n      )}\n\n      {/* Footer */}\n      <div\n        class={`pressy-page-footer pressy-page-footer--scroll ${\n          footerVisible || settingsOpen || tocOpen\n            ? \"pressy-page-footer--visible\"\n            : \"\"\n        }`}\n      >\n        <div class=\"pressy-footer-row\">\n          {allChapters && allChapters.length > 0 && (\n            <button\n              class=\"pressy-toc-toggle\"\n              onClick={(e: MouseEvent) => {\n                e.stopPropagation();\n                setSettingsOpen(false);\n                setTocOpen(!tocOpen);\n              }}\n              aria-label=\"Table of contents\"\n            >\n              <svg\n                viewBox=\"0 0 24 24\"\n                fill=\"none\"\n                stroke=\"currentColor\"\n                stroke-width=\"1.5\"\n                stroke-linecap=\"round\"\n                stroke-linejoin=\"round\"\n                width=\"18\"\n                height=\"18\"\n              >\n                <line x1=\"3\" y1=\"6\" x2=\"21\" y2=\"6\" />\n                <line x1=\"3\" y1=\"12\" x2=\"21\" y2=\"12\" />\n                <line x1=\"3\" y1=\"18\" x2=\"21\" y2=\"18\" />\n              </svg>\n            </button>\n          )}\n          {bookTitle && (\n            <button\n              class=\"pressy-footer-title\"\n              onClick={(e: MouseEvent) => {\n                e.stopPropagation();\n                if (allChapters && allChapters.length > 0) {\n                  setSettingsOpen(false);\n                  setTocOpen(!tocOpen);\n                }\n              }}\n            >\n              {bookTitle}\n            </button>\n          )}\n          <OfflineFooterIcon offlineProps={offlineProps} />\n          <button\n            class=\"pressy-settings-toggle\"\n            onClick={(e: MouseEvent) => {\n              e.stopPropagation();\n              setTocOpen(false);\n              setSettingsOpen(!settingsOpen);\n            }}\n            aria-label=\"Settings\"\n          >\n            <svg\n              viewBox=\"0 0 24 24\"\n              fill=\"none\"\n              stroke=\"currentColor\"\n              stroke-width=\"1.5\"\n              stroke-linecap=\"round\"\n              stroke-linejoin=\"round\"\n              width=\"18\"\n              height=\"18\"\n            >\n              <circle cx=\"12\" cy=\"12\" r=\"3\" />\n              <path d=\"M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z\" />\n            </svg>\n          </button>\n        </div>\n\n        {/* Settings panel */}\n        <div\n          class={`pressy-settings-panel ${\n            settingsOpen ? \"pressy-settings-panel--open\" : \"\"\n          }`}\n        >\n          <div class=\"pressy-settings-section\">\n            <div class=\"pressy-settings-label\">Theme</div>\n            <div class=\"pressy-theme-options\">\n              {(\n                [\n                  {\n                    id: \"light\",\n                    label: \"Light\",\n                    icon: (\n                      <svg\n                        viewBox=\"0 0 24 24\"\n                        fill=\"none\"\n                        stroke=\"currentColor\"\n                        stroke-width=\"1.5\"\n                        width=\"16\"\n                        height=\"16\"\n                      >\n                        <circle cx=\"12\" cy=\"12\" r=\"5\" />\n                        <line x1=\"12\" y1=\"1\" x2=\"12\" y2=\"3\" />\n                        <line x1=\"12\" y1=\"21\" x2=\"12\" y2=\"23\" />\n                        <line x1=\"4.22\" y1=\"4.22\" x2=\"5.64\" y2=\"5.64\" />\n                        <line x1=\"18.36\" y1=\"18.36\" x2=\"19.78\" y2=\"19.78\" />\n                        <line x1=\"1\" y1=\"12\" x2=\"3\" y2=\"12\" />\n                        <line x1=\"21\" y1=\"12\" x2=\"23\" y2=\"12\" />\n                        <line x1=\"4.22\" y1=\"19.78\" x2=\"5.64\" y2=\"18.36\" />\n                        <line x1=\"18.36\" y1=\"5.64\" x2=\"19.78\" y2=\"4.22\" />\n                      </svg>\n                    ),\n                  },\n                  {\n                    id: \"dark\",\n                    label: \"Dark\",\n                    icon: (\n                      <svg\n                        viewBox=\"0 0 24 24\"\n                        fill=\"none\"\n                        stroke=\"currentColor\"\n                        stroke-width=\"1.5\"\n                        width=\"16\"\n                        height=\"16\"\n                      >\n                        <path d=\"M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z\" />\n                      </svg>\n                    ),\n                  },\n                  {\n                    id: \"system\",\n                    label: \"System\",\n                    icon: (\n                      <svg\n                        viewBox=\"0 0 24 24\"\n                        fill=\"none\"\n                        stroke=\"currentColor\"\n                        stroke-width=\"1.5\"\n                        width=\"16\"\n                        height=\"16\"\n                      >\n                        <rect\n                          x=\"2\"\n                          y=\"3\"\n                          width=\"20\"\n                          height=\"14\"\n                          rx=\"2\"\n                          ry=\"2\"\n                        />\n                        <line x1=\"8\" y1=\"21\" x2=\"16\" y2=\"21\" />\n                        <line x1=\"12\" y1=\"17\" x2=\"12\" y2=\"21\" />\n                      </svg>\n                    ),\n                  },\n                  {\n                    id: \"sepia\",\n                    label: \"Sepia\",\n                    icon: (\n                      <svg\n                        viewBox=\"0 0 24 24\"\n                        fill=\"none\"\n                        stroke=\"currentColor\"\n                        stroke-width=\"1.5\"\n                        width=\"16\"\n                        height=\"16\"\n                      >\n                        <path d=\"M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z\" />\n                        <path d=\"M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z\" />\n                      </svg>\n                    ),\n                  },\n                ] as const\n              ).map((t) => (\n                <button\n                  key={t.id}\n                  class={`pressy-theme-btn ${\n                    activeTheme === t.id ? \"pressy-theme-btn--active\" : \"\"\n                  }`}\n                  onClick={(e: MouseEvent) => {\n                    e.stopPropagation();\n                    handleThemeChange(t.id);\n                  }}\n                >\n                  {t.icon}\n                  <span>{t.label}</span>\n                </button>\n              ))}\n            </div>\n          </div>\n          <div class=\"pressy-settings-section\">\n            <div class=\"pressy-settings-label\">Font Size</div>\n            <div class=\"pressy-font-size-controls\">\n              <button\n                class=\"pressy-font-size-btn\"\n                onClick={(e: MouseEvent) => {\n                  e.stopPropagation();\n                  handleFontSizeChange(-0.1);\n                }}\n                disabled={fontScale <= 0.8}\n                aria-label=\"Decrease font size\"\n              >\n                A-\n              </button>\n              <span class=\"pressy-font-size-value\">\n                {Math.round(fontScale * 100)}%\n              </span>\n              <button\n                class=\"pressy-font-size-btn\"\n                onClick={(e: MouseEvent) => {\n                  e.stopPropagation();\n                  handleFontSizeChange(0.1);\n                }}\n                disabled={fontScale >= 1.5}\n                aria-label=\"Increase font size\"\n              >\n                A+\n              </button>\n            </div>\n          </div>\n        </div>\n      </div>\n\n      <style>{SCROLL_STYLES}</style>\n    </div>\n  );\n}\n\n// ── Paginated Reader ──────────────────────────────────────────\n\ninterface LoadedChapter {\n  slug: string;\n  title: string;\n  Content: ComponentType<{ components?: Record<string, unknown> }>;\n}\n\ninterface ChapterPageRange {\n  slug: string;\n  startPage: number;\n  endPage: number;\n}\n\ninterface PaginatedReaderProps {\n  children: ComponentChildren;\n  bookTitle?: string;\n  prevChapter?: { slug: string; title: string };\n  nextChapter?: { slug: string; title: string };\n  showDropCap: boolean;\n  onSaveProgress?: (data: ProgressData) => void;\n  onRestoreProgress?: () => Promise<ProgressData | null>;\n  bookProgressPercent?: number;\n  initialContent?: ComponentType<{ components?: Record<string, unknown> }>;\n  chapterMapData?: ChapterMapData;\n  currentChapterSlug?: string;\n  allChapters?: Array<{ slug: string; title: string; wordCount?: number }>;\n  bookBasePath?: string;\n  onChapterChange?: (slug: string, page: number, totalPages: number) => void;\n  mdxComponents?: Record<string, unknown>;\n  offlineProps?: OfflineProps;\n}\n\nfunction ChapterDivider({ title }: { title: string }) {\n  return (\n    <div class=\"pressy-chapter-divider\">\n      <h2 class=\"pressy-chapter-divider-title\">{title}</h2>\n    </div>\n  );\n}\n\nfunction PaginatedReader({\n  children,\n  bookTitle,\n  prevChapter,\n  nextChapter,\n  showDropCap,\n  onSaveProgress,\n  onRestoreProgress,\n  bookProgressPercent,\n  initialContent,\n  chapterMapData,\n  currentChapterSlug,\n  allChapters,\n  bookBasePath,\n  onChapterChange,\n  mdxComponents,\n  offlineProps,\n}: PaginatedReaderProps) {\n  const containerRef = useRef<HTMLDivElement>(null);\n  const viewportRef = useRef<HTMLDivElement>(null);\n  const articleRef = useRef<HTMLElement>(null);\n  const [currentPage, setCurrentPage] = useState(0);\n  const [totalPages, setTotalPages] = useState(1);\n  const hasRestoredRef = useRef(false);\n  const saveTimerRef = useRef<ReturnType<typeof setTimeout> | null>(null);\n\n  // Multi-chapter state\n  const [loadedChapters, setLoadedChapters] = useState<LoadedChapter[]>([]);\n  const [chapterRanges, setChapterRanges] = useState<ChapterPageRange[]>([]);\n  const [activeChapterSlug, setActiveChapterSlug] = useState(\n    currentChapterSlug || \"\"\n  );\n  const preloadingRef = useRef<Set<string>>(new Set());\n\n  // Whether we're in multi-chapter mode\n  const isMultiChapter = !!(\n    chapterMapData &&\n    initialContent &&\n    currentChapterSlug &&\n    allChapters\n  );\n\n  // Initialize loaded chapters\n  useEffect(() => {\n    if (isMultiChapter && initialContent && currentChapterSlug) {\n      const chapterInfo = allChapters!.find(\n        (ch) => ch.slug === currentChapterSlug\n      );\n      setLoadedChapters([\n        {\n          slug: currentChapterSlug,\n          title: chapterInfo?.title || currentChapterSlug,\n          Content: initialContent,\n        },\n      ]);\n      setActiveChapterSlug(currentChapterSlug);\n    }\n  }, []); // Only on mount\n\n  // Settings & TOC panel state\n  const [settingsOpen, setSettingsOpen] = useState(false);\n  const [tocOpen, setTocOpen] = useState(false);\n  const [activeTheme, setActiveTheme] = useState<string>(() => {\n    if (typeof localStorage !== \"undefined\") {\n      return localStorage.getItem(\"pressy-theme\") || \"light\";\n    }\n    return \"light\";\n  });\n  const [fontScale, setFontScale] = useState<number>(() => {\n    if (typeof localStorage !== \"undefined\") {\n      const saved = localStorage.getItem(\"pressy-font-size\");\n      return saved ? parseFloat(saved) : 1.0;\n    }\n    return 1.0;\n  });\n\n  const applyFontScale = useCallback((scale: number) => {\n    if (scale === 1.0) {\n      document.documentElement.style.removeProperty(\"--font-size-base\");\n    } else {\n      document.documentElement.style.setProperty(\n        \"--font-size-base\",\n        `calc(clamp(1rem, 0.875rem + 0.5vw, 1.25rem) * ${scale})`\n      );\n    }\n  }, []);\n\n  // Apply saved font scale on mount\n  useEffect(() => {\n    if (fontScale !== 1.0) {\n      applyFontScale(fontScale);\n    }\n  }, []);\n\n  const handleThemeChange = useCallback((theme: string) => {\n    setActiveTheme(theme);\n    localStorage.setItem(\"pressy-theme\", theme);\n    const resolved =\n      theme === \"system\"\n        ? window.matchMedia(\"(prefers-color-scheme: dark)\").matches\n          ? \"dark\"\n          : \"light\"\n        : theme;\n    document.documentElement.setAttribute(\"data-theme\", resolved);\n  }, []);\n\n  // Drag/swipe state\n  const [isDragging, setIsDragging] = useState(false);\n  const [dragOffset, setDragOffset] = useState(0);\n  const [chapterHint, setChapterHint] = useState<\"next\" | \"prev\" | null>(null);\n\n  // Touch tracking refs (avoid re-renders during drag)\n  const touchStartXRef = useRef(0);\n  const touchStartYRef = useRef(0);\n  const lastTouchXRef = useRef(0);\n  const lastTouchTimeRef = useRef(0);\n  const velocityRef = useRef(0);\n  const isSwipingRef = useRef(false);\n  const isDraggingRef = useRef(false);\n\n  // Build page-to-chapter map after recalculating pages\n  const updateChapterRanges = useCallback(() => {\n    if (!isMultiChapter) return;\n    const article = articleRef.current;\n    const viewport = viewportRef.current;\n    if (!article || !viewport) return;\n\n    const viewportWidth = viewport.clientWidth;\n    if (viewportWidth === 0) return;\n\n    const sections = article.querySelectorAll(\".pressy-chapter-section\");\n    const ranges: ChapterPageRange[] = [];\n\n    sections.forEach((section) => {\n      const slug = section.getAttribute(\"data-chapter-slug\") || \"\";\n      const sectionLeft = (section as HTMLElement).offsetLeft;\n      const sectionWidth = (section as HTMLElement).scrollWidth;\n      const startPage = Math.floor(sectionLeft / viewportWidth);\n      const endPage = Math.max(\n        startPage,\n        Math.ceil((sectionLeft + sectionWidth) / viewportWidth) - 1\n      );\n      ranges.push({ slug, startPage, endPage });\n    });\n\n    setChapterRanges(ranges);\n  }, [isMultiChapter]);\n\n  // Calculate page count and set column-width to match viewport\n  const recalculatePages = useCallback(() => {\n    const article = articleRef.current;\n    const viewport = viewportRef.current;\n    if (!article || !viewport) return;\n\n    const viewportWidth = viewport.clientWidth;\n    if (viewportWidth === 0) return;\n\n    // Set column-width to viewport width so each column = one page\n    article.style.columnWidth = `${viewportWidth}px`;\n\n    // Force synchronous layout recalculation\n    void article.scrollWidth;\n\n    const total = Math.max(1, Math.round(article.scrollWidth / viewportWidth));\n    setTotalPages(total);\n\n    // Clamp current page if now out of bounds (e.g. after resize)\n    setCurrentPage((prev) => Math.min(prev, total - 1));\n\n    // Update chapter ranges for multi-chapter mode\n    updateChapterRanges();\n  }, [updateChapterRanges]);\n\n  // Font size change handler (defined after recalculatePages)\n  const handleFontSizeChange = useCallback(\n    (delta: number) => {\n      setFontScale((prev) => {\n        const next =\n          Math.round(Math.max(0.8, Math.min(1.5, prev + delta)) * 10) / 10;\n        localStorage.setItem(\"pressy-font-size\", String(next));\n        applyFontScale(next);\n        setTimeout(() => recalculatePages(), 100);\n        return next;\n      });\n    },\n    [applyFontScale, recalculatePages]\n  );\n\n  // Recalculate on mount and on resize via ResizeObserver\n  useEffect(() => {\n    const viewport = viewportRef.current;\n    if (!viewport) return;\n\n    // Delay initial calculation to let fonts and content render\n    const initialTimer = setTimeout(recalculatePages, 50);\n\n    const observer = new ResizeObserver(() => {\n      recalculatePages();\n    });\n    observer.observe(viewport);\n\n    return () => {\n      clearTimeout(initialTimer);\n      observer.disconnect();\n    };\n  }, [recalculatePages]);\n\n  // Recalculate when loaded chapters change\n  useEffect(() => {\n    if (loadedChapters.length > 0) {\n      // Delay to let new content render\n      const timer = setTimeout(recalculatePages, 50);\n      return () => clearTimeout(timer);\n    }\n  }, [loadedChapters.length, recalculatePages]);\n\n  // Recalculate when images finish loading\n  useEffect(() => {\n    const article = articleRef.current;\n    if (!article) return;\n\n    const images = article.querySelectorAll(\"img\");\n    if (images.length === 0) return;\n\n    const onLoad = () => recalculatePages();\n    images.forEach((img) => {\n      if (!img.complete) {\n        img.addEventListener(\"load\", onLoad);\n        img.addEventListener(\"error\", onLoad);\n      }\n    });\n\n    return () => {\n      images.forEach((img) => {\n        img.removeEventListener(\"load\", onLoad);\n        img.removeEventListener(\"error\", onLoad);\n      });\n    };\n  }, [recalculatePages, loadedChapters.length]);\n\n  // Check ?page=last query param for backward navigation\n  useEffect(() => {\n    const params = new URLSearchParams(window.location.search);\n    if (params.get(\"page\") === \"last\" && totalPages > 1) {\n      setCurrentPage(totalPages - 1);\n      hasRestoredRef.current = true;\n      // Clean up the URL\n      const url = new URL(window.location.href);\n      url.searchParams.delete(\"page\");\n      history.replaceState(null, \"\", url.pathname);\n    }\n  }, [totalPages]);\n\n  // Apply translateX — combines page position + drag offset\n  useEffect(() => {\n    const article = articleRef.current;\n    const viewport = viewportRef.current;\n    if (!article || !viewport) return;\n\n    const baseOffset = currentPage * viewport.clientWidth;\n    const totalOffset = baseOffset - dragOffset;\n\n    if (isDragging) {\n      // During drag: no transition, immediate response\n      article.style.transition = \"none\";\n    } else {\n      // Snap animation: smooth ease-out\n      article.style.transition =\n        \"transform 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94)\";\n    }\n\n    article.style.transform = `translateX(-${totalOffset}px)`;\n  }, [currentPage, dragOffset, isDragging]);\n\n  // Manage focusability: elements on off-screen pages get tabindex=\"-1\"\n  // so tab navigation can't reach them and cause layout shifts.\n  // Uses getBoundingClientRect which accounts for the CSS transform.\n  useEffect(() => {\n    const article = articleRef.current;\n    const viewport = viewportRef.current;\n    if (!article || !viewport) return;\n\n    const viewportRect = viewport.getBoundingClientRect();\n\n    const focusable = article.querySelectorAll<HTMLElement>(\n      \"a[href], button, input, select, textarea, [tabindex]\"\n    );\n\n    focusable.forEach((el) => {\n      const elRect = el.getBoundingClientRect();\n      const onCurrentPage =\n        elRect.left >= viewportRect.left - 1 &&\n        elRect.right <= viewportRect.right + 1;\n\n      if (onCurrentPage) {\n        const original = el.getAttribute(\"data-original-tabindex\");\n        if (original !== null) {\n          if (original === \"\") {\n            el.removeAttribute(\"tabindex\");\n          } else {\n            el.setAttribute(\"tabindex\", original);\n          }\n          el.removeAttribute(\"data-original-tabindex\");\n        }\n      } else {\n        if (!el.hasAttribute(\"data-original-tabindex\")) {\n          el.setAttribute(\n            \"data-original-tabindex\",\n            el.getAttribute(\"tabindex\") || \"\"\n          );\n        }\n        el.setAttribute(\"tabindex\", \"-1\");\n      }\n    });\n  }, [currentPage, totalPages]);\n\n  // Preload next chapter when within 2 pages of chapter end\n  useEffect(() => {\n    if (!isMultiChapter || !chapterMapData || chapterRanges.length === 0)\n      return;\n\n    const activeRange = chapterRanges.find((r) => r.slug === activeChapterSlug);\n    if (!activeRange) return;\n\n    const pagesFromEnd = activeRange.endPage - currentPage;\n    if (pagesFromEnd > 2) return;\n\n    // Find the next chapter to preload\n    const { chapterOrder, chapterMap } = chapterMapData;\n    const lastLoadedSlug = loadedChapters[loadedChapters.length - 1]?.slug;\n    const lastLoadedIdx = chapterOrder.indexOf(lastLoadedSlug);\n    if (lastLoadedIdx === -1 || lastLoadedIdx >= chapterOrder.length - 1)\n      return;\n\n    const nextSlug = chapterOrder[lastLoadedIdx + 1];\n    if (preloadingRef.current.has(nextSlug)) return;\n    if (loadedChapters.some((ch) => ch.slug === nextSlug)) return;\n\n    preloadingRef.current.add(nextSlug);\n\n    const loader = chapterMap[nextSlug];\n    if (!loader) return;\n\n    loader()\n      .then((mod) => {\n        const Content = mod.default;\n        const chapterInfo = allChapters!.find((ch) => ch.slug === nextSlug);\n        setLoadedChapters((prev) => {\n          if (prev.some((ch) => ch.slug === nextSlug)) return prev;\n          return [\n            ...prev,\n            {\n              slug: nextSlug,\n              title: chapterInfo?.title || nextSlug,\n              Content,\n            },\n          ];\n        });\n      })\n      .catch(() => {\n        // Dynamic import failed — will fall back to full-page navigation\n        preloadingRef.current.delete(nextSlug);\n      });\n  }, [\n    currentPage,\n    activeChapterSlug,\n    chapterRanges,\n    isMultiChapter,\n    chapterMapData,\n    loadedChapters,\n    allChapters,\n  ]);\n\n  // Detect chapter boundary crossings and update URL / active chapter\n  useEffect(() => {\n    if (!isMultiChapter || chapterRanges.length === 0 || !bookBasePath) return;\n\n    const currentRange = chapterRanges.find(\n      (r) => currentPage >= r.startPage && currentPage <= r.endPage\n    );\n    if (!currentRange || currentRange.slug === activeChapterSlug) return;\n\n    const prevSlug = activeChapterSlug;\n    setActiveChapterSlug(currentRange.slug);\n\n    // Update URL\n    const newPath = `${bookBasePath}/${currentRange.slug}`;\n    history.replaceState(null, \"\", newPath);\n\n    // Update document title\n    const chapterInfo = allChapters?.find(\n      (ch) => ch.slug === currentRange.slug\n    );\n    if (chapterInfo) {\n      document.title = document.title.replace(\n        /^[^|]+/,\n        chapterInfo.title + \" \"\n      );\n    }\n\n    // Notify parent about chapter change (saves progress for the chapter being left)\n    if (onChapterChange && prevSlug) {\n      const prevRange = chapterRanges.find((r) => r.slug === prevSlug);\n      if (prevRange) {\n        const prevTotalPages = prevRange.endPage - prevRange.startPage + 1;\n        onChapterChange(prevSlug, prevTotalPages - 1, prevTotalPages);\n      }\n    }\n  }, [\n    currentPage,\n    chapterRanges,\n    activeChapterSlug,\n    isMultiChapter,\n    bookBasePath,\n    allChapters,\n    onChapterChange,\n  ]);\n\n  // Save progress when page changes (debounced) — save relative to active chapter\n  useEffect(() => {\n    if (!onSaveProgress || !hasRestoredRef.current) return;\n\n    if (saveTimerRef.current) clearTimeout(saveTimerRef.current);\n    saveTimerRef.current = setTimeout(() => {\n      if (isMultiChapter && chapterRanges.length > 0) {\n        const activeRange = chapterRanges.find(\n          (r) => r.slug === activeChapterSlug\n        );\n        if (activeRange) {\n          const chapterPage = currentPage - activeRange.startPage;\n          const chapterTotalPages =\n            activeRange.endPage - activeRange.startPage + 1;\n          onSaveProgress({\n            page: chapterPage,\n            totalPages: chapterTotalPages,\n            scrollPosition: 0,\n          });\n        }\n      } else {\n        onSaveProgress({\n          page: currentPage,\n          totalPages,\n          scrollPosition: 0,\n        });\n      }\n    }, 300);\n\n    return () => {\n      if (saveTimerRef.current) clearTimeout(saveTimerRef.current);\n    };\n  }, [\n    currentPage,\n    totalPages,\n    onSaveProgress,\n    isMultiChapter,\n    chapterRanges,\n    activeChapterSlug,\n  ]);\n\n  // Save progress on page unload\n  useEffect(() => {\n    if (!onSaveProgress) return;\n\n    const handleUnload = () => {\n      if (isMultiChapter && chapterRanges.length > 0) {\n        const activeRange = chapterRanges.find(\n          (r) => r.slug === activeChapterSlug\n        );\n        if (activeRange) {\n          const chapterPage = currentPage - activeRange.startPage;\n          const chapterTotalPages =\n            activeRange.endPage - activeRange.startPage + 1;\n          onSaveProgress({\n            page: chapterPage,\n            totalPages: chapterTotalPages,\n            scrollPosition: 0,\n          });\n        }\n      } else {\n        onSaveProgress({\n          page: currentPage,\n          totalPages,\n          scrollPosition: 0,\n        });\n      }\n    };\n\n    window.addEventListener(\"beforeunload\", handleUnload);\n    return () => window.removeEventListener(\"beforeunload\", handleUnload);\n  }, [\n    currentPage,\n    totalPages,\n    onSaveProgress,\n    isMultiChapter,\n    chapterRanges,\n    activeChapterSlug,\n  ]);\n\n  // Determine the effective last chapter slug for rubber-band / next chapter hint\n  const effectiveNextChapter = (() => {\n    if (!isMultiChapter || !chapterMapData) return nextChapter;\n    const { chapterOrder } = chapterMapData;\n    const lastLoadedSlug = loadedChapters[loadedChapters.length - 1]?.slug;\n    const lastLoadedIdx = chapterOrder.indexOf(lastLoadedSlug);\n    // If we haven't loaded the last chapter in the book yet, no next chapter hint needed\n    // (preloading will seamlessly add the next chapter)\n    if (lastLoadedIdx < chapterOrder.length - 1) return undefined;\n    // All chapters loaded — navigate to book table of contents\n    if (bookBasePath) return { slug: bookBasePath, title: \"Table of Contents\" };\n    return nextChapter;\n  })();\n\n  // Determine the effective prev chapter for backward navigation\n  const effectivePrevChapter = (() => {\n    if (!isMultiChapter || !chapterMapData) return prevChapter;\n    const { chapterOrder } = chapterMapData;\n    const firstLoadedSlug = loadedChapters[0]?.slug;\n    const firstLoadedIdx = chapterOrder.indexOf(firstLoadedSlug);\n    // If the first loaded chapter is the first chapter of the book\n    if (firstLoadedIdx <= 0) return prevChapter;\n    // There's a previous chapter in the book — navigate to it via page load\n    const prevSlug = chapterOrder[firstLoadedIdx - 1];\n    const prevInfo = allChapters?.find((ch) => ch.slug === prevSlug);\n    return {\n      slug: `${bookBasePath}/${prevSlug}?page=last`,\n      title: prevInfo?.title || prevSlug,\n    };\n  })();\n\n  const goToPage = useCallback(\n    (page: number) => {\n      const clamped = Math.max(0, Math.min(page, totalPages - 1));\n      setCurrentPage(clamped);\n    },\n    [totalPages]\n  );\n\n  const goNext = useCallback(() => {\n    if (currentPage >= totalPages - 1) {\n      // At the last page — navigate to next chapter if available\n      if (effectiveNextChapter) {\n        window.location.href = effectiveNextChapter.slug;\n      }\n      return;\n    }\n    goToPage(currentPage + 1);\n  }, [currentPage, totalPages, effectiveNextChapter, goToPage]);\n\n  const goPrev = useCallback(() => {\n    if (currentPage <= 0) {\n      // At the first page — navigate to prev chapter if available\n      if (effectivePrevChapter) {\n        window.location.href = effectivePrevChapter.slug;\n      }\n      return;\n    }\n    goToPage(currentPage - 1);\n  }, [currentPage, effectivePrevChapter, goToPage]);\n\n  // Footer visibility — hidden by default, shown on interaction\n  const [footerVisible, setFooterVisible] = useState(false);\n  const footerTimerRef = useRef<ReturnType<typeof setTimeout> | null>(null);\n\n  const showFooterTemporarily = useCallback(() => {\n    setFooterVisible(true);\n    if (footerTimerRef.current) clearTimeout(footerTimerRef.current);\n    footerTimerRef.current = setTimeout(() => setFooterVisible(false), 3000);\n  }, []);\n\n  // Double-tap fullscreen (mobile middle-third)\n  const lastMiddleTapRef = useRef(0);\n  const middleTapTimerRef = useRef<ReturnType<typeof setTimeout> | null>(null);\n\n  const toggleFullscreen = useCallback(() => {\n    if (document.fullscreenElement) {\n      document.exitFullscreen();\n    } else {\n      document.documentElement.requestFullscreen().catch(() => {\n        // Fullscreen not supported or denied\n      });\n    }\n  }, []);\n\n  // Whether the device supports hover (i.e. desktop with a mouse).\n  // Touch-only devices use swipe for page turns; tapping just toggles the footer.\n  const isTouchDevice =\n    typeof window !== \"undefined\" && window.matchMedia(\"(hover: none)\").matches;\n\n  // Click handler: on desktop, edge clicks turn pages and middle clicks\n  // toggle footer / double-click fullscreen. On touch devices, any tap\n  // simply toggles the footer — swiping handles all page navigation.\n  const handleContainerClick = useCallback(\n    (e: MouseEvent) => {\n      const target = e.target as HTMLElement;\n\n      // Clicks inside panels or on interactive elements — ignore\n      if (\n        target.closest(\n          \".pressy-settings-panel, .pressy-settings-toggle, .pressy-toc-drawer, .pressy-toc-toggle\"\n        )\n      )\n        return;\n      if (target.closest('a, button, input, select, textarea, [role=\"button\"]'))\n        return;\n\n      // If settings or TOC panel is open, close it on any outside click\n      if (settingsOpen || tocOpen) {\n        setSettingsOpen(false);\n        setTocOpen(false);\n        return;\n      }\n\n      // Touch devices: tap anywhere toggles the footer, nothing else\n      if (isTouchDevice) {\n        if (footerVisible) {\n          setFooterVisible(false);\n          if (footerTimerRef.current) clearTimeout(footerTimerRef.current);\n        } else {\n          showFooterTemporarily();\n        }\n        return;\n      }\n\n      // Desktop: edge clicks turn pages, middle clicks toggle footer / fullscreen\n      const container = containerRef.current;\n      if (!container) return;\n\n      const rect = container.getBoundingClientRect();\n      const x = e.clientX - rect.left;\n      const edgeZone = rect.width * 0.15;\n\n      if (x < edgeZone) {\n        goPrev();\n      } else if (x > rect.width - edgeZone) {\n        goNext();\n      } else {\n        // Middle third — single click toggles footer, double click toggles fullscreen\n        const now = Date.now();\n        const timeSinceLastTap = now - lastMiddleTapRef.current;\n        lastMiddleTapRef.current = now;\n\n        if (timeSinceLastTap < 300) {\n          if (middleTapTimerRef.current)\n            clearTimeout(middleTapTimerRef.current);\n          toggleFullscreen();\n        } else {\n          if (middleTapTimerRef.current)\n            clearTimeout(middleTapTimerRef.current);\n          middleTapTimerRef.current = setTimeout(() => {\n            if (footerVisible) {\n              setFooterVisible(false);\n              if (footerTimerRef.current) clearTimeout(footerTimerRef.current);\n            } else {\n              showFooterTemporarily();\n            }\n          }, 300);\n        }\n      }\n    },\n    [\n      goNext,\n      goPrev,\n      footerVisible,\n      isTouchDevice,\n      settingsOpen,\n      tocOpen,\n      showFooterTemporarily,\n      toggleFullscreen,\n    ]\n  );\n\n  // Hover zone tracking for desktop navigation hints\n  const [hoverZone, setHoverZone] = useState<\"left\" | \"right\" | null>(null);\n\n  const handleMouseMove = useCallback(\n    (e: MouseEvent) => {\n      const container = containerRef.current;\n      if (!container) return;\n\n      const rect = container.getBoundingClientRect();\n      const x = e.clientX - rect.left;\n      const y = e.clientY - rect.top;\n      const third = rect.width / 3;\n\n      if (x < third) {\n        setHoverZone(\"left\");\n      } else if (x > third * 2) {\n        setHoverZone(\"right\");\n      } else {\n        setHoverZone(null);\n      }\n\n      // Show footer when mouse is in the bottom quarter\n      if (y > rect.height * 0.75) {\n        setFooterVisible(true);\n        if (footerTimerRef.current) clearTimeout(footerTimerRef.current);\n      } else if (!settingsOpen && !tocOpen) {\n        // Hide after a short delay when leaving the bottom area (not when panels are open)\n        if (footerTimerRef.current) clearTimeout(footerTimerRef.current);\n        footerTimerRef.current = setTimeout(() => setFooterVisible(false), 600);\n      }\n    },\n    [settingsOpen, tocOpen]\n  );\n\n  const handleMouseLeave = useCallback(() => {\n    setHoverZone(null);\n    if (!settingsOpen && !tocOpen) {\n      if (footerTimerRef.current) clearTimeout(footerTimerRef.current);\n      footerTimerRef.current = setTimeout(() => setFooterVisible(false), 600);\n    }\n  }, [settingsOpen, tocOpen]);\n\n  // Keyboard navigation\n  useEffect(() => {\n    const handleKeyDown = (e: KeyboardEvent) => {\n      // Don't intercept if user is in an input/textarea\n      const tag = (e.target as HTMLElement).tagName;\n      if (tag === \"INPUT\" || tag === \"TEXTAREA\" || tag === \"SELECT\") return;\n\n      if (e.key === \"ArrowRight\" || e.key === \" \") {\n        e.preventDefault();\n        goNext();\n      } else if (e.key === \"ArrowLeft\") {\n        e.preventDefault();\n        goPrev();\n      } else if (e.key === \"Home\") {\n        e.preventDefault();\n        goToPage(0);\n      } else if (e.key === \"End\") {\n        e.preventDefault();\n        goToPage(totalPages - 1);\n      }\n    };\n\n    window.addEventListener(\"keydown\", handleKeyDown);\n    return () => window.removeEventListener(\"keydown\", handleKeyDown);\n  }, [goNext, goPrev, goToPage, totalPages]);\n\n  // Touch swipe navigation with drag tracking, velocity detection, and rubber-band.\n  // Listeners attach to the outer container (not the viewport) so they capture\n  // touches that land on sibling elements like the tap-zone overlays.\n  useEffect(() => {\n    const container = containerRef.current;\n    if (!container) return;\n\n    const onTouchStart = (e: TouchEvent) => {\n      const touch = e.touches[0];\n      touchStartXRef.current = touch.clientX;\n      touchStartYRef.current = touch.clientY;\n      lastTouchXRef.current = touch.clientX;\n      lastTouchTimeRef.current = performance.now();\n      velocityRef.current = 0;\n      isSwipingRef.current = false;\n      isDraggingRef.current = false;\n    };\n\n    const onTouchMove = (e: TouchEvent) => {\n      const touch = e.touches[0];\n      const dx = touch.clientX - touchStartXRef.current;\n      const dy = touch.clientY - touchStartYRef.current;\n\n      // Lock direction after initial movement\n      if (!isSwipingRef.current) {\n        if (Math.abs(dx) > Math.abs(dy) && Math.abs(dx) > 10) {\n          isSwipingRef.current = true;\n        } else if (Math.abs(dy) > Math.abs(dx) && Math.abs(dy) > 10) {\n          // Vertical scroll — not our concern\n          return;\n        } else {\n          return; // Not enough movement yet\n        }\n      }\n\n      e.preventDefault();\n\n      // Track velocity (px per ms) using last touch position\n      const now = performance.now();\n      const timeDelta = now - lastTouchTimeRef.current;\n      if (timeDelta > 0) {\n        const instantVelocity =\n          (touch.clientX - lastTouchXRef.current) / timeDelta;\n        // Smooth velocity with exponential moving average\n        velocityRef.current = 0.6 * instantVelocity + 0.4 * velocityRef.current;\n      }\n      lastTouchXRef.current = touch.clientX;\n      lastTouchTimeRef.current = now;\n\n      // Determine drag offset with rubber-band resistance at boundaries\n      let offset = dx;\n      const atStart = currentPage === 0;\n      const atEnd = currentPage >= totalPages - 1;\n\n      if ((atStart && dx > 0) || (atEnd && dx < 0)) {\n        // Rubber-band: diminishing resistance using square root curve\n        // This gives a natural iOS-like rubber-band feel\n        const sign = dx > 0 ? 1 : -1;\n        const absDx = Math.abs(dx);\n        offset = sign * Math.sqrt(absDx) * 5;\n\n        // Show chapter hint when overscrolling past boundary\n        if (dx > 40 && atStart && effectivePrevChapter) {\n          setChapterHint(\"prev\");\n        } else if (dx < -40 && atEnd && effectiveNextChapter) {\n          setChapterHint(\"next\");\n        } else {\n          setChapterHint(null);\n        }\n      } else {\n        setChapterHint(null);\n      }\n\n      isDraggingRef.current = true;\n      setIsDragging(true);\n      setDragOffset(offset);\n    };\n\n    const onTouchEnd = (e: TouchEvent) => {\n      if (!isSwipingRef.current || !isDraggingRef.current) {\n        setIsDragging(false);\n        setDragOffset(0);\n        setChapterHint(null);\n        return;\n      }\n\n      const dx = e.changedTouches[0].clientX - touchStartXRef.current;\n      const velocity = velocityRef.current; // px/ms\n      const distanceThreshold = 50;\n      const velocityThreshold = 0.3; // px/ms — a fast flick\n      const chapterThreshold = 80;\n\n      const atStart = currentPage === 0;\n      const atEnd = currentPage >= totalPages - 1;\n\n      // Chapter navigation on overscroll\n      if (atEnd && dx < -chapterThreshold && effectiveNextChapter) {\n        setIsDragging(false);\n        setDragOffset(0);\n        setChapterHint(null);\n        window.location.href = effectiveNextChapter.slug;\n        return;\n      }\n      if (atStart && dx > chapterThreshold && effectivePrevChapter) {\n        setIsDragging(false);\n        setDragOffset(0);\n        setChapterHint(null);\n        window.location.href = effectivePrevChapter.slug;\n        return;\n      }\n\n      // Determine page change: distance OR velocity triggers a turn\n      if (dx < -distanceThreshold || velocity < -velocityThreshold) {\n        goNext();\n      } else if (dx > distanceThreshold || velocity > velocityThreshold) {\n        goPrev();\n      }\n\n      // Reset drag state — the CSS transition handles the snap animation\n      isDraggingRef.current = false;\n      setIsDragging(false);\n      setDragOffset(0);\n      setChapterHint(null);\n    };\n\n    // Cancel drag if touch is interrupted\n    const onTouchCancel = () => {\n      isDraggingRef.current = false;\n      setIsDragging(false);\n      setDragOffset(0);\n      setChapterHint(null);\n    };\n\n    container.addEventListener(\"touchstart\", onTouchStart, { passive: true });\n    container.addEventListener(\"touchmove\", onTouchMove, { passive: false });\n    container.addEventListener(\"touchend\", onTouchEnd, { passive: true });\n    container.addEventListener(\"touchcancel\", onTouchCancel, { passive: true });\n\n    return () => {\n      container.removeEventListener(\"touchstart\", onTouchStart);\n      container.removeEventListener(\"touchmove\", onTouchMove);\n      container.removeEventListener(\"touchend\", onTouchEnd);\n      container.removeEventListener(\"touchcancel\", onTouchCancel);\n    };\n  }, [\n    currentPage,\n    totalPages,\n    goNext,\n    goPrev,\n    effectiveNextChapter,\n    effectivePrevChapter,\n  ]);\n\n  // Compute per-chapter page indicator values\n  const chapterPageInfo = (() => {\n    if (!isMultiChapter || chapterRanges.length === 0) {\n      return { chapterPage: currentPage, chapterTotalPages: totalPages };\n    }\n    const activeRange = chapterRanges.find((r) => r.slug === activeChapterSlug);\n    if (!activeRange) {\n      return { chapterPage: currentPage, chapterTotalPages: totalPages };\n    }\n    return {\n      chapterPage: currentPage - activeRange.startPage,\n      chapterTotalPages: activeRange.endPage - activeRange.startPage + 1,\n    };\n  })();\n\n  // Book progress: position in the entire book based on word counts.\n  // Maps currentPage/totalPages (across all loaded content) through\n  // word counts to estimate absolute position in the full book.\n  const progressPercent = (() => {\n    if (!allChapters || allChapters.length === 0) {\n      return totalPages > 1 ? (currentPage / (totalPages - 1)) * 100 : 100;\n    }\n\n    const totalWords = allChapters.reduce(\n      (sum, ch) => sum + (ch.wordCount || 0),\n      0\n    );\n    if (totalWords === 0) return 0;\n\n    const firstLoadedSlug = loadedChapters[0]?.slug || activeChapterSlug;\n    let wordsBeforeLoaded = 0;\n    let loadedWords = 0;\n    let foundFirst = false;\n\n    for (const ch of allChapters) {\n      if (ch.slug === firstLoadedSlug) foundFirst = true;\n      if (!foundFirst) {\n        wordsBeforeLoaded += ch.wordCount || 0;\n      } else if (loadedChapters.some((lc) => lc.slug === ch.slug)) {\n        loadedWords += ch.wordCount || 0;\n      } else {\n        break;\n      }\n    }\n\n    const pageFraction = totalPages > 1 ? currentPage / (totalPages - 1) : 0;\n    const wordsInto = wordsBeforeLoaded + pageFraction * loadedWords;\n\n    return Math.min(100, (wordsInto / totalWords) * 100);\n  })();\n\n  // Render content — either multi-chapter sections or single-chapter children\n  const renderContent = () => {\n    if (isMultiChapter && loadedChapters.length > 0) {\n      return loadedChapters.map((ch) => (\n        <section\n          key={ch.slug}\n          class=\"pressy-chapter-section\"\n          data-chapter-slug={ch.slug}\n        >\n          <ChapterDivider title={ch.title} />\n          <ch.Content components={mdxComponents || {}} />\n        </section>\n      ));\n    }\n    return children;\n  };\n\n  return (\n    <div\n      class=\"pressy-reader pressy-reader--paginated\"\n      ref={containerRef}\n      onClick={handleContainerClick}\n      onMouseMove={handleMouseMove}\n      onMouseLeave={handleMouseLeave}\n    >\n      {/* Paginated content viewport */}\n      <div class=\"pressy-paginated-viewport\" ref={viewportRef}>\n        <article\n          ref={articleRef}\n          class={`pressy-prose pressy-prose--paginated ${\n            showDropCap ? \"\" : \"no-drop-cap\"\n          }`}\n          data-drop-cap={showDropCap}\n        >\n          {renderContent()}\n        </article>\n      </div>\n\n      {/* Navigation arrows — appear on hover in left/right thirds */}\n      <div\n        class={`pressy-nav-arrow pressy-nav-arrow--prev ${\n          hoverZone === \"left\" ? \"pressy-nav-arrow--visible\" : \"\"\n        }`}\n      >\n        <svg\n          viewBox=\"0 0 24 24\"\n          fill=\"none\"\n          stroke=\"currentColor\"\n          stroke-width=\"2\"\n          stroke-linecap=\"round\"\n          stroke-linejoin=\"round\"\n        >\n          <polyline points=\"15 18 9 12 15 6\" />\n        </svg>\n      </div>\n      <div\n        class={`pressy-nav-arrow pressy-nav-arrow--next ${\n          hoverZone === \"right\" ? \"pressy-nav-arrow--visible\" : \"\"\n        }`}\n      >\n        <svg\n          viewBox=\"0 0 24 24\"\n          fill=\"none\"\n          stroke=\"currentColor\"\n          stroke-width=\"2\"\n          stroke-linecap=\"round\"\n          stroke-linejoin=\"round\"\n        >\n          <polyline points=\"9 6 15 12 9 18\" />\n        </svg>\n      </div>\n\n      {/* Chapter boundary hints */}\n      {chapterHint === \"prev\" && effectivePrevChapter && (\n        <div\n          class=\"pressy-chapter-hint pressy-chapter-hint--prev\"\n          aria-live=\"polite\"\n        >\n          <span class=\"pressy-chapter-hint-arrow\">{\"\\u2190\"}</span>\n          <span class=\"pressy-chapter-hint-text\">\n            {effectivePrevChapter.title}\n          </span>\n        </div>\n      )}\n      {chapterHint === \"next\" && effectiveNextChapter && (\n        <div\n          class=\"pressy-chapter-hint pressy-chapter-hint--next\"\n          aria-live=\"polite\"\n        >\n          <span class=\"pressy-chapter-hint-text\">\n            {effectiveNextChapter.title}\n          </span>\n          <span class=\"pressy-chapter-hint-arrow\">{\"\\u2192\"}</span>\n        </div>\n      )}\n\n      {/* TOC drawer overlay */}\n      {tocOpen && allChapters && (\n        <div\n          class=\"pressy-toc-backdrop\"\n          onClick={(e: MouseEvent) => {\n            e.stopPropagation();\n            setTocOpen(false);\n          }}\n        >\n          <div\n            class=\"pressy-toc-drawer\"\n            onClick={(e: MouseEvent) => e.stopPropagation()}\n          >\n            <div class=\"pressy-toc-header\">\n              <span class=\"pressy-toc-title\">Contents</span>\n              <button\n                class=\"pressy-toc-close\"\n                onClick={(e: MouseEvent) => {\n                  e.stopPropagation();\n                  setTocOpen(false);\n                }}\n                aria-label=\"Close table of contents\"\n              >\n                <svg\n                  viewBox=\"0 0 24 24\"\n                  fill=\"none\"\n                  stroke=\"currentColor\"\n                  stroke-width=\"2\"\n                  width=\"18\"\n                  height=\"18\"\n                >\n                  <line x1=\"18\" y1=\"6\" x2=\"6\" y2=\"18\" />\n                  <line x1=\"6\" y1=\"6\" x2=\"18\" y2=\"18\" />\n                </svg>\n              </button>\n            </div>\n            <nav class=\"pressy-toc-list\">\n              <a\n                href={bookBasePath ? bookBasePath.replace(/\\/books\\/[^/]+$/, '') || '/' : '/'}\n                class=\"pressy-toc-item pressy-toc-item--home\"\n                onClick={() => setTocOpen(false)}\n              >\n                <span class=\"pressy-toc-item-num\">\n                  <svg viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" width=\"14\" height=\"14\">\n                    <path d=\"M3 9.5L12 3l9 6.5V20a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V9.5z\" />\n                  </svg>\n                </span>\n                <span class=\"pressy-toc-item-title\">{bookTitle || 'Home'}</span>\n              </a>\n              {allChapters.map((ch, i) => (\n                <a\n                  key={ch.slug}\n                  href={`${bookBasePath || \"\"}/${ch.slug}`}\n                  class={`pressy-toc-item ${\n                    ch.slug === (activeChapterSlug || currentChapterSlug)\n                      ? \"pressy-toc-item--active\"\n                      : \"\"\n                  }`}\n                  onClick={() => setTocOpen(false)}\n                >\n                  <span class=\"pressy-toc-item-num\">{i + 1}.</span>\n                  <span class=\"pressy-toc-item-title\">{ch.title}</span>\n                </a>\n              ))}\n            </nav>\n          </div>\n        </div>\n      )}\n\n      {/* Page footer with progress — hidden by default */}\n      <div\n        class={`pressy-page-footer ${\n          footerVisible || settingsOpen || tocOpen\n            ? \"pressy-page-footer--visible\"\n            : \"\"\n        }`}\n      >\n        <div class=\"pressy-progress-bar\">\n          <div\n            class=\"pressy-progress-fill\"\n            style={{ width: `${progressPercent}%` }}\n          />\n        </div>\n        <div class=\"pressy-footer-row\">\n          {allChapters && allChapters.length > 0 && (\n            <button\n              class=\"pressy-toc-toggle\"\n              onClick={(e: MouseEvent) => {\n                e.stopPropagation();\n                setSettingsOpen(false);\n                setTocOpen(!tocOpen);\n              }}\n              aria-label=\"Table of contents\"\n            >\n              <svg\n                viewBox=\"0 0 24 24\"\n                fill=\"none\"\n                stroke=\"currentColor\"\n                stroke-width=\"1.5\"\n                stroke-linecap=\"round\"\n                stroke-linejoin=\"round\"\n                width=\"18\"\n                height=\"18\"\n              >\n                <line x1=\"3\" y1=\"6\" x2=\"21\" y2=\"6\" />\n                <line x1=\"3\" y1=\"12\" x2=\"21\" y2=\"12\" />\n                <line x1=\"3\" y1=\"18\" x2=\"21\" y2=\"18\" />\n              </svg>\n            </button>\n          )}\n          {bookTitle && (\n            <button\n              class=\"pressy-footer-title\"\n              onClick={(e: MouseEvent) => {\n                e.stopPropagation();\n                if (allChapters && allChapters.length > 0) {\n                  setSettingsOpen(false);\n                  setTocOpen(!tocOpen);\n                }\n              }}\n            >\n              {bookTitle}\n            </button>\n          )}\n          <OfflineFooterIcon offlineProps={offlineProps} />\n          <button\n            class=\"pressy-settings-toggle\"\n            onClick={(e: MouseEvent) => {\n              e.stopPropagation();\n              setTocOpen(false);\n              setSettingsOpen(!settingsOpen);\n            }}\n            aria-label=\"Settings\"\n          >\n            <svg\n              viewBox=\"0 0 24 24\"\n              fill=\"none\"\n              stroke=\"currentColor\"\n              stroke-width=\"1.5\"\n              stroke-linecap=\"round\"\n              stroke-linejoin=\"round\"\n              width=\"18\"\n              height=\"18\"\n            >\n              <circle cx=\"12\" cy=\"12\" r=\"3\" />\n              <path d=\"M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z\" />\n            </svg>\n          </button>\n        </div>\n\n        {/* Settings panel */}\n        <div\n          class={`pressy-settings-panel ${\n            settingsOpen ? \"pressy-settings-panel--open\" : \"\"\n          }`}\n        >\n          <div class=\"pressy-settings-section\">\n            <div class=\"pressy-settings-label\">Theme</div>\n            <div class=\"pressy-theme-options\">\n              {(\n                [\n                  {\n                    id: \"light\",\n                    label: \"Light\",\n                    icon: (\n                      <svg\n                        viewBox=\"0 0 24 24\"\n                        fill=\"none\"\n                        stroke=\"currentColor\"\n                        stroke-width=\"1.5\"\n                        width=\"16\"\n                        height=\"16\"\n                      >\n                        <circle cx=\"12\" cy=\"12\" r=\"5\" />\n                        <line x1=\"12\" y1=\"1\" x2=\"12\" y2=\"3\" />\n                        <line x1=\"12\" y1=\"21\" x2=\"12\" y2=\"23\" />\n                        <line x1=\"4.22\" y1=\"4.22\" x2=\"5.64\" y2=\"5.64\" />\n                        <line x1=\"18.36\" y1=\"18.36\" x2=\"19.78\" y2=\"19.78\" />\n                        <line x1=\"1\" y1=\"12\" x2=\"3\" y2=\"12\" />\n                        <line x1=\"21\" y1=\"12\" x2=\"23\" y2=\"12\" />\n                        <line x1=\"4.22\" y1=\"19.78\" x2=\"5.64\" y2=\"18.36\" />\n                        <line x1=\"18.36\" y1=\"5.64\" x2=\"19.78\" y2=\"4.22\" />\n                      </svg>\n                    ),\n                  },\n                  {\n                    id: \"dark\",\n                    label: \"Dark\",\n                    icon: (\n                      <svg\n                        viewBox=\"0 0 24 24\"\n                        fill=\"none\"\n                        stroke=\"currentColor\"\n                        stroke-width=\"1.5\"\n                        width=\"16\"\n                        height=\"16\"\n                      >\n                        <path d=\"M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z\" />\n                      </svg>\n                    ),\n                  },\n                  {\n                    id: \"system\",\n                    label: \"System\",\n                    icon: (\n                      <svg\n                        viewBox=\"0 0 24 24\"\n                        fill=\"none\"\n                        stroke=\"currentColor\"\n                        stroke-width=\"1.5\"\n                        width=\"16\"\n                        height=\"16\"\n                      >\n                        <rect\n                          x=\"2\"\n                          y=\"3\"\n                          width=\"20\"\n                          height=\"14\"\n                          rx=\"2\"\n                          ry=\"2\"\n                        />\n                        <line x1=\"8\" y1=\"21\" x2=\"16\" y2=\"21\" />\n                        <line x1=\"12\" y1=\"17\" x2=\"12\" y2=\"21\" />\n                      </svg>\n                    ),\n                  },\n                  {\n                    id: \"sepia\",\n                    label: \"Sepia\",\n                    icon: (\n                      <svg\n                        viewBox=\"0 0 24 24\"\n                        fill=\"none\"\n                        stroke=\"currentColor\"\n                        stroke-width=\"1.5\"\n                        width=\"16\"\n                        height=\"16\"\n                      >\n                        <path d=\"M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z\" />\n                        <path d=\"M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z\" />\n                      </svg>\n                    ),\n                  },\n                ] as const\n              ).map((t) => (\n                <button\n                  key={t.id}\n                  class={`pressy-theme-btn ${\n                    activeTheme === t.id ? \"pressy-theme-btn--active\" : \"\"\n                  }`}\n                  onClick={(e: MouseEvent) => {\n                    e.stopPropagation();\n                    handleThemeChange(t.id);\n                  }}\n                >\n                  {t.icon}\n                  <span>{t.label}</span>\n                </button>\n              ))}\n            </div>\n          </div>\n          <div class=\"pressy-settings-section\">\n            <div class=\"pressy-settings-label\">Font Size</div>\n            <div class=\"pressy-font-size-controls\">\n              <button\n                class=\"pressy-font-size-btn\"\n                onClick={(e: MouseEvent) => {\n                  e.stopPropagation();\n                  handleFontSizeChange(-0.1);\n                }}\n                disabled={fontScale <= 0.8}\n                aria-label=\"Decrease font size\"\n              >\n                A-\n              </button>\n              <span class=\"pressy-font-size-value\">\n                {Math.round(fontScale * 100)}%\n              </span>\n              <button\n                class=\"pressy-font-size-btn\"\n                onClick={(e: MouseEvent) => {\n                  e.stopPropagation();\n                  handleFontSizeChange(0.1);\n                }}\n                disabled={fontScale >= 1.5}\n                aria-label=\"Increase font size\"\n              >\n                A+\n              </button>\n            </div>\n          </div>\n        </div>\n      </div>\n\n      <TextShare />\n      <OfflineIndicator />\n\n      <style>{PAGINATED_STYLES}</style>\n    </div>\n  );\n}\n\n// ── Styles ────────────────────────────────────────────────────\n\nconst SCROLL_STYLES = `\n  .pressy-reader {\n    min-height: 100vh;\n    display: flex;\n    flex-direction: column;\n  }\n\n  .pressy-reader-main {\n    flex: 1;\n    padding: 2rem 0;\n  }\n\n  /* ── Scroll reader footer ──────────────────────────────── */\n  .pressy-page-footer--scroll {\n    position: fixed;\n    bottom: 0;\n    left: 0;\n    right: 0;\n    padding: 0.5rem 1.5rem 1rem;\n    text-align: center;\n    user-select: none;\n    transform: translateY(100%);\n    opacity: 0;\n    transition: transform 0.25s ease, opacity 0.25s ease;\n    z-index: 15;\n    background: var(--color-bg, #ffffff);\n    box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.05);\n  }\n\n  .pressy-page-footer--scroll.pressy-page-footer--visible {\n    transform: translateY(0);\n    opacity: 1;\n  }\n\n  /* Shared footer styles for scroll reader */\n  .pressy-page-footer--scroll .pressy-footer-row {\n    display: flex;\n    align-items: center;\n    justify-content: space-between;\n    gap: 0.5rem;\n  }\n\n  .pressy-page-footer--scroll .pressy-footer-title {\n    font-family: var(--font-heading, system-ui, -apple-system, sans-serif);\n    font-size: 0.75rem;\n    color: var(--color-text-muted, #6c757d);\n    text-decoration: none;\n    overflow: hidden;\n    text-overflow: ellipsis;\n    white-space: nowrap;\n    min-width: 0;\n    flex: 1;\n    text-align: left;\n    border: none;\n    background: none;\n    cursor: pointer;\n    padding: 0;\n  }\n\n  .pressy-page-footer--scroll .pressy-footer-title:hover {\n    color: var(--color-text, #212529);\n  }\n\n  .pressy-page-footer--scroll .pressy-toc-toggle,\n  .pressy-page-footer--scroll .pressy-settings-toggle {\n    flex-shrink: 0;\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    width: 2rem;\n    height: 2rem;\n    border: none;\n    background: transparent;\n    color: var(--color-text-muted, #6c757d);\n    cursor: pointer;\n    border-radius: 0.375rem;\n    transition: color 0.15s, background 0.15s;\n    padding: 0;\n  }\n\n  .pressy-page-footer--scroll .pressy-toc-toggle:hover,\n  .pressy-page-footer--scroll .pressy-settings-toggle:hover {\n    color: var(--color-text, #212529);\n    background: var(--color-bg-subtle, #f8f9fa);\n  }\n\n  .pressy-page-footer--scroll .pressy-settings-panel {\n    overflow: hidden;\n    max-height: 0;\n    opacity: 0;\n    transition: max-height 0.25s ease, opacity 0.2s ease;\n    border-top: 0 solid var(--color-border, #dee2e6);\n  }\n\n  .pressy-page-footer--scroll .pressy-settings-panel--open {\n    max-height: 300px;\n    opacity: 1;\n    border-top-width: 1px;\n    margin-top: 0.5rem;\n    padding-top: 0.75rem;\n  }\n\n  .pressy-page-footer--scroll .pressy-settings-section {\n    margin-bottom: 0.75rem;\n  }\n\n  .pressy-page-footer--scroll .pressy-settings-section:last-child {\n    margin-bottom: 0;\n  }\n\n  .pressy-page-footer--scroll .pressy-settings-label {\n    font-family: var(--font-heading, system-ui, -apple-system, sans-serif);\n    font-size: 0.6875rem;\n    font-weight: 600;\n    text-transform: uppercase;\n    letter-spacing: 0.05em;\n    color: var(--color-text-muted, #6c757d);\n    margin-bottom: 0.5rem;\n    text-align: left;\n  }\n\n  .pressy-page-footer--scroll .pressy-theme-options {\n    display: flex;\n    gap: 0.375rem;\n  }\n\n  .pressy-page-footer--scroll .pressy-theme-btn {\n    flex: 1;\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    gap: 0.25rem;\n    padding: 0.375rem 0.5rem;\n    border: 1.5px solid var(--color-border, #dee2e6);\n    border-radius: 0.5rem;\n    background: transparent;\n    color: var(--color-text, #212529);\n    font-family: var(--font-heading, system-ui, -apple-system, sans-serif);\n    font-size: 0.6875rem;\n    cursor: pointer;\n    transition: border-color 0.15s, background 0.15s;\n  }\n\n  .pressy-page-footer--scroll .pressy-theme-btn:hover {\n    background: var(--color-bg-subtle, #f8f9fa);\n  }\n\n  .pressy-page-footer--scroll .pressy-theme-btn--active {\n    border-color: var(--color-accent, #212529);\n    background: var(--color-bg-subtle, #f8f9fa);\n    font-weight: 600;\n  }\n\n  .pressy-page-footer--scroll .pressy-font-size-controls {\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    gap: 1rem;\n  }\n\n  .pressy-page-footer--scroll .pressy-font-size-btn {\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    width: 2rem;\n    height: 2rem;\n    border: 1.5px solid var(--color-border, #dee2e6);\n    border-radius: 50%;\n    background: transparent;\n    color: var(--color-text, #212529);\n    font-family: var(--font-heading, system-ui, -apple-system, sans-serif);\n    font-size: 0.75rem;\n    font-weight: 600;\n    cursor: pointer;\n    transition: border-color 0.15s, background 0.15s;\n  }\n\n  .pressy-page-footer--scroll .pressy-font-size-btn:hover:not(:disabled) {\n    background: var(--color-bg-subtle, #f8f9fa);\n    border-color: var(--color-accent, #212529);\n  }\n\n  .pressy-page-footer--scroll .pressy-font-size-btn:disabled {\n    opacity: 0.3;\n    cursor: default;\n  }\n\n  .pressy-page-footer--scroll .pressy-font-size-value {\n    font-family: var(--font-heading, system-ui, -apple-system, sans-serif);\n    font-size: 0.8125rem;\n    font-weight: 500;\n    color: var(--color-text, #212529);\n    min-width: 3ch;\n    text-align: center;\n  }\n\n  /* ── TOC drawer for scroll reader ───────────────────────── */\n  .pressy-toc-backdrop--scroll {\n    position: fixed;\n    inset: 0;\n    background: rgba(0, 0, 0, 0.3);\n    z-index: 20;\n    display: flex;\n    align-items: flex-end;\n    animation: pressy-scroll-toc-fade-in 0.2s ease-out;\n  }\n\n  .pressy-toc-backdrop--scroll .pressy-toc-drawer {\n    width: 100%;\n    max-height: 70vh;\n    background: var(--color-bg, #ffffff);\n    border-radius: 1rem 1rem 0 0;\n    display: flex;\n    flex-direction: column;\n    animation: pressy-scroll-toc-slide-up 0.25s ease-out;\n    box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.1);\n  }\n\n  .pressy-toc-backdrop--scroll .pressy-toc-header {\n    display: flex;\n    align-items: center;\n    justify-content: space-between;\n    padding: 1rem 1.5rem 0.75rem;\n    border-bottom: 1px solid var(--color-border, #dee2e6);\n    flex-shrink: 0;\n  }\n\n  .pressy-toc-backdrop--scroll .pressy-toc-title {\n    font-family: var(--font-heading, system-ui, -apple-system, sans-serif);\n    font-size: 1rem;\n    font-weight: 600;\n    color: var(--color-text, #212529);\n  }\n\n  .pressy-toc-backdrop--scroll .pressy-toc-close {\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    width: 2rem;\n    height: 2rem;\n    border: none;\n    background: transparent;\n    color: var(--color-text-muted, #6c757d);\n    cursor: pointer;\n    border-radius: 0.375rem;\n    padding: 0;\n  }\n\n  .pressy-toc-backdrop--scroll .pressy-toc-close:hover {\n    color: var(--color-text, #212529);\n    background: var(--color-bg-subtle, #f8f9fa);\n  }\n\n  .pressy-toc-backdrop--scroll .pressy-toc-list {\n    overflow-y: auto;\n    padding: 0.5rem;\n    display: flex;\n    flex-direction: column;\n  }\n\n  .pressy-toc-backdrop--scroll .pressy-toc-item {\n    display: flex;\n    gap: 0.75rem;\n    padding: 0.625rem 1rem;\n    text-decoration: none;\n    color: var(--color-text, #212529);\n    border-radius: 0.5rem;\n    font-family: var(--font-heading, system-ui, -apple-system, sans-serif);\n    font-size: 0.875rem;\n    transition: background 0.15s;\n  }\n\n  .pressy-toc-backdrop--scroll .pressy-toc-item:hover {\n    background: var(--color-bg-subtle, #f5f5f5);\n  }\n\n  .pressy-toc-backdrop--scroll .pressy-toc-item--active {\n    background: var(--color-bg-subtle, #f5f5f5);\n    font-weight: 600;\n  }\n\n  .pressy-toc-backdrop--scroll .pressy-toc-item-num {\n    color: var(--color-text-muted, #6c757d);\n    min-width: 2ch;\n    text-align: right;\n  }\n\n  .pressy-toc-backdrop--scroll .pressy-toc-item-title {\n    flex: 1;\n    min-width: 0;\n  }\n\n  @keyframes pressy-scroll-toc-fade-in {\n    from { opacity: 0; }\n    to { opacity: 1; }\n  }\n\n  @keyframes pressy-scroll-toc-slide-up {\n    from { transform: translateY(100%); }\n    to { transform: translateY(0); }\n  }\n\n  /* ── Offline icon for scroll reader ─────────────────────── */\n  .pressy-page-footer--scroll .pressy-offline-icon {\n    flex-shrink: 0;\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    position: relative;\n    width: 2rem;\n    height: 2rem;\n    border: none;\n    background: transparent;\n    color: var(--color-text-muted, #6c757d);\n    cursor: pointer;\n    border-radius: 0.375rem;\n    transition: color 0.15s, background 0.15s;\n    padding: 0;\n  }\n\n  .pressy-page-footer--scroll .pressy-offline-icon:hover {\n    color: var(--color-text, #212529);\n    background: var(--color-bg-subtle, #f8f9fa);\n  }\n\n  .pressy-page-footer--scroll .pressy-offline-icon--cached {\n    color: #16a34a;\n  }\n\n  .pressy-page-footer--scroll .pressy-offline-icon--cached:hover {\n    color: #dc2626;\n  }\n\n  .pressy-page-footer--scroll .pressy-offline-check {\n    position: absolute;\n    bottom: 2px;\n    right: 2px;\n  }\n\n  .pressy-page-footer--scroll .pressy-offline-icon--downloading {\n    cursor: default;\n  }\n\n  @media (prefers-reduced-motion: reduce) {\n    .pressy-page-footer--scroll {\n      transition: none;\n    }\n    .pressy-toc-backdrop--scroll,\n    .pressy-toc-backdrop--scroll .pressy-toc-drawer {\n      animation: none;\n    }\n  }\n`;\n\nconst PAGINATED_STYLES = `\n  html:has(.pressy-reader--paginated) body {\n    margin: 0;\n  }\n\n  .pressy-reader--paginated {\n    height: 100vh;\n    height: 100dvh;\n    display: flex;\n    flex-direction: column;\n    overflow: hidden;\n    position: relative;\n  }\n\n  /* Viewport clips overflow and shows one page at a time.\n     Vertical padding gives consistent top/bottom margins on every page. */\n  .pressy-paginated-viewport {\n    flex: 1;\n    overflow: hidden;\n    position: relative;\n    min-height: 0;\n    padding-block: 2rem;\n    box-sizing: border-box;\n    text-wrap: pretty;\n  }\n\n  /* Article uses CSS multi-column layout for pagination.\n     column-width is set dynamically via JS to match viewport width.\n     Each column = one \"page\". Content overflows horizontally into new columns.\n     translateX controlled by JS — transitions set dynamically during drag vs snap. */\n  .pressy-prose--paginated {\n    max-width: none;\n    height: 100%;\n    column-fill: auto;\n    column-gap: 0;\n    overflow: visible;\n    box-sizing: border-box;\n    padding: 0;\n    will-change: transform;\n    /* Transition is set dynamically: none during drag, ease-out on snap */\n  }\n\n  /* Center content elements within each column/page at a readable width */\n  .pressy-prose--paginated > * {\n    max-width: min(65ch, calc(100% - 3rem));\n    margin-left: auto;\n    margin-right: auto;\n  }\n\n  /* Preserve vertical margins from prose styles */\n  .pressy-prose--paginated > h1,\n  .pressy-prose--paginated > h2,\n  .pressy-prose--paginated > h3,\n  .pressy-prose--paginated > h4 {\n    max-width: min(65ch, calc(100% - 3rem));\n    margin-left: auto;\n    margin-right: auto;\n  }\n\n  /* ── Navigation arrows ────────────────────────────────────── */\n  /* Hover-triggered arrows on left/right edges for desktop navigation */\n  .pressy-nav-arrow {\n    position: absolute;\n    top: 50%;\n    transform: translateY(-50%);\n    width: 2.5rem;\n    height: 2.5rem;\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    color: var(--color-text-muted, #6c757d);\n    opacity: 0;\n    transition: opacity 0.2s ease;\n    pointer-events: none;\n    z-index: 5;\n  }\n\n  .pressy-nav-arrow svg {\n    width: 1.5rem;\n    height: 1.5rem;\n  }\n\n  .pressy-nav-arrow--prev {\n    left: 0.75rem;\n  }\n\n  .pressy-nav-arrow--next {\n    right: 0.75rem;\n  }\n\n  .pressy-nav-arrow--visible {\n    opacity: 0.4;\n  }\n\n  /* Hide on touch devices — swipe handles navigation there */\n  @media (hover: none) {\n    .pressy-nav-arrow {\n      display: none;\n    }\n  }\n\n  /* ── Chapter boundary hints ─────────────────────────────── */\n  /* Shown when overscrolling past first/last page of a chapter */\n  .pressy-chapter-hint {\n    position: absolute;\n    top: 50%;\n    transform: translateY(-50%);\n    display: flex;\n    align-items: center;\n    gap: 0.5rem;\n    padding: 0.75rem 1.25rem;\n    background: var(--color-bg-subtle, #f5f5f5);\n    border: 1px solid var(--color-border, #dee2e6);\n    border-radius: 0.75rem;\n    font-family: var(--font-heading, system-ui, -apple-system, sans-serif);\n    font-size: var(--font-size-sm, 0.875rem);\n    color: var(--color-text-muted, #6c757d);\n    z-index: 20;\n    pointer-events: none;\n    animation: pressy-hint-fade-in 0.15s ease-out;\n    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);\n    max-width: 60%;\n    white-space: nowrap;\n    overflow: hidden;\n    text-overflow: ellipsis;\n  }\n\n  .pressy-chapter-hint--prev {\n    left: 1rem;\n  }\n\n  .pressy-chapter-hint--next {\n    right: 1rem;\n  }\n\n  .pressy-chapter-hint-arrow {\n    flex-shrink: 0;\n    font-size: 1rem;\n    opacity: 0.6;\n  }\n\n  .pressy-chapter-hint-text {\n    overflow: hidden;\n    text-overflow: ellipsis;\n  }\n\n  @keyframes pressy-hint-fade-in {\n    from { opacity: 0; transform: translateY(-50%) scale(0.95); }\n    to { opacity: 1; transform: translateY(-50%) scale(1); }\n  }\n\n  /* ── Page footer ───────────────────────────────────────────── */\n  .pressy-page-footer {\n    position: absolute;\n    bottom: 0;\n    left: 0;\n    right: 0;\n    padding: 0.5rem 1.5rem 1rem;\n    text-align: center;\n    user-select: none;\n    transform: translateY(100%);\n    opacity: 0;\n    transition: transform 0.25s ease, opacity 0.25s ease;\n    z-index: 15;\n    background: var(--color-bg, #ffffff);\n  }\n\n  .pressy-page-footer--visible {\n    transform: translateY(0);\n    opacity: 1;\n  }\n\n  /* Progress bar */\n  .pressy-progress-bar {\n    height: 3px;\n    background: var(--color-border, #dee2e6);\n    border-radius: 1.5px;\n    overflow: hidden;\n  }\n\n  .pressy-progress-fill {\n    height: 100%;\n    background: var(--color-accent, #212529);\n    border-radius: 1.5px;\n    transition: width 0.3s ease;\n  }\n\n  /* ── Footer row (title + gear) ──────────────────────────── */\n  .pressy-footer-row {\n    display: flex;\n    align-items: center;\n    justify-content: space-between;\n    margin-top: 0.5rem;\n    gap: 0.5rem;\n  }\n\n  .pressy-footer-title {\n    font-family: var(--font-heading, system-ui, -apple-system, sans-serif);\n    font-size: 0.75rem;\n    color: var(--color-text-muted, #6c757d);\n    text-decoration: none;\n    overflow: hidden;\n    text-overflow: ellipsis;\n    white-space: nowrap;\n    min-width: 0;\n    flex: 1;\n    text-align: left;\n    border: none;\n    background: none;\n    cursor: pointer;\n    padding: 0;\n  }\n\n  .pressy-footer-title:hover {\n    color: var(--color-text, #212529);\n  }\n\n  /* ── TOC toggle button ──────────────────────────────────── */\n  .pressy-toc-toggle {\n    flex-shrink: 0;\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    width: 2rem;\n    height: 2rem;\n    border: none;\n    background: transparent;\n    color: var(--color-text-muted, #6c757d);\n    cursor: pointer;\n    border-radius: 0.375rem;\n    transition: color 0.15s, background 0.15s;\n    padding: 0;\n  }\n\n  .pressy-toc-toggle:hover {\n    color: var(--color-text, #212529);\n    background: var(--color-bg-subtle, #f8f9fa);\n  }\n\n  .pressy-settings-toggle {\n    flex-shrink: 0;\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    width: 2rem;\n    height: 2rem;\n    border: none;\n    background: transparent;\n    color: var(--color-text-muted, #6c757d);\n    cursor: pointer;\n    border-radius: 0.375rem;\n    transition: color 0.15s, background 0.15s;\n    padding: 0;\n  }\n\n  .pressy-settings-toggle:hover {\n    color: var(--color-text, #212529);\n    background: var(--color-bg-subtle, #f8f9fa);\n  }\n\n  /* ── Settings panel ────────────────────────────────────── */\n  .pressy-settings-panel {\n    overflow: hidden;\n    max-height: 0;\n    opacity: 0;\n    transition: max-height 0.25s ease, opacity 0.2s ease;\n    border-top: 0 solid var(--color-border, #dee2e6);\n  }\n\n  .pressy-settings-panel--open {\n    max-height: 300px;\n    opacity: 1;\n    border-top-width: 1px;\n    margin-top: 0.5rem;\n    padding-top: 0.75rem;\n  }\n\n  .pressy-settings-section {\n    margin-bottom: 0.75rem;\n  }\n\n  .pressy-settings-section:last-child {\n    margin-bottom: 0;\n  }\n\n  .pressy-settings-label {\n    font-family: var(--font-heading, system-ui, -apple-system, sans-serif);\n    font-size: 0.6875rem;\n    font-weight: 600;\n    text-transform: uppercase;\n    letter-spacing: 0.05em;\n    color: var(--color-text-muted, #6c757d);\n    margin-bottom: 0.5rem;\n    text-align: left;\n  }\n\n  .pressy-theme-options {\n    display: flex;\n    gap: 0.375rem;\n  }\n\n  .pressy-theme-btn {\n    flex: 1;\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    gap: 0.25rem;\n    padding: 0.375rem 0.5rem;\n    border: 1.5px solid var(--color-border, #dee2e6);\n    border-radius: 0.5rem;\n    background: transparent;\n    color: var(--color-text, #212529);\n    font-family: var(--font-heading, system-ui, -apple-system, sans-serif);\n    font-size: 0.6875rem;\n    cursor: pointer;\n    transition: border-color 0.15s, background 0.15s;\n  }\n\n  .pressy-theme-btn:hover {\n    background: var(--color-bg-subtle, #f8f9fa);\n  }\n\n  .pressy-theme-btn--active {\n    border-color: var(--color-accent, #212529);\n    background: var(--color-bg-subtle, #f8f9fa);\n    font-weight: 600;\n  }\n\n  .pressy-font-size-controls {\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    gap: 1rem;\n  }\n\n  .pressy-font-size-btn {\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    width: 2rem;\n    height: 2rem;\n    border: 1.5px solid var(--color-border, #dee2e6);\n    border-radius: 50%;\n    background: transparent;\n    color: var(--color-text, #212529);\n    font-family: var(--font-heading, system-ui, -apple-system, sans-serif);\n    font-size: 0.75rem;\n    font-weight: 600;\n    cursor: pointer;\n    transition: border-color 0.15s, background 0.15s;\n  }\n\n  .pressy-font-size-btn:hover:not(:disabled) {\n    background: var(--color-bg-subtle, #f8f9fa);\n    border-color: var(--color-accent, #212529);\n  }\n\n  .pressy-font-size-btn:disabled {\n    opacity: 0.3;\n    cursor: default;\n  }\n\n  .pressy-font-size-value {\n    font-family: var(--font-heading, system-ui, -apple-system, sans-serif);\n    font-size: 0.8125rem;\n    font-weight: 500;\n    color: var(--color-text, #212529);\n    min-width: 3ch;\n    text-align: center;\n  }\n\n  /* ── Chapter sections ─────────────────────────────────── */\n  .pressy-chapter-section + .pressy-chapter-section {\n    break-before: column;\n  }\n\n  .pressy-chapter-divider {\n    padding: 0;\n    margin: 0;\n  }\n\n  .pressy-chapter-divider-title {\n    font-size: 1.5rem;\n    font-family: var(--font-heading, system-ui, -apple-system, sans-serif);\n    margin: 0;\n  }\n\n  /* ── TOC drawer ──────────────────────────────────────────── */\n  .pressy-toc-backdrop {\n    position: absolute;\n    inset: 0;\n    background: rgba(0, 0, 0, 0.3);\n    z-index: 20;\n    display: flex;\n    align-items: flex-end;\n    animation: pressy-toc-fade-in 0.2s ease-out;\n  }\n\n  .pressy-toc-drawer {\n    width: 100%;\n    max-height: 70vh;\n    background: var(--color-bg, #ffffff);\n    border-radius: 1rem 1rem 0 0;\n    display: flex;\n    flex-direction: column;\n    animation: pressy-toc-slide-up 0.25s ease-out;\n    box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.1);\n  }\n\n  .pressy-toc-header {\n    display: flex;\n    align-items: center;\n    justify-content: space-between;\n    padding: 1rem 1.5rem 0.75rem;\n    border-bottom: 1px solid var(--color-border, #dee2e6);\n    flex-shrink: 0;\n  }\n\n  .pressy-toc-title {\n    font-family: var(--font-heading, system-ui, -apple-system, sans-serif);\n    font-size: 1rem;\n    font-weight: 600;\n    color: var(--color-text, #212529);\n  }\n\n  .pressy-toc-close {\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    width: 2rem;\n    height: 2rem;\n    border: none;\n    background: transparent;\n    color: var(--color-text-muted, #6c757d);\n    cursor: pointer;\n    border-radius: 0.375rem;\n    padding: 0;\n  }\n\n  .pressy-toc-close:hover {\n    color: var(--color-text, #212529);\n    background: var(--color-bg-subtle, #f8f9fa);\n  }\n\n  .pressy-toc-list {\n    overflow-y: auto;\n    padding: 0.5rem;\n    display: flex;\n    flex-direction: column;\n  }\n\n  .pressy-toc-item {\n    display: flex;\n    gap: 0.75rem;\n    padding: 0.625rem 1rem;\n    text-decoration: none;\n    color: var(--color-text, #212529);\n    border-radius: 0.5rem;\n    font-family: var(--font-heading, system-ui, -apple-system, sans-serif);\n    font-size: 0.875rem;\n    transition: background 0.15s;\n  }\n\n  .pressy-toc-item:hover {\n    background: var(--color-bg-subtle, #f5f5f5);\n  }\n\n  .pressy-toc-item--active {\n    background: var(--color-bg-subtle, #f5f5f5);\n    font-weight: 600;\n  }\n\n  .pressy-toc-item-num {\n    color: var(--color-text-muted, #6c757d);\n    min-width: 2ch;\n    text-align: right;\n  }\n\n  .pressy-toc-item-title {\n    flex: 1;\n    min-width: 0;\n  }\n\n  @keyframes pressy-toc-fade-in {\n    from { opacity: 0; }\n    to { opacity: 1; }\n  }\n\n  @keyframes pressy-toc-slide-up {\n    from { transform: translateY(100%); }\n    to { transform: translateY(0); }\n  }\n\n  /* ── Offline footer icon ────────────────────────────────── */\n  .pressy-offline-icon {\n    flex-shrink: 0;\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    position: relative;\n    width: 2rem;\n    height: 2rem;\n    border: none;\n    background: transparent;\n    color: var(--color-text-muted, #6c757d);\n    cursor: pointer;\n    border-radius: 0.375rem;\n    transition: color 0.15s, background 0.15s;\n    padding: 0;\n  }\n\n  .pressy-offline-icon:hover {\n    color: var(--color-text, #212529);\n    background: var(--color-bg-subtle, #f8f9fa);\n  }\n\n  .pressy-offline-icon--cached {\n    color: #16a34a;\n  }\n\n  .pressy-offline-icon--cached:hover {\n    color: #dc2626;\n  }\n\n  .pressy-offline-check {\n    position: absolute;\n    bottom: 2px;\n    right: 2px;\n  }\n\n  .pressy-offline-icon--downloading {\n    cursor: default;\n  }\n\n  @keyframes pressy-offline-spin {\n    from { transform: rotate(0deg); }\n    to { transform: rotate(360deg); }\n  }\n\n  .pressy-offline-spinner {\n    animation: pressy-offline-spin 1s linear infinite;\n    transform-origin: 12px 12px;\n  }\n\n  /* ── Reduced motion preference ────────────────────────────\n     Disable page turn animations for users who prefer reduced motion. */\n  @media (prefers-reduced-motion: reduce) {\n    .pressy-prose--paginated {\n      transition: none !important;\n    }\n    .pressy-progress-fill {\n      transition: none !important;\n    }\n    .pressy-toc-backdrop,\n    .pressy-toc-drawer {\n      animation: none;\n    }\n    .pressy-offline-spinner {\n      animation: none;\n    }\n  }\n`;\n","structuredPatch":[{"oldStart":2358,"oldLines":6,"newStart":2358,"newLines":18,"lines":["     text-align: right;","   }"," ","+  .pressy-toc-backdrop--scroll .pressy-toc-item--home {","+    border-bottom: 1px solid var(--color-border, #e5e5e5);","+    margin-bottom: 0.25rem;","+    padding-bottom: 0.75rem;","+  }","+","+  .pressy-toc-backdrop--scroll .pressy-toc-item--home .pressy-toc-item-num {","+    display: flex;","+    align-items: center;","+    justify-content: center;","+  }","+","   .pressy-toc-backdrop--scroll .pressy-toc-item-title {","     flex: 1;","     min-width: 0;"]}],"userModified":false,"replaceAll":false},"sourceToolAssistantUUID":"12f5f948-3df6-4630-8fe0-e9e353ff33da"}
{"parentUuid":"1c3ca5ad-7443-416a-8136-45159be16bc6","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","message":{"model":"claude-opus-4-6","id":"msg_01Rbch4cSn8yHNqXwdoEbeKJ","type":"message","role":"assistant","content":[{"type":"text","text":"Now add the same for the paginated TOC:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":636,"cache_read_input_tokens":53548,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":636},"output_tokens":2,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CYAtwsBHxZt7WKpECTXtZ","type":"assistant","uuid":"ed6f4849-19ed-436d-bced-38b8f01fa04b","timestamp":"2026-02-16T01:40:47.617Z"}
{"parentUuid":"ed6f4849-19ed-436d-bced-38b8f01fa04b","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","message":{"model":"claude-opus-4-6","id":"msg_01Rbch4cSn8yHNqXwdoEbeKJ","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_016EmbRXMRTsqm3LGmnwS9sE","name":"Read","input":{"file_path":"/Users/blittle/dev/pressy/packages/@pressy/components/src/Reader.tsx","offset":2910,"limit":15},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":636,"cache_read_input_tokens":53548,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":636},"output_tokens":2,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CYAtwsBHxZt7WKpECTXtZ","type":"assistant","uuid":"5f8f91cc-51a4-497e-8462-cef88833659f","timestamp":"2026-02-16T01:40:48.386Z"}
{"parentUuid":"5f8f91cc-51a4-497e-8462-cef88833659f","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","type":"progress","data":{"type":"hook_progress","hookEvent":"PostToolUse","hookName":"PostToolUse:Read","command":"callback"},"parentToolUseID":"toolu_016EmbRXMRTsqm3LGmnwS9sE","toolUseID":"toolu_016EmbRXMRTsqm3LGmnwS9sE","timestamp":"2026-02-16T01:40:48.399Z","uuid":"ae285882-1551-45ea-a85e-86ae61370621"}
{"parentUuid":"5f8f91cc-51a4-497e-8462-cef88833659f","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_016EmbRXMRTsqm3LGmnwS9sE","type":"tool_result","content":"  2910→  }\n  2911→\n  2912→  .pressy-toc-item-num {\n  2913→    color: var(--color-text-muted, #6c757d);\n  2914→    min-width: 2ch;\n  2915→    text-align: right;\n  2916→  }\n  2917→\n  2918→  .pressy-toc-item-title {\n  2919→    flex: 1;\n  2920→    min-width: 0;\n  2921→  }\n  2922→\n  2923→  @keyframes pressy-toc-fade-in {\n  2924→    from { opacity: 0; }"}]},"uuid":"1103aa6c-afff-42c7-b8eb-6e055e467b37","timestamp":"2026-02-16T01:40:48.398Z","toolUseResult":{"type":"text","file":{"filePath":"/Users/blittle/dev/pressy/packages/@pressy/components/src/Reader.tsx","content":"  }\n\n  .pressy-toc-item-num {\n    color: var(--color-text-muted, #6c757d);\n    min-width: 2ch;\n    text-align: right;\n  }\n\n  .pressy-toc-item-title {\n    flex: 1;\n    min-width: 0;\n  }\n\n  @keyframes pressy-toc-fade-in {\n    from { opacity: 0; }","numLines":15,"startLine":2910,"totalLines":3002}},"sourceToolAssistantUUID":"5f8f91cc-51a4-497e-8462-cef88833659f"}
{"parentUuid":"1103aa6c-afff-42c7-b8eb-6e055e467b37","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","message":{"model":"claude-opus-4-6","id":"msg_01A2P4pWRwa429eJ2MH4Czr9","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01AvJiY138buNuUkTkyC9A5m","name":"Edit","input":{"replace_all":false,"file_path":"/Users/blittle/dev/pressy/packages/@pressy/components/src/Reader.tsx","old_string":"  .pressy-toc-item-num {\n    color: var(--color-text-muted, #6c757d);\n    min-width: 2ch;\n    text-align: right;\n  }\n\n  .pressy-toc-item-title {\n    flex: 1;\n    min-width: 0;\n  }\n\n  @keyframes pressy-toc-fade-in {","new_string":"  .pressy-toc-item-num {\n    color: var(--color-text-muted, #6c757d);\n    min-width: 2ch;\n    text-align: right;\n  }\n\n  .pressy-toc-item--home {\n    border-bottom: 1px solid var(--color-border, #e5e5e5);\n    margin-bottom: 0.25rem;\n    padding-bottom: 0.75rem;\n  }\n\n  .pressy-toc-item--home .pressy-toc-item-num {\n    display: flex;\n    align-items: center;\n    justify-content: center;\n  }\n\n  .pressy-toc-item-title {\n    flex: 1;\n    min-width: 0;\n  }\n\n  @keyframes pressy-toc-fade-in {"},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":311,"cache_read_input_tokens":54184,"output_tokens":444,"server_tool_use":{"web_search_requests":0,"web_fetch_requests":0},"service_tier":"standard","cache_creation":{"ephemeral_1h_input_tokens":311,"ephemeral_5m_input_tokens":0},"inference_geo":"","iterations":[],"speed":"standard"}},"requestId":"req_011CYAtx8igRsjXoeERQ65Bv","type":"assistant","uuid":"af925b50-70bf-4b2f-b474-6359f80f546e","timestamp":"2026-02-16T01:40:53.307Z"}
{"parentUuid":"af925b50-70bf-4b2f-b474-6359f80f546e","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","type":"progress","data":{"type":"hook_progress","hookEvent":"PostToolUse","hookName":"PostToolUse:Edit","command":"callback"},"parentToolUseID":"toolu_01AvJiY138buNuUkTkyC9A5m","toolUseID":"toolu_01AvJiY138buNuUkTkyC9A5m","timestamp":"2026-02-16T01:40:53.344Z","uuid":"01feb60c-dee2-4c8a-8802-9cea757de4be"}
{"parentUuid":"af925b50-70bf-4b2f-b474-6359f80f546e","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01AvJiY138buNuUkTkyC9A5m","type":"tool_result","content":"The file /Users/blittle/dev/pressy/packages/@pressy/components/src/Reader.tsx has been updated successfully."}]},"uuid":"83ca3058-e71e-42cf-bc64-8c5d325d8500","timestamp":"2026-02-16T01:40:53.344Z","toolUseResult":{"filePath":"/Users/blittle/dev/pressy/packages/@pressy/components/src/Reader.tsx","oldString":"  .pressy-toc-item-num {\n    color: var(--color-text-muted, #6c757d);\n    min-width: 2ch;\n    text-align: right;\n  }\n\n  .pressy-toc-item-title {\n    flex: 1;\n    min-width: 0;\n  }\n\n  @keyframes pressy-toc-fade-in {","newString":"  .pressy-toc-item-num {\n    color: var(--color-text-muted, #6c757d);\n    min-width: 2ch;\n    text-align: right;\n  }\n\n  .pressy-toc-item--home {\n    border-bottom: 1px solid var(--color-border, #e5e5e5);\n    margin-bottom: 0.25rem;\n    padding-bottom: 0.75rem;\n  }\n\n  .pressy-toc-item--home .pressy-toc-item-num {\n    display: flex;\n    align-items: center;\n    justify-content: center;\n  }\n\n  .pressy-toc-item-title {\n    flex: 1;\n    min-width: 0;\n  }\n\n  @keyframes pressy-toc-fade-in {","originalFile":"import { ComponentChildren, ComponentType } from \"preact\";\nimport { useState, useEffect, useRef, useCallback } from \"preact/hooks\";\n\nimport { Navigation } from \"./Navigation.js\";\nimport { TextShare } from \"./TextShare.js\";\nimport { OfflineIndicator } from \"./OfflineIndicator.js\";\n\nexport interface ProgressData {\n  page: number;\n  totalPages: number;\n  scrollPosition: number;\n}\n\nexport interface ChapterMapData {\n  chapterMap: Record<\n    string,\n    () => Promise<{\n      default: ComponentType<{ components?: Record<string, unknown> }>;\n    }>\n  >;\n  chapterOrder: string[];\n}\n\nexport interface OfflineProps {\n  bookSlug: string;\n  chapterUrls: string[];\n  cachedBooks: { value: Set<string> };\n  cacheProgress: {\n    value: { bookSlug: string; current: number; total: number } | null;\n  };\n  onDownload: (bookSlug: string, chapterUrls: string[]) => void;\n  onRemove: (bookSlug: string) => void;\n}\n\nexport interface ReaderProps {\n  children: ComponentChildren;\n  title: string;\n  bookTitle?: string;\n  chapterSlug?: string;\n  prevChapter?: { slug: string; title: string };\n  nextChapter?: { slug: string; title: string };\n  showDropCap?: boolean;\n  paginationMode?: \"scroll\" | \"paginated\";\n  onSaveProgress?: (data: ProgressData) => void;\n  onRestoreProgress?: () => Promise<ProgressData | null>;\n  bookProgressPercent?: number;\n  initialContent?: ComponentType<{ components?: Record<string, unknown> }>;\n  chapterMapData?: ChapterMapData;\n  currentChapterSlug?: string;\n  allChapters?: Array<{ slug: string; title: string; wordCount?: number }>;\n  bookBasePath?: string;\n  onChapterChange?: (slug: string, page: number, totalPages: number) => void;\n  mdxComponents?: Record<string, unknown>;\n  offlineProps?: OfflineProps;\n}\n\nexport function Reader({\n  children,\n  bookTitle,\n  prevChapter,\n  nextChapter,\n  showDropCap = true,\n  paginationMode = \"scroll\",\n  onSaveProgress,\n  onRestoreProgress,\n  bookProgressPercent,\n  initialContent,\n  chapterMapData,\n  currentChapterSlug,\n  allChapters,\n  bookBasePath,\n  onChapterChange,\n  mdxComponents,\n  offlineProps,\n}: ReaderProps) {\n  if (paginationMode === \"paginated\") {\n    return (\n      <PaginatedReader\n        bookTitle={bookTitle}\n        prevChapter={prevChapter}\n        nextChapter={nextChapter}\n        showDropCap={showDropCap}\n        onSaveProgress={onSaveProgress}\n        onRestoreProgress={onRestoreProgress}\n        bookProgressPercent={bookProgressPercent}\n        initialContent={initialContent}\n        chapterMapData={chapterMapData}\n        currentChapterSlug={currentChapterSlug}\n        allChapters={allChapters}\n        bookBasePath={bookBasePath}\n        onChapterChange={onChapterChange}\n        mdxComponents={mdxComponents}\n        offlineProps={offlineProps}\n      >\n        {children}\n      </PaginatedReader>\n    );\n  }\n\n  return (\n    <ScrollReader\n      bookTitle={bookTitle}\n      prevChapter={prevChapter}\n      nextChapter={nextChapter}\n      showDropCap={showDropCap}\n      onSaveProgress={onSaveProgress}\n      onRestoreProgress={onRestoreProgress}\n      allChapters={allChapters}\n      bookBasePath={bookBasePath}\n      currentChapterSlug={currentChapterSlug}\n      offlineProps={offlineProps}\n    >\n      {children}\n    </ScrollReader>\n  );\n}\n\n// ── Offline Footer Icon ───────────────────────────────────────\n\nfunction OfflineFooterIcon({ offlineProps }: { offlineProps?: OfflineProps }) {\n  if (!offlineProps) return null;\n\n  const {\n    bookSlug,\n    chapterUrls,\n    cachedBooks,\n    onDownload,\n    onRemove,\n  } = offlineProps;\n\n  // Read signal .value directly in render — @preact/signals auto-subscribes\n  // and re-renders this component when the underlying signal changes.\n  const isCached = cachedBooks.value.has(bookSlug);\n\n  // Check isCached FIRST (matching DownloadBook's order). The download function\n  // optimistically marks the book as cached immediately, so isCached becomes true\n  // at the same time as isDownloading. Checking isCached first means we show the\n  // cached icon right away while the SW downloads in the background.\n  if (isCached) {\n    return (\n      <button\n        class=\"pressy-offline-icon pressy-offline-icon--cached\"\n        onClick={(e: MouseEvent) => {\n          e.stopPropagation();\n          onRemove(bookSlug);\n        }}\n        aria-label=\"Available offline. Click to remove.\"\n        title=\"Available offline. Click to remove.\"\n      >\n        <svg\n          viewBox=\"0 0 24 24\"\n          fill=\"none\"\n          stroke=\"currentColor\"\n          stroke-width=\"1.5\"\n          stroke-linecap=\"round\"\n          stroke-linejoin=\"round\"\n          width=\"18\"\n          height=\"18\"\n        >\n          <path d=\"M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z\" />\n          <polyline points=\"9 15 12 18 15 15\" />\n          <line x1=\"12\" y1=\"12\" x2=\"12\" y2=\"18\" />\n        </svg>\n        <svg\n          class=\"pressy-offline-check\"\n          viewBox=\"0 0 24 24\"\n          fill=\"currentColor\"\n          width=\"10\"\n          height=\"10\"\n        >\n          <path d=\"M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z\" />\n        </svg>\n      </button>\n    );\n  }\n\n  return (\n    <button\n      class=\"pressy-offline-icon\"\n      onClick={(e: MouseEvent) => {\n        e.stopPropagation();\n        onDownload(bookSlug, chapterUrls);\n      }}\n      aria-label=\"Download for offline reading\"\n      title=\"Download for offline reading\"\n    >\n      <svg\n        viewBox=\"0 0 24 24\"\n        fill=\"none\"\n        stroke=\"currentColor\"\n        stroke-width=\"1.5\"\n        stroke-linecap=\"round\"\n        stroke-linejoin=\"round\"\n        width=\"18\"\n        height=\"18\"\n      >\n        <path d=\"M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z\" />\n        <polyline points=\"9 15 12 18 15 15\" />\n        <line x1=\"12\" y1=\"12\" x2=\"12\" y2=\"18\" />\n      </svg>\n    </button>\n  );\n}\n\n// ── Scroll Reader ────────────────────────────────────────────\n\ninterface ScrollReaderProps {\n  children: ComponentChildren;\n  bookTitle?: string;\n  prevChapter?: { slug: string; title: string };\n  nextChapter?: { slug: string; title: string };\n  showDropCap: boolean;\n  onSaveProgress?: (data: ProgressData) => void;\n  onRestoreProgress?: () => Promise<ProgressData | null>;\n  allChapters?: Array<{ slug: string; title: string; wordCount?: number }>;\n  bookBasePath?: string;\n  currentChapterSlug?: string;\n  offlineProps?: OfflineProps;\n}\n\nfunction ScrollReader({\n  children,\n  bookTitle,\n  prevChapter,\n  nextChapter,\n  showDropCap,\n  onSaveProgress,\n  onRestoreProgress,\n  allChapters,\n  bookBasePath,\n  currentChapterSlug,\n  offlineProps,\n}: ScrollReaderProps) {\n  const saveTimerRef = useRef<ReturnType<typeof setTimeout> | null>(null);\n\n  // Footer visibility\n  const [footerVisible, setFooterVisible] = useState(false);\n  const footerTimerRef = useRef<ReturnType<typeof setTimeout> | null>(null);\n  const [settingsOpen, setSettingsOpen] = useState(false);\n  const [tocOpen, setTocOpen] = useState(false);\n\n  const showFooterTemporarily = useCallback(() => {\n    setFooterVisible(true);\n    if (footerTimerRef.current) clearTimeout(footerTimerRef.current);\n    footerTimerRef.current = setTimeout(() => setFooterVisible(false), 3000);\n  }, []);\n\n  // Settings state\n  const [activeTheme, setActiveTheme] = useState<string>(() => {\n    if (typeof localStorage !== \"undefined\") {\n      return localStorage.getItem(\"pressy-theme\") || \"light\";\n    }\n    return \"light\";\n  });\n  const [fontScale, setFontScale] = useState<number>(() => {\n    if (typeof localStorage !== \"undefined\") {\n      const saved = localStorage.getItem(\"pressy-font-size\");\n      return saved ? parseFloat(saved) : 1.0;\n    }\n    return 1.0;\n  });\n\n  const applyFontScale = useCallback((scale: number) => {\n    if (scale === 1.0) {\n      document.documentElement.style.removeProperty(\"--font-size-base\");\n    } else {\n      document.documentElement.style.setProperty(\n        \"--font-size-base\",\n        `calc(clamp(1rem, 0.875rem + 0.5vw, 1.25rem) * ${scale})`\n      );\n    }\n  }, []);\n\n  useEffect(() => {\n    if (fontScale !== 1.0) {\n      applyFontScale(fontScale);\n    }\n  }, []);\n\n  const handleThemeChange = useCallback((theme: string) => {\n    setActiveTheme(theme);\n    localStorage.setItem(\"pressy-theme\", theme);\n    const resolved =\n      theme === \"system\"\n        ? window.matchMedia(\"(prefers-color-scheme: dark)\").matches\n          ? \"dark\"\n          : \"light\"\n        : theme;\n    document.documentElement.setAttribute(\"data-theme\", resolved);\n  }, []);\n\n  const handleFontSizeChange = useCallback(\n    (delta: number) => {\n      setFontScale((prev) => {\n        const next =\n          Math.round(Math.max(0.8, Math.min(1.5, prev + delta)) * 10) / 10;\n        localStorage.setItem(\"pressy-font-size\", String(next));\n        applyFontScale(next);\n        return next;\n      });\n    },\n    [applyFontScale]\n  );\n\n  // Toggle footer on tap\n  const handleReaderClick = useCallback(\n    (e: MouseEvent) => {\n      const target = e.target as HTMLElement;\n      if (\n        target.closest(\n          \".pressy-page-footer, .pressy-toc-backdrop, .pressy-toc-toggle\"\n        )\n      )\n        return;\n      if (target.closest('a, button, input, select, textarea, [role=\"button\"]'))\n        return;\n\n      if (settingsOpen || tocOpen) {\n        setSettingsOpen(false);\n        setTocOpen(false);\n        return;\n      }\n\n      if (footerVisible) {\n        setFooterVisible(false);\n        if (footerTimerRef.current) clearTimeout(footerTimerRef.current);\n      } else {\n        showFooterTemporarily();\n      }\n    },\n    [footerVisible, settingsOpen, tocOpen, showFooterTemporarily]\n  );\n\n  // Restore scroll position on mount\n  useEffect(() => {\n    if (!onRestoreProgress) return;\n    onRestoreProgress().then((data) => {\n      if (data && data.scrollPosition > 0) {\n        window.scrollTo(0, data.scrollPosition);\n      }\n    });\n  }, []);\n\n  // Save scroll position (debounced)\n  useEffect(() => {\n    if (!onSaveProgress) return;\n\n    const handleScroll = () => {\n      if (saveTimerRef.current) clearTimeout(saveTimerRef.current);\n      saveTimerRef.current = setTimeout(() => {\n        onSaveProgress({\n          page: 0,\n          totalPages: 0,\n          scrollPosition: window.scrollY,\n        });\n      }, 500);\n    };\n\n    window.addEventListener(\"scroll\", handleScroll, { passive: true });\n    return () => {\n      window.removeEventListener(\"scroll\", handleScroll);\n      if (saveTimerRef.current) clearTimeout(saveTimerRef.current);\n    };\n  }, [onSaveProgress]);\n\n  // Save on page unload\n  useEffect(() => {\n    if (!onSaveProgress) return;\n\n    const handleUnload = () => {\n      onSaveProgress({\n        page: 0,\n        totalPages: 0,\n        scrollPosition: window.scrollY,\n      });\n    };\n\n    window.addEventListener(\"beforeunload\", handleUnload);\n    return () => window.removeEventListener(\"beforeunload\", handleUnload);\n  }, [onSaveProgress]);\n\n  return (\n    <div class=\"pressy-reader\" onClick={handleReaderClick}>\n      <main class=\"pressy-reader-main\">\n        <article\n          class={`pressy-prose ${showDropCap ? \"\" : \"no-drop-cap\"}`}\n          data-drop-cap={showDropCap}\n        >\n          {children}\n        </article>\n      </main>\n\n      <TextShare />\n      <Navigation prev={prevChapter} next={nextChapter} />\n      <OfflineIndicator />\n\n      {/* TOC drawer overlay */}\n      {tocOpen && allChapters && (\n        <div\n          class=\"pressy-toc-backdrop pressy-toc-backdrop--scroll\"\n          onClick={(e: MouseEvent) => {\n            e.stopPropagation();\n            setTocOpen(false);\n          }}\n        >\n          <div\n            class=\"pressy-toc-drawer\"\n            onClick={(e: MouseEvent) => e.stopPropagation()}\n          >\n            <div class=\"pressy-toc-header\">\n              <span class=\"pressy-toc-title\">Contents</span>\n              <button\n                class=\"pressy-toc-close\"\n                onClick={(e: MouseEvent) => {\n                  e.stopPropagation();\n                  setTocOpen(false);\n                }}\n                aria-label=\"Close table of contents\"\n              >\n                <svg\n                  viewBox=\"0 0 24 24\"\n                  fill=\"none\"\n                  stroke=\"currentColor\"\n                  stroke-width=\"2\"\n                  width=\"18\"\n                  height=\"18\"\n                >\n                  <line x1=\"18\" y1=\"6\" x2=\"6\" y2=\"18\" />\n                  <line x1=\"6\" y1=\"6\" x2=\"18\" y2=\"18\" />\n                </svg>\n              </button>\n            </div>\n            <nav class=\"pressy-toc-list\">\n              <a\n                href={bookBasePath ? bookBasePath.replace(/\\/books\\/[^/]+$/, '') || '/' : '/'}\n                class=\"pressy-toc-item pressy-toc-item--home\"\n                onClick={() => setTocOpen(false)}\n              >\n                <span class=\"pressy-toc-item-num\">\n                  <svg viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" width=\"14\" height=\"14\">\n                    <path d=\"M3 9.5L12 3l9 6.5V20a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V9.5z\" />\n                  </svg>\n                </span>\n                <span class=\"pressy-toc-item-title\">{bookTitle || 'Home'}</span>\n              </a>\n              {allChapters.map((ch, i) => (\n                <a\n                  key={ch.slug}\n                  href={`${bookBasePath || \"\"}/${ch.slug}`}\n                  class={`pressy-toc-item ${\n                    ch.slug === currentChapterSlug\n                      ? \"pressy-toc-item--active\"\n                      : \"\"\n                  }`}\n                  onClick={() => setTocOpen(false)}\n                >\n                  <span class=\"pressy-toc-item-num\">{i + 1}.</span>\n                  <span class=\"pressy-toc-item-title\">{ch.title}</span>\n                </a>\n              ))}\n            </nav>\n          </div>\n        </div>\n      )}\n\n      {/* Footer */}\n      <div\n        class={`pressy-page-footer pressy-page-footer--scroll ${\n          footerVisible || settingsOpen || tocOpen\n            ? \"pressy-page-footer--visible\"\n            : \"\"\n        }`}\n      >\n        <div class=\"pressy-footer-row\">\n          {allChapters && allChapters.length > 0 && (\n            <button\n              class=\"pressy-toc-toggle\"\n              onClick={(e: MouseEvent) => {\n                e.stopPropagation();\n                setSettingsOpen(false);\n                setTocOpen(!tocOpen);\n              }}\n              aria-label=\"Table of contents\"\n            >\n              <svg\n                viewBox=\"0 0 24 24\"\n                fill=\"none\"\n                stroke=\"currentColor\"\n                stroke-width=\"1.5\"\n                stroke-linecap=\"round\"\n                stroke-linejoin=\"round\"\n                width=\"18\"\n                height=\"18\"\n              >\n                <line x1=\"3\" y1=\"6\" x2=\"21\" y2=\"6\" />\n                <line x1=\"3\" y1=\"12\" x2=\"21\" y2=\"12\" />\n                <line x1=\"3\" y1=\"18\" x2=\"21\" y2=\"18\" />\n              </svg>\n            </button>\n          )}\n          {bookTitle && (\n            <button\n              class=\"pressy-footer-title\"\n              onClick={(e: MouseEvent) => {\n                e.stopPropagation();\n                if (allChapters && allChapters.length > 0) {\n                  setSettingsOpen(false);\n                  setTocOpen(!tocOpen);\n                }\n              }}\n            >\n              {bookTitle}\n            </button>\n          )}\n          <OfflineFooterIcon offlineProps={offlineProps} />\n          <button\n            class=\"pressy-settings-toggle\"\n            onClick={(e: MouseEvent) => {\n              e.stopPropagation();\n              setTocOpen(false);\n              setSettingsOpen(!settingsOpen);\n            }}\n            aria-label=\"Settings\"\n          >\n            <svg\n              viewBox=\"0 0 24 24\"\n              fill=\"none\"\n              stroke=\"currentColor\"\n              stroke-width=\"1.5\"\n              stroke-linecap=\"round\"\n              stroke-linejoin=\"round\"\n              width=\"18\"\n              height=\"18\"\n            >\n              <circle cx=\"12\" cy=\"12\" r=\"3\" />\n              <path d=\"M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z\" />\n            </svg>\n          </button>\n        </div>\n\n        {/* Settings panel */}\n        <div\n          class={`pressy-settings-panel ${\n            settingsOpen ? \"pressy-settings-panel--open\" : \"\"\n          }`}\n        >\n          <div class=\"pressy-settings-section\">\n            <div class=\"pressy-settings-label\">Theme</div>\n            <div class=\"pressy-theme-options\">\n              {(\n                [\n                  {\n                    id: \"light\",\n                    label: \"Light\",\n                    icon: (\n                      <svg\n                        viewBox=\"0 0 24 24\"\n                        fill=\"none\"\n                        stroke=\"currentColor\"\n                        stroke-width=\"1.5\"\n                        width=\"16\"\n                        height=\"16\"\n                      >\n                        <circle cx=\"12\" cy=\"12\" r=\"5\" />\n                        <line x1=\"12\" y1=\"1\" x2=\"12\" y2=\"3\" />\n                        <line x1=\"12\" y1=\"21\" x2=\"12\" y2=\"23\" />\n                        <line x1=\"4.22\" y1=\"4.22\" x2=\"5.64\" y2=\"5.64\" />\n                        <line x1=\"18.36\" y1=\"18.36\" x2=\"19.78\" y2=\"19.78\" />\n                        <line x1=\"1\" y1=\"12\" x2=\"3\" y2=\"12\" />\n                        <line x1=\"21\" y1=\"12\" x2=\"23\" y2=\"12\" />\n                        <line x1=\"4.22\" y1=\"19.78\" x2=\"5.64\" y2=\"18.36\" />\n                        <line x1=\"18.36\" y1=\"5.64\" x2=\"19.78\" y2=\"4.22\" />\n                      </svg>\n                    ),\n                  },\n                  {\n                    id: \"dark\",\n                    label: \"Dark\",\n                    icon: (\n                      <svg\n                        viewBox=\"0 0 24 24\"\n                        fill=\"none\"\n                        stroke=\"currentColor\"\n                        stroke-width=\"1.5\"\n                        width=\"16\"\n                        height=\"16\"\n                      >\n                        <path d=\"M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z\" />\n                      </svg>\n                    ),\n                  },\n                  {\n                    id: \"system\",\n                    label: \"System\",\n                    icon: (\n                      <svg\n                        viewBox=\"0 0 24 24\"\n                        fill=\"none\"\n                        stroke=\"currentColor\"\n                        stroke-width=\"1.5\"\n                        width=\"16\"\n                        height=\"16\"\n                      >\n                        <rect\n                          x=\"2\"\n                          y=\"3\"\n                          width=\"20\"\n                          height=\"14\"\n                          rx=\"2\"\n                          ry=\"2\"\n                        />\n                        <line x1=\"8\" y1=\"21\" x2=\"16\" y2=\"21\" />\n                        <line x1=\"12\" y1=\"17\" x2=\"12\" y2=\"21\" />\n                      </svg>\n                    ),\n                  },\n                  {\n                    id: \"sepia\",\n                    label: \"Sepia\",\n                    icon: (\n                      <svg\n                        viewBox=\"0 0 24 24\"\n                        fill=\"none\"\n                        stroke=\"currentColor\"\n                        stroke-width=\"1.5\"\n                        width=\"16\"\n                        height=\"16\"\n                      >\n                        <path d=\"M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z\" />\n                        <path d=\"M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z\" />\n                      </svg>\n                    ),\n                  },\n                ] as const\n              ).map((t) => (\n                <button\n                  key={t.id}\n                  class={`pressy-theme-btn ${\n                    activeTheme === t.id ? \"pressy-theme-btn--active\" : \"\"\n                  }`}\n                  onClick={(e: MouseEvent) => {\n                    e.stopPropagation();\n                    handleThemeChange(t.id);\n                  }}\n                >\n                  {t.icon}\n                  <span>{t.label}</span>\n                </button>\n              ))}\n            </div>\n          </div>\n          <div class=\"pressy-settings-section\">\n            <div class=\"pressy-settings-label\">Font Size</div>\n            <div class=\"pressy-font-size-controls\">\n              <button\n                class=\"pressy-font-size-btn\"\n                onClick={(e: MouseEvent) => {\n                  e.stopPropagation();\n                  handleFontSizeChange(-0.1);\n                }}\n                disabled={fontScale <= 0.8}\n                aria-label=\"Decrease font size\"\n              >\n                A-\n              </button>\n              <span class=\"pressy-font-size-value\">\n                {Math.round(fontScale * 100)}%\n              </span>\n              <button\n                class=\"pressy-font-size-btn\"\n                onClick={(e: MouseEvent) => {\n                  e.stopPropagation();\n                  handleFontSizeChange(0.1);\n                }}\n                disabled={fontScale >= 1.5}\n                aria-label=\"Increase font size\"\n              >\n                A+\n              </button>\n            </div>\n          </div>\n        </div>\n      </div>\n\n      <style>{SCROLL_STYLES}</style>\n    </div>\n  );\n}\n\n// ── Paginated Reader ──────────────────────────────────────────\n\ninterface LoadedChapter {\n  slug: string;\n  title: string;\n  Content: ComponentType<{ components?: Record<string, unknown> }>;\n}\n\ninterface ChapterPageRange {\n  slug: string;\n  startPage: number;\n  endPage: number;\n}\n\ninterface PaginatedReaderProps {\n  children: ComponentChildren;\n  bookTitle?: string;\n  prevChapter?: { slug: string; title: string };\n  nextChapter?: { slug: string; title: string };\n  showDropCap: boolean;\n  onSaveProgress?: (data: ProgressData) => void;\n  onRestoreProgress?: () => Promise<ProgressData | null>;\n  bookProgressPercent?: number;\n  initialContent?: ComponentType<{ components?: Record<string, unknown> }>;\n  chapterMapData?: ChapterMapData;\n  currentChapterSlug?: string;\n  allChapters?: Array<{ slug: string; title: string; wordCount?: number }>;\n  bookBasePath?: string;\n  onChapterChange?: (slug: string, page: number, totalPages: number) => void;\n  mdxComponents?: Record<string, unknown>;\n  offlineProps?: OfflineProps;\n}\n\nfunction ChapterDivider({ title }: { title: string }) {\n  return (\n    <div class=\"pressy-chapter-divider\">\n      <h2 class=\"pressy-chapter-divider-title\">{title}</h2>\n    </div>\n  );\n}\n\nfunction PaginatedReader({\n  children,\n  bookTitle,\n  prevChapter,\n  nextChapter,\n  showDropCap,\n  onSaveProgress,\n  onRestoreProgress,\n  bookProgressPercent,\n  initialContent,\n  chapterMapData,\n  currentChapterSlug,\n  allChapters,\n  bookBasePath,\n  onChapterChange,\n  mdxComponents,\n  offlineProps,\n}: PaginatedReaderProps) {\n  const containerRef = useRef<HTMLDivElement>(null);\n  const viewportRef = useRef<HTMLDivElement>(null);\n  const articleRef = useRef<HTMLElement>(null);\n  const [currentPage, setCurrentPage] = useState(0);\n  const [totalPages, setTotalPages] = useState(1);\n  const hasRestoredRef = useRef(false);\n  const saveTimerRef = useRef<ReturnType<typeof setTimeout> | null>(null);\n\n  // Multi-chapter state\n  const [loadedChapters, setLoadedChapters] = useState<LoadedChapter[]>([]);\n  const [chapterRanges, setChapterRanges] = useState<ChapterPageRange[]>([]);\n  const [activeChapterSlug, setActiveChapterSlug] = useState(\n    currentChapterSlug || \"\"\n  );\n  const preloadingRef = useRef<Set<string>>(new Set());\n\n  // Whether we're in multi-chapter mode\n  const isMultiChapter = !!(\n    chapterMapData &&\n    initialContent &&\n    currentChapterSlug &&\n    allChapters\n  );\n\n  // Initialize loaded chapters\n  useEffect(() => {\n    if (isMultiChapter && initialContent && currentChapterSlug) {\n      const chapterInfo = allChapters!.find(\n        (ch) => ch.slug === currentChapterSlug\n      );\n      setLoadedChapters([\n        {\n          slug: currentChapterSlug,\n          title: chapterInfo?.title || currentChapterSlug,\n          Content: initialContent,\n        },\n      ]);\n      setActiveChapterSlug(currentChapterSlug);\n    }\n  }, []); // Only on mount\n\n  // Settings & TOC panel state\n  const [settingsOpen, setSettingsOpen] = useState(false);\n  const [tocOpen, setTocOpen] = useState(false);\n  const [activeTheme, setActiveTheme] = useState<string>(() => {\n    if (typeof localStorage !== \"undefined\") {\n      return localStorage.getItem(\"pressy-theme\") || \"light\";\n    }\n    return \"light\";\n  });\n  const [fontScale, setFontScale] = useState<number>(() => {\n    if (typeof localStorage !== \"undefined\") {\n      const saved = localStorage.getItem(\"pressy-font-size\");\n      return saved ? parseFloat(saved) : 1.0;\n    }\n    return 1.0;\n  });\n\n  const applyFontScale = useCallback((scale: number) => {\n    if (scale === 1.0) {\n      document.documentElement.style.removeProperty(\"--font-size-base\");\n    } else {\n      document.documentElement.style.setProperty(\n        \"--font-size-base\",\n        `calc(clamp(1rem, 0.875rem + 0.5vw, 1.25rem) * ${scale})`\n      );\n    }\n  }, []);\n\n  // Apply saved font scale on mount\n  useEffect(() => {\n    if (fontScale !== 1.0) {\n      applyFontScale(fontScale);\n    }\n  }, []);\n\n  const handleThemeChange = useCallback((theme: string) => {\n    setActiveTheme(theme);\n    localStorage.setItem(\"pressy-theme\", theme);\n    const resolved =\n      theme === \"system\"\n        ? window.matchMedia(\"(prefers-color-scheme: dark)\").matches\n          ? \"dark\"\n          : \"light\"\n        : theme;\n    document.documentElement.setAttribute(\"data-theme\", resolved);\n  }, []);\n\n  // Drag/swipe state\n  const [isDragging, setIsDragging] = useState(false);\n  const [dragOffset, setDragOffset] = useState(0);\n  const [chapterHint, setChapterHint] = useState<\"next\" | \"prev\" | null>(null);\n\n  // Touch tracking refs (avoid re-renders during drag)\n  const touchStartXRef = useRef(0);\n  const touchStartYRef = useRef(0);\n  const lastTouchXRef = useRef(0);\n  const lastTouchTimeRef = useRef(0);\n  const velocityRef = useRef(0);\n  const isSwipingRef = useRef(false);\n  const isDraggingRef = useRef(false);\n\n  // Build page-to-chapter map after recalculating pages\n  const updateChapterRanges = useCallback(() => {\n    if (!isMultiChapter) return;\n    const article = articleRef.current;\n    const viewport = viewportRef.current;\n    if (!article || !viewport) return;\n\n    const viewportWidth = viewport.clientWidth;\n    if (viewportWidth === 0) return;\n\n    const sections = article.querySelectorAll(\".pressy-chapter-section\");\n    const ranges: ChapterPageRange[] = [];\n\n    sections.forEach((section) => {\n      const slug = section.getAttribute(\"data-chapter-slug\") || \"\";\n      const sectionLeft = (section as HTMLElement).offsetLeft;\n      const sectionWidth = (section as HTMLElement).scrollWidth;\n      const startPage = Math.floor(sectionLeft / viewportWidth);\n      const endPage = Math.max(\n        startPage,\n        Math.ceil((sectionLeft + sectionWidth) / viewportWidth) - 1\n      );\n      ranges.push({ slug, startPage, endPage });\n    });\n\n    setChapterRanges(ranges);\n  }, [isMultiChapter]);\n\n  // Calculate page count and set column-width to match viewport\n  const recalculatePages = useCallback(() => {\n    const article = articleRef.current;\n    const viewport = viewportRef.current;\n    if (!article || !viewport) return;\n\n    const viewportWidth = viewport.clientWidth;\n    if (viewportWidth === 0) return;\n\n    // Set column-width to viewport width so each column = one page\n    article.style.columnWidth = `${viewportWidth}px`;\n\n    // Force synchronous layout recalculation\n    void article.scrollWidth;\n\n    const total = Math.max(1, Math.round(article.scrollWidth / viewportWidth));\n    setTotalPages(total);\n\n    // Clamp current page if now out of bounds (e.g. after resize)\n    setCurrentPage((prev) => Math.min(prev, total - 1));\n\n    // Update chapter ranges for multi-chapter mode\n    updateChapterRanges();\n  }, [updateChapterRanges]);\n\n  // Font size change handler (defined after recalculatePages)\n  const handleFontSizeChange = useCallback(\n    (delta: number) => {\n      setFontScale((prev) => {\n        const next =\n          Math.round(Math.max(0.8, Math.min(1.5, prev + delta)) * 10) / 10;\n        localStorage.setItem(\"pressy-font-size\", String(next));\n        applyFontScale(next);\n        setTimeout(() => recalculatePages(), 100);\n        return next;\n      });\n    },\n    [applyFontScale, recalculatePages]\n  );\n\n  // Recalculate on mount and on resize via ResizeObserver\n  useEffect(() => {\n    const viewport = viewportRef.current;\n    if (!viewport) return;\n\n    // Delay initial calculation to let fonts and content render\n    const initialTimer = setTimeout(recalculatePages, 50);\n\n    const observer = new ResizeObserver(() => {\n      recalculatePages();\n    });\n    observer.observe(viewport);\n\n    return () => {\n      clearTimeout(initialTimer);\n      observer.disconnect();\n    };\n  }, [recalculatePages]);\n\n  // Recalculate when loaded chapters change\n  useEffect(() => {\n    if (loadedChapters.length > 0) {\n      // Delay to let new content render\n      const timer = setTimeout(recalculatePages, 50);\n      return () => clearTimeout(timer);\n    }\n  }, [loadedChapters.length, recalculatePages]);\n\n  // Recalculate when images finish loading\n  useEffect(() => {\n    const article = articleRef.current;\n    if (!article) return;\n\n    const images = article.querySelectorAll(\"img\");\n    if (images.length === 0) return;\n\n    const onLoad = () => recalculatePages();\n    images.forEach((img) => {\n      if (!img.complete) {\n        img.addEventListener(\"load\", onLoad);\n        img.addEventListener(\"error\", onLoad);\n      }\n    });\n\n    return () => {\n      images.forEach((img) => {\n        img.removeEventListener(\"load\", onLoad);\n        img.removeEventListener(\"error\", onLoad);\n      });\n    };\n  }, [recalculatePages, loadedChapters.length]);\n\n  // Check ?page=last query param for backward navigation\n  useEffect(() => {\n    const params = new URLSearchParams(window.location.search);\n    if (params.get(\"page\") === \"last\" && totalPages > 1) {\n      setCurrentPage(totalPages - 1);\n      hasRestoredRef.current = true;\n      // Clean up the URL\n      const url = new URL(window.location.href);\n      url.searchParams.delete(\"page\");\n      history.replaceState(null, \"\", url.pathname);\n    }\n  }, [totalPages]);\n\n  // Apply translateX — combines page position + drag offset\n  useEffect(() => {\n    const article = articleRef.current;\n    const viewport = viewportRef.current;\n    if (!article || !viewport) return;\n\n    const baseOffset = currentPage * viewport.clientWidth;\n    const totalOffset = baseOffset - dragOffset;\n\n    if (isDragging) {\n      // During drag: no transition, immediate response\n      article.style.transition = \"none\";\n    } else {\n      // Snap animation: smooth ease-out\n      article.style.transition =\n        \"transform 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94)\";\n    }\n\n    article.style.transform = `translateX(-${totalOffset}px)`;\n  }, [currentPage, dragOffset, isDragging]);\n\n  // Manage focusability: elements on off-screen pages get tabindex=\"-1\"\n  // so tab navigation can't reach them and cause layout shifts.\n  // Uses getBoundingClientRect which accounts for the CSS transform.\n  useEffect(() => {\n    const article = articleRef.current;\n    const viewport = viewportRef.current;\n    if (!article || !viewport) return;\n\n    const viewportRect = viewport.getBoundingClientRect();\n\n    const focusable = article.querySelectorAll<HTMLElement>(\n      \"a[href], button, input, select, textarea, [tabindex]\"\n    );\n\n    focusable.forEach((el) => {\n      const elRect = el.getBoundingClientRect();\n      const onCurrentPage =\n        elRect.left >= viewportRect.left - 1 &&\n        elRect.right <= viewportRect.right + 1;\n\n      if (onCurrentPage) {\n        const original = el.getAttribute(\"data-original-tabindex\");\n        if (original !== null) {\n          if (original === \"\") {\n            el.removeAttribute(\"tabindex\");\n          } else {\n            el.setAttribute(\"tabindex\", original);\n          }\n          el.removeAttribute(\"data-original-tabindex\");\n        }\n      } else {\n        if (!el.hasAttribute(\"data-original-tabindex\")) {\n          el.setAttribute(\n            \"data-original-tabindex\",\n            el.getAttribute(\"tabindex\") || \"\"\n          );\n        }\n        el.setAttribute(\"tabindex\", \"-1\");\n      }\n    });\n  }, [currentPage, totalPages]);\n\n  // Preload next chapter when within 2 pages of chapter end\n  useEffect(() => {\n    if (!isMultiChapter || !chapterMapData || chapterRanges.length === 0)\n      return;\n\n    const activeRange = chapterRanges.find((r) => r.slug === activeChapterSlug);\n    if (!activeRange) return;\n\n    const pagesFromEnd = activeRange.endPage - currentPage;\n    if (pagesFromEnd > 2) return;\n\n    // Find the next chapter to preload\n    const { chapterOrder, chapterMap } = chapterMapData;\n    const lastLoadedSlug = loadedChapters[loadedChapters.length - 1]?.slug;\n    const lastLoadedIdx = chapterOrder.indexOf(lastLoadedSlug);\n    if (lastLoadedIdx === -1 || lastLoadedIdx >= chapterOrder.length - 1)\n      return;\n\n    const nextSlug = chapterOrder[lastLoadedIdx + 1];\n    if (preloadingRef.current.has(nextSlug)) return;\n    if (loadedChapters.some((ch) => ch.slug === nextSlug)) return;\n\n    preloadingRef.current.add(nextSlug);\n\n    const loader = chapterMap[nextSlug];\n    if (!loader) return;\n\n    loader()\n      .then((mod) => {\n        const Content = mod.default;\n        const chapterInfo = allChapters!.find((ch) => ch.slug === nextSlug);\n        setLoadedChapters((prev) => {\n          if (prev.some((ch) => ch.slug === nextSlug)) return prev;\n          return [\n            ...prev,\n            {\n              slug: nextSlug,\n              title: chapterInfo?.title || nextSlug,\n              Content,\n            },\n          ];\n        });\n      })\n      .catch(() => {\n        // Dynamic import failed — will fall back to full-page navigation\n        preloadingRef.current.delete(nextSlug);\n      });\n  }, [\n    currentPage,\n    activeChapterSlug,\n    chapterRanges,\n    isMultiChapter,\n    chapterMapData,\n    loadedChapters,\n    allChapters,\n  ]);\n\n  // Detect chapter boundary crossings and update URL / active chapter\n  useEffect(() => {\n    if (!isMultiChapter || chapterRanges.length === 0 || !bookBasePath) return;\n\n    const currentRange = chapterRanges.find(\n      (r) => currentPage >= r.startPage && currentPage <= r.endPage\n    );\n    if (!currentRange || currentRange.slug === activeChapterSlug) return;\n\n    const prevSlug = activeChapterSlug;\n    setActiveChapterSlug(currentRange.slug);\n\n    // Update URL\n    const newPath = `${bookBasePath}/${currentRange.slug}`;\n    history.replaceState(null, \"\", newPath);\n\n    // Update document title\n    const chapterInfo = allChapters?.find(\n      (ch) => ch.slug === currentRange.slug\n    );\n    if (chapterInfo) {\n      document.title = document.title.replace(\n        /^[^|]+/,\n        chapterInfo.title + \" \"\n      );\n    }\n\n    // Notify parent about chapter change (saves progress for the chapter being left)\n    if (onChapterChange && prevSlug) {\n      const prevRange = chapterRanges.find((r) => r.slug === prevSlug);\n      if (prevRange) {\n        const prevTotalPages = prevRange.endPage - prevRange.startPage + 1;\n        onChapterChange(prevSlug, prevTotalPages - 1, prevTotalPages);\n      }\n    }\n  }, [\n    currentPage,\n    chapterRanges,\n    activeChapterSlug,\n    isMultiChapter,\n    bookBasePath,\n    allChapters,\n    onChapterChange,\n  ]);\n\n  // Save progress when page changes (debounced) — save relative to active chapter\n  useEffect(() => {\n    if (!onSaveProgress || !hasRestoredRef.current) return;\n\n    if (saveTimerRef.current) clearTimeout(saveTimerRef.current);\n    saveTimerRef.current = setTimeout(() => {\n      if (isMultiChapter && chapterRanges.length > 0) {\n        const activeRange = chapterRanges.find(\n          (r) => r.slug === activeChapterSlug\n        );\n        if (activeRange) {\n          const chapterPage = currentPage - activeRange.startPage;\n          const chapterTotalPages =\n            activeRange.endPage - activeRange.startPage + 1;\n          onSaveProgress({\n            page: chapterPage,\n            totalPages: chapterTotalPages,\n            scrollPosition: 0,\n          });\n        }\n      } else {\n        onSaveProgress({\n          page: currentPage,\n          totalPages,\n          scrollPosition: 0,\n        });\n      }\n    }, 300);\n\n    return () => {\n      if (saveTimerRef.current) clearTimeout(saveTimerRef.current);\n    };\n  }, [\n    currentPage,\n    totalPages,\n    onSaveProgress,\n    isMultiChapter,\n    chapterRanges,\n    activeChapterSlug,\n  ]);\n\n  // Save progress on page unload\n  useEffect(() => {\n    if (!onSaveProgress) return;\n\n    const handleUnload = () => {\n      if (isMultiChapter && chapterRanges.length > 0) {\n        const activeRange = chapterRanges.find(\n          (r) => r.slug === activeChapterSlug\n        );\n        if (activeRange) {\n          const chapterPage = currentPage - activeRange.startPage;\n          const chapterTotalPages =\n            activeRange.endPage - activeRange.startPage + 1;\n          onSaveProgress({\n            page: chapterPage,\n            totalPages: chapterTotalPages,\n            scrollPosition: 0,\n          });\n        }\n      } else {\n        onSaveProgress({\n          page: currentPage,\n          totalPages,\n          scrollPosition: 0,\n        });\n      }\n    };\n\n    window.addEventListener(\"beforeunload\", handleUnload);\n    return () => window.removeEventListener(\"beforeunload\", handleUnload);\n  }, [\n    currentPage,\n    totalPages,\n    onSaveProgress,\n    isMultiChapter,\n    chapterRanges,\n    activeChapterSlug,\n  ]);\n\n  // Determine the effective last chapter slug for rubber-band / next chapter hint\n  const effectiveNextChapter = (() => {\n    if (!isMultiChapter || !chapterMapData) return nextChapter;\n    const { chapterOrder } = chapterMapData;\n    const lastLoadedSlug = loadedChapters[loadedChapters.length - 1]?.slug;\n    const lastLoadedIdx = chapterOrder.indexOf(lastLoadedSlug);\n    // If we haven't loaded the last chapter in the book yet, no next chapter hint needed\n    // (preloading will seamlessly add the next chapter)\n    if (lastLoadedIdx < chapterOrder.length - 1) return undefined;\n    // All chapters loaded — navigate to book table of contents\n    if (bookBasePath) return { slug: bookBasePath, title: \"Table of Contents\" };\n    return nextChapter;\n  })();\n\n  // Determine the effective prev chapter for backward navigation\n  const effectivePrevChapter = (() => {\n    if (!isMultiChapter || !chapterMapData) return prevChapter;\n    const { chapterOrder } = chapterMapData;\n    const firstLoadedSlug = loadedChapters[0]?.slug;\n    const firstLoadedIdx = chapterOrder.indexOf(firstLoadedSlug);\n    // If the first loaded chapter is the first chapter of the book\n    if (firstLoadedIdx <= 0) return prevChapter;\n    // There's a previous chapter in the book — navigate to it via page load\n    const prevSlug = chapterOrder[firstLoadedIdx - 1];\n    const prevInfo = allChapters?.find((ch) => ch.slug === prevSlug);\n    return {\n      slug: `${bookBasePath}/${prevSlug}?page=last`,\n      title: prevInfo?.title || prevSlug,\n    };\n  })();\n\n  const goToPage = useCallback(\n    (page: number) => {\n      const clamped = Math.max(0, Math.min(page, totalPages - 1));\n      setCurrentPage(clamped);\n    },\n    [totalPages]\n  );\n\n  const goNext = useCallback(() => {\n    if (currentPage >= totalPages - 1) {\n      // At the last page — navigate to next chapter if available\n      if (effectiveNextChapter) {\n        window.location.href = effectiveNextChapter.slug;\n      }\n      return;\n    }\n    goToPage(currentPage + 1);\n  }, [currentPage, totalPages, effectiveNextChapter, goToPage]);\n\n  const goPrev = useCallback(() => {\n    if (currentPage <= 0) {\n      // At the first page — navigate to prev chapter if available\n      if (effectivePrevChapter) {\n        window.location.href = effectivePrevChapter.slug;\n      }\n      return;\n    }\n    goToPage(currentPage - 1);\n  }, [currentPage, effectivePrevChapter, goToPage]);\n\n  // Footer visibility — hidden by default, shown on interaction\n  const [footerVisible, setFooterVisible] = useState(false);\n  const footerTimerRef = useRef<ReturnType<typeof setTimeout> | null>(null);\n\n  const showFooterTemporarily = useCallback(() => {\n    setFooterVisible(true);\n    if (footerTimerRef.current) clearTimeout(footerTimerRef.current);\n    footerTimerRef.current = setTimeout(() => setFooterVisible(false), 3000);\n  }, []);\n\n  // Double-tap fullscreen (mobile middle-third)\n  const lastMiddleTapRef = useRef(0);\n  const middleTapTimerRef = useRef<ReturnType<typeof setTimeout> | null>(null);\n\n  const toggleFullscreen = useCallback(() => {\n    if (document.fullscreenElement) {\n      document.exitFullscreen();\n    } else {\n      document.documentElement.requestFullscreen().catch(() => {\n        // Fullscreen not supported or denied\n      });\n    }\n  }, []);\n\n  // Whether the device supports hover (i.e. desktop with a mouse).\n  // Touch-only devices use swipe for page turns; tapping just toggles the footer.\n  const isTouchDevice =\n    typeof window !== \"undefined\" && window.matchMedia(\"(hover: none)\").matches;\n\n  // Click handler: on desktop, edge clicks turn pages and middle clicks\n  // toggle footer / double-click fullscreen. On touch devices, any tap\n  // simply toggles the footer — swiping handles all page navigation.\n  const handleContainerClick = useCallback(\n    (e: MouseEvent) => {\n      const target = e.target as HTMLElement;\n\n      // Clicks inside panels or on interactive elements — ignore\n      if (\n        target.closest(\n          \".pressy-settings-panel, .pressy-settings-toggle, .pressy-toc-drawer, .pressy-toc-toggle\"\n        )\n      )\n        return;\n      if (target.closest('a, button, input, select, textarea, [role=\"button\"]'))\n        return;\n\n      // If settings or TOC panel is open, close it on any outside click\n      if (settingsOpen || tocOpen) {\n        setSettingsOpen(false);\n        setTocOpen(false);\n        return;\n      }\n\n      // Touch devices: tap anywhere toggles the footer, nothing else\n      if (isTouchDevice) {\n        if (footerVisible) {\n          setFooterVisible(false);\n          if (footerTimerRef.current) clearTimeout(footerTimerRef.current);\n        } else {\n          showFooterTemporarily();\n        }\n        return;\n      }\n\n      // Desktop: edge clicks turn pages, middle clicks toggle footer / fullscreen\n      const container = containerRef.current;\n      if (!container) return;\n\n      const rect = container.getBoundingClientRect();\n      const x = e.clientX - rect.left;\n      const edgeZone = rect.width * 0.15;\n\n      if (x < edgeZone) {\n        goPrev();\n      } else if (x > rect.width - edgeZone) {\n        goNext();\n      } else {\n        // Middle third — single click toggles footer, double click toggles fullscreen\n        const now = Date.now();\n        const timeSinceLastTap = now - lastMiddleTapRef.current;\n        lastMiddleTapRef.current = now;\n\n        if (timeSinceLastTap < 300) {\n          if (middleTapTimerRef.current)\n            clearTimeout(middleTapTimerRef.current);\n          toggleFullscreen();\n        } else {\n          if (middleTapTimerRef.current)\n            clearTimeout(middleTapTimerRef.current);\n          middleTapTimerRef.current = setTimeout(() => {\n            if (footerVisible) {\n              setFooterVisible(false);\n              if (footerTimerRef.current) clearTimeout(footerTimerRef.current);\n            } else {\n              showFooterTemporarily();\n            }\n          }, 300);\n        }\n      }\n    },\n    [\n      goNext,\n      goPrev,\n      footerVisible,\n      isTouchDevice,\n      settingsOpen,\n      tocOpen,\n      showFooterTemporarily,\n      toggleFullscreen,\n    ]\n  );\n\n  // Hover zone tracking for desktop navigation hints\n  const [hoverZone, setHoverZone] = useState<\"left\" | \"right\" | null>(null);\n\n  const handleMouseMove = useCallback(\n    (e: MouseEvent) => {\n      const container = containerRef.current;\n      if (!container) return;\n\n      const rect = container.getBoundingClientRect();\n      const x = e.clientX - rect.left;\n      const y = e.clientY - rect.top;\n      const third = rect.width / 3;\n\n      if (x < third) {\n        setHoverZone(\"left\");\n      } else if (x > third * 2) {\n        setHoverZone(\"right\");\n      } else {\n        setHoverZone(null);\n      }\n\n      // Show footer when mouse is in the bottom quarter\n      if (y > rect.height * 0.75) {\n        setFooterVisible(true);\n        if (footerTimerRef.current) clearTimeout(footerTimerRef.current);\n      } else if (!settingsOpen && !tocOpen) {\n        // Hide after a short delay when leaving the bottom area (not when panels are open)\n        if (footerTimerRef.current) clearTimeout(footerTimerRef.current);\n        footerTimerRef.current = setTimeout(() => setFooterVisible(false), 600);\n      }\n    },\n    [settingsOpen, tocOpen]\n  );\n\n  const handleMouseLeave = useCallback(() => {\n    setHoverZone(null);\n    if (!settingsOpen && !tocOpen) {\n      if (footerTimerRef.current) clearTimeout(footerTimerRef.current);\n      footerTimerRef.current = setTimeout(() => setFooterVisible(false), 600);\n    }\n  }, [settingsOpen, tocOpen]);\n\n  // Keyboard navigation\n  useEffect(() => {\n    const handleKeyDown = (e: KeyboardEvent) => {\n      // Don't intercept if user is in an input/textarea\n      const tag = (e.target as HTMLElement).tagName;\n      if (tag === \"INPUT\" || tag === \"TEXTAREA\" || tag === \"SELECT\") return;\n\n      if (e.key === \"ArrowRight\" || e.key === \" \") {\n        e.preventDefault();\n        goNext();\n      } else if (e.key === \"ArrowLeft\") {\n        e.preventDefault();\n        goPrev();\n      } else if (e.key === \"Home\") {\n        e.preventDefault();\n        goToPage(0);\n      } else if (e.key === \"End\") {\n        e.preventDefault();\n        goToPage(totalPages - 1);\n      }\n    };\n\n    window.addEventListener(\"keydown\", handleKeyDown);\n    return () => window.removeEventListener(\"keydown\", handleKeyDown);\n  }, [goNext, goPrev, goToPage, totalPages]);\n\n  // Touch swipe navigation with drag tracking, velocity detection, and rubber-band.\n  // Listeners attach to the outer container (not the viewport) so they capture\n  // touches that land on sibling elements like the tap-zone overlays.\n  useEffect(() => {\n    const container = containerRef.current;\n    if (!container) return;\n\n    const onTouchStart = (e: TouchEvent) => {\n      const touch = e.touches[0];\n      touchStartXRef.current = touch.clientX;\n      touchStartYRef.current = touch.clientY;\n      lastTouchXRef.current = touch.clientX;\n      lastTouchTimeRef.current = performance.now();\n      velocityRef.current = 0;\n      isSwipingRef.current = false;\n      isDraggingRef.current = false;\n    };\n\n    const onTouchMove = (e: TouchEvent) => {\n      const touch = e.touches[0];\n      const dx = touch.clientX - touchStartXRef.current;\n      const dy = touch.clientY - touchStartYRef.current;\n\n      // Lock direction after initial movement\n      if (!isSwipingRef.current) {\n        if (Math.abs(dx) > Math.abs(dy) && Math.abs(dx) > 10) {\n          isSwipingRef.current = true;\n        } else if (Math.abs(dy) > Math.abs(dx) && Math.abs(dy) > 10) {\n          // Vertical scroll — not our concern\n          return;\n        } else {\n          return; // Not enough movement yet\n        }\n      }\n\n      e.preventDefault();\n\n      // Track velocity (px per ms) using last touch position\n      const now = performance.now();\n      const timeDelta = now - lastTouchTimeRef.current;\n      if (timeDelta > 0) {\n        const instantVelocity =\n          (touch.clientX - lastTouchXRef.current) / timeDelta;\n        // Smooth velocity with exponential moving average\n        velocityRef.current = 0.6 * instantVelocity + 0.4 * velocityRef.current;\n      }\n      lastTouchXRef.current = touch.clientX;\n      lastTouchTimeRef.current = now;\n\n      // Determine drag offset with rubber-band resistance at boundaries\n      let offset = dx;\n      const atStart = currentPage === 0;\n      const atEnd = currentPage >= totalPages - 1;\n\n      if ((atStart && dx > 0) || (atEnd && dx < 0)) {\n        // Rubber-band: diminishing resistance using square root curve\n        // This gives a natural iOS-like rubber-band feel\n        const sign = dx > 0 ? 1 : -1;\n        const absDx = Math.abs(dx);\n        offset = sign * Math.sqrt(absDx) * 5;\n\n        // Show chapter hint when overscrolling past boundary\n        if (dx > 40 && atStart && effectivePrevChapter) {\n          setChapterHint(\"prev\");\n        } else if (dx < -40 && atEnd && effectiveNextChapter) {\n          setChapterHint(\"next\");\n        } else {\n          setChapterHint(null);\n        }\n      } else {\n        setChapterHint(null);\n      }\n\n      isDraggingRef.current = true;\n      setIsDragging(true);\n      setDragOffset(offset);\n    };\n\n    const onTouchEnd = (e: TouchEvent) => {\n      if (!isSwipingRef.current || !isDraggingRef.current) {\n        setIsDragging(false);\n        setDragOffset(0);\n        setChapterHint(null);\n        return;\n      }\n\n      const dx = e.changedTouches[0].clientX - touchStartXRef.current;\n      const velocity = velocityRef.current; // px/ms\n      const distanceThreshold = 50;\n      const velocityThreshold = 0.3; // px/ms — a fast flick\n      const chapterThreshold = 80;\n\n      const atStart = currentPage === 0;\n      const atEnd = currentPage >= totalPages - 1;\n\n      // Chapter navigation on overscroll\n      if (atEnd && dx < -chapterThreshold && effectiveNextChapter) {\n        setIsDragging(false);\n        setDragOffset(0);\n        setChapterHint(null);\n        window.location.href = effectiveNextChapter.slug;\n        return;\n      }\n      if (atStart && dx > chapterThreshold && effectivePrevChapter) {\n        setIsDragging(false);\n        setDragOffset(0);\n        setChapterHint(null);\n        window.location.href = effectivePrevChapter.slug;\n        return;\n      }\n\n      // Determine page change: distance OR velocity triggers a turn\n      if (dx < -distanceThreshold || velocity < -velocityThreshold) {\n        goNext();\n      } else if (dx > distanceThreshold || velocity > velocityThreshold) {\n        goPrev();\n      }\n\n      // Reset drag state — the CSS transition handles the snap animation\n      isDraggingRef.current = false;\n      setIsDragging(false);\n      setDragOffset(0);\n      setChapterHint(null);\n    };\n\n    // Cancel drag if touch is interrupted\n    const onTouchCancel = () => {\n      isDraggingRef.current = false;\n      setIsDragging(false);\n      setDragOffset(0);\n      setChapterHint(null);\n    };\n\n    container.addEventListener(\"touchstart\", onTouchStart, { passive: true });\n    container.addEventListener(\"touchmove\", onTouchMove, { passive: false });\n    container.addEventListener(\"touchend\", onTouchEnd, { passive: true });\n    container.addEventListener(\"touchcancel\", onTouchCancel, { passive: true });\n\n    return () => {\n      container.removeEventListener(\"touchstart\", onTouchStart);\n      container.removeEventListener(\"touchmove\", onTouchMove);\n      container.removeEventListener(\"touchend\", onTouchEnd);\n      container.removeEventListener(\"touchcancel\", onTouchCancel);\n    };\n  }, [\n    currentPage,\n    totalPages,\n    goNext,\n    goPrev,\n    effectiveNextChapter,\n    effectivePrevChapter,\n  ]);\n\n  // Compute per-chapter page indicator values\n  const chapterPageInfo = (() => {\n    if (!isMultiChapter || chapterRanges.length === 0) {\n      return { chapterPage: currentPage, chapterTotalPages: totalPages };\n    }\n    const activeRange = chapterRanges.find((r) => r.slug === activeChapterSlug);\n    if (!activeRange) {\n      return { chapterPage: currentPage, chapterTotalPages: totalPages };\n    }\n    return {\n      chapterPage: currentPage - activeRange.startPage,\n      chapterTotalPages: activeRange.endPage - activeRange.startPage + 1,\n    };\n  })();\n\n  // Book progress: position in the entire book based on word counts.\n  // Maps currentPage/totalPages (across all loaded content) through\n  // word counts to estimate absolute position in the full book.\n  const progressPercent = (() => {\n    if (!allChapters || allChapters.length === 0) {\n      return totalPages > 1 ? (currentPage / (totalPages - 1)) * 100 : 100;\n    }\n\n    const totalWords = allChapters.reduce(\n      (sum, ch) => sum + (ch.wordCount || 0),\n      0\n    );\n    if (totalWords === 0) return 0;\n\n    const firstLoadedSlug = loadedChapters[0]?.slug || activeChapterSlug;\n    let wordsBeforeLoaded = 0;\n    let loadedWords = 0;\n    let foundFirst = false;\n\n    for (const ch of allChapters) {\n      if (ch.slug === firstLoadedSlug) foundFirst = true;\n      if (!foundFirst) {\n        wordsBeforeLoaded += ch.wordCount || 0;\n      } else if (loadedChapters.some((lc) => lc.slug === ch.slug)) {\n        loadedWords += ch.wordCount || 0;\n      } else {\n        break;\n      }\n    }\n\n    const pageFraction = totalPages > 1 ? currentPage / (totalPages - 1) : 0;\n    const wordsInto = wordsBeforeLoaded + pageFraction * loadedWords;\n\n    return Math.min(100, (wordsInto / totalWords) * 100);\n  })();\n\n  // Render content — either multi-chapter sections or single-chapter children\n  const renderContent = () => {\n    if (isMultiChapter && loadedChapters.length > 0) {\n      return loadedChapters.map((ch) => (\n        <section\n          key={ch.slug}\n          class=\"pressy-chapter-section\"\n          data-chapter-slug={ch.slug}\n        >\n          <ChapterDivider title={ch.title} />\n          <ch.Content components={mdxComponents || {}} />\n        </section>\n      ));\n    }\n    return children;\n  };\n\n  return (\n    <div\n      class=\"pressy-reader pressy-reader--paginated\"\n      ref={containerRef}\n      onClick={handleContainerClick}\n      onMouseMove={handleMouseMove}\n      onMouseLeave={handleMouseLeave}\n    >\n      {/* Paginated content viewport */}\n      <div class=\"pressy-paginated-viewport\" ref={viewportRef}>\n        <article\n          ref={articleRef}\n          class={`pressy-prose pressy-prose--paginated ${\n            showDropCap ? \"\" : \"no-drop-cap\"\n          }`}\n          data-drop-cap={showDropCap}\n        >\n          {renderContent()}\n        </article>\n      </div>\n\n      {/* Navigation arrows — appear on hover in left/right thirds */}\n      <div\n        class={`pressy-nav-arrow pressy-nav-arrow--prev ${\n          hoverZone === \"left\" ? \"pressy-nav-arrow--visible\" : \"\"\n        }`}\n      >\n        <svg\n          viewBox=\"0 0 24 24\"\n          fill=\"none\"\n          stroke=\"currentColor\"\n          stroke-width=\"2\"\n          stroke-linecap=\"round\"\n          stroke-linejoin=\"round\"\n        >\n          <polyline points=\"15 18 9 12 15 6\" />\n        </svg>\n      </div>\n      <div\n        class={`pressy-nav-arrow pressy-nav-arrow--next ${\n          hoverZone === \"right\" ? \"pressy-nav-arrow--visible\" : \"\"\n        }`}\n      >\n        <svg\n          viewBox=\"0 0 24 24\"\n          fill=\"none\"\n          stroke=\"currentColor\"\n          stroke-width=\"2\"\n          stroke-linecap=\"round\"\n          stroke-linejoin=\"round\"\n        >\n          <polyline points=\"9 6 15 12 9 18\" />\n        </svg>\n      </div>\n\n      {/* Chapter boundary hints */}\n      {chapterHint === \"prev\" && effectivePrevChapter && (\n        <div\n          class=\"pressy-chapter-hint pressy-chapter-hint--prev\"\n          aria-live=\"polite\"\n        >\n          <span class=\"pressy-chapter-hint-arrow\">{\"\\u2190\"}</span>\n          <span class=\"pressy-chapter-hint-text\">\n            {effectivePrevChapter.title}\n          </span>\n        </div>\n      )}\n      {chapterHint === \"next\" && effectiveNextChapter && (\n        <div\n          class=\"pressy-chapter-hint pressy-chapter-hint--next\"\n          aria-live=\"polite\"\n        >\n          <span class=\"pressy-chapter-hint-text\">\n            {effectiveNextChapter.title}\n          </span>\n          <span class=\"pressy-chapter-hint-arrow\">{\"\\u2192\"}</span>\n        </div>\n      )}\n\n      {/* TOC drawer overlay */}\n      {tocOpen && allChapters && (\n        <div\n          class=\"pressy-toc-backdrop\"\n          onClick={(e: MouseEvent) => {\n            e.stopPropagation();\n            setTocOpen(false);\n          }}\n        >\n          <div\n            class=\"pressy-toc-drawer\"\n            onClick={(e: MouseEvent) => e.stopPropagation()}\n          >\n            <div class=\"pressy-toc-header\">\n              <span class=\"pressy-toc-title\">Contents</span>\n              <button\n                class=\"pressy-toc-close\"\n                onClick={(e: MouseEvent) => {\n                  e.stopPropagation();\n                  setTocOpen(false);\n                }}\n                aria-label=\"Close table of contents\"\n              >\n                <svg\n                  viewBox=\"0 0 24 24\"\n                  fill=\"none\"\n                  stroke=\"currentColor\"\n                  stroke-width=\"2\"\n                  width=\"18\"\n                  height=\"18\"\n                >\n                  <line x1=\"18\" y1=\"6\" x2=\"6\" y2=\"18\" />\n                  <line x1=\"6\" y1=\"6\" x2=\"18\" y2=\"18\" />\n                </svg>\n              </button>\n            </div>\n            <nav class=\"pressy-toc-list\">\n              <a\n                href={bookBasePath ? bookBasePath.replace(/\\/books\\/[^/]+$/, '') || '/' : '/'}\n                class=\"pressy-toc-item pressy-toc-item--home\"\n                onClick={() => setTocOpen(false)}\n              >\n                <span class=\"pressy-toc-item-num\">\n                  <svg viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" width=\"14\" height=\"14\">\n                    <path d=\"M3 9.5L12 3l9 6.5V20a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V9.5z\" />\n                  </svg>\n                </span>\n                <span class=\"pressy-toc-item-title\">{bookTitle || 'Home'}</span>\n              </a>\n              {allChapters.map((ch, i) => (\n                <a\n                  key={ch.slug}\n                  href={`${bookBasePath || \"\"}/${ch.slug}`}\n                  class={`pressy-toc-item ${\n                    ch.slug === (activeChapterSlug || currentChapterSlug)\n                      ? \"pressy-toc-item--active\"\n                      : \"\"\n                  }`}\n                  onClick={() => setTocOpen(false)}\n                >\n                  <span class=\"pressy-toc-item-num\">{i + 1}.</span>\n                  <span class=\"pressy-toc-item-title\">{ch.title}</span>\n                </a>\n              ))}\n            </nav>\n          </div>\n        </div>\n      )}\n\n      {/* Page footer with progress — hidden by default */}\n      <div\n        class={`pressy-page-footer ${\n          footerVisible || settingsOpen || tocOpen\n            ? \"pressy-page-footer--visible\"\n            : \"\"\n        }`}\n      >\n        <div class=\"pressy-progress-bar\">\n          <div\n            class=\"pressy-progress-fill\"\n            style={{ width: `${progressPercent}%` }}\n          />\n        </div>\n        <div class=\"pressy-footer-row\">\n          {allChapters && allChapters.length > 0 && (\n            <button\n              class=\"pressy-toc-toggle\"\n              onClick={(e: MouseEvent) => {\n                e.stopPropagation();\n                setSettingsOpen(false);\n                setTocOpen(!tocOpen);\n              }}\n              aria-label=\"Table of contents\"\n            >\n              <svg\n                viewBox=\"0 0 24 24\"\n                fill=\"none\"\n                stroke=\"currentColor\"\n                stroke-width=\"1.5\"\n                stroke-linecap=\"round\"\n                stroke-linejoin=\"round\"\n                width=\"18\"\n                height=\"18\"\n              >\n                <line x1=\"3\" y1=\"6\" x2=\"21\" y2=\"6\" />\n                <line x1=\"3\" y1=\"12\" x2=\"21\" y2=\"12\" />\n                <line x1=\"3\" y1=\"18\" x2=\"21\" y2=\"18\" />\n              </svg>\n            </button>\n          )}\n          {bookTitle && (\n            <button\n              class=\"pressy-footer-title\"\n              onClick={(e: MouseEvent) => {\n                e.stopPropagation();\n                if (allChapters && allChapters.length > 0) {\n                  setSettingsOpen(false);\n                  setTocOpen(!tocOpen);\n                }\n              }}\n            >\n              {bookTitle}\n            </button>\n          )}\n          <OfflineFooterIcon offlineProps={offlineProps} />\n          <button\n            class=\"pressy-settings-toggle\"\n            onClick={(e: MouseEvent) => {\n              e.stopPropagation();\n              setTocOpen(false);\n              setSettingsOpen(!settingsOpen);\n            }}\n            aria-label=\"Settings\"\n          >\n            <svg\n              viewBox=\"0 0 24 24\"\n              fill=\"none\"\n              stroke=\"currentColor\"\n              stroke-width=\"1.5\"\n              stroke-linecap=\"round\"\n              stroke-linejoin=\"round\"\n              width=\"18\"\n              height=\"18\"\n            >\n              <circle cx=\"12\" cy=\"12\" r=\"3\" />\n              <path d=\"M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z\" />\n            </svg>\n          </button>\n        </div>\n\n        {/* Settings panel */}\n        <div\n          class={`pressy-settings-panel ${\n            settingsOpen ? \"pressy-settings-panel--open\" : \"\"\n          }`}\n        >\n          <div class=\"pressy-settings-section\">\n            <div class=\"pressy-settings-label\">Theme</div>\n            <div class=\"pressy-theme-options\">\n              {(\n                [\n                  {\n                    id: \"light\",\n                    label: \"Light\",\n                    icon: (\n                      <svg\n                        viewBox=\"0 0 24 24\"\n                        fill=\"none\"\n                        stroke=\"currentColor\"\n                        stroke-width=\"1.5\"\n                        width=\"16\"\n                        height=\"16\"\n                      >\n                        <circle cx=\"12\" cy=\"12\" r=\"5\" />\n                        <line x1=\"12\" y1=\"1\" x2=\"12\" y2=\"3\" />\n                        <line x1=\"12\" y1=\"21\" x2=\"12\" y2=\"23\" />\n                        <line x1=\"4.22\" y1=\"4.22\" x2=\"5.64\" y2=\"5.64\" />\n                        <line x1=\"18.36\" y1=\"18.36\" x2=\"19.78\" y2=\"19.78\" />\n                        <line x1=\"1\" y1=\"12\" x2=\"3\" y2=\"12\" />\n                        <line x1=\"21\" y1=\"12\" x2=\"23\" y2=\"12\" />\n                        <line x1=\"4.22\" y1=\"19.78\" x2=\"5.64\" y2=\"18.36\" />\n                        <line x1=\"18.36\" y1=\"5.64\" x2=\"19.78\" y2=\"4.22\" />\n                      </svg>\n                    ),\n                  },\n                  {\n                    id: \"dark\",\n                    label: \"Dark\",\n                    icon: (\n                      <svg\n                        viewBox=\"0 0 24 24\"\n                        fill=\"none\"\n                        stroke=\"currentColor\"\n                        stroke-width=\"1.5\"\n                        width=\"16\"\n                        height=\"16\"\n                      >\n                        <path d=\"M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z\" />\n                      </svg>\n                    ),\n                  },\n                  {\n                    id: \"system\",\n                    label: \"System\",\n                    icon: (\n                      <svg\n                        viewBox=\"0 0 24 24\"\n                        fill=\"none\"\n                        stroke=\"currentColor\"\n                        stroke-width=\"1.5\"\n                        width=\"16\"\n                        height=\"16\"\n                      >\n                        <rect\n                          x=\"2\"\n                          y=\"3\"\n                          width=\"20\"\n                          height=\"14\"\n                          rx=\"2\"\n                          ry=\"2\"\n                        />\n                        <line x1=\"8\" y1=\"21\" x2=\"16\" y2=\"21\" />\n                        <line x1=\"12\" y1=\"17\" x2=\"12\" y2=\"21\" />\n                      </svg>\n                    ),\n                  },\n                  {\n                    id: \"sepia\",\n                    label: \"Sepia\",\n                    icon: (\n                      <svg\n                        viewBox=\"0 0 24 24\"\n                        fill=\"none\"\n                        stroke=\"currentColor\"\n                        stroke-width=\"1.5\"\n                        width=\"16\"\n                        height=\"16\"\n                      >\n                        <path d=\"M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z\" />\n                        <path d=\"M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z\" />\n                      </svg>\n                    ),\n                  },\n                ] as const\n              ).map((t) => (\n                <button\n                  key={t.id}\n                  class={`pressy-theme-btn ${\n                    activeTheme === t.id ? \"pressy-theme-btn--active\" : \"\"\n                  }`}\n                  onClick={(e: MouseEvent) => {\n                    e.stopPropagation();\n                    handleThemeChange(t.id);\n                  }}\n                >\n                  {t.icon}\n                  <span>{t.label}</span>\n                </button>\n              ))}\n            </div>\n          </div>\n          <div class=\"pressy-settings-section\">\n            <div class=\"pressy-settings-label\">Font Size</div>\n            <div class=\"pressy-font-size-controls\">\n              <button\n                class=\"pressy-font-size-btn\"\n                onClick={(e: MouseEvent) => {\n                  e.stopPropagation();\n                  handleFontSizeChange(-0.1);\n                }}\n                disabled={fontScale <= 0.8}\n                aria-label=\"Decrease font size\"\n              >\n                A-\n              </button>\n              <span class=\"pressy-font-size-value\">\n                {Math.round(fontScale * 100)}%\n              </span>\n              <button\n                class=\"pressy-font-size-btn\"\n                onClick={(e: MouseEvent) => {\n                  e.stopPropagation();\n                  handleFontSizeChange(0.1);\n                }}\n                disabled={fontScale >= 1.5}\n                aria-label=\"Increase font size\"\n              >\n                A+\n              </button>\n            </div>\n          </div>\n        </div>\n      </div>\n\n      <TextShare />\n      <OfflineIndicator />\n\n      <style>{PAGINATED_STYLES}</style>\n    </div>\n  );\n}\n\n// ── Styles ────────────────────────────────────────────────────\n\nconst SCROLL_STYLES = `\n  .pressy-reader {\n    min-height: 100vh;\n    display: flex;\n    flex-direction: column;\n  }\n\n  .pressy-reader-main {\n    flex: 1;\n    padding: 2rem 0;\n  }\n\n  /* ── Scroll reader footer ──────────────────────────────── */\n  .pressy-page-footer--scroll {\n    position: fixed;\n    bottom: 0;\n    left: 0;\n    right: 0;\n    padding: 0.5rem 1.5rem 1rem;\n    text-align: center;\n    user-select: none;\n    transform: translateY(100%);\n    opacity: 0;\n    transition: transform 0.25s ease, opacity 0.25s ease;\n    z-index: 15;\n    background: var(--color-bg, #ffffff);\n    box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.05);\n  }\n\n  .pressy-page-footer--scroll.pressy-page-footer--visible {\n    transform: translateY(0);\n    opacity: 1;\n  }\n\n  /* Shared footer styles for scroll reader */\n  .pressy-page-footer--scroll .pressy-footer-row {\n    display: flex;\n    align-items: center;\n    justify-content: space-between;\n    gap: 0.5rem;\n  }\n\n  .pressy-page-footer--scroll .pressy-footer-title {\n    font-family: var(--font-heading, system-ui, -apple-system, sans-serif);\n    font-size: 0.75rem;\n    color: var(--color-text-muted, #6c757d);\n    text-decoration: none;\n    overflow: hidden;\n    text-overflow: ellipsis;\n    white-space: nowrap;\n    min-width: 0;\n    flex: 1;\n    text-align: left;\n    border: none;\n    background: none;\n    cursor: pointer;\n    padding: 0;\n  }\n\n  .pressy-page-footer--scroll .pressy-footer-title:hover {\n    color: var(--color-text, #212529);\n  }\n\n  .pressy-page-footer--scroll .pressy-toc-toggle,\n  .pressy-page-footer--scroll .pressy-settings-toggle {\n    flex-shrink: 0;\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    width: 2rem;\n    height: 2rem;\n    border: none;\n    background: transparent;\n    color: var(--color-text-muted, #6c757d);\n    cursor: pointer;\n    border-radius: 0.375rem;\n    transition: color 0.15s, background 0.15s;\n    padding: 0;\n  }\n\n  .pressy-page-footer--scroll .pressy-toc-toggle:hover,\n  .pressy-page-footer--scroll .pressy-settings-toggle:hover {\n    color: var(--color-text, #212529);\n    background: var(--color-bg-subtle, #f8f9fa);\n  }\n\n  .pressy-page-footer--scroll .pressy-settings-panel {\n    overflow: hidden;\n    max-height: 0;\n    opacity: 0;\n    transition: max-height 0.25s ease, opacity 0.2s ease;\n    border-top: 0 solid var(--color-border, #dee2e6);\n  }\n\n  .pressy-page-footer--scroll .pressy-settings-panel--open {\n    max-height: 300px;\n    opacity: 1;\n    border-top-width: 1px;\n    margin-top: 0.5rem;\n    padding-top: 0.75rem;\n  }\n\n  .pressy-page-footer--scroll .pressy-settings-section {\n    margin-bottom: 0.75rem;\n  }\n\n  .pressy-page-footer--scroll .pressy-settings-section:last-child {\n    margin-bottom: 0;\n  }\n\n  .pressy-page-footer--scroll .pressy-settings-label {\n    font-family: var(--font-heading, system-ui, -apple-system, sans-serif);\n    font-size: 0.6875rem;\n    font-weight: 600;\n    text-transform: uppercase;\n    letter-spacing: 0.05em;\n    color: var(--color-text-muted, #6c757d);\n    margin-bottom: 0.5rem;\n    text-align: left;\n  }\n\n  .pressy-page-footer--scroll .pressy-theme-options {\n    display: flex;\n    gap: 0.375rem;\n  }\n\n  .pressy-page-footer--scroll .pressy-theme-btn {\n    flex: 1;\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    gap: 0.25rem;\n    padding: 0.375rem 0.5rem;\n    border: 1.5px solid var(--color-border, #dee2e6);\n    border-radius: 0.5rem;\n    background: transparent;\n    color: var(--color-text, #212529);\n    font-family: var(--font-heading, system-ui, -apple-system, sans-serif);\n    font-size: 0.6875rem;\n    cursor: pointer;\n    transition: border-color 0.15s, background 0.15s;\n  }\n\n  .pressy-page-footer--scroll .pressy-theme-btn:hover {\n    background: var(--color-bg-subtle, #f8f9fa);\n  }\n\n  .pressy-page-footer--scroll .pressy-theme-btn--active {\n    border-color: var(--color-accent, #212529);\n    background: var(--color-bg-subtle, #f8f9fa);\n    font-weight: 600;\n  }\n\n  .pressy-page-footer--scroll .pressy-font-size-controls {\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    gap: 1rem;\n  }\n\n  .pressy-page-footer--scroll .pressy-font-size-btn {\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    width: 2rem;\n    height: 2rem;\n    border: 1.5px solid var(--color-border, #dee2e6);\n    border-radius: 50%;\n    background: transparent;\n    color: var(--color-text, #212529);\n    font-family: var(--font-heading, system-ui, -apple-system, sans-serif);\n    font-size: 0.75rem;\n    font-weight: 600;\n    cursor: pointer;\n    transition: border-color 0.15s, background 0.15s;\n  }\n\n  .pressy-page-footer--scroll .pressy-font-size-btn:hover:not(:disabled) {\n    background: var(--color-bg-subtle, #f8f9fa);\n    border-color: var(--color-accent, #212529);\n  }\n\n  .pressy-page-footer--scroll .pressy-font-size-btn:disabled {\n    opacity: 0.3;\n    cursor: default;\n  }\n\n  .pressy-page-footer--scroll .pressy-font-size-value {\n    font-family: var(--font-heading, system-ui, -apple-system, sans-serif);\n    font-size: 0.8125rem;\n    font-weight: 500;\n    color: var(--color-text, #212529);\n    min-width: 3ch;\n    text-align: center;\n  }\n\n  /* ── TOC drawer for scroll reader ───────────────────────── */\n  .pressy-toc-backdrop--scroll {\n    position: fixed;\n    inset: 0;\n    background: rgba(0, 0, 0, 0.3);\n    z-index: 20;\n    display: flex;\n    align-items: flex-end;\n    animation: pressy-scroll-toc-fade-in 0.2s ease-out;\n  }\n\n  .pressy-toc-backdrop--scroll .pressy-toc-drawer {\n    width: 100%;\n    max-height: 70vh;\n    background: var(--color-bg, #ffffff);\n    border-radius: 1rem 1rem 0 0;\n    display: flex;\n    flex-direction: column;\n    animation: pressy-scroll-toc-slide-up 0.25s ease-out;\n    box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.1);\n  }\n\n  .pressy-toc-backdrop--scroll .pressy-toc-header {\n    display: flex;\n    align-items: center;\n    justify-content: space-between;\n    padding: 1rem 1.5rem 0.75rem;\n    border-bottom: 1px solid var(--color-border, #dee2e6);\n    flex-shrink: 0;\n  }\n\n  .pressy-toc-backdrop--scroll .pressy-toc-title {\n    font-family: var(--font-heading, system-ui, -apple-system, sans-serif);\n    font-size: 1rem;\n    font-weight: 600;\n    color: var(--color-text, #212529);\n  }\n\n  .pressy-toc-backdrop--scroll .pressy-toc-close {\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    width: 2rem;\n    height: 2rem;\n    border: none;\n    background: transparent;\n    color: var(--color-text-muted, #6c757d);\n    cursor: pointer;\n    border-radius: 0.375rem;\n    padding: 0;\n  }\n\n  .pressy-toc-backdrop--scroll .pressy-toc-close:hover {\n    color: var(--color-text, #212529);\n    background: var(--color-bg-subtle, #f8f9fa);\n  }\n\n  .pressy-toc-backdrop--scroll .pressy-toc-list {\n    overflow-y: auto;\n    padding: 0.5rem;\n    display: flex;\n    flex-direction: column;\n  }\n\n  .pressy-toc-backdrop--scroll .pressy-toc-item {\n    display: flex;\n    gap: 0.75rem;\n    padding: 0.625rem 1rem;\n    text-decoration: none;\n    color: var(--color-text, #212529);\n    border-radius: 0.5rem;\n    font-family: var(--font-heading, system-ui, -apple-system, sans-serif);\n    font-size: 0.875rem;\n    transition: background 0.15s;\n  }\n\n  .pressy-toc-backdrop--scroll .pressy-toc-item:hover {\n    background: var(--color-bg-subtle, #f5f5f5);\n  }\n\n  .pressy-toc-backdrop--scroll .pressy-toc-item--active {\n    background: var(--color-bg-subtle, #f5f5f5);\n    font-weight: 600;\n  }\n\n  .pressy-toc-backdrop--scroll .pressy-toc-item-num {\n    color: var(--color-text-muted, #6c757d);\n    min-width: 2ch;\n    text-align: right;\n  }\n\n  .pressy-toc-backdrop--scroll .pressy-toc-item--home {\n    border-bottom: 1px solid var(--color-border, #e5e5e5);\n    margin-bottom: 0.25rem;\n    padding-bottom: 0.75rem;\n  }\n\n  .pressy-toc-backdrop--scroll .pressy-toc-item--home .pressy-toc-item-num {\n    display: flex;\n    align-items: center;\n    justify-content: center;\n  }\n\n  .pressy-toc-backdrop--scroll .pressy-toc-item-title {\n    flex: 1;\n    min-width: 0;\n  }\n\n  @keyframes pressy-scroll-toc-fade-in {\n    from { opacity: 0; }\n    to { opacity: 1; }\n  }\n\n  @keyframes pressy-scroll-toc-slide-up {\n    from { transform: translateY(100%); }\n    to { transform: translateY(0); }\n  }\n\n  /* ── Offline icon for scroll reader ─────────────────────── */\n  .pressy-page-footer--scroll .pressy-offline-icon {\n    flex-shrink: 0;\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    position: relative;\n    width: 2rem;\n    height: 2rem;\n    border: none;\n    background: transparent;\n    color: var(--color-text-muted, #6c757d);\n    cursor: pointer;\n    border-radius: 0.375rem;\n    transition: color 0.15s, background 0.15s;\n    padding: 0;\n  }\n\n  .pressy-page-footer--scroll .pressy-offline-icon:hover {\n    color: var(--color-text, #212529);\n    background: var(--color-bg-subtle, #f8f9fa);\n  }\n\n  .pressy-page-footer--scroll .pressy-offline-icon--cached {\n    color: #16a34a;\n  }\n\n  .pressy-page-footer--scroll .pressy-offline-icon--cached:hover {\n    color: #dc2626;\n  }\n\n  .pressy-page-footer--scroll .pressy-offline-check {\n    position: absolute;\n    bottom: 2px;\n    right: 2px;\n  }\n\n  .pressy-page-footer--scroll .pressy-offline-icon--downloading {\n    cursor: default;\n  }\n\n  @media (prefers-reduced-motion: reduce) {\n    .pressy-page-footer--scroll {\n      transition: none;\n    }\n    .pressy-toc-backdrop--scroll,\n    .pressy-toc-backdrop--scroll .pressy-toc-drawer {\n      animation: none;\n    }\n  }\n`;\n\nconst PAGINATED_STYLES = `\n  html:has(.pressy-reader--paginated) body {\n    margin: 0;\n  }\n\n  .pressy-reader--paginated {\n    height: 100vh;\n    height: 100dvh;\n    display: flex;\n    flex-direction: column;\n    overflow: hidden;\n    position: relative;\n  }\n\n  /* Viewport clips overflow and shows one page at a time.\n     Vertical padding gives consistent top/bottom margins on every page. */\n  .pressy-paginated-viewport {\n    flex: 1;\n    overflow: hidden;\n    position: relative;\n    min-height: 0;\n    padding-block: 2rem;\n    box-sizing: border-box;\n    text-wrap: pretty;\n  }\n\n  /* Article uses CSS multi-column layout for pagination.\n     column-width is set dynamically via JS to match viewport width.\n     Each column = one \"page\". Content overflows horizontally into new columns.\n     translateX controlled by JS — transitions set dynamically during drag vs snap. */\n  .pressy-prose--paginated {\n    max-width: none;\n    height: 100%;\n    column-fill: auto;\n    column-gap: 0;\n    overflow: visible;\n    box-sizing: border-box;\n    padding: 0;\n    will-change: transform;\n    /* Transition is set dynamically: none during drag, ease-out on snap */\n  }\n\n  /* Center content elements within each column/page at a readable width */\n  .pressy-prose--paginated > * {\n    max-width: min(65ch, calc(100% - 3rem));\n    margin-left: auto;\n    margin-right: auto;\n  }\n\n  /* Preserve vertical margins from prose styles */\n  .pressy-prose--paginated > h1,\n  .pressy-prose--paginated > h2,\n  .pressy-prose--paginated > h3,\n  .pressy-prose--paginated > h4 {\n    max-width: min(65ch, calc(100% - 3rem));\n    margin-left: auto;\n    margin-right: auto;\n  }\n\n  /* ── Navigation arrows ────────────────────────────────────── */\n  /* Hover-triggered arrows on left/right edges for desktop navigation */\n  .pressy-nav-arrow {\n    position: absolute;\n    top: 50%;\n    transform: translateY(-50%);\n    width: 2.5rem;\n    height: 2.5rem;\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    color: var(--color-text-muted, #6c757d);\n    opacity: 0;\n    transition: opacity 0.2s ease;\n    pointer-events: none;\n    z-index: 5;\n  }\n\n  .pressy-nav-arrow svg {\n    width: 1.5rem;\n    height: 1.5rem;\n  }\n\n  .pressy-nav-arrow--prev {\n    left: 0.75rem;\n  }\n\n  .pressy-nav-arrow--next {\n    right: 0.75rem;\n  }\n\n  .pressy-nav-arrow--visible {\n    opacity: 0.4;\n  }\n\n  /* Hide on touch devices — swipe handles navigation there */\n  @media (hover: none) {\n    .pressy-nav-arrow {\n      display: none;\n    }\n  }\n\n  /* ── Chapter boundary hints ─────────────────────────────── */\n  /* Shown when overscrolling past first/last page of a chapter */\n  .pressy-chapter-hint {\n    position: absolute;\n    top: 50%;\n    transform: translateY(-50%);\n    display: flex;\n    align-items: center;\n    gap: 0.5rem;\n    padding: 0.75rem 1.25rem;\n    background: var(--color-bg-subtle, #f5f5f5);\n    border: 1px solid var(--color-border, #dee2e6);\n    border-radius: 0.75rem;\n    font-family: var(--font-heading, system-ui, -apple-system, sans-serif);\n    font-size: var(--font-size-sm, 0.875rem);\n    color: var(--color-text-muted, #6c757d);\n    z-index: 20;\n    pointer-events: none;\n    animation: pressy-hint-fade-in 0.15s ease-out;\n    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);\n    max-width: 60%;\n    white-space: nowrap;\n    overflow: hidden;\n    text-overflow: ellipsis;\n  }\n\n  .pressy-chapter-hint--prev {\n    left: 1rem;\n  }\n\n  .pressy-chapter-hint--next {\n    right: 1rem;\n  }\n\n  .pressy-chapter-hint-arrow {\n    flex-shrink: 0;\n    font-size: 1rem;\n    opacity: 0.6;\n  }\n\n  .pressy-chapter-hint-text {\n    overflow: hidden;\n    text-overflow: ellipsis;\n  }\n\n  @keyframes pressy-hint-fade-in {\n    from { opacity: 0; transform: translateY(-50%) scale(0.95); }\n    to { opacity: 1; transform: translateY(-50%) scale(1); }\n  }\n\n  /* ── Page footer ───────────────────────────────────────────── */\n  .pressy-page-footer {\n    position: absolute;\n    bottom: 0;\n    left: 0;\n    right: 0;\n    padding: 0.5rem 1.5rem 1rem;\n    text-align: center;\n    user-select: none;\n    transform: translateY(100%);\n    opacity: 0;\n    transition: transform 0.25s ease, opacity 0.25s ease;\n    z-index: 15;\n    background: var(--color-bg, #ffffff);\n  }\n\n  .pressy-page-footer--visible {\n    transform: translateY(0);\n    opacity: 1;\n  }\n\n  /* Progress bar */\n  .pressy-progress-bar {\n    height: 3px;\n    background: var(--color-border, #dee2e6);\n    border-radius: 1.5px;\n    overflow: hidden;\n  }\n\n  .pressy-progress-fill {\n    height: 100%;\n    background: var(--color-accent, #212529);\n    border-radius: 1.5px;\n    transition: width 0.3s ease;\n  }\n\n  /* ── Footer row (title + gear) ──────────────────────────── */\n  .pressy-footer-row {\n    display: flex;\n    align-items: center;\n    justify-content: space-between;\n    margin-top: 0.5rem;\n    gap: 0.5rem;\n  }\n\n  .pressy-footer-title {\n    font-family: var(--font-heading, system-ui, -apple-system, sans-serif);\n    font-size: 0.75rem;\n    color: var(--color-text-muted, #6c757d);\n    text-decoration: none;\n    overflow: hidden;\n    text-overflow: ellipsis;\n    white-space: nowrap;\n    min-width: 0;\n    flex: 1;\n    text-align: left;\n    border: none;\n    background: none;\n    cursor: pointer;\n    padding: 0;\n  }\n\n  .pressy-footer-title:hover {\n    color: var(--color-text, #212529);\n  }\n\n  /* ── TOC toggle button ──────────────────────────────────── */\n  .pressy-toc-toggle {\n    flex-shrink: 0;\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    width: 2rem;\n    height: 2rem;\n    border: none;\n    background: transparent;\n    color: var(--color-text-muted, #6c757d);\n    cursor: pointer;\n    border-radius: 0.375rem;\n    transition: color 0.15s, background 0.15s;\n    padding: 0;\n  }\n\n  .pressy-toc-toggle:hover {\n    color: var(--color-text, #212529);\n    background: var(--color-bg-subtle, #f8f9fa);\n  }\n\n  .pressy-settings-toggle {\n    flex-shrink: 0;\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    width: 2rem;\n    height: 2rem;\n    border: none;\n    background: transparent;\n    color: var(--color-text-muted, #6c757d);\n    cursor: pointer;\n    border-radius: 0.375rem;\n    transition: color 0.15s, background 0.15s;\n    padding: 0;\n  }\n\n  .pressy-settings-toggle:hover {\n    color: var(--color-text, #212529);\n    background: var(--color-bg-subtle, #f8f9fa);\n  }\n\n  /* ── Settings panel ────────────────────────────────────── */\n  .pressy-settings-panel {\n    overflow: hidden;\n    max-height: 0;\n    opacity: 0;\n    transition: max-height 0.25s ease, opacity 0.2s ease;\n    border-top: 0 solid var(--color-border, #dee2e6);\n  }\n\n  .pressy-settings-panel--open {\n    max-height: 300px;\n    opacity: 1;\n    border-top-width: 1px;\n    margin-top: 0.5rem;\n    padding-top: 0.75rem;\n  }\n\n  .pressy-settings-section {\n    margin-bottom: 0.75rem;\n  }\n\n  .pressy-settings-section:last-child {\n    margin-bottom: 0;\n  }\n\n  .pressy-settings-label {\n    font-family: var(--font-heading, system-ui, -apple-system, sans-serif);\n    font-size: 0.6875rem;\n    font-weight: 600;\n    text-transform: uppercase;\n    letter-spacing: 0.05em;\n    color: var(--color-text-muted, #6c757d);\n    margin-bottom: 0.5rem;\n    text-align: left;\n  }\n\n  .pressy-theme-options {\n    display: flex;\n    gap: 0.375rem;\n  }\n\n  .pressy-theme-btn {\n    flex: 1;\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    gap: 0.25rem;\n    padding: 0.375rem 0.5rem;\n    border: 1.5px solid var(--color-border, #dee2e6);\n    border-radius: 0.5rem;\n    background: transparent;\n    color: var(--color-text, #212529);\n    font-family: var(--font-heading, system-ui, -apple-system, sans-serif);\n    font-size: 0.6875rem;\n    cursor: pointer;\n    transition: border-color 0.15s, background 0.15s;\n  }\n\n  .pressy-theme-btn:hover {\n    background: var(--color-bg-subtle, #f8f9fa);\n  }\n\n  .pressy-theme-btn--active {\n    border-color: var(--color-accent, #212529);\n    background: var(--color-bg-subtle, #f8f9fa);\n    font-weight: 600;\n  }\n\n  .pressy-font-size-controls {\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    gap: 1rem;\n  }\n\n  .pressy-font-size-btn {\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    width: 2rem;\n    height: 2rem;\n    border: 1.5px solid var(--color-border, #dee2e6);\n    border-radius: 50%;\n    background: transparent;\n    color: var(--color-text, #212529);\n    font-family: var(--font-heading, system-ui, -apple-system, sans-serif);\n    font-size: 0.75rem;\n    font-weight: 600;\n    cursor: pointer;\n    transition: border-color 0.15s, background 0.15s;\n  }\n\n  .pressy-font-size-btn:hover:not(:disabled) {\n    background: var(--color-bg-subtle, #f8f9fa);\n    border-color: var(--color-accent, #212529);\n  }\n\n  .pressy-font-size-btn:disabled {\n    opacity: 0.3;\n    cursor: default;\n  }\n\n  .pressy-font-size-value {\n    font-family: var(--font-heading, system-ui, -apple-system, sans-serif);\n    font-size: 0.8125rem;\n    font-weight: 500;\n    color: var(--color-text, #212529);\n    min-width: 3ch;\n    text-align: center;\n  }\n\n  /* ── Chapter sections ─────────────────────────────────── */\n  .pressy-chapter-section + .pressy-chapter-section {\n    break-before: column;\n  }\n\n  .pressy-chapter-divider {\n    padding: 0;\n    margin: 0;\n  }\n\n  .pressy-chapter-divider-title {\n    font-size: 1.5rem;\n    font-family: var(--font-heading, system-ui, -apple-system, sans-serif);\n    margin: 0;\n  }\n\n  /* ── TOC drawer ──────────────────────────────────────────── */\n  .pressy-toc-backdrop {\n    position: absolute;\n    inset: 0;\n    background: rgba(0, 0, 0, 0.3);\n    z-index: 20;\n    display: flex;\n    align-items: flex-end;\n    animation: pressy-toc-fade-in 0.2s ease-out;\n  }\n\n  .pressy-toc-drawer {\n    width: 100%;\n    max-height: 70vh;\n    background: var(--color-bg, #ffffff);\n    border-radius: 1rem 1rem 0 0;\n    display: flex;\n    flex-direction: column;\n    animation: pressy-toc-slide-up 0.25s ease-out;\n    box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.1);\n  }\n\n  .pressy-toc-header {\n    display: flex;\n    align-items: center;\n    justify-content: space-between;\n    padding: 1rem 1.5rem 0.75rem;\n    border-bottom: 1px solid var(--color-border, #dee2e6);\n    flex-shrink: 0;\n  }\n\n  .pressy-toc-title {\n    font-family: var(--font-heading, system-ui, -apple-system, sans-serif);\n    font-size: 1rem;\n    font-weight: 600;\n    color: var(--color-text, #212529);\n  }\n\n  .pressy-toc-close {\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    width: 2rem;\n    height: 2rem;\n    border: none;\n    background: transparent;\n    color: var(--color-text-muted, #6c757d);\n    cursor: pointer;\n    border-radius: 0.375rem;\n    padding: 0;\n  }\n\n  .pressy-toc-close:hover {\n    color: var(--color-text, #212529);\n    background: var(--color-bg-subtle, #f8f9fa);\n  }\n\n  .pressy-toc-list {\n    overflow-y: auto;\n    padding: 0.5rem;\n    display: flex;\n    flex-direction: column;\n  }\n\n  .pressy-toc-item {\n    display: flex;\n    gap: 0.75rem;\n    padding: 0.625rem 1rem;\n    text-decoration: none;\n    color: var(--color-text, #212529);\n    border-radius: 0.5rem;\n    font-family: var(--font-heading, system-ui, -apple-system, sans-serif);\n    font-size: 0.875rem;\n    transition: background 0.15s;\n  }\n\n  .pressy-toc-item:hover {\n    background: var(--color-bg-subtle, #f5f5f5);\n  }\n\n  .pressy-toc-item--active {\n    background: var(--color-bg-subtle, #f5f5f5);\n    font-weight: 600;\n  }\n\n  .pressy-toc-item-num {\n    color: var(--color-text-muted, #6c757d);\n    min-width: 2ch;\n    text-align: right;\n  }\n\n  .pressy-toc-item-title {\n    flex: 1;\n    min-width: 0;\n  }\n\n  @keyframes pressy-toc-fade-in {\n    from { opacity: 0; }\n    to { opacity: 1; }\n  }\n\n  @keyframes pressy-toc-slide-up {\n    from { transform: translateY(100%); }\n    to { transform: translateY(0); }\n  }\n\n  /* ── Offline footer icon ────────────────────────────────── */\n  .pressy-offline-icon {\n    flex-shrink: 0;\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    position: relative;\n    width: 2rem;\n    height: 2rem;\n    border: none;\n    background: transparent;\n    color: var(--color-text-muted, #6c757d);\n    cursor: pointer;\n    border-radius: 0.375rem;\n    transition: color 0.15s, background 0.15s;\n    padding: 0;\n  }\n\n  .pressy-offline-icon:hover {\n    color: var(--color-text, #212529);\n    background: var(--color-bg-subtle, #f8f9fa);\n  }\n\n  .pressy-offline-icon--cached {\n    color: #16a34a;\n  }\n\n  .pressy-offline-icon--cached:hover {\n    color: #dc2626;\n  }\n\n  .pressy-offline-check {\n    position: absolute;\n    bottom: 2px;\n    right: 2px;\n  }\n\n  .pressy-offline-icon--downloading {\n    cursor: default;\n  }\n\n  @keyframes pressy-offline-spin {\n    from { transform: rotate(0deg); }\n    to { transform: rotate(360deg); }\n  }\n\n  .pressy-offline-spinner {\n    animation: pressy-offline-spin 1s linear infinite;\n    transform-origin: 12px 12px;\n  }\n\n  /* ── Reduced motion preference ────────────────────────────\n     Disable page turn animations for users who prefer reduced motion. */\n  @media (prefers-reduced-motion: reduce) {\n    .pressy-prose--paginated {\n      transition: none !important;\n    }\n    .pressy-progress-fill {\n      transition: none !important;\n    }\n    .pressy-toc-backdrop,\n    .pressy-toc-drawer {\n      animation: none;\n    }\n    .pressy-offline-spinner {\n      animation: none;\n    }\n  }\n`;\n","structuredPatch":[{"oldStart":2915,"oldLines":6,"newStart":2915,"newLines":18,"lines":["     text-align: right;","   }"," ","+  .pressy-toc-item--home {","+    border-bottom: 1px solid var(--color-border, #e5e5e5);","+    margin-bottom: 0.25rem;","+    padding-bottom: 0.75rem;","+  }","+","+  .pressy-toc-item--home .pressy-toc-item-num {","+    display: flex;","+    align-items: center;","+    justify-content: center;","+  }","+","   .pressy-toc-item-title {","     flex: 1;","     min-width: 0;"]}],"userModified":false,"replaceAll":false},"sourceToolAssistantUUID":"af925b50-70bf-4b2f-b474-6359f80f546e"}
{"parentUuid":"83ca3058-e71e-42cf-bc64-8c5d325d8500","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","message":{"model":"claude-opus-4-6","id":"msg_01CTyuctFbZWkvULujwcMwJt","type":"message","role":"assistant","content":[{"type":"text","text":"Now let me build both packages to verify:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":486,"cache_read_input_tokens":54495,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":486},"output_tokens":1,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CYAtxVcXuM2Q4cGmzTfax","type":"assistant","uuid":"899dd897-c690-4e48-a146-25177f81442e","timestamp":"2026-02-16T01:40:55.716Z"}
{"parentUuid":"899dd897-c690-4e48-a146-25177f81442e","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","message":{"model":"claude-opus-4-6","id":"msg_01CTyuctFbZWkvULujwcMwJt","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01HFUyG66LDDuJ8gS7uFT5FE","name":"Bash","input":{"command":"pnpm --filter @pressy/components build 2>&1 && pnpm --filter pressy build 2>&1","description":"Build components and pressy packages","timeout":60000},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":486,"cache_read_input_tokens":54495,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":486},"output_tokens":1,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CYAtxVcXuM2Q4cGmzTfax","type":"assistant","uuid":"65c83b92-14c3-4da5-8f58-974a7111ea65","timestamp":"2026-02-16T01:40:57.078Z"}
{"parentUuid":"65c83b92-14c3-4da5-8f58-974a7111ea65","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","type":"progress","data":{"type":"bash_progress","output":"ESM dist/index.js.map           54.88 KB\nESM dist/runtime/offline.js.map 10.20 KB\nESM dist/runtime/sw.js.map      8.29 KB\nESM ⚡️ Build success in 16ms\nDTS Build start","fullOutput":"No projects matched the filters in \"/Users/blittle/dev/pressy\"\n> pressy@0.1.1 build /Users/blittle/dev/pressy/packages/pressy\n> tsup\nCLI Building entry: {\"index\":\"src/index.ts\",\"cli/index\":\"src/cli/index.ts\",\"vite/plugin\":\"src/vite/plugin.ts\",\"runtime/client\":\"src/runtime/client.tsx\",\"runtime/offline\":\"src/runtime/offline.ts\",\"runtime/sw\":\"src/runtime/sw.ts\"}\nCLI Using tsconfig: tsconfig.json\nCLI tsup v8.5.1\nCLI Using tsup config: /Users/blittle/dev/pressy/packages/pressy/tsup.config.ts\nCLI Target: node18\nCLI Cleaning output folder\nESM Build start\nESM dist/runtime/offline.js     5.52 KB\nESM dist/vite/plugin.js         29.94 KB\nESM dist/index.js               30.25 KB\nESM dist/runtime/client.js      28.38 KB\nESM dist/cli/index.js           32.92 KB\nESM dist/runtime/sw.js          4.09 KB\nESM dist/vite/plugin.js.map     52.96 KB\nESM dist/cli/index.js.map       58.66 KB\nESM dist/runtime/client.js.map  48.96 KB\nESM dist/index.js.map           54.88 KB\nESM dist/runtime/offline.js.map 10.20 KB\nESM dist/runtime/sw.js.map      8.29 KB\nESM ⚡️ Build success in 16ms\nDTS Build start","elapsedTimeSeconds":2,"totalLines":24,"timeoutMs":60000},"toolUseID":"bash-progress-0","parentToolUseID":"toolu_01HFUyG66LDDuJ8gS7uFT5FE","uuid":"4b84d81b-01d4-4e5e-a749-85765e6f82ef","timestamp":"2026-02-16T01:40:59.084Z"}
{"parentUuid":"4b84d81b-01d4-4e5e-a749-85765e6f82ef","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","type":"progress","data":{"type":"bash_progress","output":"ESM dist/index.js.map           54.88 KB\nESM dist/runtime/offline.js.map 10.20 KB\nESM dist/runtime/sw.js.map      8.29 KB\nESM ⚡️ Build success in 16ms\nDTS Build start","fullOutput":"No projects matched the filters in \"/Users/blittle/dev/pressy\"\n> pressy@0.1.1 build /Users/blittle/dev/pressy/packages/pressy\n> tsup\nCLI Building entry: {\"index\":\"src/index.ts\",\"cli/index\":\"src/cli/index.ts\",\"vite/plugin\":\"src/vite/plugin.ts\",\"runtime/client\":\"src/runtime/client.tsx\",\"runtime/offline\":\"src/runtime/offline.ts\",\"runtime/sw\":\"src/runtime/sw.ts\"}\nCLI Using tsconfig: tsconfig.json\nCLI tsup v8.5.1\nCLI Using tsup config: /Users/blittle/dev/pressy/packages/pressy/tsup.config.ts\nCLI Target: node18\nCLI Cleaning output folder\nESM Build start\nESM dist/runtime/offline.js     5.52 KB\nESM dist/vite/plugin.js         29.94 KB\nESM dist/index.js               30.25 KB\nESM dist/runtime/client.js      28.38 KB\nESM dist/cli/index.js           32.92 KB\nESM dist/runtime/sw.js          4.09 KB\nESM dist/vite/plugin.js.map     52.96 KB\nESM dist/cli/index.js.map       58.66 KB\nESM dist/runtime/client.js.map  48.96 KB\nESM dist/index.js.map           54.88 KB\nESM dist/runtime/offline.js.map 10.20 KB\nESM dist/runtime/sw.js.map      8.29 KB\nESM ⚡️ Build success in 16ms\nDTS Build start","elapsedTimeSeconds":3,"totalLines":24,"timeoutMs":60000},"toolUseID":"bash-progress-1","parentToolUseID":"toolu_01HFUyG66LDDuJ8gS7uFT5FE","uuid":"9b190ea2-08b7-4d03-9a8c-85aedf8f7eab","timestamp":"2026-02-16T01:41:00.085Z"}
{"parentUuid":"9b190ea2-08b7-4d03-9a8c-85aedf8f7eab","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","type":"progress","data":{"type":"bash_progress","output":"ESM dist/index.js.map           54.88 KB\nESM dist/runtime/offline.js.map 10.20 KB\nESM dist/runtime/sw.js.map      8.29 KB\nESM ⚡️ Build success in 16ms\nDTS Build start","fullOutput":"No projects matched the filters in \"/Users/blittle/dev/pressy\"\n> pressy@0.1.1 build /Users/blittle/dev/pressy/packages/pressy\n> tsup\nCLI Building entry: {\"index\":\"src/index.ts\",\"cli/index\":\"src/cli/index.ts\",\"vite/plugin\":\"src/vite/plugin.ts\",\"runtime/client\":\"src/runtime/client.tsx\",\"runtime/offline\":\"src/runtime/offline.ts\",\"runtime/sw\":\"src/runtime/sw.ts\"}\nCLI Using tsconfig: tsconfig.json\nCLI tsup v8.5.1\nCLI Using tsup config: /Users/blittle/dev/pressy/packages/pressy/tsup.config.ts\nCLI Target: node18\nCLI Cleaning output folder\nESM Build start\nESM dist/runtime/offline.js     5.52 KB\nESM dist/vite/plugin.js         29.94 KB\nESM dist/index.js               30.25 KB\nESM dist/runtime/client.js      28.38 KB\nESM dist/cli/index.js           32.92 KB\nESM dist/runtime/sw.js          4.09 KB\nESM dist/vite/plugin.js.map     52.96 KB\nESM dist/cli/index.js.map       58.66 KB\nESM dist/runtime/client.js.map  48.96 KB\nESM dist/index.js.map           54.88 KB\nESM dist/runtime/offline.js.map 10.20 KB\nESM dist/runtime/sw.js.map      8.29 KB\nESM ⚡️ Build success in 16ms\nDTS Build start","elapsedTimeSeconds":4,"totalLines":24,"timeoutMs":60000},"toolUseID":"bash-progress-2","parentToolUseID":"toolu_01HFUyG66LDDuJ8gS7uFT5FE","uuid":"cd76e869-c18f-4318-bf3b-830450e58041","timestamp":"2026-02-16T01:41:01.085Z"}
{"parentUuid":"65c83b92-14c3-4da5-8f58-974a7111ea65","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01HFUyG66LDDuJ8gS7uFT5FE","type":"tool_result","content":"No projects matched the filters in \"/Users/blittle/dev/pressy\"\n\n> pressy@0.1.1 build /Users/blittle/dev/pressy/packages/pressy\n> tsup\n\nCLI Building entry: {\"index\":\"src/index.ts\",\"cli/index\":\"src/cli/index.ts\",\"vite/plugin\":\"src/vite/plugin.ts\",\"runtime/client\":\"src/runtime/client.tsx\",\"runtime/offline\":\"src/runtime/offline.ts\",\"runtime/sw\":\"src/runtime/sw.ts\"}\nCLI Using tsconfig: tsconfig.json\nCLI tsup v8.5.1\nCLI Using tsup config: /Users/blittle/dev/pressy/packages/pressy/tsup.config.ts\nCLI Target: node18\nCLI Cleaning output folder\nESM Build start\nESM dist/runtime/offline.js     5.52 KB\nESM dist/vite/plugin.js         29.94 KB\nESM dist/index.js               30.25 KB\nESM dist/runtime/client.js      28.38 KB\nESM dist/cli/index.js           32.92 KB\nESM dist/runtime/sw.js          4.09 KB\nESM dist/vite/plugin.js.map     52.96 KB\nESM dist/cli/index.js.map       58.66 KB\nESM dist/runtime/client.js.map  48.96 KB\nESM dist/index.js.map           54.88 KB\nESM dist/runtime/offline.js.map 10.20 KB\nESM dist/runtime/sw.js.map      8.29 KB\nESM ⚡️ Build success in 16ms\nDTS Build start\nDTS ⚡️ Build success in 2808ms\nDTS dist/index.d.ts           329.00 B\nDTS dist/cli/index.d.ts       20.00 B\nDTS dist/vite/plugin.d.ts     180.00 B\nDTS dist/runtime/client.d.ts  1.43 KB\nDTS dist/runtime/offline.d.ts 1.12 KB\nDTS dist/runtime/sw.d.ts      13.00 B\nDTS dist/types-DtFj4lcD.d.ts  1.62 KB\nDTS dist/config-M8fI46fg.d.ts 1.56 KB","is_error":false}]},"uuid":"1cda8812-cc14-46b4-9117-1f33c81329bb","timestamp":"2026-02-16T01:41:01.579Z","toolUseResult":{"stdout":"No projects matched the filters in \"/Users/blittle/dev/pressy\"\n\n> pressy@0.1.1 build /Users/blittle/dev/pressy/packages/pressy\n> tsup\n\nCLI Building entry: {\"index\":\"src/index.ts\",\"cli/index\":\"src/cli/index.ts\",\"vite/plugin\":\"src/vite/plugin.ts\",\"runtime/client\":\"src/runtime/client.tsx\",\"runtime/offline\":\"src/runtime/offline.ts\",\"runtime/sw\":\"src/runtime/sw.ts\"}\nCLI Using tsconfig: tsconfig.json\nCLI tsup v8.5.1\nCLI Using tsup config: /Users/blittle/dev/pressy/packages/pressy/tsup.config.ts\nCLI Target: node18\nCLI Cleaning output folder\nESM Build start\nESM dist/runtime/offline.js     5.52 KB\nESM dist/vite/plugin.js         29.94 KB\nESM dist/index.js               30.25 KB\nESM dist/runtime/client.js      28.38 KB\nESM dist/cli/index.js           32.92 KB\nESM dist/runtime/sw.js          4.09 KB\nESM dist/vite/plugin.js.map     52.96 KB\nESM dist/cli/index.js.map       58.66 KB\nESM dist/runtime/client.js.map  48.96 KB\nESM dist/index.js.map           54.88 KB\nESM dist/runtime/offline.js.map 10.20 KB\nESM dist/runtime/sw.js.map      8.29 KB\nESM ⚡️ Build success in 16ms\nDTS Build start\nDTS ⚡️ Build success in 2808ms\nDTS dist/index.d.ts           329.00 B\nDTS dist/cli/index.d.ts       20.00 B\nDTS dist/vite/plugin.d.ts     180.00 B\nDTS dist/runtime/client.d.ts  1.43 KB\nDTS dist/runtime/offline.d.ts 1.12 KB\nDTS dist/runtime/sw.d.ts      13.00 B\nDTS dist/types-DtFj4lcD.d.ts  1.62 KB\nDTS dist/config-M8fI46fg.d.ts 1.56 KB","stderr":"","interrupted":false,"isImage":false,"noOutputExpected":false},"sourceToolAssistantUUID":"65c83b92-14c3-4da5-8f58-974a7111ea65"}
{"parentUuid":"1cda8812-cc14-46b4-9117-1f33c81329bb","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","message":{"model":"claude-opus-4-6","id":"msg_01YSRWXek9iDx1yDhmUSY2yk","type":"message","role":"assistant","content":[{"type":"text","text":"Let me check the components package name:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":727,"cache_read_input_tokens":54981,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":727},"output_tokens":1,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CYAty6wYoskrvshEJb8Ab","type":"assistant","uuid":"f55c44ef-7893-41d7-8b49-77719e13b178","timestamp":"2026-02-16T01:41:04.838Z"}
{"parentUuid":"f55c44ef-7893-41d7-8b49-77719e13b178","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","message":{"model":"claude-opus-4-6","id":"msg_01YSRWXek9iDx1yDhmUSY2yk","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01JJ3dcmZ1PUTCuBwucuMdcj","name":"Grep","input":{"pattern":"\"name\"","path":"/Users/blittle/dev/pressy/packages/@pressy/components/package.json","output_mode":"content"},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":727,"cache_read_input_tokens":54981,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":727},"output_tokens":1,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CYAty6wYoskrvshEJb8Ab","type":"assistant","uuid":"2aa52508-9074-4baf-aa2a-d8ef825749d4","timestamp":"2026-02-16T01:41:05.996Z"}
{"parentUuid":"2aa52508-9074-4baf-aa2a-d8ef825749d4","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","type":"progress","data":{"type":"hook_progress","hookEvent":"PostToolUse","hookName":"PostToolUse:Grep","command":"callback"},"parentToolUseID":"toolu_01JJ3dcmZ1PUTCuBwucuMdcj","toolUseID":"toolu_01JJ3dcmZ1PUTCuBwucuMdcj","timestamp":"2026-02-16T01:41:06.256Z","uuid":"693a993f-6314-4237-98d8-2c86da66d852"}
{"parentUuid":"2aa52508-9074-4baf-aa2a-d8ef825749d4","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01JJ3dcmZ1PUTCuBwucuMdcj","type":"tool_result","content":"2:  \"name\": \"@pressy-pub/components\","}]},"uuid":"6c388362-e7ea-4f26-b8e9-0ab09bbfb67e","timestamp":"2026-02-16T01:41:06.255Z","toolUseResult":{"mode":"content","numFiles":0,"filenames":[],"content":"2:  \"name\": \"@pressy-pub/components\",","numLines":1},"sourceToolAssistantUUID":"2aa52508-9074-4baf-aa2a-d8ef825749d4"}
{"parentUuid":"6c388362-e7ea-4f26-b8e9-0ab09bbfb67e","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","message":{"model":"claude-opus-4-6","id":"msg_014DAd9caDtxDTeuYhpP2P5T","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01E2LDC34KaGW7RVDHJcfsvt","name":"Bash","input":{"command":"pnpm --filter @pressy-pub/components build 2>&1","description":"Build components package","timeout":60000},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":146,"cache_read_input_tokens":55708,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":146},"output_tokens":26,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CYAtySpdkssWxTc2Rbwek","type":"assistant","uuid":"79780f95-c439-4717-87bf-c574d3195221","timestamp":"2026-02-16T01:41:08.673Z"}
{"parentUuid":"79780f95-c439-4717-87bf-c574d3195221","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","type":"progress","data":{"type":"bash_progress","output":"ESM dist/index.js             125.21 KB\nESM dist/content/index.js.map 14.22 KB\nESM dist/index.js.map         182.75 KB\nESM ⚡️ Build success in 16ms\nDTS Build start","fullOutput":"> @pressy-pub/components@0.1.1 build /Users/blittle/dev/pressy/packages/@pressy/components\n> tsup\nCLI Building entry: {\"index\":\"src/index.ts\",\"content/index\":\"src/content/index.ts\"}\nCLI Using tsconfig: tsconfig.json\nCLI tsup v8.5.1\nCLI Using tsup config: /Users/blittle/dev/pressy/packages/@pressy/components/tsup.config.ts\nCLI Target: es2022\nCLI Cleaning output folder\nESM Build start\nESM dist/content/index.js     9.84 KB\nESM dist/index.js             125.21 KB\nESM dist/content/index.js.map 14.22 KB\nESM dist/index.js.map         182.75 KB\nESM ⚡️ Build success in 16ms\nDTS Build start","elapsedTimeSeconds":2,"totalLines":15,"timeoutMs":60000},"toolUseID":"bash-progress-0","parentToolUseID":"toolu_01E2LDC34KaGW7RVDHJcfsvt","uuid":"030d2244-6f5c-4890-b8b8-71a684e91e61","timestamp":"2026-02-16T01:41:10.677Z"}
{"parentUuid":"030d2244-6f5c-4890-b8b8-71a684e91e61","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","type":"progress","data":{"type":"bash_progress","output":"ESM dist/index.js             125.21 KB\nESM dist/content/index.js.map 14.22 KB\nESM dist/index.js.map         182.75 KB\nESM ⚡️ Build success in 16ms\nDTS Build start","fullOutput":"> @pressy-pub/components@0.1.1 build /Users/blittle/dev/pressy/packages/@pressy/components\n> tsup\nCLI Building entry: {\"index\":\"src/index.ts\",\"content/index\":\"src/content/index.ts\"}\nCLI Using tsconfig: tsconfig.json\nCLI tsup v8.5.1\nCLI Using tsup config: /Users/blittle/dev/pressy/packages/@pressy/components/tsup.config.ts\nCLI Target: es2022\nCLI Cleaning output folder\nESM Build start\nESM dist/content/index.js     9.84 KB\nESM dist/index.js             125.21 KB\nESM dist/content/index.js.map 14.22 KB\nESM dist/index.js.map         182.75 KB\nESM ⚡️ Build success in 16ms\nDTS Build start","elapsedTimeSeconds":3,"totalLines":15,"timeoutMs":60000},"toolUseID":"bash-progress-1","parentToolUseID":"toolu_01E2LDC34KaGW7RVDHJcfsvt","uuid":"f1cb0583-8060-46ee-bfae-31f7a5dbe0ee","timestamp":"2026-02-16T01:41:11.678Z"}
{"parentUuid":"79780f95-c439-4717-87bf-c574d3195221","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01E2LDC34KaGW7RVDHJcfsvt","type":"tool_result","content":"> @pressy-pub/components@0.1.1 build /Users/blittle/dev/pressy/packages/@pressy/components\n> tsup\n\nCLI Building entry: {\"index\":\"src/index.ts\",\"content/index\":\"src/content/index.ts\"}\nCLI Using tsconfig: tsconfig.json\nCLI tsup v8.5.1\nCLI Using tsup config: /Users/blittle/dev/pressy/packages/@pressy/components/tsup.config.ts\nCLI Target: es2022\nCLI Cleaning output folder\nESM Build start\nESM dist/content/index.js     9.84 KB\nESM dist/index.js             125.21 KB\nESM dist/content/index.js.map 14.22 KB\nESM dist/index.js.map         182.75 KB\nESM ⚡️ Build success in 16ms\nDTS Build start\nDTS ⚡️ Build success in 1790ms\nDTS dist/index.d.ts         4.59 KB\nDTS dist/content/index.d.ts 1.29 KB","is_error":false}]},"uuid":"8d394582-19d9-4f48-9ef2-fb977417bf35","timestamp":"2026-02-16T01:41:11.854Z","toolUseResult":{"stdout":"> @pressy-pub/components@0.1.1 build /Users/blittle/dev/pressy/packages/@pressy/components\n> tsup\n\nCLI Building entry: {\"index\":\"src/index.ts\",\"content/index\":\"src/content/index.ts\"}\nCLI Using tsconfig: tsconfig.json\nCLI tsup v8.5.1\nCLI Using tsup config: /Users/blittle/dev/pressy/packages/@pressy/components/tsup.config.ts\nCLI Target: es2022\nCLI Cleaning output folder\nESM Build start\nESM dist/content/index.js     9.84 KB\nESM dist/index.js             125.21 KB\nESM dist/content/index.js.map 14.22 KB\nESM dist/index.js.map         182.75 KB\nESM ⚡️ Build success in 16ms\nDTS Build start\nDTS ⚡️ Build success in 1790ms\nDTS dist/index.d.ts         4.59 KB\nDTS dist/content/index.d.ts 1.29 KB","stderr":"","interrupted":false,"isImage":false,"noOutputExpected":false},"sourceToolAssistantUUID":"79780f95-c439-4717-87bf-c574d3195221"}
{"parentUuid":"8d394582-19d9-4f48-9ef2-fb977417bf35","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","message":{"model":"claude-opus-4-6","id":"msg_012AKnWRbXepb5iAefMdZdTB","type":"message","role":"assistant","content":[{"type":"text","text":"Both packages build successfully. Here's what I added:\n\nIn both TOC drawers (scroll and paginated modes in `Reader.tsx`), I added a home link as the first item in the chapter list. It shows a small house icon in place of the chapter number, displays the book title (or \"Home\" as fallback), and links to the home page by stripping `/books/<slug>` from `bookBasePath`. The home item is visually separated from the chapter list with a subtle bottom border."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":384,"cache_read_input_tokens":55854,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":384},"output_tokens":1,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CYAtysp3m5A1bMVYF7G2L","type":"assistant","uuid":"c06bb73c-d605-4cde-bc8a-fc869033ecdc","timestamp":"2026-02-16T01:41:17.380Z"}
{"parentUuid":"c06bb73c-d605-4cde-bc8a-fc869033ecdc","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","type":"progress","data":{"type":"hook_progress","hookEvent":"Stop","hookName":"Stop","command":"entire hooks claude-code stop"},"parentToolUseID":"fa915d57-c004-43c3-a069-153110332ad6","toolUseID":"fa915d57-c004-43c3-a069-153110332ad6","timestamp":"2026-02-16T01:41:17.408Z","uuid":"ba76cf4f-c1dd-4358-9049-a91e41e59671"}
{"parentUuid":"ba76cf4f-c1dd-4358-9049-a91e41e59671","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","type":"system","subtype":"stop_hook_summary","hookCount":1,"hookInfos":[{"command":"entire hooks claude-code stop"}],"hookErrors":[],"preventedContinuation":false,"stopReason":"","hasOutput":true,"level":"suggestion","timestamp":"2026-02-16T01:41:18.045Z","uuid":"438844a6-0ad9-4928-b520-096a354b432f","toolUseID":"fa915d57-c004-43c3-a069-153110332ad6"}
{"parentUuid":"438844a6-0ad9-4928-b520-096a354b432f","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","type":"system","subtype":"turn_duration","durationMs":105654,"timestamp":"2026-02-16T01:41:18.048Z","uuid":"b5b21b29-a76c-45d2-94d4-a721d97cdae3","isMeta":false}
{"type":"file-history-snapshot","messageId":"8718b8e9-a755-415d-be8a-bc3c92a11a7a","snapshot":{"messageId":"8718b8e9-a755-415d-be8a-bc3c92a11a7a","trackedFileBackups":{"packages/pressy/src/runtime/offline.ts":{"backupFileName":"259b478c67f372e9@v2","version":2,"backupTime":"2026-02-16T01:34:16.305Z"},"packages/pressy/src/runtime/client.tsx":{"backupFileName":"553e6fae6ff514b2@v3","version":3,"backupTime":"2026-02-16T01:39:32.392Z"},"packages/@pressy/components/src/Reader.tsx":{"backupFileName":"04a3a173c9615dd4@v2","version":2,"backupTime":"2026-02-16T01:43:06.357Z"}},"timestamp":"2026-02-16T01:43:06.356Z"},"isSnapshotUpdate":false}
{"parentUuid":"b5b21b29-a76c-45d2-94d4-a721d97cdae3","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","type":"user","message":{"role":"user","content":"Did we break something on mobile for displaying the bottom footer on tap? I don't see anything showing up anymore on tap, `class=\"pressy-page-footer pressy-page-footer--visible\"` properly gets set, but I don't see the actual content of the footer."},"uuid":"8718b8e9-a755-415d-be8a-bc3c92a11a7a","timestamp":"2026-02-16T01:43:05.726Z","thinkingMetadata":{"maxThinkingTokens":31999},"permissionMode":"acceptEdits"}
{"parentUuid":"8718b8e9-a755-415d-be8a-bc3c92a11a7a","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","message":{"model":"claude-opus-4-6","id":"msg_015qkkh6wdyxhRjTBjyLwA1j","type":"message","role":"assistant","content":[{"type":"text","text":"\n\n"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":63,"cache_read_input_tokens":56348,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":63},"output_tokens":11,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CYAu8LGjqdf6JFCDpRNmV","type":"assistant","uuid":"d072a48e-b4f9-416a-beb1-c3b9969688dd","timestamp":"2026-02-16T01:43:08.843Z"}
{"parentUuid":"d072a48e-b4f9-416a-beb1-c3b9969688dd","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","message":{"model":"claude-opus-4-6","id":"msg_015qkkh6wdyxhRjTBjyLwA1j","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"The user says the footer is not showing up on mobile even though the `pressy-page-footer--visible` class is being set. Let me look at the footer rendering and styles more carefully to understand what might have gone wrong. The issue is likely related to my changes somehow.\n\nLet me look at the footer content and the surrounding code more carefully.","signature":"EoYECkYICxgCKkAx8nHeQ+fGGSnSn4GXRIV6oYYKhgxT0uwehsEU6rFhYImak5H0oMn/jK7AsM0H5p1Tb6Jw+OvN0OqihNvKeEtLEgwtLEZhEx553iWMC34aDKPu0R68pjnov7DVSiIwNsenDKh7vd6WSVQEM410w0PEGxz675FZibLkLdgIPT85+F3t/DH3mnRUNksfxq9GKu0CkhMu8UtT04O3FyE1jQZ+JccKU+6jmlOXC9dJiGXbJinpskjKyTvVEar3hTZZmPWmBTGgdGsrsIP4GmorhWd/xXFUQDoQDYfEx1EBVG5S4/rGl4Ni6mkCyrJEssVGIR2+PfGF0im1vPR17mRpTr+H9VSic3fBbohe3oLn3mD5Xvm6HNOQU0GhYtnx1tv7ymYydQ/xjMcOrryC9/APKhWnrke15CuWbgRrRbEh01umLRgiOBfZppsuX0icjY8wiHQxJDJnZKnIelHheucyjUvx5U8m6yplg88WXMAXd+WIIUQjAw9Brs5IM28SaZLf77ajVtJM7FzBDCLxwS8GnSJCmklXTb1jJQ1Bi04bBeVuZB/fD1aPQ3L+6uXNfdkHDqQEu6USPkPVlw0OFYMQiIrYWVi0wCrDYZMHGWCxoGkWfjyvKx//xGAsw9ucsvmZVJN6bD4WqL2xo4sLxxBKRWtzXA1Pcmpt2SZB8Vm7xjkYAQ=="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":63,"cache_read_input_tokens":56348,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":63},"output_tokens":11,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CYAu8LGjqdf6JFCDpRNmV","type":"assistant","uuid":"c10610e5-dfcd-4ebd-8a54-594b90b9c633","timestamp":"2026-02-16T01:43:10.773Z"}
{"parentUuid":"c10610e5-dfcd-4ebd-8a54-594b90b9c633","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","message":{"model":"claude-opus-4-6","id":"msg_015qkkh6wdyxhRjTBjyLwA1j","type":"message","role":"assistant","content":[{"type":"text","text":"Let me look at the footer rendering code to see what might be off."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":63,"cache_read_input_tokens":56348,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":63},"output_tokens":11,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CYAu8LGjqdf6JFCDpRNmV","type":"assistant","uuid":"dbc1465e-74e0-4055-af24-d6e979be95b4","timestamp":"2026-02-16T01:43:11.222Z"}
{"parentUuid":"dbc1465e-74e0-4055-af24-d6e979be95b4","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","message":{"model":"claude-opus-4-6","id":"msg_015qkkh6wdyxhRjTBjyLwA1j","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01BkcJ6d3doNj7KhdkcLSsKY","name":"Read","input":{"file_path":"/Users/blittle/dev/pressy/packages/@pressy/components/src/Reader.tsx","offset":454,"limit":80},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":63,"cache_read_input_tokens":56348,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":63},"output_tokens":11,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CYAu8LGjqdf6JFCDpRNmV","type":"assistant","uuid":"583f22c4-3681-47b9-a7e9-1e479c4f6cfc","timestamp":"2026-02-16T01:43:12.034Z"}
{"parentUuid":"583f22c4-3681-47b9-a7e9-1e479c4f6cfc","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","type":"progress","data":{"type":"hook_progress","hookEvent":"PostToolUse","hookName":"PostToolUse:Read","command":"callback"},"parentToolUseID":"toolu_01BkcJ6d3doNj7KhdkcLSsKY","toolUseID":"toolu_01BkcJ6d3doNj7KhdkcLSsKY","timestamp":"2026-02-16T01:43:12.090Z","uuid":"f62c2c45-22c2-4526-b949-712412dc1867"}
{"parentUuid":"583f22c4-3681-47b9-a7e9-1e479c4f6cfc","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01BkcJ6d3doNj7KhdkcLSsKY","type":"tool_result","content":"   454→                  }`}\n   455→                  onClick={() => setTocOpen(false)}\n   456→                >\n   457→                  <span class=\"pressy-toc-item-num\">{i + 1}.</span>\n   458→                  <span class=\"pressy-toc-item-title\">{ch.title}</span>\n   459→                </a>\n   460→              ))}\n   461→            </nav>\n   462→          </div>\n   463→        </div>\n   464→      )}\n   465→\n   466→      {/* Footer */}\n   467→      <div\n   468→        class={`pressy-page-footer pressy-page-footer--scroll ${\n   469→          footerVisible || settingsOpen || tocOpen\n   470→            ? \"pressy-page-footer--visible\"\n   471→            : \"\"\n   472→        }`}\n   473→      >\n   474→        <div class=\"pressy-footer-row\">\n   475→          {allChapters && allChapters.length > 0 && (\n   476→            <button\n   477→              class=\"pressy-toc-toggle\"\n   478→              onClick={(e: MouseEvent) => {\n   479→                e.stopPropagation();\n   480→                setSettingsOpen(false);\n   481→                setTocOpen(!tocOpen);\n   482→              }}\n   483→              aria-label=\"Table of contents\"\n   484→            >\n   485→              <svg\n   486→                viewBox=\"0 0 24 24\"\n   487→                fill=\"none\"\n   488→                stroke=\"currentColor\"\n   489→                stroke-width=\"1.5\"\n   490→                stroke-linecap=\"round\"\n   491→                stroke-linejoin=\"round\"\n   492→                width=\"18\"\n   493→                height=\"18\"\n   494→              >\n   495→                <line x1=\"3\" y1=\"6\" x2=\"21\" y2=\"6\" />\n   496→                <line x1=\"3\" y1=\"12\" x2=\"21\" y2=\"12\" />\n   497→                <line x1=\"3\" y1=\"18\" x2=\"21\" y2=\"18\" />\n   498→              </svg>\n   499→            </button>\n   500→          )}\n   501→          {bookTitle && (\n   502→            <button\n   503→              class=\"pressy-footer-title\"\n   504→              onClick={(e: MouseEvent) => {\n   505→                e.stopPropagation();\n   506→                if (allChapters && allChapters.length > 0) {\n   507→                  setSettingsOpen(false);\n   508→                  setTocOpen(!tocOpen);\n   509→                }\n   510→              }}\n   511→            >\n   512→              {bookTitle}\n   513→            </button>\n   514→          )}\n   515→          <OfflineFooterIcon offlineProps={offlineProps} />\n   516→          <button\n   517→            class=\"pressy-settings-toggle\"\n   518→            onClick={(e: MouseEvent) => {\n   519→              e.stopPropagation();\n   520→              setTocOpen(false);\n   521→              setSettingsOpen(!settingsOpen);\n   522→            }}\n   523→            aria-label=\"Settings\"\n   524→          >\n   525→            <svg\n   526→              viewBox=\"0 0 24 24\"\n   527→              fill=\"none\"\n   528→              stroke=\"currentColor\"\n   529→              stroke-width=\"1.5\"\n   530→              stroke-linecap=\"round\"\n   531→              stroke-linejoin=\"round\"\n   532→              width=\"18\"\n   533→              height=\"18\""}]},"uuid":"a2aa36c2-c70c-4776-8ad7-0bcb16fca4ed","timestamp":"2026-02-16T01:43:12.089Z","toolUseResult":{"type":"text","file":{"filePath":"/Users/blittle/dev/pressy/packages/@pressy/components/src/Reader.tsx","content":"                  }`}\n                  onClick={() => setTocOpen(false)}\n                >\n                  <span class=\"pressy-toc-item-num\">{i + 1}.</span>\n                  <span class=\"pressy-toc-item-title\">{ch.title}</span>\n                </a>\n              ))}\n            </nav>\n          </div>\n        </div>\n      )}\n\n      {/* Footer */}\n      <div\n        class={`pressy-page-footer pressy-page-footer--scroll ${\n          footerVisible || settingsOpen || tocOpen\n            ? \"pressy-page-footer--visible\"\n            : \"\"\n        }`}\n      >\n        <div class=\"pressy-footer-row\">\n          {allChapters && allChapters.length > 0 && (\n            <button\n              class=\"pressy-toc-toggle\"\n              onClick={(e: MouseEvent) => {\n                e.stopPropagation();\n                setSettingsOpen(false);\n                setTocOpen(!tocOpen);\n              }}\n              aria-label=\"Table of contents\"\n            >\n              <svg\n                viewBox=\"0 0 24 24\"\n                fill=\"none\"\n                stroke=\"currentColor\"\n                stroke-width=\"1.5\"\n                stroke-linecap=\"round\"\n                stroke-linejoin=\"round\"\n                width=\"18\"\n                height=\"18\"\n              >\n                <line x1=\"3\" y1=\"6\" x2=\"21\" y2=\"6\" />\n                <line x1=\"3\" y1=\"12\" x2=\"21\" y2=\"12\" />\n                <line x1=\"3\" y1=\"18\" x2=\"21\" y2=\"18\" />\n              </svg>\n            </button>\n          )}\n          {bookTitle && (\n            <button\n              class=\"pressy-footer-title\"\n              onClick={(e: MouseEvent) => {\n                e.stopPropagation();\n                if (allChapters && allChapters.length > 0) {\n                  setSettingsOpen(false);\n                  setTocOpen(!tocOpen);\n                }\n              }}\n            >\n              {bookTitle}\n            </button>\n          )}\n          <OfflineFooterIcon offlineProps={offlineProps} />\n          <button\n            class=\"pressy-settings-toggle\"\n            onClick={(e: MouseEvent) => {\n              e.stopPropagation();\n              setTocOpen(false);\n              setSettingsOpen(!settingsOpen);\n            }}\n            aria-label=\"Settings\"\n          >\n            <svg\n              viewBox=\"0 0 24 24\"\n              fill=\"none\"\n              stroke=\"currentColor\"\n              stroke-width=\"1.5\"\n              stroke-linecap=\"round\"\n              stroke-linejoin=\"round\"\n              width=\"18\"\n              height=\"18\"","numLines":80,"startLine":454,"totalLines":3014}},"sourceToolAssistantUUID":"583f22c4-3681-47b9-a7e9-1e479c4f6cfc"}
{"parentUuid":"a2aa36c2-c70c-4776-8ad7-0bcb16fca4ed","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","message":{"model":"claude-opus-4-6","id":"msg_0163CNUnjgKhv1wmL1ZQVCyE","type":"message","role":"assistant","content":[{"type":"text","text":"The footer rendering looks fine. Let me look at the click handler that triggers `footerVisible` — specifically the tap handler that was checking for TOC elements:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":1281,"cache_read_input_tokens":56411,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":1281},"output_tokens":1,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CYAu8iePbB69KFwt23Ri2","type":"assistant","uuid":"a75eecaa-cf44-44f4-9e42-d137eb6f2e3a","timestamp":"2026-02-16T01:43:15.001Z"}
{"parentUuid":"a75eecaa-cf44-44f4-9e42-d137eb6f2e3a","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","message":{"model":"claude-opus-4-6","id":"msg_0163CNUnjgKhv1wmL1ZQVCyE","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01RJ7KiRQnwgFnMCra96NWA9","name":"Read","input":{"file_path":"/Users/blittle/dev/pressy/packages/@pressy/components/src/Reader.tsx","offset":295,"limit":45},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":1281,"cache_read_input_tokens":56411,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":1281},"output_tokens":1,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CYAu8iePbB69KFwt23Ri2","type":"assistant","uuid":"c719b2af-9d02-4ceb-9d96-a13fb925c3d8","timestamp":"2026-02-16T01:43:16.274Z"}
{"parentUuid":"c719b2af-9d02-4ceb-9d96-a13fb925c3d8","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","type":"progress","data":{"type":"hook_progress","hookEvent":"PostToolUse","hookName":"PostToolUse:Read","command":"callback"},"parentToolUseID":"toolu_01RJ7KiRQnwgFnMCra96NWA9","toolUseID":"toolu_01RJ7KiRQnwgFnMCra96NWA9","timestamp":"2026-02-16T01:43:16.288Z","uuid":"f6c6428c-e87e-4560-8a03-870b291517b8"}
{"parentUuid":"c719b2af-9d02-4ceb-9d96-a13fb925c3d8","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01RJ7KiRQnwgFnMCra96NWA9","type":"tool_result","content":"   295→        const next =\n   296→          Math.round(Math.max(0.8, Math.min(1.5, prev + delta)) * 10) / 10;\n   297→        localStorage.setItem(\"pressy-font-size\", String(next));\n   298→        applyFontScale(next);\n   299→        return next;\n   300→      });\n   301→    },\n   302→    [applyFontScale]\n   303→  );\n   304→\n   305→  // Toggle footer on tap\n   306→  const handleReaderClick = useCallback(\n   307→    (e: MouseEvent) => {\n   308→      const target = e.target as HTMLElement;\n   309→      if (\n   310→        target.closest(\n   311→          \".pressy-page-footer, .pressy-toc-backdrop, .pressy-toc-toggle\"\n   312→        )\n   313→      )\n   314→        return;\n   315→      if (target.closest('a, button, input, select, textarea, [role=\"button\"]'))\n   316→        return;\n   317→\n   318→      if (settingsOpen || tocOpen) {\n   319→        setSettingsOpen(false);\n   320→        setTocOpen(false);\n   321→        return;\n   322→      }\n   323→\n   324→      if (footerVisible) {\n   325→        setFooterVisible(false);\n   326→        if (footerTimerRef.current) clearTimeout(footerTimerRef.current);\n   327→      } else {\n   328→        showFooterTemporarily();\n   329→      }\n   330→    },\n   331→    [footerVisible, settingsOpen, tocOpen, showFooterTemporarily]\n   332→  );\n   333→\n   334→  // Restore scroll position on mount\n   335→  useEffect(() => {\n   336→    if (!onRestoreProgress) return;\n   337→    onRestoreProgress().then((data) => {\n   338→      if (data && data.scrollPosition > 0) {\n   339→        window.scrollTo(0, data.scrollPosition);"}]},"uuid":"ae001f90-ae91-4524-b836-e0efa6ef8b6b","timestamp":"2026-02-16T01:43:16.287Z","toolUseResult":{"type":"text","file":{"filePath":"/Users/blittle/dev/pressy/packages/@pressy/components/src/Reader.tsx","content":"        const next =\n          Math.round(Math.max(0.8, Math.min(1.5, prev + delta)) * 10) / 10;\n        localStorage.setItem(\"pressy-font-size\", String(next));\n        applyFontScale(next);\n        return next;\n      });\n    },\n    [applyFontScale]\n  );\n\n  // Toggle footer on tap\n  const handleReaderClick = useCallback(\n    (e: MouseEvent) => {\n      const target = e.target as HTMLElement;\n      if (\n        target.closest(\n          \".pressy-page-footer, .pressy-toc-backdrop, .pressy-toc-toggle\"\n        )\n      )\n        return;\n      if (target.closest('a, button, input, select, textarea, [role=\"button\"]'))\n        return;\n\n      if (settingsOpen || tocOpen) {\n        setSettingsOpen(false);\n        setTocOpen(false);\n        return;\n      }\n\n      if (footerVisible) {\n        setFooterVisible(false);\n        if (footerTimerRef.current) clearTimeout(footerTimerRef.current);\n      } else {\n        showFooterTemporarily();\n      }\n    },\n    [footerVisible, settingsOpen, tocOpen, showFooterTemporarily]\n  );\n\n  // Restore scroll position on mount\n  useEffect(() => {\n    if (!onRestoreProgress) return;\n    onRestoreProgress().then((data) => {\n      if (data && data.scrollPosition > 0) {\n        window.scrollTo(0, data.scrollPosition);","numLines":45,"startLine":295,"totalLines":3014}},"sourceToolAssistantUUID":"c719b2af-9d02-4ceb-9d96-a13fb925c3d8"}
{"parentUuid":"ae001f90-ae91-4524-b836-e0efa6ef8b6b","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","message":{"model":"claude-opus-4-6","id":"msg_01VoupdYKws42Q23o6BVzYXc","type":"message","role":"assistant","content":[{"type":"text","text":"This click handler looks fine. Let me look at the footer styles — specifically the `--visible` class and whether z-index or positioning could be the issue. Let me look at the scroll-mode footer styles."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":691,"cache_read_input_tokens":57692,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":691},"output_tokens":1,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CYAu932BnNkjY2fGXPpuF","type":"assistant","uuid":"3dddc636-c3ac-4d20-9d25-bb26ffdc6ccc","timestamp":"2026-02-16T01:43:19.497Z"}
{"parentUuid":"3dddc636-c3ac-4d20-9d25-bb26ffdc6ccc","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","message":{"model":"claude-opus-4-6","id":"msg_01VoupdYKws42Q23o6BVzYXc","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01NARRzcKGFwsH2K8miUkHjS","name":"Grep","input":{"pattern":"pressy-page-footer--scroll|pressy-page-footer--visible","path":"/Users/blittle/dev/pressy/packages/@pressy/components/src/Reader.tsx","output_mode":"content","-n":true,"-C":5},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":691,"cache_read_input_tokens":57692,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":691},"output_tokens":1,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CYAu932BnNkjY2fGXPpuF","type":"assistant","uuid":"ed755bf6-b78f-44fc-a410-06d626a82f44","timestamp":"2026-02-16T01:43:21.021Z"}
{"parentUuid":"ed755bf6-b78f-44fc-a410-06d626a82f44","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","type":"progress","data":{"type":"hook_progress","hookEvent":"PostToolUse","hookName":"PostToolUse:Grep","command":"callback"},"parentToolUseID":"toolu_01NARRzcKGFwsH2K8miUkHjS","toolUseID":"toolu_01NARRzcKGFwsH2K8miUkHjS","timestamp":"2026-02-16T01:43:21.347Z","uuid":"01e19e5a-e1a7-4f38-af40-7a5c1eab3fd7"}
{"parentUuid":"ed755bf6-b78f-44fc-a410-06d626a82f44","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01NARRzcKGFwsH2K8miUkHjS","type":"tool_result","content":"463-        </div>\n464-      )}\n465-\n466-      {/* Footer */}\n467-      <div\n468:        class={`pressy-page-footer pressy-page-footer--scroll ${\n469-          footerVisible || settingsOpen || tocOpen\n470:            ? \"pressy-page-footer--visible\"\n471-            : \"\"\n472-        }`}\n473-      >\n474-        <div class=\"pressy-footer-row\">\n475-          {allChapters && allChapters.length > 0 && (\n--\n1838-\n1839-      {/* Page footer with progress — hidden by default */}\n1840-      <div\n1841-        class={`pressy-page-footer ${\n1842-          footerVisible || settingsOpen || tocOpen\n1843:            ? \"pressy-page-footer--visible\"\n1844-            : \"\"\n1845-        }`}\n1846-      >\n1847-        <div class=\"pressy-progress-bar\">\n1848-          <div\n--\n2082-    flex: 1;\n2083-    padding: 2rem 0;\n2084-  }\n2085-\n2086-  /* ── Scroll reader footer ──────────────────────────────── */\n2087:  .pressy-page-footer--scroll {\n2088-    position: fixed;\n2089-    bottom: 0;\n2090-    left: 0;\n2091-    right: 0;\n2092-    padding: 0.5rem 1.5rem 1rem;\n--\n2098-    z-index: 15;\n2099-    background: var(--color-bg, #ffffff);\n2100-    box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.05);\n2101-  }\n2102-\n2103:  .pressy-page-footer--scroll.pressy-page-footer--visible {\n2104-    transform: translateY(0);\n2105-    opacity: 1;\n2106-  }\n2107-\n2108-  /* Shared footer styles for scroll reader */\n2109:  .pressy-page-footer--scroll .pressy-footer-row {\n2110-    display: flex;\n2111-    align-items: center;\n2112-    justify-content: space-between;\n2113-    gap: 0.5rem;\n2114-  }\n2115-\n2116:  .pressy-page-footer--scroll .pressy-footer-title {\n2117-    font-family: var(--font-heading, system-ui, -apple-system, sans-serif);\n2118-    font-size: 0.75rem;\n2119-    color: var(--color-text-muted, #6c757d);\n2120-    text-decoration: none;\n2121-    overflow: hidden;\n--\n2128-    background: none;\n2129-    cursor: pointer;\n2130-    padding: 0;\n2131-  }\n2132-\n2133:  .pressy-page-footer--scroll .pressy-footer-title:hover {\n2134-    color: var(--color-text, #212529);\n2135-  }\n2136-\n2137:  .pressy-page-footer--scroll .pressy-toc-toggle,\n2138:  .pressy-page-footer--scroll .pressy-settings-toggle {\n2139-    flex-shrink: 0;\n2140-    display: flex;\n2141-    align-items: center;\n2142-    justify-content: center;\n2143-    width: 2rem;\n--\n2149-    border-radius: 0.375rem;\n2150-    transition: color 0.15s, background 0.15s;\n2151-    padding: 0;\n2152-  }\n2153-\n2154:  .pressy-page-footer--scroll .pressy-toc-toggle:hover,\n2155:  .pressy-page-footer--scroll .pressy-settings-toggle:hover {\n2156-    color: var(--color-text, #212529);\n2157-    background: var(--color-bg-subtle, #f8f9fa);\n2158-  }\n2159-\n2160:  .pressy-page-footer--scroll .pressy-settings-panel {\n2161-    overflow: hidden;\n2162-    max-height: 0;\n2163-    opacity: 0;\n2164-    transition: max-height 0.25s ease, opacity 0.2s ease;\n2165-    border-top: 0 solid var(--color-border, #dee2e6);\n2166-  }\n2167-\n2168:  .pressy-page-footer--scroll .pressy-settings-panel--open {\n2169-    max-height: 300px;\n2170-    opacity: 1;\n2171-    border-top-width: 1px;\n2172-    margin-top: 0.5rem;\n2173-    padding-top: 0.75rem;\n2174-  }\n2175-\n2176:  .pressy-page-footer--scroll .pressy-settings-section {\n2177-    margin-bottom: 0.75rem;\n2178-  }\n2179-\n2180:  .pressy-page-footer--scroll .pressy-settings-section:last-child {\n2181-    margin-bottom: 0;\n2182-  }\n2183-\n2184:  .pressy-page-footer--scroll .pressy-settings-label {\n2185-    font-family: var(--font-heading, system-ui, -apple-system, sans-serif);\n2186-    font-size: 0.6875rem;\n2187-    font-weight: 600;\n2188-    text-transform: uppercase;\n2189-    letter-spacing: 0.05em;\n2190-    color: var(--color-text-muted, #6c757d);\n2191-    margin-bottom: 0.5rem;\n2192-    text-align: left;\n2193-  }\n2194-\n2195:  .pressy-page-footer--scroll .pressy-theme-options {\n2196-    display: flex;\n2197-    gap: 0.375rem;\n2198-  }\n2199-\n2200:  .pressy-page-footer--scroll .pressy-theme-btn {\n2201-    flex: 1;\n2202-    display: flex;\n2203-    align-items: center;\n2204-    justify-content: center;\n2205-    gap: 0.25rem;\n--\n2212-    font-size: 0.6875rem;\n2213-    cursor: pointer;\n2214-    transition: border-color 0.15s, background 0.15s;\n2215-  }\n2216-\n2217:  .pressy-page-footer--scroll .pressy-theme-btn:hover {\n2218-    background: var(--color-bg-subtle, #f8f9fa);\n2219-  }\n2220-\n2221:  .pressy-page-footer--scroll .pressy-theme-btn--active {\n2222-    border-color: var(--color-accent, #212529);\n2223-    background: var(--color-bg-subtle, #f8f9fa);\n2224-    font-weight: 600;\n2225-  }\n2226-\n2227:  .pressy-page-footer--scroll .pressy-font-size-controls {\n2228-    display: flex;\n2229-    align-items: center;\n2230-    justify-content: center;\n2231-    gap: 1rem;\n2232-  }\n2233-\n2234:  .pressy-page-footer--scroll .pressy-font-size-btn {\n2235-    display: flex;\n2236-    align-items: center;\n2237-    justify-content: center;\n2238-    width: 2rem;\n2239-    height: 2rem;\n--\n2246-    font-weight: 600;\n2247-    cursor: pointer;\n2248-    transition: border-color 0.15s, background 0.15s;\n2249-  }\n2250-\n2251:  .pressy-page-footer--scroll .pressy-font-size-btn:hover:not(:disabled) {\n2252-    background: var(--color-bg-subtle, #f8f9fa);\n2253-    border-color: var(--color-accent, #212529);\n2254-  }\n2255-\n2256:  .pressy-page-footer--scroll .pressy-font-size-btn:disabled {\n2257-    opacity: 0.3;\n2258-    cursor: default;\n2259-  }\n2260-\n2261:  .pressy-page-footer--scroll .pressy-font-size-value {\n2262-    font-family: var(--font-heading, system-ui, -apple-system, sans-serif);\n2263-    font-size: 0.8125rem;\n2264-    font-weight: 500;\n2265-    color: var(--color-text, #212529);\n2266-    min-width: 3ch;\n--\n2384-    from { transform: translateY(100%); }\n2385-    to { transform: translateY(0); }\n2386-  }\n2387-\n2388-  /* ── Offline icon for scroll reader ─────────────────────── */\n2389:  .pressy-page-footer--scroll .pressy-offline-icon {\n2390-    flex-shrink: 0;\n2391-    display: flex;\n2392-    align-items: center;\n2393-    justify-content: center;\n2394-    position: relative;\n--\n2401-    border-radius: 0.375rem;\n2402-    transition: color 0.15s, background 0.15s;\n2403-    padding: 0;\n2404-  }\n2405-\n2406:  .pressy-page-footer--scroll .pressy-offline-icon:hover {\n2407-    color: var(--color-text, #212529);\n2408-    background: var(--color-bg-subtle, #f8f9fa);\n2409-  }\n2410-\n2411:  .pressy-page-footer--scroll .pressy-offline-icon--cached {\n2412-    color: #16a34a;\n2413-  }\n2414-\n2415:  .pressy-page-footer--scroll .pressy-offline-icon--cached:hover {\n2416-    color: #dc2626;\n2417-  }\n2418-\n2419:  .pressy-page-footer--scroll .pressy-offline-check {\n2420-    position: absolute;\n2421-    bottom: 2px;\n2422-    right: 2px;\n2423-  }\n2424-\n2425:  .pressy-page-footer--scroll .pressy-offline-icon--downloading {\n2426-    cursor: default;\n2427-  }\n2428-\n2429-  @media (prefers-reduced-motion: reduce) {\n2430:    .pressy-page-footer--scroll {\n2431-      transition: none;\n2432-    }\n2433-    .pressy-toc-backdrop--scroll,\n2434-    .pressy-toc-backdrop--scroll .pressy-toc-drawer {\n2435-      animation: none;\n--\n2602-    transition: transform 0.25s ease, opacity 0.25s ease;\n2603-    z-index: 15;\n2604-    background: var(--color-bg, #ffffff);\n2605-  }\n2606-\n2607:  .pressy-page-footer--visible {\n2608-    transform: translateY(0);\n2609-    opacity: 1;\n2610-  }\n2611-\n2612-  /* Progress bar */"}]},"uuid":"ebeac6b1-d594-49be-a840-31d113c65d8e","timestamp":"2026-02-16T01:43:21.346Z","toolUseResult":{"mode":"content","numFiles":0,"filenames":[],"content":"463-        </div>\n464-      )}\n465-\n466-      {/* Footer */}\n467-      <div\n468:        class={`pressy-page-footer pressy-page-footer--scroll ${\n469-          footerVisible || settingsOpen || tocOpen\n470:            ? \"pressy-page-footer--visible\"\n471-            : \"\"\n472-        }`}\n473-      >\n474-        <div class=\"pressy-footer-row\">\n475-          {allChapters && allChapters.length > 0 && (\n--\n1838-\n1839-      {/* Page footer with progress — hidden by default */}\n1840-      <div\n1841-        class={`pressy-page-footer ${\n1842-          footerVisible || settingsOpen || tocOpen\n1843:            ? \"pressy-page-footer--visible\"\n1844-            : \"\"\n1845-        }`}\n1846-      >\n1847-        <div class=\"pressy-progress-bar\">\n1848-          <div\n--\n2082-    flex: 1;\n2083-    padding: 2rem 0;\n2084-  }\n2085-\n2086-  /* ── Scroll reader footer ──────────────────────────────── */\n2087:  .pressy-page-footer--scroll {\n2088-    position: fixed;\n2089-    bottom: 0;\n2090-    left: 0;\n2091-    right: 0;\n2092-    padding: 0.5rem 1.5rem 1rem;\n--\n2098-    z-index: 15;\n2099-    background: var(--color-bg, #ffffff);\n2100-    box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.05);\n2101-  }\n2102-\n2103:  .pressy-page-footer--scroll.pressy-page-footer--visible {\n2104-    transform: translateY(0);\n2105-    opacity: 1;\n2106-  }\n2107-\n2108-  /* Shared footer styles for scroll reader */\n2109:  .pressy-page-footer--scroll .pressy-footer-row {\n2110-    display: flex;\n2111-    align-items: center;\n2112-    justify-content: space-between;\n2113-    gap: 0.5rem;\n2114-  }\n2115-\n2116:  .pressy-page-footer--scroll .pressy-footer-title {\n2117-    font-family: var(--font-heading, system-ui, -apple-system, sans-serif);\n2118-    font-size: 0.75rem;\n2119-    color: var(--color-text-muted, #6c757d);\n2120-    text-decoration: none;\n2121-    overflow: hidden;\n--\n2128-    background: none;\n2129-    cursor: pointer;\n2130-    padding: 0;\n2131-  }\n2132-\n2133:  .pressy-page-footer--scroll .pressy-footer-title:hover {\n2134-    color: var(--color-text, #212529);\n2135-  }\n2136-\n2137:  .pressy-page-footer--scroll .pressy-toc-toggle,\n2138:  .pressy-page-footer--scroll .pressy-settings-toggle {\n2139-    flex-shrink: 0;\n2140-    display: flex;\n2141-    align-items: center;\n2142-    justify-content: center;\n2143-    width: 2rem;\n--\n2149-    border-radius: 0.375rem;\n2150-    transition: color 0.15s, background 0.15s;\n2151-    padding: 0;\n2152-  }\n2153-\n2154:  .pressy-page-footer--scroll .pressy-toc-toggle:hover,\n2155:  .pressy-page-footer--scroll .pressy-settings-toggle:hover {\n2156-    color: var(--color-text, #212529);\n2157-    background: var(--color-bg-subtle, #f8f9fa);\n2158-  }\n2159-\n2160:  .pressy-page-footer--scroll .pressy-settings-panel {\n2161-    overflow: hidden;\n2162-    max-height: 0;\n2163-    opacity: 0;\n2164-    transition: max-height 0.25s ease, opacity 0.2s ease;\n2165-    border-top: 0 solid var(--color-border, #dee2e6);\n2166-  }\n2167-\n2168:  .pressy-page-footer--scroll .pressy-settings-panel--open {\n2169-    max-height: 300px;\n2170-    opacity: 1;\n2171-    border-top-width: 1px;\n2172-    margin-top: 0.5rem;\n2173-    padding-top: 0.75rem;\n2174-  }\n2175-\n2176:  .pressy-page-footer--scroll .pressy-settings-section {\n2177-    margin-bottom: 0.75rem;\n2178-  }\n2179-\n2180:  .pressy-page-footer--scroll .pressy-settings-section:last-child {\n2181-    margin-bottom: 0;\n2182-  }\n2183-\n2184:  .pressy-page-footer--scroll .pressy-settings-label {\n2185-    font-family: var(--font-heading, system-ui, -apple-system, sans-serif);\n2186-    font-size: 0.6875rem;\n2187-    font-weight: 600;\n2188-    text-transform: uppercase;\n2189-    letter-spacing: 0.05em;\n2190-    color: var(--color-text-muted, #6c757d);\n2191-    margin-bottom: 0.5rem;\n2192-    text-align: left;\n2193-  }\n2194-\n2195:  .pressy-page-footer--scroll .pressy-theme-options {\n2196-    display: flex;\n2197-    gap: 0.375rem;\n2198-  }\n2199-\n2200:  .pressy-page-footer--scroll .pressy-theme-btn {\n2201-    flex: 1;\n2202-    display: flex;\n2203-    align-items: center;\n2204-    justify-content: center;\n2205-    gap: 0.25rem;\n--\n2212-    font-size: 0.6875rem;\n2213-    cursor: pointer;\n2214-    transition: border-color 0.15s, background 0.15s;\n2215-  }\n2216-\n2217:  .pressy-page-footer--scroll .pressy-theme-btn:hover {\n2218-    background: var(--color-bg-subtle, #f8f9fa);\n2219-  }\n2220-\n2221:  .pressy-page-footer--scroll .pressy-theme-btn--active {\n2222-    border-color: var(--color-accent, #212529);\n2223-    background: var(--color-bg-subtle, #f8f9fa);\n2224-    font-weight: 600;\n2225-  }\n2226-\n2227:  .pressy-page-footer--scroll .pressy-font-size-controls {\n2228-    display: flex;\n2229-    align-items: center;\n2230-    justify-content: center;\n2231-    gap: 1rem;\n2232-  }\n2233-\n2234:  .pressy-page-footer--scroll .pressy-font-size-btn {\n2235-    display: flex;\n2236-    align-items: center;\n2237-    justify-content: center;\n2238-    width: 2rem;\n2239-    height: 2rem;\n--\n2246-    font-weight: 600;\n2247-    cursor: pointer;\n2248-    transition: border-color 0.15s, background 0.15s;\n2249-  }\n2250-\n2251:  .pressy-page-footer--scroll .pressy-font-size-btn:hover:not(:disabled) {\n2252-    background: var(--color-bg-subtle, #f8f9fa);\n2253-    border-color: var(--color-accent, #212529);\n2254-  }\n2255-\n2256:  .pressy-page-footer--scroll .pressy-font-size-btn:disabled {\n2257-    opacity: 0.3;\n2258-    cursor: default;\n2259-  }\n2260-\n2261:  .pressy-page-footer--scroll .pressy-font-size-value {\n2262-    font-family: var(--font-heading, system-ui, -apple-system, sans-serif);\n2263-    font-size: 0.8125rem;\n2264-    font-weight: 500;\n2265-    color: var(--color-text, #212529);\n2266-    min-width: 3ch;\n--\n2384-    from { transform: translateY(100%); }\n2385-    to { transform: translateY(0); }\n2386-  }\n2387-\n2388-  /* ── Offline icon for scroll reader ─────────────────────── */\n2389:  .pressy-page-footer--scroll .pressy-offline-icon {\n2390-    flex-shrink: 0;\n2391-    display: flex;\n2392-    align-items: center;\n2393-    justify-content: center;\n2394-    position: relative;\n--\n2401-    border-radius: 0.375rem;\n2402-    transition: color 0.15s, background 0.15s;\n2403-    padding: 0;\n2404-  }\n2405-\n2406:  .pressy-page-footer--scroll .pressy-offline-icon:hover {\n2407-    color: var(--color-text, #212529);\n2408-    background: var(--color-bg-subtle, #f8f9fa);\n2409-  }\n2410-\n2411:  .pressy-page-footer--scroll .pressy-offline-icon--cached {\n2412-    color: #16a34a;\n2413-  }\n2414-\n2415:  .pressy-page-footer--scroll .pressy-offline-icon--cached:hover {\n2416-    color: #dc2626;\n2417-  }\n2418-\n2419:  .pressy-page-footer--scroll .pressy-offline-check {\n2420-    position: absolute;\n2421-    bottom: 2px;\n2422-    right: 2px;\n2423-  }\n2424-\n2425:  .pressy-page-footer--scroll .pressy-offline-icon--downloading {\n2426-    cursor: default;\n2427-  }\n2428-\n2429-  @media (prefers-reduced-motion: reduce) {\n2430:    .pressy-page-footer--scroll {\n2431-      transition: none;\n2432-    }\n2433-    .pressy-toc-backdrop--scroll,\n2434-    .pressy-toc-backdrop--scroll .pressy-toc-drawer {\n2435-      animation: none;\n--\n2602-    transition: transform 0.25s ease, opacity 0.25s ease;\n2603-    z-index: 15;\n2604-    background: var(--color-bg, #ffffff);\n2605-  }\n2606-\n2607:  .pressy-page-footer--visible {\n2608-    transform: translateY(0);\n2609-    opacity: 1;\n2610-  }\n2611-\n2612-  /* Progress bar */","numLines":248},"sourceToolAssistantUUID":"ed755bf6-b78f-44fc-a410-06d626a82f44"}
{"parentUuid":"ebeac6b1-d594-49be-a840-31d113c65d8e","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","message":{"model":"claude-opus-4-6","id":"msg_01KX4imre6QAMD4Q2VUiHRMD","type":"message","role":"assistant","content":[{"type":"text","text":"The styles look fine. Let me look at the actual scroll reader component to check if there's a rendering issue. Let me look at the component that wraps the scroll reader to see if something in my edits could have broken the structure."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":3254,"cache_read_input_tokens":58383,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":3254},"output_tokens":1,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CYAu9QUmWB4ANdeXXy2fj","type":"assistant","uuid":"a0e89378-2b8a-4974-80b5-66b9754f8dfe","timestamp":"2026-02-16T01:43:24.680Z"}
{"parentUuid":"a0e89378-2b8a-4974-80b5-66b9754f8dfe","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","message":{"model":"claude-opus-4-6","id":"msg_01KX4imre6QAMD4Q2VUiHRMD","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01RPCu1JeEjyk1WHPsC1XAsA","name":"Read","input":{"file_path":"/Users/blittle/dev/pressy/packages/@pressy/components/src/Reader.tsx","offset":200,"limit":50},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":3254,"cache_read_input_tokens":58383,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":3254},"output_tokens":1,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CYAu9QUmWB4ANdeXXy2fj","type":"assistant","uuid":"0553b3f0-c76c-410e-9ea2-bf7013ea8619","timestamp":"2026-02-16T01:43:25.946Z"}
{"parentUuid":"0553b3f0-c76c-410e-9ea2-bf7013ea8619","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","type":"progress","data":{"type":"hook_progress","hookEvent":"PostToolUse","hookName":"PostToolUse:Read","command":"callback"},"parentToolUseID":"toolu_01RPCu1JeEjyk1WHPsC1XAsA","toolUseID":"toolu_01RPCu1JeEjyk1WHPsC1XAsA","timestamp":"2026-02-16T01:43:25.964Z","uuid":"fcebb9a3-4e89-42d6-a4e3-09db071c8995"}
{"parentUuid":"0553b3f0-c76c-410e-9ea2-bf7013ea8619","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01RPCu1JeEjyk1WHPsC1XAsA","type":"tool_result","content":"   200→      </svg>\n   201→    </button>\n   202→  );\n   203→}\n   204→\n   205→// ── Scroll Reader ────────────────────────────────────────────\n   206→\n   207→interface ScrollReaderProps {\n   208→  children: ComponentChildren;\n   209→  bookTitle?: string;\n   210→  prevChapter?: { slug: string; title: string };\n   211→  nextChapter?: { slug: string; title: string };\n   212→  showDropCap: boolean;\n   213→  onSaveProgress?: (data: ProgressData) => void;\n   214→  onRestoreProgress?: () => Promise<ProgressData | null>;\n   215→  allChapters?: Array<{ slug: string; title: string; wordCount?: number }>;\n   216→  bookBasePath?: string;\n   217→  currentChapterSlug?: string;\n   218→  offlineProps?: OfflineProps;\n   219→}\n   220→\n   221→function ScrollReader({\n   222→  children,\n   223→  bookTitle,\n   224→  prevChapter,\n   225→  nextChapter,\n   226→  showDropCap,\n   227→  onSaveProgress,\n   228→  onRestoreProgress,\n   229→  allChapters,\n   230→  bookBasePath,\n   231→  currentChapterSlug,\n   232→  offlineProps,\n   233→}: ScrollReaderProps) {\n   234→  const saveTimerRef = useRef<ReturnType<typeof setTimeout> | null>(null);\n   235→\n   236→  // Footer visibility\n   237→  const [footerVisible, setFooterVisible] = useState(false);\n   238→  const footerTimerRef = useRef<ReturnType<typeof setTimeout> | null>(null);\n   239→  const [settingsOpen, setSettingsOpen] = useState(false);\n   240→  const [tocOpen, setTocOpen] = useState(false);\n   241→\n   242→  const showFooterTemporarily = useCallback(() => {\n   243→    setFooterVisible(true);\n   244→    if (footerTimerRef.current) clearTimeout(footerTimerRef.current);\n   245→    footerTimerRef.current = setTimeout(() => setFooterVisible(false), 3000);\n   246→  }, []);\n   247→\n   248→  // Settings state\n   249→  const [activeTheme, setActiveTheme] = useState<string>(() => {"}]},"uuid":"bc5a891c-3796-4ef6-8ea9-583060e78aa0","timestamp":"2026-02-16T01:43:25.963Z","toolUseResult":{"type":"text","file":{"filePath":"/Users/blittle/dev/pressy/packages/@pressy/components/src/Reader.tsx","content":"      </svg>\n    </button>\n  );\n}\n\n// ── Scroll Reader ────────────────────────────────────────────\n\ninterface ScrollReaderProps {\n  children: ComponentChildren;\n  bookTitle?: string;\n  prevChapter?: { slug: string; title: string };\n  nextChapter?: { slug: string; title: string };\n  showDropCap: boolean;\n  onSaveProgress?: (data: ProgressData) => void;\n  onRestoreProgress?: () => Promise<ProgressData | null>;\n  allChapters?: Array<{ slug: string; title: string; wordCount?: number }>;\n  bookBasePath?: string;\n  currentChapterSlug?: string;\n  offlineProps?: OfflineProps;\n}\n\nfunction ScrollReader({\n  children,\n  bookTitle,\n  prevChapter,\n  nextChapter,\n  showDropCap,\n  onSaveProgress,\n  onRestoreProgress,\n  allChapters,\n  bookBasePath,\n  currentChapterSlug,\n  offlineProps,\n}: ScrollReaderProps) {\n  const saveTimerRef = useRef<ReturnType<typeof setTimeout> | null>(null);\n\n  // Footer visibility\n  const [footerVisible, setFooterVisible] = useState(false);\n  const footerTimerRef = useRef<ReturnType<typeof setTimeout> | null>(null);\n  const [settingsOpen, setSettingsOpen] = useState(false);\n  const [tocOpen, setTocOpen] = useState(false);\n\n  const showFooterTemporarily = useCallback(() => {\n    setFooterVisible(true);\n    if (footerTimerRef.current) clearTimeout(footerTimerRef.current);\n    footerTimerRef.current = setTimeout(() => setFooterVisible(false), 3000);\n  }, []);\n\n  // Settings state\n  const [activeTheme, setActiveTheme] = useState<string>(() => {","numLines":50,"startLine":200,"totalLines":3014}},"sourceToolAssistantUUID":"0553b3f0-c76c-410e-9ea2-bf7013ea8619"}
{"parentUuid":"bc5a891c-3796-4ef6-8ea9-583060e78aa0","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","message":{"model":"claude-opus-4-6","id":"msg_01UPfbU69sYqJEFFvwDXRT65","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01TXu9a6BZowRtXZZtctpS3M","name":"Read","input":{"file_path":"/Users/blittle/dev/pressy/packages/@pressy/components/src/Reader.tsx","offset":370,"limit":20},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":799,"cache_read_input_tokens":61637,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":799},"output_tokens":25,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CYAu9kRKpiVDpSKokbpKw","type":"assistant","uuid":"181e84e0-c0cb-4e51-b292-8b1ceddf6ce9","timestamp":"2026-02-16T01:43:28.892Z"}
{"parentUuid":"181e84e0-c0cb-4e51-b292-8b1ceddf6ce9","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","type":"progress","data":{"type":"hook_progress","hookEvent":"PostToolUse","hookName":"PostToolUse:Read","command":"callback"},"parentToolUseID":"toolu_01TXu9a6BZowRtXZZtctpS3M","toolUseID":"toolu_01TXu9a6BZowRtXZZtctpS3M","timestamp":"2026-02-16T01:43:28.935Z","uuid":"a8c219e5-0aae-408f-b90a-e26b20da91da"}
{"parentUuid":"181e84e0-c0cb-4e51-b292-8b1ceddf6ce9","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01TXu9a6BZowRtXZZtctpS3M","type":"tool_result","content":"   370→    const handleUnload = () => {\n   371→      onSaveProgress({\n   372→        page: 0,\n   373→        totalPages: 0,\n   374→        scrollPosition: window.scrollY,\n   375→      });\n   376→    };\n   377→\n   378→    window.addEventListener(\"beforeunload\", handleUnload);\n   379→    return () => window.removeEventListener(\"beforeunload\", handleUnload);\n   380→  }, [onSaveProgress]);\n   381→\n   382→  return (\n   383→    <div class=\"pressy-reader\" onClick={handleReaderClick}>\n   384→      <main class=\"pressy-reader-main\">\n   385→        <article\n   386→          class={`pressy-prose ${showDropCap ? \"\" : \"no-drop-cap\"}`}\n   387→          data-drop-cap={showDropCap}\n   388→        >\n   389→          {children}"}]},"uuid":"ac86498d-866b-41f0-8454-123d6724fd89","timestamp":"2026-02-16T01:43:28.934Z","toolUseResult":{"type":"text","file":{"filePath":"/Users/blittle/dev/pressy/packages/@pressy/components/src/Reader.tsx","content":"    const handleUnload = () => {\n      onSaveProgress({\n        page: 0,\n        totalPages: 0,\n        scrollPosition: window.scrollY,\n      });\n    };\n\n    window.addEventListener(\"beforeunload\", handleUnload);\n    return () => window.removeEventListener(\"beforeunload\", handleUnload);\n  }, [onSaveProgress]);\n\n  return (\n    <div class=\"pressy-reader\" onClick={handleReaderClick}>\n      <main class=\"pressy-reader-main\">\n        <article\n          class={`pressy-prose ${showDropCap ? \"\" : \"no-drop-cap\"}`}\n          data-drop-cap={showDropCap}\n        >\n          {children}","numLines":20,"startLine":370,"totalLines":3014}},"sourceToolAssistantUUID":"181e84e0-c0cb-4e51-b292-8b1ceddf6ce9"}
{"parentUuid":"ac86498d-866b-41f0-8454-123d6724fd89","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","message":{"model":"claude-opus-4-6","id":"msg_01BCBdmnVeKDeAammeApYALX","type":"message","role":"assistant","content":[{"type":"text","text":"The scroll reader looks fine — the footer is properly inside the `.pressy-reader` div. My changes only added the home link inside the TOC nav, which shouldn't affect footer visibility at all.\n\nLet me check if this is a paginated reader issue instead. Let me look at that click handler:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":358,"cache_read_input_tokens":62436,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":358},"output_tokens":1,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CYAu9y27EGsLrv8wKeT31","type":"assistant","uuid":"b56ba2b4-0db8-415e-96b8-7349b1444eb0","timestamp":"2026-02-16T01:43:33.099Z"}
{"parentUuid":"b56ba2b4-0db8-415e-96b8-7349b1444eb0","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","message":{"model":"claude-opus-4-6","id":"msg_01BCBdmnVeKDeAammeApYALX","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01BTTdexbmcThRKB3PTLXkiy","name":"Read","input":{"file_path":"/Users/blittle/dev/pressy/packages/@pressy/components/src/Reader.tsx","offset":1300,"limit":100},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":358,"cache_read_input_tokens":62436,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":358},"output_tokens":1,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CYAu9y27EGsLrv8wKeT31","type":"assistant","uuid":"cfbfb5a9-4052-4c96-8b57-c1950141469d","timestamp":"2026-02-16T01:43:33.805Z"}
{"parentUuid":"cfbfb5a9-4052-4c96-8b57-c1950141469d","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","type":"progress","data":{"type":"hook_progress","hookEvent":"PostToolUse","hookName":"PostToolUse:Read","command":"callback"},"parentToolUseID":"toolu_01BTTdexbmcThRKB3PTLXkiy","toolUseID":"toolu_01BTTdexbmcThRKB3PTLXkiy","timestamp":"2026-02-16T01:43:33.822Z","uuid":"eb64ec26-4957-4e14-8671-67999b2ad8da"}
{"parentUuid":"cfbfb5a9-4052-4c96-8b57-c1950141469d","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01BTTdexbmcThRKB3PTLXkiy","type":"tool_result","content":"  1300→  // Double-tap fullscreen (mobile middle-third)\n  1301→  const lastMiddleTapRef = useRef(0);\n  1302→  const middleTapTimerRef = useRef<ReturnType<typeof setTimeout> | null>(null);\n  1303→\n  1304→  const toggleFullscreen = useCallback(() => {\n  1305→    if (document.fullscreenElement) {\n  1306→      document.exitFullscreen();\n  1307→    } else {\n  1308→      document.documentElement.requestFullscreen().catch(() => {\n  1309→        // Fullscreen not supported or denied\n  1310→      });\n  1311→    }\n  1312→  }, []);\n  1313→\n  1314→  // Whether the device supports hover (i.e. desktop with a mouse).\n  1315→  // Touch-only devices use swipe for page turns; tapping just toggles the footer.\n  1316→  const isTouchDevice =\n  1317→    typeof window !== \"undefined\" && window.matchMedia(\"(hover: none)\").matches;\n  1318→\n  1319→  // Click handler: on desktop, edge clicks turn pages and middle clicks\n  1320→  // toggle footer / double-click fullscreen. On touch devices, any tap\n  1321→  // simply toggles the footer — swiping handles all page navigation.\n  1322→  const handleContainerClick = useCallback(\n  1323→    (e: MouseEvent) => {\n  1324→      const target = e.target as HTMLElement;\n  1325→\n  1326→      // Clicks inside panels or on interactive elements — ignore\n  1327→      if (\n  1328→        target.closest(\n  1329→          \".pressy-settings-panel, .pressy-settings-toggle, .pressy-toc-drawer, .pressy-toc-toggle\"\n  1330→        )\n  1331→      )\n  1332→        return;\n  1333→      if (target.closest('a, button, input, select, textarea, [role=\"button\"]'))\n  1334→        return;\n  1335→\n  1336→      // If settings or TOC panel is open, close it on any outside click\n  1337→      if (settingsOpen || tocOpen) {\n  1338→        setSettingsOpen(false);\n  1339→        setTocOpen(false);\n  1340→        return;\n  1341→      }\n  1342→\n  1343→      // Touch devices: tap anywhere toggles the footer, nothing else\n  1344→      if (isTouchDevice) {\n  1345→        if (footerVisible) {\n  1346→          setFooterVisible(false);\n  1347→          if (footerTimerRef.current) clearTimeout(footerTimerRef.current);\n  1348→        } else {\n  1349→          showFooterTemporarily();\n  1350→        }\n  1351→        return;\n  1352→      }\n  1353→\n  1354→      // Desktop: edge clicks turn pages, middle clicks toggle footer / fullscreen\n  1355→      const container = containerRef.current;\n  1356→      if (!container) return;\n  1357→\n  1358→      const rect = container.getBoundingClientRect();\n  1359→      const x = e.clientX - rect.left;\n  1360→      const edgeZone = rect.width * 0.15;\n  1361→\n  1362→      if (x < edgeZone) {\n  1363→        goPrev();\n  1364→      } else if (x > rect.width - edgeZone) {\n  1365→        goNext();\n  1366→      } else {\n  1367→        // Middle third — single click toggles footer, double click toggles fullscreen\n  1368→        const now = Date.now();\n  1369→        const timeSinceLastTap = now - lastMiddleTapRef.current;\n  1370→        lastMiddleTapRef.current = now;\n  1371→\n  1372→        if (timeSinceLastTap < 300) {\n  1373→          if (middleTapTimerRef.current)\n  1374→            clearTimeout(middleTapTimerRef.current);\n  1375→          toggleFullscreen();\n  1376→        } else {\n  1377→          if (middleTapTimerRef.current)\n  1378→            clearTimeout(middleTapTimerRef.current);\n  1379→          middleTapTimerRef.current = setTimeout(() => {\n  1380→            if (footerVisible) {\n  1381→              setFooterVisible(false);\n  1382→              if (footerTimerRef.current) clearTimeout(footerTimerRef.current);\n  1383→            } else {\n  1384→              showFooterTemporarily();\n  1385→            }\n  1386→          }, 300);\n  1387→        }\n  1388→      }\n  1389→    },\n  1390→    [\n  1391→      goNext,\n  1392→      goPrev,\n  1393→      footerVisible,\n  1394→      isTouchDevice,\n  1395→      settingsOpen,\n  1396→      tocOpen,\n  1397→      showFooterTemporarily,\n  1398→      toggleFullscreen,\n  1399→    ]"}]},"uuid":"791735cb-7066-4c9b-a605-696f205a315f","timestamp":"2026-02-16T01:43:33.821Z","toolUseResult":{"type":"text","file":{"filePath":"/Users/blittle/dev/pressy/packages/@pressy/components/src/Reader.tsx","content":"  // Double-tap fullscreen (mobile middle-third)\n  const lastMiddleTapRef = useRef(0);\n  const middleTapTimerRef = useRef<ReturnType<typeof setTimeout> | null>(null);\n\n  const toggleFullscreen = useCallback(() => {\n    if (document.fullscreenElement) {\n      document.exitFullscreen();\n    } else {\n      document.documentElement.requestFullscreen().catch(() => {\n        // Fullscreen not supported or denied\n      });\n    }\n  }, []);\n\n  // Whether the device supports hover (i.e. desktop with a mouse).\n  // Touch-only devices use swipe for page turns; tapping just toggles the footer.\n  const isTouchDevice =\n    typeof window !== \"undefined\" && window.matchMedia(\"(hover: none)\").matches;\n\n  // Click handler: on desktop, edge clicks turn pages and middle clicks\n  // toggle footer / double-click fullscreen. On touch devices, any tap\n  // simply toggles the footer — swiping handles all page navigation.\n  const handleContainerClick = useCallback(\n    (e: MouseEvent) => {\n      const target = e.target as HTMLElement;\n\n      // Clicks inside panels or on interactive elements — ignore\n      if (\n        target.closest(\n          \".pressy-settings-panel, .pressy-settings-toggle, .pressy-toc-drawer, .pressy-toc-toggle\"\n        )\n      )\n        return;\n      if (target.closest('a, button, input, select, textarea, [role=\"button\"]'))\n        return;\n\n      // If settings or TOC panel is open, close it on any outside click\n      if (settingsOpen || tocOpen) {\n        setSettingsOpen(false);\n        setTocOpen(false);\n        return;\n      }\n\n      // Touch devices: tap anywhere toggles the footer, nothing else\n      if (isTouchDevice) {\n        if (footerVisible) {\n          setFooterVisible(false);\n          if (footerTimerRef.current) clearTimeout(footerTimerRef.current);\n        } else {\n          showFooterTemporarily();\n        }\n        return;\n      }\n\n      // Desktop: edge clicks turn pages, middle clicks toggle footer / fullscreen\n      const container = containerRef.current;\n      if (!container) return;\n\n      const rect = container.getBoundingClientRect();\n      const x = e.clientX - rect.left;\n      const edgeZone = rect.width * 0.15;\n\n      if (x < edgeZone) {\n        goPrev();\n      } else if (x > rect.width - edgeZone) {\n        goNext();\n      } else {\n        // Middle third — single click toggles footer, double click toggles fullscreen\n        const now = Date.now();\n        const timeSinceLastTap = now - lastMiddleTapRef.current;\n        lastMiddleTapRef.current = now;\n\n        if (timeSinceLastTap < 300) {\n          if (middleTapTimerRef.current)\n            clearTimeout(middleTapTimerRef.current);\n          toggleFullscreen();\n        } else {\n          if (middleTapTimerRef.current)\n            clearTimeout(middleTapTimerRef.current);\n          middleTapTimerRef.current = setTimeout(() => {\n            if (footerVisible) {\n              setFooterVisible(false);\n              if (footerTimerRef.current) clearTimeout(footerTimerRef.current);\n            } else {\n              showFooterTemporarily();\n            }\n          }, 300);\n        }\n      }\n    },\n    [\n      goNext,\n      goPrev,\n      footerVisible,\n      isTouchDevice,\n      settingsOpen,\n      tocOpen,\n      showFooterTemporarily,\n      toggleFullscreen,\n    ]","numLines":100,"startLine":1300,"totalLines":3014}},"sourceToolAssistantUUID":"cfbfb5a9-4052-4c96-8b57-c1950141469d"}
{"parentUuid":"791735cb-7066-4c9b-a605-696f205a315f","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","message":{"model":"claude-opus-4-6","id":"msg_01ESrpXognyroW9B4UiqFMM5","type":"message","role":"assistant","content":[{"type":"text","text":"That all looks fine. The click handlers are working (user confirms the class gets set). The issue is the content not being *visible*. Let me look at the paginated reader's footer structure:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":1538,"cache_read_input_tokens":62794,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":1538},"output_tokens":1,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CYAuAKvTi28La6CsjJfY8","type":"assistant","uuid":"98a1c7d6-5d2d-4ca2-b4dc-78daa78752d9","timestamp":"2026-02-16T01:43:37.818Z"}
{"parentUuid":"98a1c7d6-5d2d-4ca2-b4dc-78daa78752d9","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","message":{"model":"claude-opus-4-6","id":"msg_01ESrpXognyroW9B4UiqFMM5","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01TdEUsedyvvHapUuUVMPcvD","name":"Read","input":{"file_path":"/Users/blittle/dev/pressy/packages/@pressy/components/src/Reader.tsx","offset":1838,"limit":80},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":1538,"cache_read_input_tokens":62794,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":1538},"output_tokens":1,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CYAuAKvTi28La6CsjJfY8","type":"assistant","uuid":"4d445ff6-f59b-4f34-b0e1-833a7c24503e","timestamp":"2026-02-16T01:43:38.953Z"}
{"parentUuid":"4d445ff6-f59b-4f34-b0e1-833a7c24503e","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","type":"progress","data":{"type":"hook_progress","hookEvent":"PostToolUse","hookName":"PostToolUse:Read","command":"callback"},"parentToolUseID":"toolu_01TdEUsedyvvHapUuUVMPcvD","toolUseID":"toolu_01TdEUsedyvvHapUuUVMPcvD","timestamp":"2026-02-16T01:43:39.006Z","uuid":"803602a2-1758-4195-baa4-06b2fc56b1be"}
{"parentUuid":"4d445ff6-f59b-4f34-b0e1-833a7c24503e","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01TdEUsedyvvHapUuUVMPcvD","type":"tool_result","content":"  1838→\n  1839→      {/* Page footer with progress — hidden by default */}\n  1840→      <div\n  1841→        class={`pressy-page-footer ${\n  1842→          footerVisible || settingsOpen || tocOpen\n  1843→            ? \"pressy-page-footer--visible\"\n  1844→            : \"\"\n  1845→        }`}\n  1846→      >\n  1847→        <div class=\"pressy-progress-bar\">\n  1848→          <div\n  1849→            class=\"pressy-progress-fill\"\n  1850→            style={{ width: `${progressPercent}%` }}\n  1851→          />\n  1852→        </div>\n  1853→        <div class=\"pressy-footer-row\">\n  1854→          {allChapters && allChapters.length > 0 && (\n  1855→            <button\n  1856→              class=\"pressy-toc-toggle\"\n  1857→              onClick={(e: MouseEvent) => {\n  1858→                e.stopPropagation();\n  1859→                setSettingsOpen(false);\n  1860→                setTocOpen(!tocOpen);\n  1861→              }}\n  1862→              aria-label=\"Table of contents\"\n  1863→            >\n  1864→              <svg\n  1865→                viewBox=\"0 0 24 24\"\n  1866→                fill=\"none\"\n  1867→                stroke=\"currentColor\"\n  1868→                stroke-width=\"1.5\"\n  1869→                stroke-linecap=\"round\"\n  1870→                stroke-linejoin=\"round\"\n  1871→                width=\"18\"\n  1872→                height=\"18\"\n  1873→              >\n  1874→                <line x1=\"3\" y1=\"6\" x2=\"21\" y2=\"6\" />\n  1875→                <line x1=\"3\" y1=\"12\" x2=\"21\" y2=\"12\" />\n  1876→                <line x1=\"3\" y1=\"18\" x2=\"21\" y2=\"18\" />\n  1877→              </svg>\n  1878→            </button>\n  1879→          )}\n  1880→          {bookTitle && (\n  1881→            <button\n  1882→              class=\"pressy-footer-title\"\n  1883→              onClick={(e: MouseEvent) => {\n  1884→                e.stopPropagation();\n  1885→                if (allChapters && allChapters.length > 0) {\n  1886→                  setSettingsOpen(false);\n  1887→                  setTocOpen(!tocOpen);\n  1888→                }\n  1889→              }}\n  1890→            >\n  1891→              {bookTitle}\n  1892→            </button>\n  1893→          )}\n  1894→          <OfflineFooterIcon offlineProps={offlineProps} />\n  1895→          <button\n  1896→            class=\"pressy-settings-toggle\"\n  1897→            onClick={(e: MouseEvent) => {\n  1898→              e.stopPropagation();\n  1899→              setTocOpen(false);\n  1900→              setSettingsOpen(!settingsOpen);\n  1901→            }}\n  1902→            aria-label=\"Settings\"\n  1903→          >\n  1904→            <svg\n  1905→              viewBox=\"0 0 24 24\"\n  1906→              fill=\"none\"\n  1907→              stroke=\"currentColor\"\n  1908→              stroke-width=\"1.5\"\n  1909→              stroke-linecap=\"round\"\n  1910→              stroke-linejoin=\"round\"\n  1911→              width=\"18\"\n  1912→              height=\"18\"\n  1913→            >\n  1914→              <circle cx=\"12\" cy=\"12\" r=\"3\" />\n  1915→              <path d=\"M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z\" />\n  1916→            </svg>\n  1917→          </button>"}]},"uuid":"8a84c27f-680a-4309-848e-496a00044be9","timestamp":"2026-02-16T01:43:39.006Z","toolUseResult":{"type":"text","file":{"filePath":"/Users/blittle/dev/pressy/packages/@pressy/components/src/Reader.tsx","content":"\n      {/* Page footer with progress — hidden by default */}\n      <div\n        class={`pressy-page-footer ${\n          footerVisible || settingsOpen || tocOpen\n            ? \"pressy-page-footer--visible\"\n            : \"\"\n        }`}\n      >\n        <div class=\"pressy-progress-bar\">\n          <div\n            class=\"pressy-progress-fill\"\n            style={{ width: `${progressPercent}%` }}\n          />\n        </div>\n        <div class=\"pressy-footer-row\">\n          {allChapters && allChapters.length > 0 && (\n            <button\n              class=\"pressy-toc-toggle\"\n              onClick={(e: MouseEvent) => {\n                e.stopPropagation();\n                setSettingsOpen(false);\n                setTocOpen(!tocOpen);\n              }}\n              aria-label=\"Table of contents\"\n            >\n              <svg\n                viewBox=\"0 0 24 24\"\n                fill=\"none\"\n                stroke=\"currentColor\"\n                stroke-width=\"1.5\"\n                stroke-linecap=\"round\"\n                stroke-linejoin=\"round\"\n                width=\"18\"\n                height=\"18\"\n              >\n                <line x1=\"3\" y1=\"6\" x2=\"21\" y2=\"6\" />\n                <line x1=\"3\" y1=\"12\" x2=\"21\" y2=\"12\" />\n                <line x1=\"3\" y1=\"18\" x2=\"21\" y2=\"18\" />\n              </svg>\n            </button>\n          )}\n          {bookTitle && (\n            <button\n              class=\"pressy-footer-title\"\n              onClick={(e: MouseEvent) => {\n                e.stopPropagation();\n                if (allChapters && allChapters.length > 0) {\n                  setSettingsOpen(false);\n                  setTocOpen(!tocOpen);\n                }\n              }}\n            >\n              {bookTitle}\n            </button>\n          )}\n          <OfflineFooterIcon offlineProps={offlineProps} />\n          <button\n            class=\"pressy-settings-toggle\"\n            onClick={(e: MouseEvent) => {\n              e.stopPropagation();\n              setTocOpen(false);\n              setSettingsOpen(!settingsOpen);\n            }}\n            aria-label=\"Settings\"\n          >\n            <svg\n              viewBox=\"0 0 24 24\"\n              fill=\"none\"\n              stroke=\"currentColor\"\n              stroke-width=\"1.5\"\n              stroke-linecap=\"round\"\n              stroke-linejoin=\"round\"\n              width=\"18\"\n              height=\"18\"\n            >\n              <circle cx=\"12\" cy=\"12\" r=\"3\" />\n              <path d=\"M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z\" />\n            </svg>\n          </button>","numLines":80,"startLine":1838,"totalLines":3014}},"sourceToolAssistantUUID":"4d445ff6-f59b-4f34-b0e1-833a7c24503e"}
{"parentUuid":"8a84c27f-680a-4309-848e-496a00044be9","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","message":{"model":"claude-opus-4-6","id":"msg_01RESsDnHxLHHu6D5FJiPdS4","type":"message","role":"assistant","content":[{"type":"text","text":"The footer structure looks intact. Since the user says the class is properly getting set but the content isn't visible, this is likely a CSS issue — not something my TOC changes caused (those only add elements *inside* the TOC drawer). Let me look at the paginated footer container styles more carefully:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":1801,"cache_read_input_tokens":64332,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":1801},"output_tokens":1,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CYAuAi7SixhNpE1nevCSd","type":"assistant","uuid":"64e56f44-a548-41c1-9cf1-8ffd95394a83","timestamp":"2026-02-16T01:43:43.488Z"}
{"parentUuid":"64e56f44-a548-41c1-9cf1-8ffd95394a83","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","message":{"model":"claude-opus-4-6","id":"msg_01RESsDnHxLHHu6D5FJiPdS4","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_013NoLk4ZPvbJxCBUvjrrRcY","name":"Read","input":{"file_path":"/Users/blittle/dev/pressy/packages/@pressy/components/src/Reader.tsx","offset":2580,"limit":80},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":1801,"cache_read_input_tokens":64332,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":1801},"output_tokens":1,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CYAuAi7SixhNpE1nevCSd","type":"assistant","uuid":"45363837-ee40-4ebe-b2b5-176a23359e60","timestamp":"2026-02-16T01:43:44.682Z"}
{"parentUuid":"45363837-ee40-4ebe-b2b5-176a23359e60","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","type":"progress","data":{"type":"hook_progress","hookEvent":"PostToolUse","hookName":"PostToolUse:Read","command":"callback"},"parentToolUseID":"toolu_013NoLk4ZPvbJxCBUvjrrRcY","toolUseID":"toolu_013NoLk4ZPvbJxCBUvjrrRcY","timestamp":"2026-02-16T01:43:44.695Z","uuid":"debcbe8d-9705-4786-a706-1fdbb517b77a"}
{"parentUuid":"45363837-ee40-4ebe-b2b5-176a23359e60","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_013NoLk4ZPvbJxCBUvjrrRcY","type":"tool_result","content":"  2580→\n  2581→  .pressy-chapter-hint-text {\n  2582→    overflow: hidden;\n  2583→    text-overflow: ellipsis;\n  2584→  }\n  2585→\n  2586→  @keyframes pressy-hint-fade-in {\n  2587→    from { opacity: 0; transform: translateY(-50%) scale(0.95); }\n  2588→    to { opacity: 1; transform: translateY(-50%) scale(1); }\n  2589→  }\n  2590→\n  2591→  /* ── Page footer ───────────────────────────────────────────── */\n  2592→  .pressy-page-footer {\n  2593→    position: absolute;\n  2594→    bottom: 0;\n  2595→    left: 0;\n  2596→    right: 0;\n  2597→    padding: 0.5rem 1.5rem 1rem;\n  2598→    text-align: center;\n  2599→    user-select: none;\n  2600→    transform: translateY(100%);\n  2601→    opacity: 0;\n  2602→    transition: transform 0.25s ease, opacity 0.25s ease;\n  2603→    z-index: 15;\n  2604→    background: var(--color-bg, #ffffff);\n  2605→  }\n  2606→\n  2607→  .pressy-page-footer--visible {\n  2608→    transform: translateY(0);\n  2609→    opacity: 1;\n  2610→  }\n  2611→\n  2612→  /* Progress bar */\n  2613→  .pressy-progress-bar {\n  2614→    height: 3px;\n  2615→    background: var(--color-border, #dee2e6);\n  2616→    border-radius: 1.5px;\n  2617→    overflow: hidden;\n  2618→  }\n  2619→\n  2620→  .pressy-progress-fill {\n  2621→    height: 100%;\n  2622→    background: var(--color-accent, #212529);\n  2623→    border-radius: 1.5px;\n  2624→    transition: width 0.3s ease;\n  2625→  }\n  2626→\n  2627→  /* ── Footer row (title + gear) ──────────────────────────── */\n  2628→  .pressy-footer-row {\n  2629→    display: flex;\n  2630→    align-items: center;\n  2631→    justify-content: space-between;\n  2632→    margin-top: 0.5rem;\n  2633→    gap: 0.5rem;\n  2634→  }\n  2635→\n  2636→  .pressy-footer-title {\n  2637→    font-family: var(--font-heading, system-ui, -apple-system, sans-serif);\n  2638→    font-size: 0.75rem;\n  2639→    color: var(--color-text-muted, #6c757d);\n  2640→    text-decoration: none;\n  2641→    overflow: hidden;\n  2642→    text-overflow: ellipsis;\n  2643→    white-space: nowrap;\n  2644→    min-width: 0;\n  2645→    flex: 1;\n  2646→    text-align: left;\n  2647→    border: none;\n  2648→    background: none;\n  2649→    cursor: pointer;\n  2650→    padding: 0;\n  2651→  }\n  2652→\n  2653→  .pressy-footer-title:hover {\n  2654→    color: var(--color-text, #212529);\n  2655→  }\n  2656→\n  2657→  /* ── TOC toggle button ──────────────────────────────────── */\n  2658→  .pressy-toc-toggle {\n  2659→    flex-shrink: 0;"}]},"uuid":"2da76fd7-dd81-45fd-947f-ac85117fbceb","timestamp":"2026-02-16T01:43:44.694Z","toolUseResult":{"type":"text","file":{"filePath":"/Users/blittle/dev/pressy/packages/@pressy/components/src/Reader.tsx","content":"\n  .pressy-chapter-hint-text {\n    overflow: hidden;\n    text-overflow: ellipsis;\n  }\n\n  @keyframes pressy-hint-fade-in {\n    from { opacity: 0; transform: translateY(-50%) scale(0.95); }\n    to { opacity: 1; transform: translateY(-50%) scale(1); }\n  }\n\n  /* ── Page footer ───────────────────────────────────────────── */\n  .pressy-page-footer {\n    position: absolute;\n    bottom: 0;\n    left: 0;\n    right: 0;\n    padding: 0.5rem 1.5rem 1rem;\n    text-align: center;\n    user-select: none;\n    transform: translateY(100%);\n    opacity: 0;\n    transition: transform 0.25s ease, opacity 0.25s ease;\n    z-index: 15;\n    background: var(--color-bg, #ffffff);\n  }\n\n  .pressy-page-footer--visible {\n    transform: translateY(0);\n    opacity: 1;\n  }\n\n  /* Progress bar */\n  .pressy-progress-bar {\n    height: 3px;\n    background: var(--color-border, #dee2e6);\n    border-radius: 1.5px;\n    overflow: hidden;\n  }\n\n  .pressy-progress-fill {\n    height: 100%;\n    background: var(--color-accent, #212529);\n    border-radius: 1.5px;\n    transition: width 0.3s ease;\n  }\n\n  /* ── Footer row (title + gear) ──────────────────────────── */\n  .pressy-footer-row {\n    display: flex;\n    align-items: center;\n    justify-content: space-between;\n    margin-top: 0.5rem;\n    gap: 0.5rem;\n  }\n\n  .pressy-footer-title {\n    font-family: var(--font-heading, system-ui, -apple-system, sans-serif);\n    font-size: 0.75rem;\n    color: var(--color-text-muted, #6c757d);\n    text-decoration: none;\n    overflow: hidden;\n    text-overflow: ellipsis;\n    white-space: nowrap;\n    min-width: 0;\n    flex: 1;\n    text-align: left;\n    border: none;\n    background: none;\n    cursor: pointer;\n    padding: 0;\n  }\n\n  .pressy-footer-title:hover {\n    color: var(--color-text, #212529);\n  }\n\n  /* ── TOC toggle button ──────────────────────────────────── */\n  .pressy-toc-toggle {\n    flex-shrink: 0;","numLines":80,"startLine":2580,"totalLines":3014}},"sourceToolAssistantUUID":"45363837-ee40-4ebe-b2b5-176a23359e60"}
{"parentUuid":"2da76fd7-dd81-45fd-947f-ac85117fbceb","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","message":{"model":"claude-opus-4-6","id":"msg_014rRELHYhUjYqcBVRDrUZ3Y","type":"message","role":"assistant","content":[{"type":"text","text":"The paginated footer uses `position: absolute` and the parent needs `overflow: visible` or at least not `overflow: hidden` for it to show when translating from `translateY(100%)` back up. Let me check the paginated reader container for any `overflow` setting."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":1220,"cache_read_input_tokens":66133,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":1220},"output_tokens":1,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CYAuB8Mxv315LCXt3eTUx","type":"assistant","uuid":"2d16b075-7285-4ad7-b25b-b6e50754e75a","timestamp":"2026-02-16T01:43:48.624Z"}
{"parentUuid":"2d16b075-7285-4ad7-b25b-b6e50754e75a","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","message":{"model":"claude-opus-4-6","id":"msg_014rRELHYhUjYqcBVRDrUZ3Y","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_018ezkWrT7ZMABcLPDU7kwDD","name":"Grep","input":{"pattern":"pressy-paginated-container|pressy-page-container|overflow","path":"/Users/blittle/dev/pressy/packages/@pressy/components/src/Reader.tsx","output_mode":"content","-n":true,"head_limit":40},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":1220,"cache_read_input_tokens":66133,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":1220},"output_tokens":1,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CYAuB8Mxv315LCXt3eTUx","type":"assistant","uuid":"276cdb4e-f966-466b-8cc5-af59c1297851","timestamp":"2026-02-16T01:43:50.774Z"}
{"parentUuid":"276cdb4e-f966-466b-8cc5-af59c1297851","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","type":"progress","data":{"type":"hook_progress","hookEvent":"PostToolUse","hookName":"PostToolUse:Grep","command":"callback"},"parentToolUseID":"toolu_018ezkWrT7ZMABcLPDU7kwDD","toolUseID":"toolu_018ezkWrT7ZMABcLPDU7kwDD","timestamp":"2026-02-16T01:43:51.057Z","uuid":"180a7915-3b63-4002-ac1c-e8ea6058b93e"}
{"parentUuid":"276cdb4e-f966-466b-8cc5-af59c1297851","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_018ezkWrT7ZMABcLPDU7kwDD","type":"tool_result","content":"2121:    overflow: hidden;\n2122:    text-overflow: ellipsis;\n2161:    overflow: hidden;\n2328:    overflow-y: auto;\n2450:    overflow: hidden;\n2454:  /* Viewport clips overflow and shows one page at a time.\n2458:    overflow: hidden;\n2468:     Each column = one \"page\". Content overflows horizontally into new columns.\n2475:    overflow: visible;\n2563:    overflow: hidden;\n2564:    text-overflow: ellipsis;\n2582:    overflow: hidden;\n2583:    text-overflow: ellipsis;\n2617:    overflow: hidden;\n2641:    overflow: hidden;\n2642:    text-overflow: ellipsis;\n2702:    overflow: hidden;\n2885:    overflow-y: auto;\n\n[Showing results with pagination = limit: 40, offset: 0]"}]},"uuid":"9db25dc9-dc34-4f63-bd8b-e53b9575af28","timestamp":"2026-02-16T01:43:51.056Z","toolUseResult":{"mode":"content","numFiles":0,"filenames":[],"content":"2121:    overflow: hidden;\n2122:    text-overflow: ellipsis;\n2161:    overflow: hidden;\n2328:    overflow-y: auto;\n2450:    overflow: hidden;\n2454:  /* Viewport clips overflow and shows one page at a time.\n2458:    overflow: hidden;\n2468:     Each column = one \"page\". Content overflows horizontally into new columns.\n2475:    overflow: visible;\n2563:    overflow: hidden;\n2564:    text-overflow: ellipsis;\n2582:    overflow: hidden;\n2583:    text-overflow: ellipsis;\n2617:    overflow: hidden;\n2641:    overflow: hidden;\n2642:    text-overflow: ellipsis;\n2702:    overflow: hidden;\n2885:    overflow-y: auto;","numLines":18,"appliedLimit":40},"sourceToolAssistantUUID":"276cdb4e-f966-466b-8cc5-af59c1297851"}
{"parentUuid":"9db25dc9-dc34-4f63-bd8b-e53b9575af28","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","message":{"model":"claude-opus-4-6","id":"msg_015GHhgsyEdNFidK2f2hmT1g","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_018fcFeedCHw4of6UyBqRrWj","name":"Read","input":{"file_path":"/Users/blittle/dev/pressy/packages/@pressy/components/src/Reader.tsx","offset":2445,"limit":40},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":457,"cache_read_input_tokens":67353,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":457},"output_tokens":25,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CYAuBbbJwQU5ksRCyeDSs","type":"assistant","uuid":"c95b994c-3d0d-478b-acf0-4358f7336f08","timestamp":"2026-02-16T01:43:53.933Z"}
{"parentUuid":"c95b994c-3d0d-478b-acf0-4358f7336f08","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","type":"progress","data":{"type":"hook_progress","hookEvent":"PostToolUse","hookName":"PostToolUse:Read","command":"callback"},"parentToolUseID":"toolu_018fcFeedCHw4of6UyBqRrWj","toolUseID":"toolu_018fcFeedCHw4of6UyBqRrWj","timestamp":"2026-02-16T01:43:53.993Z","uuid":"1fab8771-df43-4353-93e0-2ffe7845e261"}
{"parentUuid":"c95b994c-3d0d-478b-acf0-4358f7336f08","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_018fcFeedCHw4of6UyBqRrWj","type":"tool_result","content":"  2445→  .pressy-reader--paginated {\n  2446→    height: 100vh;\n  2447→    height: 100dvh;\n  2448→    display: flex;\n  2449→    flex-direction: column;\n  2450→    overflow: hidden;\n  2451→    position: relative;\n  2452→  }\n  2453→\n  2454→  /* Viewport clips overflow and shows one page at a time.\n  2455→     Vertical padding gives consistent top/bottom margins on every page. */\n  2456→  .pressy-paginated-viewport {\n  2457→    flex: 1;\n  2458→    overflow: hidden;\n  2459→    position: relative;\n  2460→    min-height: 0;\n  2461→    padding-block: 2rem;\n  2462→    box-sizing: border-box;\n  2463→    text-wrap: pretty;\n  2464→  }\n  2465→\n  2466→  /* Article uses CSS multi-column layout for pagination.\n  2467→     column-width is set dynamically via JS to match viewport width.\n  2468→     Each column = one \"page\". Content overflows horizontally into new columns.\n  2469→     translateX controlled by JS — transitions set dynamically during drag vs snap. */\n  2470→  .pressy-prose--paginated {\n  2471→    max-width: none;\n  2472→    height: 100%;\n  2473→    column-fill: auto;\n  2474→    column-gap: 0;\n  2475→    overflow: visible;\n  2476→    box-sizing: border-box;\n  2477→    padding: 0;\n  2478→    will-change: transform;\n  2479→    /* Transition is set dynamically: none during drag, ease-out on snap */\n  2480→  }\n  2481→\n  2482→  /* Center content elements within each column/page at a readable width */\n  2483→  .pressy-prose--paginated > * {\n  2484→    max-width: min(65ch, calc(100% - 3rem));"}]},"uuid":"41382a71-0868-4cde-9c54-55e4aa3da913","timestamp":"2026-02-16T01:43:53.992Z","toolUseResult":{"type":"text","file":{"filePath":"/Users/blittle/dev/pressy/packages/@pressy/components/src/Reader.tsx","content":"  .pressy-reader--paginated {\n    height: 100vh;\n    height: 100dvh;\n    display: flex;\n    flex-direction: column;\n    overflow: hidden;\n    position: relative;\n  }\n\n  /* Viewport clips overflow and shows one page at a time.\n     Vertical padding gives consistent top/bottom margins on every page. */\n  .pressy-paginated-viewport {\n    flex: 1;\n    overflow: hidden;\n    position: relative;\n    min-height: 0;\n    padding-block: 2rem;\n    box-sizing: border-box;\n    text-wrap: pretty;\n  }\n\n  /* Article uses CSS multi-column layout for pagination.\n     column-width is set dynamically via JS to match viewport width.\n     Each column = one \"page\". Content overflows horizontally into new columns.\n     translateX controlled by JS — transitions set dynamically during drag vs snap. */\n  .pressy-prose--paginated {\n    max-width: none;\n    height: 100%;\n    column-fill: auto;\n    column-gap: 0;\n    overflow: visible;\n    box-sizing: border-box;\n    padding: 0;\n    will-change: transform;\n    /* Transition is set dynamically: none during drag, ease-out on snap */\n  }\n\n  /* Center content elements within each column/page at a readable width */\n  .pressy-prose--paginated > * {\n    max-width: min(65ch, calc(100% - 3rem));","numLines":40,"startLine":2445,"totalLines":3014}},"sourceToolAssistantUUID":"c95b994c-3d0d-478b-acf0-4358f7336f08"}
{"parentUuid":"41382a71-0868-4cde-9c54-55e4aa3da913","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","message":{"model":"claude-opus-4-6","id":"msg_01TcQLV4SdgoL615w4Pn6FhV","type":"message","role":"assistant","content":[{"type":"text","text":"There it is — `.pressy-reader--paginated` has `overflow: hidden`. The footer is `position: absolute` with `bottom: 0` and initially `transform: translateY(100%)`, which pushes it fully below the container. When it becomes visible with `translateY(0)`, it should sit at the bottom. But with `overflow: hidden` on the parent, the footer would be clipped when translated down.\n\nWait — actually, `translateY(100%)` would push it below the container, and `overflow: hidden` would clip it. When it becomes visible (`translateY(0)`), it should be at `bottom: 0` inside the container, which should be fine. The issue is something else.\n\nLet me look at the actual paginated reader return structure:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":654,"cache_read_input_tokens":67810,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":654},"output_tokens":1,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CYAuBpfNRFuSG1TJuPdhR","type":"assistant","uuid":"051c2527-d780-4b1a-a046-02e32990e73c","timestamp":"2026-02-16T01:44:00.805Z"}
{"parentUuid":"051c2527-d780-4b1a-a046-02e32990e73c","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","message":{"model":"claude-opus-4-6","id":"msg_01TcQLV4SdgoL615w4Pn6FhV","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01FZu6mw7RLe97QgXvkt8PKU","name":"Read","input":{"file_path":"/Users/blittle/dev/pressy/packages/@pressy/components/src/Reader.tsx","offset":1680,"limit":85},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":654,"cache_read_input_tokens":67810,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":654},"output_tokens":1,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CYAuBpfNRFuSG1TJuPdhR","type":"assistant","uuid":"fee45369-94fb-428f-83ba-284ea945a689","timestamp":"2026-02-16T01:44:01.502Z"}
{"parentUuid":"fee45369-94fb-428f-83ba-284ea945a689","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","type":"progress","data":{"type":"hook_progress","hookEvent":"PostToolUse","hookName":"PostToolUse:Read","command":"callback"},"parentToolUseID":"toolu_01FZu6mw7RLe97QgXvkt8PKU","toolUseID":"toolu_01FZu6mw7RLe97QgXvkt8PKU","timestamp":"2026-02-16T01:44:01.530Z","uuid":"f17b1357-57a3-42c2-8da9-4989f747d6a5"}
{"parentUuid":"fee45369-94fb-428f-83ba-284ea945a689","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01FZu6mw7RLe97QgXvkt8PKU","type":"tool_result","content":"  1680→          class=\"pressy-chapter-section\"\n  1681→          data-chapter-slug={ch.slug}\n  1682→        >\n  1683→          <ChapterDivider title={ch.title} />\n  1684→          <ch.Content components={mdxComponents || {}} />\n  1685→        </section>\n  1686→      ));\n  1687→    }\n  1688→    return children;\n  1689→  };\n  1690→\n  1691→  return (\n  1692→    <div\n  1693→      class=\"pressy-reader pressy-reader--paginated\"\n  1694→      ref={containerRef}\n  1695→      onClick={handleContainerClick}\n  1696→      onMouseMove={handleMouseMove}\n  1697→      onMouseLeave={handleMouseLeave}\n  1698→    >\n  1699→      {/* Paginated content viewport */}\n  1700→      <div class=\"pressy-paginated-viewport\" ref={viewportRef}>\n  1701→        <article\n  1702→          ref={articleRef}\n  1703→          class={`pressy-prose pressy-prose--paginated ${\n  1704→            showDropCap ? \"\" : \"no-drop-cap\"\n  1705→          }`}\n  1706→          data-drop-cap={showDropCap}\n  1707→        >\n  1708→          {renderContent()}\n  1709→        </article>\n  1710→      </div>\n  1711→\n  1712→      {/* Navigation arrows — appear on hover in left/right thirds */}\n  1713→      <div\n  1714→        class={`pressy-nav-arrow pressy-nav-arrow--prev ${\n  1715→          hoverZone === \"left\" ? \"pressy-nav-arrow--visible\" : \"\"\n  1716→        }`}\n  1717→      >\n  1718→        <svg\n  1719→          viewBox=\"0 0 24 24\"\n  1720→          fill=\"none\"\n  1721→          stroke=\"currentColor\"\n  1722→          stroke-width=\"2\"\n  1723→          stroke-linecap=\"round\"\n  1724→          stroke-linejoin=\"round\"\n  1725→        >\n  1726→          <polyline points=\"15 18 9 12 15 6\" />\n  1727→        </svg>\n  1728→      </div>\n  1729→      <div\n  1730→        class={`pressy-nav-arrow pressy-nav-arrow--next ${\n  1731→          hoverZone === \"right\" ? \"pressy-nav-arrow--visible\" : \"\"\n  1732→        }`}\n  1733→      >\n  1734→        <svg\n  1735→          viewBox=\"0 0 24 24\"\n  1736→          fill=\"none\"\n  1737→          stroke=\"currentColor\"\n  1738→          stroke-width=\"2\"\n  1739→          stroke-linecap=\"round\"\n  1740→          stroke-linejoin=\"round\"\n  1741→        >\n  1742→          <polyline points=\"9 6 15 12 9 18\" />\n  1743→        </svg>\n  1744→      </div>\n  1745→\n  1746→      {/* Chapter boundary hints */}\n  1747→      {chapterHint === \"prev\" && effectivePrevChapter && (\n  1748→        <div\n  1749→          class=\"pressy-chapter-hint pressy-chapter-hint--prev\"\n  1750→          aria-live=\"polite\"\n  1751→        >\n  1752→          <span class=\"pressy-chapter-hint-arrow\">{\"\\u2190\"}</span>\n  1753→          <span class=\"pressy-chapter-hint-text\">\n  1754→            {effectivePrevChapter.title}\n  1755→          </span>\n  1756→        </div>\n  1757→      )}\n  1758→      {chapterHint === \"next\" && effectiveNextChapter && (\n  1759→        <div\n  1760→          class=\"pressy-chapter-hint pressy-chapter-hint--next\"\n  1761→          aria-live=\"polite\"\n  1762→        >\n  1763→          <span class=\"pressy-chapter-hint-text\">\n  1764→            {effectiveNextChapter.title}"}]},"uuid":"013b0846-e682-4941-9e61-1814cda98716","timestamp":"2026-02-16T01:44:01.528Z","toolUseResult":{"type":"text","file":{"filePath":"/Users/blittle/dev/pressy/packages/@pressy/components/src/Reader.tsx","content":"          class=\"pressy-chapter-section\"\n          data-chapter-slug={ch.slug}\n        >\n          <ChapterDivider title={ch.title} />\n          <ch.Content components={mdxComponents || {}} />\n        </section>\n      ));\n    }\n    return children;\n  };\n\n  return (\n    <div\n      class=\"pressy-reader pressy-reader--paginated\"\n      ref={containerRef}\n      onClick={handleContainerClick}\n      onMouseMove={handleMouseMove}\n      onMouseLeave={handleMouseLeave}\n    >\n      {/* Paginated content viewport */}\n      <div class=\"pressy-paginated-viewport\" ref={viewportRef}>\n        <article\n          ref={articleRef}\n          class={`pressy-prose pressy-prose--paginated ${\n            showDropCap ? \"\" : \"no-drop-cap\"\n          }`}\n          data-drop-cap={showDropCap}\n        >\n          {renderContent()}\n        </article>\n      </div>\n\n      {/* Navigation arrows — appear on hover in left/right thirds */}\n      <div\n        class={`pressy-nav-arrow pressy-nav-arrow--prev ${\n          hoverZone === \"left\" ? \"pressy-nav-arrow--visible\" : \"\"\n        }`}\n      >\n        <svg\n          viewBox=\"0 0 24 24\"\n          fill=\"none\"\n          stroke=\"currentColor\"\n          stroke-width=\"2\"\n          stroke-linecap=\"round\"\n          stroke-linejoin=\"round\"\n        >\n          <polyline points=\"15 18 9 12 15 6\" />\n        </svg>\n      </div>\n      <div\n        class={`pressy-nav-arrow pressy-nav-arrow--next ${\n          hoverZone === \"right\" ? \"pressy-nav-arrow--visible\" : \"\"\n        }`}\n      >\n        <svg\n          viewBox=\"0 0 24 24\"\n          fill=\"none\"\n          stroke=\"currentColor\"\n          stroke-width=\"2\"\n          stroke-linecap=\"round\"\n          stroke-linejoin=\"round\"\n        >\n          <polyline points=\"9 6 15 12 9 18\" />\n        </svg>\n      </div>\n\n      {/* Chapter boundary hints */}\n      {chapterHint === \"prev\" && effectivePrevChapter && (\n        <div\n          class=\"pressy-chapter-hint pressy-chapter-hint--prev\"\n          aria-live=\"polite\"\n        >\n          <span class=\"pressy-chapter-hint-arrow\">{\"\\u2190\"}</span>\n          <span class=\"pressy-chapter-hint-text\">\n            {effectivePrevChapter.title}\n          </span>\n        </div>\n      )}\n      {chapterHint === \"next\" && effectiveNextChapter && (\n        <div\n          class=\"pressy-chapter-hint pressy-chapter-hint--next\"\n          aria-live=\"polite\"\n        >\n          <span class=\"pressy-chapter-hint-text\">\n            {effectiveNextChapter.title}","numLines":85,"startLine":1680,"totalLines":3014}},"sourceToolAssistantUUID":"fee45369-94fb-428f-83ba-284ea945a689"}
{"parentUuid":"013b0846-e682-4941-9e61-1814cda98716","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","message":{"model":"claude-opus-4-6","id":"msg_0112g8P2D7pM4AvgM4Ao47Sh","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01DCVuSRFNZajNsnzPfK4V7q","name":"Read","input":{"file_path":"/Users/blittle/dev/pressy/packages/@pressy/components/src/Reader.tsx","offset":1917,"limit":60},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":1407,"cache_read_input_tokens":68464,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":1407},"output_tokens":25,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CYAuCNKP6Bs6jHJ9ebT6q","type":"assistant","uuid":"a6b64052-13a8-458b-ae20-02f1655a5548","timestamp":"2026-02-16T01:44:04.824Z"}
{"parentUuid":"a6b64052-13a8-458b-ae20-02f1655a5548","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","type":"progress","data":{"type":"hook_progress","hookEvent":"PostToolUse","hookName":"PostToolUse:Read","command":"callback"},"parentToolUseID":"toolu_01DCVuSRFNZajNsnzPfK4V7q","toolUseID":"toolu_01DCVuSRFNZajNsnzPfK4V7q","timestamp":"2026-02-16T01:44:04.840Z","uuid":"aced61ad-08e2-4551-8657-003facd074eb"}
{"parentUuid":"a6b64052-13a8-458b-ae20-02f1655a5548","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01DCVuSRFNZajNsnzPfK4V7q","type":"tool_result","content":"  1917→          </button>\n  1918→        </div>\n  1919→\n  1920→        {/* Settings panel */}\n  1921→        <div\n  1922→          class={`pressy-settings-panel ${\n  1923→            settingsOpen ? \"pressy-settings-panel--open\" : \"\"\n  1924→          }`}\n  1925→        >\n  1926→          <div class=\"pressy-settings-section\">\n  1927→            <div class=\"pressy-settings-label\">Theme</div>\n  1928→            <div class=\"pressy-theme-options\">\n  1929→              {(\n  1930→                [\n  1931→                  {\n  1932→                    id: \"light\",\n  1933→                    label: \"Light\",\n  1934→                    icon: (\n  1935→                      <svg\n  1936→                        viewBox=\"0 0 24 24\"\n  1937→                        fill=\"none\"\n  1938→                        stroke=\"currentColor\"\n  1939→                        stroke-width=\"1.5\"\n  1940→                        width=\"16\"\n  1941→                        height=\"16\"\n  1942→                      >\n  1943→                        <circle cx=\"12\" cy=\"12\" r=\"5\" />\n  1944→                        <line x1=\"12\" y1=\"1\" x2=\"12\" y2=\"3\" />\n  1945→                        <line x1=\"12\" y1=\"21\" x2=\"12\" y2=\"23\" />\n  1946→                        <line x1=\"4.22\" y1=\"4.22\" x2=\"5.64\" y2=\"5.64\" />\n  1947→                        <line x1=\"18.36\" y1=\"18.36\" x2=\"19.78\" y2=\"19.78\" />\n  1948→                        <line x1=\"1\" y1=\"12\" x2=\"3\" y2=\"12\" />\n  1949→                        <line x1=\"21\" y1=\"12\" x2=\"23\" y2=\"12\" />\n  1950→                        <line x1=\"4.22\" y1=\"19.78\" x2=\"5.64\" y2=\"18.36\" />\n  1951→                        <line x1=\"18.36\" y1=\"5.64\" x2=\"19.78\" y2=\"4.22\" />\n  1952→                      </svg>\n  1953→                    ),\n  1954→                  },\n  1955→                  {\n  1956→                    id: \"dark\",\n  1957→                    label: \"Dark\",\n  1958→                    icon: (\n  1959→                      <svg\n  1960→                        viewBox=\"0 0 24 24\"\n  1961→                        fill=\"none\"\n  1962→                        stroke=\"currentColor\"\n  1963→                        stroke-width=\"1.5\"\n  1964→                        width=\"16\"\n  1965→                        height=\"16\"\n  1966→                      >\n  1967→                        <path d=\"M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z\" />\n  1968→                      </svg>\n  1969→                    ),\n  1970→                  },\n  1971→                  {\n  1972→                    id: \"system\",\n  1973→                    label: \"System\",\n  1974→                    icon: (\n  1975→                      <svg\n  1976→                        viewBox=\"0 0 24 24\""}]},"uuid":"a8597160-001a-42bf-a600-1c17822b585b","timestamp":"2026-02-16T01:44:04.839Z","toolUseResult":{"type":"text","file":{"filePath":"/Users/blittle/dev/pressy/packages/@pressy/components/src/Reader.tsx","content":"          </button>\n        </div>\n\n        {/* Settings panel */}\n        <div\n          class={`pressy-settings-panel ${\n            settingsOpen ? \"pressy-settings-panel--open\" : \"\"\n          }`}\n        >\n          <div class=\"pressy-settings-section\">\n            <div class=\"pressy-settings-label\">Theme</div>\n            <div class=\"pressy-theme-options\">\n              {(\n                [\n                  {\n                    id: \"light\",\n                    label: \"Light\",\n                    icon: (\n                      <svg\n                        viewBox=\"0 0 24 24\"\n                        fill=\"none\"\n                        stroke=\"currentColor\"\n                        stroke-width=\"1.5\"\n                        width=\"16\"\n                        height=\"16\"\n                      >\n                        <circle cx=\"12\" cy=\"12\" r=\"5\" />\n                        <line x1=\"12\" y1=\"1\" x2=\"12\" y2=\"3\" />\n                        <line x1=\"12\" y1=\"21\" x2=\"12\" y2=\"23\" />\n                        <line x1=\"4.22\" y1=\"4.22\" x2=\"5.64\" y2=\"5.64\" />\n                        <line x1=\"18.36\" y1=\"18.36\" x2=\"19.78\" y2=\"19.78\" />\n                        <line x1=\"1\" y1=\"12\" x2=\"3\" y2=\"12\" />\n                        <line x1=\"21\" y1=\"12\" x2=\"23\" y2=\"12\" />\n                        <line x1=\"4.22\" y1=\"19.78\" x2=\"5.64\" y2=\"18.36\" />\n                        <line x1=\"18.36\" y1=\"5.64\" x2=\"19.78\" y2=\"4.22\" />\n                      </svg>\n                    ),\n                  },\n                  {\n                    id: \"dark\",\n                    label: \"Dark\",\n                    icon: (\n                      <svg\n                        viewBox=\"0 0 24 24\"\n                        fill=\"none\"\n                        stroke=\"currentColor\"\n                        stroke-width=\"1.5\"\n                        width=\"16\"\n                        height=\"16\"\n                      >\n                        <path d=\"M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z\" />\n                      </svg>\n                    ),\n                  },\n                  {\n                    id: \"system\",\n                    label: \"System\",\n                    icon: (\n                      <svg\n                        viewBox=\"0 0 24 24\"","numLines":60,"startLine":1917,"totalLines":3014}},"sourceToolAssistantUUID":"a6b64052-13a8-458b-ae20-02f1655a5548"}
{"parentUuid":"a8597160-001a-42bf-a600-1c17822b585b","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","message":{"model":"claude-opus-4-6","id":"msg_01N6eXLEwc4QkUCfr6uizhUL","type":"message","role":"assistant","content":[{"type":"text","text":"Hmm, everything structurally looks correct. My changes only touched the TOC drawer `<nav>` contents, which shouldn't affect the footer at all. Let me think about this differently — the user says this is happening on mobile. Could this be a pre-existing issue unrelated to my changes?\n\nLet me check if there was a recent change to the file by looking at git:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":1030,"cache_read_input_tokens":69871,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":1030},"output_tokens":2,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CYAuCd3u52j82fLNQkF3M","type":"assistant","uuid":"4405ec9a-f474-4be7-a77b-0be9f9366ab5","timestamp":"2026-02-16T01:44:10.490Z"}
{"parentUuid":"4405ec9a-f474-4be7-a77b-0be9f9366ab5","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","message":{"model":"claude-opus-4-6","id":"msg_01N6eXLEwc4QkUCfr6uizhUL","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_019jyQ4US4SryFcZYVxu4hoo","name":"Bash","input":{"command":"git diff HEAD -- packages/@pressy/components/src/Reader.tsx | head -150","description":"Show git diff for Reader.tsx"},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":1030,"cache_read_input_tokens":69871,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":1030},"output_tokens":2,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CYAuCd3u52j82fLNQkF3M","type":"assistant","uuid":"ac6f66ba-5437-44ef-8cb0-df585ab33621","timestamp":"2026-02-16T01:44:11.382Z"}
{"parentUuid":"ac6f66ba-5437-44ef-8cb0-df585ab33621","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_019jyQ4US4SryFcZYVxu4hoo","type":"tool_result","content":"diff --git c/packages/@pressy/components/src/Reader.tsx w/packages/@pressy/components/src/Reader.tsx\nindex a119bf6..fea7621 100644\n--- c/packages/@pressy/components/src/Reader.tsx\n+++ w/packages/@pressy/components/src/Reader.tsx\n@@ -431,6 +431,18 @@ function ScrollReader({\n               </button>\n             </div>\n             <nav class=\"pressy-toc-list\">\n+              <a\n+                href={bookBasePath ? bookBasePath.replace(/\\/books\\/[^/]+$/, '') || '/' : '/'}\n+                class=\"pressy-toc-item pressy-toc-item--home\"\n+                onClick={() => setTocOpen(false)}\n+              >\n+                <span class=\"pressy-toc-item-num\">\n+                  <svg viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" width=\"14\" height=\"14\">\n+                    <path d=\"M3 9.5L12 3l9 6.5V20a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V9.5z\" />\n+                  </svg>\n+                </span>\n+                <span class=\"pressy-toc-item-title\">{bookTitle || 'Home'}</span>\n+              </a>\n               {allChapters.map((ch, i) => (\n                 <a\n                   key={ch.slug}\n@@ -1792,6 +1804,18 @@ function PaginatedReader({\n               </button>\n             </div>\n             <nav class=\"pressy-toc-list\">\n+              <a\n+                href={bookBasePath ? bookBasePath.replace(/\\/books\\/[^/]+$/, '') || '/' : '/'}\n+                class=\"pressy-toc-item pressy-toc-item--home\"\n+                onClick={() => setTocOpen(false)}\n+              >\n+                <span class=\"pressy-toc-item-num\">\n+                  <svg viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" width=\"14\" height=\"14\">\n+                    <path d=\"M3 9.5L12 3l9 6.5V20a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V9.5z\" />\n+                  </svg>\n+                </span>\n+                <span class=\"pressy-toc-item-title\">{bookTitle || 'Home'}</span>\n+              </a>\n               {allChapters.map((ch, i) => (\n                 <a\n                   key={ch.slug}\n@@ -2334,6 +2358,18 @@ const SCROLL_STYLES = `\n     text-align: right;\n   }\n \n+  .pressy-toc-backdrop--scroll .pressy-toc-item--home {\n+    border-bottom: 1px solid var(--color-border, #e5e5e5);\n+    margin-bottom: 0.25rem;\n+    padding-bottom: 0.75rem;\n+  }\n+\n+  .pressy-toc-backdrop--scroll .pressy-toc-item--home .pressy-toc-item-num {\n+    display: flex;\n+    align-items: center;\n+    justify-content: center;\n+  }\n+\n   .pressy-toc-backdrop--scroll .pressy-toc-item-title {\n     flex: 1;\n     min-width: 0;\n@@ -2879,6 +2915,18 @@ const PAGINATED_STYLES = `\n     text-align: right;\n   }\n \n+  .pressy-toc-item--home {\n+    border-bottom: 1px solid var(--color-border, #e5e5e5);\n+    margin-bottom: 0.25rem;\n+    padding-bottom: 0.75rem;\n+  }\n+\n+  .pressy-toc-item--home .pressy-toc-item-num {\n+    display: flex;\n+    align-items: center;\n+    justify-content: center;\n+  }\n+\n   .pressy-toc-item-title {\n     flex: 1;\n     min-width: 0;","is_error":false}]},"uuid":"79dc06a4-0fd8-4e01-9f9e-0ce3824fb10b","timestamp":"2026-02-16T01:44:11.765Z","toolUseResult":{"stdout":"diff --git c/packages/@pressy/components/src/Reader.tsx w/packages/@pressy/components/src/Reader.tsx\nindex a119bf6..fea7621 100644\n--- c/packages/@pressy/components/src/Reader.tsx\n+++ w/packages/@pressy/components/src/Reader.tsx\n@@ -431,6 +431,18 @@ function ScrollReader({\n               </button>\n             </div>\n             <nav class=\"pressy-toc-list\">\n+              <a\n+                href={bookBasePath ? bookBasePath.replace(/\\/books\\/[^/]+$/, '') || '/' : '/'}\n+                class=\"pressy-toc-item pressy-toc-item--home\"\n+                onClick={() => setTocOpen(false)}\n+              >\n+                <span class=\"pressy-toc-item-num\">\n+                  <svg viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" width=\"14\" height=\"14\">\n+                    <path d=\"M3 9.5L12 3l9 6.5V20a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V9.5z\" />\n+                  </svg>\n+                </span>\n+                <span class=\"pressy-toc-item-title\">{bookTitle || 'Home'}</span>\n+              </a>\n               {allChapters.map((ch, i) => (\n                 <a\n                   key={ch.slug}\n@@ -1792,6 +1804,18 @@ function PaginatedReader({\n               </button>\n             </div>\n             <nav class=\"pressy-toc-list\">\n+              <a\n+                href={bookBasePath ? bookBasePath.replace(/\\/books\\/[^/]+$/, '') || '/' : '/'}\n+                class=\"pressy-toc-item pressy-toc-item--home\"\n+                onClick={() => setTocOpen(false)}\n+              >\n+                <span class=\"pressy-toc-item-num\">\n+                  <svg viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" width=\"14\" height=\"14\">\n+                    <path d=\"M3 9.5L12 3l9 6.5V20a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V9.5z\" />\n+                  </svg>\n+                </span>\n+                <span class=\"pressy-toc-item-title\">{bookTitle || 'Home'}</span>\n+              </a>\n               {allChapters.map((ch, i) => (\n                 <a\n                   key={ch.slug}\n@@ -2334,6 +2358,18 @@ const SCROLL_STYLES = `\n     text-align: right;\n   }\n \n+  .pressy-toc-backdrop--scroll .pressy-toc-item--home {\n+    border-bottom: 1px solid var(--color-border, #e5e5e5);\n+    margin-bottom: 0.25rem;\n+    padding-bottom: 0.75rem;\n+  }\n+\n+  .pressy-toc-backdrop--scroll .pressy-toc-item--home .pressy-toc-item-num {\n+    display: flex;\n+    align-items: center;\n+    justify-content: center;\n+  }\n+\n   .pressy-toc-backdrop--scroll .pressy-toc-item-title {\n     flex: 1;\n     min-width: 0;\n@@ -2879,6 +2915,18 @@ const PAGINATED_STYLES = `\n     text-align: right;\n   }\n \n+  .pressy-toc-item--home {\n+    border-bottom: 1px solid var(--color-border, #e5e5e5);\n+    margin-bottom: 0.25rem;\n+    padding-bottom: 0.75rem;\n+  }\n+\n+  .pressy-toc-item--home .pressy-toc-item-num {\n+    display: flex;\n+    align-items: center;\n+    justify-content: center;\n+  }\n+\n   .pressy-toc-item-title {\n     flex: 1;\n     min-width: 0;","stderr":"","interrupted":false,"isImage":false,"noOutputExpected":false},"sourceToolAssistantUUID":"ac6f66ba-5437-44ef-8cb0-df585ab33621"}
{"parentUuid":"79dc06a4-0fd8-4e01-9f9e-0ce3824fb10b","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","message":{"model":"claude-opus-4-6","id":"msg_0133cWy6vBi9iBn7VRxE96gV","type":"message","role":"assistant","content":[{"type":"text","text":"My changes are only inside the TOC drawer and CSS — they definitely wouldn't break the footer visibility. This must be a pre-existing issue. But let me think about what could cause the footer content to not show even though the class is set...\n\nThe user says `pressy-page-footer pressy-page-footer--visible` gets set properly. Let me check if there's something happening with the `pressy-page-footer` base style that could prevent content from showing. Looking at the paginated version:\n\n```css\n.pressy-page-footer {\n  position: absolute;\n  bottom: 0;\n  left: 0;\n  right: 0;\n  padding: 0.5rem 1.5rem 1rem;\n  transform: translateY(100%);\n  opacity: 0;\n  z-index: 15;\n  background: var(--color-bg, #ffffff);\n}\n```\n\nAnd the parent `.pressy-reader--paginated` has `overflow: hidden`. When the footer is at `bottom: 0; transform: translateY(100%)`, it's pushed entirely outside the container, and `overflow: hidden` clips it. When visible, `transform: translateY(0)` brings it back — but it sits at the very bottom of the 100vh container, which on mobile with dynamic viewport heights could be behind the browser chrome.\n\nWait — let me check if the `--visible` rule for the paginated footer might be getting overridden by the scroll footer's more specific rule:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":1431,"cache_read_input_tokens":70901,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":1431},"output_tokens":1,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CYAuD7sVkjQvNxLMT38gE","type":"assistant","uuid":"1fb22995-18d1-4cc3-94ec-01a127e1b6b7","timestamp":"2026-02-16T01:44:23.164Z"}
{"parentUuid":"1fb22995-18d1-4cc3-94ec-01a127e1b6b7","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","message":{"model":"claude-opus-4-6","id":"msg_0133cWy6vBi9iBn7VRxE96gV","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_015cYBvv9uziAmACChDdBEag","name":"Grep","input":{"pattern":"pressy-page-footer--visible","path":"/Users/blittle/dev/pressy/packages/@pressy/components/src/Reader.tsx","output_mode":"content","-n":true,"-C":3},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":1431,"cache_read_input_tokens":70901,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":1431},"output_tokens":1,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CYAuD7sVkjQvNxLMT38gE","type":"assistant","uuid":"6eb6926c-ccf7-446a-8878-254d58202b18","timestamp":"2026-02-16T01:44:24.903Z"}
{"parentUuid":"6eb6926c-ccf7-446a-8878-254d58202b18","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","type":"progress","data":{"type":"hook_progress","hookEvent":"PostToolUse","hookName":"PostToolUse:Grep","command":"callback"},"parentToolUseID":"toolu_015cYBvv9uziAmACChDdBEag","toolUseID":"toolu_015cYBvv9uziAmACChDdBEag","timestamp":"2026-02-16T01:44:25.176Z","uuid":"92bccbff-cd74-4050-a623-cb8209fe3c95"}
{"parentUuid":"6eb6926c-ccf7-446a-8878-254d58202b18","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_015cYBvv9uziAmACChDdBEag","type":"tool_result","content":"467-      <div\n468-        class={`pressy-page-footer pressy-page-footer--scroll ${\n469-          footerVisible || settingsOpen || tocOpen\n470:            ? \"pressy-page-footer--visible\"\n471-            : \"\"\n472-        }`}\n473-      >\n--\n1840-      <div\n1841-        class={`pressy-page-footer ${\n1842-          footerVisible || settingsOpen || tocOpen\n1843:            ? \"pressy-page-footer--visible\"\n1844-            : \"\"\n1845-        }`}\n1846-      >\n--\n2100-    box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.05);\n2101-  }\n2102-\n2103:  .pressy-page-footer--scroll.pressy-page-footer--visible {\n2104-    transform: translateY(0);\n2105-    opacity: 1;\n2106-  }\n--\n2604-    background: var(--color-bg, #ffffff);\n2605-  }\n2606-\n2607:  .pressy-page-footer--visible {\n2608-    transform: translateY(0);\n2609-    opacity: 1;\n2610-  }"}]},"uuid":"702895da-6847-478b-bc32-a0725f3813b9","timestamp":"2026-02-16T01:44:25.175Z","toolUseResult":{"mode":"content","numFiles":0,"filenames":[],"content":"467-      <div\n468-        class={`pressy-page-footer pressy-page-footer--scroll ${\n469-          footerVisible || settingsOpen || tocOpen\n470:            ? \"pressy-page-footer--visible\"\n471-            : \"\"\n472-        }`}\n473-      >\n--\n1840-      <div\n1841-        class={`pressy-page-footer ${\n1842-          footerVisible || settingsOpen || tocOpen\n1843:            ? \"pressy-page-footer--visible\"\n1844-            : \"\"\n1845-        }`}\n1846-      >\n--\n2100-    box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.05);\n2101-  }\n2102-\n2103:  .pressy-page-footer--scroll.pressy-page-footer--visible {\n2104-    transform: translateY(0);\n2105-    opacity: 1;\n2106-  }\n--\n2604-    background: var(--color-bg, #ffffff);\n2605-  }\n2606-\n2607:  .pressy-page-footer--visible {\n2608-    transform: translateY(0);\n2609-    opacity: 1;\n2610-  }","numLines":31},"sourceToolAssistantUUID":"6eb6926c-ccf7-446a-8878-254d58202b18"}
{"parentUuid":"702895da-6847-478b-bc32-a0725f3813b9","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","message":{"model":"claude-opus-4-6","id":"msg_01UEAsGBpaxBycoZm2Hekw9r","type":"message","role":"assistant","content":[{"type":"text","text":"Both style blocks define `--visible` correctly. But wait — both the `SCROLL_STYLES` and `PAGINATED_STYLES` are separate `<style>` tags, and both get injected. The scroll styles have `.pressy-page-footer--scroll` base which sets `transform: translateY(100%)`, and its visible override is `.pressy-page-footer--scroll.pressy-page-footer--visible`. The paginated uses just `.pressy-page-footer`.\n\nBoth style blocks are being injected at the same time. If the scroll reader's `.pressy-page-footer--scroll` rule appears *after* the paginated `.pressy-page-footer--visible`, the more specific `.pressy-page-footer--scroll` base rule (`translateY(100%)`) could override the less-specific `.pressy-page-footer--visible` on the paginated footer. But the paginated footer doesn't have the `--scroll` class, so this shouldn't apply.\n\nActually, I suspect the issue might be that both style blocks are loaded, and the scroll styles might affect the paginated reader. But looking carefully, the classes are different.\n\nLet me look at whether both readers might be rendering simultaneously, or if there's some other issue. Let me check if maybe the `showFooterTemporarily` timer is hiding it too fast on mobile:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":828,"cache_read_input_tokens":72332,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":828},"output_tokens":1,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CYAuE7ZBEYti5T6hSKhvf","type":"assistant","uuid":"f8ea1992-a584-42e2-93e2-28aa70e9ebed","timestamp":"2026-02-16T01:44:34.039Z"}
{"parentUuid":"f8ea1992-a584-42e2-93e2-28aa70e9ebed","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","message":{"model":"claude-opus-4-6","id":"msg_01UEAsGBpaxBycoZm2Hekw9r","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01P1GLvfcn1Z9mCn23KU7SgX","name":"Grep","input":{"pattern":"showFooterTemporarily","path":"/Users/blittle/dev/pressy/packages/@pressy/components/src/Reader.tsx","output_mode":"content","-n":true,"-C":3},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":828,"cache_read_input_tokens":72332,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":828},"output_tokens":1,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CYAuE7ZBEYti5T6hSKhvf","type":"assistant","uuid":"f22d7eee-576c-4ed3-8cbd-2e4d7228bf1a","timestamp":"2026-02-16T01:44:35.072Z"}
{"parentUuid":"f22d7eee-576c-4ed3-8cbd-2e4d7228bf1a","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","type":"progress","data":{"type":"hook_progress","hookEvent":"PostToolUse","hookName":"PostToolUse:Grep","command":"callback"},"parentToolUseID":"toolu_01P1GLvfcn1Z9mCn23KU7SgX","toolUseID":"toolu_01P1GLvfcn1Z9mCn23KU7SgX","timestamp":"2026-02-16T01:44:35.333Z","uuid":"b05d1739-6c3a-4ae6-8da7-6ff67a49ac78"}
{"parentUuid":"f22d7eee-576c-4ed3-8cbd-2e4d7228bf1a","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01P1GLvfcn1Z9mCn23KU7SgX","type":"tool_result","content":"239-  const [settingsOpen, setSettingsOpen] = useState(false);\n240-  const [tocOpen, setTocOpen] = useState(false);\n241-\n242:  const showFooterTemporarily = useCallback(() => {\n243-    setFooterVisible(true);\n244-    if (footerTimerRef.current) clearTimeout(footerTimerRef.current);\n245-    footerTimerRef.current = setTimeout(() => setFooterVisible(false), 3000);\n--\n325-        setFooterVisible(false);\n326-        if (footerTimerRef.current) clearTimeout(footerTimerRef.current);\n327-      } else {\n328:        showFooterTemporarily();\n329-      }\n330-    },\n331:    [footerVisible, settingsOpen, tocOpen, showFooterTemporarily]\n332-  );\n333-\n334-  // Restore scroll position on mount\n--\n1291-  const [footerVisible, setFooterVisible] = useState(false);\n1292-  const footerTimerRef = useRef<ReturnType<typeof setTimeout> | null>(null);\n1293-\n1294:  const showFooterTemporarily = useCallback(() => {\n1295-    setFooterVisible(true);\n1296-    if (footerTimerRef.current) clearTimeout(footerTimerRef.current);\n1297-    footerTimerRef.current = setTimeout(() => setFooterVisible(false), 3000);\n--\n1346-          setFooterVisible(false);\n1347-          if (footerTimerRef.current) clearTimeout(footerTimerRef.current);\n1348-        } else {\n1349:          showFooterTemporarily();\n1350-        }\n1351-        return;\n1352-      }\n--\n1381-              setFooterVisible(false);\n1382-              if (footerTimerRef.current) clearTimeout(footerTimerRef.current);\n1383-            } else {\n1384:              showFooterTemporarily();\n1385-            }\n1386-          }, 300);\n1387-        }\n--\n1394-      isTouchDevice,\n1395-      settingsOpen,\n1396-      tocOpen,\n1397:      showFooterTemporarily,\n1398-      toggleFullscreen,\n1399-    ]\n1400-  );"}]},"uuid":"72f6436f-fb48-4ac4-bf4d-5c82c9808c4d","timestamp":"2026-02-16T01:44:35.332Z","toolUseResult":{"mode":"content","numFiles":0,"filenames":[],"content":"239-  const [settingsOpen, setSettingsOpen] = useState(false);\n240-  const [tocOpen, setTocOpen] = useState(false);\n241-\n242:  const showFooterTemporarily = useCallback(() => {\n243-    setFooterVisible(true);\n244-    if (footerTimerRef.current) clearTimeout(footerTimerRef.current);\n245-    footerTimerRef.current = setTimeout(() => setFooterVisible(false), 3000);\n--\n325-        setFooterVisible(false);\n326-        if (footerTimerRef.current) clearTimeout(footerTimerRef.current);\n327-      } else {\n328:        showFooterTemporarily();\n329-      }\n330-    },\n331:    [footerVisible, settingsOpen, tocOpen, showFooterTemporarily]\n332-  );\n333-\n334-  // Restore scroll position on mount\n--\n1291-  const [footerVisible, setFooterVisible] = useState(false);\n1292-  const footerTimerRef = useRef<ReturnType<typeof setTimeout> | null>(null);\n1293-\n1294:  const showFooterTemporarily = useCallback(() => {\n1295-    setFooterVisible(true);\n1296-    if (footerTimerRef.current) clearTimeout(footerTimerRef.current);\n1297-    footerTimerRef.current = setTimeout(() => setFooterVisible(false), 3000);\n--\n1346-          setFooterVisible(false);\n1347-          if (footerTimerRef.current) clearTimeout(footerTimerRef.current);\n1348-        } else {\n1349:          showFooterTemporarily();\n1350-        }\n1351-        return;\n1352-      }\n--\n1381-              setFooterVisible(false);\n1382-              if (footerTimerRef.current) clearTimeout(footerTimerRef.current);\n1383-            } else {\n1384:              showFooterTemporarily();\n1385-            }\n1386-          }, 300);\n1387-        }\n--\n1394-      isTouchDevice,\n1395-      settingsOpen,\n1396-      tocOpen,\n1397:      showFooterTemporarily,\n1398-      toggleFullscreen,\n1399-    ]\n1400-  );","numLines":50},"sourceToolAssistantUUID":"f22d7eee-576c-4ed3-8cbd-2e4d7228bf1a"}
{"parentUuid":"72f6436f-fb48-4ac4-bf4d-5c82c9808c4d","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","message":{"model":"claude-opus-4-6","id":"msg_01QYLR2qgrWAHTh5bMqnbFVn","type":"message","role":"assistant","content":[{"type":"text","text":"The user says the class gets set, so the state/logic works. The issue must be purely visual — the footer has the class but isn't visually appearing. Since the user said this is on mobile, let me check if there are any mobile-specific CSS rules affecting the footer:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":1052,"cache_read_input_tokens":73160,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":1052},"output_tokens":1,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CYAuErqRqvXrPEkWxhuFj","type":"assistant","uuid":"81d41cfd-e7c4-4d34-94e3-c9ecf36afe72","timestamp":"2026-02-16T01:44:38.640Z"}
{"parentUuid":"81d41cfd-e7c4-4d34-94e3-c9ecf36afe72","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","message":{"model":"claude-opus-4-6","id":"msg_01QYLR2qgrWAHTh5bMqnbFVn","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01DC3WE6apZ3VBbBPXyFjvaF","name":"Grep","input":{"pattern":"@media.*max-width.*pressy-page-footer|pressy-page-footer.*@media","path":"/Users/blittle/dev/pressy/packages/@pressy/components/src/Reader.tsx","output_mode":"content","-n":true},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":1052,"cache_read_input_tokens":73160,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":1052},"output_tokens":1,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CYAuErqRqvXrPEkWxhuFj","type":"assistant","uuid":"55486b32-7749-470f-9627-9bba969f69c9","timestamp":"2026-02-16T01:44:39.792Z"}
{"parentUuid":"55486b32-7749-470f-9627-9bba969f69c9","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","type":"progress","data":{"type":"hook_progress","hookEvent":"PostToolUse","hookName":"PostToolUse:Grep","command":"callback"},"parentToolUseID":"toolu_01DC3WE6apZ3VBbBPXyFjvaF","toolUseID":"toolu_01DC3WE6apZ3VBbBPXyFjvaF","timestamp":"2026-02-16T01:44:40.056Z","uuid":"6dda54b5-2bf6-4444-a483-afec96f20a16"}
{"parentUuid":"55486b32-7749-470f-9627-9bba969f69c9","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01DC3WE6apZ3VBbBPXyFjvaF","type":"tool_result","content":"No matches found"}]},"uuid":"49bcb6e5-8d45-4d57-9dfb-cf896afa396a","timestamp":"2026-02-16T01:44:40.055Z","toolUseResult":{"mode":"content","numFiles":0,"filenames":[],"content":"","numLines":0},"sourceToolAssistantUUID":"55486b32-7749-470f-9627-9bba969f69c9"}
{"parentUuid":"49bcb6e5-8d45-4d57-9dfb-cf896afa396a","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","message":{"model":"claude-opus-4-6","id":"msg_0115GCAL2J8zQ87mJ6Vq432W","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01CtMBNmLKqBJksgiTuB4jeh","name":"Grep","input":{"pattern":"@media\"","path":"/Users/blittle/dev/pressy/packages/@pressy/components/src/Reader.tsx","output_mode":"content","-n":true},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":226,"cache_read_input_tokens":74212,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":226},"output_tokens":25,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CYAuFD5LY8KFTQwjZGwd4","type":"assistant","uuid":"8e084e57-43e3-47c6-a4bc-4927e2512927","timestamp":"2026-02-16T01:44:43.251Z"}
{"parentUuid":"8e084e57-43e3-47c6-a4bc-4927e2512927","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","type":"progress","data":{"type":"hook_progress","hookEvent":"PostToolUse","hookName":"PostToolUse:Grep","command":"callback"},"parentToolUseID":"toolu_01CtMBNmLKqBJksgiTuB4jeh","toolUseID":"toolu_01CtMBNmLKqBJksgiTuB4jeh","timestamp":"2026-02-16T01:44:43.520Z","uuid":"a19ec09d-6e6b-4b1f-bbfe-e41e2c011348"}
{"parentUuid":"8e084e57-43e3-47c6-a4bc-4927e2512927","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01CtMBNmLKqBJksgiTuB4jeh","type":"tool_result","content":"No matches found"}]},"uuid":"d482302e-4b68-485e-867a-ab1d193bd0b3","timestamp":"2026-02-16T01:44:43.520Z","toolUseResult":{"mode":"content","numFiles":0,"filenames":[],"content":"","numLines":0},"sourceToolAssistantUUID":"8e084e57-43e3-47c6-a4bc-4927e2512927"}
{"parentUuid":"d482302e-4b68-485e-867a-ab1d193bd0b3","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","message":{"model":"claude-opus-4-6","id":"msg_014cxg9t6BrwPH2hRk5NCMWJ","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01PaQPoGNYb2MCC4yoPpkAuW","name":"Grep","input":{"pattern":"@media","path":"/Users/blittle/dev/pressy/packages/@pressy/components/src/Reader.tsx","output_mode":"content","-n":true},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":146,"cache_read_input_tokens":74438,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":146},"output_tokens":25,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CYAuFTtaHDzdJFA1J5q1F","type":"assistant","uuid":"cf98b8ac-ed3a-40e9-8c8e-274a08ac9717","timestamp":"2026-02-16T01:44:46.796Z"}
{"parentUuid":"cf98b8ac-ed3a-40e9-8c8e-274a08ac9717","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","type":"progress","data":{"type":"hook_progress","hookEvent":"PostToolUse","hookName":"PostToolUse:Grep","command":"callback"},"parentToolUseID":"toolu_01PaQPoGNYb2MCC4yoPpkAuW","toolUseID":"toolu_01PaQPoGNYb2MCC4yoPpkAuW","timestamp":"2026-02-16T01:44:47.066Z","uuid":"66aaad07-f169-48ac-952b-f9d52e89f71a"}
{"parentUuid":"cf98b8ac-ed3a-40e9-8c8e-274a08ac9717","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01PaQPoGNYb2MCC4yoPpkAuW","type":"tool_result","content":"2429:  @media (prefers-reduced-motion: reduce) {\n2535:  @media (hover: none) {\n2998:  @media (prefers-reduced-motion: reduce) {"}]},"uuid":"3aa34648-7a5b-4046-8f36-3a797ea2ebca","timestamp":"2026-02-16T01:44:47.065Z","toolUseResult":{"mode":"content","numFiles":0,"filenames":[],"content":"2429:  @media (prefers-reduced-motion: reduce) {\n2535:  @media (hover: none) {\n2998:  @media (prefers-reduced-motion: reduce) {","numLines":3},"sourceToolAssistantUUID":"cf98b8ac-ed3a-40e9-8c8e-274a08ac9717"}
{"parentUuid":"3aa34648-7a5b-4046-8f36-3a797ea2ebca","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","message":{"model":"claude-opus-4-6","id":"msg_0147iQRPAWBpUuKY3QkusWPN","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01Six5xJ4gMna5c33Ctw4SCU","name":"Read","input":{"file_path":"/Users/blittle/dev/pressy/packages/@pressy/components/src/Reader.tsx","offset":2535,"limit":30},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":190,"cache_read_input_tokens":74584,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":190},"output_tokens":25,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CYAuFjPEV4HxAbAEzu88v","type":"assistant","uuid":"82a0f3a9-26be-496a-8325-7594b2ad3c6d","timestamp":"2026-02-16T01:44:50.385Z"}
{"parentUuid":"82a0f3a9-26be-496a-8325-7594b2ad3c6d","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","type":"progress","data":{"type":"hook_progress","hookEvent":"PostToolUse","hookName":"PostToolUse:Read","command":"callback"},"parentToolUseID":"toolu_01Six5xJ4gMna5c33Ctw4SCU","toolUseID":"toolu_01Six5xJ4gMna5c33Ctw4SCU","timestamp":"2026-02-16T01:44:50.441Z","uuid":"54a8e3d3-041a-4e29-b907-1ba20be9bd75"}
{"parentUuid":"82a0f3a9-26be-496a-8325-7594b2ad3c6d","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01Six5xJ4gMna5c33Ctw4SCU","type":"tool_result","content":"  2535→  @media (hover: none) {\n  2536→    .pressy-nav-arrow {\n  2537→      display: none;\n  2538→    }\n  2539→  }\n  2540→\n  2541→  /* ── Chapter boundary hints ─────────────────────────────── */\n  2542→  /* Shown when overscrolling past first/last page of a chapter */\n  2543→  .pressy-chapter-hint {\n  2544→    position: absolute;\n  2545→    top: 50%;\n  2546→    transform: translateY(-50%);\n  2547→    display: flex;\n  2548→    align-items: center;\n  2549→    gap: 0.5rem;\n  2550→    padding: 0.75rem 1.25rem;\n  2551→    background: var(--color-bg-subtle, #f5f5f5);\n  2552→    border: 1px solid var(--color-border, #dee2e6);\n  2553→    border-radius: 0.75rem;\n  2554→    font-family: var(--font-heading, system-ui, -apple-system, sans-serif);\n  2555→    font-size: var(--font-size-sm, 0.875rem);\n  2556→    color: var(--color-text-muted, #6c757d);\n  2557→    z-index: 20;\n  2558→    pointer-events: none;\n  2559→    animation: pressy-hint-fade-in 0.15s ease-out;\n  2560→    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);\n  2561→    max-width: 60%;\n  2562→    white-space: nowrap;\n  2563→    overflow: hidden;\n  2564→    text-overflow: ellipsis;"}]},"uuid":"27bb16f3-e2fc-4dc3-88ed-317994a9ddb1","timestamp":"2026-02-16T01:44:50.440Z","toolUseResult":{"type":"text","file":{"filePath":"/Users/blittle/dev/pressy/packages/@pressy/components/src/Reader.tsx","content":"  @media (hover: none) {\n    .pressy-nav-arrow {\n      display: none;\n    }\n  }\n\n  /* ── Chapter boundary hints ─────────────────────────────── */\n  /* Shown when overscrolling past first/last page of a chapter */\n  .pressy-chapter-hint {\n    position: absolute;\n    top: 50%;\n    transform: translateY(-50%);\n    display: flex;\n    align-items: center;\n    gap: 0.5rem;\n    padding: 0.75rem 1.25rem;\n    background: var(--color-bg-subtle, #f5f5f5);\n    border: 1px solid var(--color-border, #dee2e6);\n    border-radius: 0.75rem;\n    font-family: var(--font-heading, system-ui, -apple-system, sans-serif);\n    font-size: var(--font-size-sm, 0.875rem);\n    color: var(--color-text-muted, #6c757d);\n    z-index: 20;\n    pointer-events: none;\n    animation: pressy-hint-fade-in 0.15s ease-out;\n    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);\n    max-width: 60%;\n    white-space: nowrap;\n    overflow: hidden;\n    text-overflow: ellipsis;","numLines":30,"startLine":2535,"totalLines":3014}},"sourceToolAssistantUUID":"82a0f3a9-26be-496a-8325-7594b2ad3c6d"}
{"parentUuid":"27bb16f3-e2fc-4dc3-88ed-317994a9ddb1","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","message":{"model":"claude-opus-4-6","id":"msg_016eFQE9FmXipncC82KVEScM","type":"message","role":"assistant","content":[{"type":"text","text":"Nothing there. The user is saying the class IS being set but the content doesn't appear. Let me reconsider — could this be a z-index issue where something sits on top, or could the footer's height be 0?\n\nActually, wait. Let me re-read the user's message more carefully: \"I don't see anything showing up anymore on tap.\" The key word is \"anymore\" — this implies it was working before. My changes to Reader.tsx only added elements inside the TOC nav, and CSS rules with very specific selectors. None of that should affect the footer.\n\nBut wait — could the home link `<a>` inside the TOC be somehow capturing the click? Let me look at the click handler again. The TOC is only rendered when `tocOpen` is true. When the footer first shows on tap, `tocOpen` is false. The handler would call `showFooterTemporarily()`, which sets `footerVisible = true`. The footer should render. The TOC drawer is not open at this point, so my new `<a>` element is never in the DOM.\n\nLet me check if maybe the issue is that the component was rebuilt incorrectly:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":606,"cache_read_input_tokens":74774,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":606},"output_tokens":1,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CYAuFyXnLK38vCKASxghf","type":"assistant","uuid":"cd239a1d-52e8-49dd-ac81-82be19abde84","timestamp":"2026-02-16T01:45:00.504Z"}
{"parentUuid":"cd239a1d-52e8-49dd-ac81-82be19abde84","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","message":{"model":"claude-opus-4-6","id":"msg_016eFQE9FmXipncC82KVEScM","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01WhN8qFCN9j8tXbSWzUxMpn","name":"Bash","input":{"command":"pnpm --filter @pressy-pub/components build 2>&1","description":"Rebuild components package","timeout":60000},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":606,"cache_read_input_tokens":74774,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":606},"output_tokens":1,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CYAuFyXnLK38vCKASxghf","type":"assistant","uuid":"ac39ec73-25ee-4e5a-b5f9-11ab5d1b61cf","timestamp":"2026-02-16T01:45:01.557Z"}
{"parentUuid":"ac39ec73-25ee-4e5a-b5f9-11ab5d1b61cf","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","type":"progress","data":{"type":"bash_progress","output":"ESM dist/content/index.js     9.84 KB\nESM dist/content/index.js.map 14.22 KB\nESM dist/index.js.map         182.75 KB\nESM ⚡️ Build success in 15ms\nDTS Build start","fullOutput":"> @pressy-pub/components@0.1.1 build /Users/blittle/dev/pressy/packages/@pressy/components\n> tsup\nCLI Building entry: {\"index\":\"src/index.ts\",\"content/index\":\"src/content/index.ts\"}\nCLI Using tsconfig: tsconfig.json\nCLI tsup v8.5.1\nCLI Using tsup config: /Users/blittle/dev/pressy/packages/@pressy/components/tsup.config.ts\nCLI Target: es2022\nCLI Cleaning output folder\nESM Build start\nESM dist/index.js             125.21 KB\nESM dist/content/index.js     9.84 KB\nESM dist/content/index.js.map 14.22 KB\nESM dist/index.js.map         182.75 KB\nESM ⚡️ Build success in 15ms\nDTS Build start","elapsedTimeSeconds":2,"totalLines":15,"timeoutMs":60000},"toolUseID":"bash-progress-0","parentToolUseID":"toolu_01WhN8qFCN9j8tXbSWzUxMpn","uuid":"5cfe40ea-667f-457f-b9a6-7b13258830c8","timestamp":"2026-02-16T01:45:03.562Z"}
{"parentUuid":"ac39ec73-25ee-4e5a-b5f9-11ab5d1b61cf","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01WhN8qFCN9j8tXbSWzUxMpn","type":"tool_result","content":"> @pressy-pub/components@0.1.1 build /Users/blittle/dev/pressy/packages/@pressy/components\n> tsup\n\nCLI Building entry: {\"index\":\"src/index.ts\",\"content/index\":\"src/content/index.ts\"}\nCLI Using tsconfig: tsconfig.json\nCLI tsup v8.5.1\nCLI Using tsup config: /Users/blittle/dev/pressy/packages/@pressy/components/tsup.config.ts\nCLI Target: es2022\nCLI Cleaning output folder\nESM Build start\nESM dist/index.js             125.21 KB\nESM dist/content/index.js     9.84 KB\nESM dist/content/index.js.map 14.22 KB\nESM dist/index.js.map         182.75 KB\nESM ⚡️ Build success in 15ms\nDTS Build start\nDTS ⚡️ Build success in 1285ms\nDTS dist/index.d.ts         4.59 KB\nDTS dist/content/index.d.ts 1.29 KB","is_error":false}]},"uuid":"8cd1943b-50ad-47eb-81a3-033f3bca599e","timestamp":"2026-02-16T01:45:04.098Z","toolUseResult":{"stdout":"> @pressy-pub/components@0.1.1 build /Users/blittle/dev/pressy/packages/@pressy/components\n> tsup\n\nCLI Building entry: {\"index\":\"src/index.ts\",\"content/index\":\"src/content/index.ts\"}\nCLI Using tsconfig: tsconfig.json\nCLI tsup v8.5.1\nCLI Using tsup config: /Users/blittle/dev/pressy/packages/@pressy/components/tsup.config.ts\nCLI Target: es2022\nCLI Cleaning output folder\nESM Build start\nESM dist/index.js             125.21 KB\nESM dist/content/index.js     9.84 KB\nESM dist/content/index.js.map 14.22 KB\nESM dist/index.js.map         182.75 KB\nESM ⚡️ Build success in 15ms\nDTS Build start\nDTS ⚡️ Build success in 1285ms\nDTS dist/index.d.ts         4.59 KB\nDTS dist/content/index.d.ts 1.29 KB","stderr":"","interrupted":false,"isImage":false,"noOutputExpected":false},"sourceToolAssistantUUID":"ac39ec73-25ee-4e5a-b5f9-11ab5d1b61cf"}
{"parentUuid":"8cd1943b-50ad-47eb-81a3-033f3bca599e","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","message":{"model":"claude-opus-4-6","id":"msg_01Ta5jKucyKqKRnjcahXogKk","type":"message","role":"assistant","content":[{"type":"text","text":"The build is fine. Since my changes to `Reader.tsx` only affect the *inside* of the TOC drawer (which isn't even rendered when the footer first appears), they can't be the cause. This is likely a pre-existing issue.\n\nThat said, let me look at the built output to double-check nothing weird happened with CSS specificity or ordering:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":753,"cache_read_input_tokens":75380,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":753},"output_tokens":3,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CYAuGyqukcRvQzDJp6Kj7","type":"assistant","uuid":"d02dd471-4169-4ebc-ba9f-3f0d5b4cddb9","timestamp":"2026-02-16T01:45:08.899Z"}
{"parentUuid":"d02dd471-4169-4ebc-ba9f-3f0d5b4cddb9","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","message":{"model":"claude-opus-4-6","id":"msg_01Ta5jKucyKqKRnjcahXogKk","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_012xviNhJAVgM3Rcip4z3uCZ","name":"Grep","input":{"pattern":"pressy-page-footer","path":"/Users/blittle/dev/pressy/packages/@pressy/components/dist/index.js","output_mode":"content","-n":true},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":753,"cache_read_input_tokens":75380,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":753},"output_tokens":3,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CYAuGyqukcRvQzDJp6Kj7","type":"assistant","uuid":"ba4b159c-6f6e-4841-ad21-18a02d56af3f","timestamp":"2026-02-16T01:45:09.974Z"}
{"parentUuid":"ba4b159c-6f6e-4841-ad21-18a02d56af3f","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","type":"progress","data":{"type":"hook_progress","hookEvent":"PostToolUse","hookName":"PostToolUse:Grep","command":"callback"},"parentToolUseID":"toolu_012xviNhJAVgM3Rcip4z3uCZ","toolUseID":"toolu_012xviNhJAVgM3Rcip4z3uCZ","timestamp":"2026-02-16T01:45:10.242Z","uuid":"42a4f2fb-9c19-432d-b146-947a2a4fa92d"}
{"parentUuid":"ba4b159c-6f6e-4841-ad21-18a02d56af3f","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_012xviNhJAVgM3Rcip4z3uCZ","type":"tool_result","content":"575:        \".pressy-page-footer, .pressy-toc-backdrop, .pressy-toc-toggle\"\n725:        class: `pressy-page-footer pressy-page-footer--scroll ${footerVisible || settingsOpen || tocOpen ? \"pressy-page-footer--visible\" : \"\"}`,\n1863:            class: `pressy-page-footer ${footerVisible || settingsOpen || tocOpen ? \"pressy-page-footer--visible\" : \"\"}`,\n2124:  .pressy-page-footer--scroll {\n2140:  .pressy-page-footer--scroll.pressy-page-footer--visible {\n2146:  .pressy-page-footer--scroll .pressy-footer-row {\n2153:  .pressy-page-footer--scroll .pressy-footer-title {\n2170:  .pressy-page-footer--scroll .pressy-footer-title:hover {\n2174:  .pressy-page-footer--scroll .pressy-toc-toggle,\n2175:  .pressy-page-footer--scroll .pressy-settings-toggle {\n2191:  .pressy-page-footer--scroll .pressy-toc-toggle:hover,\n2192:  .pressy-page-footer--scroll .pressy-settings-toggle:hover {\n2197:  .pressy-page-footer--scroll .pressy-settings-panel {\n2205:  .pressy-page-footer--scroll .pressy-settings-panel--open {\n2213:  .pressy-page-footer--scroll .pressy-settings-section {\n2217:  .pressy-page-footer--scroll .pressy-settings-section:last-child {\n2221:  .pressy-page-footer--scroll .pressy-settings-label {\n2232:  .pressy-page-footer--scroll .pressy-theme-options {\n2237:  .pressy-page-footer--scroll .pressy-theme-btn {\n2254:  .pressy-page-footer--scroll .pressy-theme-btn:hover {\n2258:  .pressy-page-footer--scroll .pressy-theme-btn--active {\n2264:  .pressy-page-footer--scroll .pressy-font-size-controls {\n2271:  .pressy-page-footer--scroll .pressy-font-size-btn {\n2288:  .pressy-page-footer--scroll .pressy-font-size-btn:hover:not(:disabled) {\n2293:  .pressy-page-footer--scroll .pressy-font-size-btn:disabled {\n2298:  .pressy-page-footer--scroll .pressy-font-size-value {\n2426:  .pressy-page-footer--scroll .pressy-offline-icon {\n2443:  .pressy-page-footer--scroll .pressy-offline-icon:hover {\n2448:  .pressy-page-footer--scroll .pressy-offline-icon--cached {\n2452:  .pressy-page-footer--scroll .pressy-offline-icon--cached:hover {\n2456:  .pressy-page-footer--scroll .pressy-offline-check {\n2462:  .pressy-page-footer--scroll .pressy-offline-icon--downloading {\n2467:    .pressy-page-footer--scroll {\n2628:  .pressy-page-footer {\n2643:  .pressy-page-footer--visible {"}]},"uuid":"d8e3b3c7-91c9-418c-9246-274c479fbc03","timestamp":"2026-02-16T01:45:10.241Z","toolUseResult":{"mode":"content","numFiles":0,"filenames":[],"content":"575:        \".pressy-page-footer, .pressy-toc-backdrop, .pressy-toc-toggle\"\n725:        class: `pressy-page-footer pressy-page-footer--scroll ${footerVisible || settingsOpen || tocOpen ? \"pressy-page-footer--visible\" : \"\"}`,\n1863:            class: `pressy-page-footer ${footerVisible || settingsOpen || tocOpen ? \"pressy-page-footer--visible\" : \"\"}`,\n2124:  .pressy-page-footer--scroll {\n2140:  .pressy-page-footer--scroll.pressy-page-footer--visible {\n2146:  .pressy-page-footer--scroll .pressy-footer-row {\n2153:  .pressy-page-footer--scroll .pressy-footer-title {\n2170:  .pressy-page-footer--scroll .pressy-footer-title:hover {\n2174:  .pressy-page-footer--scroll .pressy-toc-toggle,\n2175:  .pressy-page-footer--scroll .pressy-settings-toggle {\n2191:  .pressy-page-footer--scroll .pressy-toc-toggle:hover,\n2192:  .pressy-page-footer--scroll .pressy-settings-toggle:hover {\n2197:  .pressy-page-footer--scroll .pressy-settings-panel {\n2205:  .pressy-page-footer--scroll .pressy-settings-panel--open {\n2213:  .pressy-page-footer--scroll .pressy-settings-section {\n2217:  .pressy-page-footer--scroll .pressy-settings-section:last-child {\n2221:  .pressy-page-footer--scroll .pressy-settings-label {\n2232:  .pressy-page-footer--scroll .pressy-theme-options {\n2237:  .pressy-page-footer--scroll .pressy-theme-btn {\n2254:  .pressy-page-footer--scroll .pressy-theme-btn:hover {\n2258:  .pressy-page-footer--scroll .pressy-theme-btn--active {\n2264:  .pressy-page-footer--scroll .pressy-font-size-controls {\n2271:  .pressy-page-footer--scroll .pressy-font-size-btn {\n2288:  .pressy-page-footer--scroll .pressy-font-size-btn:hover:not(:disabled) {\n2293:  .pressy-page-footer--scroll .pressy-font-size-btn:disabled {\n2298:  .pressy-page-footer--scroll .pressy-font-size-value {\n2426:  .pressy-page-footer--scroll .pressy-offline-icon {\n2443:  .pressy-page-footer--scroll .pressy-offline-icon:hover {\n2448:  .pressy-page-footer--scroll .pressy-offline-icon--cached {\n2452:  .pressy-page-footer--scroll .pressy-offline-icon--cached:hover {\n2456:  .pressy-page-footer--scroll .pressy-offline-check {\n2462:  .pressy-page-footer--scroll .pressy-offline-icon--downloading {\n2467:    .pressy-page-footer--scroll {\n2628:  .pressy-page-footer {\n2643:  .pressy-page-footer--visible {","numLines":35},"sourceToolAssistantUUID":"ba4b159c-6f6e-4841-ad21-18a02d56af3f"}
{"parentUuid":"d8e3b3c7-91c9-418c-9246-274c479fbc03","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","message":{"model":"claude-opus-4-6","id":"msg_01Qvkr19bibTjcvpRfy6vd83","type":"message","role":"assistant","content":[{"type":"text","text":"The CSS looks correct. Both `SCROLL_STYLES` and `PAGINATED_STYLES` are separate style blocks with properly scoped selectors.\n\nThis is almost certainly a pre-existing issue unrelated to my changes. My diff only adds elements inside the `<nav class=\"pressy-toc-list\">` (which only renders when `tocOpen === true`), and CSS rules targeting `.pressy-toc-item--home`. Neither can affect the footer visibility.\n\nCould you check if the issue existed before my changes? You can verify by reverting Reader.tsx with `git stash` to test. But if you're confident it started with this session, could you share more details about which reader mode (scroll or paginated) and what you see in the computed styles for `.pressy-page-footer--visible`? The class being set but content not showing usually means either:\n\n1. Something is covering it (z-index issue)\n2. The `transform`/`opacity` transition isn't applying (CSS specificity override)\n3. The footer `div` has the class but its children aren't rendering (conditional rendering returning null)\n\nOne thing I notice: the paginated footer has `position: absolute` inside `.pressy-reader--paginated` which has `overflow: hidden`. If the mobile browser's dynamic toolbar changes the viewport height, the `100dvh` container might shift the footer's absolute `bottom: 0` behind the browser chrome. Would you like me to try changing the paginated footer to `position: fixed` to see if that helps?"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":1064,"cache_read_input_tokens":76133,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":1064},"output_tokens":4,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CYAuHSJ8aFnsZXZH8AcDQ","type":"assistant","uuid":"3fb0f932-f5a4-4d86-aa12-be48161643e0","timestamp":"2026-02-16T01:45:21.994Z"}
{"parentUuid":"3fb0f932-f5a4-4d86-aa12-be48161643e0","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","type":"progress","data":{"type":"hook_progress","hookEvent":"Stop","hookName":"Stop","command":"entire hooks claude-code stop"},"parentToolUseID":"374fc5df-97ef-4c23-8eda-c1d500e96ac4","toolUseID":"374fc5df-97ef-4c23-8eda-c1d500e96ac4","timestamp":"2026-02-16T01:45:22.037Z","uuid":"562570d9-c8df-48d0-820c-25fbb99af331"}
{"parentUuid":"562570d9-c8df-48d0-820c-25fbb99af331","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","type":"system","subtype":"stop_hook_summary","hookCount":1,"hookInfos":[{"command":"entire hooks claude-code stop"}],"hookErrors":[],"preventedContinuation":false,"stopReason":"","hasOutput":true,"level":"suggestion","timestamp":"2026-02-16T01:45:22.501Z","uuid":"963e9ba0-2970-4930-ad30-767a38372428","toolUseID":"374fc5df-97ef-4c23-8eda-c1d500e96ac4"}
{"parentUuid":"963e9ba0-2970-4930-ad30-767a38372428","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","type":"system","subtype":"turn_duration","durationMs":136146,"timestamp":"2026-02-16T01:45:22.503Z","uuid":"cf54e1d1-9ac4-4575-ae74-ed67b19ece3f","isMeta":false}
{"type":"file-history-snapshot","messageId":"270609ad-33a6-4622-8fd8-92978a26e7ea","snapshot":{"messageId":"270609ad-33a6-4622-8fd8-92978a26e7ea","trackedFileBackups":{"packages/pressy/src/runtime/offline.ts":{"backupFileName":"259b478c67f372e9@v2","version":2,"backupTime":"2026-02-16T01:34:16.305Z"},"packages/pressy/src/runtime/client.tsx":{"backupFileName":"553e6fae6ff514b2@v3","version":3,"backupTime":"2026-02-16T01:39:32.392Z"},"packages/@pressy/components/src/Reader.tsx":{"backupFileName":"04a3a173c9615dd4@v2","version":2,"backupTime":"2026-02-16T01:43:06.357Z"}},"timestamp":"2026-02-16T01:47:59.568Z"},"isSnapshotUpdate":false}
{"parentUuid":"cf54e1d1-9ac4-4575-ae74-ed67b19ece3f","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","type":"user","message":{"role":"user","content":"If I set the CSS manually in the browser to:\n\n```\n.pressy-page-footer--visible {\n    transform: translateY(-58px);\n    opacity: 1;\n}\n```\n\nIt does show up, but that breaks desktop"},"uuid":"270609ad-33a6-4622-8fd8-92978a26e7ea","timestamp":"2026-02-16T01:47:58.953Z","thinkingMetadata":{"maxThinkingTokens":31999},"permissionMode":"acceptEdits"}
{"parentUuid":"270609ad-33a6-4622-8fd8-92978a26e7ea","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","message":{"model":"claude-opus-4-6","id":"msg_011uyDmvK3ShMKNwtXrySgzJ","type":"message","role":"assistant","content":[{"type":"text","text":"\n\n"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":58,"cache_read_input_tokens":77539,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":58},"output_tokens":10,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CYAuVwGk2iSDk5SsL283i","type":"assistant","uuid":"32731bdc-7fae-4ecf-bb4a-b1465b4b7c62","timestamp":"2026-02-16T01:48:02.489Z"}
{"parentUuid":"32731bdc-7fae-4ecf-bb4a-b1465b4b7c62","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","message":{"model":"claude-opus-4-6","id":"msg_011uyDmvK3ShMKNwtXrySgzJ","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"The user is saying that on mobile, the footer needs `translateY(-58px)` instead of `translateY(0)` to be visible. This means the footer is being pushed below the visible area by something - likely the mobile browser's bottom bar/toolbar taking up space.\n\nThe footer is `position: absolute; bottom: 0` inside `.pressy-reader--paginated` which is `height: 100dvh`. On mobile, `100dvh` accounts for the dynamic viewport, but the browser's bottom toolbar can still obscure content at the very bottom.\n\nActually, wait - let me think about this differently. The footer uses:\n```css\n.pressy-page-footer {\n  position: absolute;\n  bottom: 0;\n  ...\n  transform: translateY(100%);\n}\n```\n\nWhen visible:\n```css\n.pressy-page-footer--visible {\n  transform: translateY(0);\n}\n```\n\nSo when visible, the footer sits at `bottom: 0` of the container. If the container is `100dvh` but the actual visible viewport is smaller (due to mobile browser chrome at the bottom), the footer would be behind the browser chrome.\n\nThe fix with `translateY(-58px)` manually moves it up, but that's fragile. A better solution would be to use `env(safe-area-inset-bottom)` to account for the browser's safe area automatically.\n\nActually, let me reconsider—the parent container has `height: 100dvh` which should already account for the dynamic viewport on modern mobile browsers. The real issue is whether `100dvh` actually respects the browser's bottom bar on all devices, or if there's a fixed overlay that's taking up space outside the container's height calculation. The footer uses a transform to hide and show itself, but on mobile browsers with bottom toolbars, the footer gets positioned behind that bar even when visible. The 58px offset the user applied is likely accounting for a mobile browser's bottom navigation bar height. The proper solution would be to use `env(safe-area-inset-bottom)` to respect the safe area, or adjust the footer's positioning to account for viewport overlays rather than relying on fixed pixel values. position: absolute; bottom: 0`. When visible, `transform: translateY(0)` means the footer's bottom edge aligns with the container's bottom edge. The footer content extends upward from there. This should work...\n\nUnless the container's actual rendered height doesn't match the visible viewport. On mobile Safari, for example, the address bar and toolbar can cause the visual viewport to differ from the layout viewport. `100dvh` is supposed to match the dynamic (current) viewport, but there could be edge cases.\n\nActually, I think the issue might be simpler. The user said this worked before (\"anymore\"). Could there be a safe-area-inset or viewport-fit=cover issue? Or perhaps the footer's `bottom: 0` is correct but something else has pushed the container's bottom edge below the visible area.\n\nThe cleanest fix would be using `position: fixed` for the footer instead, since it positions relative to the viewport rather than the container. The scroll reader already uses `position: fixed` for its footer and it works fine, so applying the same approach to the paginated reader should solve this. The `-58px` offset the user applied suggests this is about browser UI elements rather than just safe area insets, likely the address bar height. I'm reconsidering whether the `100dvh` container is actually positioned correctly at the viewport's top, or if something's pushing it down and causing the footer to overflow below the visible area.\n\nSince I don't have full visibility into the page structure, the most reliable solution would be switching the paginated footer to `position: fixed` like the scroll footer already does, which would position it relative to the viewport regardless of the container's placement.\n\nNow I'm re-reading the user's question about the mobile footer breaking. Looking back at what we actually changed—just added TOC items and some CSS for the home item styling—none of those selectors should affect the footer at all.\n\nThis is a pre-existing issue, not something we introduced. The real fix would be switching the paginated footer to `position: fixed` like the scroll version uses, so the footer stays anchored to the viewport instead of the container. With `position: fixed`, the `bottom: 0` would reference the viewport, and even though `overflow: hidden` wouldn't clip it anymore, the footer would still be hidden by the `opacity: 0` and `transform: translateY(100%)` when it's supposed to be off-screen.","signature":"EvZKCkYICxgCKkByuzE4pRy+vbcrfDYta2NN+BEd08tR4DeCDbJJV34UU9BbY9Vf+j/IG/P01VAU5d8x5Ety3FO93ap2bNSRpBi/Egw75wWNk5sHAbX7DGEaDHblW2h33+M7yVxrqiIwT1eSqoR5Gf6cqG4iqkJuBkSeJxrRyL4u3YwXH3TpezEeFkOQnn5Pu0XovmHHH8KfKt1Jk/qYAeBEtNEqLT7MQ4ruzK6FBRbtof4iSjmCiCV7EaBuY47aJzIJj7f4BZOuCt4YyS4r52iD41XV2cjfCZY0t9P72kYtcws6vFcFFVFM06TvXHuxAT5vQENl36/Sxkl5mbxQT3xz+p/uF+kE7xZo1nlKS2UcrjlwXz9WI88FMdVJIXIASvtfq6NoOlieqFJpnVlWj9rh+VeFIRdOphLTpRdrYjtmZBMdd8zIdRJB42Y5lANyfDaO/9JS5zZHtYkHk/6H5i7GUU4AcFPYoXhYhs29gmPF92zZsDtwY2JeD/0vtQ/pDV157+Mw53S7lFKF6GNAbKDahaAIGpcx0ziU+jktTuFmmcQ53GDXoufaXZrzGHau2LjV0X/TODjzUwkBp9cVRehHzjCDoJFI9vdIXbkIQYBOah5XfY/fmasoxtIT7Sf6FHZ07UIGX4VTdKQ6oEbHf+yfuxYK9ggt5F6pxenprygbQAqG0/K0T1HAy8yNGnVf7KMJWlIQK2VLX4OF/fUHQwGU93o1NWocm3PMmfPkKQ3bsHZOGwA8zDzFNTh3Ctz9SYsc4fAz9TQptkAvNjtvvclC32zHYSl+3N3BtcgCXPKcPMVm0Yy7+eqKY4q3roHvi7naWIqX3yCSB+crk5qXPa48ki+TIK5/qE6h7fX5w7fBU1HOPvo9Mm6brtlK08a80i7UJTpZYP7ieZZtu+bGy9gIRPvypr3l0kQyjw9AKYYuKT93w98EG6pcX7w2GCYY0Eu/OOvanTZNd/2d3ShySb52Nd+eVklhEI0wtneYPnKjyv/mesS+p6ZrAnpfTJX+HUs3mYl0TnAN8S9uui0Hl6CZsRhbiRADg0FohSa7owBl2KfolnJswLwmfgdJKk9hQdPYzQodTL38FoJpZi9VBqWpJxblhqhwUhMp+OJJjp66hpfIinhURgWHBbKijY8k3qXwg50syg0w0wqucszldma8ftDrsyEBFsr6JGiWdG0ZbMd2AOMi7QvkhuGoeXs2BT1FHYbXKiLUC2i62pbPBfwX5AwUtVIJtI4RYPxDzU2EDOkfU5s9M2YV/wJmbZSZNx1NjKUqmeiDaf8Q//osffCVAwqGMBJhDaOGuJzVtYW/fiCO822VDIWlbSVfp++3rRXi1ZbELTFApp6+z9ijj46aW1i2tiJXSmoIvGzjTNxTJ63VtN2CIv6oalHEHuKilBR0rV92rgMqH2siAk136iIvObhzMaMX/IyFLuZ3L4qxCWI/0KTbtUx2E5Mu5fl21APjBdpqBsfgd48txqahGLzQLTk3w5gbeCTk1rS72RGpGWa5r5Y0i5mdlvganrVedb5fjDd7+kxgMa+nCOWvw4DADsYYwWY7PmeoO+bg7R5YGah5Obe1SUi8GHnEXAsxgHG7WKPqkAwO/xOsKPU02CzqGNUifyEtGuzZo5NlLJbI1D1s1ky1QuQS66AQ6nn+Wnxs/MpjUWf6jOiA0e6DwEVjVlZvq9rGHSxJjCOg2vsmLfC/5wOn27h34plO23t8N1KX6oBvJqg7nA4bUpcKLBAqFCpQ8v/9jd4wE58fDW3nf0BCFDGjp0vUgqtAFNcOikwOyeLln8K+04c2PuiCNj9gJfz9PGc+lwFN9sYJnKvG8Mpo2RP1HmxbonB2yW3rrarkXQ5Y+iPc+zESxNlkQUFW4bFpM7LF0sgPYxCOm8p3ydWg9xo+rtwwpJqxzsuyC852Ldfp+Xl14YZA4daPmOz1dFty8AhS1uUS1uSMfJ3XC7oYXNAWxcyOrsAreGUdk2hX8xWsvAguoDpACMXeOtkZWp0cD8IzLUoWu4xZ+BdugKy/BQKuaOD1pKBvFD55zMAd9qe8Xbe3my7E7T+xNJUqcYfBXhrCS+Lben1u8m6OdlTMu30/cSJMttpryBRrdq+uyrL6kxSy4HdWrrPzcLqrWnGCzcSOtGo3vwJw659r9Xbr74eJ9daca7I4s89BicvmHoRjv3/4fsiw6hfg1XhjPddSe6rO0QISpsW1o4hVkCISL0huONFEn1V27G8qJDOYvdxQ2kL9NSXyg353IFXVcKma6DGy05lBmEq6m/JcVWjl6Btnr4H4wqnjq6HHKiV1R38yGkMGhJC5A62EFhBmTuPkPivFwwQGxokAQzBrf3gKauztv/zY5eqnC6W9mF1Exg+YtPeAnIGo3kjp2UCaoBDUbY36KKuNHyyG+A4UGpmoWlb+KHfe4843MQ4RrzIIKsjRrvtCpNGY4vh0LrGQ4XKSzdiUghDs4Srot7sEnuy0F1q/QphgMUqfSvo9m78RLoibQm8sykexHZiBvtCryABEYo9cQZflrnDT6o3KL9HU+nG0Xky3JNjH3Qk6Ub675SaxDhek9Y6NJTp/JFPLH7b88AcvndCTMHzRhTOPEE7u25R+19L7wbTzlPkDv7obva8jiP9OPVE5Pli49SQT37eBvaeH3b5cTfI2NyVXXpKS3f4z9BmcOTbf9rN8hSTe+zvNVbMRwyRBu15FRaGy9XOh+vO19sGSYhTB2N7v0/+9+t2KYF3oXgKzU3Qmjp0B37qBJ2jurzSnwUdPrZCGHPdrsTZvSIWLdP6XNCYClwSNuEIe4FxJdp6hCtaSkjpqJJbsGnmlO52J51oCGJO7Lex3ZOGqP4Y/RwAnWj8pwRiM9dkzkopdKdJ9V5zMfxIzd4yHWVGs89lgeD0ukjI9f9Jf4SEHrlaeYm9Iw1ygysfPOFE4PITvUr6X5/n8hoZUZbXAyDCqPMuyGQV1f0xQ/NlEgMxJlCwplS7+RtCi9Qs0bs+5CZunxwIX/BBxAXiR0txRtE+C44AyIesHwaSGbgk1p2+/RDg7Rq1ZGRf8y4hLkdsHb07JBgP3Cchy5cYqg4Jrw5vpU9h7A5xegkf42cNuZo0i1iN1uP9GkAhC4pSXhB/wpWaSrhBcU6mjhVY15OGTvTgKArKon5mtygESPZItFcLLF+Nx1pUakCFZ02V/rypex4Xnpnqsj5eSK450ak0j5cjoApbcGGlv9NXv9lE9LdLeOsvuwfhDCJaZ4DPzexe8AzajRvl1jObik6mfCA9AbVCFnntA6puICX5VPSKpk7Xtsc8JL2iGgBZGdOjj0vcxPgftIsLGJR8YXrXq4KFJzUTrHQBHXqlslcQiTVUl12VEruZh9bsGZ/SirfZ51x1/IKhurl5U3JZ/a5JpA/jBP/BQETECqKSJ+/XrOpqA6noHNVEIL7kGJdAhnW2sYxFQGS9RudIgEDDwQwAs9WjuRZAZlPjmdh/Ucfhk9KzQa+3cw9QiSFPe/mhTMvMNrZmbbF1AhBqRkuesHWFSFijhgK4koJw3bbz5IzvvsQGX7xBxhmai4r2//4Yj3UK0T5abnzWsmGvX3uUnboLABkVErLjQmlff7P5GCTKCIxcW9Y7bSH6++1amHhibib3wrxs7vEJOUb15cJFu7V4AcMDOaYq1gU88Jid2mFzK6gu9ePcB06c6YamDUgK1Fx9XiJ1VjMspIu0xmde5w6vjHfAFiVYrvELHNHKuqBWcTcmnhOOZ9pkcFHDh4JTloOEGbuY1A452seocKyJRawTi6fAgXcgcX6vRwdoYsekbP66yfr5MPFWTB1GNkfOxzHh6vU+YiI22HLMzN0PzS2TZ8CFY3Iu0EwEhs0wX3GduLEgToWEj3ho+BnU8l5UUODcfONLZh/GxTTUb2z0Psa2GiMj9+BkT/SHzECg2hFpXrRSgzyimtwZ7zk5hdKXg1sqpcQM8Odvmdc8qSN9IX4hUUj5+cQuoj/nQIzOlHjfrR6zIDL+VOTPitYWqD5/kdAIPDCU4yCj2ZRKcxWtvfsuauv9H0GMFq2vSEDcnkARn1hEdXWhMo8kaDvnrGzxS9PGnVvobCDEfwU5zacFlQyJGaaqtav+OPXX/C5WftoaBpflcpBn28hydTOK/0Bc6qruf+bvJcZvQAPl6MhMjB/aLBobUGEHSRGEN6JePVIdhvMsf2TNgJ4flX371+OA2D2EUqmoj/g/Hw1AH2UIK5QRtwTt979juMhe4uisQQNmy5vlt84Bp20ZNMIFTDv0gtAHsAmL7D32tTek9oUIqBnHJJxRXcGni5g9bUpUrl9Goqj6CRtnLlYcngZAJIIyEZdNYxRL7Aq7qv27qfjvA9C4WKHSlfiJ+SCPtiCwdtsA/o64RKaFnq8SQbiYS8CeA67lrxAAsYt4dnHN39GZdlEbGx53WeXaZ+5dXQHXsx15aI6NjRFdi8U6MANnij1qleDsDuKFB6pz+mIabozIcYyeggTZw37UJwI1R48TjECvzE1sOMWQq28ThAA/m15/uDVP1uAaHzJGseGO/ABBoSgQikxd7WHr6Fzt+E3akfdfhSKgcRXpDiMyeEmc9kLESCvVZN1xNzCQaJvB3aEqqltB2r8R3AoP1Z+o7OJ7z2IrGfhsnd1xqoEkUljxkdmxCCE5WxYUdwhXznV0TrvrIC9N5d0UjGi/ZOdtaQ/hLnLbgwyx6pcDD10RtzbT4y0gcfGkoweBUHDX6xe/koxDFuqGWBj/pRsKGt6VGYNj/FJh0qB4s38zDZzWHZgURzYgzEkIExZne9Dw9M7FRtIYVzho9EiQbpH/noRIv6AAacVgm/w2sMvbl2o4u23HCLMGU6EUUTBS2IkP9UtyA63JB+JnepHON5BGQBCzfYSB19ptrHmLoSzGVwQMbYylM6aNpGL3+K0wQL7PHBBiPL8RutPWRCMgf/Ui26hylSDA62U/5YDFqao+vvq0wQ4L7ps7ezGn5903ydAN64FC+rpjUR+UBBBXkkXAkksB7gZ4Zm3hBAwd/7U660ej/FiM3jwZV4dD6fsh+4JBKCXEOhnn2HiOqaSdaS2YmVVJQIC41rbQvxOiQL+k9yPqs734Zojp900NrpLy6lHskGdNIDVSvSDJU/WdrI66pW85GxsfjrSosXlUTIyXmc746FDLWhNV7EHlCvZzZPRWC9l8E15kmnqJ6ACq6xWlF903UekFubD10avoRrNIjJeUeRI8wzAqonIFHSTZs8xMpvCidXxOXmmBrUajKH4rjcn6ISWn2Y8UjRylo6JpBRjnO/3eDEv9CveIrqczaBYuoR4xqoQq/05QmE1pochtsvEuq5aei7Fu8VWFuHJxl03chlkUNVj4XQuNR9Bn6lvVlLP7WrwXL/F/ru2ajGJQQv9BU/Ad1I68PNiIw/LF1VcXflXOMpsMqxrXjXAIDztLVPeE6/s8VN1zETcehVxVvl6GnXTt//mJfudQtlehs4iAzd4fATgFaH9u+8a4vM2eoNSWFYLwnrk0Ed5K1t1+OEnUJDeVCsvoKiLI0KhMSdpmXEjf9Wrc5S02y+ifSzyk/8LXI21MXYIsB0LpNqCwoapH+QaM//jL+eEaTkNOmh7AAx1ns3aT1EiPeBAWZ7rb1hkaa11DBMGtsg2gNeQp/hn57+0nAQ6IvgK84DJ39XxexJfiidn4Zh9dQ9Nn+et2rTcBj+5bldm1+uO4EPW47EmxI7QZhhAxLTlfKqfskTz7c42qbpw429NwqoN4WK6m7CuL2jiw1DNSxfxagb6KInxSyXEueQhGQTlsA6wRe2i0Mt0coaaZihEyESgHXHYXz+wwtUuLhkhd2Vpaz7dSN4hWQC9Q0pkXo39mfwlnFLQs7S/3pgC+sGiy2DCCgvHJgAA8Ox6zFZK5Slkirpqi3kazX1ZxwY/wW5aER71cmzjJ3rqD69EYQukx/95p87do7fyrXPn6ULMw4VO17+RGg4reSczeu6FPAWfl7gI2W5tQ61VEGTl+hyl6qiiTxMZT7B9YnBf5FoVx8rgIyyOuKo/m657ac4WxpAKSUIBoXa7q/jo7/y15m8t2Hm/uo4MJJ1VUpWFUm8p58PpZTMUQeiHJoif0LDkoVjNzDxYJ4SBwFr2RHG8x+ayVCAcnBLQqNUvJharnmE6NiVh+HafMpTsAstIkIy8KKptYpkqRdfQOw85uTYeGCXd3GhX+1vdrtJPqhmV+mKt8S6e+SIqK26I+e+9lFeANuB55WBPVx39ktsRngbFNRwxtaoAFYz/4cL1zd/fdWgVGh+6MKZeqQrAB480C2pa68Az7EGl73tNUGq19W1wn+QLZ0ofvUUi72euW4tNAmwdDZZuC6MF8phk5EEUbnDvGd5TY1jEyMdPSFYt8gUo/LUC2TmQMTaJYVXLxq71DfCGXvwwDt7fAvuJ8xRbGGt9uc5aRAbqgiywQHnTP1b3D3UM8r1NRfge9ZLFJvJAwvhlQnB+V8GZfTeqdjV/DYfSAli7QG8DTSxTFC+sPyVrGJXmaqbpKnazpzUOZAfr8Y77XVVjzfX5FzbrCBTP0zwXiDrkVJsid4RXKCelRfiE8QQsOUGq7vJm7E9cL15rXa01ul1OYMF0LeYdRdq+MmtaZocGtjhAq1K3RIAOW9QysP6/UgVttD5wg+PhvB49IgnyUpLUVFBimUM5kvvm3Z8/BKRDfaMCVFzj00BCwnz0+GMBdAIiCOqSogOp1mtEdHRaw6qXOA4e6WPz5ODlkH9p1FLdEaHaTfthzS89KfY7dsZwzqIH3MOssabGWdkS7ist2lrEBzqEoxi7uiRkZzro/3JuaJbfadN59FDzuC6b12acxnIrSHOsIMYamxz9LEzulDLxoS5m6moE5CcNKgWZ+t+Ejij0pQZuIsk0y/8lXCf+/8IUetDcyR0kuHSshLT8212/alQdxb9PvMgoCdib1dz1/8DT0/3rOJgeimtGsQpvDzDjQzrEXPiiRevWx8WaML2Nt1WY6Z6BCqOnQD/NaBX0YdDA8gEdz5bM6y7DO5yH2ISKKybzEJ3bMOnwPLiGz4FgcPbwKpw9FhOWMpa88OD2cdQuyPvU97/h4vPgPg6+621UKWXQ5bI22DFdb4eDLmqr2na3MImItogD1ko2j3cywB8LBQDCDnyv2TwbdQSQXl+QpKdA31z9q5umdAhwCtqtcORYccA4Ao8CTzJG1YCNQktwlAlZ/DgYgzrkGnNZZf+EPUxl8e9qqaIBG6+WRu8KRQ57JSHMUeoNJQxwc8P3AoeASSl/vpNRQH51vBSrcb+PDHdoG0zRCC3ggJCFd13P3WFlquVdZVNUxYdghxvxvgJe857TsFP922snf/L8LfeTU7/dPug8Qv7/HXCLdp4ZVwPMAVMrzauBR6SBO5UpdH4PQRXjt44Z15XrIOMS2FYtA74EjPAl+7zNcE8fCp7jKyVgC3WyLT/TxiukYnPaP5EZ+8wBpFoczoFV0g6kRSnGoXHVUTABgPq1uUMV/dEnqtogrzpwNzsDh9gutGIacitcQTc/zReBDFvIspiA9TWye84H/SLS59CzdgFn0jFiJZnBFd4ZVdLdq4WwPD31s3vZ3TsdXV8Ekc+LM1jqyhr2PzCiyvf/H70Bj/dte03jIl4HMHZP03Pu4Dt/DuLBlCjfMKR00iTu2Umcr5v5f2D4NQ10pubd/um9B+04Da7PlyxsL+Xxiud4hlI3yj/n7KAek5GLpCNGHuSWJXKfySFtXpmi7+PV/TYJExcTtfan3s3MuICxTEbHbvovvCeqe+BW7c0uqYvVKL/BOZCG6++KU/YvVsJsVwinQmWZDp6cAGnPkOaEKjnKW6SMB0C1NyG7sJpGSMmBmlngKY/Y6KAx9qBncowct18mj0pGjYf+NBL9nczcId+40nIoEYktVnMSF0NNZQTQPqrqKk1KH+B9GbEygIanc9pHOO2SOAVCDbes6Gv6ozUHKx2d73mBxJzVe8Q6LwAceI1O3g8KfMDGchIG0/by2kz9JynPKvqtgi2jKtu3olu/KuMXjutQXpaIJKZQW4vpcK4X9vuPdrwO4n/1JMTTqu3r0f3FzgoldD11tX8w10nrvh5BxKbayP0KYkgqaAqT/w4KTc9FlziijNAjjoSDLi9fI+P/jA7IyAXN+e7MOj+DOjRwXb0TGBpXrZ7LRTNjHWROgthZetmh2Rru0eMq1s9UyxjOaJ9Xx85IsHy6M0ClTLyXP4fdJfA2SeewjTtaNeopIqItLdU5LMSvedwBSC7rBpo137T60pW9AB2iX1MgaqCLjQFzML+dVXzYAc/2lbhUnRKRv0lcTj2cvzb3CiElmdiEBZp4MYG4I+k+TwqRipI08w5waMCjKSEkHk2U8xCQVwa7uvlLbZB6xleE+T1wTG9BQHqAMoCW3Fbjzcl4MQeZJTLZiW1Yxk3BsHWEV7QutpjfCXSYiUuzDtpY13bNSi5IWlJz8LRS8G9aKr1OZB+cOZDhuKuNaZOrTqsQPVYpGc6WMMVa6SMXxP/2HLYyirRz2FKoxLFLoYhV9OgzPUtdazeVA/eVG+dgxhxb8y/1v0p+zDcVnuS2xOSHu3OU724/RnhidMekBaNj3AvuUHfVxIUpuTMAaGq545GWJlkje4eOoeSfrtjVepWO7N0+LW2soZp7ojBwyZTv2limjVFzz+pM7w3a4jjVoPDAJSw2tmLydhiKAOvUdAyUJ0cyraltTjtB7taZCLtBzvadDOP5D0+hDwx58CkZWbCSFoE4wsYgrBQUc82/SlKW0O8ILtikAC+9DELkHojjKPEk3ABuhBV3ok5GSLWvELtV/ggrwubiyE0z46J5M4vH4feyyMbOpRZmj4nMQBIBzSIMVMOTuG5NWFgtY291WrtRaj7HwVJ/l3p1Tyrx3HoLntG6K+zCuTMNNaLcDJaNMuAM/Xjyi5dHnlbCaEgB2gvviS1eoJyeexDjsHmtpnu+kK52oDIC05cLOsoUIH/fbIFjBTGmlh4SykiO62bloFJrgf734vBb6su31zzzAZuALrQPvmsa02WpNKqvVGP1ZM+E+GhmVagOHzRDw2y6R1qAvpPIGXmniiG9OKlzI5RdX8YE6tUJYhvTEKCLD1stZmbESTnR7NN8ELdnZ+9AZXGUjpVATUcGI/ioDgyv6FU4BVoC0bz6mMRQTIdTZ2cx/Lc4tswDQANQ/1v93eh38zzD1TPZ7lmfQ6e/AjEbA6OBIEVmjPiaGiZECo9xYDXnk+P6bpQtcpNicvk6N6r64JQNh62W7mBBGzoTyhTLPUnt/72m6bnWy9nhADA7r1Y+DI3b7x+v3BfV3FnS+b+InB5no70QMDCdCzXAQsOV3HENaxXQBYn9OKNf5CaIlHsb0/75+IZtyFAFm+wmwYI+JxNLgCXoLL34f8ykjBJwTqWleZYOEBSmiqO7HBXeWpjy3SiKyxpgyIjyrRC3+NsJCE83+gEp6mBEE02MxAqBty2OTMDpTj/ompvOTtFaJ3kRcpXq7/P3K64+S5umzx1p6BRZ892blMbuFUY0r080rt17FKACtBzh6P2872ggyqM4sip+xyDAK3uFl7BlZZF+h4c1V4X9SZFJdbceE2tYO8deR0hrmAYWmLi66vGigLAeF/dlqP9cTe5iK6/HjMEcQjqy6eblnk8bTfWXhjEVbf785W5iF9HW6VSkT+YAQirC6ATggCTI40ZZKuSsOq4uB1Iw0bM3zrBq6PEhT6XqzNTapCmnSsx6IG8kB4ACHIFabNPMQjy+UeY23PO+FyrTkBvxg2+AokmsQAQrS63CZvuKSuVz2O03bEBclpH5SUGBsPw/EhnQxWY4oNpaaPcbN+e8a7JtzpqD/kdqywAQS9yi0Yhzh4AahuCAjRpmAFkpB1KH50QYpFubBq1vhZ5lqRYWKpOh0qnBmz/QfugJkPPNcdc5i0PWkX9BUYwbIvELNpsEziYAexL1oz7OPow1ltyUAr9N8tQANsh5QCunUXrBNWKmSt4jY7rGS+ZyxhNfWioxMlpjHpIwVJmS7HNcce4mU9QiwzeCpIxbWaobWDTUeV7wjxC4eHcotVw5CWK8ML1o4N78TVzD6sT8CKppX4rSAzRrVqfYOl9H+lptao4jGyX/f7IwIEZMSxZMeb4JWO1Jo+FX5cSlfb36loOKKEJmt1bB6qy0U8hya4Cfj8ro1ea5+YTyCorbZ14m+50P4SJfCBO9d+YFtcpwtSB2j5V7Mff0vSo9sugon4ukwIudNpzFCpUxhSHn9nbV+py53lz/bE0ifcMKcjPtpojUn6Cr9g+AOO33gK51r8AYUv3smb2rqMD5Purs2PR/1ig7zk9pbj03LUl86Sj3V89SCrD9LOdBtdWQUn3Y0TDgf7E04BJwe9PEE3O3wm3d4EVo/bZNMVuRoZuaG2hU4+qPlIJRGEtpFryB2dKm5m1Y1SshSIieRD2Wd5vli6JfMw1E67ugWFfGscOydzpEa1wgS8ZAw3S08rDkeQtd6c2/fqmDboJ/oOA/Kr5AluUyiM8PFvC7axwMxk732/ljtNFDoAHTHpvEPeR2nTqJCnv1cZyeRBDTcy0NF4oCzXVqv6ZGuLM+SyvE6xlhxiI/JQELagM+Jd5gavS63ij+YJCCCsCNk8FZfSQVJguC/P3LmNvi98ROrjHZNW/0nA+GaBxM7SJX7uJcSttCtnTDWzIW8EH/PtIDcJvWYgP9kpICBZV7IanhAimI/DhzkBlJZkqCaUpYSrLgfUk5kqG+FjFK6EPe9vfUGhmR0TVfSNL2jtbsdjGOHSfAf5FeN5JeC3V/j8mVNbnnuwiz5J0ZYsj2wfRxrf+ZCg1VPf4q9JCPk0gOXO48olTvjViCxQqZaJHjGdwPo0FeGVj9EGyX2yUUTuXRjIygU3rIa6+OJNEERyCVD4Lw6mBhIG/JNhKEh0nwzhQ+7AZ7Tdg+MP5E6b85YN2Yp0K+hDpfluhjiOkZ7mjLRiTsNUb4x0lQbSQ98JK4rtDhiRZONZdo7GX0eBbIICdFJtlVJyuTD7agHrXUIs1MIQawWh95edrEHXY9jetMMhTMjDxUqsvxRROJhMm6XDJmVRMEbuDvPbSHsgQMidNAJ9kP3xWpKml7kKMBS8qfVzOfIpxmGg66i1XfYTRq16P7YTgOy7PjpbYRHoRSrbvtXTSPqDpiJevqmITTmz5aRlvi3kh0H/CXUyfzJuXUxDBP5ELb+mP/04VFPZpU3TEli/B5svRHXFvKECflRLRseJWdERnk6GjlJozdIoYJzs4SWLMOrJ7vXsMIefKUlOlx3Xn2Qj80ZJluaJPAJGB746vje6fDRRCL9M33XAaayZTBiUs2FpkxdGn0VOxFYu7Bfqhe/ohpX9PHkYjwX41jOOOYTk4KM0RNtPVj2+/WNFLiZ4XXMziauoCjAw4bdHA66p7Ld8gyA6MZRimqjEON9kzPlGJtjCMWdb93mFyVLq7oF1pA6iPfXoypOf2nYYcckcEEs0CYE6QhyGAyXrv75wXO9CRNQ4400bP+2tfpt0MIVstJ2l0wr43HqGkWa5C0zuaTcd15HOTk9IB1nazmfx1xzKECexZDUMosCslfbMymvHSi2WsCvWFqSzZTRWNrQz9v01/WVBtuUORAxWCOgvqveqzU3CU+xd9yg4voXPc5wF0HZkBbC9uBhnyaDk5vYNYKPiir85nF9Jphgt2hhe4pZ+I0DOgnFHWxy0D6IyS0P6swhRmRETRFb/W9eHuOqa0vffzf2wcQyDz/3uKZQAkpHudCsOQFww8bFBK7avVgCfzp7U4bGjI/Oaj7+BAOeJrmRFeVvAgnaGetR2Pge9Y0Cmj1t2Qg3DDVPAqzn23i0YdjAs8r7sru7yP8hNjffA3Tmn+yVfcW3iXy5w91GLz7eRkmoOzI7Ex6CBn4awBVwqXrv5V0zOLnsXRs1dposXXTY61HkB3tFXybD0q6Y0yk9RG+KH4krKN5HtqyXHhatojbsr0hkMuD0i7UYnMAP4yNX7v5kJgvESP0pFP6d3vcjuz2HqVneXphcfLt0FHpZxm+uhLNd0TgCWhV79zt0V5sWyarMt4EbvJ1fWVPMh5C3YKNPDhtv8E/QIGP55v13zHs9RsZG5qhiC+gH8E4/WTt11RVihLeXafnLQLQAEByIe6PcFWciJAuN/VvT8Egm5XZwiggoD6SOsDdzNIgXBjcaqyo6CYHQFLoZPcSxGtkjhgB4bgAoaHhJRYVVzJlgYWyTFMMzYV6eJLhwGhjCN/HncSWOeiaTzJ/kRZSvKt4PD20xpOBkbH4o44b4aZafiJPlLf5u/EAEo9gyd8SAVWbsrM/Ddg9JtY4N153uniyyS01DFfKO0bkkY6tASyYgEiPyb+DhbZa1CfJmadfNOnscauF4cVo2Er1cltno7sLiHE8NJbpVBD7jOLwXzV5aIaxIrk/DAV9thKni0ghM1LIkfy+IHnFC2f4ar/3SgHXKThWUbktrwHdZ4Sq/SY+peW90xiFotVBPdyn2a48mkCsH2tSCLKOk0IIShO3Es8Xx4Cx/IHrxGw9DNkdWWbhMNiLDe6IvGpLtp4h68SG5gk40C8ejQ46Pj+v4SC0XCnXhowv++JAZOpb5UauD3SmxT60I3h97ye23kDBR+h3DtypTMe0j2VUgRR7iR4UHzGJ9rnnvUKeMySz9U6cdIK3gLMw9uV/9dxq0AlBHUX1hKL3dAPoagZwg9WD9Wm3WeJLd79nRDWQuGY4F/BH/0Id2qmuPdJ1Cl6bPAGBGgl6hxTxqAJwbkLrGZw791E5dgkGz87Tmp5tMdCWEhSkUYAQ=="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":58,"cache_read_input_tokens":77539,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":58},"output_tokens":10,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CYAuVwGk2iSDk5SsL283i","type":"assistant","uuid":"46cdcbae-720b-40ad-be58-a2234d01abee","timestamp":"2026-02-16T01:48:51.296Z"}
{"parentUuid":"46cdcbae-720b-40ad-be58-a2234d01abee","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","message":{"model":"claude-opus-4-6","id":"msg_011uyDmvK3ShMKNwtXrySgzJ","type":"message","role":"assistant","content":[{"type":"text","text":"That tells me the footer is sitting behind the mobile browser's bottom toolbar. The paginated footer uses `position: absolute` inside the `100dvh` container, but on mobile the visible area can be shorter than the layout viewport by the height of the browser chrome.\n\nThe scroll reader doesn't have this problem because its footer already uses `position: fixed`. Let me apply the same fix to the paginated footer."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":58,"cache_read_input_tokens":77539,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":58},"output_tokens":10,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CYAuVwGk2iSDk5SsL283i","type":"assistant","uuid":"9ab70239-a4b4-4e7b-8708-33cdaabe57f4","timestamp":"2026-02-16T01:48:52.777Z"}
{"parentUuid":"9ab70239-a4b4-4e7b-8708-33cdaabe57f4","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","message":{"model":"claude-opus-4-6","id":"msg_011uyDmvK3ShMKNwtXrySgzJ","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01LCT72FqV5nF7KScNRH9v3J","name":"Read","input":{"file_path":"/Users/blittle/dev/pressy/packages/@pressy/components/src/Reader.tsx","offset":2591,"limit":20},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":58,"cache_read_input_tokens":77539,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":58},"output_tokens":10,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CYAuVwGk2iSDk5SsL283i","type":"assistant","uuid":"7ce1daee-14e6-4031-988a-836649cb9841","timestamp":"2026-02-16T01:48:53.726Z"}
{"parentUuid":"7ce1daee-14e6-4031-988a-836649cb9841","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","type":"progress","data":{"type":"hook_progress","hookEvent":"PostToolUse","hookName":"PostToolUse:Read","command":"callback"},"parentToolUseID":"toolu_01LCT72FqV5nF7KScNRH9v3J","toolUseID":"toolu_01LCT72FqV5nF7KScNRH9v3J","timestamp":"2026-02-16T01:48:53.780Z","uuid":"7ddba087-6297-40b0-b58f-c253e291ab1e"}
{"parentUuid":"7ce1daee-14e6-4031-988a-836649cb9841","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01LCT72FqV5nF7KScNRH9v3J","type":"tool_result","content":"  2591→  /* ── Page footer ───────────────────────────────────────────── */\n  2592→  .pressy-page-footer {\n  2593→    position: absolute;\n  2594→    bottom: 0;\n  2595→    left: 0;\n  2596→    right: 0;\n  2597→    padding: 0.5rem 1.5rem 1rem;\n  2598→    text-align: center;\n  2599→    user-select: none;\n  2600→    transform: translateY(100%);\n  2601→    opacity: 0;\n  2602→    transition: transform 0.25s ease, opacity 0.25s ease;\n  2603→    z-index: 15;\n  2604→    background: var(--color-bg, #ffffff);\n  2605→  }\n  2606→\n  2607→  .pressy-page-footer--visible {\n  2608→    transform: translateY(0);\n  2609→    opacity: 1;\n  2610→  }"}]},"uuid":"56130bac-4702-4916-8198-2149bd8751e4","timestamp":"2026-02-16T01:48:53.779Z","toolUseResult":{"type":"text","file":{"filePath":"/Users/blittle/dev/pressy/packages/@pressy/components/src/Reader.tsx","content":"  /* ── Page footer ───────────────────────────────────────────── */\n  .pressy-page-footer {\n    position: absolute;\n    bottom: 0;\n    left: 0;\n    right: 0;\n    padding: 0.5rem 1.5rem 1rem;\n    text-align: center;\n    user-select: none;\n    transform: translateY(100%);\n    opacity: 0;\n    transition: transform 0.25s ease, opacity 0.25s ease;\n    z-index: 15;\n    background: var(--color-bg, #ffffff);\n  }\n\n  .pressy-page-footer--visible {\n    transform: translateY(0);\n    opacity: 1;\n  }","numLines":20,"startLine":2591,"totalLines":3014}},"sourceToolAssistantUUID":"7ce1daee-14e6-4031-988a-836649cb9841"}
{"parentUuid":"56130bac-4702-4916-8198-2149bd8751e4","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","message":{"model":"claude-opus-4-6","id":"msg_014uXK3HuYYBHzS9rymKqBbL","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_012FUL8NUMrxGPoSWfHNJYJg","name":"Edit","input":{"replace_all":false,"file_path":"/Users/blittle/dev/pressy/packages/@pressy/components/src/Reader.tsx","old_string":"  /* ── Page footer ───────────────────────────────────────────── */\n  .pressy-page-footer {\n    position: absolute;\n    bottom: 0;\n    left: 0;\n    right: 0;\n    padding: 0.5rem 1.5rem 1rem;\n    text-align: center;\n    user-select: none;\n    transform: translateY(100%);\n    opacity: 0;\n    transition: transform 0.25s ease, opacity 0.25s ease;\n    z-index: 15;\n    background: var(--color-bg, #ffffff);\n  }","new_string":"  /* ── Page footer ───────────────────────────────────────────── */\n  .pressy-page-footer {\n    position: fixed;\n    bottom: 0;\n    left: 0;\n    right: 0;\n    padding: 0.5rem 1.5rem calc(1rem + env(safe-area-inset-bottom, 0px));\n    text-align: center;\n    user-select: none;\n    transform: translateY(100%);\n    opacity: 0;\n    transition: transform 0.25s ease, opacity 0.25s ease;\n    z-index: 15;\n    background: var(--color-bg, #ffffff);\n  }"},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":2893,"cache_read_input_tokens":77597,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":2893},"output_tokens":25,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CYAuZwqLYCYpDYmmWSTPC","type":"assistant","uuid":"74f33766-6516-4c74-8f95-8a2d33333073","timestamp":"2026-02-16T01:48:59.668Z"}
{"parentUuid":"74f33766-6516-4c74-8f95-8a2d33333073","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","type":"progress","data":{"type":"hook_progress","hookEvent":"PostToolUse","hookName":"PostToolUse:Edit","command":"callback"},"parentToolUseID":"toolu_012FUL8NUMrxGPoSWfHNJYJg","toolUseID":"toolu_012FUL8NUMrxGPoSWfHNJYJg","timestamp":"2026-02-16T01:48:59.680Z","uuid":"d9db9f3e-84c1-4087-a54b-f8c12a90c150"}
{"parentUuid":"74f33766-6516-4c74-8f95-8a2d33333073","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_012FUL8NUMrxGPoSWfHNJYJg","type":"tool_result","content":"The file /Users/blittle/dev/pressy/packages/@pressy/components/src/Reader.tsx has been updated successfully."}]},"uuid":"76e75585-d900-4b62-a00e-b899618b6230","timestamp":"2026-02-16T01:48:59.679Z","toolUseResult":{"filePath":"/Users/blittle/dev/pressy/packages/@pressy/components/src/Reader.tsx","oldString":"  /* ── Page footer ───────────────────────────────────────────── */\n  .pressy-page-footer {\n    position: absolute;\n    bottom: 0;\n    left: 0;\n    right: 0;\n    padding: 0.5rem 1.5rem 1rem;\n    text-align: center;\n    user-select: none;\n    transform: translateY(100%);\n    opacity: 0;\n    transition: transform 0.25s ease, opacity 0.25s ease;\n    z-index: 15;\n    background: var(--color-bg, #ffffff);\n  }","newString":"  /* ── Page footer ───────────────────────────────────────────── */\n  .pressy-page-footer {\n    position: fixed;\n    bottom: 0;\n    left: 0;\n    right: 0;\n    padding: 0.5rem 1.5rem calc(1rem + env(safe-area-inset-bottom, 0px));\n    text-align: center;\n    user-select: none;\n    transform: translateY(100%);\n    opacity: 0;\n    transition: transform 0.25s ease, opacity 0.25s ease;\n    z-index: 15;\n    background: var(--color-bg, #ffffff);\n  }","originalFile":"import { ComponentChildren, ComponentType } from \"preact\";\nimport { useState, useEffect, useRef, useCallback } from \"preact/hooks\";\n\nimport { Navigation } from \"./Navigation.js\";\nimport { TextShare } from \"./TextShare.js\";\nimport { OfflineIndicator } from \"./OfflineIndicator.js\";\n\nexport interface ProgressData {\n  page: number;\n  totalPages: number;\n  scrollPosition: number;\n}\n\nexport interface ChapterMapData {\n  chapterMap: Record<\n    string,\n    () => Promise<{\n      default: ComponentType<{ components?: Record<string, unknown> }>;\n    }>\n  >;\n  chapterOrder: string[];\n}\n\nexport interface OfflineProps {\n  bookSlug: string;\n  chapterUrls: string[];\n  cachedBooks: { value: Set<string> };\n  cacheProgress: {\n    value: { bookSlug: string; current: number; total: number } | null;\n  };\n  onDownload: (bookSlug: string, chapterUrls: string[]) => void;\n  onRemove: (bookSlug: string) => void;\n}\n\nexport interface ReaderProps {\n  children: ComponentChildren;\n  title: string;\n  bookTitle?: string;\n  chapterSlug?: string;\n  prevChapter?: { slug: string; title: string };\n  nextChapter?: { slug: string; title: string };\n  showDropCap?: boolean;\n  paginationMode?: \"scroll\" | \"paginated\";\n  onSaveProgress?: (data: ProgressData) => void;\n  onRestoreProgress?: () => Promise<ProgressData | null>;\n  bookProgressPercent?: number;\n  initialContent?: ComponentType<{ components?: Record<string, unknown> }>;\n  chapterMapData?: ChapterMapData;\n  currentChapterSlug?: string;\n  allChapters?: Array<{ slug: string; title: string; wordCount?: number }>;\n  bookBasePath?: string;\n  onChapterChange?: (slug: string, page: number, totalPages: number) => void;\n  mdxComponents?: Record<string, unknown>;\n  offlineProps?: OfflineProps;\n}\n\nexport function Reader({\n  children,\n  bookTitle,\n  prevChapter,\n  nextChapter,\n  showDropCap = true,\n  paginationMode = \"scroll\",\n  onSaveProgress,\n  onRestoreProgress,\n  bookProgressPercent,\n  initialContent,\n  chapterMapData,\n  currentChapterSlug,\n  allChapters,\n  bookBasePath,\n  onChapterChange,\n  mdxComponents,\n  offlineProps,\n}: ReaderProps) {\n  if (paginationMode === \"paginated\") {\n    return (\n      <PaginatedReader\n        bookTitle={bookTitle}\n        prevChapter={prevChapter}\n        nextChapter={nextChapter}\n        showDropCap={showDropCap}\n        onSaveProgress={onSaveProgress}\n        onRestoreProgress={onRestoreProgress}\n        bookProgressPercent={bookProgressPercent}\n        initialContent={initialContent}\n        chapterMapData={chapterMapData}\n        currentChapterSlug={currentChapterSlug}\n        allChapters={allChapters}\n        bookBasePath={bookBasePath}\n        onChapterChange={onChapterChange}\n        mdxComponents={mdxComponents}\n        offlineProps={offlineProps}\n      >\n        {children}\n      </PaginatedReader>\n    );\n  }\n\n  return (\n    <ScrollReader\n      bookTitle={bookTitle}\n      prevChapter={prevChapter}\n      nextChapter={nextChapter}\n      showDropCap={showDropCap}\n      onSaveProgress={onSaveProgress}\n      onRestoreProgress={onRestoreProgress}\n      allChapters={allChapters}\n      bookBasePath={bookBasePath}\n      currentChapterSlug={currentChapterSlug}\n      offlineProps={offlineProps}\n    >\n      {children}\n    </ScrollReader>\n  );\n}\n\n// ── Offline Footer Icon ───────────────────────────────────────\n\nfunction OfflineFooterIcon({ offlineProps }: { offlineProps?: OfflineProps }) {\n  if (!offlineProps) return null;\n\n  const {\n    bookSlug,\n    chapterUrls,\n    cachedBooks,\n    onDownload,\n    onRemove,\n  } = offlineProps;\n\n  // Read signal .value directly in render — @preact/signals auto-subscribes\n  // and re-renders this component when the underlying signal changes.\n  const isCached = cachedBooks.value.has(bookSlug);\n\n  // Check isCached FIRST (matching DownloadBook's order). The download function\n  // optimistically marks the book as cached immediately, so isCached becomes true\n  // at the same time as isDownloading. Checking isCached first means we show the\n  // cached icon right away while the SW downloads in the background.\n  if (isCached) {\n    return (\n      <button\n        class=\"pressy-offline-icon pressy-offline-icon--cached\"\n        onClick={(e: MouseEvent) => {\n          e.stopPropagation();\n          onRemove(bookSlug);\n        }}\n        aria-label=\"Available offline. Click to remove.\"\n        title=\"Available offline. Click to remove.\"\n      >\n        <svg\n          viewBox=\"0 0 24 24\"\n          fill=\"none\"\n          stroke=\"currentColor\"\n          stroke-width=\"1.5\"\n          stroke-linecap=\"round\"\n          stroke-linejoin=\"round\"\n          width=\"18\"\n          height=\"18\"\n        >\n          <path d=\"M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z\" />\n          <polyline points=\"9 15 12 18 15 15\" />\n          <line x1=\"12\" y1=\"12\" x2=\"12\" y2=\"18\" />\n        </svg>\n        <svg\n          class=\"pressy-offline-check\"\n          viewBox=\"0 0 24 24\"\n          fill=\"currentColor\"\n          width=\"10\"\n          height=\"10\"\n        >\n          <path d=\"M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z\" />\n        </svg>\n      </button>\n    );\n  }\n\n  return (\n    <button\n      class=\"pressy-offline-icon\"\n      onClick={(e: MouseEvent) => {\n        e.stopPropagation();\n        onDownload(bookSlug, chapterUrls);\n      }}\n      aria-label=\"Download for offline reading\"\n      title=\"Download for offline reading\"\n    >\n      <svg\n        viewBox=\"0 0 24 24\"\n        fill=\"none\"\n        stroke=\"currentColor\"\n        stroke-width=\"1.5\"\n        stroke-linecap=\"round\"\n        stroke-linejoin=\"round\"\n        width=\"18\"\n        height=\"18\"\n      >\n        <path d=\"M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z\" />\n        <polyline points=\"9 15 12 18 15 15\" />\n        <line x1=\"12\" y1=\"12\" x2=\"12\" y2=\"18\" />\n      </svg>\n    </button>\n  );\n}\n\n// ── Scroll Reader ────────────────────────────────────────────\n\ninterface ScrollReaderProps {\n  children: ComponentChildren;\n  bookTitle?: string;\n  prevChapter?: { slug: string; title: string };\n  nextChapter?: { slug: string; title: string };\n  showDropCap: boolean;\n  onSaveProgress?: (data: ProgressData) => void;\n  onRestoreProgress?: () => Promise<ProgressData | null>;\n  allChapters?: Array<{ slug: string; title: string; wordCount?: number }>;\n  bookBasePath?: string;\n  currentChapterSlug?: string;\n  offlineProps?: OfflineProps;\n}\n\nfunction ScrollReader({\n  children,\n  bookTitle,\n  prevChapter,\n  nextChapter,\n  showDropCap,\n  onSaveProgress,\n  onRestoreProgress,\n  allChapters,\n  bookBasePath,\n  currentChapterSlug,\n  offlineProps,\n}: ScrollReaderProps) {\n  const saveTimerRef = useRef<ReturnType<typeof setTimeout> | null>(null);\n\n  // Footer visibility\n  const [footerVisible, setFooterVisible] = useState(false);\n  const footerTimerRef = useRef<ReturnType<typeof setTimeout> | null>(null);\n  const [settingsOpen, setSettingsOpen] = useState(false);\n  const [tocOpen, setTocOpen] = useState(false);\n\n  const showFooterTemporarily = useCallback(() => {\n    setFooterVisible(true);\n    if (footerTimerRef.current) clearTimeout(footerTimerRef.current);\n    footerTimerRef.current = setTimeout(() => setFooterVisible(false), 3000);\n  }, []);\n\n  // Settings state\n  const [activeTheme, setActiveTheme] = useState<string>(() => {\n    if (typeof localStorage !== \"undefined\") {\n      return localStorage.getItem(\"pressy-theme\") || \"light\";\n    }\n    return \"light\";\n  });\n  const [fontScale, setFontScale] = useState<number>(() => {\n    if (typeof localStorage !== \"undefined\") {\n      const saved = localStorage.getItem(\"pressy-font-size\");\n      return saved ? parseFloat(saved) : 1.0;\n    }\n    return 1.0;\n  });\n\n  const applyFontScale = useCallback((scale: number) => {\n    if (scale === 1.0) {\n      document.documentElement.style.removeProperty(\"--font-size-base\");\n    } else {\n      document.documentElement.style.setProperty(\n        \"--font-size-base\",\n        `calc(clamp(1rem, 0.875rem + 0.5vw, 1.25rem) * ${scale})`\n      );\n    }\n  }, []);\n\n  useEffect(() => {\n    if (fontScale !== 1.0) {\n      applyFontScale(fontScale);\n    }\n  }, []);\n\n  const handleThemeChange = useCallback((theme: string) => {\n    setActiveTheme(theme);\n    localStorage.setItem(\"pressy-theme\", theme);\n    const resolved =\n      theme === \"system\"\n        ? window.matchMedia(\"(prefers-color-scheme: dark)\").matches\n          ? \"dark\"\n          : \"light\"\n        : theme;\n    document.documentElement.setAttribute(\"data-theme\", resolved);\n  }, []);\n\n  const handleFontSizeChange = useCallback(\n    (delta: number) => {\n      setFontScale((prev) => {\n        const next =\n          Math.round(Math.max(0.8, Math.min(1.5, prev + delta)) * 10) / 10;\n        localStorage.setItem(\"pressy-font-size\", String(next));\n        applyFontScale(next);\n        return next;\n      });\n    },\n    [applyFontScale]\n  );\n\n  // Toggle footer on tap\n  const handleReaderClick = useCallback(\n    (e: MouseEvent) => {\n      const target = e.target as HTMLElement;\n      if (\n        target.closest(\n          \".pressy-page-footer, .pressy-toc-backdrop, .pressy-toc-toggle\"\n        )\n      )\n        return;\n      if (target.closest('a, button, input, select, textarea, [role=\"button\"]'))\n        return;\n\n      if (settingsOpen || tocOpen) {\n        setSettingsOpen(false);\n        setTocOpen(false);\n        return;\n      }\n\n      if (footerVisible) {\n        setFooterVisible(false);\n        if (footerTimerRef.current) clearTimeout(footerTimerRef.current);\n      } else {\n        showFooterTemporarily();\n      }\n    },\n    [footerVisible, settingsOpen, tocOpen, showFooterTemporarily]\n  );\n\n  // Restore scroll position on mount\n  useEffect(() => {\n    if (!onRestoreProgress) return;\n    onRestoreProgress().then((data) => {\n      if (data && data.scrollPosition > 0) {\n        window.scrollTo(0, data.scrollPosition);\n      }\n    });\n  }, []);\n\n  // Save scroll position (debounced)\n  useEffect(() => {\n    if (!onSaveProgress) return;\n\n    const handleScroll = () => {\n      if (saveTimerRef.current) clearTimeout(saveTimerRef.current);\n      saveTimerRef.current = setTimeout(() => {\n        onSaveProgress({\n          page: 0,\n          totalPages: 0,\n          scrollPosition: window.scrollY,\n        });\n      }, 500);\n    };\n\n    window.addEventListener(\"scroll\", handleScroll, { passive: true });\n    return () => {\n      window.removeEventListener(\"scroll\", handleScroll);\n      if (saveTimerRef.current) clearTimeout(saveTimerRef.current);\n    };\n  }, [onSaveProgress]);\n\n  // Save on page unload\n  useEffect(() => {\n    if (!onSaveProgress) return;\n\n    const handleUnload = () => {\n      onSaveProgress({\n        page: 0,\n        totalPages: 0,\n        scrollPosition: window.scrollY,\n      });\n    };\n\n    window.addEventListener(\"beforeunload\", handleUnload);\n    return () => window.removeEventListener(\"beforeunload\", handleUnload);\n  }, [onSaveProgress]);\n\n  return (\n    <div class=\"pressy-reader\" onClick={handleReaderClick}>\n      <main class=\"pressy-reader-main\">\n        <article\n          class={`pressy-prose ${showDropCap ? \"\" : \"no-drop-cap\"}`}\n          data-drop-cap={showDropCap}\n        >\n          {children}\n        </article>\n      </main>\n\n      <TextShare />\n      <Navigation prev={prevChapter} next={nextChapter} />\n      <OfflineIndicator />\n\n      {/* TOC drawer overlay */}\n      {tocOpen && allChapters && (\n        <div\n          class=\"pressy-toc-backdrop pressy-toc-backdrop--scroll\"\n          onClick={(e: MouseEvent) => {\n            e.stopPropagation();\n            setTocOpen(false);\n          }}\n        >\n          <div\n            class=\"pressy-toc-drawer\"\n            onClick={(e: MouseEvent) => e.stopPropagation()}\n          >\n            <div class=\"pressy-toc-header\">\n              <span class=\"pressy-toc-title\">Contents</span>\n              <button\n                class=\"pressy-toc-close\"\n                onClick={(e: MouseEvent) => {\n                  e.stopPropagation();\n                  setTocOpen(false);\n                }}\n                aria-label=\"Close table of contents\"\n              >\n                <svg\n                  viewBox=\"0 0 24 24\"\n                  fill=\"none\"\n                  stroke=\"currentColor\"\n                  stroke-width=\"2\"\n                  width=\"18\"\n                  height=\"18\"\n                >\n                  <line x1=\"18\" y1=\"6\" x2=\"6\" y2=\"18\" />\n                  <line x1=\"6\" y1=\"6\" x2=\"18\" y2=\"18\" />\n                </svg>\n              </button>\n            </div>\n            <nav class=\"pressy-toc-list\">\n              <a\n                href={bookBasePath ? bookBasePath.replace(/\\/books\\/[^/]+$/, '') || '/' : '/'}\n                class=\"pressy-toc-item pressy-toc-item--home\"\n                onClick={() => setTocOpen(false)}\n              >\n                <span class=\"pressy-toc-item-num\">\n                  <svg viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" width=\"14\" height=\"14\">\n                    <path d=\"M3 9.5L12 3l9 6.5V20a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V9.5z\" />\n                  </svg>\n                </span>\n                <span class=\"pressy-toc-item-title\">{bookTitle || 'Home'}</span>\n              </a>\n              {allChapters.map((ch, i) => (\n                <a\n                  key={ch.slug}\n                  href={`${bookBasePath || \"\"}/${ch.slug}`}\n                  class={`pressy-toc-item ${\n                    ch.slug === currentChapterSlug\n                      ? \"pressy-toc-item--active\"\n                      : \"\"\n                  }`}\n                  onClick={() => setTocOpen(false)}\n                >\n                  <span class=\"pressy-toc-item-num\">{i + 1}.</span>\n                  <span class=\"pressy-toc-item-title\">{ch.title}</span>\n                </a>\n              ))}\n            </nav>\n          </div>\n        </div>\n      )}\n\n      {/* Footer */}\n      <div\n        class={`pressy-page-footer pressy-page-footer--scroll ${\n          footerVisible || settingsOpen || tocOpen\n            ? \"pressy-page-footer--visible\"\n            : \"\"\n        }`}\n      >\n        <div class=\"pressy-footer-row\">\n          {allChapters && allChapters.length > 0 && (\n            <button\n              class=\"pressy-toc-toggle\"\n              onClick={(e: MouseEvent) => {\n                e.stopPropagation();\n                setSettingsOpen(false);\n                setTocOpen(!tocOpen);\n              }}\n              aria-label=\"Table of contents\"\n            >\n              <svg\n                viewBox=\"0 0 24 24\"\n                fill=\"none\"\n                stroke=\"currentColor\"\n                stroke-width=\"1.5\"\n                stroke-linecap=\"round\"\n                stroke-linejoin=\"round\"\n                width=\"18\"\n                height=\"18\"\n              >\n                <line x1=\"3\" y1=\"6\" x2=\"21\" y2=\"6\" />\n                <line x1=\"3\" y1=\"12\" x2=\"21\" y2=\"12\" />\n                <line x1=\"3\" y1=\"18\" x2=\"21\" y2=\"18\" />\n              </svg>\n            </button>\n          )}\n          {bookTitle && (\n            <button\n              class=\"pressy-footer-title\"\n              onClick={(e: MouseEvent) => {\n                e.stopPropagation();\n                if (allChapters && allChapters.length > 0) {\n                  setSettingsOpen(false);\n                  setTocOpen(!tocOpen);\n                }\n              }}\n            >\n              {bookTitle}\n            </button>\n          )}\n          <OfflineFooterIcon offlineProps={offlineProps} />\n          <button\n            class=\"pressy-settings-toggle\"\n            onClick={(e: MouseEvent) => {\n              e.stopPropagation();\n              setTocOpen(false);\n              setSettingsOpen(!settingsOpen);\n            }}\n            aria-label=\"Settings\"\n          >\n            <svg\n              viewBox=\"0 0 24 24\"\n              fill=\"none\"\n              stroke=\"currentColor\"\n              stroke-width=\"1.5\"\n              stroke-linecap=\"round\"\n              stroke-linejoin=\"round\"\n              width=\"18\"\n              height=\"18\"\n            >\n              <circle cx=\"12\" cy=\"12\" r=\"3\" />\n              <path d=\"M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z\" />\n            </svg>\n          </button>\n        </div>\n\n        {/* Settings panel */}\n        <div\n          class={`pressy-settings-panel ${\n            settingsOpen ? \"pressy-settings-panel--open\" : \"\"\n          }`}\n        >\n          <div class=\"pressy-settings-section\">\n            <div class=\"pressy-settings-label\">Theme</div>\n            <div class=\"pressy-theme-options\">\n              {(\n                [\n                  {\n                    id: \"light\",\n                    label: \"Light\",\n                    icon: (\n                      <svg\n                        viewBox=\"0 0 24 24\"\n                        fill=\"none\"\n                        stroke=\"currentColor\"\n                        stroke-width=\"1.5\"\n                        width=\"16\"\n                        height=\"16\"\n                      >\n                        <circle cx=\"12\" cy=\"12\" r=\"5\" />\n                        <line x1=\"12\" y1=\"1\" x2=\"12\" y2=\"3\" />\n                        <line x1=\"12\" y1=\"21\" x2=\"12\" y2=\"23\" />\n                        <line x1=\"4.22\" y1=\"4.22\" x2=\"5.64\" y2=\"5.64\" />\n                        <line x1=\"18.36\" y1=\"18.36\" x2=\"19.78\" y2=\"19.78\" />\n                        <line x1=\"1\" y1=\"12\" x2=\"3\" y2=\"12\" />\n                        <line x1=\"21\" y1=\"12\" x2=\"23\" y2=\"12\" />\n                        <line x1=\"4.22\" y1=\"19.78\" x2=\"5.64\" y2=\"18.36\" />\n                        <line x1=\"18.36\" y1=\"5.64\" x2=\"19.78\" y2=\"4.22\" />\n                      </svg>\n                    ),\n                  },\n                  {\n                    id: \"dark\",\n                    label: \"Dark\",\n                    icon: (\n                      <svg\n                        viewBox=\"0 0 24 24\"\n                        fill=\"none\"\n                        stroke=\"currentColor\"\n                        stroke-width=\"1.5\"\n                        width=\"16\"\n                        height=\"16\"\n                      >\n                        <path d=\"M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z\" />\n                      </svg>\n                    ),\n                  },\n                  {\n                    id: \"system\",\n                    label: \"System\",\n                    icon: (\n                      <svg\n                        viewBox=\"0 0 24 24\"\n                        fill=\"none\"\n                        stroke=\"currentColor\"\n                        stroke-width=\"1.5\"\n                        width=\"16\"\n                        height=\"16\"\n                      >\n                        <rect\n                          x=\"2\"\n                          y=\"3\"\n                          width=\"20\"\n                          height=\"14\"\n                          rx=\"2\"\n                          ry=\"2\"\n                        />\n                        <line x1=\"8\" y1=\"21\" x2=\"16\" y2=\"21\" />\n                        <line x1=\"12\" y1=\"17\" x2=\"12\" y2=\"21\" />\n                      </svg>\n                    ),\n                  },\n                  {\n                    id: \"sepia\",\n                    label: \"Sepia\",\n                    icon: (\n                      <svg\n                        viewBox=\"0 0 24 24\"\n                        fill=\"none\"\n                        stroke=\"currentColor\"\n                        stroke-width=\"1.5\"\n                        width=\"16\"\n                        height=\"16\"\n                      >\n                        <path d=\"M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z\" />\n                        <path d=\"M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z\" />\n                      </svg>\n                    ),\n                  },\n                ] as const\n              ).map((t) => (\n                <button\n                  key={t.id}\n                  class={`pressy-theme-btn ${\n                    activeTheme === t.id ? \"pressy-theme-btn--active\" : \"\"\n                  }`}\n                  onClick={(e: MouseEvent) => {\n                    e.stopPropagation();\n                    handleThemeChange(t.id);\n                  }}\n                >\n                  {t.icon}\n                  <span>{t.label}</span>\n                </button>\n              ))}\n            </div>\n          </div>\n          <div class=\"pressy-settings-section\">\n            <div class=\"pressy-settings-label\">Font Size</div>\n            <div class=\"pressy-font-size-controls\">\n              <button\n                class=\"pressy-font-size-btn\"\n                onClick={(e: MouseEvent) => {\n                  e.stopPropagation();\n                  handleFontSizeChange(-0.1);\n                }}\n                disabled={fontScale <= 0.8}\n                aria-label=\"Decrease font size\"\n              >\n                A-\n              </button>\n              <span class=\"pressy-font-size-value\">\n                {Math.round(fontScale * 100)}%\n              </span>\n              <button\n                class=\"pressy-font-size-btn\"\n                onClick={(e: MouseEvent) => {\n                  e.stopPropagation();\n                  handleFontSizeChange(0.1);\n                }}\n                disabled={fontScale >= 1.5}\n                aria-label=\"Increase font size\"\n              >\n                A+\n              </button>\n            </div>\n          </div>\n        </div>\n      </div>\n\n      <style>{SCROLL_STYLES}</style>\n    </div>\n  );\n}\n\n// ── Paginated Reader ──────────────────────────────────────────\n\ninterface LoadedChapter {\n  slug: string;\n  title: string;\n  Content: ComponentType<{ components?: Record<string, unknown> }>;\n}\n\ninterface ChapterPageRange {\n  slug: string;\n  startPage: number;\n  endPage: number;\n}\n\ninterface PaginatedReaderProps {\n  children: ComponentChildren;\n  bookTitle?: string;\n  prevChapter?: { slug: string; title: string };\n  nextChapter?: { slug: string; title: string };\n  showDropCap: boolean;\n  onSaveProgress?: (data: ProgressData) => void;\n  onRestoreProgress?: () => Promise<ProgressData | null>;\n  bookProgressPercent?: number;\n  initialContent?: ComponentType<{ components?: Record<string, unknown> }>;\n  chapterMapData?: ChapterMapData;\n  currentChapterSlug?: string;\n  allChapters?: Array<{ slug: string; title: string; wordCount?: number }>;\n  bookBasePath?: string;\n  onChapterChange?: (slug: string, page: number, totalPages: number) => void;\n  mdxComponents?: Record<string, unknown>;\n  offlineProps?: OfflineProps;\n}\n\nfunction ChapterDivider({ title }: { title: string }) {\n  return (\n    <div class=\"pressy-chapter-divider\">\n      <h2 class=\"pressy-chapter-divider-title\">{title}</h2>\n    </div>\n  );\n}\n\nfunction PaginatedReader({\n  children,\n  bookTitle,\n  prevChapter,\n  nextChapter,\n  showDropCap,\n  onSaveProgress,\n  onRestoreProgress,\n  bookProgressPercent,\n  initialContent,\n  chapterMapData,\n  currentChapterSlug,\n  allChapters,\n  bookBasePath,\n  onChapterChange,\n  mdxComponents,\n  offlineProps,\n}: PaginatedReaderProps) {\n  const containerRef = useRef<HTMLDivElement>(null);\n  const viewportRef = useRef<HTMLDivElement>(null);\n  const articleRef = useRef<HTMLElement>(null);\n  const [currentPage, setCurrentPage] = useState(0);\n  const [totalPages, setTotalPages] = useState(1);\n  const hasRestoredRef = useRef(false);\n  const saveTimerRef = useRef<ReturnType<typeof setTimeout> | null>(null);\n\n  // Multi-chapter state\n  const [loadedChapters, setLoadedChapters] = useState<LoadedChapter[]>([]);\n  const [chapterRanges, setChapterRanges] = useState<ChapterPageRange[]>([]);\n  const [activeChapterSlug, setActiveChapterSlug] = useState(\n    currentChapterSlug || \"\"\n  );\n  const preloadingRef = useRef<Set<string>>(new Set());\n\n  // Whether we're in multi-chapter mode\n  const isMultiChapter = !!(\n    chapterMapData &&\n    initialContent &&\n    currentChapterSlug &&\n    allChapters\n  );\n\n  // Initialize loaded chapters\n  useEffect(() => {\n    if (isMultiChapter && initialContent && currentChapterSlug) {\n      const chapterInfo = allChapters!.find(\n        (ch) => ch.slug === currentChapterSlug\n      );\n      setLoadedChapters([\n        {\n          slug: currentChapterSlug,\n          title: chapterInfo?.title || currentChapterSlug,\n          Content: initialContent,\n        },\n      ]);\n      setActiveChapterSlug(currentChapterSlug);\n    }\n  }, []); // Only on mount\n\n  // Settings & TOC panel state\n  const [settingsOpen, setSettingsOpen] = useState(false);\n  const [tocOpen, setTocOpen] = useState(false);\n  const [activeTheme, setActiveTheme] = useState<string>(() => {\n    if (typeof localStorage !== \"undefined\") {\n      return localStorage.getItem(\"pressy-theme\") || \"light\";\n    }\n    return \"light\";\n  });\n  const [fontScale, setFontScale] = useState<number>(() => {\n    if (typeof localStorage !== \"undefined\") {\n      const saved = localStorage.getItem(\"pressy-font-size\");\n      return saved ? parseFloat(saved) : 1.0;\n    }\n    return 1.0;\n  });\n\n  const applyFontScale = useCallback((scale: number) => {\n    if (scale === 1.0) {\n      document.documentElement.style.removeProperty(\"--font-size-base\");\n    } else {\n      document.documentElement.style.setProperty(\n        \"--font-size-base\",\n        `calc(clamp(1rem, 0.875rem + 0.5vw, 1.25rem) * ${scale})`\n      );\n    }\n  }, []);\n\n  // Apply saved font scale on mount\n  useEffect(() => {\n    if (fontScale !== 1.0) {\n      applyFontScale(fontScale);\n    }\n  }, []);\n\n  const handleThemeChange = useCallback((theme: string) => {\n    setActiveTheme(theme);\n    localStorage.setItem(\"pressy-theme\", theme);\n    const resolved =\n      theme === \"system\"\n        ? window.matchMedia(\"(prefers-color-scheme: dark)\").matches\n          ? \"dark\"\n          : \"light\"\n        : theme;\n    document.documentElement.setAttribute(\"data-theme\", resolved);\n  }, []);\n\n  // Drag/swipe state\n  const [isDragging, setIsDragging] = useState(false);\n  const [dragOffset, setDragOffset] = useState(0);\n  const [chapterHint, setChapterHint] = useState<\"next\" | \"prev\" | null>(null);\n\n  // Touch tracking refs (avoid re-renders during drag)\n  const touchStartXRef = useRef(0);\n  const touchStartYRef = useRef(0);\n  const lastTouchXRef = useRef(0);\n  const lastTouchTimeRef = useRef(0);\n  const velocityRef = useRef(0);\n  const isSwipingRef = useRef(false);\n  const isDraggingRef = useRef(false);\n\n  // Build page-to-chapter map after recalculating pages\n  const updateChapterRanges = useCallback(() => {\n    if (!isMultiChapter) return;\n    const article = articleRef.current;\n    const viewport = viewportRef.current;\n    if (!article || !viewport) return;\n\n    const viewportWidth = viewport.clientWidth;\n    if (viewportWidth === 0) return;\n\n    const sections = article.querySelectorAll(\".pressy-chapter-section\");\n    const ranges: ChapterPageRange[] = [];\n\n    sections.forEach((section) => {\n      const slug = section.getAttribute(\"data-chapter-slug\") || \"\";\n      const sectionLeft = (section as HTMLElement).offsetLeft;\n      const sectionWidth = (section as HTMLElement).scrollWidth;\n      const startPage = Math.floor(sectionLeft / viewportWidth);\n      const endPage = Math.max(\n        startPage,\n        Math.ceil((sectionLeft + sectionWidth) / viewportWidth) - 1\n      );\n      ranges.push({ slug, startPage, endPage });\n    });\n\n    setChapterRanges(ranges);\n  }, [isMultiChapter]);\n\n  // Calculate page count and set column-width to match viewport\n  const recalculatePages = useCallback(() => {\n    const article = articleRef.current;\n    const viewport = viewportRef.current;\n    if (!article || !viewport) return;\n\n    const viewportWidth = viewport.clientWidth;\n    if (viewportWidth === 0) return;\n\n    // Set column-width to viewport width so each column = one page\n    article.style.columnWidth = `${viewportWidth}px`;\n\n    // Force synchronous layout recalculation\n    void article.scrollWidth;\n\n    const total = Math.max(1, Math.round(article.scrollWidth / viewportWidth));\n    setTotalPages(total);\n\n    // Clamp current page if now out of bounds (e.g. after resize)\n    setCurrentPage((prev) => Math.min(prev, total - 1));\n\n    // Update chapter ranges for multi-chapter mode\n    updateChapterRanges();\n  }, [updateChapterRanges]);\n\n  // Font size change handler (defined after recalculatePages)\n  const handleFontSizeChange = useCallback(\n    (delta: number) => {\n      setFontScale((prev) => {\n        const next =\n          Math.round(Math.max(0.8, Math.min(1.5, prev + delta)) * 10) / 10;\n        localStorage.setItem(\"pressy-font-size\", String(next));\n        applyFontScale(next);\n        setTimeout(() => recalculatePages(), 100);\n        return next;\n      });\n    },\n    [applyFontScale, recalculatePages]\n  );\n\n  // Recalculate on mount and on resize via ResizeObserver\n  useEffect(() => {\n    const viewport = viewportRef.current;\n    if (!viewport) return;\n\n    // Delay initial calculation to let fonts and content render\n    const initialTimer = setTimeout(recalculatePages, 50);\n\n    const observer = new ResizeObserver(() => {\n      recalculatePages();\n    });\n    observer.observe(viewport);\n\n    return () => {\n      clearTimeout(initialTimer);\n      observer.disconnect();\n    };\n  }, [recalculatePages]);\n\n  // Recalculate when loaded chapters change\n  useEffect(() => {\n    if (loadedChapters.length > 0) {\n      // Delay to let new content render\n      const timer = setTimeout(recalculatePages, 50);\n      return () => clearTimeout(timer);\n    }\n  }, [loadedChapters.length, recalculatePages]);\n\n  // Recalculate when images finish loading\n  useEffect(() => {\n    const article = articleRef.current;\n    if (!article) return;\n\n    const images = article.querySelectorAll(\"img\");\n    if (images.length === 0) return;\n\n    const onLoad = () => recalculatePages();\n    images.forEach((img) => {\n      if (!img.complete) {\n        img.addEventListener(\"load\", onLoad);\n        img.addEventListener(\"error\", onLoad);\n      }\n    });\n\n    return () => {\n      images.forEach((img) => {\n        img.removeEventListener(\"load\", onLoad);\n        img.removeEventListener(\"error\", onLoad);\n      });\n    };\n  }, [recalculatePages, loadedChapters.length]);\n\n  // Check ?page=last query param for backward navigation\n  useEffect(() => {\n    const params = new URLSearchParams(window.location.search);\n    if (params.get(\"page\") === \"last\" && totalPages > 1) {\n      setCurrentPage(totalPages - 1);\n      hasRestoredRef.current = true;\n      // Clean up the URL\n      const url = new URL(window.location.href);\n      url.searchParams.delete(\"page\");\n      history.replaceState(null, \"\", url.pathname);\n    }\n  }, [totalPages]);\n\n  // Apply translateX — combines page position + drag offset\n  useEffect(() => {\n    const article = articleRef.current;\n    const viewport = viewportRef.current;\n    if (!article || !viewport) return;\n\n    const baseOffset = currentPage * viewport.clientWidth;\n    const totalOffset = baseOffset - dragOffset;\n\n    if (isDragging) {\n      // During drag: no transition, immediate response\n      article.style.transition = \"none\";\n    } else {\n      // Snap animation: smooth ease-out\n      article.style.transition =\n        \"transform 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94)\";\n    }\n\n    article.style.transform = `translateX(-${totalOffset}px)`;\n  }, [currentPage, dragOffset, isDragging]);\n\n  // Manage focusability: elements on off-screen pages get tabindex=\"-1\"\n  // so tab navigation can't reach them and cause layout shifts.\n  // Uses getBoundingClientRect which accounts for the CSS transform.\n  useEffect(() => {\n    const article = articleRef.current;\n    const viewport = viewportRef.current;\n    if (!article || !viewport) return;\n\n    const viewportRect = viewport.getBoundingClientRect();\n\n    const focusable = article.querySelectorAll<HTMLElement>(\n      \"a[href], button, input, select, textarea, [tabindex]\"\n    );\n\n    focusable.forEach((el) => {\n      const elRect = el.getBoundingClientRect();\n      const onCurrentPage =\n        elRect.left >= viewportRect.left - 1 &&\n        elRect.right <= viewportRect.right + 1;\n\n      if (onCurrentPage) {\n        const original = el.getAttribute(\"data-original-tabindex\");\n        if (original !== null) {\n          if (original === \"\") {\n            el.removeAttribute(\"tabindex\");\n          } else {\n            el.setAttribute(\"tabindex\", original);\n          }\n          el.removeAttribute(\"data-original-tabindex\");\n        }\n      } else {\n        if (!el.hasAttribute(\"data-original-tabindex\")) {\n          el.setAttribute(\n            \"data-original-tabindex\",\n            el.getAttribute(\"tabindex\") || \"\"\n          );\n        }\n        el.setAttribute(\"tabindex\", \"-1\");\n      }\n    });\n  }, [currentPage, totalPages]);\n\n  // Preload next chapter when within 2 pages of chapter end\n  useEffect(() => {\n    if (!isMultiChapter || !chapterMapData || chapterRanges.length === 0)\n      return;\n\n    const activeRange = chapterRanges.find((r) => r.slug === activeChapterSlug);\n    if (!activeRange) return;\n\n    const pagesFromEnd = activeRange.endPage - currentPage;\n    if (pagesFromEnd > 2) return;\n\n    // Find the next chapter to preload\n    const { chapterOrder, chapterMap } = chapterMapData;\n    const lastLoadedSlug = loadedChapters[loadedChapters.length - 1]?.slug;\n    const lastLoadedIdx = chapterOrder.indexOf(lastLoadedSlug);\n    if (lastLoadedIdx === -1 || lastLoadedIdx >= chapterOrder.length - 1)\n      return;\n\n    const nextSlug = chapterOrder[lastLoadedIdx + 1];\n    if (preloadingRef.current.has(nextSlug)) return;\n    if (loadedChapters.some((ch) => ch.slug === nextSlug)) return;\n\n    preloadingRef.current.add(nextSlug);\n\n    const loader = chapterMap[nextSlug];\n    if (!loader) return;\n\n    loader()\n      .then((mod) => {\n        const Content = mod.default;\n        const chapterInfo = allChapters!.find((ch) => ch.slug === nextSlug);\n        setLoadedChapters((prev) => {\n          if (prev.some((ch) => ch.slug === nextSlug)) return prev;\n          return [\n            ...prev,\n            {\n              slug: nextSlug,\n              title: chapterInfo?.title || nextSlug,\n              Content,\n            },\n          ];\n        });\n      })\n      .catch(() => {\n        // Dynamic import failed — will fall back to full-page navigation\n        preloadingRef.current.delete(nextSlug);\n      });\n  }, [\n    currentPage,\n    activeChapterSlug,\n    chapterRanges,\n    isMultiChapter,\n    chapterMapData,\n    loadedChapters,\n    allChapters,\n  ]);\n\n  // Detect chapter boundary crossings and update URL / active chapter\n  useEffect(() => {\n    if (!isMultiChapter || chapterRanges.length === 0 || !bookBasePath) return;\n\n    const currentRange = chapterRanges.find(\n      (r) => currentPage >= r.startPage && currentPage <= r.endPage\n    );\n    if (!currentRange || currentRange.slug === activeChapterSlug) return;\n\n    const prevSlug = activeChapterSlug;\n    setActiveChapterSlug(currentRange.slug);\n\n    // Update URL\n    const newPath = `${bookBasePath}/${currentRange.slug}`;\n    history.replaceState(null, \"\", newPath);\n\n    // Update document title\n    const chapterInfo = allChapters?.find(\n      (ch) => ch.slug === currentRange.slug\n    );\n    if (chapterInfo) {\n      document.title = document.title.replace(\n        /^[^|]+/,\n        chapterInfo.title + \" \"\n      );\n    }\n\n    // Notify parent about chapter change (saves progress for the chapter being left)\n    if (onChapterChange && prevSlug) {\n      const prevRange = chapterRanges.find((r) => r.slug === prevSlug);\n      if (prevRange) {\n        const prevTotalPages = prevRange.endPage - prevRange.startPage + 1;\n        onChapterChange(prevSlug, prevTotalPages - 1, prevTotalPages);\n      }\n    }\n  }, [\n    currentPage,\n    chapterRanges,\n    activeChapterSlug,\n    isMultiChapter,\n    bookBasePath,\n    allChapters,\n    onChapterChange,\n  ]);\n\n  // Save progress when page changes (debounced) — save relative to active chapter\n  useEffect(() => {\n    if (!onSaveProgress || !hasRestoredRef.current) return;\n\n    if (saveTimerRef.current) clearTimeout(saveTimerRef.current);\n    saveTimerRef.current = setTimeout(() => {\n      if (isMultiChapter && chapterRanges.length > 0) {\n        const activeRange = chapterRanges.find(\n          (r) => r.slug === activeChapterSlug\n        );\n        if (activeRange) {\n          const chapterPage = currentPage - activeRange.startPage;\n          const chapterTotalPages =\n            activeRange.endPage - activeRange.startPage + 1;\n          onSaveProgress({\n            page: chapterPage,\n            totalPages: chapterTotalPages,\n            scrollPosition: 0,\n          });\n        }\n      } else {\n        onSaveProgress({\n          page: currentPage,\n          totalPages,\n          scrollPosition: 0,\n        });\n      }\n    }, 300);\n\n    return () => {\n      if (saveTimerRef.current) clearTimeout(saveTimerRef.current);\n    };\n  }, [\n    currentPage,\n    totalPages,\n    onSaveProgress,\n    isMultiChapter,\n    chapterRanges,\n    activeChapterSlug,\n  ]);\n\n  // Save progress on page unload\n  useEffect(() => {\n    if (!onSaveProgress) return;\n\n    const handleUnload = () => {\n      if (isMultiChapter && chapterRanges.length > 0) {\n        const activeRange = chapterRanges.find(\n          (r) => r.slug === activeChapterSlug\n        );\n        if (activeRange) {\n          const chapterPage = currentPage - activeRange.startPage;\n          const chapterTotalPages =\n            activeRange.endPage - activeRange.startPage + 1;\n          onSaveProgress({\n            page: chapterPage,\n            totalPages: chapterTotalPages,\n            scrollPosition: 0,\n          });\n        }\n      } else {\n        onSaveProgress({\n          page: currentPage,\n          totalPages,\n          scrollPosition: 0,\n        });\n      }\n    };\n\n    window.addEventListener(\"beforeunload\", handleUnload);\n    return () => window.removeEventListener(\"beforeunload\", handleUnload);\n  }, [\n    currentPage,\n    totalPages,\n    onSaveProgress,\n    isMultiChapter,\n    chapterRanges,\n    activeChapterSlug,\n  ]);\n\n  // Determine the effective last chapter slug for rubber-band / next chapter hint\n  const effectiveNextChapter = (() => {\n    if (!isMultiChapter || !chapterMapData) return nextChapter;\n    const { chapterOrder } = chapterMapData;\n    const lastLoadedSlug = loadedChapters[loadedChapters.length - 1]?.slug;\n    const lastLoadedIdx = chapterOrder.indexOf(lastLoadedSlug);\n    // If we haven't loaded the last chapter in the book yet, no next chapter hint needed\n    // (preloading will seamlessly add the next chapter)\n    if (lastLoadedIdx < chapterOrder.length - 1) return undefined;\n    // All chapters loaded — navigate to book table of contents\n    if (bookBasePath) return { slug: bookBasePath, title: \"Table of Contents\" };\n    return nextChapter;\n  })();\n\n  // Determine the effective prev chapter for backward navigation\n  const effectivePrevChapter = (() => {\n    if (!isMultiChapter || !chapterMapData) return prevChapter;\n    const { chapterOrder } = chapterMapData;\n    const firstLoadedSlug = loadedChapters[0]?.slug;\n    const firstLoadedIdx = chapterOrder.indexOf(firstLoadedSlug);\n    // If the first loaded chapter is the first chapter of the book\n    if (firstLoadedIdx <= 0) return prevChapter;\n    // There's a previous chapter in the book — navigate to it via page load\n    const prevSlug = chapterOrder[firstLoadedIdx - 1];\n    const prevInfo = allChapters?.find((ch) => ch.slug === prevSlug);\n    return {\n      slug: `${bookBasePath}/${prevSlug}?page=last`,\n      title: prevInfo?.title || prevSlug,\n    };\n  })();\n\n  const goToPage = useCallback(\n    (page: number) => {\n      const clamped = Math.max(0, Math.min(page, totalPages - 1));\n      setCurrentPage(clamped);\n    },\n    [totalPages]\n  );\n\n  const goNext = useCallback(() => {\n    if (currentPage >= totalPages - 1) {\n      // At the last page — navigate to next chapter if available\n      if (effectiveNextChapter) {\n        window.location.href = effectiveNextChapter.slug;\n      }\n      return;\n    }\n    goToPage(currentPage + 1);\n  }, [currentPage, totalPages, effectiveNextChapter, goToPage]);\n\n  const goPrev = useCallback(() => {\n    if (currentPage <= 0) {\n      // At the first page — navigate to prev chapter if available\n      if (effectivePrevChapter) {\n        window.location.href = effectivePrevChapter.slug;\n      }\n      return;\n    }\n    goToPage(currentPage - 1);\n  }, [currentPage, effectivePrevChapter, goToPage]);\n\n  // Footer visibility — hidden by default, shown on interaction\n  const [footerVisible, setFooterVisible] = useState(false);\n  const footerTimerRef = useRef<ReturnType<typeof setTimeout> | null>(null);\n\n  const showFooterTemporarily = useCallback(() => {\n    setFooterVisible(true);\n    if (footerTimerRef.current) clearTimeout(footerTimerRef.current);\n    footerTimerRef.current = setTimeout(() => setFooterVisible(false), 3000);\n  }, []);\n\n  // Double-tap fullscreen (mobile middle-third)\n  const lastMiddleTapRef = useRef(0);\n  const middleTapTimerRef = useRef<ReturnType<typeof setTimeout> | null>(null);\n\n  const toggleFullscreen = useCallback(() => {\n    if (document.fullscreenElement) {\n      document.exitFullscreen();\n    } else {\n      document.documentElement.requestFullscreen().catch(() => {\n        // Fullscreen not supported or denied\n      });\n    }\n  }, []);\n\n  // Whether the device supports hover (i.e. desktop with a mouse).\n  // Touch-only devices use swipe for page turns; tapping just toggles the footer.\n  const isTouchDevice =\n    typeof window !== \"undefined\" && window.matchMedia(\"(hover: none)\").matches;\n\n  // Click handler: on desktop, edge clicks turn pages and middle clicks\n  // toggle footer / double-click fullscreen. On touch devices, any tap\n  // simply toggles the footer — swiping handles all page navigation.\n  const handleContainerClick = useCallback(\n    (e: MouseEvent) => {\n      const target = e.target as HTMLElement;\n\n      // Clicks inside panels or on interactive elements — ignore\n      if (\n        target.closest(\n          \".pressy-settings-panel, .pressy-settings-toggle, .pressy-toc-drawer, .pressy-toc-toggle\"\n        )\n      )\n        return;\n      if (target.closest('a, button, input, select, textarea, [role=\"button\"]'))\n        return;\n\n      // If settings or TOC panel is open, close it on any outside click\n      if (settingsOpen || tocOpen) {\n        setSettingsOpen(false);\n        setTocOpen(false);\n        return;\n      }\n\n      // Touch devices: tap anywhere toggles the footer, nothing else\n      if (isTouchDevice) {\n        if (footerVisible) {\n          setFooterVisible(false);\n          if (footerTimerRef.current) clearTimeout(footerTimerRef.current);\n        } else {\n          showFooterTemporarily();\n        }\n        return;\n      }\n\n      // Desktop: edge clicks turn pages, middle clicks toggle footer / fullscreen\n      const container = containerRef.current;\n      if (!container) return;\n\n      const rect = container.getBoundingClientRect();\n      const x = e.clientX - rect.left;\n      const edgeZone = rect.width * 0.15;\n\n      if (x < edgeZone) {\n        goPrev();\n      } else if (x > rect.width - edgeZone) {\n        goNext();\n      } else {\n        // Middle third — single click toggles footer, double click toggles fullscreen\n        const now = Date.now();\n        const timeSinceLastTap = now - lastMiddleTapRef.current;\n        lastMiddleTapRef.current = now;\n\n        if (timeSinceLastTap < 300) {\n          if (middleTapTimerRef.current)\n            clearTimeout(middleTapTimerRef.current);\n          toggleFullscreen();\n        } else {\n          if (middleTapTimerRef.current)\n            clearTimeout(middleTapTimerRef.current);\n          middleTapTimerRef.current = setTimeout(() => {\n            if (footerVisible) {\n              setFooterVisible(false);\n              if (footerTimerRef.current) clearTimeout(footerTimerRef.current);\n            } else {\n              showFooterTemporarily();\n            }\n          }, 300);\n        }\n      }\n    },\n    [\n      goNext,\n      goPrev,\n      footerVisible,\n      isTouchDevice,\n      settingsOpen,\n      tocOpen,\n      showFooterTemporarily,\n      toggleFullscreen,\n    ]\n  );\n\n  // Hover zone tracking for desktop navigation hints\n  const [hoverZone, setHoverZone] = useState<\"left\" | \"right\" | null>(null);\n\n  const handleMouseMove = useCallback(\n    (e: MouseEvent) => {\n      const container = containerRef.current;\n      if (!container) return;\n\n      const rect = container.getBoundingClientRect();\n      const x = e.clientX - rect.left;\n      const y = e.clientY - rect.top;\n      const third = rect.width / 3;\n\n      if (x < third) {\n        setHoverZone(\"left\");\n      } else if (x > third * 2) {\n        setHoverZone(\"right\");\n      } else {\n        setHoverZone(null);\n      }\n\n      // Show footer when mouse is in the bottom quarter\n      if (y > rect.height * 0.75) {\n        setFooterVisible(true);\n        if (footerTimerRef.current) clearTimeout(footerTimerRef.current);\n      } else if (!settingsOpen && !tocOpen) {\n        // Hide after a short delay when leaving the bottom area (not when panels are open)\n        if (footerTimerRef.current) clearTimeout(footerTimerRef.current);\n        footerTimerRef.current = setTimeout(() => setFooterVisible(false), 600);\n      }\n    },\n    [settingsOpen, tocOpen]\n  );\n\n  const handleMouseLeave = useCallback(() => {\n    setHoverZone(null);\n    if (!settingsOpen && !tocOpen) {\n      if (footerTimerRef.current) clearTimeout(footerTimerRef.current);\n      footerTimerRef.current = setTimeout(() => setFooterVisible(false), 600);\n    }\n  }, [settingsOpen, tocOpen]);\n\n  // Keyboard navigation\n  useEffect(() => {\n    const handleKeyDown = (e: KeyboardEvent) => {\n      // Don't intercept if user is in an input/textarea\n      const tag = (e.target as HTMLElement).tagName;\n      if (tag === \"INPUT\" || tag === \"TEXTAREA\" || tag === \"SELECT\") return;\n\n      if (e.key === \"ArrowRight\" || e.key === \" \") {\n        e.preventDefault();\n        goNext();\n      } else if (e.key === \"ArrowLeft\") {\n        e.preventDefault();\n        goPrev();\n      } else if (e.key === \"Home\") {\n        e.preventDefault();\n        goToPage(0);\n      } else if (e.key === \"End\") {\n        e.preventDefault();\n        goToPage(totalPages - 1);\n      }\n    };\n\n    window.addEventListener(\"keydown\", handleKeyDown);\n    return () => window.removeEventListener(\"keydown\", handleKeyDown);\n  }, [goNext, goPrev, goToPage, totalPages]);\n\n  // Touch swipe navigation with drag tracking, velocity detection, and rubber-band.\n  // Listeners attach to the outer container (not the viewport) so they capture\n  // touches that land on sibling elements like the tap-zone overlays.\n  useEffect(() => {\n    const container = containerRef.current;\n    if (!container) return;\n\n    const onTouchStart = (e: TouchEvent) => {\n      const touch = e.touches[0];\n      touchStartXRef.current = touch.clientX;\n      touchStartYRef.current = touch.clientY;\n      lastTouchXRef.current = touch.clientX;\n      lastTouchTimeRef.current = performance.now();\n      velocityRef.current = 0;\n      isSwipingRef.current = false;\n      isDraggingRef.current = false;\n    };\n\n    const onTouchMove = (e: TouchEvent) => {\n      const touch = e.touches[0];\n      const dx = touch.clientX - touchStartXRef.current;\n      const dy = touch.clientY - touchStartYRef.current;\n\n      // Lock direction after initial movement\n      if (!isSwipingRef.current) {\n        if (Math.abs(dx) > Math.abs(dy) && Math.abs(dx) > 10) {\n          isSwipingRef.current = true;\n        } else if (Math.abs(dy) > Math.abs(dx) && Math.abs(dy) > 10) {\n          // Vertical scroll — not our concern\n          return;\n        } else {\n          return; // Not enough movement yet\n        }\n      }\n\n      e.preventDefault();\n\n      // Track velocity (px per ms) using last touch position\n      const now = performance.now();\n      const timeDelta = now - lastTouchTimeRef.current;\n      if (timeDelta > 0) {\n        const instantVelocity =\n          (touch.clientX - lastTouchXRef.current) / timeDelta;\n        // Smooth velocity with exponential moving average\n        velocityRef.current = 0.6 * instantVelocity + 0.4 * velocityRef.current;\n      }\n      lastTouchXRef.current = touch.clientX;\n      lastTouchTimeRef.current = now;\n\n      // Determine drag offset with rubber-band resistance at boundaries\n      let offset = dx;\n      const atStart = currentPage === 0;\n      const atEnd = currentPage >= totalPages - 1;\n\n      if ((atStart && dx > 0) || (atEnd && dx < 0)) {\n        // Rubber-band: diminishing resistance using square root curve\n        // This gives a natural iOS-like rubber-band feel\n        const sign = dx > 0 ? 1 : -1;\n        const absDx = Math.abs(dx);\n        offset = sign * Math.sqrt(absDx) * 5;\n\n        // Show chapter hint when overscrolling past boundary\n        if (dx > 40 && atStart && effectivePrevChapter) {\n          setChapterHint(\"prev\");\n        } else if (dx < -40 && atEnd && effectiveNextChapter) {\n          setChapterHint(\"next\");\n        } else {\n          setChapterHint(null);\n        }\n      } else {\n        setChapterHint(null);\n      }\n\n      isDraggingRef.current = true;\n      setIsDragging(true);\n      setDragOffset(offset);\n    };\n\n    const onTouchEnd = (e: TouchEvent) => {\n      if (!isSwipingRef.current || !isDraggingRef.current) {\n        setIsDragging(false);\n        setDragOffset(0);\n        setChapterHint(null);\n        return;\n      }\n\n      const dx = e.changedTouches[0].clientX - touchStartXRef.current;\n      const velocity = velocityRef.current; // px/ms\n      const distanceThreshold = 50;\n      const velocityThreshold = 0.3; // px/ms — a fast flick\n      const chapterThreshold = 80;\n\n      const atStart = currentPage === 0;\n      const atEnd = currentPage >= totalPages - 1;\n\n      // Chapter navigation on overscroll\n      if (atEnd && dx < -chapterThreshold && effectiveNextChapter) {\n        setIsDragging(false);\n        setDragOffset(0);\n        setChapterHint(null);\n        window.location.href = effectiveNextChapter.slug;\n        return;\n      }\n      if (atStart && dx > chapterThreshold && effectivePrevChapter) {\n        setIsDragging(false);\n        setDragOffset(0);\n        setChapterHint(null);\n        window.location.href = effectivePrevChapter.slug;\n        return;\n      }\n\n      // Determine page change: distance OR velocity triggers a turn\n      if (dx < -distanceThreshold || velocity < -velocityThreshold) {\n        goNext();\n      } else if (dx > distanceThreshold || velocity > velocityThreshold) {\n        goPrev();\n      }\n\n      // Reset drag state — the CSS transition handles the snap animation\n      isDraggingRef.current = false;\n      setIsDragging(false);\n      setDragOffset(0);\n      setChapterHint(null);\n    };\n\n    // Cancel drag if touch is interrupted\n    const onTouchCancel = () => {\n      isDraggingRef.current = false;\n      setIsDragging(false);\n      setDragOffset(0);\n      setChapterHint(null);\n    };\n\n    container.addEventListener(\"touchstart\", onTouchStart, { passive: true });\n    container.addEventListener(\"touchmove\", onTouchMove, { passive: false });\n    container.addEventListener(\"touchend\", onTouchEnd, { passive: true });\n    container.addEventListener(\"touchcancel\", onTouchCancel, { passive: true });\n\n    return () => {\n      container.removeEventListener(\"touchstart\", onTouchStart);\n      container.removeEventListener(\"touchmove\", onTouchMove);\n      container.removeEventListener(\"touchend\", onTouchEnd);\n      container.removeEventListener(\"touchcancel\", onTouchCancel);\n    };\n  }, [\n    currentPage,\n    totalPages,\n    goNext,\n    goPrev,\n    effectiveNextChapter,\n    effectivePrevChapter,\n  ]);\n\n  // Compute per-chapter page indicator values\n  const chapterPageInfo = (() => {\n    if (!isMultiChapter || chapterRanges.length === 0) {\n      return { chapterPage: currentPage, chapterTotalPages: totalPages };\n    }\n    const activeRange = chapterRanges.find((r) => r.slug === activeChapterSlug);\n    if (!activeRange) {\n      return { chapterPage: currentPage, chapterTotalPages: totalPages };\n    }\n    return {\n      chapterPage: currentPage - activeRange.startPage,\n      chapterTotalPages: activeRange.endPage - activeRange.startPage + 1,\n    };\n  })();\n\n  // Book progress: position in the entire book based on word counts.\n  // Maps currentPage/totalPages (across all loaded content) through\n  // word counts to estimate absolute position in the full book.\n  const progressPercent = (() => {\n    if (!allChapters || allChapters.length === 0) {\n      return totalPages > 1 ? (currentPage / (totalPages - 1)) * 100 : 100;\n    }\n\n    const totalWords = allChapters.reduce(\n      (sum, ch) => sum + (ch.wordCount || 0),\n      0\n    );\n    if (totalWords === 0) return 0;\n\n    const firstLoadedSlug = loadedChapters[0]?.slug || activeChapterSlug;\n    let wordsBeforeLoaded = 0;\n    let loadedWords = 0;\n    let foundFirst = false;\n\n    for (const ch of allChapters) {\n      if (ch.slug === firstLoadedSlug) foundFirst = true;\n      if (!foundFirst) {\n        wordsBeforeLoaded += ch.wordCount || 0;\n      } else if (loadedChapters.some((lc) => lc.slug === ch.slug)) {\n        loadedWords += ch.wordCount || 0;\n      } else {\n        break;\n      }\n    }\n\n    const pageFraction = totalPages > 1 ? currentPage / (totalPages - 1) : 0;\n    const wordsInto = wordsBeforeLoaded + pageFraction * loadedWords;\n\n    return Math.min(100, (wordsInto / totalWords) * 100);\n  })();\n\n  // Render content — either multi-chapter sections or single-chapter children\n  const renderContent = () => {\n    if (isMultiChapter && loadedChapters.length > 0) {\n      return loadedChapters.map((ch) => (\n        <section\n          key={ch.slug}\n          class=\"pressy-chapter-section\"\n          data-chapter-slug={ch.slug}\n        >\n          <ChapterDivider title={ch.title} />\n          <ch.Content components={mdxComponents || {}} />\n        </section>\n      ));\n    }\n    return children;\n  };\n\n  return (\n    <div\n      class=\"pressy-reader pressy-reader--paginated\"\n      ref={containerRef}\n      onClick={handleContainerClick}\n      onMouseMove={handleMouseMove}\n      onMouseLeave={handleMouseLeave}\n    >\n      {/* Paginated content viewport */}\n      <div class=\"pressy-paginated-viewport\" ref={viewportRef}>\n        <article\n          ref={articleRef}\n          class={`pressy-prose pressy-prose--paginated ${\n            showDropCap ? \"\" : \"no-drop-cap\"\n          }`}\n          data-drop-cap={showDropCap}\n        >\n          {renderContent()}\n        </article>\n      </div>\n\n      {/* Navigation arrows — appear on hover in left/right thirds */}\n      <div\n        class={`pressy-nav-arrow pressy-nav-arrow--prev ${\n          hoverZone === \"left\" ? \"pressy-nav-arrow--visible\" : \"\"\n        }`}\n      >\n        <svg\n          viewBox=\"0 0 24 24\"\n          fill=\"none\"\n          stroke=\"currentColor\"\n          stroke-width=\"2\"\n          stroke-linecap=\"round\"\n          stroke-linejoin=\"round\"\n        >\n          <polyline points=\"15 18 9 12 15 6\" />\n        </svg>\n      </div>\n      <div\n        class={`pressy-nav-arrow pressy-nav-arrow--next ${\n          hoverZone === \"right\" ? \"pressy-nav-arrow--visible\" : \"\"\n        }`}\n      >\n        <svg\n          viewBox=\"0 0 24 24\"\n          fill=\"none\"\n          stroke=\"currentColor\"\n          stroke-width=\"2\"\n          stroke-linecap=\"round\"\n          stroke-linejoin=\"round\"\n        >\n          <polyline points=\"9 6 15 12 9 18\" />\n        </svg>\n      </div>\n\n      {/* Chapter boundary hints */}\n      {chapterHint === \"prev\" && effectivePrevChapter && (\n        <div\n          class=\"pressy-chapter-hint pressy-chapter-hint--prev\"\n          aria-live=\"polite\"\n        >\n          <span class=\"pressy-chapter-hint-arrow\">{\"\\u2190\"}</span>\n          <span class=\"pressy-chapter-hint-text\">\n            {effectivePrevChapter.title}\n          </span>\n        </div>\n      )}\n      {chapterHint === \"next\" && effectiveNextChapter && (\n        <div\n          class=\"pressy-chapter-hint pressy-chapter-hint--next\"\n          aria-live=\"polite\"\n        >\n          <span class=\"pressy-chapter-hint-text\">\n            {effectiveNextChapter.title}\n          </span>\n          <span class=\"pressy-chapter-hint-arrow\">{\"\\u2192\"}</span>\n        </div>\n      )}\n\n      {/* TOC drawer overlay */}\n      {tocOpen && allChapters && (\n        <div\n          class=\"pressy-toc-backdrop\"\n          onClick={(e: MouseEvent) => {\n            e.stopPropagation();\n            setTocOpen(false);\n          }}\n        >\n          <div\n            class=\"pressy-toc-drawer\"\n            onClick={(e: MouseEvent) => e.stopPropagation()}\n          >\n            <div class=\"pressy-toc-header\">\n              <span class=\"pressy-toc-title\">Contents</span>\n              <button\n                class=\"pressy-toc-close\"\n                onClick={(e: MouseEvent) => {\n                  e.stopPropagation();\n                  setTocOpen(false);\n                }}\n                aria-label=\"Close table of contents\"\n              >\n                <svg\n                  viewBox=\"0 0 24 24\"\n                  fill=\"none\"\n                  stroke=\"currentColor\"\n                  stroke-width=\"2\"\n                  width=\"18\"\n                  height=\"18\"\n                >\n                  <line x1=\"18\" y1=\"6\" x2=\"6\" y2=\"18\" />\n                  <line x1=\"6\" y1=\"6\" x2=\"18\" y2=\"18\" />\n                </svg>\n              </button>\n            </div>\n            <nav class=\"pressy-toc-list\">\n              <a\n                href={bookBasePath ? bookBasePath.replace(/\\/books\\/[^/]+$/, '') || '/' : '/'}\n                class=\"pressy-toc-item pressy-toc-item--home\"\n                onClick={() => setTocOpen(false)}\n              >\n                <span class=\"pressy-toc-item-num\">\n                  <svg viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" width=\"14\" height=\"14\">\n                    <path d=\"M3 9.5L12 3l9 6.5V20a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V9.5z\" />\n                  </svg>\n                </span>\n                <span class=\"pressy-toc-item-title\">{bookTitle || 'Home'}</span>\n              </a>\n              {allChapters.map((ch, i) => (\n                <a\n                  key={ch.slug}\n                  href={`${bookBasePath || \"\"}/${ch.slug}`}\n                  class={`pressy-toc-item ${\n                    ch.slug === (activeChapterSlug || currentChapterSlug)\n                      ? \"pressy-toc-item--active\"\n                      : \"\"\n                  }`}\n                  onClick={() => setTocOpen(false)}\n                >\n                  <span class=\"pressy-toc-item-num\">{i + 1}.</span>\n                  <span class=\"pressy-toc-item-title\">{ch.title}</span>\n                </a>\n              ))}\n            </nav>\n          </div>\n        </div>\n      )}\n\n      {/* Page footer with progress — hidden by default */}\n      <div\n        class={`pressy-page-footer ${\n          footerVisible || settingsOpen || tocOpen\n            ? \"pressy-page-footer--visible\"\n            : \"\"\n        }`}\n      >\n        <div class=\"pressy-progress-bar\">\n          <div\n            class=\"pressy-progress-fill\"\n            style={{ width: `${progressPercent}%` }}\n          />\n        </div>\n        <div class=\"pressy-footer-row\">\n          {allChapters && allChapters.length > 0 && (\n            <button\n              class=\"pressy-toc-toggle\"\n              onClick={(e: MouseEvent) => {\n                e.stopPropagation();\n                setSettingsOpen(false);\n                setTocOpen(!tocOpen);\n              }}\n              aria-label=\"Table of contents\"\n            >\n              <svg\n                viewBox=\"0 0 24 24\"\n                fill=\"none\"\n                stroke=\"currentColor\"\n                stroke-width=\"1.5\"\n                stroke-linecap=\"round\"\n                stroke-linejoin=\"round\"\n                width=\"18\"\n                height=\"18\"\n              >\n                <line x1=\"3\" y1=\"6\" x2=\"21\" y2=\"6\" />\n                <line x1=\"3\" y1=\"12\" x2=\"21\" y2=\"12\" />\n                <line x1=\"3\" y1=\"18\" x2=\"21\" y2=\"18\" />\n              </svg>\n            </button>\n          )}\n          {bookTitle && (\n            <button\n              class=\"pressy-footer-title\"\n              onClick={(e: MouseEvent) => {\n                e.stopPropagation();\n                if (allChapters && allChapters.length > 0) {\n                  setSettingsOpen(false);\n                  setTocOpen(!tocOpen);\n                }\n              }}\n            >\n              {bookTitle}\n            </button>\n          )}\n          <OfflineFooterIcon offlineProps={offlineProps} />\n          <button\n            class=\"pressy-settings-toggle\"\n            onClick={(e: MouseEvent) => {\n              e.stopPropagation();\n              setTocOpen(false);\n              setSettingsOpen(!settingsOpen);\n            }}\n            aria-label=\"Settings\"\n          >\n            <svg\n              viewBox=\"0 0 24 24\"\n              fill=\"none\"\n              stroke=\"currentColor\"\n              stroke-width=\"1.5\"\n              stroke-linecap=\"round\"\n              stroke-linejoin=\"round\"\n              width=\"18\"\n              height=\"18\"\n            >\n              <circle cx=\"12\" cy=\"12\" r=\"3\" />\n              <path d=\"M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z\" />\n            </svg>\n          </button>\n        </div>\n\n        {/* Settings panel */}\n        <div\n          class={`pressy-settings-panel ${\n            settingsOpen ? \"pressy-settings-panel--open\" : \"\"\n          }`}\n        >\n          <div class=\"pressy-settings-section\">\n            <div class=\"pressy-settings-label\">Theme</div>\n            <div class=\"pressy-theme-options\">\n              {(\n                [\n                  {\n                    id: \"light\",\n                    label: \"Light\",\n                    icon: (\n                      <svg\n                        viewBox=\"0 0 24 24\"\n                        fill=\"none\"\n                        stroke=\"currentColor\"\n                        stroke-width=\"1.5\"\n                        width=\"16\"\n                        height=\"16\"\n                      >\n                        <circle cx=\"12\" cy=\"12\" r=\"5\" />\n                        <line x1=\"12\" y1=\"1\" x2=\"12\" y2=\"3\" />\n                        <line x1=\"12\" y1=\"21\" x2=\"12\" y2=\"23\" />\n                        <line x1=\"4.22\" y1=\"4.22\" x2=\"5.64\" y2=\"5.64\" />\n                        <line x1=\"18.36\" y1=\"18.36\" x2=\"19.78\" y2=\"19.78\" />\n                        <line x1=\"1\" y1=\"12\" x2=\"3\" y2=\"12\" />\n                        <line x1=\"21\" y1=\"12\" x2=\"23\" y2=\"12\" />\n                        <line x1=\"4.22\" y1=\"19.78\" x2=\"5.64\" y2=\"18.36\" />\n                        <line x1=\"18.36\" y1=\"5.64\" x2=\"19.78\" y2=\"4.22\" />\n                      </svg>\n                    ),\n                  },\n                  {\n                    id: \"dark\",\n                    label: \"Dark\",\n                    icon: (\n                      <svg\n                        viewBox=\"0 0 24 24\"\n                        fill=\"none\"\n                        stroke=\"currentColor\"\n                        stroke-width=\"1.5\"\n                        width=\"16\"\n                        height=\"16\"\n                      >\n                        <path d=\"M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z\" />\n                      </svg>\n                    ),\n                  },\n                  {\n                    id: \"system\",\n                    label: \"System\",\n                    icon: (\n                      <svg\n                        viewBox=\"0 0 24 24\"\n                        fill=\"none\"\n                        stroke=\"currentColor\"\n                        stroke-width=\"1.5\"\n                        width=\"16\"\n                        height=\"16\"\n                      >\n                        <rect\n                          x=\"2\"\n                          y=\"3\"\n                          width=\"20\"\n                          height=\"14\"\n                          rx=\"2\"\n                          ry=\"2\"\n                        />\n                        <line x1=\"8\" y1=\"21\" x2=\"16\" y2=\"21\" />\n                        <line x1=\"12\" y1=\"17\" x2=\"12\" y2=\"21\" />\n                      </svg>\n                    ),\n                  },\n                  {\n                    id: \"sepia\",\n                    label: \"Sepia\",\n                    icon: (\n                      <svg\n                        viewBox=\"0 0 24 24\"\n                        fill=\"none\"\n                        stroke=\"currentColor\"\n                        stroke-width=\"1.5\"\n                        width=\"16\"\n                        height=\"16\"\n                      >\n                        <path d=\"M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z\" />\n                        <path d=\"M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z\" />\n                      </svg>\n                    ),\n                  },\n                ] as const\n              ).map((t) => (\n                <button\n                  key={t.id}\n                  class={`pressy-theme-btn ${\n                    activeTheme === t.id ? \"pressy-theme-btn--active\" : \"\"\n                  }`}\n                  onClick={(e: MouseEvent) => {\n                    e.stopPropagation();\n                    handleThemeChange(t.id);\n                  }}\n                >\n                  {t.icon}\n                  <span>{t.label}</span>\n                </button>\n              ))}\n            </div>\n          </div>\n          <div class=\"pressy-settings-section\">\n            <div class=\"pressy-settings-label\">Font Size</div>\n            <div class=\"pressy-font-size-controls\">\n              <button\n                class=\"pressy-font-size-btn\"\n                onClick={(e: MouseEvent) => {\n                  e.stopPropagation();\n                  handleFontSizeChange(-0.1);\n                }}\n                disabled={fontScale <= 0.8}\n                aria-label=\"Decrease font size\"\n              >\n                A-\n              </button>\n              <span class=\"pressy-font-size-value\">\n                {Math.round(fontScale * 100)}%\n              </span>\n              <button\n                class=\"pressy-font-size-btn\"\n                onClick={(e: MouseEvent) => {\n                  e.stopPropagation();\n                  handleFontSizeChange(0.1);\n                }}\n                disabled={fontScale >= 1.5}\n                aria-label=\"Increase font size\"\n              >\n                A+\n              </button>\n            </div>\n          </div>\n        </div>\n      </div>\n\n      <TextShare />\n      <OfflineIndicator />\n\n      <style>{PAGINATED_STYLES}</style>\n    </div>\n  );\n}\n\n// ── Styles ────────────────────────────────────────────────────\n\nconst SCROLL_STYLES = `\n  .pressy-reader {\n    min-height: 100vh;\n    display: flex;\n    flex-direction: column;\n  }\n\n  .pressy-reader-main {\n    flex: 1;\n    padding: 2rem 0;\n  }\n\n  /* ── Scroll reader footer ──────────────────────────────── */\n  .pressy-page-footer--scroll {\n    position: fixed;\n    bottom: 0;\n    left: 0;\n    right: 0;\n    padding: 0.5rem 1.5rem 1rem;\n    text-align: center;\n    user-select: none;\n    transform: translateY(100%);\n    opacity: 0;\n    transition: transform 0.25s ease, opacity 0.25s ease;\n    z-index: 15;\n    background: var(--color-bg, #ffffff);\n    box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.05);\n  }\n\n  .pressy-page-footer--scroll.pressy-page-footer--visible {\n    transform: translateY(0);\n    opacity: 1;\n  }\n\n  /* Shared footer styles for scroll reader */\n  .pressy-page-footer--scroll .pressy-footer-row {\n    display: flex;\n    align-items: center;\n    justify-content: space-between;\n    gap: 0.5rem;\n  }\n\n  .pressy-page-footer--scroll .pressy-footer-title {\n    font-family: var(--font-heading, system-ui, -apple-system, sans-serif);\n    font-size: 0.75rem;\n    color: var(--color-text-muted, #6c757d);\n    text-decoration: none;\n    overflow: hidden;\n    text-overflow: ellipsis;\n    white-space: nowrap;\n    min-width: 0;\n    flex: 1;\n    text-align: left;\n    border: none;\n    background: none;\n    cursor: pointer;\n    padding: 0;\n  }\n\n  .pressy-page-footer--scroll .pressy-footer-title:hover {\n    color: var(--color-text, #212529);\n  }\n\n  .pressy-page-footer--scroll .pressy-toc-toggle,\n  .pressy-page-footer--scroll .pressy-settings-toggle {\n    flex-shrink: 0;\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    width: 2rem;\n    height: 2rem;\n    border: none;\n    background: transparent;\n    color: var(--color-text-muted, #6c757d);\n    cursor: pointer;\n    border-radius: 0.375rem;\n    transition: color 0.15s, background 0.15s;\n    padding: 0;\n  }\n\n  .pressy-page-footer--scroll .pressy-toc-toggle:hover,\n  .pressy-page-footer--scroll .pressy-settings-toggle:hover {\n    color: var(--color-text, #212529);\n    background: var(--color-bg-subtle, #f8f9fa);\n  }\n\n  .pressy-page-footer--scroll .pressy-settings-panel {\n    overflow: hidden;\n    max-height: 0;\n    opacity: 0;\n    transition: max-height 0.25s ease, opacity 0.2s ease;\n    border-top: 0 solid var(--color-border, #dee2e6);\n  }\n\n  .pressy-page-footer--scroll .pressy-settings-panel--open {\n    max-height: 300px;\n    opacity: 1;\n    border-top-width: 1px;\n    margin-top: 0.5rem;\n    padding-top: 0.75rem;\n  }\n\n  .pressy-page-footer--scroll .pressy-settings-section {\n    margin-bottom: 0.75rem;\n  }\n\n  .pressy-page-footer--scroll .pressy-settings-section:last-child {\n    margin-bottom: 0;\n  }\n\n  .pressy-page-footer--scroll .pressy-settings-label {\n    font-family: var(--font-heading, system-ui, -apple-system, sans-serif);\n    font-size: 0.6875rem;\n    font-weight: 600;\n    text-transform: uppercase;\n    letter-spacing: 0.05em;\n    color: var(--color-text-muted, #6c757d);\n    margin-bottom: 0.5rem;\n    text-align: left;\n  }\n\n  .pressy-page-footer--scroll .pressy-theme-options {\n    display: flex;\n    gap: 0.375rem;\n  }\n\n  .pressy-page-footer--scroll .pressy-theme-btn {\n    flex: 1;\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    gap: 0.25rem;\n    padding: 0.375rem 0.5rem;\n    border: 1.5px solid var(--color-border, #dee2e6);\n    border-radius: 0.5rem;\n    background: transparent;\n    color: var(--color-text, #212529);\n    font-family: var(--font-heading, system-ui, -apple-system, sans-serif);\n    font-size: 0.6875rem;\n    cursor: pointer;\n    transition: border-color 0.15s, background 0.15s;\n  }\n\n  .pressy-page-footer--scroll .pressy-theme-btn:hover {\n    background: var(--color-bg-subtle, #f8f9fa);\n  }\n\n  .pressy-page-footer--scroll .pressy-theme-btn--active {\n    border-color: var(--color-accent, #212529);\n    background: var(--color-bg-subtle, #f8f9fa);\n    font-weight: 600;\n  }\n\n  .pressy-page-footer--scroll .pressy-font-size-controls {\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    gap: 1rem;\n  }\n\n  .pressy-page-footer--scroll .pressy-font-size-btn {\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    width: 2rem;\n    height: 2rem;\n    border: 1.5px solid var(--color-border, #dee2e6);\n    border-radius: 50%;\n    background: transparent;\n    color: var(--color-text, #212529);\n    font-family: var(--font-heading, system-ui, -apple-system, sans-serif);\n    font-size: 0.75rem;\n    font-weight: 600;\n    cursor: pointer;\n    transition: border-color 0.15s, background 0.15s;\n  }\n\n  .pressy-page-footer--scroll .pressy-font-size-btn:hover:not(:disabled) {\n    background: var(--color-bg-subtle, #f8f9fa);\n    border-color: var(--color-accent, #212529);\n  }\n\n  .pressy-page-footer--scroll .pressy-font-size-btn:disabled {\n    opacity: 0.3;\n    cursor: default;\n  }\n\n  .pressy-page-footer--scroll .pressy-font-size-value {\n    font-family: var(--font-heading, system-ui, -apple-system, sans-serif);\n    font-size: 0.8125rem;\n    font-weight: 500;\n    color: var(--color-text, #212529);\n    min-width: 3ch;\n    text-align: center;\n  }\n\n  /* ── TOC drawer for scroll reader ───────────────────────── */\n  .pressy-toc-backdrop--scroll {\n    position: fixed;\n    inset: 0;\n    background: rgba(0, 0, 0, 0.3);\n    z-index: 20;\n    display: flex;\n    align-items: flex-end;\n    animation: pressy-scroll-toc-fade-in 0.2s ease-out;\n  }\n\n  .pressy-toc-backdrop--scroll .pressy-toc-drawer {\n    width: 100%;\n    max-height: 70vh;\n    background: var(--color-bg, #ffffff);\n    border-radius: 1rem 1rem 0 0;\n    display: flex;\n    flex-direction: column;\n    animation: pressy-scroll-toc-slide-up 0.25s ease-out;\n    box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.1);\n  }\n\n  .pressy-toc-backdrop--scroll .pressy-toc-header {\n    display: flex;\n    align-items: center;\n    justify-content: space-between;\n    padding: 1rem 1.5rem 0.75rem;\n    border-bottom: 1px solid var(--color-border, #dee2e6);\n    flex-shrink: 0;\n  }\n\n  .pressy-toc-backdrop--scroll .pressy-toc-title {\n    font-family: var(--font-heading, system-ui, -apple-system, sans-serif);\n    font-size: 1rem;\n    font-weight: 600;\n    color: var(--color-text, #212529);\n  }\n\n  .pressy-toc-backdrop--scroll .pressy-toc-close {\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    width: 2rem;\n    height: 2rem;\n    border: none;\n    background: transparent;\n    color: var(--color-text-muted, #6c757d);\n    cursor: pointer;\n    border-radius: 0.375rem;\n    padding: 0;\n  }\n\n  .pressy-toc-backdrop--scroll .pressy-toc-close:hover {\n    color: var(--color-text, #212529);\n    background: var(--color-bg-subtle, #f8f9fa);\n  }\n\n  .pressy-toc-backdrop--scroll .pressy-toc-list {\n    overflow-y: auto;\n    padding: 0.5rem;\n    display: flex;\n    flex-direction: column;\n  }\n\n  .pressy-toc-backdrop--scroll .pressy-toc-item {\n    display: flex;\n    gap: 0.75rem;\n    padding: 0.625rem 1rem;\n    text-decoration: none;\n    color: var(--color-text, #212529);\n    border-radius: 0.5rem;\n    font-family: var(--font-heading, system-ui, -apple-system, sans-serif);\n    font-size: 0.875rem;\n    transition: background 0.15s;\n  }\n\n  .pressy-toc-backdrop--scroll .pressy-toc-item:hover {\n    background: var(--color-bg-subtle, #f5f5f5);\n  }\n\n  .pressy-toc-backdrop--scroll .pressy-toc-item--active {\n    background: var(--color-bg-subtle, #f5f5f5);\n    font-weight: 600;\n  }\n\n  .pressy-toc-backdrop--scroll .pressy-toc-item-num {\n    color: var(--color-text-muted, #6c757d);\n    min-width: 2ch;\n    text-align: right;\n  }\n\n  .pressy-toc-backdrop--scroll .pressy-toc-item--home {\n    border-bottom: 1px solid var(--color-border, #e5e5e5);\n    margin-bottom: 0.25rem;\n    padding-bottom: 0.75rem;\n  }\n\n  .pressy-toc-backdrop--scroll .pressy-toc-item--home .pressy-toc-item-num {\n    display: flex;\n    align-items: center;\n    justify-content: center;\n  }\n\n  .pressy-toc-backdrop--scroll .pressy-toc-item-title {\n    flex: 1;\n    min-width: 0;\n  }\n\n  @keyframes pressy-scroll-toc-fade-in {\n    from { opacity: 0; }\n    to { opacity: 1; }\n  }\n\n  @keyframes pressy-scroll-toc-slide-up {\n    from { transform: translateY(100%); }\n    to { transform: translateY(0); }\n  }\n\n  /* ── Offline icon for scroll reader ─────────────────────── */\n  .pressy-page-footer--scroll .pressy-offline-icon {\n    flex-shrink: 0;\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    position: relative;\n    width: 2rem;\n    height: 2rem;\n    border: none;\n    background: transparent;\n    color: var(--color-text-muted, #6c757d);\n    cursor: pointer;\n    border-radius: 0.375rem;\n    transition: color 0.15s, background 0.15s;\n    padding: 0;\n  }\n\n  .pressy-page-footer--scroll .pressy-offline-icon:hover {\n    color: var(--color-text, #212529);\n    background: var(--color-bg-subtle, #f8f9fa);\n  }\n\n  .pressy-page-footer--scroll .pressy-offline-icon--cached {\n    color: #16a34a;\n  }\n\n  .pressy-page-footer--scroll .pressy-offline-icon--cached:hover {\n    color: #dc2626;\n  }\n\n  .pressy-page-footer--scroll .pressy-offline-check {\n    position: absolute;\n    bottom: 2px;\n    right: 2px;\n  }\n\n  .pressy-page-footer--scroll .pressy-offline-icon--downloading {\n    cursor: default;\n  }\n\n  @media (prefers-reduced-motion: reduce) {\n    .pressy-page-footer--scroll {\n      transition: none;\n    }\n    .pressy-toc-backdrop--scroll,\n    .pressy-toc-backdrop--scroll .pressy-toc-drawer {\n      animation: none;\n    }\n  }\n`;\n\nconst PAGINATED_STYLES = `\n  html:has(.pressy-reader--paginated) body {\n    margin: 0;\n  }\n\n  .pressy-reader--paginated {\n    height: 100vh;\n    height: 100dvh;\n    display: flex;\n    flex-direction: column;\n    overflow: hidden;\n    position: relative;\n  }\n\n  /* Viewport clips overflow and shows one page at a time.\n     Vertical padding gives consistent top/bottom margins on every page. */\n  .pressy-paginated-viewport {\n    flex: 1;\n    overflow: hidden;\n    position: relative;\n    min-height: 0;\n    padding-block: 2rem;\n    box-sizing: border-box;\n    text-wrap: pretty;\n  }\n\n  /* Article uses CSS multi-column layout for pagination.\n     column-width is set dynamically via JS to match viewport width.\n     Each column = one \"page\". Content overflows horizontally into new columns.\n     translateX controlled by JS — transitions set dynamically during drag vs snap. */\n  .pressy-prose--paginated {\n    max-width: none;\n    height: 100%;\n    column-fill: auto;\n    column-gap: 0;\n    overflow: visible;\n    box-sizing: border-box;\n    padding: 0;\n    will-change: transform;\n    /* Transition is set dynamically: none during drag, ease-out on snap */\n  }\n\n  /* Center content elements within each column/page at a readable width */\n  .pressy-prose--paginated > * {\n    max-width: min(65ch, calc(100% - 3rem));\n    margin-left: auto;\n    margin-right: auto;\n  }\n\n  /* Preserve vertical margins from prose styles */\n  .pressy-prose--paginated > h1,\n  .pressy-prose--paginated > h2,\n  .pressy-prose--paginated > h3,\n  .pressy-prose--paginated > h4 {\n    max-width: min(65ch, calc(100% - 3rem));\n    margin-left: auto;\n    margin-right: auto;\n  }\n\n  /* ── Navigation arrows ────────────────────────────────────── */\n  /* Hover-triggered arrows on left/right edges for desktop navigation */\n  .pressy-nav-arrow {\n    position: absolute;\n    top: 50%;\n    transform: translateY(-50%);\n    width: 2.5rem;\n    height: 2.5rem;\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    color: var(--color-text-muted, #6c757d);\n    opacity: 0;\n    transition: opacity 0.2s ease;\n    pointer-events: none;\n    z-index: 5;\n  }\n\n  .pressy-nav-arrow svg {\n    width: 1.5rem;\n    height: 1.5rem;\n  }\n\n  .pressy-nav-arrow--prev {\n    left: 0.75rem;\n  }\n\n  .pressy-nav-arrow--next {\n    right: 0.75rem;\n  }\n\n  .pressy-nav-arrow--visible {\n    opacity: 0.4;\n  }\n\n  /* Hide on touch devices — swipe handles navigation there */\n  @media (hover: none) {\n    .pressy-nav-arrow {\n      display: none;\n    }\n  }\n\n  /* ── Chapter boundary hints ─────────────────────────────── */\n  /* Shown when overscrolling past first/last page of a chapter */\n  .pressy-chapter-hint {\n    position: absolute;\n    top: 50%;\n    transform: translateY(-50%);\n    display: flex;\n    align-items: center;\n    gap: 0.5rem;\n    padding: 0.75rem 1.25rem;\n    background: var(--color-bg-subtle, #f5f5f5);\n    border: 1px solid var(--color-border, #dee2e6);\n    border-radius: 0.75rem;\n    font-family: var(--font-heading, system-ui, -apple-system, sans-serif);\n    font-size: var(--font-size-sm, 0.875rem);\n    color: var(--color-text-muted, #6c757d);\n    z-index: 20;\n    pointer-events: none;\n    animation: pressy-hint-fade-in 0.15s ease-out;\n    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);\n    max-width: 60%;\n    white-space: nowrap;\n    overflow: hidden;\n    text-overflow: ellipsis;\n  }\n\n  .pressy-chapter-hint--prev {\n    left: 1rem;\n  }\n\n  .pressy-chapter-hint--next {\n    right: 1rem;\n  }\n\n  .pressy-chapter-hint-arrow {\n    flex-shrink: 0;\n    font-size: 1rem;\n    opacity: 0.6;\n  }\n\n  .pressy-chapter-hint-text {\n    overflow: hidden;\n    text-overflow: ellipsis;\n  }\n\n  @keyframes pressy-hint-fade-in {\n    from { opacity: 0; transform: translateY(-50%) scale(0.95); }\n    to { opacity: 1; transform: translateY(-50%) scale(1); }\n  }\n\n  /* ── Page footer ───────────────────────────────────────────── */\n  .pressy-page-footer {\n    position: absolute;\n    bottom: 0;\n    left: 0;\n    right: 0;\n    padding: 0.5rem 1.5rem 1rem;\n    text-align: center;\n    user-select: none;\n    transform: translateY(100%);\n    opacity: 0;\n    transition: transform 0.25s ease, opacity 0.25s ease;\n    z-index: 15;\n    background: var(--color-bg, #ffffff);\n  }\n\n  .pressy-page-footer--visible {\n    transform: translateY(0);\n    opacity: 1;\n  }\n\n  /* Progress bar */\n  .pressy-progress-bar {\n    height: 3px;\n    background: var(--color-border, #dee2e6);\n    border-radius: 1.5px;\n    overflow: hidden;\n  }\n\n  .pressy-progress-fill {\n    height: 100%;\n    background: var(--color-accent, #212529);\n    border-radius: 1.5px;\n    transition: width 0.3s ease;\n  }\n\n  /* ── Footer row (title + gear) ──────────────────────────── */\n  .pressy-footer-row {\n    display: flex;\n    align-items: center;\n    justify-content: space-between;\n    margin-top: 0.5rem;\n    gap: 0.5rem;\n  }\n\n  .pressy-footer-title {\n    font-family: var(--font-heading, system-ui, -apple-system, sans-serif);\n    font-size: 0.75rem;\n    color: var(--color-text-muted, #6c757d);\n    text-decoration: none;\n    overflow: hidden;\n    text-overflow: ellipsis;\n    white-space: nowrap;\n    min-width: 0;\n    flex: 1;\n    text-align: left;\n    border: none;\n    background: none;\n    cursor: pointer;\n    padding: 0;\n  }\n\n  .pressy-footer-title:hover {\n    color: var(--color-text, #212529);\n  }\n\n  /* ── TOC toggle button ──────────────────────────────────── */\n  .pressy-toc-toggle {\n    flex-shrink: 0;\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    width: 2rem;\n    height: 2rem;\n    border: none;\n    background: transparent;\n    color: var(--color-text-muted, #6c757d);\n    cursor: pointer;\n    border-radius: 0.375rem;\n    transition: color 0.15s, background 0.15s;\n    padding: 0;\n  }\n\n  .pressy-toc-toggle:hover {\n    color: var(--color-text, #212529);\n    background: var(--color-bg-subtle, #f8f9fa);\n  }\n\n  .pressy-settings-toggle {\n    flex-shrink: 0;\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    width: 2rem;\n    height: 2rem;\n    border: none;\n    background: transparent;\n    color: var(--color-text-muted, #6c757d);\n    cursor: pointer;\n    border-radius: 0.375rem;\n    transition: color 0.15s, background 0.15s;\n    padding: 0;\n  }\n\n  .pressy-settings-toggle:hover {\n    color: var(--color-text, #212529);\n    background: var(--color-bg-subtle, #f8f9fa);\n  }\n\n  /* ── Settings panel ────────────────────────────────────── */\n  .pressy-settings-panel {\n    overflow: hidden;\n    max-height: 0;\n    opacity: 0;\n    transition: max-height 0.25s ease, opacity 0.2s ease;\n    border-top: 0 solid var(--color-border, #dee2e6);\n  }\n\n  .pressy-settings-panel--open {\n    max-height: 300px;\n    opacity: 1;\n    border-top-width: 1px;\n    margin-top: 0.5rem;\n    padding-top: 0.75rem;\n  }\n\n  .pressy-settings-section {\n    margin-bottom: 0.75rem;\n  }\n\n  .pressy-settings-section:last-child {\n    margin-bottom: 0;\n  }\n\n  .pressy-settings-label {\n    font-family: var(--font-heading, system-ui, -apple-system, sans-serif);\n    font-size: 0.6875rem;\n    font-weight: 600;\n    text-transform: uppercase;\n    letter-spacing: 0.05em;\n    color: var(--color-text-muted, #6c757d);\n    margin-bottom: 0.5rem;\n    text-align: left;\n  }\n\n  .pressy-theme-options {\n    display: flex;\n    gap: 0.375rem;\n  }\n\n  .pressy-theme-btn {\n    flex: 1;\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    gap: 0.25rem;\n    padding: 0.375rem 0.5rem;\n    border: 1.5px solid var(--color-border, #dee2e6);\n    border-radius: 0.5rem;\n    background: transparent;\n    color: var(--color-text, #212529);\n    font-family: var(--font-heading, system-ui, -apple-system, sans-serif);\n    font-size: 0.6875rem;\n    cursor: pointer;\n    transition: border-color 0.15s, background 0.15s;\n  }\n\n  .pressy-theme-btn:hover {\n    background: var(--color-bg-subtle, #f8f9fa);\n  }\n\n  .pressy-theme-btn--active {\n    border-color: var(--color-accent, #212529);\n    background: var(--color-bg-subtle, #f8f9fa);\n    font-weight: 600;\n  }\n\n  .pressy-font-size-controls {\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    gap: 1rem;\n  }\n\n  .pressy-font-size-btn {\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    width: 2rem;\n    height: 2rem;\n    border: 1.5px solid var(--color-border, #dee2e6);\n    border-radius: 50%;\n    background: transparent;\n    color: var(--color-text, #212529);\n    font-family: var(--font-heading, system-ui, -apple-system, sans-serif);\n    font-size: 0.75rem;\n    font-weight: 600;\n    cursor: pointer;\n    transition: border-color 0.15s, background 0.15s;\n  }\n\n  .pressy-font-size-btn:hover:not(:disabled) {\n    background: var(--color-bg-subtle, #f8f9fa);\n    border-color: var(--color-accent, #212529);\n  }\n\n  .pressy-font-size-btn:disabled {\n    opacity: 0.3;\n    cursor: default;\n  }\n\n  .pressy-font-size-value {\n    font-family: var(--font-heading, system-ui, -apple-system, sans-serif);\n    font-size: 0.8125rem;\n    font-weight: 500;\n    color: var(--color-text, #212529);\n    min-width: 3ch;\n    text-align: center;\n  }\n\n  /* ── Chapter sections ─────────────────────────────────── */\n  .pressy-chapter-section + .pressy-chapter-section {\n    break-before: column;\n  }\n\n  .pressy-chapter-divider {\n    padding: 0;\n    margin: 0;\n  }\n\n  .pressy-chapter-divider-title {\n    font-size: 1.5rem;\n    font-family: var(--font-heading, system-ui, -apple-system, sans-serif);\n    margin: 0;\n  }\n\n  /* ── TOC drawer ──────────────────────────────────────────── */\n  .pressy-toc-backdrop {\n    position: absolute;\n    inset: 0;\n    background: rgba(0, 0, 0, 0.3);\n    z-index: 20;\n    display: flex;\n    align-items: flex-end;\n    animation: pressy-toc-fade-in 0.2s ease-out;\n  }\n\n  .pressy-toc-drawer {\n    width: 100%;\n    max-height: 70vh;\n    background: var(--color-bg, #ffffff);\n    border-radius: 1rem 1rem 0 0;\n    display: flex;\n    flex-direction: column;\n    animation: pressy-toc-slide-up 0.25s ease-out;\n    box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.1);\n  }\n\n  .pressy-toc-header {\n    display: flex;\n    align-items: center;\n    justify-content: space-between;\n    padding: 1rem 1.5rem 0.75rem;\n    border-bottom: 1px solid var(--color-border, #dee2e6);\n    flex-shrink: 0;\n  }\n\n  .pressy-toc-title {\n    font-family: var(--font-heading, system-ui, -apple-system, sans-serif);\n    font-size: 1rem;\n    font-weight: 600;\n    color: var(--color-text, #212529);\n  }\n\n  .pressy-toc-close {\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    width: 2rem;\n    height: 2rem;\n    border: none;\n    background: transparent;\n    color: var(--color-text-muted, #6c757d);\n    cursor: pointer;\n    border-radius: 0.375rem;\n    padding: 0;\n  }\n\n  .pressy-toc-close:hover {\n    color: var(--color-text, #212529);\n    background: var(--color-bg-subtle, #f8f9fa);\n  }\n\n  .pressy-toc-list {\n    overflow-y: auto;\n    padding: 0.5rem;\n    display: flex;\n    flex-direction: column;\n  }\n\n  .pressy-toc-item {\n    display: flex;\n    gap: 0.75rem;\n    padding: 0.625rem 1rem;\n    text-decoration: none;\n    color: var(--color-text, #212529);\n    border-radius: 0.5rem;\n    font-family: var(--font-heading, system-ui, -apple-system, sans-serif);\n    font-size: 0.875rem;\n    transition: background 0.15s;\n  }\n\n  .pressy-toc-item:hover {\n    background: var(--color-bg-subtle, #f5f5f5);\n  }\n\n  .pressy-toc-item--active {\n    background: var(--color-bg-subtle, #f5f5f5);\n    font-weight: 600;\n  }\n\n  .pressy-toc-item-num {\n    color: var(--color-text-muted, #6c757d);\n    min-width: 2ch;\n    text-align: right;\n  }\n\n  .pressy-toc-item--home {\n    border-bottom: 1px solid var(--color-border, #e5e5e5);\n    margin-bottom: 0.25rem;\n    padding-bottom: 0.75rem;\n  }\n\n  .pressy-toc-item--home .pressy-toc-item-num {\n    display: flex;\n    align-items: center;\n    justify-content: center;\n  }\n\n  .pressy-toc-item-title {\n    flex: 1;\n    min-width: 0;\n  }\n\n  @keyframes pressy-toc-fade-in {\n    from { opacity: 0; }\n    to { opacity: 1; }\n  }\n\n  @keyframes pressy-toc-slide-up {\n    from { transform: translateY(100%); }\n    to { transform: translateY(0); }\n  }\n\n  /* ── Offline footer icon ────────────────────────────────── */\n  .pressy-offline-icon {\n    flex-shrink: 0;\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    position: relative;\n    width: 2rem;\n    height: 2rem;\n    border: none;\n    background: transparent;\n    color: var(--color-text-muted, #6c757d);\n    cursor: pointer;\n    border-radius: 0.375rem;\n    transition: color 0.15s, background 0.15s;\n    padding: 0;\n  }\n\n  .pressy-offline-icon:hover {\n    color: var(--color-text, #212529);\n    background: var(--color-bg-subtle, #f8f9fa);\n  }\n\n  .pressy-offline-icon--cached {\n    color: #16a34a;\n  }\n\n  .pressy-offline-icon--cached:hover {\n    color: #dc2626;\n  }\n\n  .pressy-offline-check {\n    position: absolute;\n    bottom: 2px;\n    right: 2px;\n  }\n\n  .pressy-offline-icon--downloading {\n    cursor: default;\n  }\n\n  @keyframes pressy-offline-spin {\n    from { transform: rotate(0deg); }\n    to { transform: rotate(360deg); }\n  }\n\n  .pressy-offline-spinner {\n    animation: pressy-offline-spin 1s linear infinite;\n    transform-origin: 12px 12px;\n  }\n\n  /* ── Reduced motion preference ────────────────────────────\n     Disable page turn animations for users who prefer reduced motion. */\n  @media (prefers-reduced-motion: reduce) {\n    .pressy-prose--paginated {\n      transition: none !important;\n    }\n    .pressy-progress-fill {\n      transition: none !important;\n    }\n    .pressy-toc-backdrop,\n    .pressy-toc-drawer {\n      animation: none;\n    }\n    .pressy-offline-spinner {\n      animation: none;\n    }\n  }\n`;\n","structuredPatch":[{"oldStart":2590,"oldLines":11,"newStart":2590,"newLines":11,"lines":[" ","   /* ── Page footer ───────────────────────────────────────────── */","   .pressy-page-footer {","-    position: absolute;","+    position: fixed;","     bottom: 0;","     left: 0;","     right: 0;","-    padding: 0.5rem 1.5rem 1rem;","+    padding: 0.5rem 1.5rem calc(1rem + env(safe-area-inset-bottom, 0px));","     text-align: center;","     user-select: none;","     transform: translateY(100%);"]}],"userModified":false,"replaceAll":false},"sourceToolAssistantUUID":"74f33766-6516-4c74-8f95-8a2d33333073"}
{"parentUuid":"76e75585-d900-4b62-a00e-b899618b6230","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","message":{"model":"claude-opus-4-6","id":"msg_014s5sKoHwrqGrqRydEHzZ1S","type":"message","role":"assistant","content":[{"type":"text","text":"Now let me also add `safe-area-inset-bottom` to the scroll footer for consistency, since it could have the same issue on notched devices:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":497,"cache_read_input_tokens":80490,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":497},"output_tokens":3,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CYAuaMHyVJb2AsxJgDdQn","type":"assistant","uuid":"dd36a0f0-7ef6-4d20-82d6-216102872ba8","timestamp":"2026-02-16T01:49:03.345Z"}
{"parentUuid":"dd36a0f0-7ef6-4d20-82d6-216102872ba8","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","message":{"model":"claude-opus-4-6","id":"msg_014s5sKoHwrqGrqRydEHzZ1S","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01WZrqdPit564oqHnT9KXLRj","name":"Read","input":{"file_path":"/Users/blittle/dev/pressy/packages/@pressy/components/src/Reader.tsx","offset":2086,"limit":20},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":497,"cache_read_input_tokens":80490,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":497},"output_tokens":3,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CYAuaMHyVJb2AsxJgDdQn","type":"assistant","uuid":"05b25ecd-e343-4a77-b9aa-c48a328498cb","timestamp":"2026-02-16T01:49:04.023Z"}
{"parentUuid":"05b25ecd-e343-4a77-b9aa-c48a328498cb","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","type":"progress","data":{"type":"hook_progress","hookEvent":"PostToolUse","hookName":"PostToolUse:Read","command":"callback"},"parentToolUseID":"toolu_01WZrqdPit564oqHnT9KXLRj","toolUseID":"toolu_01WZrqdPit564oqHnT9KXLRj","timestamp":"2026-02-16T01:49:04.074Z","uuid":"7d4ca3eb-dc51-4eb9-b2bf-b36bfd693461"}
{"parentUuid":"05b25ecd-e343-4a77-b9aa-c48a328498cb","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01WZrqdPit564oqHnT9KXLRj","type":"tool_result","content":"  2086→  /* ── Scroll reader footer ──────────────────────────────── */\n  2087→  .pressy-page-footer--scroll {\n  2088→    position: fixed;\n  2089→    bottom: 0;\n  2090→    left: 0;\n  2091→    right: 0;\n  2092→    padding: 0.5rem 1.5rem 1rem;\n  2093→    text-align: center;\n  2094→    user-select: none;\n  2095→    transform: translateY(100%);\n  2096→    opacity: 0;\n  2097→    transition: transform 0.25s ease, opacity 0.25s ease;\n  2098→    z-index: 15;\n  2099→    background: var(--color-bg, #ffffff);\n  2100→    box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.05);\n  2101→  }\n  2102→\n  2103→  .pressy-page-footer--scroll.pressy-page-footer--visible {\n  2104→    transform: translateY(0);\n  2105→    opacity: 1;"}]},"uuid":"7cf84a22-6684-458a-837a-71da151553c4","timestamp":"2026-02-16T01:49:04.074Z","toolUseResult":{"type":"text","file":{"filePath":"/Users/blittle/dev/pressy/packages/@pressy/components/src/Reader.tsx","content":"  /* ── Scroll reader footer ──────────────────────────────── */\n  .pressy-page-footer--scroll {\n    position: fixed;\n    bottom: 0;\n    left: 0;\n    right: 0;\n    padding: 0.5rem 1.5rem 1rem;\n    text-align: center;\n    user-select: none;\n    transform: translateY(100%);\n    opacity: 0;\n    transition: transform 0.25s ease, opacity 0.25s ease;\n    z-index: 15;\n    background: var(--color-bg, #ffffff);\n    box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.05);\n  }\n\n  .pressy-page-footer--scroll.pressy-page-footer--visible {\n    transform: translateY(0);\n    opacity: 1;","numLines":20,"startLine":2086,"totalLines":3014}},"sourceToolAssistantUUID":"05b25ecd-e343-4a77-b9aa-c48a328498cb"}
{"parentUuid":"7cf84a22-6684-458a-837a-71da151553c4","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","message":{"model":"claude-opus-4-6","id":"msg_01Bbcep22jVVYC9kySg2mPYz","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01MZAhfSbuoCRivk8DuPBZpu","name":"Edit","input":{"replace_all":false,"file_path":"/Users/blittle/dev/pressy/packages/@pressy/components/src/Reader.tsx","old_string":"  .pressy-page-footer--scroll {\n    position: fixed;\n    bottom: 0;\n    left: 0;\n    right: 0;\n    padding: 0.5rem 1.5rem 1rem;","new_string":"  .pressy-page-footer--scroll {\n    position: fixed;\n    bottom: 0;\n    left: 0;\n    right: 0;\n    padding: 0.5rem 1.5rem calc(1rem + env(safe-area-inset-bottom, 0px));"},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":460,"cache_read_input_tokens":80987,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":460},"output_tokens":24,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CYAuagDGW8Jqj7oLFo6N2","type":"assistant","uuid":"8f42cb07-d900-43a5-81d2-9ddbe936a8fa","timestamp":"2026-02-16T01:49:08.331Z"}
{"parentUuid":"8f42cb07-d900-43a5-81d2-9ddbe936a8fa","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","type":"progress","data":{"type":"hook_progress","hookEvent":"PostToolUse","hookName":"PostToolUse:Edit","command":"callback"},"parentToolUseID":"toolu_01MZAhfSbuoCRivk8DuPBZpu","toolUseID":"toolu_01MZAhfSbuoCRivk8DuPBZpu","timestamp":"2026-02-16T01:49:08.343Z","uuid":"d9c25c64-ffd1-44e6-8de3-b107832d2624"}
{"parentUuid":"8f42cb07-d900-43a5-81d2-9ddbe936a8fa","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01MZAhfSbuoCRivk8DuPBZpu","type":"tool_result","content":"The file /Users/blittle/dev/pressy/packages/@pressy/components/src/Reader.tsx has been updated successfully."}]},"uuid":"eb6cf61c-3550-4097-b730-9c199b42e2ca","timestamp":"2026-02-16T01:49:08.342Z","toolUseResult":{"filePath":"/Users/blittle/dev/pressy/packages/@pressy/components/src/Reader.tsx","oldString":"  .pressy-page-footer--scroll {\n    position: fixed;\n    bottom: 0;\n    left: 0;\n    right: 0;\n    padding: 0.5rem 1.5rem 1rem;","newString":"  .pressy-page-footer--scroll {\n    position: fixed;\n    bottom: 0;\n    left: 0;\n    right: 0;\n    padding: 0.5rem 1.5rem calc(1rem + env(safe-area-inset-bottom, 0px));","originalFile":"import { ComponentChildren, ComponentType } from \"preact\";\nimport { useState, useEffect, useRef, useCallback } from \"preact/hooks\";\n\nimport { Navigation } from \"./Navigation.js\";\nimport { TextShare } from \"./TextShare.js\";\nimport { OfflineIndicator } from \"./OfflineIndicator.js\";\n\nexport interface ProgressData {\n  page: number;\n  totalPages: number;\n  scrollPosition: number;\n}\n\nexport interface ChapterMapData {\n  chapterMap: Record<\n    string,\n    () => Promise<{\n      default: ComponentType<{ components?: Record<string, unknown> }>;\n    }>\n  >;\n  chapterOrder: string[];\n}\n\nexport interface OfflineProps {\n  bookSlug: string;\n  chapterUrls: string[];\n  cachedBooks: { value: Set<string> };\n  cacheProgress: {\n    value: { bookSlug: string; current: number; total: number } | null;\n  };\n  onDownload: (bookSlug: string, chapterUrls: string[]) => void;\n  onRemove: (bookSlug: string) => void;\n}\n\nexport interface ReaderProps {\n  children: ComponentChildren;\n  title: string;\n  bookTitle?: string;\n  chapterSlug?: string;\n  prevChapter?: { slug: string; title: string };\n  nextChapter?: { slug: string; title: string };\n  showDropCap?: boolean;\n  paginationMode?: \"scroll\" | \"paginated\";\n  onSaveProgress?: (data: ProgressData) => void;\n  onRestoreProgress?: () => Promise<ProgressData | null>;\n  bookProgressPercent?: number;\n  initialContent?: ComponentType<{ components?: Record<string, unknown> }>;\n  chapterMapData?: ChapterMapData;\n  currentChapterSlug?: string;\n  allChapters?: Array<{ slug: string; title: string; wordCount?: number }>;\n  bookBasePath?: string;\n  onChapterChange?: (slug: string, page: number, totalPages: number) => void;\n  mdxComponents?: Record<string, unknown>;\n  offlineProps?: OfflineProps;\n}\n\nexport function Reader({\n  children,\n  bookTitle,\n  prevChapter,\n  nextChapter,\n  showDropCap = true,\n  paginationMode = \"scroll\",\n  onSaveProgress,\n  onRestoreProgress,\n  bookProgressPercent,\n  initialContent,\n  chapterMapData,\n  currentChapterSlug,\n  allChapters,\n  bookBasePath,\n  onChapterChange,\n  mdxComponents,\n  offlineProps,\n}: ReaderProps) {\n  if (paginationMode === \"paginated\") {\n    return (\n      <PaginatedReader\n        bookTitle={bookTitle}\n        prevChapter={prevChapter}\n        nextChapter={nextChapter}\n        showDropCap={showDropCap}\n        onSaveProgress={onSaveProgress}\n        onRestoreProgress={onRestoreProgress}\n        bookProgressPercent={bookProgressPercent}\n        initialContent={initialContent}\n        chapterMapData={chapterMapData}\n        currentChapterSlug={currentChapterSlug}\n        allChapters={allChapters}\n        bookBasePath={bookBasePath}\n        onChapterChange={onChapterChange}\n        mdxComponents={mdxComponents}\n        offlineProps={offlineProps}\n      >\n        {children}\n      </PaginatedReader>\n    );\n  }\n\n  return (\n    <ScrollReader\n      bookTitle={bookTitle}\n      prevChapter={prevChapter}\n      nextChapter={nextChapter}\n      showDropCap={showDropCap}\n      onSaveProgress={onSaveProgress}\n      onRestoreProgress={onRestoreProgress}\n      allChapters={allChapters}\n      bookBasePath={bookBasePath}\n      currentChapterSlug={currentChapterSlug}\n      offlineProps={offlineProps}\n    >\n      {children}\n    </ScrollReader>\n  );\n}\n\n// ── Offline Footer Icon ───────────────────────────────────────\n\nfunction OfflineFooterIcon({ offlineProps }: { offlineProps?: OfflineProps }) {\n  if (!offlineProps) return null;\n\n  const {\n    bookSlug,\n    chapterUrls,\n    cachedBooks,\n    onDownload,\n    onRemove,\n  } = offlineProps;\n\n  // Read signal .value directly in render — @preact/signals auto-subscribes\n  // and re-renders this component when the underlying signal changes.\n  const isCached = cachedBooks.value.has(bookSlug);\n\n  // Check isCached FIRST (matching DownloadBook's order). The download function\n  // optimistically marks the book as cached immediately, so isCached becomes true\n  // at the same time as isDownloading. Checking isCached first means we show the\n  // cached icon right away while the SW downloads in the background.\n  if (isCached) {\n    return (\n      <button\n        class=\"pressy-offline-icon pressy-offline-icon--cached\"\n        onClick={(e: MouseEvent) => {\n          e.stopPropagation();\n          onRemove(bookSlug);\n        }}\n        aria-label=\"Available offline. Click to remove.\"\n        title=\"Available offline. Click to remove.\"\n      >\n        <svg\n          viewBox=\"0 0 24 24\"\n          fill=\"none\"\n          stroke=\"currentColor\"\n          stroke-width=\"1.5\"\n          stroke-linecap=\"round\"\n          stroke-linejoin=\"round\"\n          width=\"18\"\n          height=\"18\"\n        >\n          <path d=\"M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z\" />\n          <polyline points=\"9 15 12 18 15 15\" />\n          <line x1=\"12\" y1=\"12\" x2=\"12\" y2=\"18\" />\n        </svg>\n        <svg\n          class=\"pressy-offline-check\"\n          viewBox=\"0 0 24 24\"\n          fill=\"currentColor\"\n          width=\"10\"\n          height=\"10\"\n        >\n          <path d=\"M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z\" />\n        </svg>\n      </button>\n    );\n  }\n\n  return (\n    <button\n      class=\"pressy-offline-icon\"\n      onClick={(e: MouseEvent) => {\n        e.stopPropagation();\n        onDownload(bookSlug, chapterUrls);\n      }}\n      aria-label=\"Download for offline reading\"\n      title=\"Download for offline reading\"\n    >\n      <svg\n        viewBox=\"0 0 24 24\"\n        fill=\"none\"\n        stroke=\"currentColor\"\n        stroke-width=\"1.5\"\n        stroke-linecap=\"round\"\n        stroke-linejoin=\"round\"\n        width=\"18\"\n        height=\"18\"\n      >\n        <path d=\"M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z\" />\n        <polyline points=\"9 15 12 18 15 15\" />\n        <line x1=\"12\" y1=\"12\" x2=\"12\" y2=\"18\" />\n      </svg>\n    </button>\n  );\n}\n\n// ── Scroll Reader ────────────────────────────────────────────\n\ninterface ScrollReaderProps {\n  children: ComponentChildren;\n  bookTitle?: string;\n  prevChapter?: { slug: string; title: string };\n  nextChapter?: { slug: string; title: string };\n  showDropCap: boolean;\n  onSaveProgress?: (data: ProgressData) => void;\n  onRestoreProgress?: () => Promise<ProgressData | null>;\n  allChapters?: Array<{ slug: string; title: string; wordCount?: number }>;\n  bookBasePath?: string;\n  currentChapterSlug?: string;\n  offlineProps?: OfflineProps;\n}\n\nfunction ScrollReader({\n  children,\n  bookTitle,\n  prevChapter,\n  nextChapter,\n  showDropCap,\n  onSaveProgress,\n  onRestoreProgress,\n  allChapters,\n  bookBasePath,\n  currentChapterSlug,\n  offlineProps,\n}: ScrollReaderProps) {\n  const saveTimerRef = useRef<ReturnType<typeof setTimeout> | null>(null);\n\n  // Footer visibility\n  const [footerVisible, setFooterVisible] = useState(false);\n  const footerTimerRef = useRef<ReturnType<typeof setTimeout> | null>(null);\n  const [settingsOpen, setSettingsOpen] = useState(false);\n  const [tocOpen, setTocOpen] = useState(false);\n\n  const showFooterTemporarily = useCallback(() => {\n    setFooterVisible(true);\n    if (footerTimerRef.current) clearTimeout(footerTimerRef.current);\n    footerTimerRef.current = setTimeout(() => setFooterVisible(false), 3000);\n  }, []);\n\n  // Settings state\n  const [activeTheme, setActiveTheme] = useState<string>(() => {\n    if (typeof localStorage !== \"undefined\") {\n      return localStorage.getItem(\"pressy-theme\") || \"light\";\n    }\n    return \"light\";\n  });\n  const [fontScale, setFontScale] = useState<number>(() => {\n    if (typeof localStorage !== \"undefined\") {\n      const saved = localStorage.getItem(\"pressy-font-size\");\n      return saved ? parseFloat(saved) : 1.0;\n    }\n    return 1.0;\n  });\n\n  const applyFontScale = useCallback((scale: number) => {\n    if (scale === 1.0) {\n      document.documentElement.style.removeProperty(\"--font-size-base\");\n    } else {\n      document.documentElement.style.setProperty(\n        \"--font-size-base\",\n        `calc(clamp(1rem, 0.875rem + 0.5vw, 1.25rem) * ${scale})`\n      );\n    }\n  }, []);\n\n  useEffect(() => {\n    if (fontScale !== 1.0) {\n      applyFontScale(fontScale);\n    }\n  }, []);\n\n  const handleThemeChange = useCallback((theme: string) => {\n    setActiveTheme(theme);\n    localStorage.setItem(\"pressy-theme\", theme);\n    const resolved =\n      theme === \"system\"\n        ? window.matchMedia(\"(prefers-color-scheme: dark)\").matches\n          ? \"dark\"\n          : \"light\"\n        : theme;\n    document.documentElement.setAttribute(\"data-theme\", resolved);\n  }, []);\n\n  const handleFontSizeChange = useCallback(\n    (delta: number) => {\n      setFontScale((prev) => {\n        const next =\n          Math.round(Math.max(0.8, Math.min(1.5, prev + delta)) * 10) / 10;\n        localStorage.setItem(\"pressy-font-size\", String(next));\n        applyFontScale(next);\n        return next;\n      });\n    },\n    [applyFontScale]\n  );\n\n  // Toggle footer on tap\n  const handleReaderClick = useCallback(\n    (e: MouseEvent) => {\n      const target = e.target as HTMLElement;\n      if (\n        target.closest(\n          \".pressy-page-footer, .pressy-toc-backdrop, .pressy-toc-toggle\"\n        )\n      )\n        return;\n      if (target.closest('a, button, input, select, textarea, [role=\"button\"]'))\n        return;\n\n      if (settingsOpen || tocOpen) {\n        setSettingsOpen(false);\n        setTocOpen(false);\n        return;\n      }\n\n      if (footerVisible) {\n        setFooterVisible(false);\n        if (footerTimerRef.current) clearTimeout(footerTimerRef.current);\n      } else {\n        showFooterTemporarily();\n      }\n    },\n    [footerVisible, settingsOpen, tocOpen, showFooterTemporarily]\n  );\n\n  // Restore scroll position on mount\n  useEffect(() => {\n    if (!onRestoreProgress) return;\n    onRestoreProgress().then((data) => {\n      if (data && data.scrollPosition > 0) {\n        window.scrollTo(0, data.scrollPosition);\n      }\n    });\n  }, []);\n\n  // Save scroll position (debounced)\n  useEffect(() => {\n    if (!onSaveProgress) return;\n\n    const handleScroll = () => {\n      if (saveTimerRef.current) clearTimeout(saveTimerRef.current);\n      saveTimerRef.current = setTimeout(() => {\n        onSaveProgress({\n          page: 0,\n          totalPages: 0,\n          scrollPosition: window.scrollY,\n        });\n      }, 500);\n    };\n\n    window.addEventListener(\"scroll\", handleScroll, { passive: true });\n    return () => {\n      window.removeEventListener(\"scroll\", handleScroll);\n      if (saveTimerRef.current) clearTimeout(saveTimerRef.current);\n    };\n  }, [onSaveProgress]);\n\n  // Save on page unload\n  useEffect(() => {\n    if (!onSaveProgress) return;\n\n    const handleUnload = () => {\n      onSaveProgress({\n        page: 0,\n        totalPages: 0,\n        scrollPosition: window.scrollY,\n      });\n    };\n\n    window.addEventListener(\"beforeunload\", handleUnload);\n    return () => window.removeEventListener(\"beforeunload\", handleUnload);\n  }, [onSaveProgress]);\n\n  return (\n    <div class=\"pressy-reader\" onClick={handleReaderClick}>\n      <main class=\"pressy-reader-main\">\n        <article\n          class={`pressy-prose ${showDropCap ? \"\" : \"no-drop-cap\"}`}\n          data-drop-cap={showDropCap}\n        >\n          {children}\n        </article>\n      </main>\n\n      <TextShare />\n      <Navigation prev={prevChapter} next={nextChapter} />\n      <OfflineIndicator />\n\n      {/* TOC drawer overlay */}\n      {tocOpen && allChapters && (\n        <div\n          class=\"pressy-toc-backdrop pressy-toc-backdrop--scroll\"\n          onClick={(e: MouseEvent) => {\n            e.stopPropagation();\n            setTocOpen(false);\n          }}\n        >\n          <div\n            class=\"pressy-toc-drawer\"\n            onClick={(e: MouseEvent) => e.stopPropagation()}\n          >\n            <div class=\"pressy-toc-header\">\n              <span class=\"pressy-toc-title\">Contents</span>\n              <button\n                class=\"pressy-toc-close\"\n                onClick={(e: MouseEvent) => {\n                  e.stopPropagation();\n                  setTocOpen(false);\n                }}\n                aria-label=\"Close table of contents\"\n              >\n                <svg\n                  viewBox=\"0 0 24 24\"\n                  fill=\"none\"\n                  stroke=\"currentColor\"\n                  stroke-width=\"2\"\n                  width=\"18\"\n                  height=\"18\"\n                >\n                  <line x1=\"18\" y1=\"6\" x2=\"6\" y2=\"18\" />\n                  <line x1=\"6\" y1=\"6\" x2=\"18\" y2=\"18\" />\n                </svg>\n              </button>\n            </div>\n            <nav class=\"pressy-toc-list\">\n              <a\n                href={bookBasePath ? bookBasePath.replace(/\\/books\\/[^/]+$/, '') || '/' : '/'}\n                class=\"pressy-toc-item pressy-toc-item--home\"\n                onClick={() => setTocOpen(false)}\n              >\n                <span class=\"pressy-toc-item-num\">\n                  <svg viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" width=\"14\" height=\"14\">\n                    <path d=\"M3 9.5L12 3l9 6.5V20a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V9.5z\" />\n                  </svg>\n                </span>\n                <span class=\"pressy-toc-item-title\">{bookTitle || 'Home'}</span>\n              </a>\n              {allChapters.map((ch, i) => (\n                <a\n                  key={ch.slug}\n                  href={`${bookBasePath || \"\"}/${ch.slug}`}\n                  class={`pressy-toc-item ${\n                    ch.slug === currentChapterSlug\n                      ? \"pressy-toc-item--active\"\n                      : \"\"\n                  }`}\n                  onClick={() => setTocOpen(false)}\n                >\n                  <span class=\"pressy-toc-item-num\">{i + 1}.</span>\n                  <span class=\"pressy-toc-item-title\">{ch.title}</span>\n                </a>\n              ))}\n            </nav>\n          </div>\n        </div>\n      )}\n\n      {/* Footer */}\n      <div\n        class={`pressy-page-footer pressy-page-footer--scroll ${\n          footerVisible || settingsOpen || tocOpen\n            ? \"pressy-page-footer--visible\"\n            : \"\"\n        }`}\n      >\n        <div class=\"pressy-footer-row\">\n          {allChapters && allChapters.length > 0 && (\n            <button\n              class=\"pressy-toc-toggle\"\n              onClick={(e: MouseEvent) => {\n                e.stopPropagation();\n                setSettingsOpen(false);\n                setTocOpen(!tocOpen);\n              }}\n              aria-label=\"Table of contents\"\n            >\n              <svg\n                viewBox=\"0 0 24 24\"\n                fill=\"none\"\n                stroke=\"currentColor\"\n                stroke-width=\"1.5\"\n                stroke-linecap=\"round\"\n                stroke-linejoin=\"round\"\n                width=\"18\"\n                height=\"18\"\n              >\n                <line x1=\"3\" y1=\"6\" x2=\"21\" y2=\"6\" />\n                <line x1=\"3\" y1=\"12\" x2=\"21\" y2=\"12\" />\n                <line x1=\"3\" y1=\"18\" x2=\"21\" y2=\"18\" />\n              </svg>\n            </button>\n          )}\n          {bookTitle && (\n            <button\n              class=\"pressy-footer-title\"\n              onClick={(e: MouseEvent) => {\n                e.stopPropagation();\n                if (allChapters && allChapters.length > 0) {\n                  setSettingsOpen(false);\n                  setTocOpen(!tocOpen);\n                }\n              }}\n            >\n              {bookTitle}\n            </button>\n          )}\n          <OfflineFooterIcon offlineProps={offlineProps} />\n          <button\n            class=\"pressy-settings-toggle\"\n            onClick={(e: MouseEvent) => {\n              e.stopPropagation();\n              setTocOpen(false);\n              setSettingsOpen(!settingsOpen);\n            }}\n            aria-label=\"Settings\"\n          >\n            <svg\n              viewBox=\"0 0 24 24\"\n              fill=\"none\"\n              stroke=\"currentColor\"\n              stroke-width=\"1.5\"\n              stroke-linecap=\"round\"\n              stroke-linejoin=\"round\"\n              width=\"18\"\n              height=\"18\"\n            >\n              <circle cx=\"12\" cy=\"12\" r=\"3\" />\n              <path d=\"M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z\" />\n            </svg>\n          </button>\n        </div>\n\n        {/* Settings panel */}\n        <div\n          class={`pressy-settings-panel ${\n            settingsOpen ? \"pressy-settings-panel--open\" : \"\"\n          }`}\n        >\n          <div class=\"pressy-settings-section\">\n            <div class=\"pressy-settings-label\">Theme</div>\n            <div class=\"pressy-theme-options\">\n              {(\n                [\n                  {\n                    id: \"light\",\n                    label: \"Light\",\n                    icon: (\n                      <svg\n                        viewBox=\"0 0 24 24\"\n                        fill=\"none\"\n                        stroke=\"currentColor\"\n                        stroke-width=\"1.5\"\n                        width=\"16\"\n                        height=\"16\"\n                      >\n                        <circle cx=\"12\" cy=\"12\" r=\"5\" />\n                        <line x1=\"12\" y1=\"1\" x2=\"12\" y2=\"3\" />\n                        <line x1=\"12\" y1=\"21\" x2=\"12\" y2=\"23\" />\n                        <line x1=\"4.22\" y1=\"4.22\" x2=\"5.64\" y2=\"5.64\" />\n                        <line x1=\"18.36\" y1=\"18.36\" x2=\"19.78\" y2=\"19.78\" />\n                        <line x1=\"1\" y1=\"12\" x2=\"3\" y2=\"12\" />\n                        <line x1=\"21\" y1=\"12\" x2=\"23\" y2=\"12\" />\n                        <line x1=\"4.22\" y1=\"19.78\" x2=\"5.64\" y2=\"18.36\" />\n                        <line x1=\"18.36\" y1=\"5.64\" x2=\"19.78\" y2=\"4.22\" />\n                      </svg>\n                    ),\n                  },\n                  {\n                    id: \"dark\",\n                    label: \"Dark\",\n                    icon: (\n                      <svg\n                        viewBox=\"0 0 24 24\"\n                        fill=\"none\"\n                        stroke=\"currentColor\"\n                        stroke-width=\"1.5\"\n                        width=\"16\"\n                        height=\"16\"\n                      >\n                        <path d=\"M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z\" />\n                      </svg>\n                    ),\n                  },\n                  {\n                    id: \"system\",\n                    label: \"System\",\n                    icon: (\n                      <svg\n                        viewBox=\"0 0 24 24\"\n                        fill=\"none\"\n                        stroke=\"currentColor\"\n                        stroke-width=\"1.5\"\n                        width=\"16\"\n                        height=\"16\"\n                      >\n                        <rect\n                          x=\"2\"\n                          y=\"3\"\n                          width=\"20\"\n                          height=\"14\"\n                          rx=\"2\"\n                          ry=\"2\"\n                        />\n                        <line x1=\"8\" y1=\"21\" x2=\"16\" y2=\"21\" />\n                        <line x1=\"12\" y1=\"17\" x2=\"12\" y2=\"21\" />\n                      </svg>\n                    ),\n                  },\n                  {\n                    id: \"sepia\",\n                    label: \"Sepia\",\n                    icon: (\n                      <svg\n                        viewBox=\"0 0 24 24\"\n                        fill=\"none\"\n                        stroke=\"currentColor\"\n                        stroke-width=\"1.5\"\n                        width=\"16\"\n                        height=\"16\"\n                      >\n                        <path d=\"M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z\" />\n                        <path d=\"M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z\" />\n                      </svg>\n                    ),\n                  },\n                ] as const\n              ).map((t) => (\n                <button\n                  key={t.id}\n                  class={`pressy-theme-btn ${\n                    activeTheme === t.id ? \"pressy-theme-btn--active\" : \"\"\n                  }`}\n                  onClick={(e: MouseEvent) => {\n                    e.stopPropagation();\n                    handleThemeChange(t.id);\n                  }}\n                >\n                  {t.icon}\n                  <span>{t.label}</span>\n                </button>\n              ))}\n            </div>\n          </div>\n          <div class=\"pressy-settings-section\">\n            <div class=\"pressy-settings-label\">Font Size</div>\n            <div class=\"pressy-font-size-controls\">\n              <button\n                class=\"pressy-font-size-btn\"\n                onClick={(e: MouseEvent) => {\n                  e.stopPropagation();\n                  handleFontSizeChange(-0.1);\n                }}\n                disabled={fontScale <= 0.8}\n                aria-label=\"Decrease font size\"\n              >\n                A-\n              </button>\n              <span class=\"pressy-font-size-value\">\n                {Math.round(fontScale * 100)}%\n              </span>\n              <button\n                class=\"pressy-font-size-btn\"\n                onClick={(e: MouseEvent) => {\n                  e.stopPropagation();\n                  handleFontSizeChange(0.1);\n                }}\n                disabled={fontScale >= 1.5}\n                aria-label=\"Increase font size\"\n              >\n                A+\n              </button>\n            </div>\n          </div>\n        </div>\n      </div>\n\n      <style>{SCROLL_STYLES}</style>\n    </div>\n  );\n}\n\n// ── Paginated Reader ──────────────────────────────────────────\n\ninterface LoadedChapter {\n  slug: string;\n  title: string;\n  Content: ComponentType<{ components?: Record<string, unknown> }>;\n}\n\ninterface ChapterPageRange {\n  slug: string;\n  startPage: number;\n  endPage: number;\n}\n\ninterface PaginatedReaderProps {\n  children: ComponentChildren;\n  bookTitle?: string;\n  prevChapter?: { slug: string; title: string };\n  nextChapter?: { slug: string; title: string };\n  showDropCap: boolean;\n  onSaveProgress?: (data: ProgressData) => void;\n  onRestoreProgress?: () => Promise<ProgressData | null>;\n  bookProgressPercent?: number;\n  initialContent?: ComponentType<{ components?: Record<string, unknown> }>;\n  chapterMapData?: ChapterMapData;\n  currentChapterSlug?: string;\n  allChapters?: Array<{ slug: string; title: string; wordCount?: number }>;\n  bookBasePath?: string;\n  onChapterChange?: (slug: string, page: number, totalPages: number) => void;\n  mdxComponents?: Record<string, unknown>;\n  offlineProps?: OfflineProps;\n}\n\nfunction ChapterDivider({ title }: { title: string }) {\n  return (\n    <div class=\"pressy-chapter-divider\">\n      <h2 class=\"pressy-chapter-divider-title\">{title}</h2>\n    </div>\n  );\n}\n\nfunction PaginatedReader({\n  children,\n  bookTitle,\n  prevChapter,\n  nextChapter,\n  showDropCap,\n  onSaveProgress,\n  onRestoreProgress,\n  bookProgressPercent,\n  initialContent,\n  chapterMapData,\n  currentChapterSlug,\n  allChapters,\n  bookBasePath,\n  onChapterChange,\n  mdxComponents,\n  offlineProps,\n}: PaginatedReaderProps) {\n  const containerRef = useRef<HTMLDivElement>(null);\n  const viewportRef = useRef<HTMLDivElement>(null);\n  const articleRef = useRef<HTMLElement>(null);\n  const [currentPage, setCurrentPage] = useState(0);\n  const [totalPages, setTotalPages] = useState(1);\n  const hasRestoredRef = useRef(false);\n  const saveTimerRef = useRef<ReturnType<typeof setTimeout> | null>(null);\n\n  // Multi-chapter state\n  const [loadedChapters, setLoadedChapters] = useState<LoadedChapter[]>([]);\n  const [chapterRanges, setChapterRanges] = useState<ChapterPageRange[]>([]);\n  const [activeChapterSlug, setActiveChapterSlug] = useState(\n    currentChapterSlug || \"\"\n  );\n  const preloadingRef = useRef<Set<string>>(new Set());\n\n  // Whether we're in multi-chapter mode\n  const isMultiChapter = !!(\n    chapterMapData &&\n    initialContent &&\n    currentChapterSlug &&\n    allChapters\n  );\n\n  // Initialize loaded chapters\n  useEffect(() => {\n    if (isMultiChapter && initialContent && currentChapterSlug) {\n      const chapterInfo = allChapters!.find(\n        (ch) => ch.slug === currentChapterSlug\n      );\n      setLoadedChapters([\n        {\n          slug: currentChapterSlug,\n          title: chapterInfo?.title || currentChapterSlug,\n          Content: initialContent,\n        },\n      ]);\n      setActiveChapterSlug(currentChapterSlug);\n    }\n  }, []); // Only on mount\n\n  // Settings & TOC panel state\n  const [settingsOpen, setSettingsOpen] = useState(false);\n  const [tocOpen, setTocOpen] = useState(false);\n  const [activeTheme, setActiveTheme] = useState<string>(() => {\n    if (typeof localStorage !== \"undefined\") {\n      return localStorage.getItem(\"pressy-theme\") || \"light\";\n    }\n    return \"light\";\n  });\n  const [fontScale, setFontScale] = useState<number>(() => {\n    if (typeof localStorage !== \"undefined\") {\n      const saved = localStorage.getItem(\"pressy-font-size\");\n      return saved ? parseFloat(saved) : 1.0;\n    }\n    return 1.0;\n  });\n\n  const applyFontScale = useCallback((scale: number) => {\n    if (scale === 1.0) {\n      document.documentElement.style.removeProperty(\"--font-size-base\");\n    } else {\n      document.documentElement.style.setProperty(\n        \"--font-size-base\",\n        `calc(clamp(1rem, 0.875rem + 0.5vw, 1.25rem) * ${scale})`\n      );\n    }\n  }, []);\n\n  // Apply saved font scale on mount\n  useEffect(() => {\n    if (fontScale !== 1.0) {\n      applyFontScale(fontScale);\n    }\n  }, []);\n\n  const handleThemeChange = useCallback((theme: string) => {\n    setActiveTheme(theme);\n    localStorage.setItem(\"pressy-theme\", theme);\n    const resolved =\n      theme === \"system\"\n        ? window.matchMedia(\"(prefers-color-scheme: dark)\").matches\n          ? \"dark\"\n          : \"light\"\n        : theme;\n    document.documentElement.setAttribute(\"data-theme\", resolved);\n  }, []);\n\n  // Drag/swipe state\n  const [isDragging, setIsDragging] = useState(false);\n  const [dragOffset, setDragOffset] = useState(0);\n  const [chapterHint, setChapterHint] = useState<\"next\" | \"prev\" | null>(null);\n\n  // Touch tracking refs (avoid re-renders during drag)\n  const touchStartXRef = useRef(0);\n  const touchStartYRef = useRef(0);\n  const lastTouchXRef = useRef(0);\n  const lastTouchTimeRef = useRef(0);\n  const velocityRef = useRef(0);\n  const isSwipingRef = useRef(false);\n  const isDraggingRef = useRef(false);\n\n  // Build page-to-chapter map after recalculating pages\n  const updateChapterRanges = useCallback(() => {\n    if (!isMultiChapter) return;\n    const article = articleRef.current;\n    const viewport = viewportRef.current;\n    if (!article || !viewport) return;\n\n    const viewportWidth = viewport.clientWidth;\n    if (viewportWidth === 0) return;\n\n    const sections = article.querySelectorAll(\".pressy-chapter-section\");\n    const ranges: ChapterPageRange[] = [];\n\n    sections.forEach((section) => {\n      const slug = section.getAttribute(\"data-chapter-slug\") || \"\";\n      const sectionLeft = (section as HTMLElement).offsetLeft;\n      const sectionWidth = (section as HTMLElement).scrollWidth;\n      const startPage = Math.floor(sectionLeft / viewportWidth);\n      const endPage = Math.max(\n        startPage,\n        Math.ceil((sectionLeft + sectionWidth) / viewportWidth) - 1\n      );\n      ranges.push({ slug, startPage, endPage });\n    });\n\n    setChapterRanges(ranges);\n  }, [isMultiChapter]);\n\n  // Calculate page count and set column-width to match viewport\n  const recalculatePages = useCallback(() => {\n    const article = articleRef.current;\n    const viewport = viewportRef.current;\n    if (!article || !viewport) return;\n\n    const viewportWidth = viewport.clientWidth;\n    if (viewportWidth === 0) return;\n\n    // Set column-width to viewport width so each column = one page\n    article.style.columnWidth = `${viewportWidth}px`;\n\n    // Force synchronous layout recalculation\n    void article.scrollWidth;\n\n    const total = Math.max(1, Math.round(article.scrollWidth / viewportWidth));\n    setTotalPages(total);\n\n    // Clamp current page if now out of bounds (e.g. after resize)\n    setCurrentPage((prev) => Math.min(prev, total - 1));\n\n    // Update chapter ranges for multi-chapter mode\n    updateChapterRanges();\n  }, [updateChapterRanges]);\n\n  // Font size change handler (defined after recalculatePages)\n  const handleFontSizeChange = useCallback(\n    (delta: number) => {\n      setFontScale((prev) => {\n        const next =\n          Math.round(Math.max(0.8, Math.min(1.5, prev + delta)) * 10) / 10;\n        localStorage.setItem(\"pressy-font-size\", String(next));\n        applyFontScale(next);\n        setTimeout(() => recalculatePages(), 100);\n        return next;\n      });\n    },\n    [applyFontScale, recalculatePages]\n  );\n\n  // Recalculate on mount and on resize via ResizeObserver\n  useEffect(() => {\n    const viewport = viewportRef.current;\n    if (!viewport) return;\n\n    // Delay initial calculation to let fonts and content render\n    const initialTimer = setTimeout(recalculatePages, 50);\n\n    const observer = new ResizeObserver(() => {\n      recalculatePages();\n    });\n    observer.observe(viewport);\n\n    return () => {\n      clearTimeout(initialTimer);\n      observer.disconnect();\n    };\n  }, [recalculatePages]);\n\n  // Recalculate when loaded chapters change\n  useEffect(() => {\n    if (loadedChapters.length > 0) {\n      // Delay to let new content render\n      const timer = setTimeout(recalculatePages, 50);\n      return () => clearTimeout(timer);\n    }\n  }, [loadedChapters.length, recalculatePages]);\n\n  // Recalculate when images finish loading\n  useEffect(() => {\n    const article = articleRef.current;\n    if (!article) return;\n\n    const images = article.querySelectorAll(\"img\");\n    if (images.length === 0) return;\n\n    const onLoad = () => recalculatePages();\n    images.forEach((img) => {\n      if (!img.complete) {\n        img.addEventListener(\"load\", onLoad);\n        img.addEventListener(\"error\", onLoad);\n      }\n    });\n\n    return () => {\n      images.forEach((img) => {\n        img.removeEventListener(\"load\", onLoad);\n        img.removeEventListener(\"error\", onLoad);\n      });\n    };\n  }, [recalculatePages, loadedChapters.length]);\n\n  // Check ?page=last query param for backward navigation\n  useEffect(() => {\n    const params = new URLSearchParams(window.location.search);\n    if (params.get(\"page\") === \"last\" && totalPages > 1) {\n      setCurrentPage(totalPages - 1);\n      hasRestoredRef.current = true;\n      // Clean up the URL\n      const url = new URL(window.location.href);\n      url.searchParams.delete(\"page\");\n      history.replaceState(null, \"\", url.pathname);\n    }\n  }, [totalPages]);\n\n  // Apply translateX — combines page position + drag offset\n  useEffect(() => {\n    const article = articleRef.current;\n    const viewport = viewportRef.current;\n    if (!article || !viewport) return;\n\n    const baseOffset = currentPage * viewport.clientWidth;\n    const totalOffset = baseOffset - dragOffset;\n\n    if (isDragging) {\n      // During drag: no transition, immediate response\n      article.style.transition = \"none\";\n    } else {\n      // Snap animation: smooth ease-out\n      article.style.transition =\n        \"transform 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94)\";\n    }\n\n    article.style.transform = `translateX(-${totalOffset}px)`;\n  }, [currentPage, dragOffset, isDragging]);\n\n  // Manage focusability: elements on off-screen pages get tabindex=\"-1\"\n  // so tab navigation can't reach them and cause layout shifts.\n  // Uses getBoundingClientRect which accounts for the CSS transform.\n  useEffect(() => {\n    const article = articleRef.current;\n    const viewport = viewportRef.current;\n    if (!article || !viewport) return;\n\n    const viewportRect = viewport.getBoundingClientRect();\n\n    const focusable = article.querySelectorAll<HTMLElement>(\n      \"a[href], button, input, select, textarea, [tabindex]\"\n    );\n\n    focusable.forEach((el) => {\n      const elRect = el.getBoundingClientRect();\n      const onCurrentPage =\n        elRect.left >= viewportRect.left - 1 &&\n        elRect.right <= viewportRect.right + 1;\n\n      if (onCurrentPage) {\n        const original = el.getAttribute(\"data-original-tabindex\");\n        if (original !== null) {\n          if (original === \"\") {\n            el.removeAttribute(\"tabindex\");\n          } else {\n            el.setAttribute(\"tabindex\", original);\n          }\n          el.removeAttribute(\"data-original-tabindex\");\n        }\n      } else {\n        if (!el.hasAttribute(\"data-original-tabindex\")) {\n          el.setAttribute(\n            \"data-original-tabindex\",\n            el.getAttribute(\"tabindex\") || \"\"\n          );\n        }\n        el.setAttribute(\"tabindex\", \"-1\");\n      }\n    });\n  }, [currentPage, totalPages]);\n\n  // Preload next chapter when within 2 pages of chapter end\n  useEffect(() => {\n    if (!isMultiChapter || !chapterMapData || chapterRanges.length === 0)\n      return;\n\n    const activeRange = chapterRanges.find((r) => r.slug === activeChapterSlug);\n    if (!activeRange) return;\n\n    const pagesFromEnd = activeRange.endPage - currentPage;\n    if (pagesFromEnd > 2) return;\n\n    // Find the next chapter to preload\n    const { chapterOrder, chapterMap } = chapterMapData;\n    const lastLoadedSlug = loadedChapters[loadedChapters.length - 1]?.slug;\n    const lastLoadedIdx = chapterOrder.indexOf(lastLoadedSlug);\n    if (lastLoadedIdx === -1 || lastLoadedIdx >= chapterOrder.length - 1)\n      return;\n\n    const nextSlug = chapterOrder[lastLoadedIdx + 1];\n    if (preloadingRef.current.has(nextSlug)) return;\n    if (loadedChapters.some((ch) => ch.slug === nextSlug)) return;\n\n    preloadingRef.current.add(nextSlug);\n\n    const loader = chapterMap[nextSlug];\n    if (!loader) return;\n\n    loader()\n      .then((mod) => {\n        const Content = mod.default;\n        const chapterInfo = allChapters!.find((ch) => ch.slug === nextSlug);\n        setLoadedChapters((prev) => {\n          if (prev.some((ch) => ch.slug === nextSlug)) return prev;\n          return [\n            ...prev,\n            {\n              slug: nextSlug,\n              title: chapterInfo?.title || nextSlug,\n              Content,\n            },\n          ];\n        });\n      })\n      .catch(() => {\n        // Dynamic import failed — will fall back to full-page navigation\n        preloadingRef.current.delete(nextSlug);\n      });\n  }, [\n    currentPage,\n    activeChapterSlug,\n    chapterRanges,\n    isMultiChapter,\n    chapterMapData,\n    loadedChapters,\n    allChapters,\n  ]);\n\n  // Detect chapter boundary crossings and update URL / active chapter\n  useEffect(() => {\n    if (!isMultiChapter || chapterRanges.length === 0 || !bookBasePath) return;\n\n    const currentRange = chapterRanges.find(\n      (r) => currentPage >= r.startPage && currentPage <= r.endPage\n    );\n    if (!currentRange || currentRange.slug === activeChapterSlug) return;\n\n    const prevSlug = activeChapterSlug;\n    setActiveChapterSlug(currentRange.slug);\n\n    // Update URL\n    const newPath = `${bookBasePath}/${currentRange.slug}`;\n    history.replaceState(null, \"\", newPath);\n\n    // Update document title\n    const chapterInfo = allChapters?.find(\n      (ch) => ch.slug === currentRange.slug\n    );\n    if (chapterInfo) {\n      document.title = document.title.replace(\n        /^[^|]+/,\n        chapterInfo.title + \" \"\n      );\n    }\n\n    // Notify parent about chapter change (saves progress for the chapter being left)\n    if (onChapterChange && prevSlug) {\n      const prevRange = chapterRanges.find((r) => r.slug === prevSlug);\n      if (prevRange) {\n        const prevTotalPages = prevRange.endPage - prevRange.startPage + 1;\n        onChapterChange(prevSlug, prevTotalPages - 1, prevTotalPages);\n      }\n    }\n  }, [\n    currentPage,\n    chapterRanges,\n    activeChapterSlug,\n    isMultiChapter,\n    bookBasePath,\n    allChapters,\n    onChapterChange,\n  ]);\n\n  // Save progress when page changes (debounced) — save relative to active chapter\n  useEffect(() => {\n    if (!onSaveProgress || !hasRestoredRef.current) return;\n\n    if (saveTimerRef.current) clearTimeout(saveTimerRef.current);\n    saveTimerRef.current = setTimeout(() => {\n      if (isMultiChapter && chapterRanges.length > 0) {\n        const activeRange = chapterRanges.find(\n          (r) => r.slug === activeChapterSlug\n        );\n        if (activeRange) {\n          const chapterPage = currentPage - activeRange.startPage;\n          const chapterTotalPages =\n            activeRange.endPage - activeRange.startPage + 1;\n          onSaveProgress({\n            page: chapterPage,\n            totalPages: chapterTotalPages,\n            scrollPosition: 0,\n          });\n        }\n      } else {\n        onSaveProgress({\n          page: currentPage,\n          totalPages,\n          scrollPosition: 0,\n        });\n      }\n    }, 300);\n\n    return () => {\n      if (saveTimerRef.current) clearTimeout(saveTimerRef.current);\n    };\n  }, [\n    currentPage,\n    totalPages,\n    onSaveProgress,\n    isMultiChapter,\n    chapterRanges,\n    activeChapterSlug,\n  ]);\n\n  // Save progress on page unload\n  useEffect(() => {\n    if (!onSaveProgress) return;\n\n    const handleUnload = () => {\n      if (isMultiChapter && chapterRanges.length > 0) {\n        const activeRange = chapterRanges.find(\n          (r) => r.slug === activeChapterSlug\n        );\n        if (activeRange) {\n          const chapterPage = currentPage - activeRange.startPage;\n          const chapterTotalPages =\n            activeRange.endPage - activeRange.startPage + 1;\n          onSaveProgress({\n            page: chapterPage,\n            totalPages: chapterTotalPages,\n            scrollPosition: 0,\n          });\n        }\n      } else {\n        onSaveProgress({\n          page: currentPage,\n          totalPages,\n          scrollPosition: 0,\n        });\n      }\n    };\n\n    window.addEventListener(\"beforeunload\", handleUnload);\n    return () => window.removeEventListener(\"beforeunload\", handleUnload);\n  }, [\n    currentPage,\n    totalPages,\n    onSaveProgress,\n    isMultiChapter,\n    chapterRanges,\n    activeChapterSlug,\n  ]);\n\n  // Determine the effective last chapter slug for rubber-band / next chapter hint\n  const effectiveNextChapter = (() => {\n    if (!isMultiChapter || !chapterMapData) return nextChapter;\n    const { chapterOrder } = chapterMapData;\n    const lastLoadedSlug = loadedChapters[loadedChapters.length - 1]?.slug;\n    const lastLoadedIdx = chapterOrder.indexOf(lastLoadedSlug);\n    // If we haven't loaded the last chapter in the book yet, no next chapter hint needed\n    // (preloading will seamlessly add the next chapter)\n    if (lastLoadedIdx < chapterOrder.length - 1) return undefined;\n    // All chapters loaded — navigate to book table of contents\n    if (bookBasePath) return { slug: bookBasePath, title: \"Table of Contents\" };\n    return nextChapter;\n  })();\n\n  // Determine the effective prev chapter for backward navigation\n  const effectivePrevChapter = (() => {\n    if (!isMultiChapter || !chapterMapData) return prevChapter;\n    const { chapterOrder } = chapterMapData;\n    const firstLoadedSlug = loadedChapters[0]?.slug;\n    const firstLoadedIdx = chapterOrder.indexOf(firstLoadedSlug);\n    // If the first loaded chapter is the first chapter of the book\n    if (firstLoadedIdx <= 0) return prevChapter;\n    // There's a previous chapter in the book — navigate to it via page load\n    const prevSlug = chapterOrder[firstLoadedIdx - 1];\n    const prevInfo = allChapters?.find((ch) => ch.slug === prevSlug);\n    return {\n      slug: `${bookBasePath}/${prevSlug}?page=last`,\n      title: prevInfo?.title || prevSlug,\n    };\n  })();\n\n  const goToPage = useCallback(\n    (page: number) => {\n      const clamped = Math.max(0, Math.min(page, totalPages - 1));\n      setCurrentPage(clamped);\n    },\n    [totalPages]\n  );\n\n  const goNext = useCallback(() => {\n    if (currentPage >= totalPages - 1) {\n      // At the last page — navigate to next chapter if available\n      if (effectiveNextChapter) {\n        window.location.href = effectiveNextChapter.slug;\n      }\n      return;\n    }\n    goToPage(currentPage + 1);\n  }, [currentPage, totalPages, effectiveNextChapter, goToPage]);\n\n  const goPrev = useCallback(() => {\n    if (currentPage <= 0) {\n      // At the first page — navigate to prev chapter if available\n      if (effectivePrevChapter) {\n        window.location.href = effectivePrevChapter.slug;\n      }\n      return;\n    }\n    goToPage(currentPage - 1);\n  }, [currentPage, effectivePrevChapter, goToPage]);\n\n  // Footer visibility — hidden by default, shown on interaction\n  const [footerVisible, setFooterVisible] = useState(false);\n  const footerTimerRef = useRef<ReturnType<typeof setTimeout> | null>(null);\n\n  const showFooterTemporarily = useCallback(() => {\n    setFooterVisible(true);\n    if (footerTimerRef.current) clearTimeout(footerTimerRef.current);\n    footerTimerRef.current = setTimeout(() => setFooterVisible(false), 3000);\n  }, []);\n\n  // Double-tap fullscreen (mobile middle-third)\n  const lastMiddleTapRef = useRef(0);\n  const middleTapTimerRef = useRef<ReturnType<typeof setTimeout> | null>(null);\n\n  const toggleFullscreen = useCallback(() => {\n    if (document.fullscreenElement) {\n      document.exitFullscreen();\n    } else {\n      document.documentElement.requestFullscreen().catch(() => {\n        // Fullscreen not supported or denied\n      });\n    }\n  }, []);\n\n  // Whether the device supports hover (i.e. desktop with a mouse).\n  // Touch-only devices use swipe for page turns; tapping just toggles the footer.\n  const isTouchDevice =\n    typeof window !== \"undefined\" && window.matchMedia(\"(hover: none)\").matches;\n\n  // Click handler: on desktop, edge clicks turn pages and middle clicks\n  // toggle footer / double-click fullscreen. On touch devices, any tap\n  // simply toggles the footer — swiping handles all page navigation.\n  const handleContainerClick = useCallback(\n    (e: MouseEvent) => {\n      const target = e.target as HTMLElement;\n\n      // Clicks inside panels or on interactive elements — ignore\n      if (\n        target.closest(\n          \".pressy-settings-panel, .pressy-settings-toggle, .pressy-toc-drawer, .pressy-toc-toggle\"\n        )\n      )\n        return;\n      if (target.closest('a, button, input, select, textarea, [role=\"button\"]'))\n        return;\n\n      // If settings or TOC panel is open, close it on any outside click\n      if (settingsOpen || tocOpen) {\n        setSettingsOpen(false);\n        setTocOpen(false);\n        return;\n      }\n\n      // Touch devices: tap anywhere toggles the footer, nothing else\n      if (isTouchDevice) {\n        if (footerVisible) {\n          setFooterVisible(false);\n          if (footerTimerRef.current) clearTimeout(footerTimerRef.current);\n        } else {\n          showFooterTemporarily();\n        }\n        return;\n      }\n\n      // Desktop: edge clicks turn pages, middle clicks toggle footer / fullscreen\n      const container = containerRef.current;\n      if (!container) return;\n\n      const rect = container.getBoundingClientRect();\n      const x = e.clientX - rect.left;\n      const edgeZone = rect.width * 0.15;\n\n      if (x < edgeZone) {\n        goPrev();\n      } else if (x > rect.width - edgeZone) {\n        goNext();\n      } else {\n        // Middle third — single click toggles footer, double click toggles fullscreen\n        const now = Date.now();\n        const timeSinceLastTap = now - lastMiddleTapRef.current;\n        lastMiddleTapRef.current = now;\n\n        if (timeSinceLastTap < 300) {\n          if (middleTapTimerRef.current)\n            clearTimeout(middleTapTimerRef.current);\n          toggleFullscreen();\n        } else {\n          if (middleTapTimerRef.current)\n            clearTimeout(middleTapTimerRef.current);\n          middleTapTimerRef.current = setTimeout(() => {\n            if (footerVisible) {\n              setFooterVisible(false);\n              if (footerTimerRef.current) clearTimeout(footerTimerRef.current);\n            } else {\n              showFooterTemporarily();\n            }\n          }, 300);\n        }\n      }\n    },\n    [\n      goNext,\n      goPrev,\n      footerVisible,\n      isTouchDevice,\n      settingsOpen,\n      tocOpen,\n      showFooterTemporarily,\n      toggleFullscreen,\n    ]\n  );\n\n  // Hover zone tracking for desktop navigation hints\n  const [hoverZone, setHoverZone] = useState<\"left\" | \"right\" | null>(null);\n\n  const handleMouseMove = useCallback(\n    (e: MouseEvent) => {\n      const container = containerRef.current;\n      if (!container) return;\n\n      const rect = container.getBoundingClientRect();\n      const x = e.clientX - rect.left;\n      const y = e.clientY - rect.top;\n      const third = rect.width / 3;\n\n      if (x < third) {\n        setHoverZone(\"left\");\n      } else if (x > third * 2) {\n        setHoverZone(\"right\");\n      } else {\n        setHoverZone(null);\n      }\n\n      // Show footer when mouse is in the bottom quarter\n      if (y > rect.height * 0.75) {\n        setFooterVisible(true);\n        if (footerTimerRef.current) clearTimeout(footerTimerRef.current);\n      } else if (!settingsOpen && !tocOpen) {\n        // Hide after a short delay when leaving the bottom area (not when panels are open)\n        if (footerTimerRef.current) clearTimeout(footerTimerRef.current);\n        footerTimerRef.current = setTimeout(() => setFooterVisible(false), 600);\n      }\n    },\n    [settingsOpen, tocOpen]\n  );\n\n  const handleMouseLeave = useCallback(() => {\n    setHoverZone(null);\n    if (!settingsOpen && !tocOpen) {\n      if (footerTimerRef.current) clearTimeout(footerTimerRef.current);\n      footerTimerRef.current = setTimeout(() => setFooterVisible(false), 600);\n    }\n  }, [settingsOpen, tocOpen]);\n\n  // Keyboard navigation\n  useEffect(() => {\n    const handleKeyDown = (e: KeyboardEvent) => {\n      // Don't intercept if user is in an input/textarea\n      const tag = (e.target as HTMLElement).tagName;\n      if (tag === \"INPUT\" || tag === \"TEXTAREA\" || tag === \"SELECT\") return;\n\n      if (e.key === \"ArrowRight\" || e.key === \" \") {\n        e.preventDefault();\n        goNext();\n      } else if (e.key === \"ArrowLeft\") {\n        e.preventDefault();\n        goPrev();\n      } else if (e.key === \"Home\") {\n        e.preventDefault();\n        goToPage(0);\n      } else if (e.key === \"End\") {\n        e.preventDefault();\n        goToPage(totalPages - 1);\n      }\n    };\n\n    window.addEventListener(\"keydown\", handleKeyDown);\n    return () => window.removeEventListener(\"keydown\", handleKeyDown);\n  }, [goNext, goPrev, goToPage, totalPages]);\n\n  // Touch swipe navigation with drag tracking, velocity detection, and rubber-band.\n  // Listeners attach to the outer container (not the viewport) so they capture\n  // touches that land on sibling elements like the tap-zone overlays.\n  useEffect(() => {\n    const container = containerRef.current;\n    if (!container) return;\n\n    const onTouchStart = (e: TouchEvent) => {\n      const touch = e.touches[0];\n      touchStartXRef.current = touch.clientX;\n      touchStartYRef.current = touch.clientY;\n      lastTouchXRef.current = touch.clientX;\n      lastTouchTimeRef.current = performance.now();\n      velocityRef.current = 0;\n      isSwipingRef.current = false;\n      isDraggingRef.current = false;\n    };\n\n    const onTouchMove = (e: TouchEvent) => {\n      const touch = e.touches[0];\n      const dx = touch.clientX - touchStartXRef.current;\n      const dy = touch.clientY - touchStartYRef.current;\n\n      // Lock direction after initial movement\n      if (!isSwipingRef.current) {\n        if (Math.abs(dx) > Math.abs(dy) && Math.abs(dx) > 10) {\n          isSwipingRef.current = true;\n        } else if (Math.abs(dy) > Math.abs(dx) && Math.abs(dy) > 10) {\n          // Vertical scroll — not our concern\n          return;\n        } else {\n          return; // Not enough movement yet\n        }\n      }\n\n      e.preventDefault();\n\n      // Track velocity (px per ms) using last touch position\n      const now = performance.now();\n      const timeDelta = now - lastTouchTimeRef.current;\n      if (timeDelta > 0) {\n        const instantVelocity =\n          (touch.clientX - lastTouchXRef.current) / timeDelta;\n        // Smooth velocity with exponential moving average\n        velocityRef.current = 0.6 * instantVelocity + 0.4 * velocityRef.current;\n      }\n      lastTouchXRef.current = touch.clientX;\n      lastTouchTimeRef.current = now;\n\n      // Determine drag offset with rubber-band resistance at boundaries\n      let offset = dx;\n      const atStart = currentPage === 0;\n      const atEnd = currentPage >= totalPages - 1;\n\n      if ((atStart && dx > 0) || (atEnd && dx < 0)) {\n        // Rubber-band: diminishing resistance using square root curve\n        // This gives a natural iOS-like rubber-band feel\n        const sign = dx > 0 ? 1 : -1;\n        const absDx = Math.abs(dx);\n        offset = sign * Math.sqrt(absDx) * 5;\n\n        // Show chapter hint when overscrolling past boundary\n        if (dx > 40 && atStart && effectivePrevChapter) {\n          setChapterHint(\"prev\");\n        } else if (dx < -40 && atEnd && effectiveNextChapter) {\n          setChapterHint(\"next\");\n        } else {\n          setChapterHint(null);\n        }\n      } else {\n        setChapterHint(null);\n      }\n\n      isDraggingRef.current = true;\n      setIsDragging(true);\n      setDragOffset(offset);\n    };\n\n    const onTouchEnd = (e: TouchEvent) => {\n      if (!isSwipingRef.current || !isDraggingRef.current) {\n        setIsDragging(false);\n        setDragOffset(0);\n        setChapterHint(null);\n        return;\n      }\n\n      const dx = e.changedTouches[0].clientX - touchStartXRef.current;\n      const velocity = velocityRef.current; // px/ms\n      const distanceThreshold = 50;\n      const velocityThreshold = 0.3; // px/ms — a fast flick\n      const chapterThreshold = 80;\n\n      const atStart = currentPage === 0;\n      const atEnd = currentPage >= totalPages - 1;\n\n      // Chapter navigation on overscroll\n      if (atEnd && dx < -chapterThreshold && effectiveNextChapter) {\n        setIsDragging(false);\n        setDragOffset(0);\n        setChapterHint(null);\n        window.location.href = effectiveNextChapter.slug;\n        return;\n      }\n      if (atStart && dx > chapterThreshold && effectivePrevChapter) {\n        setIsDragging(false);\n        setDragOffset(0);\n        setChapterHint(null);\n        window.location.href = effectivePrevChapter.slug;\n        return;\n      }\n\n      // Determine page change: distance OR velocity triggers a turn\n      if (dx < -distanceThreshold || velocity < -velocityThreshold) {\n        goNext();\n      } else if (dx > distanceThreshold || velocity > velocityThreshold) {\n        goPrev();\n      }\n\n      // Reset drag state — the CSS transition handles the snap animation\n      isDraggingRef.current = false;\n      setIsDragging(false);\n      setDragOffset(0);\n      setChapterHint(null);\n    };\n\n    // Cancel drag if touch is interrupted\n    const onTouchCancel = () => {\n      isDraggingRef.current = false;\n      setIsDragging(false);\n      setDragOffset(0);\n      setChapterHint(null);\n    };\n\n    container.addEventListener(\"touchstart\", onTouchStart, { passive: true });\n    container.addEventListener(\"touchmove\", onTouchMove, { passive: false });\n    container.addEventListener(\"touchend\", onTouchEnd, { passive: true });\n    container.addEventListener(\"touchcancel\", onTouchCancel, { passive: true });\n\n    return () => {\n      container.removeEventListener(\"touchstart\", onTouchStart);\n      container.removeEventListener(\"touchmove\", onTouchMove);\n      container.removeEventListener(\"touchend\", onTouchEnd);\n      container.removeEventListener(\"touchcancel\", onTouchCancel);\n    };\n  }, [\n    currentPage,\n    totalPages,\n    goNext,\n    goPrev,\n    effectiveNextChapter,\n    effectivePrevChapter,\n  ]);\n\n  // Compute per-chapter page indicator values\n  const chapterPageInfo = (() => {\n    if (!isMultiChapter || chapterRanges.length === 0) {\n      return { chapterPage: currentPage, chapterTotalPages: totalPages };\n    }\n    const activeRange = chapterRanges.find((r) => r.slug === activeChapterSlug);\n    if (!activeRange) {\n      return { chapterPage: currentPage, chapterTotalPages: totalPages };\n    }\n    return {\n      chapterPage: currentPage - activeRange.startPage,\n      chapterTotalPages: activeRange.endPage - activeRange.startPage + 1,\n    };\n  })();\n\n  // Book progress: position in the entire book based on word counts.\n  // Maps currentPage/totalPages (across all loaded content) through\n  // word counts to estimate absolute position in the full book.\n  const progressPercent = (() => {\n    if (!allChapters || allChapters.length === 0) {\n      return totalPages > 1 ? (currentPage / (totalPages - 1)) * 100 : 100;\n    }\n\n    const totalWords = allChapters.reduce(\n      (sum, ch) => sum + (ch.wordCount || 0),\n      0\n    );\n    if (totalWords === 0) return 0;\n\n    const firstLoadedSlug = loadedChapters[0]?.slug || activeChapterSlug;\n    let wordsBeforeLoaded = 0;\n    let loadedWords = 0;\n    let foundFirst = false;\n\n    for (const ch of allChapters) {\n      if (ch.slug === firstLoadedSlug) foundFirst = true;\n      if (!foundFirst) {\n        wordsBeforeLoaded += ch.wordCount || 0;\n      } else if (loadedChapters.some((lc) => lc.slug === ch.slug)) {\n        loadedWords += ch.wordCount || 0;\n      } else {\n        break;\n      }\n    }\n\n    const pageFraction = totalPages > 1 ? currentPage / (totalPages - 1) : 0;\n    const wordsInto = wordsBeforeLoaded + pageFraction * loadedWords;\n\n    return Math.min(100, (wordsInto / totalWords) * 100);\n  })();\n\n  // Render content — either multi-chapter sections or single-chapter children\n  const renderContent = () => {\n    if (isMultiChapter && loadedChapters.length > 0) {\n      return loadedChapters.map((ch) => (\n        <section\n          key={ch.slug}\n          class=\"pressy-chapter-section\"\n          data-chapter-slug={ch.slug}\n        >\n          <ChapterDivider title={ch.title} />\n          <ch.Content components={mdxComponents || {}} />\n        </section>\n      ));\n    }\n    return children;\n  };\n\n  return (\n    <div\n      class=\"pressy-reader pressy-reader--paginated\"\n      ref={containerRef}\n      onClick={handleContainerClick}\n      onMouseMove={handleMouseMove}\n      onMouseLeave={handleMouseLeave}\n    >\n      {/* Paginated content viewport */}\n      <div class=\"pressy-paginated-viewport\" ref={viewportRef}>\n        <article\n          ref={articleRef}\n          class={`pressy-prose pressy-prose--paginated ${\n            showDropCap ? \"\" : \"no-drop-cap\"\n          }`}\n          data-drop-cap={showDropCap}\n        >\n          {renderContent()}\n        </article>\n      </div>\n\n      {/* Navigation arrows — appear on hover in left/right thirds */}\n      <div\n        class={`pressy-nav-arrow pressy-nav-arrow--prev ${\n          hoverZone === \"left\" ? \"pressy-nav-arrow--visible\" : \"\"\n        }`}\n      >\n        <svg\n          viewBox=\"0 0 24 24\"\n          fill=\"none\"\n          stroke=\"currentColor\"\n          stroke-width=\"2\"\n          stroke-linecap=\"round\"\n          stroke-linejoin=\"round\"\n        >\n          <polyline points=\"15 18 9 12 15 6\" />\n        </svg>\n      </div>\n      <div\n        class={`pressy-nav-arrow pressy-nav-arrow--next ${\n          hoverZone === \"right\" ? \"pressy-nav-arrow--visible\" : \"\"\n        }`}\n      >\n        <svg\n          viewBox=\"0 0 24 24\"\n          fill=\"none\"\n          stroke=\"currentColor\"\n          stroke-width=\"2\"\n          stroke-linecap=\"round\"\n          stroke-linejoin=\"round\"\n        >\n          <polyline points=\"9 6 15 12 9 18\" />\n        </svg>\n      </div>\n\n      {/* Chapter boundary hints */}\n      {chapterHint === \"prev\" && effectivePrevChapter && (\n        <div\n          class=\"pressy-chapter-hint pressy-chapter-hint--prev\"\n          aria-live=\"polite\"\n        >\n          <span class=\"pressy-chapter-hint-arrow\">{\"\\u2190\"}</span>\n          <span class=\"pressy-chapter-hint-text\">\n            {effectivePrevChapter.title}\n          </span>\n        </div>\n      )}\n      {chapterHint === \"next\" && effectiveNextChapter && (\n        <div\n          class=\"pressy-chapter-hint pressy-chapter-hint--next\"\n          aria-live=\"polite\"\n        >\n          <span class=\"pressy-chapter-hint-text\">\n            {effectiveNextChapter.title}\n          </span>\n          <span class=\"pressy-chapter-hint-arrow\">{\"\\u2192\"}</span>\n        </div>\n      )}\n\n      {/* TOC drawer overlay */}\n      {tocOpen && allChapters && (\n        <div\n          class=\"pressy-toc-backdrop\"\n          onClick={(e: MouseEvent) => {\n            e.stopPropagation();\n            setTocOpen(false);\n          }}\n        >\n          <div\n            class=\"pressy-toc-drawer\"\n            onClick={(e: MouseEvent) => e.stopPropagation()}\n          >\n            <div class=\"pressy-toc-header\">\n              <span class=\"pressy-toc-title\">Contents</span>\n              <button\n                class=\"pressy-toc-close\"\n                onClick={(e: MouseEvent) => {\n                  e.stopPropagation();\n                  setTocOpen(false);\n                }}\n                aria-label=\"Close table of contents\"\n              >\n                <svg\n                  viewBox=\"0 0 24 24\"\n                  fill=\"none\"\n                  stroke=\"currentColor\"\n                  stroke-width=\"2\"\n                  width=\"18\"\n                  height=\"18\"\n                >\n                  <line x1=\"18\" y1=\"6\" x2=\"6\" y2=\"18\" />\n                  <line x1=\"6\" y1=\"6\" x2=\"18\" y2=\"18\" />\n                </svg>\n              </button>\n            </div>\n            <nav class=\"pressy-toc-list\">\n              <a\n                href={bookBasePath ? bookBasePath.replace(/\\/books\\/[^/]+$/, '') || '/' : '/'}\n                class=\"pressy-toc-item pressy-toc-item--home\"\n                onClick={() => setTocOpen(false)}\n              >\n                <span class=\"pressy-toc-item-num\">\n                  <svg viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" width=\"14\" height=\"14\">\n                    <path d=\"M3 9.5L12 3l9 6.5V20a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V9.5z\" />\n                  </svg>\n                </span>\n                <span class=\"pressy-toc-item-title\">{bookTitle || 'Home'}</span>\n              </a>\n              {allChapters.map((ch, i) => (\n                <a\n                  key={ch.slug}\n                  href={`${bookBasePath || \"\"}/${ch.slug}`}\n                  class={`pressy-toc-item ${\n                    ch.slug === (activeChapterSlug || currentChapterSlug)\n                      ? \"pressy-toc-item--active\"\n                      : \"\"\n                  }`}\n                  onClick={() => setTocOpen(false)}\n                >\n                  <span class=\"pressy-toc-item-num\">{i + 1}.</span>\n                  <span class=\"pressy-toc-item-title\">{ch.title}</span>\n                </a>\n              ))}\n            </nav>\n          </div>\n        </div>\n      )}\n\n      {/* Page footer with progress — hidden by default */}\n      <div\n        class={`pressy-page-footer ${\n          footerVisible || settingsOpen || tocOpen\n            ? \"pressy-page-footer--visible\"\n            : \"\"\n        }`}\n      >\n        <div class=\"pressy-progress-bar\">\n          <div\n            class=\"pressy-progress-fill\"\n            style={{ width: `${progressPercent}%` }}\n          />\n        </div>\n        <div class=\"pressy-footer-row\">\n          {allChapters && allChapters.length > 0 && (\n            <button\n              class=\"pressy-toc-toggle\"\n              onClick={(e: MouseEvent) => {\n                e.stopPropagation();\n                setSettingsOpen(false);\n                setTocOpen(!tocOpen);\n              }}\n              aria-label=\"Table of contents\"\n            >\n              <svg\n                viewBox=\"0 0 24 24\"\n                fill=\"none\"\n                stroke=\"currentColor\"\n                stroke-width=\"1.5\"\n                stroke-linecap=\"round\"\n                stroke-linejoin=\"round\"\n                width=\"18\"\n                height=\"18\"\n              >\n                <line x1=\"3\" y1=\"6\" x2=\"21\" y2=\"6\" />\n                <line x1=\"3\" y1=\"12\" x2=\"21\" y2=\"12\" />\n                <line x1=\"3\" y1=\"18\" x2=\"21\" y2=\"18\" />\n              </svg>\n            </button>\n          )}\n          {bookTitle && (\n            <button\n              class=\"pressy-footer-title\"\n              onClick={(e: MouseEvent) => {\n                e.stopPropagation();\n                if (allChapters && allChapters.length > 0) {\n                  setSettingsOpen(false);\n                  setTocOpen(!tocOpen);\n                }\n              }}\n            >\n              {bookTitle}\n            </button>\n          )}\n          <OfflineFooterIcon offlineProps={offlineProps} />\n          <button\n            class=\"pressy-settings-toggle\"\n            onClick={(e: MouseEvent) => {\n              e.stopPropagation();\n              setTocOpen(false);\n              setSettingsOpen(!settingsOpen);\n            }}\n            aria-label=\"Settings\"\n          >\n            <svg\n              viewBox=\"0 0 24 24\"\n              fill=\"none\"\n              stroke=\"currentColor\"\n              stroke-width=\"1.5\"\n              stroke-linecap=\"round\"\n              stroke-linejoin=\"round\"\n              width=\"18\"\n              height=\"18\"\n            >\n              <circle cx=\"12\" cy=\"12\" r=\"3\" />\n              <path d=\"M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z\" />\n            </svg>\n          </button>\n        </div>\n\n        {/* Settings panel */}\n        <div\n          class={`pressy-settings-panel ${\n            settingsOpen ? \"pressy-settings-panel--open\" : \"\"\n          }`}\n        >\n          <div class=\"pressy-settings-section\">\n            <div class=\"pressy-settings-label\">Theme</div>\n            <div class=\"pressy-theme-options\">\n              {(\n                [\n                  {\n                    id: \"light\",\n                    label: \"Light\",\n                    icon: (\n                      <svg\n                        viewBox=\"0 0 24 24\"\n                        fill=\"none\"\n                        stroke=\"currentColor\"\n                        stroke-width=\"1.5\"\n                        width=\"16\"\n                        height=\"16\"\n                      >\n                        <circle cx=\"12\" cy=\"12\" r=\"5\" />\n                        <line x1=\"12\" y1=\"1\" x2=\"12\" y2=\"3\" />\n                        <line x1=\"12\" y1=\"21\" x2=\"12\" y2=\"23\" />\n                        <line x1=\"4.22\" y1=\"4.22\" x2=\"5.64\" y2=\"5.64\" />\n                        <line x1=\"18.36\" y1=\"18.36\" x2=\"19.78\" y2=\"19.78\" />\n                        <line x1=\"1\" y1=\"12\" x2=\"3\" y2=\"12\" />\n                        <line x1=\"21\" y1=\"12\" x2=\"23\" y2=\"12\" />\n                        <line x1=\"4.22\" y1=\"19.78\" x2=\"5.64\" y2=\"18.36\" />\n                        <line x1=\"18.36\" y1=\"5.64\" x2=\"19.78\" y2=\"4.22\" />\n                      </svg>\n                    ),\n                  },\n                  {\n                    id: \"dark\",\n                    label: \"Dark\",\n                    icon: (\n                      <svg\n                        viewBox=\"0 0 24 24\"\n                        fill=\"none\"\n                        stroke=\"currentColor\"\n                        stroke-width=\"1.5\"\n                        width=\"16\"\n                        height=\"16\"\n                      >\n                        <path d=\"M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z\" />\n                      </svg>\n                    ),\n                  },\n                  {\n                    id: \"system\",\n                    label: \"System\",\n                    icon: (\n                      <svg\n                        viewBox=\"0 0 24 24\"\n                        fill=\"none\"\n                        stroke=\"currentColor\"\n                        stroke-width=\"1.5\"\n                        width=\"16\"\n                        height=\"16\"\n                      >\n                        <rect\n                          x=\"2\"\n                          y=\"3\"\n                          width=\"20\"\n                          height=\"14\"\n                          rx=\"2\"\n                          ry=\"2\"\n                        />\n                        <line x1=\"8\" y1=\"21\" x2=\"16\" y2=\"21\" />\n                        <line x1=\"12\" y1=\"17\" x2=\"12\" y2=\"21\" />\n                      </svg>\n                    ),\n                  },\n                  {\n                    id: \"sepia\",\n                    label: \"Sepia\",\n                    icon: (\n                      <svg\n                        viewBox=\"0 0 24 24\"\n                        fill=\"none\"\n                        stroke=\"currentColor\"\n                        stroke-width=\"1.5\"\n                        width=\"16\"\n                        height=\"16\"\n                      >\n                        <path d=\"M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z\" />\n                        <path d=\"M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z\" />\n                      </svg>\n                    ),\n                  },\n                ] as const\n              ).map((t) => (\n                <button\n                  key={t.id}\n                  class={`pressy-theme-btn ${\n                    activeTheme === t.id ? \"pressy-theme-btn--active\" : \"\"\n                  }`}\n                  onClick={(e: MouseEvent) => {\n                    e.stopPropagation();\n                    handleThemeChange(t.id);\n                  }}\n                >\n                  {t.icon}\n                  <span>{t.label}</span>\n                </button>\n              ))}\n            </div>\n          </div>\n          <div class=\"pressy-settings-section\">\n            <div class=\"pressy-settings-label\">Font Size</div>\n            <div class=\"pressy-font-size-controls\">\n              <button\n                class=\"pressy-font-size-btn\"\n                onClick={(e: MouseEvent) => {\n                  e.stopPropagation();\n                  handleFontSizeChange(-0.1);\n                }}\n                disabled={fontScale <= 0.8}\n                aria-label=\"Decrease font size\"\n              >\n                A-\n              </button>\n              <span class=\"pressy-font-size-value\">\n                {Math.round(fontScale * 100)}%\n              </span>\n              <button\n                class=\"pressy-font-size-btn\"\n                onClick={(e: MouseEvent) => {\n                  e.stopPropagation();\n                  handleFontSizeChange(0.1);\n                }}\n                disabled={fontScale >= 1.5}\n                aria-label=\"Increase font size\"\n              >\n                A+\n              </button>\n            </div>\n          </div>\n        </div>\n      </div>\n\n      <TextShare />\n      <OfflineIndicator />\n\n      <style>{PAGINATED_STYLES}</style>\n    </div>\n  );\n}\n\n// ── Styles ────────────────────────────────────────────────────\n\nconst SCROLL_STYLES = `\n  .pressy-reader {\n    min-height: 100vh;\n    display: flex;\n    flex-direction: column;\n  }\n\n  .pressy-reader-main {\n    flex: 1;\n    padding: 2rem 0;\n  }\n\n  /* ── Scroll reader footer ──────────────────────────────── */\n  .pressy-page-footer--scroll {\n    position: fixed;\n    bottom: 0;\n    left: 0;\n    right: 0;\n    padding: 0.5rem 1.5rem 1rem;\n    text-align: center;\n    user-select: none;\n    transform: translateY(100%);\n    opacity: 0;\n    transition: transform 0.25s ease, opacity 0.25s ease;\n    z-index: 15;\n    background: var(--color-bg, #ffffff);\n    box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.05);\n  }\n\n  .pressy-page-footer--scroll.pressy-page-footer--visible {\n    transform: translateY(0);\n    opacity: 1;\n  }\n\n  /* Shared footer styles for scroll reader */\n  .pressy-page-footer--scroll .pressy-footer-row {\n    display: flex;\n    align-items: center;\n    justify-content: space-between;\n    gap: 0.5rem;\n  }\n\n  .pressy-page-footer--scroll .pressy-footer-title {\n    font-family: var(--font-heading, system-ui, -apple-system, sans-serif);\n    font-size: 0.75rem;\n    color: var(--color-text-muted, #6c757d);\n    text-decoration: none;\n    overflow: hidden;\n    text-overflow: ellipsis;\n    white-space: nowrap;\n    min-width: 0;\n    flex: 1;\n    text-align: left;\n    border: none;\n    background: none;\n    cursor: pointer;\n    padding: 0;\n  }\n\n  .pressy-page-footer--scroll .pressy-footer-title:hover {\n    color: var(--color-text, #212529);\n  }\n\n  .pressy-page-footer--scroll .pressy-toc-toggle,\n  .pressy-page-footer--scroll .pressy-settings-toggle {\n    flex-shrink: 0;\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    width: 2rem;\n    height: 2rem;\n    border: none;\n    background: transparent;\n    color: var(--color-text-muted, #6c757d);\n    cursor: pointer;\n    border-radius: 0.375rem;\n    transition: color 0.15s, background 0.15s;\n    padding: 0;\n  }\n\n  .pressy-page-footer--scroll .pressy-toc-toggle:hover,\n  .pressy-page-footer--scroll .pressy-settings-toggle:hover {\n    color: var(--color-text, #212529);\n    background: var(--color-bg-subtle, #f8f9fa);\n  }\n\n  .pressy-page-footer--scroll .pressy-settings-panel {\n    overflow: hidden;\n    max-height: 0;\n    opacity: 0;\n    transition: max-height 0.25s ease, opacity 0.2s ease;\n    border-top: 0 solid var(--color-border, #dee2e6);\n  }\n\n  .pressy-page-footer--scroll .pressy-settings-panel--open {\n    max-height: 300px;\n    opacity: 1;\n    border-top-width: 1px;\n    margin-top: 0.5rem;\n    padding-top: 0.75rem;\n  }\n\n  .pressy-page-footer--scroll .pressy-settings-section {\n    margin-bottom: 0.75rem;\n  }\n\n  .pressy-page-footer--scroll .pressy-settings-section:last-child {\n    margin-bottom: 0;\n  }\n\n  .pressy-page-footer--scroll .pressy-settings-label {\n    font-family: var(--font-heading, system-ui, -apple-system, sans-serif);\n    font-size: 0.6875rem;\n    font-weight: 600;\n    text-transform: uppercase;\n    letter-spacing: 0.05em;\n    color: var(--color-text-muted, #6c757d);\n    margin-bottom: 0.5rem;\n    text-align: left;\n  }\n\n  .pressy-page-footer--scroll .pressy-theme-options {\n    display: flex;\n    gap: 0.375rem;\n  }\n\n  .pressy-page-footer--scroll .pressy-theme-btn {\n    flex: 1;\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    gap: 0.25rem;\n    padding: 0.375rem 0.5rem;\n    border: 1.5px solid var(--color-border, #dee2e6);\n    border-radius: 0.5rem;\n    background: transparent;\n    color: var(--color-text, #212529);\n    font-family: var(--font-heading, system-ui, -apple-system, sans-serif);\n    font-size: 0.6875rem;\n    cursor: pointer;\n    transition: border-color 0.15s, background 0.15s;\n  }\n\n  .pressy-page-footer--scroll .pressy-theme-btn:hover {\n    background: var(--color-bg-subtle, #f8f9fa);\n  }\n\n  .pressy-page-footer--scroll .pressy-theme-btn--active {\n    border-color: var(--color-accent, #212529);\n    background: var(--color-bg-subtle, #f8f9fa);\n    font-weight: 600;\n  }\n\n  .pressy-page-footer--scroll .pressy-font-size-controls {\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    gap: 1rem;\n  }\n\n  .pressy-page-footer--scroll .pressy-font-size-btn {\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    width: 2rem;\n    height: 2rem;\n    border: 1.5px solid var(--color-border, #dee2e6);\n    border-radius: 50%;\n    background: transparent;\n    color: var(--color-text, #212529);\n    font-family: var(--font-heading, system-ui, -apple-system, sans-serif);\n    font-size: 0.75rem;\n    font-weight: 600;\n    cursor: pointer;\n    transition: border-color 0.15s, background 0.15s;\n  }\n\n  .pressy-page-footer--scroll .pressy-font-size-btn:hover:not(:disabled) {\n    background: var(--color-bg-subtle, #f8f9fa);\n    border-color: var(--color-accent, #212529);\n  }\n\n  .pressy-page-footer--scroll .pressy-font-size-btn:disabled {\n    opacity: 0.3;\n    cursor: default;\n  }\n\n  .pressy-page-footer--scroll .pressy-font-size-value {\n    font-family: var(--font-heading, system-ui, -apple-system, sans-serif);\n    font-size: 0.8125rem;\n    font-weight: 500;\n    color: var(--color-text, #212529);\n    min-width: 3ch;\n    text-align: center;\n  }\n\n  /* ── TOC drawer for scroll reader ───────────────────────── */\n  .pressy-toc-backdrop--scroll {\n    position: fixed;\n    inset: 0;\n    background: rgba(0, 0, 0, 0.3);\n    z-index: 20;\n    display: flex;\n    align-items: flex-end;\n    animation: pressy-scroll-toc-fade-in 0.2s ease-out;\n  }\n\n  .pressy-toc-backdrop--scroll .pressy-toc-drawer {\n    width: 100%;\n    max-height: 70vh;\n    background: var(--color-bg, #ffffff);\n    border-radius: 1rem 1rem 0 0;\n    display: flex;\n    flex-direction: column;\n    animation: pressy-scroll-toc-slide-up 0.25s ease-out;\n    box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.1);\n  }\n\n  .pressy-toc-backdrop--scroll .pressy-toc-header {\n    display: flex;\n    align-items: center;\n    justify-content: space-between;\n    padding: 1rem 1.5rem 0.75rem;\n    border-bottom: 1px solid var(--color-border, #dee2e6);\n    flex-shrink: 0;\n  }\n\n  .pressy-toc-backdrop--scroll .pressy-toc-title {\n    font-family: var(--font-heading, system-ui, -apple-system, sans-serif);\n    font-size: 1rem;\n    font-weight: 600;\n    color: var(--color-text, #212529);\n  }\n\n  .pressy-toc-backdrop--scroll .pressy-toc-close {\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    width: 2rem;\n    height: 2rem;\n    border: none;\n    background: transparent;\n    color: var(--color-text-muted, #6c757d);\n    cursor: pointer;\n    border-radius: 0.375rem;\n    padding: 0;\n  }\n\n  .pressy-toc-backdrop--scroll .pressy-toc-close:hover {\n    color: var(--color-text, #212529);\n    background: var(--color-bg-subtle, #f8f9fa);\n  }\n\n  .pressy-toc-backdrop--scroll .pressy-toc-list {\n    overflow-y: auto;\n    padding: 0.5rem;\n    display: flex;\n    flex-direction: column;\n  }\n\n  .pressy-toc-backdrop--scroll .pressy-toc-item {\n    display: flex;\n    gap: 0.75rem;\n    padding: 0.625rem 1rem;\n    text-decoration: none;\n    color: var(--color-text, #212529);\n    border-radius: 0.5rem;\n    font-family: var(--font-heading, system-ui, -apple-system, sans-serif);\n    font-size: 0.875rem;\n    transition: background 0.15s;\n  }\n\n  .pressy-toc-backdrop--scroll .pressy-toc-item:hover {\n    background: var(--color-bg-subtle, #f5f5f5);\n  }\n\n  .pressy-toc-backdrop--scroll .pressy-toc-item--active {\n    background: var(--color-bg-subtle, #f5f5f5);\n    font-weight: 600;\n  }\n\n  .pressy-toc-backdrop--scroll .pressy-toc-item-num {\n    color: var(--color-text-muted, #6c757d);\n    min-width: 2ch;\n    text-align: right;\n  }\n\n  .pressy-toc-backdrop--scroll .pressy-toc-item--home {\n    border-bottom: 1px solid var(--color-border, #e5e5e5);\n    margin-bottom: 0.25rem;\n    padding-bottom: 0.75rem;\n  }\n\n  .pressy-toc-backdrop--scroll .pressy-toc-item--home .pressy-toc-item-num {\n    display: flex;\n    align-items: center;\n    justify-content: center;\n  }\n\n  .pressy-toc-backdrop--scroll .pressy-toc-item-title {\n    flex: 1;\n    min-width: 0;\n  }\n\n  @keyframes pressy-scroll-toc-fade-in {\n    from { opacity: 0; }\n    to { opacity: 1; }\n  }\n\n  @keyframes pressy-scroll-toc-slide-up {\n    from { transform: translateY(100%); }\n    to { transform: translateY(0); }\n  }\n\n  /* ── Offline icon for scroll reader ─────────────────────── */\n  .pressy-page-footer--scroll .pressy-offline-icon {\n    flex-shrink: 0;\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    position: relative;\n    width: 2rem;\n    height: 2rem;\n    border: none;\n    background: transparent;\n    color: var(--color-text-muted, #6c757d);\n    cursor: pointer;\n    border-radius: 0.375rem;\n    transition: color 0.15s, background 0.15s;\n    padding: 0;\n  }\n\n  .pressy-page-footer--scroll .pressy-offline-icon:hover {\n    color: var(--color-text, #212529);\n    background: var(--color-bg-subtle, #f8f9fa);\n  }\n\n  .pressy-page-footer--scroll .pressy-offline-icon--cached {\n    color: #16a34a;\n  }\n\n  .pressy-page-footer--scroll .pressy-offline-icon--cached:hover {\n    color: #dc2626;\n  }\n\n  .pressy-page-footer--scroll .pressy-offline-check {\n    position: absolute;\n    bottom: 2px;\n    right: 2px;\n  }\n\n  .pressy-page-footer--scroll .pressy-offline-icon--downloading {\n    cursor: default;\n  }\n\n  @media (prefers-reduced-motion: reduce) {\n    .pressy-page-footer--scroll {\n      transition: none;\n    }\n    .pressy-toc-backdrop--scroll,\n    .pressy-toc-backdrop--scroll .pressy-toc-drawer {\n      animation: none;\n    }\n  }\n`;\n\nconst PAGINATED_STYLES = `\n  html:has(.pressy-reader--paginated) body {\n    margin: 0;\n  }\n\n  .pressy-reader--paginated {\n    height: 100vh;\n    height: 100dvh;\n    display: flex;\n    flex-direction: column;\n    overflow: hidden;\n    position: relative;\n  }\n\n  /* Viewport clips overflow and shows one page at a time.\n     Vertical padding gives consistent top/bottom margins on every page. */\n  .pressy-paginated-viewport {\n    flex: 1;\n    overflow: hidden;\n    position: relative;\n    min-height: 0;\n    padding-block: 2rem;\n    box-sizing: border-box;\n    text-wrap: pretty;\n  }\n\n  /* Article uses CSS multi-column layout for pagination.\n     column-width is set dynamically via JS to match viewport width.\n     Each column = one \"page\". Content overflows horizontally into new columns.\n     translateX controlled by JS — transitions set dynamically during drag vs snap. */\n  .pressy-prose--paginated {\n    max-width: none;\n    height: 100%;\n    column-fill: auto;\n    column-gap: 0;\n    overflow: visible;\n    box-sizing: border-box;\n    padding: 0;\n    will-change: transform;\n    /* Transition is set dynamically: none during drag, ease-out on snap */\n  }\n\n  /* Center content elements within each column/page at a readable width */\n  .pressy-prose--paginated > * {\n    max-width: min(65ch, calc(100% - 3rem));\n    margin-left: auto;\n    margin-right: auto;\n  }\n\n  /* Preserve vertical margins from prose styles */\n  .pressy-prose--paginated > h1,\n  .pressy-prose--paginated > h2,\n  .pressy-prose--paginated > h3,\n  .pressy-prose--paginated > h4 {\n    max-width: min(65ch, calc(100% - 3rem));\n    margin-left: auto;\n    margin-right: auto;\n  }\n\n  /* ── Navigation arrows ────────────────────────────────────── */\n  /* Hover-triggered arrows on left/right edges for desktop navigation */\n  .pressy-nav-arrow {\n    position: absolute;\n    top: 50%;\n    transform: translateY(-50%);\n    width: 2.5rem;\n    height: 2.5rem;\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    color: var(--color-text-muted, #6c757d);\n    opacity: 0;\n    transition: opacity 0.2s ease;\n    pointer-events: none;\n    z-index: 5;\n  }\n\n  .pressy-nav-arrow svg {\n    width: 1.5rem;\n    height: 1.5rem;\n  }\n\n  .pressy-nav-arrow--prev {\n    left: 0.75rem;\n  }\n\n  .pressy-nav-arrow--next {\n    right: 0.75rem;\n  }\n\n  .pressy-nav-arrow--visible {\n    opacity: 0.4;\n  }\n\n  /* Hide on touch devices — swipe handles navigation there */\n  @media (hover: none) {\n    .pressy-nav-arrow {\n      display: none;\n    }\n  }\n\n  /* ── Chapter boundary hints ─────────────────────────────── */\n  /* Shown when overscrolling past first/last page of a chapter */\n  .pressy-chapter-hint {\n    position: absolute;\n    top: 50%;\n    transform: translateY(-50%);\n    display: flex;\n    align-items: center;\n    gap: 0.5rem;\n    padding: 0.75rem 1.25rem;\n    background: var(--color-bg-subtle, #f5f5f5);\n    border: 1px solid var(--color-border, #dee2e6);\n    border-radius: 0.75rem;\n    font-family: var(--font-heading, system-ui, -apple-system, sans-serif);\n    font-size: var(--font-size-sm, 0.875rem);\n    color: var(--color-text-muted, #6c757d);\n    z-index: 20;\n    pointer-events: none;\n    animation: pressy-hint-fade-in 0.15s ease-out;\n    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);\n    max-width: 60%;\n    white-space: nowrap;\n    overflow: hidden;\n    text-overflow: ellipsis;\n  }\n\n  .pressy-chapter-hint--prev {\n    left: 1rem;\n  }\n\n  .pressy-chapter-hint--next {\n    right: 1rem;\n  }\n\n  .pressy-chapter-hint-arrow {\n    flex-shrink: 0;\n    font-size: 1rem;\n    opacity: 0.6;\n  }\n\n  .pressy-chapter-hint-text {\n    overflow: hidden;\n    text-overflow: ellipsis;\n  }\n\n  @keyframes pressy-hint-fade-in {\n    from { opacity: 0; transform: translateY(-50%) scale(0.95); }\n    to { opacity: 1; transform: translateY(-50%) scale(1); }\n  }\n\n  /* ── Page footer ───────────────────────────────────────────── */\n  .pressy-page-footer {\n    position: fixed;\n    bottom: 0;\n    left: 0;\n    right: 0;\n    padding: 0.5rem 1.5rem calc(1rem + env(safe-area-inset-bottom, 0px));\n    text-align: center;\n    user-select: none;\n    transform: translateY(100%);\n    opacity: 0;\n    transition: transform 0.25s ease, opacity 0.25s ease;\n    z-index: 15;\n    background: var(--color-bg, #ffffff);\n  }\n\n  .pressy-page-footer--visible {\n    transform: translateY(0);\n    opacity: 1;\n  }\n\n  /* Progress bar */\n  .pressy-progress-bar {\n    height: 3px;\n    background: var(--color-border, #dee2e6);\n    border-radius: 1.5px;\n    overflow: hidden;\n  }\n\n  .pressy-progress-fill {\n    height: 100%;\n    background: var(--color-accent, #212529);\n    border-radius: 1.5px;\n    transition: width 0.3s ease;\n  }\n\n  /* ── Footer row (title + gear) ──────────────────────────── */\n  .pressy-footer-row {\n    display: flex;\n    align-items: center;\n    justify-content: space-between;\n    margin-top: 0.5rem;\n    gap: 0.5rem;\n  }\n\n  .pressy-footer-title {\n    font-family: var(--font-heading, system-ui, -apple-system, sans-serif);\n    font-size: 0.75rem;\n    color: var(--color-text-muted, #6c757d);\n    text-decoration: none;\n    overflow: hidden;\n    text-overflow: ellipsis;\n    white-space: nowrap;\n    min-width: 0;\n    flex: 1;\n    text-align: left;\n    border: none;\n    background: none;\n    cursor: pointer;\n    padding: 0;\n  }\n\n  .pressy-footer-title:hover {\n    color: var(--color-text, #212529);\n  }\n\n  /* ── TOC toggle button ──────────────────────────────────── */\n  .pressy-toc-toggle {\n    flex-shrink: 0;\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    width: 2rem;\n    height: 2rem;\n    border: none;\n    background: transparent;\n    color: var(--color-text-muted, #6c757d);\n    cursor: pointer;\n    border-radius: 0.375rem;\n    transition: color 0.15s, background 0.15s;\n    padding: 0;\n  }\n\n  .pressy-toc-toggle:hover {\n    color: var(--color-text, #212529);\n    background: var(--color-bg-subtle, #f8f9fa);\n  }\n\n  .pressy-settings-toggle {\n    flex-shrink: 0;\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    width: 2rem;\n    height: 2rem;\n    border: none;\n    background: transparent;\n    color: var(--color-text-muted, #6c757d);\n    cursor: pointer;\n    border-radius: 0.375rem;\n    transition: color 0.15s, background 0.15s;\n    padding: 0;\n  }\n\n  .pressy-settings-toggle:hover {\n    color: var(--color-text, #212529);\n    background: var(--color-bg-subtle, #f8f9fa);\n  }\n\n  /* ── Settings panel ────────────────────────────────────── */\n  .pressy-settings-panel {\n    overflow: hidden;\n    max-height: 0;\n    opacity: 0;\n    transition: max-height 0.25s ease, opacity 0.2s ease;\n    border-top: 0 solid var(--color-border, #dee2e6);\n  }\n\n  .pressy-settings-panel--open {\n    max-height: 300px;\n    opacity: 1;\n    border-top-width: 1px;\n    margin-top: 0.5rem;\n    padding-top: 0.75rem;\n  }\n\n  .pressy-settings-section {\n    margin-bottom: 0.75rem;\n  }\n\n  .pressy-settings-section:last-child {\n    margin-bottom: 0;\n  }\n\n  .pressy-settings-label {\n    font-family: var(--font-heading, system-ui, -apple-system, sans-serif);\n    font-size: 0.6875rem;\n    font-weight: 600;\n    text-transform: uppercase;\n    letter-spacing: 0.05em;\n    color: var(--color-text-muted, #6c757d);\n    margin-bottom: 0.5rem;\n    text-align: left;\n  }\n\n  .pressy-theme-options {\n    display: flex;\n    gap: 0.375rem;\n  }\n\n  .pressy-theme-btn {\n    flex: 1;\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    gap: 0.25rem;\n    padding: 0.375rem 0.5rem;\n    border: 1.5px solid var(--color-border, #dee2e6);\n    border-radius: 0.5rem;\n    background: transparent;\n    color: var(--color-text, #212529);\n    font-family: var(--font-heading, system-ui, -apple-system, sans-serif);\n    font-size: 0.6875rem;\n    cursor: pointer;\n    transition: border-color 0.15s, background 0.15s;\n  }\n\n  .pressy-theme-btn:hover {\n    background: var(--color-bg-subtle, #f8f9fa);\n  }\n\n  .pressy-theme-btn--active {\n    border-color: var(--color-accent, #212529);\n    background: var(--color-bg-subtle, #f8f9fa);\n    font-weight: 600;\n  }\n\n  .pressy-font-size-controls {\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    gap: 1rem;\n  }\n\n  .pressy-font-size-btn {\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    width: 2rem;\n    height: 2rem;\n    border: 1.5px solid var(--color-border, #dee2e6);\n    border-radius: 50%;\n    background: transparent;\n    color: var(--color-text, #212529);\n    font-family: var(--font-heading, system-ui, -apple-system, sans-serif);\n    font-size: 0.75rem;\n    font-weight: 600;\n    cursor: pointer;\n    transition: border-color 0.15s, background 0.15s;\n  }\n\n  .pressy-font-size-btn:hover:not(:disabled) {\n    background: var(--color-bg-subtle, #f8f9fa);\n    border-color: var(--color-accent, #212529);\n  }\n\n  .pressy-font-size-btn:disabled {\n    opacity: 0.3;\n    cursor: default;\n  }\n\n  .pressy-font-size-value {\n    font-family: var(--font-heading, system-ui, -apple-system, sans-serif);\n    font-size: 0.8125rem;\n    font-weight: 500;\n    color: var(--color-text, #212529);\n    min-width: 3ch;\n    text-align: center;\n  }\n\n  /* ── Chapter sections ─────────────────────────────────── */\n  .pressy-chapter-section + .pressy-chapter-section {\n    break-before: column;\n  }\n\n  .pressy-chapter-divider {\n    padding: 0;\n    margin: 0;\n  }\n\n  .pressy-chapter-divider-title {\n    font-size: 1.5rem;\n    font-family: var(--font-heading, system-ui, -apple-system, sans-serif);\n    margin: 0;\n  }\n\n  /* ── TOC drawer ──────────────────────────────────────────── */\n  .pressy-toc-backdrop {\n    position: absolute;\n    inset: 0;\n    background: rgba(0, 0, 0, 0.3);\n    z-index: 20;\n    display: flex;\n    align-items: flex-end;\n    animation: pressy-toc-fade-in 0.2s ease-out;\n  }\n\n  .pressy-toc-drawer {\n    width: 100%;\n    max-height: 70vh;\n    background: var(--color-bg, #ffffff);\n    border-radius: 1rem 1rem 0 0;\n    display: flex;\n    flex-direction: column;\n    animation: pressy-toc-slide-up 0.25s ease-out;\n    box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.1);\n  }\n\n  .pressy-toc-header {\n    display: flex;\n    align-items: center;\n    justify-content: space-between;\n    padding: 1rem 1.5rem 0.75rem;\n    border-bottom: 1px solid var(--color-border, #dee2e6);\n    flex-shrink: 0;\n  }\n\n  .pressy-toc-title {\n    font-family: var(--font-heading, system-ui, -apple-system, sans-serif);\n    font-size: 1rem;\n    font-weight: 600;\n    color: var(--color-text, #212529);\n  }\n\n  .pressy-toc-close {\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    width: 2rem;\n    height: 2rem;\n    border: none;\n    background: transparent;\n    color: var(--color-text-muted, #6c757d);\n    cursor: pointer;\n    border-radius: 0.375rem;\n    padding: 0;\n  }\n\n  .pressy-toc-close:hover {\n    color: var(--color-text, #212529);\n    background: var(--color-bg-subtle, #f8f9fa);\n  }\n\n  .pressy-toc-list {\n    overflow-y: auto;\n    padding: 0.5rem;\n    display: flex;\n    flex-direction: column;\n  }\n\n  .pressy-toc-item {\n    display: flex;\n    gap: 0.75rem;\n    padding: 0.625rem 1rem;\n    text-decoration: none;\n    color: var(--color-text, #212529);\n    border-radius: 0.5rem;\n    font-family: var(--font-heading, system-ui, -apple-system, sans-serif);\n    font-size: 0.875rem;\n    transition: background 0.15s;\n  }\n\n  .pressy-toc-item:hover {\n    background: var(--color-bg-subtle, #f5f5f5);\n  }\n\n  .pressy-toc-item--active {\n    background: var(--color-bg-subtle, #f5f5f5);\n    font-weight: 600;\n  }\n\n  .pressy-toc-item-num {\n    color: var(--color-text-muted, #6c757d);\n    min-width: 2ch;\n    text-align: right;\n  }\n\n  .pressy-toc-item--home {\n    border-bottom: 1px solid var(--color-border, #e5e5e5);\n    margin-bottom: 0.25rem;\n    padding-bottom: 0.75rem;\n  }\n\n  .pressy-toc-item--home .pressy-toc-item-num {\n    display: flex;\n    align-items: center;\n    justify-content: center;\n  }\n\n  .pressy-toc-item-title {\n    flex: 1;\n    min-width: 0;\n  }\n\n  @keyframes pressy-toc-fade-in {\n    from { opacity: 0; }\n    to { opacity: 1; }\n  }\n\n  @keyframes pressy-toc-slide-up {\n    from { transform: translateY(100%); }\n    to { transform: translateY(0); }\n  }\n\n  /* ── Offline footer icon ────────────────────────────────── */\n  .pressy-offline-icon {\n    flex-shrink: 0;\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    position: relative;\n    width: 2rem;\n    height: 2rem;\n    border: none;\n    background: transparent;\n    color: var(--color-text-muted, #6c757d);\n    cursor: pointer;\n    border-radius: 0.375rem;\n    transition: color 0.15s, background 0.15s;\n    padding: 0;\n  }\n\n  .pressy-offline-icon:hover {\n    color: var(--color-text, #212529);\n    background: var(--color-bg-subtle, #f8f9fa);\n  }\n\n  .pressy-offline-icon--cached {\n    color: #16a34a;\n  }\n\n  .pressy-offline-icon--cached:hover {\n    color: #dc2626;\n  }\n\n  .pressy-offline-check {\n    position: absolute;\n    bottom: 2px;\n    right: 2px;\n  }\n\n  .pressy-offline-icon--downloading {\n    cursor: default;\n  }\n\n  @keyframes pressy-offline-spin {\n    from { transform: rotate(0deg); }\n    to { transform: rotate(360deg); }\n  }\n\n  .pressy-offline-spinner {\n    animation: pressy-offline-spin 1s linear infinite;\n    transform-origin: 12px 12px;\n  }\n\n  /* ── Reduced motion preference ────────────────────────────\n     Disable page turn animations for users who prefer reduced motion. */\n  @media (prefers-reduced-motion: reduce) {\n    .pressy-prose--paginated {\n      transition: none !important;\n    }\n    .pressy-progress-fill {\n      transition: none !important;\n    }\n    .pressy-toc-backdrop,\n    .pressy-toc-drawer {\n      animation: none;\n    }\n    .pressy-offline-spinner {\n      animation: none;\n    }\n  }\n`;\n","structuredPatch":[{"oldStart":2089,"oldLines":7,"newStart":2089,"newLines":7,"lines":["     bottom: 0;","     left: 0;","     right: 0;","-    padding: 0.5rem 1.5rem 1rem;","+    padding: 0.5rem 1.5rem calc(1rem + env(safe-area-inset-bottom, 0px));","     text-align: center;","     user-select: none;","     transform: translateY(100%);"]}],"userModified":false,"replaceAll":false},"sourceToolAssistantUUID":"8f42cb07-d900-43a5-81d2-9ddbe936a8fa"}
{"parentUuid":"eb6cf61c-3550-4097-b730-9c199b42e2ca","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","message":{"model":"claude-opus-4-6","id":"msg_01BDJSYyKdEUXAGSnafoPXhV","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_016bfPTuCDHidd9VArZGdp8Q","name":"Bash","input":{"command":"pnpm --filter @pressy-pub/components build 2>&1 && pnpm --filter pressy build 2>&1","description":"Build both packages","timeout":60000},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":411,"cache_read_input_tokens":81447,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":411},"output_tokens":26,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CYAub1LxF8qxfiZ1qHiZQ","type":"assistant","uuid":"6c98dd38-364c-465f-83e9-446dc0cfb734","timestamp":"2026-02-16T01:49:12.251Z"}
{"parentUuid":"6c98dd38-364c-465f-83e9-446dc0cfb734","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","type":"progress","data":{"type":"bash_progress","output":"ESM dist/index.js             125.29 KB\nESM dist/content/index.js.map 14.22 KB\nESM dist/index.js.map         182.82 KB\nESM ⚡️ Build success in 15ms\nDTS Build start","fullOutput":"> @pressy-pub/components@0.1.1 build /Users/blittle/dev/pressy/packages/@pressy/components\n> tsup\nCLI Building entry: {\"index\":\"src/index.ts\",\"content/index\":\"src/content/index.ts\"}\nCLI Using tsconfig: tsconfig.json\nCLI tsup v8.5.1\nCLI Using tsup config: /Users/blittle/dev/pressy/packages/@pressy/components/tsup.config.ts\nCLI Target: es2022\nCLI Cleaning output folder\nESM Build start\nESM dist/content/index.js     9.84 KB\nESM dist/index.js             125.29 KB\nESM dist/content/index.js.map 14.22 KB\nESM dist/index.js.map         182.82 KB\nESM ⚡️ Build success in 15ms\nDTS Build start","elapsedTimeSeconds":2,"totalLines":15,"timeoutMs":60000},"toolUseID":"bash-progress-0","parentToolUseID":"toolu_016bfPTuCDHidd9VArZGdp8Q","uuid":"571b7381-a05c-477e-9778-5415781f3bf6","timestamp":"2026-02-16T01:49:14.257Z"}
{"parentUuid":"571b7381-a05c-477e-9778-5415781f3bf6","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","type":"progress","data":{"type":"bash_progress","output":"ESM dist/index.js             125.29 KB\nESM dist/content/index.js.map 14.22 KB\nESM dist/index.js.map         182.82 KB\nESM ⚡️ Build success in 15ms\nDTS Build start","fullOutput":"> @pressy-pub/components@0.1.1 build /Users/blittle/dev/pressy/packages/@pressy/components\n> tsup\nCLI Building entry: {\"index\":\"src/index.ts\",\"content/index\":\"src/content/index.ts\"}\nCLI Using tsconfig: tsconfig.json\nCLI tsup v8.5.1\nCLI Using tsup config: /Users/blittle/dev/pressy/packages/@pressy/components/tsup.config.ts\nCLI Target: es2022\nCLI Cleaning output folder\nESM Build start\nESM dist/content/index.js     9.84 KB\nESM dist/index.js             125.29 KB\nESM dist/content/index.js.map 14.22 KB\nESM dist/index.js.map         182.82 KB\nESM ⚡️ Build success in 15ms\nDTS Build start","elapsedTimeSeconds":3,"totalLines":15,"timeoutMs":60000},"toolUseID":"bash-progress-1","parentToolUseID":"toolu_016bfPTuCDHidd9VArZGdp8Q","uuid":"f7f2ea38-7faf-465f-bd87-93e0d8b08229","timestamp":"2026-02-16T01:49:15.258Z"}
{"parentUuid":"f7f2ea38-7faf-465f-bd87-93e0d8b08229","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","type":"progress","data":{"type":"bash_progress","output":"ESM dist/vite/plugin.js.map     52.96 KB\nESM dist/runtime/client.js.map  48.96 KB\nESM dist/runtime/offline.js.map 10.20 KB\nESM dist/runtime/sw.js.map      8.29 KB\nESM ⚡️ Build success in 17ms","fullOutput":"> @pressy-pub/components@0.1.1 build /Users/blittle/dev/pressy/packages/@pressy/components\n> tsup\nCLI Building entry: {\"index\":\"src/index.ts\",\"content/index\":\"src/content/index.ts\"}\nCLI Using tsconfig: tsconfig.json\nCLI tsup v8.5.1\nCLI Using tsup config: /Users/blittle/dev/pressy/packages/@pressy/components/tsup.config.ts\nCLI Target: es2022\nCLI Cleaning output folder\nESM Build start\nESM dist/content/index.js     9.84 KB\nESM dist/index.js             125.29 KB\nESM dist/content/index.js.map 14.22 KB\nESM dist/index.js.map         182.82 KB\nESM ⚡️ Build success in 15ms\nDTS Build start\nDTS ⚡️ Build success in 1887ms\nDTS dist/index.d.ts         4.59 KB\nDTS dist/content/index.d.ts 1.29 KB\n> pressy@0.1.1 build /Users/blittle/dev/pressy/packages/pressy\n> tsup\nCLI Building entry: {\"index\":\"src/index.ts\",\"cli/index\":\"src/cli/index.ts\",\"vite/plugin\":\"src/vite/plugin.ts\",\"runtime/client\":\"src/runtime/client.tsx\",\"runtime/offline\":\"src/runtime/offline.ts\",\"runtime/sw\":\"src/runtime/sw.ts\"}\nCLI Using tsconfig: tsconfig.json\nCLI tsup v8.5.1\nCLI Using tsup config: /Users/blittle/dev/pressy/packages/pressy/tsup.config.ts\nCLI Target: node18\nCLI Cleaning output folder\nESM Build start\nESM dist/cli/index.js           32.92 KB\nESM dist/index.js               30.25 KB\nESM dist/vite/plugin.js         29.94 KB\nESM dist/runtime/client.js      28.38 KB\nESM dist/runtime/offline.js     5.52 KB\nESM dist/runtime/sw.js          4.09 KB\nESM dist/cli/index.js.map       58.66 KB\nESM dist/index.js.map           54.88 KB\nESM dist/vite/plugin.js.map     52.96 KB\nESM dist/runtime/client.js.map  48.96 KB\nESM dist/runtime/offline.js.map 10.20 KB\nESM dist/runtime/sw.js.map      8.29 KB\nESM ⚡️ Build success in 17ms","elapsedTimeSeconds":4,"totalLines":40,"timeoutMs":60000},"toolUseID":"bash-progress-2","parentToolUseID":"toolu_016bfPTuCDHidd9VArZGdp8Q","uuid":"3eff4bf2-3be0-442a-87e1-8255168898ea","timestamp":"2026-02-16T01:49:16.259Z"}
{"parentUuid":"3eff4bf2-3be0-442a-87e1-8255168898ea","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","type":"progress","data":{"type":"bash_progress","output":"ESM dist/runtime/client.js.map  48.96 KB\nESM dist/runtime/offline.js.map 10.20 KB\nESM dist/runtime/sw.js.map      8.29 KB\nESM ⚡️ Build success in 17ms\nDTS Build start","fullOutput":"> @pressy-pub/components@0.1.1 build /Users/blittle/dev/pressy/packages/@pressy/components\n> tsup\nCLI Building entry: {\"index\":\"src/index.ts\",\"content/index\":\"src/content/index.ts\"}\nCLI Using tsconfig: tsconfig.json\nCLI tsup v8.5.1\nCLI Using tsup config: /Users/blittle/dev/pressy/packages/@pressy/components/tsup.config.ts\nCLI Target: es2022\nCLI Cleaning output folder\nESM Build start\nESM dist/content/index.js     9.84 KB\nESM dist/index.js             125.29 KB\nESM dist/content/index.js.map 14.22 KB\nESM dist/index.js.map         182.82 KB\nESM ⚡️ Build success in 15ms\nDTS Build start\nDTS ⚡️ Build success in 1887ms\nDTS dist/index.d.ts         4.59 KB\nDTS dist/content/index.d.ts 1.29 KB\n> pressy@0.1.1 build /Users/blittle/dev/pressy/packages/pressy\n> tsup\nCLI Building entry: {\"index\":\"src/index.ts\",\"cli/index\":\"src/cli/index.ts\",\"vite/plugin\":\"src/vite/plugin.ts\",\"runtime/client\":\"src/runtime/client.tsx\",\"runtime/offline\":\"src/runtime/offline.ts\",\"runtime/sw\":\"src/runtime/sw.ts\"}\nCLI Using tsconfig: tsconfig.json\nCLI tsup v8.5.1\nCLI Using tsup config: /Users/blittle/dev/pressy/packages/pressy/tsup.config.ts\nCLI Target: node18\nCLI Cleaning output folder\nESM Build start\nESM dist/cli/index.js           32.92 KB\nESM dist/index.js               30.25 KB\nESM dist/vite/plugin.js         29.94 KB\nESM dist/runtime/client.js      28.38 KB\nESM dist/runtime/offline.js     5.52 KB\nESM dist/runtime/sw.js          4.09 KB\nESM dist/cli/index.js.map       58.66 KB\nESM dist/index.js.map           54.88 KB\nESM dist/vite/plugin.js.map     52.96 KB\nESM dist/runtime/client.js.map  48.96 KB\nESM dist/runtime/offline.js.map 10.20 KB\nESM dist/runtime/sw.js.map      8.29 KB\nESM ⚡️ Build success in 17ms\nDTS Build start","elapsedTimeSeconds":5,"totalLines":41,"timeoutMs":60000},"toolUseID":"bash-progress-3","parentToolUseID":"toolu_016bfPTuCDHidd9VArZGdp8Q","uuid":"b7704a01-9ebc-46b6-a321-5ac36869db30","timestamp":"2026-02-16T01:49:17.260Z"}
{"parentUuid":"b7704a01-9ebc-46b6-a321-5ac36869db30","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","type":"progress","data":{"type":"bash_progress","output":"ESM dist/runtime/client.js.map  48.96 KB\nESM dist/runtime/offline.js.map 10.20 KB\nESM dist/runtime/sw.js.map      8.29 KB\nESM ⚡️ Build success in 17ms\nDTS Build start","fullOutput":"> @pressy-pub/components@0.1.1 build /Users/blittle/dev/pressy/packages/@pressy/components\n> tsup\nCLI Building entry: {\"index\":\"src/index.ts\",\"content/index\":\"src/content/index.ts\"}\nCLI Using tsconfig: tsconfig.json\nCLI tsup v8.5.1\nCLI Using tsup config: /Users/blittle/dev/pressy/packages/@pressy/components/tsup.config.ts\nCLI Target: es2022\nCLI Cleaning output folder\nESM Build start\nESM dist/content/index.js     9.84 KB\nESM dist/index.js             125.29 KB\nESM dist/content/index.js.map 14.22 KB\nESM dist/index.js.map         182.82 KB\nESM ⚡️ Build success in 15ms\nDTS Build start\nDTS ⚡️ Build success in 1887ms\nDTS dist/index.d.ts         4.59 KB\nDTS dist/content/index.d.ts 1.29 KB\n> pressy@0.1.1 build /Users/blittle/dev/pressy/packages/pressy\n> tsup\nCLI Building entry: {\"index\":\"src/index.ts\",\"cli/index\":\"src/cli/index.ts\",\"vite/plugin\":\"src/vite/plugin.ts\",\"runtime/client\":\"src/runtime/client.tsx\",\"runtime/offline\":\"src/runtime/offline.ts\",\"runtime/sw\":\"src/runtime/sw.ts\"}\nCLI Using tsconfig: tsconfig.json\nCLI tsup v8.5.1\nCLI Using tsup config: /Users/blittle/dev/pressy/packages/pressy/tsup.config.ts\nCLI Target: node18\nCLI Cleaning output folder\nESM Build start\nESM dist/cli/index.js           32.92 KB\nESM dist/index.js               30.25 KB\nESM dist/vite/plugin.js         29.94 KB\nESM dist/runtime/client.js      28.38 KB\nESM dist/runtime/offline.js     5.52 KB\nESM dist/runtime/sw.js          4.09 KB\nESM dist/cli/index.js.map       58.66 KB\nESM dist/index.js.map           54.88 KB\nESM dist/vite/plugin.js.map     52.96 KB\nESM dist/runtime/client.js.map  48.96 KB\nESM dist/runtime/offline.js.map 10.20 KB\nESM dist/runtime/sw.js.map      8.29 KB\nESM ⚡️ Build success in 17ms\nDTS Build start","elapsedTimeSeconds":6,"totalLines":41,"timeoutMs":60000},"toolUseID":"bash-progress-4","parentToolUseID":"toolu_016bfPTuCDHidd9VArZGdp8Q","uuid":"d798f2fd-c479-41d6-bc29-50b3011a6ee1","timestamp":"2026-02-16T01:49:18.260Z"}
{"parentUuid":"d798f2fd-c479-41d6-bc29-50b3011a6ee1","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","type":"progress","data":{"type":"bash_progress","output":"ESM dist/runtime/client.js.map  48.96 KB\nESM dist/runtime/offline.js.map 10.20 KB\nESM dist/runtime/sw.js.map      8.29 KB\nESM ⚡️ Build success in 17ms\nDTS Build start","fullOutput":"> @pressy-pub/components@0.1.1 build /Users/blittle/dev/pressy/packages/@pressy/components\n> tsup\nCLI Building entry: {\"index\":\"src/index.ts\",\"content/index\":\"src/content/index.ts\"}\nCLI Using tsconfig: tsconfig.json\nCLI tsup v8.5.1\nCLI Using tsup config: /Users/blittle/dev/pressy/packages/@pressy/components/tsup.config.ts\nCLI Target: es2022\nCLI Cleaning output folder\nESM Build start\nESM dist/content/index.js     9.84 KB\nESM dist/index.js             125.29 KB\nESM dist/content/index.js.map 14.22 KB\nESM dist/index.js.map         182.82 KB\nESM ⚡️ Build success in 15ms\nDTS Build start\nDTS ⚡️ Build success in 1887ms\nDTS dist/index.d.ts         4.59 KB\nDTS dist/content/index.d.ts 1.29 KB\n> pressy@0.1.1 build /Users/blittle/dev/pressy/packages/pressy\n> tsup\nCLI Building entry: {\"index\":\"src/index.ts\",\"cli/index\":\"src/cli/index.ts\",\"vite/plugin\":\"src/vite/plugin.ts\",\"runtime/client\":\"src/runtime/client.tsx\",\"runtime/offline\":\"src/runtime/offline.ts\",\"runtime/sw\":\"src/runtime/sw.ts\"}\nCLI Using tsconfig: tsconfig.json\nCLI tsup v8.5.1\nCLI Using tsup config: /Users/blittle/dev/pressy/packages/pressy/tsup.config.ts\nCLI Target: node18\nCLI Cleaning output folder\nESM Build start\nESM dist/cli/index.js           32.92 KB\nESM dist/index.js               30.25 KB\nESM dist/vite/plugin.js         29.94 KB\nESM dist/runtime/client.js      28.38 KB\nESM dist/runtime/offline.js     5.52 KB\nESM dist/runtime/sw.js          4.09 KB\nESM dist/cli/index.js.map       58.66 KB\nESM dist/index.js.map           54.88 KB\nESM dist/vite/plugin.js.map     52.96 KB\nESM dist/runtime/client.js.map  48.96 KB\nESM dist/runtime/offline.js.map 10.20 KB\nESM dist/runtime/sw.js.map      8.29 KB\nESM ⚡️ Build success in 17ms\nDTS Build start","elapsedTimeSeconds":7,"totalLines":41,"timeoutMs":60000},"toolUseID":"bash-progress-5","parentToolUseID":"toolu_016bfPTuCDHidd9VArZGdp8Q","uuid":"6cd773e0-1e6e-4ca9-b058-27bdebe66f58","timestamp":"2026-02-16T01:49:19.260Z"}
{"parentUuid":"6c98dd38-364c-465f-83e9-446dc0cfb734","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_016bfPTuCDHidd9VArZGdp8Q","type":"tool_result","content":"> @pressy-pub/components@0.1.1 build /Users/blittle/dev/pressy/packages/@pressy/components\n> tsup\n\nCLI Building entry: {\"index\":\"src/index.ts\",\"content/index\":\"src/content/index.ts\"}\nCLI Using tsconfig: tsconfig.json\nCLI tsup v8.5.1\nCLI Using tsup config: /Users/blittle/dev/pressy/packages/@pressy/components/tsup.config.ts\nCLI Target: es2022\nCLI Cleaning output folder\nESM Build start\nESM dist/content/index.js     9.84 KB\nESM dist/index.js             125.29 KB\nESM dist/content/index.js.map 14.22 KB\nESM dist/index.js.map         182.82 KB\nESM ⚡️ Build success in 15ms\nDTS Build start\nDTS ⚡️ Build success in 1887ms\nDTS dist/index.d.ts         4.59 KB\nDTS dist/content/index.d.ts 1.29 KB\n\n> pressy@0.1.1 build /Users/blittle/dev/pressy/packages/pressy\n> tsup\n\nCLI Building entry: {\"index\":\"src/index.ts\",\"cli/index\":\"src/cli/index.ts\",\"vite/plugin\":\"src/vite/plugin.ts\",\"runtime/client\":\"src/runtime/client.tsx\",\"runtime/offline\":\"src/runtime/offline.ts\",\"runtime/sw\":\"src/runtime/sw.ts\"}\nCLI Using tsconfig: tsconfig.json\nCLI tsup v8.5.1\nCLI Using tsup config: /Users/blittle/dev/pressy/packages/pressy/tsup.config.ts\nCLI Target: node18\nCLI Cleaning output folder\nESM Build start\nESM dist/cli/index.js           32.92 KB\nESM dist/index.js               30.25 KB\nESM dist/vite/plugin.js         29.94 KB\nESM dist/runtime/client.js      28.38 KB\nESM dist/runtime/offline.js     5.52 KB\nESM dist/runtime/sw.js          4.09 KB\nESM dist/cli/index.js.map       58.66 KB\nESM dist/index.js.map           54.88 KB\nESM dist/vite/plugin.js.map     52.96 KB\nESM dist/runtime/client.js.map  48.96 KB\nESM dist/runtime/offline.js.map 10.20 KB\nESM dist/runtime/sw.js.map      8.29 KB\nESM ⚡️ Build success in 17ms\nDTS Build start\nDTS ⚡️ Build success in 2986ms\nDTS dist/index.d.ts           329.00 B\nDTS dist/cli/index.d.ts       20.00 B\nDTS dist/vite/plugin.d.ts     180.00 B\nDTS dist/runtime/client.d.ts  1.43 KB\nDTS dist/runtime/offline.d.ts 1.12 KB\nDTS dist/runtime/sw.d.ts      13.00 B\nDTS dist/types-DtFj4lcD.d.ts  1.62 KB\nDTS dist/config-M8fI46fg.d.ts 1.56 KB","is_error":false}]},"uuid":"e5319de0-2799-44f8-8c04-2cf22d3560b8","timestamp":"2026-02-16T01:49:19.311Z","toolUseResult":{"stdout":"> @pressy-pub/components@0.1.1 build /Users/blittle/dev/pressy/packages/@pressy/components\n> tsup\n\nCLI Building entry: {\"index\":\"src/index.ts\",\"content/index\":\"src/content/index.ts\"}\nCLI Using tsconfig: tsconfig.json\nCLI tsup v8.5.1\nCLI Using tsup config: /Users/blittle/dev/pressy/packages/@pressy/components/tsup.config.ts\nCLI Target: es2022\nCLI Cleaning output folder\nESM Build start\nESM dist/content/index.js     9.84 KB\nESM dist/index.js             125.29 KB\nESM dist/content/index.js.map 14.22 KB\nESM dist/index.js.map         182.82 KB\nESM ⚡️ Build success in 15ms\nDTS Build start\nDTS ⚡️ Build success in 1887ms\nDTS dist/index.d.ts         4.59 KB\nDTS dist/content/index.d.ts 1.29 KB\n\n> pressy@0.1.1 build /Users/blittle/dev/pressy/packages/pressy\n> tsup\n\nCLI Building entry: {\"index\":\"src/index.ts\",\"cli/index\":\"src/cli/index.ts\",\"vite/plugin\":\"src/vite/plugin.ts\",\"runtime/client\":\"src/runtime/client.tsx\",\"runtime/offline\":\"src/runtime/offline.ts\",\"runtime/sw\":\"src/runtime/sw.ts\"}\nCLI Using tsconfig: tsconfig.json\nCLI tsup v8.5.1\nCLI Using tsup config: /Users/blittle/dev/pressy/packages/pressy/tsup.config.ts\nCLI Target: node18\nCLI Cleaning output folder\nESM Build start\nESM dist/cli/index.js           32.92 KB\nESM dist/index.js               30.25 KB\nESM dist/vite/plugin.js         29.94 KB\nESM dist/runtime/client.js      28.38 KB\nESM dist/runtime/offline.js     5.52 KB\nESM dist/runtime/sw.js          4.09 KB\nESM dist/cli/index.js.map       58.66 KB\nESM dist/index.js.map           54.88 KB\nESM dist/vite/plugin.js.map     52.96 KB\nESM dist/runtime/client.js.map  48.96 KB\nESM dist/runtime/offline.js.map 10.20 KB\nESM dist/runtime/sw.js.map      8.29 KB\nESM ⚡️ Build success in 17ms\nDTS Build start\nDTS ⚡️ Build success in 2986ms\nDTS dist/index.d.ts           329.00 B\nDTS dist/cli/index.d.ts       20.00 B\nDTS dist/vite/plugin.d.ts     180.00 B\nDTS dist/runtime/client.d.ts  1.43 KB\nDTS dist/runtime/offline.d.ts 1.12 KB\nDTS dist/runtime/sw.d.ts      13.00 B\nDTS dist/types-DtFj4lcD.d.ts  1.62 KB\nDTS dist/config-M8fI46fg.d.ts 1.56 KB","stderr":"","interrupted":false,"isImage":false,"noOutputExpected":false},"sourceToolAssistantUUID":"6c98dd38-364c-465f-83e9-446dc0cfb734"}
{"parentUuid":"e5319de0-2799-44f8-8c04-2cf22d3560b8","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","message":{"model":"claude-opus-4-6","id":"msg_01QFc9NpXtmqQVnJxmHBMtBP","type":"message","role":"assistant","content":[{"type":"text","text":"Two changes:\n\n1. **Paginated footer**: Changed from `position: absolute` to `position: fixed` — this was the main issue. With `absolute`, the footer was positioned relative to the `100dvh` container, but on mobile the browser's bottom toolbar obscures the bottom of that container. `position: fixed` positions relative to the actual viewport, matching what the scroll reader already does.\n\n2. **Both footers**: Added `env(safe-area-inset-bottom)` to the bottom padding so the footer content stays above the home indicator on notched devices (iPhone X+)."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":965,"cache_read_input_tokens":81858,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":965},"output_tokens":1,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CYAuboNewDs55Sjt4ARna","type":"assistant","uuid":"4d3ba33c-f7e5-486f-9b05-fa5a76fe3956","timestamp":"2026-02-16T01:49:25.319Z"}
{"parentUuid":"4d3ba33c-f7e5-486f-9b05-fa5a76fe3956","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","type":"progress","data":{"type":"hook_progress","hookEvent":"Stop","hookName":"Stop","command":"entire hooks claude-code stop"},"parentToolUseID":"ebb86a61-e238-43de-af77-c9ceae21fc22","toolUseID":"ebb86a61-e238-43de-af77-c9ceae21fc22","timestamp":"2026-02-16T01:49:25.399Z","uuid":"eafd5b7f-9090-460a-9699-9147450cf943"}
{"parentUuid":"eafd5b7f-9090-460a-9699-9147450cf943","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","type":"system","subtype":"stop_hook_summary","hookCount":1,"hookInfos":[{"command":"entire hooks claude-code stop"}],"hookErrors":[],"preventedContinuation":false,"stopReason":"","hasOutput":true,"level":"suggestion","timestamp":"2026-02-16T01:49:26.138Z","uuid":"6f1f28b1-3be0-42ed-b7db-21468505fc8c","toolUseID":"ebb86a61-e238-43de-af77-c9ceae21fc22"}
{"parentUuid":"6f1f28b1-3be0-42ed-b7db-21468505fc8c","isSidechain":false,"userType":"external","cwd":"/Users/blittle/dev/pressy","sessionId":"0f95203f-9122-4058-970a-d2b1b4d17e62","version":"2.1.42","gitBranch":"main","slug":"hashed-snuggling-coral","type":"system","subtype":"turn_duration","durationMs":86572,"timestamp":"2026-02-16T01:49:26.140Z","uuid":"b72c5ac4-188a-408e-850b-9d6086058411","isMeta":false}
