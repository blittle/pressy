{"version":3,"sources":["../../src/runtime/client.ts"],"sourcesContent":["import { render, hydrate as preactHydrate } from 'preact'\nimport { signal, effect } from '@preact/signals'\nimport type { ContentManifest, Route, ReadingProgress } from '../types.js'\n\n// State signals\nexport const currentRoute = signal<string>('/')\nexport const currentTheme = signal<'light' | 'dark' | 'sepia'>('light')\nexport const paginationMode = signal<'scroll' | 'paginated'>('scroll')\nexport const currentPage = signal<number>(0)\nexport const isOffline = signal<boolean>(!navigator.onLine)\n\n// IndexedDB for reading progress\nconst DB_NAME = 'pressy'\nconst DB_VERSION = 1\nconst PROGRESS_STORE = 'reading-progress'\nconst UNLOCKS_STORE = 'unlocks'\n\nlet db: IDBDatabase | null = null\n\nasync function initDB(): Promise<IDBDatabase> {\n  if (db) return db\n\n  return new Promise((resolve, reject) => {\n    const request = indexedDB.open(DB_NAME, DB_VERSION)\n\n    request.onerror = () => reject(request.error)\n    request.onsuccess = () => {\n      db = request.result\n      resolve(db)\n    }\n\n    request.onupgradeneeded = (event) => {\n      const database = (event.target as IDBOpenDBRequest).result\n      if (!database.objectStoreNames.contains(PROGRESS_STORE)) {\n        database.createObjectStore(PROGRESS_STORE, { keyPath: 'chapterSlug' })\n      }\n      if (!database.objectStoreNames.contains(UNLOCKS_STORE)) {\n        database.createObjectStore(UNLOCKS_STORE, { keyPath: 'bookSlug' })\n      }\n    }\n  })\n}\n\nexport async function saveReadingProgress(progress: ReadingProgress): Promise<void> {\n  const database = await initDB()\n  return new Promise((resolve, reject) => {\n    const tx = database.transaction(PROGRESS_STORE, 'readwrite')\n    const store = tx.objectStore(PROGRESS_STORE)\n    const request = store.put(progress)\n    request.onsuccess = () => resolve()\n    request.onerror = () => reject(request.error)\n  })\n}\n\nexport async function getReadingProgress(chapterSlug: string): Promise<ReadingProgress | null> {\n  const database = await initDB()\n  return new Promise((resolve, reject) => {\n    const tx = database.transaction(PROGRESS_STORE, 'readonly')\n    const store = tx.objectStore(PROGRESS_STORE)\n    const request = store.get(chapterSlug)\n    request.onsuccess = () => resolve(request.result || null)\n    request.onerror = () => reject(request.error)\n  })\n}\n\nexport async function isBookUnlocked(bookSlug: string): Promise<boolean> {\n  const database = await initDB()\n  return new Promise((resolve, reject) => {\n    const tx = database.transaction(UNLOCKS_STORE, 'readonly')\n    const store = tx.objectStore(UNLOCKS_STORE)\n    const request = store.get(bookSlug)\n    request.onsuccess = () => resolve(!!request.result)\n    request.onerror = () => reject(request.error)\n  })\n}\n\nexport async function unlockBook(bookSlug: string, orderId?: string): Promise<void> {\n  const database = await initDB()\n  return new Promise((resolve, reject) => {\n    const tx = database.transaction(UNLOCKS_STORE, 'readwrite')\n    const store = tx.objectStore(UNLOCKS_STORE)\n    const request = store.put({ bookSlug, orderId, unlockedAt: Date.now() })\n    request.onsuccess = () => resolve()\n    request.onerror = () => reject(request.error)\n  })\n}\n\n// Client-side router\nexport function navigate(path: string, replace = false): void {\n  if (replace) {\n    history.replaceState(null, '', path)\n  } else {\n    history.pushState(null, '', path)\n  }\n  currentRoute.value = path\n}\n\n// Theme management\nexport function setTheme(theme: 'light' | 'dark' | 'sepia'): void {\n  currentTheme.value = theme\n  document.documentElement.setAttribute('data-theme', theme)\n  localStorage.setItem('pressy-theme', theme)\n}\n\nfunction loadTheme(): void {\n  const saved = localStorage.getItem('pressy-theme') as 'light' | 'dark' | 'sepia' | null\n  if (saved) {\n    setTheme(saved)\n  } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {\n    setTheme('dark')\n  }\n}\n\n// Pagination management\nexport function setPaginationMode(mode: 'scroll' | 'paginated'): void {\n  paginationMode.value = mode\n  localStorage.setItem('pressy-pagination', mode)\n}\n\nfunction loadPaginationMode(): void {\n  const saved = localStorage.getItem('pressy-pagination') as 'scroll' | 'paginated' | null\n  if (saved) {\n    paginationMode.value = saved\n  }\n}\n\n// Keyboard navigation for paginated mode\nfunction setupKeyboardNav(): void {\n  document.addEventListener('keydown', (e) => {\n    if (paginationMode.value !== 'paginated') return\n\n    if (e.key === 'ArrowRight' || e.key === ' ') {\n      e.preventDefault()\n      currentPage.value++\n    } else if (e.key === 'ArrowLeft') {\n      e.preventDefault()\n      if (currentPage.value > 0) {\n        currentPage.value--\n      }\n    }\n  })\n}\n\n// Offline detection\nfunction setupOfflineDetection(): void {\n  window.addEventListener('online', () => {\n    isOffline.value = false\n  })\n  window.addEventListener('offline', () => {\n    isOffline.value = true\n  })\n}\n\n// Main hydration function\nexport function hydrate(data: { route: string; manifest: ContentManifest }): void {\n  currentRoute.value = data.route\n\n  // Initialize\n  loadTheme()\n  loadPaginationMode()\n  setupKeyboardNav()\n  setupOfflineDetection()\n  initDB()\n\n  // Handle popstate for back/forward navigation\n  window.addEventListener('popstate', () => {\n    currentRoute.value = window.location.pathname\n  })\n\n  // Handle client-side link clicks\n  document.addEventListener('click', (e) => {\n    const link = (e.target as HTMLElement).closest('a')\n    if (!link) return\n\n    const href = link.getAttribute('href')\n    if (!href || href.startsWith('http') || href.startsWith('#')) return\n\n    e.preventDefault()\n    navigate(href)\n  })\n}\n\n// Export for use in components\nexport { signal, effect }\n"],"mappings":"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","names":[]}